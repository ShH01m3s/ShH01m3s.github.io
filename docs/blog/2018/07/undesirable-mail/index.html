<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Undesirable Mail - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ü™§">
      <a href="/docs/thunting">
        <span>Threat Hunting ü™§</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ü™§">
      <a href="/docs/thunting">
        <span>Threat Hunting ü™§</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/blog/"> üëàüèº Back to </br> Blog ‚úçÔ∏è </a>
  </p>
  <aside>
   <nav id="TableOfContents"></nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Undesirable Mail</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
          <a class="category-link" href="/domain/diary">Diary</a>
          
      </div> <br />
      
      
      
      

      
      

      
      <div class="article-tag">
          <i class="fas fa-tag"></i>
          
          
          <a class="tag-link" href="/tags/malware" rel="tag">malware</a>
          
           ,  
          <a class="tag-link" href="/tags/reverse" rel="tag">reverse</a>
          
           ,  
          <a class="tag-link" href="/tags/rtf" rel="tag">rtf</a>
          
      </div> 
      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p><em><strong>Thursday</strong></em>, <em><strong>Warm and cloudy.</strong></em></p>
<p><em>&ldquo;Open me! I am a payment order! I am important, I swear!&rdquo;, - some RTF-file was yelling. I wasn&rsquo;t expecting any bills so this slyboots did not maim my poor little laptop. Phew ! Lucky me! But since this was a social engineering attack (not very crafty but still), someone less concerned with his or her safety could have opened it and cause him- or herself a lot of trouble. What I am trying to say (very inarticulately ) is that simply opening a small RTF document could result in absolute disaster for your machine! In this post I am telling the story how exactly does it happen&hellip;</em></p>
<p><img src="/images/blog/2018/undesirablemail/256f405cd586450e4b545.jpg" alt="img"></p>
<p><strong>Tools:</strong> Hiew 3.0.5000, RTFScan v0.26, OfficeMalScanner, sha1deep.exe, Notepad++</p>
<p><strong>Environment:</strong> Win7x64 (VBox Version 5.2.16 r123759 (Qt5.6.2))</p>
<p><strong>SHA-1:</strong> 295594a3374a0a264ec0885d22cad2bbbe378c5f</p>
<p><strong>12:12</strong>. Some time ago I ran into some RTF file and after spending some time with it I learned how these little fellows function. I am not claiming to be an expert though, I just now know a little bit better what to be aware of and where to look. So, when that day I opened the document and saw this, I knew that was not smelling good:</p>
<p><img src="/images/blog/2018/undesirablemail/3abdc305babc3c2988c00.png" alt="img"></p>
<p>Two nice light green squares are pointing at those suspicious portions of the document. First is saying that there might be an Excel embedded. The second is proving these suspicions.</p>
<p>So, as you can clearly see from the picture above, there was an Excel file embedded (likely), and I know pretty damn well that if you see some office document, it might be equipped with some deleterious macro script. As shown on the screenshot, there is also some sequence of bytes: <strong>d0cf11e0</strong> which is a signature of an office document. Here is some reference regarding different signatures.</p>
<p>About OLE documents.</p>
<p>Well, the first question was how to extract this from the file?</p>
<p>I opened my VM and ran a RTFScan agains it with the following command:</p>
<p><strong>RTFScan C:\Users$herl0ck\Documents\4-Docs\malware.rtf scan</strong></p>
<p>and this is what I have got as a result:</p>
<p><img src="/images/blog/2018/undesirablemail/284241310076c1fdd7559.png" alt="img"></p>
<p>Yellow box serves to highlight the command and the green ones - to show that the scanner has found 5 OLE objects embedded.</p>
<p>So, I saw that I was right! There were these weeds in that RTF document! What is exactly an OLE object anyway?</p>
<p><img src="/images/blog/2018/undesirablemail/7b7ff61cdd8d739404054.png" alt="img"></p>
<p>There are 5 OLE_DOCUMENT__malware__<!-- raw HTML omitted -->.bin named by RTFScanner when making a dump. Let&rsquo;s see&hellip; I&rsquo;ll copy one of these names and search my VM for it (the scanner doesn&rsquo;t save them in the current directory and having a squirrel-like memory, alas!) I don&rsquo;t remember where to look for it.</p>
<p><img src="/images/blog/2018/undesirablemail/33d3ecebd6833195f330a.png" alt="img"></p>
<p>At the destination I found all the five &ldquo;prisoners&rdquo; and copied them to my host to view in hex. Scrolling the first dumped OLE object almost to the very end, I noticed very familiar strings (<strong>&ldquo;Dim&rdquo;, &ldquo;For i = 13 To 85&rdquo;, &ldquo;String = &ldquo;dkV&hellip;&rdquo;</strong>) indicating that there WAS macro lurking inside!</p>
<p><img src="/images/blog/2018/undesirablemail/02e49ae99d01941df9a96.png" alt="img"></p>
<p>Next questing I asked myself was &ldquo;Are they all different?&rdquo; Pulling a <strong>sha1deep.exe</strong>from my toolkit, I have calculated the hash and it turned out to be the same (<strong>9a9ba8040952200d264637d0b2001225de826dc4</strong>), proving me right! So, no need to analyze them all, one would be enough.</p>
<p>Ok, once I got that OLE dump I need some tool to extract macro code. Let&rsquo;s see&hellip; Aha! OfficeMalScanner will do the trick. Righty-right! Off we go with that:</p>
<p><img src="/images/blog/2018/undesirablemail/0dd2711200669536e52fd.png" alt="img"></p>
<p>Very well. Now all I need to do is follow that path shown and have a look at the macro extracted.. I have a string feeling I am about to finish this journey.</p>
<p><img src="/images/blog/2018/undesirablemail/8fa7d4cca74066e60b1ab.png" alt="img"></p>
<p>I usually use Notepad++ for viewing scripts since it supports multiple programming languages for highlighting the code and has some other useful additional features.</p>
<p>From the first glance at the code I can make a conclusion that I should never ever rejoice upon task completion before it is actually completed &hellip; This code is highly obfuscated and needs more effort from my part. There are several ways to accomplish that:</p>
<ol>
<li>decode it manually in text editor (no way I am doing that!)</li>
<li>run it in VM and see what it has done</li>
<li>trow it into a sandbox</li>
<li>use some Office with macro enabled, put breakpoints at the end of the payload and look at the contents of the variables.</li>
</ol>
<p>Opening the document using the application where it belongs revealed social engineering content.</p>
<p><img src="/images/blog/2018/undesirablemail/e31e636144e7a446f02c4.png" alt="img"></p>
<p><strong>13:03</strong>. Need a break&hellip;</p>
<p><strong>13:15</strong>. After having a nice break I can get back to the file.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">simple_decipher</span> <span class="p">(</span><span class="n">p_string</span><span class="p">,</span> <span class="n">p_key</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">  <span class="n">result</span> <span class="o">=</span> <span class="err">‚Äú‚Äù</span>
</span></span><span class="line"><span class="cl">  <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_string</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">  <span class="n">result</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">p_string</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span> <span class="err">‚Äì</span> <span class="n">p_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">count</span> <span class="o">+=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">simple_decipher</span><span class="p">(</span><span class="err">‚Äú</span><span class="mi">8</span><span class="n">CA0A1AB8FA7AAA39AA7A7A366B1A5A68DAB979EA1AD</span><span class="err">‚Äù</span><span class="p">,</span> <span class="mi">56</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">simple_decipher</span><span class="p">(</span><span class="err">‚Äú</span><span class="mi">8</span><span class="n">F8B9BAAA1A8AC668BA09DA4A4</span><span class="err">‚Äù</span><span class="p">,</span> <span class="mi">56</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">simple_decipher</span><span class="p">(</span><span class="err">‚Äú</span><span class="mi">8</span><span class="n">AADA6</span><span class="err">‚Äù</span><span class="p">,</span> <span class="mi">56</span><span class="p">)</span>
</span></span></code></pre></div><p>And the resulting decoded strings are these:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">ThisWorkbook.ymnUs_fiu
</span></span><span class="line"><span class="cl">WScript.Shell
</span></span><span class="line"><span class="cl">Run
</span></span></code></pre></div><p>&hellip;which reveals the intentions pretty well:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-vb" data-lang="vb"><span class="line"><span class="cl"><span class="n">CallByName</span> <span class="n">CreateObject</span><span class="p">(</span><span class="n">I_RZl</span><span class="p">(</span><span class="s">&#34;8F8B9BAAA1A8AC668BA09DA4A4&#34;</span><span class="p">)),</span> <span class="n">I_RZl</span><span class="p">(</span><span class="s">&#34;8AADA6&#34;</span><span class="p">),</span> <span class="n">VbMethod</span><span class="p">,</span> <span class="n">I_RZl</span><span class="p">(</span><span class="n">ThisWorkbook</span><span class="p">.</span><span class="n">Sheets</span><span class="p">(</span><span class="s">&#34;Opto&#34;</span><span class="p">).</span><span class="n">Range</span><span class="p">(</span><span class="s">&#34;H211&#34;</span><span class="p">).</span><span class="n">Value</span><span class="p">),</span> <span class="n">0</span><span class="p">,</span> <span class="k">True</span>
</span></span></code></pre></div><p>Code refers to some Opto Sheet, but there is no such thing in the whole document! Why?! I&rsquo;ve really searched for the entire document and its structure, no such thing as &ldquo;Opto Sheet&rdquo;&hellip; And the it struck me like a lightning bolt! What if I open it in Hiew again and search for &ldquo;Opto&rdquo;&hellip;</p>
<p>Voila!</p>
<p><img src="/images/blog/2018/undesirablemail/ddb4d804263571c8e4d84.png" alt="img"></p>
<p>Let&rsquo;s copy these hex digits and run my Pthy against it&hellip; Aha! That&rsquo;s interesting&hellip;. Deserves further investigation ! To make it easier to look through, it&rsquo;s better to view it in Notepad++ with Batch as a language to beautify it a bit&hellip;and ta-da! My efforts have finally paid off. Look at this pearls!</p>
<p><img src="/images/blog/2018/undesirablemail/30b22a7efff7a7e08c6c5.png" alt="img"></p>
<p>Orange square shows the target path on the local system. Green one - where to download some file from. Blue line underlines the user-agent. Sometimes it&rsquo;s used by malware authors to filter requests for download. Thus, if you use default user agent, the server might respond with 404 (File not found) or some other code. That means you won&rsquo;t be able to download it without explicitly specifying that thing. In this very case, however, server willingly responded to the default request without the need to set user agent to this: &lsquo;WSK&rsquo;.</p>
<p>What can I conclude looking at that script? First, the author has lots of free time. Second: the script likely downloads .exe and .doc (which is what it claims to be downloading. Doesn&rsquo;t mean that&rsquo;s true). Let&rsquo;s go where it&rsquo;s pointing to!&hellip; Where is my dragon ? Kali Linux has a great tool at its disposal: wget. I can specify parameters and HTTP headers like this:</p>
<p><img src="/images/blog/2018/undesirablemail/a419d4fd7cfce2b84fab8.png" alt="img"></p>
<p>If there would be user-agent problem, I could specify it like this:</p>
<blockquote>
<p>wget <a href="https://somewebsite.com/somecreepystuff.exe">https://somewebsite.com/somecreepystuff.exe</a> -user-agent=&ldquo;WSK&rdquo;</p>
</blockquote>
<p>Alternatively, I could use Postman, which is a good GUI tool for crafting HTTP requests, but I won&rsquo;t. May be some other time.</p>
<p>So! I think I might have been carried away too far. What have I just downloaded? Well-well&hellip; looks like the malicious code did less lying than I thought: that was true, one <strong>.exe</strong> file and one <strong>.doc</strong>. The first one is detected as Injector by lots of antivirus agents. But I thing it was quite obvious from the very beginning that nothing good is coming out of it: well, how many times do you see a simple document perform so much creepy stuff without you even being aware? As far as I&rsquo;m concerned, never.</p>
<p><img src="/images/blog/2018/undesirablemail/8db422395abdebe62d68a.png" alt="img"></p>
<p>Aha! It&rsquo;s trying to convince me that it&rsquo;s an Excel document&hellip; or Excel installer. Ha-ha! Nice try. However, some PCs are configured in a way that most file formats are not displayed. So, it this case a user might not even see <strong>.exe</strong> ending. This <strong>x1.exe</strong> (SHA-1 is 535261b8fca79bdaa25a335b31b64b35c4244ab2) drops something and launches another program. But that&rsquo;s whole other story, friends.</p>
<p>Off for now, dear diary!</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
