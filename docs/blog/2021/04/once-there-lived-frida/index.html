<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Once There Lived Frida - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.b67d7fec5daec98747a80616a05e9e1e96dc0976219c428241762578c5ae69c3.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-articles">
      <a href="/docs/articles">
        <span>Articles</span>
      </a>
    </li>
    
    <li class="menu-item-blog">
      <a href="/docs/blog">
        <span>Blog</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit">
      <a href="/docs/toolkit">
        <span>Toolkit</span>
      </a>
    </li>
    
    <li class="menu-item-about me">
      <a href="/docs/about">
        <span>About me</span>
      </a>
    </li>
    
    <li class="menu-item-achievements">
      <a href="/docs/achievements">
        <span>Achievements</span>
      </a>
    </li>
    
    <li class="menu-item-contacts">
      <a href="/docs/contact">
        <span>Contacts</span>
      </a>
    </li>
    
    <li class="menu-item-notes">
      <a href="/docs/notes">
        <span>Notes</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-articles">
      <a href="/docs/articles">
        <span>Articles</span>
      </a>
    </li>
    
    <li class="menu-item-blog">
      <a href="/docs/blog">
        <span>Blog</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit">
      <a href="/docs/toolkit">
        <span>Toolkit</span>
      </a>
    </li>
    
    <li class="menu-item-about me">
      <a href="/docs/about">
        <span>About me</span>
      </a>
    </li>
    
    <li class="menu-item-achievements">
      <a href="/docs/achievements">
        <span>Achievements</span>
      </a>
    </li>
    
    <li class="menu-item-contacts">
      <a href="/docs/contact">
        <span>Contacts</span>
      </a>
    </li>
    
    <li class="menu-item-notes">
      <a href="/docs/notes">
        <span>Notes</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
  <div class="docs-menu">
   </div> 



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Once There Lived Frida</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
                <i class="fas fa-archive"></i>
              
          <a class="category-link" href="/domain/general">general</a>
          
              
              <i class="fas fa-microchip"></i>
              
          <a class="category-link" href="/domain/reverse">reverse</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
          <a class="platform-link" href="/doctype/setup">setup</a>
          
             ,  
              
          <a class="platform-link" href="/doctype/diary">diary</a>
          
      </div> <br /><br/>
      
      
      
      
      <div class="article-category">
          
            
            
            
              <i class="fab fa-apple"></i>
            
            
            
          <a class="platform-link" href="/platforms/mac">mac</a>
          
      </div> <br />
      

      
      <div class="article-category">
        <i class="fas fa-tools"></i>
          
          <a class="platform-link" href="/tools/radare2">radare2</a>
          
          <a class="platform-link" href="/tools/frida">frida</a>
          
      </div> <br />
      
      

      
      <div class="article-tag">
          <i class="fas fa-tag"></i>
          
          
          <a class="tag-link" href="/tags/how-i..." rel="tag">how i...</a>
          
           ,  
          <a class="tag-link" href="/tags/reverse" rel="tag">reverse</a>
          
      </div> 
      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p>üìÜ <code>24/04/2021</code> , <em>Saturday</em></p>
<p>üï∞ <code>10:21 AM</code>.</p>
<p><em>It&rsquo;s an ordinary gloomy Mordor morning. To be honest, I was hoping for a sunny one&hellip; But may be one has to live somewhere else to claim that ü§∑‚Äç‚ôÄÔ∏è. It&rsquo;s been a while since I&rsquo;ve done some decent reversing and I started missing it a bit. My first whitebox project and another one with mobile vulnerability assessment have both inspired me in their own ways to writing another blog post about reverse engineering.</em></p>
<h2 id="android-vs-ios-everlasting-battle-">Android vs iOS Everlasting Battle ‚öîÔ∏è</h2>
<p>Anyone, performing mobile vulnerability assessment knows pretty well, that Android is like a Christmas üéÑ tree in the scary and mysterious fog üå´  of reverse engineering, just standing there and sparkling with its lights and luring travellers passing by for some occasional reversing üòâ. The code, it&rsquo;s all there, in its pristine beauty saying <em>&ldquo;Come one! Look at these almost totally human-readable code! I am not like iOS, I am friednly&rdquo;</em>. That&rsquo;s why writing my first super primitive frida code for Android was rediculously easy (substituting package name with a made up one and tampering with the method name as well for discretion sake üòé):</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">bypassPIN</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">try</span><span class="p">{</span>
         <span class="nx">Java</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="s2">&#34;com.example.MyLoginController&#34;</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">onMatch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">instance</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[ * ] Instance com.example.MyLoginController found in memory: &#34;</span> <span class="o">+</span> <span class="nx">instance</span><span class="p">);</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[ * ] Method found in memory: &#34;</span> <span class="o">+</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">ifCorrect</span><span class="p">);</span>
                    <span class="nx">instance</span><span class="p">.</span><span class="nx">ifCorrect</span><span class="p">();</span>
                <span class="p">},</span>
                <span class="nx">onComplete</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[ * ] Successfully bypassed PIN code&#34;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>

        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[ x ] Woops, something went wrong:&#34;</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
         <span class="p">}</span>    
       <span class="p">});</span>
<span class="p">}</span>
</code></pre></div><p>As for fingerprint check, this application used <code>FingerprintManager</code>, which is deprecated and there already exists a frida <a href="https://github.com/FSecureLABS/android-keystore-audit/blob/master/frida-scripts/fingerprint-bypass.js">script</a> to bypass it.</p>
<p>Reversing iOS (especilly those iOS applications written in Swift) is a tricky business. It&rsquo;s not a piece of cake, it a real bear üêª! For starters, unlike Android <code>.java</code> both Obj-C and Swift for iOS are compiled to hardcore ARM assembly code which is not as welcoming as java code ü§∑ (even Java Bytecode). Secondly, Swift functions are very often mangled üß∂. I&rsquo;ve already seen this technique when analysing C++ compiled binaries. A swift mangled name looks something like this: <code>_TtCFCC5MyApp7MyClass10MySubClass6myFuncFS0_FT_T_L_11MySubSubClass</code>. To demangle this trash one would have to use a tool or learn this &ldquo;code&rdquo;. For example, on Mac OSX you could run <code>swift demangle _TtCFCC5MyApp7MyClass10MySubClass6myFuncFS0_FT_T_L_11MySubSubClass</code> or <code>xcrun swift-demangle _TtCFCC5MyApp7MyClass10MySubClass6myFuncFS0_FT_T_L_11MySubSubClass </code> to see that it means the following: <code>MySubSubClass #1 in MyApp.MyClass.MySubClass.myFunc(MyApp.MyClass) -&gt; () -&gt; ()</code>. It resembles serialisation in a way&hellip;. .  Well, this demangling is sometimes automatically performed by <code>radare2</code>, Hopper or some other disassemblers (not in my case). May be I have not found this option yet.</p>
<p>I&rsquo;ve asked myself, what a weird way to protect code. It&rsquo;s making things harder, but not too much harder since it&rsquo;s pretty easy to demangle these things back. There must be another reason to do that. As it turned out, this is done to prevent collisions when different objects are named the same []:</p>
<blockquote>
<p><strong>Name mangling</strong> is the encoding of <strong>function</strong> and variable <strong>names</strong> into unique <strong>names</strong> so that linkers can separate common <strong>names</strong> in the language. Type <strong>names</strong> may also be <strong>mangled</strong>. <strong>Name mangling</strong> is commonly used to facilitate the overloading feature and visibility within different scopes.</p>
</blockquote>
<p>Another trick that makes analysis just slightly more difficult is that iOS applications downloaded from AppStore are <strong>always</strong> encrypted, this is the policy enforced by Apple. Therefore, you need an actual device and a specified tool to decrypt it. Not that it&rsquo;s too hard, but it&rsquo;s a slight complication sometimes. I think, this might make patching in runtime a little harder &hellip; .</p>
<p>Now to <code>frida</code>. Since there is nothing human-readable in iOS compiled code (unless you are a serious man reading ARM code as if it were a bedtime story for a kid), a frida script would look something like this if I were to change the return value of some function that returns <code>bool</code> [<a href="https://syrion.me/blog/ios-swift-antijailbreak-bypass-frida/">2</a>]:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">addr</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">(</span><span class="mh">0x100ac</span><span class="p">);</span>
<span class="nx">moduleBase</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">getBaseAddress</span><span class="p">(</span><span class="nx">targetModule</span><span class="p">);</span>
<span class="nx">targetAddress</span> <span class="o">=</span> <span class="nx">moduleBase</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">addr</span><span class="p">);</span>
    <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">targetAddress</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">onEnter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">x0</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">){</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">x0</span><span class="o">=</span><span class="mh">0x00</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Bypass checkExistenceOfSuspiciousFiles&#34;</span><span class="p">);</span>
                <span class="p">}</span>          
        <span class="p">},</span>
    <span class="p">});</span>
</code></pre></div><p>So, in order to patch a function in runtime üöÇ (i.e. while the program is being run) I need to know:</p>
<ul>
<li><input disabled="" type="checkbox"> the virtual address of the function I want to hook ü™ù</li>
<li><input disabled="" type="checkbox"> the register holding the value of interest</li>
</ul>
<p>This way I will be able to  do the naughty job with this application.</p>
<h2 id="application-briefing">Application briefing</h2>
<p>Just a little briefing: this application is using local authentication mechanism, hence, it&rsquo;s not validating login information on the server once the user first logged in and set PIN and a finger. It&rsquo;s also using a vulnerable mechanism of &ldquo;authentication&rdquo; with <code>LAContext()</code>. See these articles [<a href="https://blog.nvisium.com/dont-touch-me-that-way">8</a>], [<a href="https://github.com/sensepost/objection/wiki/Understanding-the-iOS-Biometrics-Bypass">10</a>] or this presentation [<a href="https://youtu.be/XhXIHVGCFFM">9</a>] for more information why exactly it is not safe. I am going to try exploiting this way of &ldquo;authentication&rdquo;.</p>
<p>After logging in for the first time using a username and a password checked on the server, the user is forced to come up with a 4-digit PIN code and turn on TouchID (optionally). The trouble starts when this 4-digit PIN or TouchID are then used to authenticate since they are stored locally, checked locally and not being used to decrypt something or establish a connection.</p>
<p>As for PIN, it simply compared to the value retrieved from Keychain, something like the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kr">override</span> <span class="kd">func</span> <span class="nf">checkPinCode</span><span class="p">(){</span>
        <span class="p">...</span>
  <span class="k">if</span> <span class="n">pin</span> <span class="p">==</span> <span class="kc">self</span><span class="p">.</span><span class="n">getPinCodeFromKeychain</span><span class="p">()</span> <span class="p">{</span>
       <span class="c1">// some success code</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
   		 <span class="c1">// error code</span>
    <span class="p">}</span>
<span class="c1">// some other class code</span>

<span class="kd">func</span> <span class="nf">getPinCodeFromKeychain</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">String</span><span class="p">?</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">keychain</span> <span class="p">=</span> <span class="n">KeychainSwift</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">keychain</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="kc">self</span><span class="p">.</span><span class="n">pinCode</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div><p>One can simply (or not that simply in case of iOS) patch the function that&rsquo;s checking PIN or TouchID in such a way that they always return <code>true</code>. Caramba üò≥!</p>
<blockquote>
<p>A little note üìù: the same job can be achieved with a simple <code>ios ui biometrics_bypass</code> running with objection. But I would like to try doing this myself. May be later I will check the script that&rsquo;s doing it if I fail myself or just to check other ways of acomplishing this task.</p>
</blockquote>
<p>üï∞ <code>11:03 AM</code> So, this is where one starts thinking about learning to reverse ARM code, but to be honest, I&rsquo;ve been thinking about it for quite a time and already have started some preliminary research on that part. You see, the world is going mobile, even Apple is now using ARM processessors for their laptops (refering to M1 I am currently using). It&rsquo;s becoming a useful skill to gain.</p>
<p>Even though inspiration is all over me at the moment, I am having my violin üéª lessons and got to go. But I hope, I will be coming back for this topic pretty soon.</p>
<p>Chearsü•Ç</p>
<p>üï∞ <code>06:43 PM</code>. So, I am back, dear diary and ready to spend a little time on this problem. First of all, I need a plan. There are several I might patch:</p>
<ul>
<li>
<p>TouchID or FaceID</p>
<ul>
<li><code>evaluatePolicy()</code> - in the library code, requires patching its call to API. This is the technique used by objection (<code>ios ui biometrics_bypass</code>).</li>
<li><code>evaluate()</code> - in the library code. Would require patching function body.</li>
</ul>
</li>
<li>
<p>PIN code</p>
<ul>
<li><code>getPinCodeFromKeychain()</code> - in the code of the application itself, requires patching the string returned by another proprietary application function <code>getPinCodeFromKeychain()</code>.</li>
</ul>
</li>
</ul>
<p>Only now when I&rsquo;ve put this down, I&rsquo;ve realised that objection might fail, since this <code>evaluatePolicy()</code> function is not in the application code, but in the dylib that&rsquo;s being loaded. But may be not&hellip; . üîç I need to investigate this further.</p>
<p>Since I am a total noob in this, it&rsquo;s ony logical to start from the known path. So, I am going to research this <code>evaluatePolicy()</code> a little deeper and see, how this hooking is implemented there.</p>
<p>I will then try patching <code>getPinCodeFromKeychain()</code> since it seems reasonably easier.</p>
<p>And in the end, as the final boss of this game, I will try to hunt down üî´ and patch ü©π <code>evaluate()</code> function&rsquo;s body. There is a <code>if...else</code> block that I might patch in such a way that it returns <code>true</code> on failing and returns <code>false</code> on succeeding. In this case I would have to use <strong>un-matching</strong> fingerprint in order to log in.</p>
<p>Sounds like a plan. So, I am ready to get my hands a little dirtly. Let&rsquo;s get down to business!</p>
<p><img src="images/bender.jpeg" alt="bender"></p>
<h2 id="test-drive-">Test Drive üöò</h2>
<p>üìÜ <code>01/05/2021</code></p>
<p>üï∞ <code>02:10 PM</code></p>
<p>I am not a pro in frida-scripting. Up until recently I&rsquo;ve been as bas as a dog üê© at discussing politics in a civilized manner.</p>
<p>Since I have the source code, I have a luxury to reference it in order to ease my analysis. <em>&ldquo;Cheater-cheater&rdquo;</em>, - one could give their two cents, but I would say, it&rsquo;s stupid not to use every tool and every information to help the analysis go smoother and faster. In case of a real investigation that could save me valuable time that could have been crucial for someone.</p>
<p>I&rsquo;ve been trying to compile the binary, but since I am running it on M1, I had to comment out some code and also <em>de-pod</em> some libs from it as well. There must be some way around, but that would take too much time to get the problem solved. So, I&rsquo;ve chosen the easiest way to acomplish the same task and got rid of everything that &ldquo;smelled bad&rdquo; ü¶®. But this lazy approach has produced an expected but not a desirable outcome: the binaries now a little different, as well as the offsets of the function I am trying to dig out. I have several options:</p>
<ul>
<li><input disabled="" type="checkbox"> Compile the original developer version of the project as is, i.e. untouched&quot; üë∞‚Äç‚ôÄÔ∏è. This requires using another laptop. A little bit time consuming since I can get</li>
<li><input disabled="" type="checkbox"> </li>
</ul>
<p><img src="images/bin-info-compare.png" alt="bin-info-compare"></p>
<p>üï∞ <code>10:08 AM</code></p>
<p>I&rsquo;ve found the function of interest using Cutter by the function name. Since the return value is usually stored in x0 and going by the code, it is the case here as well, I need to hook the function and modify the value on leaving the function.</p>
<p>This function starts at <code>0x100028a84</code> and returns at <code>0x100028a84</code>. I am going to correlate the original source code with this disassembly so that I feel more confident when I only have assembly at my disposal. Oh, dreadful times coming&hellip; . Need to get ultimately prepared!</p>
<p>The function is relatively simple: get value from keychain and compare it with the entered one (checkout the code snippet above, in the <a href="#application-briefing">Application briefing</a> section).</p>
<p>My hack is simple and pretty straightforward as well: substitute the value returned with the one I come up with. So, even if the pin is <code>1111</code>, I can substitute it with <code>2222</code> and there is no way that the application will know that this value was not the one retreived from the Keychain. How would one solve this problem? Well, if this application would use this pin code to decrypt some refresh token or other information, wrong pin would result in garbage data and this hack would not work, or would it?</p>
<p>Another option would be to print the value of the <code>x0</code> register before function exit. I will try both.</p>
<p>Running frida server on my test iDevice:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">./frida-server-14.2.13-ios-arm64 -l 192.168.1.72
</code></pre></div><p>Then, I am retrieving the Death Star üí´ process PID with <code>frida-trace</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">frida-ps -H 192.168.1.72 <span class="p">|</span> grep -i death
</code></pre></div><p>Highly symbolic, the process PID is <code>666</code>&hellip; üòà. It&rsquo;s a very promising and encouraging  beginning ü§®. Now that I have the PID, I can board this ship üõ≥!</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">frida -H 192.168.1.72 -p <span class="m">666</span>
</code></pre></div><p>Now, I need to know the name of the main module of this Death Star. I am using frida promt and <code>Process.enumerateModules()</code> and the first one returned, named like the application itself IS the main module:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">Process.enumerateModules()</span>

<span class="p">{</span>
        <span class="nt">&#34;base&#34;</span><span class="p">:</span> <span class="s2">&#34;0x100094000&#34;</span><span class="p">,</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Death Star&#34;</span><span class="p">,</span>
        <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;/private/var/containers/Bundle/Application/5D839E1B-C7EA-47D1-BA2F-65E2DDE701AF/Death Star.app/Death Star&#34;</span><span class="p">,</span>
        <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">10305536</span>
    <span class="p">}</span><span class="err">,</span>
<span class="err">...</span>
</code></pre></div><p>So, the <code>base</code> address is <code>0x100094000</code>. This is the address I am to add to the offset, that I get from <code>radare2</code>.</p>
<p>Let&rsquo;s go to radare2 (aka Cutter) and get the address near function return: <code>0x100025238 </code>.</p>
<p><img src="images/cutter-getpin-dis.png" alt="cutter-getpin-dis"></p>
<p>Since return values are usually stored in <code>x0</code> and the function returns a string, it&rsquo;s pretty fair to suggest that <code>x0</code> register will contain the correct PIN retreived from the Keychain by this point of execution.</p>
<p>So, am I supposed to add <code>0x100025238</code> to the <code>base</code> address <code>0x100094000</code> that frida has returned. No, of course. There are two states that the code can be in: at rest on disk (simple file) or a process in memory. While it&rsquo;s always at rest on the disk, it&rsquo;s not always being run and therefore it&rsquo;s not always a process. On the disk and in RAM (when being run) the code has sligtly different layout and addresses. What&rsquo;s radare2 is showing - virtual addresses on disk, while frida - in virtual addresses in RAM.</p>
<p>25238</p>
<p>peacefully resting on disk and</p>
<p>0x100025190</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">resolveAddress</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">idaBase</span><span class="p">,</span> <span class="nx">idaAddr</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">baseAddr</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">findBaseAddress</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[+] BaseAddr of &#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nx">baseAddr</span><span class="p">);</span>
      
    <span class="c1">// Calculate offset in memory from base address in IDA database
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">(</span><span class="nx">idaAddr</span><span class="p">).</span><span class="nx">sub</span><span class="p">(</span><span class="nx">idaBase</span><span class="p">);</span>
      
    <span class="c1">// Add current memory base address to offset of function to monitor
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">baseAddr</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">offset</span><span class="p">);</span>
      
    <span class="c1">// Write location of function in memory to console
</span><span class="c1"></span>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[+] Address in memory: &#39;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>I thought there might be a problem with ASLR, but it seems it&rsquo;s already calculated.</p>
<p>baseAddr = 0x100094000</p>
<p>offset = 0x100025238 - 0x100000000</p>
<p>result = 0x100094000 + (0x100025238 - 0x100000000) = 0x100094000 + 25238</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">frida-ps -H 192.168.1.72 -ai <span class="c1"># find bundle id</span>
frida -H 192.168.1.72 -f bundleid --no-pause -l bypassPin-ios.js <span class="c1"># start app with frida</span>
</code></pre></div><h2 id="diving-into--lacontextevaluatepolicy">Diving into ü§ø LAContext().evaluatePolicy()</h2>
<p>üìÜ <code>26/04/2021</code></p>
<p>üï∞  <code>08:02 AM</code></p>
<p><em>It&rsquo;s a very pleasant and warm Monday morning üåû  which lifts my spirits up a lot. Ojala this were a Sunday morning&hellip; . I am doing some nerd stuff while having little sips of the delicious coffee ‚òïÔ∏è my husband has made me so thoughtfully before leaving to the office ‚ô•Ô∏è.</em></p>
<p><img src="images/professor-good-news.jpeg" alt="professor-good-news"></p>
<p>I have the source code for this Death Star üí´  leaked by someone very nice or very treacherous and so I know which function I need to find. My task is a little less complicated. This is the source code of a function that I am hunting:</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">private</span> <span class="kd">func</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">policy</span><span class="p">:</span> <span class="n">LAPolicy</span><span class="p">,</span> <span class="n">with</span> <span class="n">context</span><span class="p">:</span> <span class="n">LAContext</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">success</span> <span class="n">successBlock</span><span class="p">:@</span><span class="n">escaping</span> <span class="n">AuthenticationSuccess</span><span class="p">,</span> <span class="n">failure</span> <span class="n">failureBlock</span><span class="p">:@</span><span class="n">escaping</span> <span class="n">AuthenticationFailure</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="n">evaluatePolicy</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">localizedReason</span><span class="p">:</span> <span class="n">reason</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="k">in</span>
            <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">async</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">success</span> <span class="p">{</span> <span class="n">successBlock</span><span class="p">()</span> <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;This function was patched&#34;</span><span class="p">)</span>
                    <span class="c1">//let errorType = AuthenticationError.initWithError(err as! LAError)</span>
                    <span class="c1">//failureBlock(errorType)</span>
                    <span class="n">successBlock</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div><p>It&rsquo;s pretty standard. The same code I&rsquo;ve seen many times in different presentations and source code. This function checks for the TouchID and FaceID and jumps to either <code>success</code> or <code>err</code> block depending on the result of <code>evaluatePolicy()</code> method. So, let&rsquo;s see this method. I am jumping to <code>Jump to definition </code> to see where it comes from and how it looks like. And that&rsquo;s what I see:</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift">  <span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">iOS</span> <span class="mf">8.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">open</span> <span class="kd">func</span> <span class="nf">evaluatePolicy</span><span class="p">(</span><span class="kc">_</span> <span class="n">policy</span><span class="p">:</span> <span class="n">LAPolicy</span><span class="p">,</span> <span class="n">localizedReason</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">reply</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="nb">Bool</span><span class="p">,</span> <span class="n">Error</span><span class="p">?)</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)</span>
</code></pre></div><p>It&rsquo;s API, <code>LAContext.h</code>, <code>LocalAuthentication</code>. So no implementation is available. But I am not really interested in the implementation itself, but rather in what it returns.</p>
<p>It look like it returns <code>void</code>, but objection patches <code>bool</code>. That is weird. Why? Dissecting this API with the help of my husband has given the following result. This function takes two arguments: <code>policy</code> of type <code>LAPolicy</code> and <code>localizedReason</code> as <code>String</code>. Its return value is a closure (lambda expression). This function returns void. May be somewhere in the ARM assembly code it is returning <code>bool</code>&hellip; .This I don&rsquo;t yet understand.</p>
<p>üï∞ <code>07:40 PM</code></p>
<p>I have also noticed these modules:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
        <span class="nt">&#34;base&#34;</span><span class="p">:</span> <span class="s2">&#34;0x1d9c20000&#34;</span><span class="p">,</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;LocalAuthentication&#34;</span><span class="p">,</span>
        <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;/System/Library/Frameworks/LocalAuthentication.framework/LocalAuthentication&#34;</span><span class="p">,</span>
        <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">98304</span>
    <span class="p">}</span><span class="err">,</span>
<span class="p">{</span>
        <span class="nt">&#34;base&#34;</span><span class="p">:</span> <span class="s2">&#34;0x1dd8ab000&#34;</span><span class="p">,</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;SharedUtils&#34;</span><span class="p">,</span>
        <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;/System/Library/Frameworks/LocalAuthentication.framework/Support/SharedUtils.framework/SharedUtils&#34;</span><span class="p">,</span>
        <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">274432</span>
    <span class="p">}</span><span class="err">,</span>
<span class="p">{</span>
        <span class="nt">&#34;base&#34;</span><span class="p">:</span> <span class="s2">&#34;0x1e93c8000&#34;</span><span class="p">,</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;LocalAuthenticationPrivateUI&#34;</span><span class="p">,</span>
        <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;/System/Library/PrivateFrameworks/LocalAuthenticationPrivateUI.framework/LocalAuthenticationPrivateUI&#34;</span><span class="p">,</span>
        <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">233472</span>
    <span class="p">}</span><span class="err">,</span>
</code></pre></div><p>One of them contains <code>evaluatePolicy()</code> method.</p>
<p>My first try:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">test</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">targetModule</span> <span class="o">=</span> <span class="s1">&#39;BiometricAuthentication&#39;</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Target module is BiometricAuthentication&#34;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">addr</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">(</span><span class="mh">0x7a84</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Offset is &#34;</span> <span class="o">+</span> <span class="nx">addr</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">moduleBase</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">getBaseAddress</span><span class="p">(</span><span class="nx">targetModule</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Module&#39;s base address is &#34;</span> <span class="o">+</span> <span class="nx">moduleBase</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">targetAddress</span> <span class="o">=</span> <span class="nx">moduleBase</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">addr</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Calculated address is &#34;</span> <span class="o">+</span> <span class="nx">moduleBase</span><span class="p">);</span>
    
    <span class="k">try</span><span class="p">{</span>
        <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">targetAddress</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">onEnter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">w0</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">w0</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">){</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">w0</span><span class="o">=</span><span class="mh">0x01</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Returning reverse value for w0 register&#34;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// exceptions to handle, example:
</span><span class="c1"></span>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
     <span class="p">}</span> 
          
<span class="p">}</span>
</code></pre></div><p>0x101276696</p>
<p>0x10153a770</p>
<p>0x1012781b8</p>
<p>0x101534f9c</p>
<p>0x101535557</p>
<p>0x10153f367</p>
<p>Running <code>ios ui biometrics_bypass</code> in objection gives a little hint on how exactly it is implemented. Two functions seem to be patched: <a href="https://developer.apple.com/documentation/localauthentication/lacontext/1514174-evaluateaccesscontrol">evaluateAccessControl</a> and <a href="https://developer.apple.com/documentation/localauthentication/lacontext/1514176-evaluatepolicy/">evaluatePolicy</a>. Running them using hooking option manually doesn&rsquo;t work. I yet don&rsquo;t understand why.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">ios hooking <span class="nb">set</span> return_value <span class="s2">&#34;-[LAContext evaluateAccess
</span><span class="s2">Control:accessControl:localizedReason:reply:]&#34;</span> <span class="nb">true</span>
ios hooking <span class="nb">set</span> return_value <span class="s2">&#34;-[LAContext evaluatePolicy
</span><span class="s2">:localizedReason:reply:]&#34;</span> <span class="nb">true</span>
</code></pre></div><p>Returned nothing. Phil Keeple in his blog <a href="https://philkeeble.com/ios/iOS-Bypass-Fingerprint/">post</a> was also trying to investigate this issue, but hooked evaluatePolicy only with no result as well, though <code>ios ui biometrics_bypass</code> works fine.  Phil suggests that this might be some more tweaks and tricks under the hood. While I agree that could be a reason, I suspect that there might be sligtly different implementation for <code>hooking</code> a function manually and a flow that&rsquo;s <code>ios ui biometrics_bypass</code> is using, i.e. a bug üêú.</p>
<p>Reverse engineering objection in desperate attempt to find a frida script that&rsquo;s doing the job was a fiasco.</p>
<p><code>09:50 PM</code></p>
<p>I am lauching my victim application. Just to make it a little more interesting, let&rsquo;s say, it&rsquo;s a Death Star üí´  app that we need to log into in order to prevent it from destroying some nice and cute planet full of kittens üêà‚Äç‚¨õ  and penguins üêß.</p>
<p>For static analysis I am using both <code>radare2</code> and its newborn üë∂ GUI application Cutter.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">radare2 deathstar <span class="c1"># loading binary with radare2</span>
aaaa <span class="c1"># running full analysis</span>
fs imports<span class="p">;</span> f~authenticator <span class="c1"># loading imports flag space and grepping for &#34;authenticator&#34; in the function names. You won&#39;t get anything meaninglful and useful in strings and imports unless you run aaaa</span>
</code></pre></div><p>I&rsquo;ve found all methods imported, that contain <code>authenticator</code> in their names and that might be an indicator that they have something to do with authentication mechanism of this Death Star üí´&hellip; .</p>
<p>The easy way would be to copy the objection script code for bypassing <code>evaluatePolicy()</code> and refactor it a bit to work for a library instead of the main code (it&rsquo;s as if it doesn&rsquo;t patch the lib, still have not checked). But I am not looking for easy ways, pretty comfortable being a cautionary tale.</p>
<h2 id="finding-evaluate-in-compiled-code">Finding <code>evaluate()</code> in compiled code</h2>
<p>üìÜ <code>25/05/2021</code></p>
<p>üï∞ <code>09:13 PM</code></p>
<p>Trying to patch the function in the binary. It would not be that difficult to find it, since not too much code there. But still, I am going to do some cheating here. I am going to call <code>print()</code> with some unique string to find it later in the disassembly</p>
<p>Now, I will compile a new .ipa and I will look for the string &ldquo;This function was patched&rdquo; after disassembling and code analysis. Gotcha?! Let&rsquo;s see&hellip; .</p>
<p>Now, this is the disassembly decompiled by Ghidra:</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="kt">void</span> <span class="n">sub</span><span class="p">.</span><span class="n">nominal_type_descriptor_for_Dispatch</span><span class="p">.</span><span class="n">DispatchWorkItemFlags_7bd0</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">arg1</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">arg2</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">arg3</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">undefined8</span> <span class="n">uVar1</span><span class="p">;</span>
    <span class="n">undefined8</span> <span class="n">uVar2</span><span class="p">;</span>
    <span class="n">undefined8</span> <span class="n">uVar3</span><span class="p">;</span>
    <span class="n">undefined8</span> <span class="n">uVar4</span><span class="p">;</span>
    <span class="n">undefined8</span> <span class="o">*</span><span class="n">puVar5</span><span class="p">;</span>
    <span class="n">undefined8</span> <span class="n">uVar6</span><span class="p">;</span>
    <span class="kt">int64_t</span> <span class="n">var_30h</span><span class="p">;</span>
    
    <span class="n">puVar5</span> <span class="o">=</span> <span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">_reloc</span><span class="p">.</span><span class="n">type</span> <span class="n">metadata</span> <span class="k">for</span> <span class="n">Any</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">arg1</span> <span class="o">&amp;</span> <span class="mi">1U</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">uVar1</span> <span class="o">=</span> <span class="n">Swift</span><span class="p">.</span><span class="n">_allocateUninitializedArray</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builtin</span><span class="p">.</span><span class="n">Word</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">Swift</span><span class="p">.</span><span class="n">Array</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Builtin</span><span class="p">.</span><span class="n">RawPointer</span><span class="p">)(</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">uVar6</span> <span class="o">=</span> <span class="mh">0x19</span><span class="p">;</span>
        <span class="n">uVar2</span> <span class="o">=</span> <span class="n">Swift</span><span class="p">.</span><span class="n">String</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="nl">_builtinStringLiteral</span><span class="p">:</span> <span class="n">Builtin</span><span class="p">.</span><span class="n">RawPointer</span><span class="p">,</span> <span class="nl">utf8CodeUnitCount</span><span class="p">:</span> <span class="n">Builtin</span><span class="p">.</span><span class="n">Word</span><span class="p">,</span> <span class="nl">isASCII</span><span class="p">:</span> <span class="n">Builtin</span><span class="p">.</span><span class="n">Int1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Swift</span><span class="p">.</span><span class="n">String</span>
                          <span class="p">(</span><span class="s">&#34;This function was patched&#34;</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">puVar5</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">_reloc</span><span class="p">.</span><span class="n">type</span> <span class="n">metadata</span> <span class="k">for</span> <span class="n">Swift</span><span class="p">.</span><span class="n">String</span><span class="p">;</span>
        <span class="o">*</span><span class="n">puVar5</span> <span class="o">=</span> <span class="n">uVar2</span><span class="p">;</span>
        <span class="n">puVar5</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">uVar6</span><span class="p">;</span>
        <span class="n">uVar3</span> <span class="o">=</span> <span class="n">_</span><span class="err">$</span><span class="n">ss5print_9separator10terminatoryypd_S2StFfA0_</span><span class="p">();</span>
        <span class="n">uVar2</span> <span class="o">=</span> <span class="n">uVar6</span><span class="p">;</span>
        <span class="n">uVar4</span> <span class="o">=</span> <span class="n">_</span><span class="err">$</span><span class="n">ss5print_9separator10terminatoryypd_S2StFfA1_</span><span class="p">();</span>
        <span class="n">Swift</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="nl">_</span><span class="p">:</span> <span class="n">Any</span><span class="p">...,</span> <span class="nl">separator</span><span class="p">:</span> <span class="n">Swift</span><span class="p">.</span><span class="n">String</span><span class="p">,</span> <span class="nl">terminator</span><span class="p">:</span> <span class="n">Swift</span><span class="p">.</span><span class="n">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">()</span>
                  <span class="p">(</span><span class="n">uVar1</span><span class="p">,</span> <span class="n">uVar3</span><span class="p">,</span> <span class="n">uVar6</span><span class="p">,</span> <span class="n">uVar4</span><span class="p">,</span> <span class="n">uVar2</span><span class="p">);</span>
        <span class="n">swift_bridgeObjectRelease</span><span class="p">(</span><span class="n">uVar2</span><span class="p">);</span>
        <span class="n">swift_bridgeObjectRelease</span><span class="p">(</span><span class="n">uVar6</span><span class="p">);</span>
        <span class="n">swift_bridgeObjectRelease</span><span class="p">(</span><span class="n">uVar1</span><span class="p">);</span>
        <span class="n">swift_retain</span><span class="p">(</span><span class="n">arg3</span><span class="p">);</span>
        <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">code</span> <span class="o">*</span><span class="p">)</span><span class="n">arg2</span><span class="p">)();</span>
        <span class="n">swift_release</span><span class="p">(</span><span class="n">arg3</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">swift_retain</span><span class="p">(</span><span class="n">arg3</span><span class="p">);</span>
        <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">code</span> <span class="o">*</span><span class="p">)</span><span class="n">arg2</span><span class="p">)();</span>
        <span class="n">swift_release</span><span class="p">(</span><span class="n">arg3</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>And the original assembly code:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">0x00007c80      bl      Swift.String.init(_builtinStringLiteral: Builtin.RawPointer, utf8CodeUnitCount: Builtin.Word, isASCII: Builtin.Int1) -&gt; Swift.String ; sym.imp.Swift.String.init__builtinStringLiteral:_Builtin.RawPointer__utf8CodeUnitCount:_Builtin.Word__isASCII:_Builtin.Int1_____Swift.String
0x00007c84      adrp    x9, reloc.nominal type descriptor for Dispatch.DispatchWorkItemFlags ; 0xc000
0x00007c88      ldr     x9, [x9, 0x10] ; 0xc010
                                   ; reloc.type_metadata_for_Swift.String
0x00007c8c      ldr     x10, [var_20h] ; 0x20
0x00007c90      str     x9, [x10, 0x18]
0x00007c94      str     x0, [x10]
0x00007c98      str     x1, [x10, 8]
0x00007c9c      bl      _$ss5print_9separator10terminatoryypd_S2StFfA0_ ; sym.__ss5print_9separator10terminatoryypd_S2StFfA0
0x00007ca0      str     x0, [sp, 0x18]
0x00007ca4      str     x1, [sp, 0x10]
0x00007ca8      bl      _$ss5print_9separator10terminatoryypd_S2StFfA1_ ; sym.__ss5print_9separator10terminatoryypd_S2StFfA1
0x00007cac      ldr     x3, [var_28h] ; 0x28
0x00007cb0      str     x0, [sp, 8]
0x00007cb4      mov     x0, x3
0x00007cb8      ldr     x4, [var_18h] ; 0x18
0x00007cbc      str     x1, [sp]
0x00007cc0      mov     x1, x4
0x00007cc4      ldr     x2, [var_10h] ; 0x10
0x00007cc8      ldr     x3, [var_8h]
0x00007ccc      ldr     x4, [sp]
0x00007cd0      bl      Swift.print(_: Any..., separator: Swift.String, terminator: Swift.String) -&gt; () ; sym.imp.Swift.print__:_Any...__separator:_Swift.String__terminator:_Swift.String
                                   ; Swift.print(_: Any..., separator: Swift.String, terminator: Swift.String) -&gt; ()
0x00007cd4      ldr     x0, [sp]
0x00007cd8      bl      swift_bridgeObjectRelease ; sym.imp.swift_bridgeObjectRelease
0x00007cdc      ldr     x0, [var_10h] ; 0x10
0x00007ce0      bl      swift_bridgeObjectRelease ; sym.imp.swift_bridgeObjectRelease
0x00007ce4      ldr     x0, [var_28h] ; 0x28
0x00007ce8      bl      swift_bridgeObjectRelease ; sym.imp.swift_bridgeObjectRelease
0x00007cec      ldr     x0, [var_38h] ; 0x38
0x00007cf0      bl      swift_retain ; sym.imp.swift_retain
0x00007cf4      ldr     x20, [var_38h] ; 0x38
0x00007cf8      ldur    x9, [var_30h]
0x00007cfc      blr     x9
0x00007d00      ldr     x9, [var_38h] ; 0x38
0x00007d04      mov     x0, x9
0x00007d08      bl      swift_release ; sym.imp.swift_release
0x00007d0c      ldp     x29, x30, [var_70h]
0x00007d10      ldp     x20, x19, [var_60h]
0x00007d14      add     sp, sp, 0x80 ; 0x178000
0x00007d18      ret
</code></pre></div><p>üï∞ <code>22:11 PM</code>. Now, I am going to hook into my target application and see what modules are running within its process memory space. For this I need to get a PID of this application. I use <code>frida-ps -H 192.168.1.79 | grep &lt;partial_app_name&gt;</code>. Now with the PID I am hooking into this process to see all modules it&rsquo;s running <code>frida -H 192.168.1.79 -p 958</code>. Then, with the frida promt I run <code>Process.enumerateModules()</code>. There, right on top somewhere very close to the application name itself I see this:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
        <span class="nt">&#34;base&#34;</span><span class="p">:</span> <span class="s2">&#34;0x1024c8000&#34;</span><span class="p">,</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;InterestingModule&#34;</span><span class="p">,</span>
        <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;/private/var/containers/Bundle/Application/4A444E04-2CFF-488A-B05C-7EC2D76D9AED/myapp.app/Frameworks/InterestingModule.framework/InterestingModule&#34;</span><span class="p">,</span>
        <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">49152</span>
    <span class="p">}</span><span class="err">,</span>
</code></pre></div><p>Hooray, I have its base address in memory. To get to my part of code, I need the functions offset. For this I am using <code>radare2</code>. But since I can hardly keep my eyes open, I am going to pause here for some time&hellip; . Good night! üò¥</p>
<h2 id="references">References</h2>
<p>[<a href="https://www.reddit.com/r/jailbreakdevelopers/comments/hh32p8/tutorial_how_to_hook_swift_method_with_frida/">1</a>], [<a href="https://syrion.me/blog/ios-swift-antijailbreak-bypass-frida/">2</a>] Hooking and tampering with Swift using frida</p>
<p>[<a href="https://grepharder.github.io/blog/0x01_intro_to_reversing_ios_swift_apps_with_radare2.html">3</a>] Reversing Swift with radare2</p>
<p>[<a href="https://grepharder.github.io/blog/0x04_calling_ios_native_functions_from_python_using_frida_and_rpc.html">4</a>] Calling native iOS functions with frida</p>
<p>[<a href="https://r2wiki.readthedocs.io/en/latest/options/p/pd-sz/">5</a>] radare2 wiki</p>
<p>[<a href="https://academy.realm.io/posts/goto-mike-ash-exploring-swift-memory-layout/">6</a>] Swift memory layout</p>
<p>[<a href="https://nik.re/posts/2020-05-15/debugging_and_instrumenting_swift_apps_ios_13">7</a>] Swift instrumenting with Frida on iOS 13</p>
<p>[<a href="https://blog.nvisium.com/dont-touch-me-that-way">8</a>] Don&rsquo;t Touch Me That Way by nVisium. Also available here on YouTube [<a href="https://youtu.be/XhXIHVGCFFM">9</a>].</p>
<p>[<a href="https://github.com/sensepost/objection/wiki/Understanding-the-iOS-Biometrics-Bypass">10</a>] Objection <code>ios ui biometrics_bypass</code> article</p>
<p>[<a href="https://www.guardsquare.com/blog/two-attack-scenarios-will-defeat-your-diy-ios-app-protection">11</a>] To read. Different ways to attack in runtime.</p>
<p>[<a href="http://highaltitudehacks.com/">12</a>] Blog on exploiting ARM + [<a href="http://highaltitudehacks.com/2018/07/24/ios-application-security-part-49-runtime-patching-with-frida/">13</a>] This article from the blog. Perhaps some functions are still Obj-C and can be easier manipulated + [<a href="http://highaltitudehacks.com/2018/07/24/ios-application-security-part-48-frida-apis/">14</a>] + [<a href="http://highaltitudehacks.com/2018/07/23/ios-application-security-part-47-inspecting-apps-with-frida/">15</a>]</p>
<p>[<a href="https://www.ibm.com/docs/ssw_ibm_i_72/rzarg/name_mangling.htm#:~:text=Name%20mangling%20is%20the%20encoding,and%20visibility%20within%20different%20scopes.">16</a>] About name mangling</p>
<p>[<a href="https://saml98.github.io/jekyll/update/2020/10/09/frida-tracing.html">17</a>] Observing the effects of an iOS button with Frida (Oct 9, 2020)</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.1237ff71925bb8625c97a9af8db4c54525258bedfd7c47493daaff723bea755e.js"></script>
  

  
  
  
    
  


</body>

</html>
