<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title> - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.9d91cbb32c96c334ae7b38c3d99d30727e0836e1182125cc5f007d215f0b9e59.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-forensics 🔍 and incident response 🥷">
      <a href="/docs/dfir">
        <span>Forensics 🔍 and Incident Response 🥷</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-forensics 🔍 and incident response 🥷">
      <a href="/docs/dfir">
        <span>Forensics 🔍 and Incident Response 🥷</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/blog/"> Back to Blog ✍️ Section 👈🏼 </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#case-details">Case Details</a></li>
    <li><a href="#questions">Questions</a>
      <ul>
        <li><a href="#1-wmi-event-consumer-name">1. WMI Event Consumer name?</a></li>
        <li><a href="#2-parent-pid-name">2. Parent PID Name?</a></li>
        <li><a href="#3-sha256-hash-of-the-file-extracted">3. SHA256 hash of the file extracted</a></li>
        <li><a href="#4-file-downloaded-hash">4. File downloaded Hash</a></li>
        <li><a href="#5-os-component-hash">5. OS component Hash</a></li>
      </ul>
    </li>
    <li><a href="#strategy">Strategy</a></li>
    <li><a href="#investigation">Investigation</a></li>
  </ul>
</nav>
 </aside>
 </div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title"></h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p>⛔️  Spoiler alert!</p>
<h2 id="case-details">Case Details</h2>
<p>This is not an investigation like the previous one. This is threat hunting. So, we have only logs via Kibana available. To harden my knowledge with this technologies I&rsquo;ve had a very quick overview on ElasticStack website and enrolled in <a href="https://app.pluralsight.com/paths/skills/threat-hunting-with-the-elastic-stack">this</a> course. Basically, I will have to answer questing having a loads of logs and a query engine available.</p>
<h2 id="questions">Questions</h2>
<h3 id="1-wmi-event-consumer-name">1. WMI Event Consumer name?</h3>
<p>✅ <em>The Threat Hunting process usually starts with the analyst making a hypothesis about a possible compromise vector or techniques used by an attacker. In this scenario, your initial hypothesis is as follows: &ldquo;The attacker used the WMI subscription mechanism to obtain persistence within the infrastructure&rdquo;. Verify this hypothesis and find the name of the WMI Event Consumer used by the attacker to maintain his foothold.</em></p>
<p>I&rsquo;ve followed the URL in the VM, but there was nothing there. However, there was on port 5601. I opened <em>Discover</em> tab in Kibana. I was not very creative, so, I just filtered by <em>WMI</em> keyword. Then, I&rsquo;ve looked through the entries and added a <em>Consumer name</em> column (since this one does have a name). In the results, I&rsquo;ve found the most suspicious one and was right.</p>
<h3 id="2-parent-pid-name">2. Parent PID Name?</h3>
<p>✅ <em>In the previous step, you looked for traces of the attacker&rsquo;s persistence in the compromised system through a WMI subscription mechanism. Now find the process that installed the WMI subscription. Answer the question by specifying the PID of that process and the name of its executable file, separated by a comma without spaces.</em></p>
<p>The first idea that comes to mind is to find a field <code>parent_pid</code> or alike and see, which process was the initiator. Another way is to see, when the whole process of WMI subscription was initialized and set the time frame before that. Consumer binding (final step) took place at <code>23:26</code>, so we are looking for processes logs before that.</p>
<p>So, it happened on <code>June 21, 2021</code> 📆, at <code>23:25:47</code> 🕰 (doesn&rsquo;t look like opeational hours, by the way). So, I&rsquo;ve set the filter from the 21th of June 2021, from <code>23:00</code> till <code>23:30</code>. I&rsquo;ve also filtered by keyword <code>wmi</code>.</p>
<p>Right before our WMI event, there was another one: winword.exe process. It&rsquo;s process id can be seen in <code>proc_id</code> column (it was helpful to add it as a column). So, the whole attack might have been started due to the word doc opening. So, our indicator might be like: <code>a winword.exe process that starts a wmi subscription</code> which doesn&rsquo;t even sound ok.</p>
<h3 id="3-sha256-hash-of-the-file-extracted">3. SHA256 hash of the file extracted</h3>
<p><em>The process described in the previous question was used to open a file extracted from the archive that user received by email. Specify a SHA256 hash of the file extracted and opened from the archive. Sample answer: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.</em></p>
<p>Moving back in time, I&rsquo;ll try to change the keyword to <code>winword.exe</code> and leave the timeframe the same. Though the time is not within operational hours, I still want to start as close to the WMI event as possible and then move backwards in time.</p>
<p>But first, I&rsquo;ll examine the event from the previous question. Looks like there is a field <code>proc_cmdline</code> specifying parameters when the process <code>winword</code> was launched. And the doc name is there too: <code>OPEC  crude oil production.docx</code>. So, let&rsquo;s filter by this keyword keeping the timeframe the same just yet. I will also add <code>file_sha256</code> field to ease the search.</p>
<p>Each time the word process loads a library, a new log entry is created. I would like to filter out all such events at least for now. And I want to opt in to <code>docx</code> files only. So, I&rsquo;m adding the filter <code>file_name:*.docx</code>.</p>
<p>We also need to keep in mind the sequence of events: email received -&gt; archive opened -&gt; opened with <code>winword.exe</code>. Add filter for <code>OUTLOOK.EXE</code>.</p>
<p><code>n</code> switch seems malicious when used with <code>docx</code> files, since it opens a file without creating a window instance. <code>o</code>  switch doesn&rsquo;t have any description over the Internet.</p>
<p><code>report.zip</code> - 1 hit, File Created. Some zip archive was saved to disk prior to the attack. However, no SHA256 was provided by the log files. Let&rsquo;s see the same folder. May something was created in the same folder&hellip; .</p>
<p>Somehow <code>NOT file_name:*.dll</code> didn&rsquo;t work. Search for <code>report.zip</code> returns only one result: file created by Outlook. Let&rsquo;s see who opened it and where was it moved or saved later?</p>
<p><code>event_type:FileOpen</code> and keyword <code>*.zip</code> -&gt; one hit again. Some <code>Temp_report.zip</code> file was decompressed to <code>market forecast Emma.docx</code>, but no signs of the <code>report.zip</code> saved to the initial directory. However, in the process description there was <code>OPEC  crude oil production.docx</code> mentioned again. Was the zip file renamed and moved and then the file decompressed also renamed? That was the correct answer. Althout, I don&rsquo;t quite get the exact chain of events.</p>
<ol>
<li>File downloaded and saved by Outlook.exe as report.exe in the (filter: <code>event_type:FileCreate AND </code>)</li>
</ol>
<h3 id="4-file-downloaded-hash">4. File downloaded Hash</h3>
<p><em>The file mentioned in question 3, is not malicious in and of itself, but when it is opened, another file is downloaded from the Internet that already contains the malicious code. Answer the question by specifying the address, from which this file was downloaded, and the SHA256 hash of the downloaded file, separated by commas without spaces.</em></p>
<h3 id="5-os-component-hash">5. OS component Hash</h3>
<p><em>The malicious code from the file, mentioned in question 4, directly installed a WMI subscription, which we started our hunting with, and also downloaded several files from the Internet to the compromised host. For file downloading, the attacker used a tricky technique that gave him the opportunity to hide the real process, which initiated the corresponding network activity. Specify the SHA256 hash of the operating system component whose functionality was used by the attacker to download files from the Internet.</em></p>
<h2 id="strategy">Strategy</h2>
<h2 id="investigation">Investigation</h2>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.1237ff71925bb8625c97a9af8db4c54525258bedfd7c47493daaff723bea755e.js"></script>
  

  
  
  
    
  


</body>

</html>
