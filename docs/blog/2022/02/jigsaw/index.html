<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Game Over - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ü™§">
      <a href="/docs/thunting">
        <span>Threat Hunting ü™§</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ü™§">
      <a href="/docs/thunting">
        <span>Threat Hunting ü™§</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/blog/"> üëàüèº Back to </br> Blog ‚úçÔ∏è </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#-toolkit">üß∞ Toolkit</a></li>
    <li><a href="#-investigation">üîé Investigation</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Game Over</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      
      <div class="article-category">
          
            
              <i class="fab fa-windows"></i>          
            
            
            
            
            
            
          
          
      </div> <br />
      

      
      <div class="article-category">
        <i class="fas fa-tools"></i>
          
          
          <a class="platform-link" href="/tools/parallels">Parallels</a> 
          
           , 
          <a class="platform-link" href="/tools/dcode">DCode</a> 
          
           , 
          <a class="platform-link" href="/tools/cqevtxrecovery">CQEVTXRecovery</a> 
          
           , 
          <a class="platform-link" href="/tools/dnspy">dnspy</a> 
          
           , 
          <a class="platform-link" href="/tools/mftcmd">MFTCmd</a> 
          
           , 
          <a class="platform-link" href="/tools/chainsaw">chainsaw</a> 
          
           , 
          <a class="platform-link" href="/tools/dumpit">Dumpit</a> 
          
           , 
          <a class="platform-link" href="/tools/windd">WinDD</a> 
          
      </div> <br />
      
      

      
      <div class="article-tag">
          <i class="fas fa-tag"></i>
          
          
          <a class="tag-link" href="/tags/case" rel="tag">case</a>
          
      </div> 
      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p><em>One sunny üòé day I came to a coworking office very early in the morning. As usual, I&rsquo;ve decided to kick it off with a freshly brewed coffee which we never had, so, I had to go with an instant substitute. Ugh üò£! I was hoping to savour my disgust meditating over the Feedly recents, when I noticed that I was not the only lark that day. Mark, a freelance designer who happened to be a huge fan of Assassin&rsquo;s Creed games (just like me), was sitting in the corner of the shared kitchen with his laptop, looking so gloomy that I was sorry I didn&rsquo;t take my ‚òîÔ∏è with me. When I&rsquo;ve forced the last sip of that potion inside, I wished him good morning and headed to my working nest. He didn&rsquo;t respond though, which was weird, since he usually was very friendly. I thought he needed some time on his own and was about to leave the kitchen when suddenly he hailed me. Long story short, he seemed to get himself a virus and didn&rsquo;t know how to get rid of it. He seemed scared, since lots of important files were encrypted.</em></p>
<p><em>I was prettry sure that a ransomware was in place and after checking the file system of my poor fellow and seeing lots of files with a peculiar .fun extension, I&rsquo;ve become sure of it.</em></p>
<h2 id="-toolkit">üß∞ Toolkit</h2>
<p>Windows 11 Parallels VM installed on a MacBook Pro.</p>
<p><strong>RAM Acquisition</strong>: <code>WinDD.exe</code> (tried using Dumpit.exe, due to a small footprint, but didn&rsquo;t work on a Win11 machine).</p>
<p><strong>Memory analysis</strong>: volalitility 3 and Excel to open csv and filter the vol3 output  produced by other utilities)</p>
<p><strong>Other</strong>: DCode v5.5 (for registry timestamps translation),  CQEVTXRecovery for Event Logs repair, chainsaw 1.1.5 for Event Logs automated analysis, Event Viewer to view repaired Event Logs, Eric Zimmerman‚Äôs tools (MFTCmd).</p>
<p><strong>Reverse Engineering</strong>:  dnspy 6.1.8 (x64).</p>
<h2 id="-investigation">üîé Investigation</h2>
<p>üìÖ <code>11/02/2022</code></p>
<p>‚è∞ <code>7:05 AM</code></p>
<p>A quick <a href="https://fileinfo.com/extension/fun#:~:text=A%20FUN%20file%20is%20a,DOCX%2C%20.">google search</a> suggested that these files might have been encrypted with a childish ransomware Jigsaw ü™ö.</p>
<blockquote>
<p>‚ö†Ô∏è However, according to the same very search, I was supposed to see a banner that would show some address and the amount wanted, which I didn&rsquo;t.</p>
</blockquote>
<p>I&rsquo;ve decided to go with a RAM analysis since I was not sure about full functionality of the malware and what impact any of my manipulations could  have caused on a live system. What if it starts deleting files when you try attaching a debugger?</p>
<p>So, I started <code>WinDD.exe</code>  from a USB drive, saving the file as <code>poormark.dmp</code>. As a good diligent forensicator, I immediately calculated MD5 and SHA256 hash values to put them into a report.</p>
<p>So, the first thing I usually do and am going to do now is running a vol3 <code>netscan</code> pluging to see all open connections. Sometimes it&rsquo;s the quickest way to spot that something is not right, since there is not that wealth of info unlike with other plugins&rsquo; output (using <a href="https://blog.onfvp.com/post/volatility-cheatsheet/">this</a> and <a href="https://book.hacktricks.xyz/forensics/basic-forensic-methodology/memory-dump-analysis/volatility-examples">this</a> cheat sheets).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python39 <span class="c1"># activating python39 with a alias for pyenv</span>
</span></span><span class="line"><span class="cl">vol3 -f poormark.dmp windows.netscan.NetScan &gt; netscan.csv
</span></span></code></pre></div><p>Since I already know I will need the output for several other commands, it&rsquo;s better to do so now.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vol3 -f poormark.dmp windows.pslist.PsList &gt; pslist.csv
</span></span><span class="line"><span class="cl">vol3 -f poormark.dmp windows.psscan.PsScan &gt; psscan.csv
</span></span><span class="line"><span class="cl">vol3 -f poormark.dmp windows.pstree.PsTree &gt; pstree.csv
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">vol3 -f poormark.dmp windows.cmdline &gt; cmdline.csv
</span></span><span class="line"><span class="cl">vol3 -f poormark.dmp windows.filescan.FileScan &gt; filescan.csv
</span></span><span class="line"><span class="cl">vol3 -f poormark.dmp windows.malfind.Malfind &gt; malfind.txt
</span></span></code></pre></div><p>Now, I am going to import this data to an Excel workbook, a sheet for each output (File -&gt; Import -&gt; CSV file, space as a delimiter). Now, I can add filters to each, delete blank rows and start working.</p>
<p>Sip, sip ‚òïÔ∏è &hellip; .</p>
<p><img src="https://media3.giphy.com/media/g43ZqCrsNRbpu/giphy.gif?cid=790b7611cf82928f0a99a24c32a1caccd506483f0abf837d&amp;rid=giphy.gif&amp;ct=g" alt="img"></p>
<p>That&rsquo;s ok&hellip; . The sooner I finish, the sooner I can get myself a treat.</p>
<p>As suggested my Michael Leclair from the SDF series (Udemy) and his podcasts, I&rsquo;ve started from looking for any deviations from the normal bahaviour of Windows core process (child-parent, boot time, singleton or not etc).</p>
<blockquote>
<p>‚úçÔ∏è I was using my own <a href="docs/dfir/investigation/processes/core/win-core/">article</a> about that based on the mentioned resources. I&rsquo;ve tried to organise all of this data for convenience and it turned out to be not that convenient in the real life, so I will be working on that.</p>
</blockquote>
<p>Well. Nothing from that angle. But it was a valid shot. Need another sip of that repellent coffee ‚òïÔ∏è.</p>
<p>‚è∞ <code>7:20 AM</code></p>
<p>Hm. The motivation to get myself a sip of better liquid (any liquid would be better, I guess) seemed to make a better impact on my deduction powers.</p>
<p>I&rsquo;ve spotted two unusual processes: <em>firefox.exe</em> (PID 1234) and <em>drpbx.exe</em> (PID 2626). Both processes were <em><strong>orphaned</strong></em> though they usually have <em>explorer.exe</em> (PID 1377) as a parent. They were spawned by different parents though: <em>firefox</em> PPID 1580 and <em>drpbx</em> 2123. <em>Firefox.exe</em> started today at 06:25:20 and <em>drpbx.exe</em> roughly a minute afterwards at 06:26:22. The strange thing is that they are orphaned i.e. don&rsquo;t have a parent in the process tree. In case of these two particular executables (it is if they both are legitimate) they should have been started by <code>explorer.exe</code>, a Zeus in the realm of Windows user processes üòÉ. Hm, curiouser and curiouser ü§î.</p>
<p>Sip, sip ‚òïÔ∏è ü§¢&hellip; .</p>
<p>Since <em>pslist</em> plugin uses a doubly linked list of processes pointed by <code>PsActiveProcessHead</code>, the information produced is identical to that shown by Task Manager, Process Explorer or alike. <code>psscan</code>, on the other hand, uses another technique and can sometimes be used to retrieve unlinked, hidden processes. Let&rsquo;s try this one instead, compare the results and see, may be either 1580 or 2123 are still there&hellip; .</p>
<p>‚è∞ <code>7:22 AM</code></p>
<p>Nope. Neither. Hm, let&rsquo;s compare the output of the <code>pslist</code> and <code>psscan</code>. Should probably write a bash script for that tedious task.</p>
<p>‚è∞ <code>7:30 AM</code></p>
<p>Sip, sip, sip ‚òïÔ∏è ü§¢ü§¢&hellip; .</p>
<p>Nope again. Sad.</p>
<p>The absence of parent processes is not the only suspicious thing about both of these executables. <code>malfind</code> plugin also returned several alerts ‚ö†Ô∏è. So, it&rsquo;s worth diving deeper. I wonder&hellip;</p>
<p>Sip, sip, sip ‚òïÔ∏è ü§¢ü§¢&hellip; .</p>
<p>Hm. I am looking at the <code>filescan</code> output and I like these <code>firefox.exe</code> and <code>drpbx.exe</code> even less&hellip; . Why do they have such unusual paths? Is it ok for these guys? Besides, there <em>is</em> another <code>firefox.exe</code> on this system with a more conventional path.</p>
<p><code>drpbx.exe</code> itself is named unusually for a legitimate software. Come on! <code>drpbx.exe</code>? What&rsquo;s it, like, a Czech üá®üáø software? Also, it is stored in the same location and using alike name as this weirdo <code>firefox.exe</code>.</p>
<p><img src="images/drpbxpath.png" alt="drpbxpath"></p>
<p><img src="images/firefoxpath.png" alt="firefoxpath"></p>
<p>‚è∞ <code>7:40 AM</code></p>
<p>Ok, that&rsquo;s it. Enough of this peeking and stalking. That&rsquo;s get my hands on this sample at get it thoroughly examined. I know its PID and I can try dumping it with the <code>dumpfiles</code> plugin.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vol3 -f poormark.dmp  windows.dumpfiles.DumpFiles --pid <span class="m">1234</span>
</span></span></code></pre></div><p>Cool! Let&rsquo;s get now the second fellow!</p>
<p>‚è∞ <code>7:41 AM</code></p>
<p>Oops. This one doesn&rsquo;t give up that easily. However, I could try dumping it using the offsets that I got from the <code>filescan</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vol3 -f poormark.dmp  windows.dumpfiles.DumpFiles --physaddr 0xxxxxxx
</span></span></code></pre></div><p>It worked üßü‚Äç‚ôÇÔ∏èüß™! It&rsquo;s now time to upload them both to a VirusTotal then.</p>
<p>‚è∞ <code>7:45 AM</code></p>
<p>It looks like these are both the same thing and that thing is not nice. Going by the name <em>BitcoinBlackmailer.exe</em> or <em>Jigsaw Ransomware</em>, it might be spooky, but not that desctructive as it may seem. Looks like it&rsquo;s a .NET malware (meaning, it can be decompiled into something more friendly than hardcore Assembly) and moreover looks like the data needed for decryption is contained in that executable. Wow. Piece of cake? Or a trap&hellip; ?</p>
<p><img src="images/Picture1.png" alt="Picture 1"></p>
<p>‚è∞ <code>7:46 AM</code></p>
<p>Ok, let&rsquo;s see what else I can dig, this time from the <code>cmdline</code> output. Hm. Looks like <code>drpbx.exe</code> was launched by another executable, some <code>install.exe</code>.</p>
<p><img src="images/cmdlineooutput.png" alt="cmdlineooutput"></p>
<p>Fine, that&rsquo;s dump this one as well and get it scanned by VT.</p>
<p>‚è∞ <code>7:47 AM</code></p>
<p>What the heck? This one is yet another instance of the same crap. Looks like I am getting to the point when reverse engineering is unavoidable.</p>
<p>Well, how about approaching this from another end? Grepping and stuff. What if I check, what clues can I get from the <code>AssassinsCreedUnity</code> keyword&rsquo;s surroundings in RAM.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">strings poormark.dmp <span class="p">|</span> grep <span class="s2">&#34;AssassinsCreedUnity&#34;</span> -C2
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="se">\H</span>fref<span class="se">\N</span>qzvavfgengbe<span class="se">\N</span>ccQngn<span class="se">\Y</span>bpny<span class="se">\Q</span>ecok<span class="se">\q</span>ecok.rkr
</span></span><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ownloads<span class="se">\A</span>ssassinsCreedUnity<span class="se">\i</span>nstall.exe
</span></span><span class="line"><span class="cl">URLDownloadToCacheFileW
</span></span></code></pre></div><p>Aha! Gotcha! Wait, what? Official Windows API <a href="https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775122(v=vs.85)">docs</a> give a little insight as to what this function is used for. Looks like this one is responsible for automatically saving the files on the system and showing that pop-up <em>Open</em> when it&rsquo;s done, in IE. Good, looks like Mark was digging his own grave with his own hands üôå. Looks like Mark wanted to save some money on AssassinsCreed Edition&hellip; . Ay Ay Ay! Since the Downloads folder contained this malware, it could be great proof of knowledge and intentional download of the file. However, that wouldn&rsquo;t prove that the user knew about the true functionality of the executable.</p>
<p>But wait, there is also something pretty weird above this <em>AssassinsCreedUnity</em> keyword. Some string, that looks pretty much like a ROT13 encoded path. Let&rsquo;s see, what it really is (using <a href="https://cryptii.com/pipes/rot13-decoder">Cryptii</a> for that):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="se">\H</span>fref<span class="se">\N</span>qzvavfgengbe<span class="se">\N</span>ccQngn<span class="se">\Y</span>bpny<span class="se">\Q</span>ecok<span class="se">\q</span>ecok.rkr
</span></span><span class="line"><span class="cl"><span class="c1"># turns into, wait for it... .</span>
</span></span><span class="line"><span class="cl"><span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\D</span>rpbx<span class="se">\d</span>rpbx.exe
</span></span></code></pre></div><p>Why is it ROT13 encoded then? Well, it might be a UserAssist key, since the paths are indeed ROT13 encoded when written there. Ok, may be I will find other clues using the save technique, but a different keyword:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">strings poormark.dmp <span class="p">|</span> grep <span class="s2">&#34;qecok.rkr&#34;</span> -C2
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="se">\H</span>fref<span class="se">\N</span>qzvavfgengbe<span class="se">\N</span>ccQngn<span class="se">\E</span>bnzvat<span class="se">\S</span>esk<span class="se">\s</span>versbk.rkr
</span></span><span class="line"><span class="cl"><span class="se">\H</span>fref<span class="se">\N</span>qzvavfgengbe<span class="se">\Q</span>bjaybnqf<span class="se">\N</span>ffnffvafPerrqHavgl<span class="se">\v</span>afgnyy.rkr
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>Voil√†! Something again.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="se">\H</span>fref<span class="se">\N</span>qzvavfgengbe<span class="se">\N</span>ccQngn<span class="se">\E</span>bnzvat<span class="se">\S</span>esk<span class="se">\s</span>versbk.rkr
</span></span><span class="line"><span class="cl"><span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ownloads<span class="se">\A</span>ssassinsCreedUnity
</span></span><span class="line"><span class="cl"><span class="c1"># turns into, wait for it... .</span>
</span></span><span class="line"><span class="cl"><span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\F</span>rfx<span class="se">\f</span>irefox.exe
</span></span><span class="line"><span class="cl"><span class="se">\H</span>fref<span class="se">\N</span>qzvavfgengbe<span class="se">\Q</span>bjaybnqf<span class="se">\N</span>ffnffvafPerrqHavgl<span class="se">\v</span>afgnyy.rkr
</span></span></code></pre></div><p>So, now I know that all the three malicious executables are likely present in UserAssist registry key. So, that&rsquo;s where I think I am going to go next. Since registry is hanging out in RAM while the PC is running, being updated constantly, there is an option to dump the whole hive (failed doing so) or just dump specific keys using <code>windows.registry.printkey.PrintKey</code> or plugins specific to the key (<code>windows.registry.printkey.PrintKey</code>).</p>
<p>‚è∞ <code>7:54 AM</code></p>
<p>So, let&rsquo;s see, what&rsquo;s inside this UserAssist&hellip; .</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vol3 -f poormark.dmp windows.registry.userassist.UserAssist
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="se">\H</span>fref<span class="se">\N</span>qzvavfgengbe<span class="se">\Q</span>bjaybnqf<span class="se">\N</span>ffnffvafPerrqHavgl<span class="se">\v</span>afgnyy.rkr
</span></span><span class="line"><span class="cl"><span class="s2">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">00 00 00 00 01 00 00 00	........
</span></span></span><span class="line"><span class="cl"><span class="s2">00 00 00 00 00 00 00 00	........
</span></span></span><span class="line"><span class="cl"><span class="s2">00 00 80 bf 00 00 80 bf	........
</span></span></span><span class="line"><span class="cl"><span class="s2">00 00 80 bf 00 00 80 bf	........
</span></span></span><span class="line"><span class="cl"><span class="s2">00 00 80 bf 00 00 80 bf	........
</span></span></span><span class="line"><span class="cl"><span class="s2">00 00 80 bf 00 00 80 bf	........
</span></span></span><span class="line"><span class="cl"><span class="s2">00 00 80 bf 00 00 80 bf	........
</span></span></span><span class="line"><span class="cl"><span class="s2">ff ff ff ff 70 29 0A D5	.....,^`
</span></span></span><span class="line"><span class="cl"><span class="s2">74 1F d8 01 00 00 00 00	........&#34;</span>	False
</span></span></code></pre></div><p>Aha! So, there <em>is</em> this <code>install.exe</code> there. At the end of this hex digits row there is a timestamp. I will use DCode utility to convert little-endian hex <code>70290AD5741FD801</code> into Windows filetime UTC.</p>
<p><img src="images/dcode.png" alt="dcode"></p>
<p>What I can conlude by now is that this <code>install.exe</code> was launhed via its executable (not a shortcut). It was run a minute after <code>firefox.exe</code> and almost instantly followed by <code>drpbx.exe</code> which might suggest that it was this mysterious parent of <code>drpbx.exe</code>. Right after giving birth ü§∞ to this clone of its, this <code>install.exe</code> exited leaving the &ldquo;baby&rdquo; on its own.</p>
<p><code>01 00</code> at offset <code>0x4</code> tells me that this program was run once (<a href="https://bakerst221b.com/docs/dfir/investigation/configs/win-registry/#user-assist">ref</a>). However, the focus count is 0 and time focused is <code>0:00:00.500000</code> (<code>userassist</code> plugin converts this data from hex for readability). Looks like the user didn&rsquo;t spend too much time looking at at üëÄ.</p>
<p><em><strong>Focus time</strong></em> is the time the user spends looking at the windows on his desktop. Not neccessarilly really focusing&hellip; . So, the program needs to have GUI for that, and there must be switching between windows as well. As soon as the window gets activated, clicked on, the focus count is incremented.</p>
<p>UserAssist key for <code>drpbx.exe</code>, however, lacks the timestamp. Why? Also, <code>userassist</code> plugin is showing 3 focus count and 0:02:29 total time focused. Looks like <code>install.exe</code> quit almoust instantly and <code>drpbox</code> has been hanging there for a while. Besides, since the focus cound is 3, it&rsquo;s likely that Mark has seen the window. In other cases that could be a great proof of intent, but here I already know that he has just made a foolish mistake.</p>
<p><img src="images/drpbxuserass.png" alt="drpbxuserass"></p>
<p>Besides, if I add the results of <code>pslist</code> to this data, it seems that there have been just a few seconds between running the <code>install.exe</code> and <code>drpbx.exe</code>. It would be hard to do so manually.</p>
<p>Since there is no <code>install.exe</code> currently running and <code>drpbx</code> is orphaned, my assumption is that <code>install.exe</code> might have spawned  <code>drpbx</code>.</p>
<p>‚è∞ <code>8:04 AM</code></p>
<p>I can see Event logs in RAM as well. Let&rsquo;s try dumping them using <code>filescan</code> plugin with the offset again. May be something of interest will be there.</p>
<p>‚è∞ <code>8:04 AM</code></p>
<p>Ok, I&rsquo;ve managed to restore some of Event Logs using <code>CQEVTXRecovery.exe</code>, and run chainsaw utility against it hoping to spot anything suspicious.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">chainsaw hunt . --mapping /Users/user/Documents/toolkit/win/chainsaw/mapping_files/sigma-mapping.yml --rules /Users/user/Documents/toolkit/win/chainsaw/sigma_rules/ --csv result.csv
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">CQEVTXRecovery.exe -in pathwithlogs -out pathforresult
</span></span></code></pre></div><p>However, nothing was found this way.</p>
<p>Ok, I an as well open them with Event Viewer on a Windows VM and review manually (luckily, not to many records there). Or am I just not good enough in manually scrolling through these logs?</p>
<p><img src="https://media.giphy.com/media/rMckaUH3vrIk0/giphy.gif" alt="img"></p>
<p>‚è∞ <code>8:24 AM</code></p>
<p>As I thought, there is no helpful clue there as well. Alas! So, I think, it&rsquo;s time to get hands dirty with a little reverse engineering. I am going to open each of these three executables in dnspy tool for .NET RE and see, whether these are indeed the same thing.</p>
<p>Hm. The first thing I notice is that it&rsquo;s not that trivial. Might cause even more headache than this instant coffee (I think my husband would like to divorce me if he found out I call this potion <em>coffee</em>). But since he doesn&rsquo;t read my blog, I don&rsquo;t think it&rsquo;s going to happen.</p>
<p>I see a <code>ConfusedByAttribute</code> which I used to see many times before and even dedicated a blog <a href="/docs/blog/2018/04/dot-net-confuser/">post</a> about it.</p>
<p><img src="images/Picture2.png" alt="Picture2"></p>
<p>Static deobfuscation is time consuming, thus I am not doing it. Instead, I am going to make use of <em>Set Next Instruction</em> functionality of dnspy heavily used to control the program flow. Think of it as changing the value of EIP register, i.e. I can choose the next line to be executed within one function though. So, I am focusing on if-statements.</p>
<p>This malware indeed has the key inside the binary&hellip; . Not wise, dude. And also thank you for naming it so unconfusingly as well, <code>EncryptionPassword</code>. Belissimo! Going by the way it looks, it&rsquo;s likely encoded with Base64.</p>
<p><img src="images/Picture3.png" alt="Picture3"></p>
<p>Ok, but what type of encryption is this malware using? Hm&hellip; I see this <code>SymmetricAlgorithm</code> function. Great, but which one? Need some time to inspect the code which is not yet obfuscated.</p>
<p>‚è∞ <code>8:30 AM</code></p>
<p>Hm, lucky me, <code>SymmetricAlgorithm</code> in .NET is by default AES, CBC mode. So, apart from the <code>EncryptionPassword</code> I need a IV (initialization vector).</p>
<blockquote>
<p>ü§ûI promise, I will write an article about block ciphers some time in future!</p>
</blockquote>
<p>But I have not seen this IV or anything that would like it. Nothing. Hm. Let me check again.</p>
<p>‚è∞ <code>8:34 AM</code></p>
<p>No, there is not <em>yet</em>.  .NET confuser deobfuscates its code one piece at a time. So, in order to get the IV, I will have to start debugging. Ok. That&rsquo;s start. What the heeeeeel?! It seems that the executable just gets detached and is running happily in RAM anyway. What am I doing wrong?</p>
<p><img src="https://media.giphy.com/media/cLJdDcAWTkW6k/giphy.gif" alt="img"></p>
<p>‚è∞ <code>10:34 AM</code></p>
<p>Ok&hellip; I am utterly angry üò°. Several hours spent trying to figure out the reason for this happening and guess what? I even thought that this might be due to the fact that I am running it on a Windows 11 machine.</p>
<p>I opened some <em>Output</em> window. I wondered what would be shown there. And I saw something like <em>&ldquo;Cannot make an anti-debugging patch because the executable is not using it&rdquo;</em>. Really?! If it&rsquo;s not using it, DON&rsquo;T TRY PATCHING IT!!!</p>
<p><img src="images/lilaf.jpeg" alt="lilaf"></p>
<p>Ok, at least I have found this IV along the way.</p>
<p><img src="images/Picture4.png" alt="Picture4"></p>
<p>‚è∞ <code>10:44 AM</code></p>
<p>Ok, but what really happens? Why there are three identical files? I am launching the executable without a debugger and let&rsquo;s see what&rsquo;s going to happen. I will execute <code>install.exe</code>.</p>
<p>Ha! As I have suspected, <code>install.exe</code> spawns <code>drpbx.exe</code> and exits. But where is the firefox?</p>
<p>‚è∞ <code>10:46 AM</code></p>
<p>Well, debugging shows a part of code that seems to be all about that&hellip; . Eurika! I think, now I know, what has happened.</p>
<p>Ok, but what is the impact on the system after this malware has finished its naughty mission? Malware likes making use of common Windows persistance mechanisms. The most common is <code>Run</code> and <code>RunOnce</code> registry keys (specific to the user of system wide). Another common technique is to copy itself to the Startup folder. The path might differ from system to system. For Windows 11 these are <code>C:\Users\Username\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</code> and  <code>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp</code>.</p>
<ol>
<li>
<p><code>install</code>, <code>drpbx.exe</code> and <code>firefox.exe</code> are all different instances of the same code that copies itself to persist on the system.</p>
</li>
<li>
<p>When <code>install</code> is launched, it copies itself to <code>\Users\Administrator\AppData\Local\Drpbx\</code> as <code>drpbx.exe</code>, spawns <code>drpbx.exe</code> process and then quits, leaving the process orphaned. Then, depending on the settings, it might <em>wait until the system reboots</em>. This was the case here.</p>
</li>
<li>
<p>While still active the malware sets either the registry startup entry mentioned above or copies itself to either of the startup locations. In this case the registry key option was used.</p>
</li>
<li>
<p>After reboot the instance that persisted through the registry is launched. This instance encrypts documents producing files with <em>.fun</em> extension.</p>
</li>
</ol>
<p>However, one question remains: why both <code>firefox.exe</code> and <code>drpbx.exe</code> were found in memory? <code>install.exe</code> spawns <code>drpbx.exe</code> only, <code>firefox.exe</code> is started after the system reboots and RAM is cleared after reboot since it‚Äôs volatile. Besides, judging by the timestamps in <code>pslist</code>, <code>firefox.exe</code> was launched <strong>before</strong> <code>drpbx.exe</code> which should not have happened.</p>
<p>One of the most likely scenarios is that Mark first launched <code>install.exe</code> in attempt to install a game (going by the name of the folder <code>install.exe</code> was downloaded to). However, no game seemed to be installed and Mark tried rebooting the PC.</p>
<p>However, this didn‚Äôt work as well, and he tried executing the <code>install.exe</code> again. Only then he noticed that something went wrong. That can explain both <code>firefox.exe</code> and <code>drpbx.exe</code> hanging in RAM, <code>drpbx.exe</code> executing *<strong>after*</strong> <code>firefox.exe</code>. This might be a hint that the user didn‚Äôt know about the true functionality of the malware.</p>
<p>Great, now I have everything in my disposal to help the friend of mine to derypt his valuable files. Hey, Mark!</p>
<p>‚è∞ <code>10:50 AM</code></p>
<p>I&rsquo;ve given Mark several recommendation on how to remove the malware and get the PC cleaned afterwards. Below are these recommendations. By the ‚ùì OPTIONAL keyword I&rsquo;ve marked those recommendations that were not needed here, but could have been given in a real case when I don&rsquo;t know the user myself:</p>
<ol>
<li>
<p>‚úçÔ∏è Kill all of the following processes if they are still running on the system: <code>install.exe</code>, <code>drpbx.exe</code>, <code>firefox.exe</code>.</p>
</li>
<li>
<p>‚úçÔ∏è Delete the files from the following locations:</p>
<ol>
<li><code>\Users\Administrator\AppData\Roaming\Frfx\firefox.exe</code></li>
<li><code>\Users\Administrator\AppData\Local\Drpbx\drpbx.exe</code></li>
<li><code>\Users\Administrator\Downloads\AssassinsCreedUnity\install.exe</code></li>
<li><code>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\firefox.exe</code> for Win11</li>
<li><code>C:\Users\Username\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\firefox.exe</code> for Win11</li>
</ol>
</li>
<li>
<p>‚úçÔ∏è Clean the following registry key üîë : <code>SOFTWARE/Microsoft/Windows/CurrentVersion/Run</code>, if <code>\Users\Administrator\AppData\Roaming\Frfx\firefox.exe</code> is written there.</p>
</li>
<li>
<p>‚úçÔ∏è Use the python üêç script below to get your files back the files.</p>
</li>
<li>
<p>‚ùìOPTIONAL. In case I didn&rsquo;t have any context and didn&rsquo;t know Mark as well, I would suggest collecting other triage data from the system to make sure, that the malware was not spread through the network within the infrastructure and also to conduct additional investigation as to user intent and knowledge (Kansa, KAPE or other tools might be used for collection). The most relevant artefacts in this case would be the following:</p>
<ol>
<li>
<p>Eml, pst, ost files (in case malware was spread over email), however, I do have pretty strong evidence that it was downloaded via browser.</p>
</li>
<li>
<p>Evtx files (to find the URL the malware was likely downloaded from and possibly other malware as well or hacking activity, lateral movement if any etc)</p>
</li>
<li>
<p>Registry hives (to further prove intent or innocence, if needed).</p>
</li>
<li>
<p>Firefox, IE and Chrome browser history (in case the malware was downloaded using browser, which is the most likely scenario).</p>
</li>
</ol>
</li>
<li>
<p>‚ùìOPTIONAL. If it is confirmed that the user didn‚Äôt know about the true functionality of the malware, then the policy of the company and controls in place need to be reviewed as to what users are allowed to download and install what software.</p>
</li>
<li>
<p>‚ùìOPTIONAL. Also, employee security awareness training need to be regularly held, educating them on cybersecurity risks and threats.</p>
</li>
</ol>
<p>I&rsquo;ve also recommended him to buy the Unity edition, it&rsquo;s totally worth it anyway! And if he <em>is</em> risking online that carelessly, at least, use another user account, or even better, another PC.</p>
<p>If I didn&rsquo;t know Mark in person, I would probably try finding this link he used. For example, using regex or scrolling through the Event Logs.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">strings poormark.dmp <span class="p">|</span>  grep -Eo <span class="s2">&#34;(http|https)://[a-zA-Z0-9./?=_-]*&#34;</span> <span class="p">|</span> sort -u &gt; links.txt
</span></span></code></pre></div><p>‚è∞ <code>11:50 AM</code></p>
<p>The victory tastes almoust dizzyingly sweet.</p>
<p>PS. It took much less time to google the IV instead of manually reversing the file to get it. However, I just felt utterly uncomfortable not knowing why I cannot attach the debugger and not being able to get this IV myself.</p>
<p>PPS. By the way, below is my pythong script for decrypting using the above mentioned key üîë and IV.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># activate python39 env if you are using pyen or virtualenv</span>
</span></span><span class="line"><span class="cl">python39
</span></span><span class="line"><span class="cl">pip install pycryptodome
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span><span class="p">,</span> <span class="n">unpad</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">key</span><span class="o">=</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="s2">&#34;OoIsAwwF23cICQoLDA0ODe==&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s2">&#34;/path/to/important/file.fun&#34;</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">flag_file</span><span class="o">=</span><span class="n">flag</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">iv</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;0103530100206760&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="o">=</span><span class="n">iv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">original_data</span> <span class="o">=</span> <span class="n">unpad</span><span class="p">(</span><span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">flag_file</span><span class="p">),</span> <span class="n">AES</span><span class="o">.</span><span class="n">block_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">original_data</span><span class="p">)</span>
</span></span></code></pre></div>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
