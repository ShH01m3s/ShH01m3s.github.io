<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linux Forensics by Magnet Forensics - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.b67d7fec5daec98747a80616a05e9e1e96dc0976219c428241762578c5ae69c3.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-articles">
      <a href="/docs/articles">
        <span>Articles</span>
      </a>
    </li>
    
    <li class="menu-item-blog">
      <a href="/docs/blog">
        <span>Blog</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit">
      <a href="/docs/toolkit">
        <span>Toolkit</span>
      </a>
    </li>
    
    <li class="menu-item-about me">
      <a href="/docs/about">
        <span>About me</span>
      </a>
    </li>
    
    <li class="menu-item-achievements">
      <a href="/docs/achievements">
        <span>Achievements</span>
      </a>
    </li>
    
    <li class="menu-item-contacts">
      <a href="/docs/contact">
        <span>Contacts</span>
      </a>
    </li>
    
    <li class="menu-item-notes">
      <a href="/docs/notes">
        <span>Notes</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-articles">
      <a href="/docs/articles">
        <span>Articles</span>
      </a>
    </li>
    
    <li class="menu-item-blog">
      <a href="/docs/blog">
        <span>Blog</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit">
      <a href="/docs/toolkit">
        <span>Toolkit</span>
      </a>
    </li>
    
    <li class="menu-item-about me">
      <a href="/docs/about">
        <span>About me</span>
      </a>
    </li>
    
    <li class="menu-item-achievements">
      <a href="/docs/achievements">
        <span>Achievements</span>
      </a>
    </li>
    
    <li class="menu-item-contacts">
      <a href="/docs/contact">
        <span>Contacts</span>
      </a>
    </li>
    
    <li class="menu-item-notes">
      <a href="/docs/notes">
        <span>Notes</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/articles/forensics/analysis/materials/"> Back to Materials Section </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#case-1">Case 1</a></li>
    <li><a href="#case-2">Case 2</a></li>
    <li><a href="#case-3">Case 3</a></li>
    <li><a href="#case-3-kali-linux-user-profiling">Case 3. Kali Linux User Profiling</a></li>
  </ul>
</nav>
 </aside>
 </div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Linux Forensics by Magnet Forensics</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
                <i class="fas fa-search"></i>
              
          <a class="category-link" href="/domain/forensics">forensics</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
                <i class="fa fa-sticky-note"></i>
              
          <a class="platform-link" href="/doctype/coursenotes">coursenotes</a>
          
      </div> <br /><br/>
      
      
      
      

      
      

      
      <div class="article-tag">
          <i class="fas fa-tag"></i>
          
          
          <a class="tag-link" href="/tags/magnet" rel="tag">magnet</a>
          
      </div> 
      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p><em>These are my course notes from <a href="https://www.magnetforensics.com/resources/performing-linux-forensic-analysis-why-you-should-care-dec-2/?submission=https://go.magnetforensics.com/l/52162/2020-12-04/kwzwtz">Linux Forensics</a> by Magnet Forensics. Thank you, guys, for sharing! I will put a quote paragraph with a üí°at the beginning whenever I have some ideas or thoughts along the way.</em></p>
<p>Everything is a file. MacOS is similar, but it&rsquo;s different in Windows.</p>
<ul>
<li>Programs
<ul>
<li><code>/bin</code> - exes and basic commands</li>
<li><code>/usr</code> - user-land programs and data</li>
<li><code>/opt</code> - some not standart progs</li>
<li><code>/sbin</code> - admin level tools</li>
<li><code>/lib</code> - libraries</li>
<li><code>/srv</code> - where services were intended to be install</li>
</ul>
</li>
<li>Devices
<ul>
<li><code>/dev</code> - all devices</li>
<li><code>/media</code> - for mounting USBs</li>
<li><code>/mnt</code> - mounting other devices</li>
</ul>
</li>
<li>Data
<ul>
<li><code>/run</code> - system data since reboot (before the next reboot)</li>
<li><code>/home</code> - user personal data</li>
<li><code>/root</code> - same as /home for root</li>
<li><code>/tmp</code> - temporary data</li>
<li><code>/var</code> - logs and other volatile data</li>
<li><code>/lost+found</code> - recovered from system crash</li>
</ul>
</li>
<li>System
<ul>
<li><code>/proc</code> - a live mirror of what&rsquo;s in system memory but represented as a file hierachy /proc/(processid)/(stuff being used on system boot)</li>
<li><code>/etc</code> - config files and scripts</li>
<li><code>/boot</code> - the kernel, boot files, boot loader config</li>
</ul>
</li>
</ul>
<p>File type cheatsheet (use <code>stat</code> or <code>ls</code>):</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">D - directory

L - link

S - socket

P - pipe

C - character ?

B - block ?
</code></pre></div><h2 id="case-1">Case 1</h2>
<blockquote>
<p>Nearly all IP are recreated by a competitor. Investigate the development machine</p>
</blockquote>
<p>Potential data exfiltration.</p>
<ol>
<li>
<p><code>netstat -lpeanut</code> shows that there are two dhcp clients running, one using unusual port and user:</p>
<p>![Screenshot 2020-12-15 at 12.30.07 PM](images/Screenshot 2020-12-15 at 12.30.07 PM.png)</p>
</li>
<li>
<p><code>ps aux | grep 40500</code> or <code>ps aux | grep dhclient</code> shows the running processes and sometimes commands used to run them. This suspicious client was run from <code>/tmp</code> folder:</p>
<p>![Screenshot 2020-12-15 at 12.33.53 PM](images/Screenshot 2020-12-15 at 12.33.53 PM.png)</p>
</li>
<li>
<p><code>ls -la /tmp/</code> to see the file that was launched. But nothing there. Seems that the file was deleted after being launched:</p>
<p>![Screenshot 2020-12-15 at 12.36.52 PM](images/Screenshot 2020-12-15 at 12.36.52 PM.png)</p>
</li>
<li>
<p><code>lsof -p 40500</code> to see the files the were opened by the prog with certain PID. Shows that dhclient was indeed deleted and the socket files still open (red):</p>
<p>![Screenshot 2020-12-15 at 12.38.56 PM](images/Screenshot 2020-12-15 at 12.38.56 PM.png)</p>
</li>
</ol>
<blockquote>
<p>‚ùó In Linux a file can be deleted and still be run.</p>
</blockquote>
<ol start="5">
<li>
<p><code>/procfs</code> is like a snapshot of RAM. Linux maps its memory to a temp virtual file system. Explore as it&rsquo;s mapped onto the disk. <code>cd /proc/40500/</code> and <code>ls</code>. See <code>exe</code> symlink in red. Run <code>ls -l</code> to see where the symlink points to and it points to the deleted suspicious file ü¶π‚Äç‚ôÇÔ∏è. But despite this, one can still get the file from memory.</p>
<p>![Screenshot 2020-12-15 at 12.43.56 PM](images/Screenshot 2020-12-15 at 12.43.56 PM.png)</p>
</li>
<li>
<p><code>cp /proc/40500/exe /tmp/copy</code> and <code>cat /proc/40500/exe &gt; /tmp/reassembled</code>. Compare hashes <code>md5sum</code> and <code>sha1sum</code>.</p>
</li>
<li>
<p>Find these hashes in other directories (in case it was copied) and on other machines <code>sudo find / -type f -exec md5sum {} \; | grep &lt;hash_from_step_5&gt;</code> or <code>sudo find /bin/ -type f -exec md5sum {} \; | grep &lt;hash&gt;</code>:</p>
<p>![Screenshot 2020-12-15 at 12.51.31 PM](images/Screenshot 2020-12-15 at 12.51.31 PM.png)</p>
</li>
</ol>
<h2 id="case-2">Case 2</h2>
<ol>
<li>Running <code>netstat</code>, see the weird python script with established connection to some remote host:</li>
</ol>
<p>![Screenshot 2020-12-15 at 12.55.06 PM](/Users/veronicazvereva/Documents/website/analyst/content/docs/coursenotes/linux-forensics-magnet/images/Screenshot 2020-12-15 at 12.55.06 PM.png)</p>
<ol start="2">
<li>Grab the executable: <code>lsof -p 2082</code> and <code>ps aux  grep 2082</code>.</li>
</ol>
<p>![Screenshot 2020-12-15 at 12.57.22 PM](images/Screenshot 2020-12-15 at 12.57.22 PM.png)</p>
<ol start="3">
<li>Let&rsquo;s see the <code>/tmp/</code> folder for <code>backdoor</code> executable</li>
<li>Check <code>/proc/2082</code> and <code>ls</code></li>
</ol>
<p>![Screenshot 2020-12-15 at 12.59.55 PM](images/Screenshot 2020-12-15 at 12.59.55 PM.png)</p>
<ol start="5">
<li>Since the executable is a legitimate python, need to explore further. In <code>/proc/2082</code> run <code>sudo cat cmdline</code> shows the comand used to launch, <code>cat task/2082/children</code> shows children PID. <code>sudo cat status</code> shows  general information. <code>cat environ</code> shows &hellip; . <code>cat arp</code> shows MAC addresses of the machines connected:</li>
</ol>
<p>![Screenshot 2020-12-15 at 1.02.18 PM](images/Screenshot 2020-12-15 at 1.02.18 PM.png)</p>
<ol start="6">
<li>Get the backdoor file: file recovery or memory forensics. Sometimes /procfs can manage.</li>
</ol>
<h2 id="case-3">Case 3</h2>
<blockquote>
<p>Compromised Apache Web server with drupal application used for local team. There was some unusual activity noticed between 05/10 and 08/10/19.</p>
</blockquote>
<ol>
<li>You need to preserve edidence and some commands override artifacts (like <code>find</code>). Disable access times</li>
</ol>
<ul>
<li><code>sudo mount -o remount,noatime /dev/...</code> or:</li>
<li><code>mkdir /mnt/extdrv/rootvol</code></li>
<li><code>rootvol=/mnt/extdrv/rootvol</code></li>
<li><code>sudo mount --bind / $rootvol</code></li>
<li><code>sudo mount -o remount,ro $rootvol</code></li>
</ul>
<ol start="2">
<li>User activity: <code>/etc/passwd</code>. <code>sudo debugfs -R 'stat &lt;1835260&gt;' /dev/...</code>.</li>
</ol>
<p>![Screenshot 2020-12-15 at 1.21.49 PM](images/Screenshot 2020-12-15 at 1.21.49 PM.png)</p>
<ol start="3">
<li>
<p>checking groups. <code>tail -n 4 /etc/group</code>, <code>grep -E 'mail' | php' /etc/group</code></p>
</li>
<li>
<p>checking files. Searching for files that had the metadata changed withing the last 5 days: <code>find / -type f -newermt 2019-10-04</code> or <code>find / -type f -newerct 2019-10-04</code>. Failed logins: <code>/var/log/faillog</code>, <code>/var/www/html/jabc/scripts</code>, <code>/var/www/html/jabc/scripts/update.php</code>, <code>/etc/gshadow</code>, <code>/etc/group</code> etc. Home dirs of suspicious users.</p>
</li>
</ol>
<p>![Screenshot 2020-12-15 at 1.28.57 PM](images/Screenshot 2020-12-15 at 1.28.57 PM.png)</p>
<ol start="5">
<li>Checking user bash history (<code>.bashrc_history</code> ) <code>.bashrc</code> for certain commands and the order of exe.</li>
</ol>
<p>![Screenshot 2020-12-16 at 10.17.42 PM](images/Screenshot 2020-12-16 at 10.17.42 PM.png)</p>
<ol start="6">
<li>Suspicious directories. <code>sudo debugfs -R 'stat &lt;1835263&gt;' /dev..</code>, <code>ls -lhat /usr/php</code>.</li>
</ol>
<p>![Screenshot 2020-12-16 at 10.22.29 PM](images/Screenshot 2020-12-16 at 10.22.29 PM.png)</p>
<ol start="7">
<li>
<p>Last logged in users:</p>
<ol>
<li><code>last</code>, <code>w</code>, <code>lastlog</code>, <code>sudo last -f /var/log/wtmp</code>, <code>sudo last -f /var/log/btmp</code> (failed logins).</li>
<li>dump <code>wtmp</code>:</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo debugfs /dev/..
debugfs &gt; <span class="nb">cd</span> /var/log/
debugfs &gt; ls
debugfs &gt; imap &lt;524275&gt;
debugfs &gt; dump_inode wtmp /media/extdrv/case/wtmp.dump
   
strings wtmp.dump
</code></pre></div><ol start="8">
<li><code>sudo cat /var/log/auth.log</code> showed failed attempts to bruteforce root password. Then:</li>
</ol>
<p>![Screenshot 2020-12-16 at 10.35.52 PM](images/Screenshot 2020-12-16 at 10.35.52 PM.png)</p>
</li>
</ol>
<blockquote>
<p>The /<strong>etc</strong>/<strong>skel</strong> directory contains <strong>files</strong> and directories that are automatically copied over to a new user&rsquo;s when it is created from useradd command. This will ensure that all the users gets same intial settings and environment.</p>
</blockquote>
<p>‚Äã		![Screenshot 2020-12-16 at 10.40.17 PM](images/Screenshot 2020-12-16 at 10.40.17 PM.png)</p>
<ol start="8">
<li>Examine <code>error.log</code> of Apache server for IPs that was spotted before:</li>
</ol>
<p>![Screenshot 2020-12-16 at 10.42.32 PM](images/Screenshot 2020-12-16 at 10.42.32 PM.png)</p>
<ol start="9">
<li>Checking Apache <code>access.log</code></li>
</ol>
<p>![Screenshot 2020-12-16 at 10.45.41 PM](images/Screenshot 2020-12-16 at 10.45.41 PM.png)</p>
<p>decoded payload</p>
<p>![Screenshot 2020-12-16 at 10.51.09 PM](images/Screenshot 2020-12-16 at 10.51.09 PM.png)</p>
<p>And there was revealed that <code>/jabs/scripts/update.php</code> was actually a webshell:</p>
<p>![Screenshot 2020-12-16 at 10.52.04 PM](images/Screenshot 2020-12-16 at 10.52.04 PM.png)</p>
<p>Lots of files were deleted from <code>/tmp</code> folder. Except for only <code>apache-xTRhUVX</code>.</p>
<p>Getting deleted files back:</p>
<p><code>sudo debugfs -R 'dump &lt;8&gt; ./journal' /dev/</code> and then <code>sudo ext4magic -a DATE -b DATE -j ./journal -m -d output/ </code></p>
<p>![Screenshot 2020-12-16 at 10.55.57 PM](images/Screenshot 2020-12-16 at 10.55.57 PM.png)</p>
<p>![Screenshot 2020-12-16 at 10.59.12 PM](images/Screenshot 2020-12-16 at 10.59.12 PM.png)</p>
<p>![Screenshot 2020-12-16 at 11.01.32 PM](images/Screenshot 2020-12-16 at 11.01.32 PM.png)</p>
<p>Use Timeline explorer.</p>
<h2 id="case-3-kali-linux-user-profiling">Case 3. Kali Linux User Profiling</h2>
<blockquote>
<p>IP theft and Kali Linux is a suspect. Has the user exfiltrated pictures or documents?</p>
</blockquote>
<p>Can look for info in xdg directories:</p>
<ul>
<li>~/.cache ($XDG_CACHE_HOME)</li>
<li>~/.local/share ($XDG_DATA_HOME)</li>
<li>~/.config ($XDG_CONFIG_HOME)</li>
</ul>
<p>Can look for info in non-xdg dirs:</p>
<ul>
<li>~/.&lt;application_name&gt;</li>
<li>~ (user home dir)</li>
</ul>
<p><code>cat .bash_history</code> and defaults in <code>./bashrc</code>. For Kali <code>~/.msf4/history</code> (doesn&rsquo;t log commands for the remote shell), <code>~/.nc_history</code> (created if <code>rlwrap </code> was used to run <code>nc</code>. Also <code>~/.viminfo</code>: cmd history, string search history, input-line history, contents of non-empty regs, marks for several files, file marks pointing to locs in files, last search/sub pattern for &lsquo;n&rsquo; or &lsquo;&amp;&rsquo;, buffer list, global vars. <code>~/.cache/sessions</code> - by xfce-session and only if sessions are saved: list of open progs that were saved from last session (when the user last logged out) for recent Kalis. Xfce-session-[hostname]:0 and <code>.bak</code> - prev version of it. Client - prog or windows that needs to be opened. At the end of the file the amount of progs that are to be run and last time this session was last saved (not opened by user ). XFWM - xfce window manager.</p>
<p>xfwm4-[xfwm-GUID-for-session].state - saves position for all opened windows. WINDOW_ROLE. URI - the path to the file</p>
<p><code>~/.xsessions-errors</code> - logs all errors, starts with session start date, includes user intial env variables. Useful to see what progs were run through GUI:</p>
<p>![Screenshot 2020-12-16 at 11.32.15 PM](images/Screenshot 2020-12-16 at 11.32.15 PM.png)</p>
<p><code>~/.cache/thumbnails</code> - generated when viewing dirs with pics, docs, videos etc. what&rsquo;s thumbnailed depends on systems installed thumbnailers and configs. Run <code>debugfs</code> against thumbnails to see the files' first view date.</p>
<p>Thumbnail actually creates a jpeg text keys to store some data (URI to the file thumbnailed and modified time).</p>
<p>Xfce uses Thunar as its file explorer. Thunar uses Tumbler as its thumbnails. Its configs are here: $XDG_CONFIG_DIRS/tumbler/tumbler.rc (default $XDG_CONFIG_DIRS=/etc/xdg) and  $XDG_CONFIG_HOME/tumbler/tumbler.rc (by default $XDG_CONFIG_HOME=~/.config) and /usr/share/thumbnailers.</p>
<p>Examples:</p>
<p>![Screenshot 2020-12-16 at 11.43.40 PM](images/Screenshot 2020-12-16 at 11.43.40 PM.png)</p>
<p>![Screenshot 2020-12-16 at 11.43.59 PM](images/Screenshot 2020-12-16 at 11.43.59 PM.png)</p>
<p><code>~/.local/share/recently-used.xbel</code> - shows recently opened documents, what app was used to open them, configs in $XDG_CONFIG_DIRS/gtk-3.0/settings.ini.</p>
<p>![Screenshot 2020-12-16 at 11.46.41 PM](images/Screenshot 2020-12-16 at 11.46.41 PM.png)</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.1237ff71925bb8625c97a9af8db4c54525258bedfd7c47493daaff723bea755e.js"></script>
  

  
  
  
    
  


</body>

</html>
