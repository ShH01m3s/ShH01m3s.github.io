<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AWS Configuration - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.f5ee5a6a50d29b6390e5652a9df2ffcaffd904244cc05d6f936d9e4feeb76a3d.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-forensics 🔍 and incident response 🥷">
      <a href="/docs/dfir">
        <span>Forensics 🔍 and Incident Response 🥷</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-forensics 🔍 and incident response 🥷">
      <a href="/docs/dfir">
        <span>Forensics 🔍 and Incident Response 🥷</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/investigation/configs/"> Back to ⚙️ Config Data Analysis Section 👈🏼 </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#useful-commands">Useful commands</a></li>
    <li><a href="#tricks">Tricks</a></li>
    <li><a href="#terraform">Terraform</a></li>
    <li><a href="#vpc">VPC</a>
      <ul>
        <li><a href="#nacl">NACL</a></li>
        <li><a href="#security-group">Security Group</a></li>
        <li><a href="#nat">NAT</a></li>
        <li><a href="#elastic-ip">Elastic IP</a></li>
        <li><a href="#vpc-flow-logs">VPC Flow Logs</a></li>
        <li><a href="#vpc-traffic-mirroring">VPC Traffic Mirroring</a></li>
        <li><a href="#aws-vpc-endpoints">AWS VPC Endpoints</a>
          <ul>
            <li><a href="#gateway">Gateway</a></li>
            <li><a href="#interface">Interface</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#default-configurations">Default Configurations</a></li>
    <li><a href="#-btfm">📘 BTFM</a>
      <ul>
        <li><a href="#imds">IMDS</a></li>
        <li><a href="#flow-logs">Flow Logs</a></li>
      </ul>
    </li>
    <li><a href="#-toolkit">🧰 Toolkit</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
 </div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">AWS Configuration</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
                <i class="fas fa-archive"></i>
              
          <a class="category-link" href="/domain/general">general</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
                <i class="fa fa-graduation-cap"></i>
              
          <a class="platform-link" href="/doctype/article">article</a>
          
      </div> <br /><br/>
      
      
      
      
      <div class="article-category">
          
            
            
            
            
            
          <a class="platform-link" href="/platforms/win">win</a>
          
      </div> <br />
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <h2 id="useful-commands">Useful commands</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Get current creds and region for aws CLI</span>
</span></span><span class="line"><span class="cl">~/.aws/credentials
</span></span><span class="line"><span class="cl">~/.aws/config
</span></span></code></pre></div><h2 id="tricks">Tricks</h2>
<h2 id="terraform">Terraform</h2>
<p>Most of the things can be and usually prefered to be configured via Terraform. It&rsquo;s usually refered to as &ldquo;Infrastructure as code&rdquo;, which basically means that you can &ldquo;code&rdquo; the way your infrastructure is built and with what permissions. For example, you can either create an EC2 instance via GUI in AWS Console, or use aws CLI for that or you can do this via Terraform. The latter option allows better managements, transparancy and, of course, automation.</p>
<p>Following the advice of the instructor from Udemy (see reference below), I&rsquo;ve used Visual Studio (which I usually use for scripting) with a HashiCorp Terraform plugin installed. To install terraform itself follow the instructions here - <a href="https://learn.hashicorp.com/tutorials/terraform/install-cli">https://learn.hashicorp.com/tutorials/terraform/install-cli</a>. Good tutorials are available for free on the Terraform&rsquo;s website as well: <a href="https://learn.hashicorp.com/tutorials/terraform/aws-build?in=terraform/aws-get-started">https://learn.hashicorp.com/tutorials/terraform/aws-build?in=terraform/aws-get-started</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">category</span> <span class="s2">&#34;subcategory&#34;</span> <span class="s2">&#34;some_randomname&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="err">mandatory_stuff</span> <span class="err">=</span> <span class="nt">&#34;your value 1&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="err">another_optional_stuff</span> <span class="err">=</span> <span class="s2">&#34;your value 2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">resource</span> <span class="s2">&#34;google_storage_bucket&#34;</span> <span class="s2">&#34;assets&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> 	<span class="err">name</span> <span class="err">=</span> <span class="nt">&#34;sec510-assets-${var.UniqueString}&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">provider</span> <span class="s2">&#34;aws&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="err">region</span> <span class="err">=</span> <span class="nt">&#34;eu-west-2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">resource</span> <span class="s2">&#34;aws_instance&#34;</span> <span class="s2">&#34;ec2&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="err">ami</span> <span class="err">=</span> <span class="nt">&#34;ami-12390843958&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="err">instance_type</span> <span class="err">=</span> <span class="s2">&#34;t2.micro&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The suggested workflow would be to store <code>tf</code> files (terraform proprietary format) on git (for version control).</p>
<h2 id="vpc">VPC</h2>
<p>The main concern is that something provate can be poked from the outside. There are several controls in place to avoid this and following the best practicies of Defense-in-Depth policy we are better to leverage all of them properly. But the bigger the organization becomes, the harder it gets to configure everything correctly. Default VPC is very lax. Therefore, it should not be used for anything more serious than I personal blog or lab exercises and stuff like that.</p>
<p>For something to be publicly availble, a Internet Gateway is required.</p>
<h3 id="nacl">NACL</h3>
<p>Network Access Control list. Whever there is a match, further list trversal is ceised. Traffic restrictions are determined by both the NACL (which is overly permissive for the default VPC) and a security group (see the next subsection).</p>
<blockquote>
<p>⚠️ Important note! NACL are stateless, which means that if the request was allowed to pass through, the response might not be if it was not configured. Rules are evaluated in order until a match is found (allow or deny) and the remaining rules in the list are skipped.</p>
</blockquote>
<h3 id="security-group">Security Group</h3>
<p>For default EC2 security group (presuming no changes were made when deploying it) all ingress traffic will be blocked. When EC2 is greated via CLI, it&rsquo;s less &ldquo;open-minded&rdquo; and allows less crap 💩 to flow through. Default security group (ingress all from the same sec group, egress allow traffic on all ports) != default EC2 security group.</p>
<blockquote>
<p>⚠️ Important note!
By default, security groups, do not allow any ingress and allow all egress traffic. Anything that was not specified, is <strong>denied by default</strong>.
Security groups are stateful. So, if the request has passed through, the response will as well. Moreover, all rules are evaluted before decision is made. If there are some conflicting rules, then, the most permissive will get the medal 🥇.</p>
</blockquote>
<blockquote>
<p>❓ How rules are evaluated after NACL and SG specific are evaluated?</p>
</blockquote>
<h3 id="nat">NAT</h3>
<p>A NAT gateway is a Network Address Translation (NAT) service. You can use a NAT gateway so that instances in a private subnet can connect to services outside your VPC but external services cannot initiate a connection with those instances. Can be public (for the internet) or private (between VPCs).
<a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/nat_gateway">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/nat_gateway</a>
<a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html">https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html</a>
NAT is not required for completely private network and private endpoints. All this access is managed by policies and role-based access controls.</p>
<h3 id="elastic-ip">Elastic IP</h3>
<p>Weird enough, but it means static IP.</p>
<h3 id="vpc-flow-logs">VPC Flow Logs</h3>
<p>If these are enabled, you will be able to tell, who connected to what resource and when. Flow Logs are not enabled by default. It&rsquo;s not the same as pcap file! It doesn&rsquo;t provide full packet info. Just statistics, addresses, ports, result (accept/reject).</p>
<p>Logs are sent then either to the CloudWatch or S3 (depending on the configuration). An IAM role needs to be created prior to that. Here are the minimum requirements for the CloudWatch role: CreateLogGroup, CreateLogStream, PutLogEvents, DescribeLogGroups, DescribeLogStreams need to beallowed for all resources. To be able to assume this role, VPC Flow Logs service needs to have its own policy where <code>&quot;service&quot;:&quot;vpc-flow-logs.amazonaws.com&quot;</code> is set to allow <code>AssumeRole</code> action. See <a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs-cwl.html">here</a> for more details.</p>
<p>Log <a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html#flow-log-records">breakthrough</a>. Looks like a simple string with a space as a delimiter. Each field has its place within the string.</p>
<h3 id="vpc-traffic-mirroring">VPC Traffic Mirroring</h3>
<p>A great idea to use. Deploying an EC2 with some IDS, mirror traffic there for detection. Filter for the most relevant stuff to pass it to SIEM?</p>
<h3 id="aws-vpc-endpoints">AWS VPC Endpoints</h3>
<p>By default, even private VPCs will talk over the Intenet, raising unneccessary interest of the attackers. VPC Endpoints are used in order to establish a connection for separate VPCs without exposing themselves to the public.</p>
<p><a href="https://www.linkedin.com/pulse/aws-interface-endpoint-vs-gateway-alex-chang/">https://www.linkedin.com/pulse/aws-interface-endpoint-vs-gateway-alex-chang/</a>
<a href="https://aws.amazon.com/blogs/architecture/choosing-your-vpc-endpoint-strategy-for-amazon-s3/">https://aws.amazon.com/blogs/architecture/choosing-your-vpc-endpoint-strategy-for-amazon-s3/</a></p>
<h4 id="gateway">Gateway</h4>
<p>Free to use. Dynamo and S3 use this type of endpoint. Reside within the VPC globally.</p>
<h4 id="interface">Interface</h4>
<p>Using static IP. Reside inside the subnet (which is inside the VPC). Cost something.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">##</span> <span class="err">INTERFACE</span> <span class="err">ENDPOINT</span>
</span></span><span class="line"><span class="cl"><span class="err">resource</span> <span class="s2">&#34;aws_vpc_endpoint&#34;</span> <span class="s2">&#34;passwordstore&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="err">vpc_id</span> <span class="err">=</span> <span class="err">aws_vpc.app.id</span>
</span></span><span class="line"><span class="cl">	<span class="err">service_name</span> <span class="err">=</span> <span class="nt">&#34;com.amazonaws.${local.region}.passwordstore&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="err">vpc_endpoint_type</span> <span class="err">=</span> <span class="s2">&#34;Interface&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="err">subnet_ids</span> <span class="err">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">		<span class="err">aws_subnet.private</span><span class="mi">1</span><span class="err">.id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="err">aws_subnet.private</span><span class="mi">2</span><span class="err">.id</span>
</span></span><span class="line"><span class="cl">	<span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="err">security_group_ids</span> <span class="err">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">		<span class="err">aws_security_group.passwordstore.id</span>
</span></span><span class="line"><span class="cl">	<span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="err">private_dns_enabled</span> <span class="err">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">##</span> <span class="err">INTEFRACEE</span> <span class="err">ENDPOINT,</span> <span class="err">require</span> <span class="err">private</span> <span class="err">access,</span> <span class="err">restrict</span> <span class="err">access</span> <span class="err">to</span> <span class="mi">1</span> <span class="err">VPC</span>
</span></span><span class="line"><span class="cl"><span class="err">data</span> <span class="s2">&#34;aws_iam_policy_document&#34;</span> <span class="s2">&#34;passwordstore&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="err">statement</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">		<span class="err">actions</span> <span class="err">=</span> <span class="err">[</span><span class="nt">&#34;passwordstore:GetSecretValue&#34;</span><span class="err">]</span>
</span></span><span class="line"><span class="cl">		<span class="err">resources</span> <span class="err">=</span> <span class="err">*</span>
</span></span><span class="line"><span class="cl">		<span class="err">effect</span> <span class="err">=</span> <span class="s2">&#34;Allow&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="err">condition</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="err">test</span> <span class="err">=</span> <span class="nt">&#34;StringEquals&#34;</span>
</span></span><span class="line"><span class="cl">			<span class="err">variable</span> <span class="err">=</span> <span class="s2">&#34;aws:SourceVpc&#34;</span>
</span></span><span class="line"><span class="cl">			<span class="err">values</span> <span class="err">=</span> <span class="p">[</span><span class="err">aws_vpc.app.id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> 
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">##</span> <span class="err">SECURITY</span> <span class="err">GROUP</span>
</span></span><span class="line"><span class="cl"><span class="err">resource</span> <span class="s2">&#34;aws_security_group&#34;</span> <span class="s2">&#34;passwordstore&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="err">name</span> <span class="err">=</span> <span class="nt">&#34;passwordstore&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="err">description</span> <span class="err">=</span> <span class="s2">&#34;Sec group to for PassStore VPC endpoint&#34;</span> <span class="err">vpc_id</span> <span class="err">=</span> <span class="err">aws_vpc.app.id</span>
</span></span><span class="line"><span class="cl">	<span class="err">ingress</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="err">description</span> <span class="err">=</span> <span class="nt">&#34;HTTPS from the subnet containing the EC2 instance&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="err">from_port</span> <span class="err">=</span> <span class="mi">443</span>
</span></span><span class="line"><span class="cl">		<span class="err">to_port</span> <span class="err">=</span> <span class="mi">443</span>
</span></span><span class="line"><span class="cl">		<span class="err">protocol</span> <span class="err">=</span> <span class="s2">&#34;tcp&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="err">cidr_blocks</span> <span class="err">=</span> <span class="p">[</span><span class="err">aws_subnet.public</span><span class="mi">1</span><span class="err">.cidr_block</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="default-configurations">Default Configurations</h2>
<p>By default, SSH 22 and RDP 3389 are closed, but these are suggested to be opened when creaing them, warning how dangeroud this is. What&rsquo;s <a href="https://docs.aws.amazon.com/vpc/latest/mirroring/what-is-traffic-mirroring.html">traffic mirroring</a>? Using <a href="https://docs.aws.amazon.com/vpc/latest/mirroring/tm-example-open-source.html">this functionality with</a> open-source tools.</p>
<h2 id="-btfm">📘 BTFM</h2>
<p>Terraform prerequisites: account on AWS, Google, Azure or another Cloud provider, Terraform isntalled locally on the PC, credentials from the cloud in question (for example, for AWS these are <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code>). For full instructions refer to [<a href="https://learn.hashicorp.com/tutorials/terraform/aws-build?in=terraform/aws-get-started">2</a>].</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">terraform init
</span></span><span class="line"><span class="cl"><span class="c1"># create some tf file or make changes to the existing one</span>
</span></span><span class="line"><span class="cl">terraform apply
</span></span><span class="line"><span class="cl">terraform destroy <span class="c1"># to delete what was deleted</span>
</span></span></code></pre></div><h3 id="imds">IMDS</h3>
<p>Following the best practices, one would use IMDSv2, but if it&rsquo;s not the case, then one can <code>ssh</code> into EC2 and run the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -s <span class="s2">&#34;http://169.254.169.254/latest/meta-data/iam/security-credentials/&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; my-ec2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">curl -s <span class="s2">&#34;http://169.254.169.254/latest/meta-data/iam/security-credentials/my-ec2&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># if you see something juicy here, not that great. If it&#39;s IMDSv1, even worse.</span>
</span></span></code></pre></div><p>The result is something like the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Code&#34;</span> <span class="p">:</span> <span class="s2">&#34;Success&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Last Updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2021-01-16T08:00:00Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Type&#34;</span><span class="p">:</span> <span class="s2">&#34;AWS-HMAC&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;AccessKeyId&#34;</span><span class="p">:</span> <span class="s2">&#34;1234567890&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;SecretAcessKey&#34;</span><span class="p">:</span> <span class="s2">&#34;12345678901234567890&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Token&#34;</span><span class="p">:</span> <span class="s2">&#34;a very long base64 encoded string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Expiration&#34;</span><span class="p">:</span> <span class="s2">&#34;2025-04-16T08:00:00Z&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>How to use IMDSv2 - <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html</a>. IMDSv2 has several protections in place to ensure SSRF is not possible: TTL=1 (IP, network layer, of TCP/IP, network), req,uire PUT request (most WAF don&rsquo;t support it), deny all requests with <code>X-Forwarded-For</code>, <code>X-aws-ec2-metadata-token-ttl-seconds</code> and <code>X- aws-ec2-metadata-token</code> custom headers are required. One only needs to <a href="https://stackoverflow.com/questions/64595032/how-to-tell-what-version-of-instance-metadata-serviceimds-ec2-instance-is-usin#:~:text=If%20you%20want%20to%20determine,what%20the%20status%20code%20is">make sure they have IMDSv2</a> instead of version 1.</p>
<p>If one uses <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/launch_template#metadata-options">Terraform</a>, try using the below settings:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">...</span>
</span></span><span class="line"><span class="cl"><span class="err">metadata_options</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">http_endpoint</span> <span class="err">=</span> <span class="nt">&#34;enabled&#34;</span> <span class="err">#</span> <span class="err">better</span> <span class="err">set</span> <span class="err">disabled</span> <span class="err">in</span> <span class="err">case</span> <span class="err">it&#39;s</span> <span class="err">not</span> <span class="err">required</span> <span class="err">by</span> <span class="err">EC</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="err">http_tokens</span> <span class="err">=</span> <span class="s2">&#34;required&#34;</span> <span class="err">#</span> <span class="err">one</span> <span class="err">way</span> <span class="err">to</span> <span class="err">prevent</span> <span class="err">SSRF</span>
</span></span><span class="line"><span class="cl">    <span class="err">http_put_response_hop_limit</span> <span class="err">=</span> <span class="mi">1</span> <span class="err">#</span> <span class="err">requests</span> <span class="err">will</span> <span class="err">be</span> <span class="err">blocked</span> <span class="err">if</span> <span class="err">requested</span> <span class="err">by</span> <span class="err">any</span> <span class="err">other</span> <span class="err">machine</span> <span class="err">other</span> <span class="err">then</span> <span class="err">the</span> <span class="err">EC</span><span class="mi">2</span> <span class="err">itself.</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">...</span>
</span></span></code></pre></div><h3 id="flow-logs">Flow Logs</h3>
<p>Retrieve the logs:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">aws ec2 describe-flow-logs <span class="c1"># append --profile for SSO or make sure you have the correct creds in ~/.aws/config</span>
</span></span><span class="line"><span class="cl">aws logs filter-log-events --log-group-name &lt;groupname&gt;  <span class="c1"># append --profile for SSO or make sure you have the correct creds in ~/.aws/config</span>
</span></span></code></pre></div><p>Filter the logs - <a href="https://docs.aws.amazon.com/cli/latest/reference/logs/filter-log-events.html">docs</a>.</p>
<h2 id="-toolkit">🧰 Toolkit</h2>
<p><a href="https://rhinosecuritylabs.com/aws/pacu-open-source-aws-exploitation-framework/">Pacu</a>, AWS exploitation framework. Might be good to use when you need to find the flaw in your infrastructure.</p>
<p><a href="https://github.com/duo-labs/parliament">Parliament</a>. Find vulnerabilities in IAM policies statically.</p>
<h2 id="references">References</h2>
<p>[<a href="https://flohealth.udemy.com/course/terraform-fast-track/learn/lecture/21023824#overview">1</a>] Udemy Course on Terraform</p>
<p>[<a href="https://learn.hashicorp.com/tutorials/terraform/aws-build?in=terraform/aws-get-started">2</a>] Terraform official website with tutorials</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
