<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AWS Configuration - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.9d91cbb32c96c334ae7b38c3d99d30727e0836e1182125cc5f007d215f0b9e59.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-forensics ğŸ” and incident response ğŸ¥·">
      <a href="/docs/dfir">
        <span>Forensics ğŸ” and Incident Response ğŸ¥·</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference ğŸ“š">
      <a href="/docs/reference">
        <span>Tech Reference ğŸ“š</span>
      </a>
    </li>
    
    <li class="menu-item-notes ğŸ“">
      <a href="/docs/notes">
        <span>Notes ğŸ“</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-forensics ğŸ” and incident response ğŸ¥·">
      <a href="/docs/dfir">
        <span>Forensics ğŸ” and Incident Response ğŸ¥·</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference ğŸ“š">
      <a href="/docs/reference">
        <span>Tech Reference ğŸ“š</span>
      </a>
    </li>
    
    <li class="menu-item-notes ğŸ“">
      <a href="/docs/notes">
        <span>Notes ğŸ“</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/investigation/configs/"> Back to âš™ï¸ Config Data Analysis Section ğŸ‘ˆğŸ¼ </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#useful-commands">Useful commands</a></li>
    <li><a href="#tricks">Tricks</a></li>
    <li><a href="#terraform">Terraform</a></li>
    <li><a href="#-btfm">ğŸ“˜ BTFM</a>
      <ul>
        <li><a href="#imds">IMDS</a></li>
      </ul>
    </li>
    <li><a href="#-toolkit">ğŸ§° Toolkit</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
 </div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">AWS Configuration</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
                <i class="fas fa-archive"></i>
              
          <a class="category-link" href="/domain/general">general</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
                <i class="fa fa-graduation-cap"></i>
              
          <a class="platform-link" href="/doctype/article">article</a>
          
      </div> <br /><br/>
      
      
      
      
      <div class="article-category">
          
            
            
            
            
            
          <a class="platform-link" href="/platforms/win">win</a>
          
      </div> <br />
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <h2 id="useful-commands">Useful commands</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Get current creds and region for aws CLI</span>
~/.aws/credentials
~/.aws/config
</code></pre></div><h2 id="tricks">Tricks</h2>
<h2 id="terraform">Terraform</h2>
<p>Most of the things can be and usually prefered to be configured via Terraform. It&rsquo;s usually refered to as &ldquo;Infrastructure as code&rdquo;, which basically means that you can &ldquo;code&rdquo; the way your infrastructure is built and with what permissions. For example, you can either create an EC2 instance via GUI in AWS Console, or use aws CLI for that or you can do this via Terraform. The latter option allows better managements, transparancy and, of course, automation.</p>
<p>Following the advice of the instructor from Udemy (see reference below), I&rsquo;ve used Visual Studio (which I usually use for scripting) with a HashiCorp Terraform plugin installed. To install terraform itself follow the instructions here - <a href="https://learn.hashicorp.com/tutorials/terraform/install-cli">https://learn.hashicorp.com/tutorials/terraform/install-cli</a>. Good tutorials are available for free on the Terraform&rsquo;s website as well: <a href="https://learn.hashicorp.com/tutorials/terraform/aws-build?in=terraform/aws-get-started">https://learn.hashicorp.com/tutorials/terraform/aws-build?in=terraform/aws-get-started</a>.</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">category</span> <span class="s2">&#34;subcategory&#34;</span> <span class="s2">&#34;some_randomname&#34;</span> <span class="p">{</span>
	<span class="err">mandatory_stuff</span> <span class="err">=</span> <span class="nt">&#34;your value 1&#34;</span>
	<span class="err">another_optional_stuff</span> <span class="err">=</span> <span class="s2">&#34;your value 2&#34;</span>
<span class="p">}</span>


<span class="err">resource</span> <span class="s2">&#34;google_storage_bucket&#34;</span> <span class="s2">&#34;assets&#34;</span> <span class="p">{</span>
 	<span class="err">name</span> <span class="err">=</span> <span class="nt">&#34;sec510-assets-${var.UniqueString}&#34;</span>
<span class="p">}</span>


<span class="err">provider</span> <span class="s2">&#34;aws&#34;</span> <span class="p">{</span>
	<span class="err">region</span> <span class="err">=</span> <span class="nt">&#34;eu-west-2&#34;</span>
<span class="p">}</span>


<span class="err">resource</span> <span class="s2">&#34;aws_instance&#34;</span> <span class="s2">&#34;ec2&#34;</span> <span class="p">{</span>
	<span class="err">ami</span> <span class="err">=</span> <span class="nt">&#34;ami-12390843958&#34;</span>
	<span class="err">instance_type</span> <span class="err">=</span> <span class="s2">&#34;t2.micro&#34;</span>
<span class="p">}</span>


</code></pre></div><p>The suggested workflow would be to store <code>tf</code> files (terraform proprietary format) on git (for version control).</p>
<h2 id="-btfm">ğŸ“˜ BTFM</h2>
<p>Terraform prerequisites: account on AWS, Google, Azure or another Cloud provider, Terraform isntalled locally on the PC, credentials from the cloud in question (for example, for AWS these are <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code>). For full instructions refer to [<a href="https://learn.hashicorp.com/tutorials/terraform/aws-build?in=terraform/aws-get-started">2</a>].</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">terraform init
<span class="c1"># create some tf file or make changes to the existing one</span>
terraform apply
terraform destroy <span class="c1"># to delete what was deleted</span>
</code></pre></div><h3 id="imds">IMDS</h3>
<p>Following the best practices, one would use IMDSv2, but if it&rsquo;s not the case, then one can <code>ssh</code> into EC2 and run the following command:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">curl -s <span class="s2">&#34;http://169.254.169.254/latest/meta-data/iam/security-credentials/&#34;</span>

&gt; my-ec2

curl -s <span class="s2">&#34;http://169.254.169.254/latest/meta-data/iam/security-credentials/my-ec2&#34;</span>

<span class="c1"># if you see something juicy here, not that great. If it&#39;s IMDSv1, even worse.</span>
</code></pre></div><p>The result is something like the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
	<span class="nt">&#34;Code&#34;</span> <span class="p">:</span> <span class="s2">&#34;Success&#34;</span><span class="p">,</span>
	<span class="nt">&#34;Last Updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2021-01-16T08:00:00Z&#34;</span><span class="p">,</span>
	<span class="nt">&#34;Type&#34;</span><span class="p">:</span> <span class="s2">&#34;AWS-HMAC&#34;</span><span class="p">,</span>
	<span class="nt">&#34;AccessKeyId&#34;</span><span class="p">:</span> <span class="s2">&#34;1234567890&#34;</span><span class="p">,</span>
	<span class="nt">&#34;SecretAcessKey&#34;</span><span class="p">:</span> <span class="s2">&#34;12345678901234567890&#34;</span><span class="p">,</span>
	<span class="nt">&#34;Token&#34;</span><span class="p">:</span> <span class="s2">&#34;a very long base64 encoded string&#34;</span><span class="p">,</span>
	<span class="nt">&#34;Expiration&#34;</span><span class="p">:</span> <span class="s2">&#34;2025-04-16T08:00:00Z&#34;</span>
<span class="p">}</span>
</code></pre></div><p>How to use IMDSv2 - <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html</a>. IMDSv2 has several protections in place to ensure SSRF is not possible: TTL=1 (IP, network layer, of TCP/IP, network), req,uire PUT request (most WAF don&rsquo;t support it), deny all requests with <code>X-Forwarded-For</code>, <code>X-aws-ec2-metadata-token-ttl-seconds</code> and <code>X- aws-ec2-metadata-token</code> custom headers are required. One only needs to <a href="https://stackoverflow.com/questions/64595032/how-to-tell-what-version-of-instance-metadata-serviceimds-ec2-instance-is-usin#:~:text=If%20you%20want%20to%20determine,what%20the%20status%20code%20is">make sure they have IMDSv2</a> instead of version 1.</p>
<p>If one uses <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/launch_template#metadata-options">Terraform</a>, try using the below settings:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">...</span>
<span class="err">metadata_options</span> <span class="p">{</span>
    <span class="err">http_endpoint</span> <span class="err">=</span> <span class="nt">&#34;enabled&#34;</span> <span class="err">#</span> <span class="err">better</span> <span class="err">set</span> <span class="err">disabled</span> <span class="err">in</span> <span class="err">case</span> <span class="err">it&#39;s</span> <span class="err">not</span> <span class="err">required</span> <span class="err">by</span> <span class="err">EC</span><span class="mi">2</span>
    <span class="err">http_tokens</span> <span class="err">=</span> <span class="s2">&#34;required&#34;</span> <span class="err">#</span> <span class="err">one</span> <span class="err">way</span> <span class="err">to</span> <span class="err">prevent</span> <span class="err">SSRF</span>
    <span class="err">http_put_response_hop_limit</span> <span class="err">=</span> <span class="mi">1</span> <span class="err">#</span> <span class="err">requests</span> <span class="err">will</span> <span class="err">be</span> <span class="err">blocked</span> <span class="err">if</span> <span class="err">requested</span> <span class="err">by</span> <span class="err">any</span> <span class="err">other</span> <span class="err">machine</span> <span class="err">other</span> <span class="err">then</span> <span class="err">the</span> <span class="err">EC</span><span class="mi">2</span> <span class="err">itself.</span>
<span class="p">}</span>
<span class="err">...</span>
</code></pre></div><h2 id="-toolkit">ğŸ§° Toolkit</h2>
<p><a href="https://rhinosecuritylabs.com/aws/pacu-open-source-aws-exploitation-framework/">Pacu</a>, AWS exploitation framework. Might be good to use when you need to find the flaw in your infrastructure.</p>
<p><a href="https://github.com/duo-labs/parliament">Parliament</a>. Find vulnerabilities in IAM policies statically.</p>
<h2 id="references">References</h2>
<p>[<a href="https://flohealth.udemy.com/course/terraform-fast-track/learn/lecture/21023824#overview">1</a>] Udemy Course on Terraform</p>
<p>[<a href="https://learn.hashicorp.com/tutorials/terraform/aws-build?in=terraform/aws-get-started">2</a>] Terraform official website with tutorials</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.1237ff71925bb8625c97a9af8db4c54525258bedfd7c47493daaff723bea755e.js"></script>
  

  
  
  
    
  


</body>

</html>
