<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Evidence Analysis ğŸ” - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.9d91cbb32c96c334ae7b38c3d99d30727e0836e1182125cc5f007d215f0b9e59.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-forensics ğŸ” and incident response ğŸ¥·">
      <a href="/docs/dfir">
        <span>Forensics ğŸ” and Incident Response ğŸ¥·</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-notes ğŸ“">
      <a href="/docs/notes">
        <span>Notes ğŸ“</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-forensics ğŸ” and incident response ğŸ¥·">
      <a href="/docs/dfir">
        <span>Forensics ğŸ” and Incident Response ğŸ¥·</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-notes ğŸ“">
      <a href="/docs/notes">
        <span>Notes ğŸ“</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/investigation/"> Back to ğŸ” Forensic Investigation Section ğŸ‘ˆğŸ¼ </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#image-info">Image Info</a></li>
    <li><a href="#malware-analysis">Malware Analysis</a>
      <ul>
        <li><a href="#checklist">Checklist</a></li>
        <li><a href="#persistence-mechanisms">Persistence Mechanisms</a></li>
        <li><a href="#ram-analysis">RAM Analysis</a></li>
        <li><a href="#network-triage">Network Triage</a></li>
        <li><a href="#malware-indicators">Malware Indicators</a></li>
        <li><a href="#malware-evasion-techniques">Malware Evasion Techniques</a></li>
        <li><a href="#throubleshooting-malware">Throubleshooting malware</a></li>
      </ul>
    </li>
    <li><a href="#user-activity">User Activity</a>
      <ul>
        <li><a href="#dummy--vs-poopy-"><strong>Dummy</strong> ğŸ˜¬ vs <strong>Poopy</strong> ğŸ’©</a></li>
        <li><a href="#sheep--vs-others---and-"><strong>Sheep</strong> ğŸ‘ vs <strong>others</strong> ğŸ’©, ğŸ˜¬ and ğŸ¦“</a></li>
        <li><a href="#poopy--vs-donkey-"><strong>Poopy</strong> ğŸ’© vs <strong>donkey</strong> ğŸ¦“</a></li>
        <li><a href="#poopy--and-donkey--vs-others--and-"><strong>Poopy</strong> ğŸ’© and <strong>donkey</strong> ğŸ¦“ vs <strong>others</strong> ğŸ˜¬ and ğŸ‘</a></li>
        <li><a href="#logs">Logs</a></li>
      </ul>
    </li>
    <li><a href="#configurations">Configurations</a>
      <ul>
        <li><a href="#getting-access">Getting Access</a></li>
        <li><a href="#avoiding-detection">Avoiding detection</a></li>
        <li><a href="#response">Response</a></li>
        <li><a href="#malware-assist">Malware Assist</a></li>
      </ul>
    </li>
    <li><a href="#reference">Reference</a></li>
  </ul>
</nav>
 </aside>
 </div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Evidence Analysis ğŸ”</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
                <i class="fas fa-search"></i>
              
          <a class="category-link" href="/domain/forensics">forensics</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
                <i class="fa fa-graduation-cap"></i>
              
          <a class="platform-link" href="/doctype/article">article</a>
          
      </div> <br /><br/>
      
      
      
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p>First, have a template for an IR/forensics sheet. This can be done in Excel or other program alike. You can list all the evidence and hint and leads to follow there. It&rsquo;s better to specify the machine that contained that evidence, the command and program used to find it, path to the evidence, why you think it&rsquo;s suspicious etc. You may divide leads, host indicators, network indicators on separate sheets.</p>
<h2 id="image-info">Image Info</h2>
<p>Use <code>sleuthkit</code> to gather some information. <code>mmstat &lt;disk_or_image&gt;</code> shows volume type. I&rsquo;ve ran this command, but as I can conclude by the output, it&rsquo;s not volume type, but rather a partition schema. I wonder, if these are the same things. <code>mmls -t &lt;partition_schema&gt; &lt;disk_or_image&gt;</code> shows the disk layout including unallocated space. Actually, no need to pass <code>&lt;partition_schema&gt;</code>, it&rsquo;s determined by the tool. Hence, no need to run <code>mmstat</code>. From the <code>mmls</code> we need to note the partition offset to use it with outher tools. For example, <code>fsstat -o &lt;offset&gt; &lt;disk_or_image&gt;</code> shows very detailed information about a partition. The output depends on the file system. For Linux ğŸ§ partitions it&rsquo;ll show informationn about inodes etc. For NTFS - about NTFS metadata, for exFAT - FAT1 and Root directory. The same information but more detailed can be viewed with ğŸ›  Active@Disk Editor. To view deleted files: <code>fls -o &lt;offset&gt; &lt;disk_or_image&gt;</code>. To export a timeline from the volume - <code>fls -r -m &quot;/&quot; -o &lt;offset&gt; &lt;disk_or_image&gt; &gt; bodyfile.txt</code> (<code>-r</code> - recursive, <code>-m</code> - use <code>mactime</code> input format to use with another tool, <code>\</code> - mount point question mark â“). To create timeline, run <code>mactime.pl -b &lt;bodyfile&gt; -d &gt; timeline.csv</code> [<a href="">1</a>]. To specify timezone, add <code>-z</code> switch.</p>
<p>[<a href="">1</a>] Windows Forensics Cookbook</p>
<h2 id="malware-analysis">Malware Analysis</h2>
<p><em>ğŸ” What are we looking for?</em> Persistence / start-up mechanisms, running processes and remnants left.</p>
<p><strong>SANS Six-Part Methodology</strong>, used to identify malicious processses:</p>
<ul>
<li><input disabled="" type="checkbox"> Identify rogue processes</li>
<li><input disabled="" type="checkbox"> Analyze DLLs and handles</li>
<li><input disabled="" type="checkbox"> Review network artifacts</li>
<li><input disabled="" type="checkbox"> Look for code injection</li>
<li><input disabled="" type="checkbox"> Check for any signs of a rootkit</li>
<li><input disabled="" type="checkbox"> Dump suspicious process and drivers</li>
</ul>
<p>ğŸ‘£ <em>What A/V solution is being used?</em> ğŸ¦  ğŸ›‘ If it&rsquo;s Windows, there might be just Windows Defender or some third-party AV. Find the logs for this particular AV solution. More <a href="/docs/dfir/host/windows/windows-artifacts#av-logs">here</a> about this Windows artifact. As for macOS, it has a built-in gatekeeper which logs all these alerts and can even detect known malware. More <a href="/docs/dfir/host/apple/mac-artifacts#Quarantine-files">here</a> about this macOS artifact.</p>
<h3 id="checklist">Checklist</h3>
<p>ğŸ›  Cyber Triage (uses WinAPI), SleuthKit, volatility modules, yara rules, AVs, Registry Explorer (for Windows reg analysis).</p>
<p>There are two main points to use as a start point for malware search: common persistence mechanism for the system, network connections and RAM. Below is the cheatsheet to use in order to find suspicious files. Each of these indicators are not 100%, but you can add scores and then reverse engineer only those highly suspicious to save up time.</p>
<ul>
<li>
<p><input disabled="" type="checkbox"> âœï¸ <strong>Where to look for malware signs</strong>. May be it was removed or it&rsquo;s stealthy. Or may be it&rsquo;ll be too hard. Things that are left behind. The same artifacts that with processes in general (User Activity). There must be some signs that the malware was started (like, startup locations), run (logs, dump, registry etc) and shutdown (process termination logs, crash dumps, remnants in RAM etc).</p>
<ul>
<li>
<p><input disabled="" type="checkbox"> <strong>Persistence mechanisms</strong>. More about persistence mechanism in the below section.</p>
</li>
<li>
<p><input disabled="" type="checkbox"> <strong>RAM</strong>.</p>
</li>
<li>
<p><input disabled="" type="checkbox"> <strong>Network triage</strong></p>
<ul>
<li>
<p><input disabled="" type="checkbox"> Connections (opened, closed, attempted)</p>
</li>
<li>
<p><input disabled="" type="checkbox"> Filter out Internal addresses</p>
</li>
<li>
<p><input disabled="" type="checkbox"> Check the remote connections. External IPs reputations. ğŸ›  <code>hostintel</code>.</p>
</li>
<li>
<p><input disabled="" type="checkbox"> Executables that launched these connections</p>
</li>
<li>
<p><input disabled="" type="checkbox"> Port-services mismatch or unusual ports or services</p>
</li>
<li>
<p><input disabled="" type="checkbox"> Frequency. How frequently is the host connecting to another machine? For how long? May be it is something legitimate. But if it&rsquo;s recent or/and not regular - might be an indicator.</p>
<p>Unusual. Unusual application names, paths, typos or pokerhand ports (<code>44488</code> <code>12345</code> or alike). Or may some gibberish names. Unusual protocols - <code>1</code> (ICMP) <code>6</code> (TCP) <code>70</code> (UDP). Look for the ports outside of these three.</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> âœï¸ <strong>Put a score to all suspicious files</strong></p>
<ul>
<li><input disabled="" type="checkbox"> Signed executable.</li>
<li><input disabled="" type="checkbox"> Strings.</li>
<li><input disabled="" type="checkbox"> 32 bit application.</li>
<li><input disabled="" type="checkbox"> Atypical location.</li>
<li><input disabled="" type="checkbox"> Suspicious time.</li>
<li><input disabled="" type="checkbox"> Suspicious name.</li>
<li><input disabled="" type="checkbox"> Signs of reconnaissance stage.</li>
<li><input disabled="" type="checkbox"> Runtime linking.</li>
<li><input disabled="" type="checkbox"> Packed executables.</li>
<li><input disabled="" type="checkbox"> Hash.</li>
<li><input disabled="" type="checkbox"> Byte-level signatures.</li>
<li><input disabled="" type="checkbox"> Name/Path.</li>
<li><input disabled="" type="checkbox"> Unexpected owners.</li>
<li><input disabled="" type="checkbox"> Hidden by WinAPI.</li>
<li><input disabled="" type="checkbox"> Process taken over.</li>
<li><input disabled="" type="checkbox"> On-disk and in-memory contents don&rsquo;t match.</li>
<li><input disabled="" type="checkbox"> Unusual behaviour.</li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> âœï¸ Put the suspicious files down into your IR/forensics sheet.</p>
</li>
<li>
<p><input disabled="" type="checkbox"> âœï¸ Check what processes, dlls, handles, files and network connection were used by the suspicious process.</p>
</li>
</ul>
<h3 id="persistence-mechanisms">Persistence Mechanisms</h3>
<ul>
<li><input disabled="" type="checkbox"> âœï¸ Are there mal <strong>triggered</strong> programs? Path to progs launched, when triggered (login, startup, schedule), user priv (service), creating date (unreliable).
<ul>
<li><input disabled="" type="checkbox"> Normally there?</li>
<li><input disabled="" type="checkbox"> Suspicious location?</li>
<li><input disabled="" type="checkbox"> Times similar to the event</li>
<li><input disabled="" type="checkbox"> Legitimate signature? Is the issuer trusted or is it self-signed?</li>
<li><input disabled="" type="checkbox"> Do you find it on other machines withing the enterprise?</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> âœï¸ Are there mal accidentally run (<strong>trick launch</strong>)?
<ul>
<li><input disabled="" type="checkbox"> </li>
</ul>
</li>
<li><input disabled="" type="checkbox"> âœï¸ Are there libs accidentally loaded?
<ul>
<li><input disabled="" type="checkbox"> <strong>LoadLibraryPathFile</strong> - set of folders for finding and resolving libraries.</li>
<li><input disabled="" type="checkbox"> The same folder as the exe.</li>
</ul>
</li>
</ul>
<p>ğŸ—’ <em>Explore common autorun and persistence locations in order to find the files that are automatically run at <strong>startup</strong>.</em></p>
<p>ğŸ‘£ <strong>For a Windows machine</strong>. Registry keys: For <code>SOFTWARE</code> hive (system wide) and <code>NTUSER.dat</code> (user-specific): <code>Software\Microsoft\Windows\CurrentVersion\Run</code>, <code>Software\Microsoft\Windows\CurrentVersion\RunOnce</code>. Read more about it in Windows registry article. <code>SOFTWARE</code> hive also has <code>Software\Microsoft\Windows\CurrentVersion\policies\Explorer\Run and Software\Microsoft\Windows NT\Winlogon\Userinit</code>. File system: <code>%AppData%\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</code>. I would also check running processes on the live system to see which processes were started at system start up (time launched is too close to <code>winlogon</code> for example, or any other core process that starts at boot). Scheduled task, malicious service, WMI action that triggers based on some local event. AutoRuns, Startup folders, WMI Actions. Sandboxing, hashing or reverse. Common persistence mechanisms for Windows:</p>
<ol>
<li><strong>Services</strong>. The executable needs to have certain code and permissions for service behaviour and there are three options to acomplish that:
<ol>
<li>New service</li>
<li>Hijacking. Required modifications to some existing service. Example: GlassRAT</li>
<li>Service failure recovery â“â“â“ DrWatson?</li>
</ol>
</li>
<li><strong>Registry</strong>. start value <code>0x2</code> tells OS to strat it at boot. Example: APT1, RIP listener service.</li>
<li><strong>Scheduled tasks</strong>.<code>at.exe</code> (deprecated but can still be used) and <code>schtasks.exe</code>. For <code>at</code> see <code>at*.job</code> and <code>Schdlgu.txt</code> and Task Scheduler and Security Logs for the second one.</li>
<li><strong>DLL Hijacking</strong>. My presentation is available in files section in Russian ğŸ‡·ğŸ‡º.</li>
<li><strong>WMI Event Consumers</strong>.</li>
<li><strong>Local group policy</strong>.</li>
<li><strong>MS Office Add-In</strong>.</li>
<li><strong>Flushing BIOS</strong></li>
</ol>
<p>Read more about the above techniques: <a href="https://isc.sans.edu/diary/Wipe+the+drive+Stealthy+Malware+Persistence+Mechanism+-+Part+1/15394">Wipe the drive! Stealthy Malware Persistence - Part 1</a> and <a href="https://isc.sans.edu/forums/diary/Wipe+the+drive+Stealthy+Malware+Persistence+Part+2/15406/">Wipe the drive! Stealthy Malware Persistence - Part 2</a>.</p>
<p>ğŸ‘£ <strong>For a macOS machine</strong>. <code>System Preferences -&gt; Users &amp; Groups -&gt; Login Items</code>. Additional: SDF podcast.</p>
<p>ğŸ—’ <em>Among these entried find suspicious ones.</em></p>
<p>How to determine if it&rsquo;s malicious? Well, the sure way is only to reverse engineer it, but it is time consuming. So, you need to narrow down the candidates first. There are a couple of indicators that are commonly seen in malware.</p>
<h3 id="ram-analysis">RAM Analysis</h3>
<p>Diffs between <code>psscan</code> and <code>pslist</code> are an indicator of an unlinked process which is a strong malware indicator on its own. If you have an exe that you suspect to be a rootkit, make a RAM snapshot of a clean system, run this exe and make a snapshot again. Then, check the differences. Try to identify the processes that appeared.</p>
<h3 id="network-triage">Network Triage</h3>
<p><strong>Open connections</strong>. <code>netstat -boan</code> statistics and current tcp connections along with the exe, listening port and PID. For Mac OS netstat there is no <code>-o</code> switch, so I&rsquo;ve used <code>netstat -ban</code>. ğŸ‘£ Check for Windows Security Event Log <code>5156</code> is triggered when a network connection is allowed. 4688 - new process starting. <code>5158</code> -&gt; <code>5031</code> binding started and terminated by fw.</p>
<p>Filter out internal addresses (they are not interesting initially). Check the remote connections. Check executables that launched these connections, also look for port-services mismatch or unusual ports or services. â˜ï¸ malware section as well.</p>
<p>External IPs reputations. ğŸ›  <code>hostintel</code>.</p>
<p>Frequency. How frequently is the host connecting to another machine? For how long? May be it is something legitimate. But if it&rsquo;s recent or/and not regular - might be an indicator.</p>
<p>Unusual. Unusual application names, paths, typos or pokerhand ports (<code>44488</code> <code>12345</code> or alike). Or may some gibberish names. Unusual protocols - <code>1</code> (ICMP) <code>6</code> (TCP) <code>70</code> (UDP). Look for the ports outside of these three.</p>
<h3 id="malware-indicators">Malware Indicators</h3>
<p><strong>Signed executable</strong>. It&rsquo;s a rare case, but it exists. Around 3% of malware is <strong>signed</strong>. It&rsquo;s due to the fact that some systems require executables to be signed. But this technique is not very good for malware authors since when at least one &ldquo;product&rdquo; is marked as malicious, all code that was signed with the same certificate will be identified as well. ğŸ›  Use <code>sigcheck</code> to check signatures and hashes against Virus Total.</p>
<p><strong>Strings</strong>. Check <strong>strings</strong> in <code>Image</code> and in <code>Memory</code> using the corresponding radio button on the <code>Strings</code> tab of a selected process info in Process Explorer. If they differ - process replacement tool place.</p>
<p><strong>32 bit application.</strong> For backward compatibility for older machines, malware authors prefer compiling 32bit applications. Since malware authors usually want their software to work on as many machines as possible, they often compile <strong>32bit code</strong>. That&rsquo;s not a decent indicator by itself, but it&rsquo;s a good additional score.</p>
<p><strong>Location</strong>. It might be atypical location for <code>svchost.exe</code> in Documents forlder. You&rsquo;ll need to know what&rsquo;s ok and good for the given system. May user SANS poster <em>Find Evil</em>. Common locations for malware: <code>Windows\System32</code> is a very important location since it allows running with elevated privileges? â“â“â“Also <code>Temp</code> folder and <code>Temp Internet Files</code>. <code>Windows</code>, <code>Windows SxS</code>. Recycle bin also may contain some files or remnants. <code>Program files</code> is the most usual for programs and malware may reside there as well.<code>System Volume Information</code>. That doesn&rsquo;t mean, however, that malware can&rsquo;t be elsewhere.</p>
<p><strong>Suspicious time</strong>. Created at suspicious time? Launch time suspicious?</p>
<p><strong>Suspicious name</strong>. For example, name exactly like or very similar to some core system process? Strange name similar to leg one? <code>svchosts</code>, for example. Present in <code>psscan</code> but absent in <code>pslist</code> (for running processes)? Read more about RAM forensics in the corresponding section. It&rsquo;s usual for malware to mistype the names if common wincore processes or use the same names in weird locations.</p>
<p><strong>Signs of reconnaissance stage</strong>.</p>
<p><strong>Runtime linking</strong>. Since static linking is rare (it increases the body of a program) and dynamicly linked functions can be inspected in different ways, runtime linking might be a choice for malware authors to hide the functionality. How to determine if the runtime linking is used?<em>â“Windows, Mac, Linux?</em> <strong>Importing</strong> and using <code>GetProcessAddress</code>/<code>LdrGetProcessAddress</code> or/and <code>LoadLibrary</code>/<code>LdrLoadDll</code>.</p>
<p><strong>Packed executables</strong>. Almoust 100% indicator that the author didn&rsquo;t want his treasure to be reverse engineered. Why could this be? Because it&rsquo;s some software with a portion of client-side code that performs sensitive operations. One example of a legitimate software is a program that generates OTP codes. There are several ways to determine that a file is packed. The first one - using enthropy analysis against the file. Consider, that most program epilogues start with <code>55 8B EC</code> (<code>push ebp mov ebp, esp</code>) and end with <code>c3</code> (<code>ret</code>).  That means that the number of both in one executable should be relatively the same. Compressed files don&rsquo;t compress well. Another example is to pack the file and determine, how efficiently was it packed. If it wasn&rsquo;t possible to pack the file too much, it&rsquo;s probable that the file is already packed. ğŸ›  Use the first method with <a href="https://www.aldeid.com/wiki/PEiD">PEiD</a> (GUI Windows tool), use the second method with <code>densityscan</code> (commercial cross-platform tool). Below are some common preliminary indicators of packed executables:</p>
<ul>
<li><input disabled="" type="checkbox"> <strong>VA vs PA</strong>. Empty Physical addresses for sections (while VA are not empty). More about virtual and physical addresses in the reverse engineering section.</li>
<li><input disabled="" type="checkbox"> Weired names for <strong>PE sections</strong>. PE sections (for Windows) are usually <code>text</code>, <code>bss</code>, <code>data</code> etc. If you some gibberish that&rsquo;s not usually seen here, most likely the executable is packed.</li>
</ul>
<p><strong>Hash</strong>. The first and dummiest way, but highly suggested is to check the file hash against VirusTotal database. This way you&rsquo;ll eliminate <strong>known good</strong> files, since it&rsquo;s highly unlikely that a legitimate software like Windows files have never been checked so far. Also, this way you can find <strong>known bad</strong>.</p>
<p><strong>Byte-level signatures.</strong> May be you have some signatures left from previous malware.</p>
<p><strong>Name/Path</strong>. In order to spot deviations at that point you need to have a firm understanding of what&rsquo;s normal for that particular system. There are some common &ldquo;normalities&rdquo; for different OSes, of course, as well. You can refer to SANS poster &ldquo;Find Evil&rdquo; which is often updated, SDF Podcast of Michael Leclair about Windows Core Processes, or find the corresponding article about core processes and system supernova in the Technical Reference section of this website.</p>
<p><strong>Unexpected owners</strong>.</p>
<p><strong>Hidden by WinAPI</strong>.</p>
<p><strong>Process taken over</strong>.</p>
<p><strong>On-disk and in-memory contents don&rsquo;t match</strong>.</p>
<p><strong>Unusual behaviour and resources</strong>. Suspicious files opened, netwrk ports and connections, OS resources (mutexes, hooks etc), significant amount of CPU or RAM? <code>.rsrc</code> section usually contains such resources as icons, pictires etc. However, some malicious programs (as well as legitimate ones) can store a driver or other code there which gets extracted and executed by the main progam flow. If you suspect that a dinamically linked library was loaded into a process after load time, compare the import list in <a href="/docs/toolkit/general/reverse-toolkit/#process-explorer">Process Explorer</a> to the imports shown in <a href="/docs/toolkit/general/reverse-toolkit/#dependency-walker">Dependency Walker</a> (Windows, for other OS use analogous tools).</p>
<table>
<thead>
<tr>
<th>Function imported</th>
<th>Usual usage in malware</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>Network triage</strong>. Check network activity for malicious stuuff.</p>
<h3 id="malware-evasion-techniques">Malware Evasion Techniques</h3>
<p>Malware is not going to just always sit there and sing ğŸ¶. Below are common techniques. More detailed explanation is in the anti-forensics section.</p>
<ul>
<li><input disabled="" type="checkbox"> <strong>Service Hijacking and Replacement</strong>.</li>
<li><input disabled="" type="checkbox"> <strong>Process Injection</strong>. Stealthy. Trivial identification using RAM analysis tools.</li>
<li><input disabled="" type="checkbox"> <strong>Filename/Service Hijacking</strong>.</li>
<li><input disabled="" type="checkbox"> <strong>ADS</strong>.</li>
<li><input disabled="" type="checkbox"> <strong>WebShells and Beacons</strong>.</li>
<li><input disabled="" type="checkbox"> <strong>Firmware</strong>.</li>
<li><input disabled="" type="checkbox"> <strong>DLL Injeciton</strong>.</li>
<li><input disabled="" type="checkbox"> <strong>A/V Bypass</strong>.</li>
<li><input disabled="" type="checkbox"> <strong>Defense Manipulation</strong>.</li>
<li><input disabled="" type="checkbox"> <strong>Frequent Compilation</strong>.</li>
<li><input disabled="" type="checkbox"> <strong>Binary Padding</strong>.</li>
<li><input disabled="" type="checkbox"> <strong>Armoring</strong>. It&rsquo;s useful to avoid A/V, but it&rsquo;s very suspicious and easy to spot. Examples: packed malware, polymorphic.</li>
<li><input disabled="" type="checkbox"> <strong>Dormant Malware</strong> ğŸ’¤.  <em>I&rsquo;ll think about that tomorrow. Tomorrow is another day.</em> (c, Gone With The Wind).</li>
<li><input disabled="" type="checkbox"> <strong>Signing Code with Valid Cert</strong>. Thawte and Verisign are responsible for issuing ceritifacates for malware.</li>
<li><input disabled="" type="checkbox"> <strong>Anti-Forensics/Timestomping</strong>. Timestomping is used to modify the timestamps of a file.</li>
<li><input disabled="" type="checkbox"> <strong>Rootkits</strong>.</li>
<li><input disabled="" type="checkbox"> <strong>&ldquo;Fileless&rdquo; Malware</strong>.</li>
</ul>
<h3 id="throubleshooting-malware">Throubleshooting malware</h3>
<ul>
<li>If it&rsquo;s a dll, it can be still ran independently.  Though there are no guaratees, there are two ways to acomplish that (either can work for you):
<ul>
<li>use <code>rundll32</code> (<code>rundll32 [dllname].dll, [function name or ordeal]</code>). Example, a <code>malware.dll</code> that has a function <code>InstallService</code> which requires an argument service name. We want to launch it, call this function to create a service with name &ldquo;MaliciousService&rdquo;: <code>rundll32 malware.dll, MaliciousService</code>. In Dependency Walker we can peek the function&rsquo;s ordeal and run this command like this (if the ordeal is, say, 5): <code>rundll32 malware.dll, #5</code>.</li>
<li>patch PE header of the dll + changing its extension. <code>IMAGE_FILE_HEADER</code> -&gt; <code>CHARACTERISTICS</code> &ndash;&gt; <code>IMAGE_FILE_DLL</code> flag <code>0x2000</code> set to <code>0x0000</code>.</li>
</ul>
</li>
<li><code>ServiceMain</code> without any <code>Install</code> function.
<ul>
<li>Use <code>sc</code> command</li>
<li><code>HKLM/SYSTEM/CurrentControlSet\Services</code> - modify the registry</li>
</ul>
</li>
</ul>
<h2 id="user-activity">User Activity</h2>
<p>Actually, as I read further an further, it seems that everything is about a user. But!</p>
<p>A user can be of several categories. I&rsquo;ll name each one as shortly as I can to refer to them in future. But I will describe them in more detail below.</p>
<p><strong>Legitimate user, who has done something bad by accident</strong>. Let&rsquo;s call him a <strong>dummy</strong> ğŸ˜¬. I&rsquo;ve been there, I once changed permissions to <code>Deny</code> for my admin account to disk <code>C</code> on Windows and could do nothing about it later. How stupid was it ğŸ™ˆ? My excuse is that I only started with PCs&hellip; .</p>
<p><strong>Legitimate user, who has done something bad by intent.</strong> Let&rsquo;s call this one a <strong>poopy</strong> ğŸ’©. Say, he or she feels highy underpaid and sells company&rsquo;s kitty plans to some evil dog hackers.</p>
<p><strong>A user created and used by a hacker.</strong> This one I will call a <strong>sheep</strong> ğŸ‘  as in <em>A wolf in sheep&rsquo;s clothing</em>, since the attacker is trying mask itself as something good.  This one is not unusual, but I guess, easily determined by the sysadmin. However, there are some cases, when an attacker can change view permissions for his/her account on AD so that no one will see this user.</p>
<p><strong>A user created legitimately, but compromised by a hacker and doing something by intent.</strong> This one will be a <strong>donkey</strong> ğŸ¦“, as the attaker is using another account for his ride. I guess it&rsquo;s the most common when the hackers are in the picture.</p>
<p>And here are the questions we will have to answer during investigations, that can help in distinguishing between these types.</p>
<h3 id="dummy--vs-poopy-"><strong>Dummy</strong> ğŸ˜¬ vs <strong>Poopy</strong> ğŸ’©</h3>
<p><em>â“ How to prove that the person didn&rsquo;t do it on purpose, but by accident?</em></p>
<p>âœï¸ It&rsquo;s often not enough just to find a file on a system. One needs to prove <strong>the intent</strong>. Remember to use more than one artifact whenever possible! For example, the user may be insisting that he or she did not download this file. But, if the browser was set to flush data every 7 days and the timestamps for the deleted file shows it was deleted an hour after it was deleted - this might raiser some reasonable doubt think ğŸ¤”. Or, the file was wiped ğŸ§¹ (it&rsquo;s contents filled with <code>0</code>s). If one didn&rsquo;t know it existed, why delete it? Or there is no data on the PC indicating the use of the file, but it was continuously downloaded/uploaded according to the server logs. âš ï¸ This, however, won&rsquo;t prove that there was no hacker in place!</p>
<h3 id="sheep--vs-others---and-"><strong>Sheep</strong> ğŸ‘ vs <strong>others</strong> ğŸ’©, ğŸ˜¬ and ğŸ¦“</h3>
<p>âœï¸ <strong>Are there suspicious accounts?</strong> ğŸ‘£ SAM reg hive (local and domain). Even if the account is deleted, then you can still spot it: user directory sometimes is retained and also check logs. The below question may help finding a malicious user (hacker). More <a href="/docs/dfir/forensic-investigation/accounts">here</a>.</p>
<ul>
<li><input disabled="" type="checkbox"> User Name does not match conventions for this organisation?</li>
<li><input disabled="" type="checkbox"> Weird priviledges</li>
<li><input disabled="" type="checkbox"> Scope (local or domain)</li>
<li><input disabled="" type="checkbox"> Creation time and date.</li>
</ul>
<h3 id="poopy--vs-donkey-"><strong>Poopy</strong> ğŸ’© vs <strong>donkey</strong> ğŸ¦“</h3>
<p><em>â“ How to prove that the account was compromised?</em></p>
<p>Lot&rsquo;s of attacks involve account compromise. In some cases malware is not even needed. There are several arguments for the defence: <em>I didn&rsquo;t know</em>, <em>It was not me</em>, <em>It was a malware</em> and <em>It happened accidently</em>.</p>
<p>âœï¸ <strong>Suspicious logins?</strong></p>
<ul>
<li><input disabled="" type="checkbox"> Should this user use this account?</li>
<li><input disabled="" type="checkbox"> Are they new to the computer?</li>
<li><input disabled="" type="checkbox"> If remote, does the account usually come from that computer?</li>
<li><input disabled="" type="checkbox"> Is the time expected?</li>
<li><input disabled="" type="checkbox"> Does the account have lots of failed logins? ğŸ‘‰ <em>A very strong indicator of compromise</em></li>
<li><input disabled="" type="checkbox"> A login during time when the user was absent ğŸ‘‰ <em>A very strong indicator of compromise</em></li>
</ul>
<p>âœï¸ <strong>Malware</strong>. There is a separate section for malware above â˜ï¸, but it can be a strong defense for some one claiming his or her account was compromised. But! âš ï¸ Even if there is a malware found, it&rsquo;s essential to prove that it existed at the time that some investigated activity took place.</p>
<h3 id="poopy--and-donkey--vs-others--and-"><strong>Poopy</strong> ğŸ’© and <strong>donkey</strong> ğŸ¦“ vs <strong>others</strong> ğŸ˜¬ and ğŸ‘</h3>
<p>âœï¸ <strong>Suspicious activity?</strong></p>
<ul>
<li><input disabled="" type="checkbox"> <strong>What searches were performed?</strong>
<ul>
<li><input disabled="" type="checkbox"> Search relevant to job role?</li>
<li><input disabled="" type="checkbox"> Search for malicious progs or techniques?</li>
<li><input disabled="" type="checkbox"> Was there an attempt to delete the evidence? For example, browser cache cleared <em>manually</em>, depends on this browser settings.</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> <strong>Access resources</strong>.
<ul>
<li><input disabled="" type="checkbox"> Accessed malwebsite?</li>
<li><input disabled="" type="checkbox"> Network shares?</li>
<li><input disabled="" type="checkbox"> Mass copy? ğŸ‘‰ <em>Might be an indicator of data exfiltration.</em></li>
<li><input disabled="" type="checkbox"> Was it a result of a redirect (300 HTTP or header redirect, or pop-up) ğŸ‘‰ <em>May help the defending side if this can be proved.</em></li>
<li><input disabled="" type="checkbox"> File accessed soon after creation? ğŸ‘‰ <em>Might be an indicator of some automated task, or not&hellip;.</em>.</li>
<li><input disabled="" type="checkbox"> Was a file deleted/wiped? ğŸ‘‰ <em>File wiped is a strong indiator of intent.</em> ğŸ›  Directory Snoop can show that the file was wiped, not simply deleted. Not all wiping software clears the <code>$MFT</code> table.</li>
<li><input disabled="" type="checkbox"> What devices were attached?</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> <strong>Remotely executed code</strong>. Remote host + username; interactive or cmd; time. Registry. Event logs for logins and Event login for remote processes.
<ul>
<li><input disabled="" type="checkbox"> Remote = local?</li>
<li><input disabled="" type="checkbox"> Expected?</li>
<li><input disabled="" type="checkbox"> Prog expected?</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> <strong>Communications</strong>. Messangers, emails, social networking, forums, websites.
<ul>
<li><input disabled="" type="checkbox"> Determine all the mail clients used and use this information to find artefacts. â—ï¸â—ï¸â—ï¸â—ï¸ Link to collection.</li>
<li><input disabled="" type="checkbox"> Relevant threads (<code>strings</code> + <code>grep</code> or DFIR framework).</li>
<li><input disabled="" type="checkbox"> IP in mail spoofed?</li>
</ul>
</li>
</ul>
<p>ğŸ‘£ User started processes (Event log, RunMRU, MUICache, UserAssist, AppCompatCache or Shimcache, BAM (Background activity monitor), RecentApps, RecentFilecache or AmCache, SRUM (system resource usage monitor), Windows Timeline, Prefetch).</p>
<p>ğŸ‘£ Terms and time when the search was performed. Web artifacts and saved previous searches.</p>
<p>ğŸ‘£ Includes Host (remote or local), path, time. (configs like history of browser; recently used files, process handles). FileExplorer&rsquo;s ShellBags (what folder was opened) and RunMRU,Application Most Recently Used Files, Web artifacts (cookies, history, db, cache), Memory (commands, remote desk info, paths), cont monitoring.</p>
<p>ğŸ‘£ Event logs, domain logs. The below question may help finding a malicious user (hacker) or malicious insider with intent. More <a href="/docs/dfir/forensic-investigation/4-accounts">here</a>.</p>
<p>ğŸ‘£ Mails. â—ï¸â—ï¸â—ï¸â—ï¸ Link to collection.</p>
<h3 id="logs">Logs</h3>
<h4 id="macos">macOS</h4>
<p><code>python FSEParser_V3.3.py -s -t folder /.fseventsd -o /Users/sentinel/Desktop/FSEvents_Out	</code>. More about FSEvents might be seen here [<a href="http://www.osdfcon.org/presentations/2017/Ibrahim-Understanding-MacOS-File-Ststem-Events-with-FSEvents-Parser.pdf">10</a>]. Thanks to Nicole Ibrahim from OSDFCon, we have this filetype reverse engineered and documented. At least, v1.</p>
<blockquote>
<p>ğŸ˜­ Getting an error when trying to run <code>FSEventsParser</code> on a M1. No excpetion when running it on an Intel machine though.
ğŸ˜Š âœ… My solution was to run a windows version on a VM. Worked fine.</p>
</blockquote>
<p>Mount activity: DMGs, External devices or Shared network drives.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">SELECT
*, _ROWID_ &#34;NAVICAT_ROWID&#34;
FROM
&#34;fsevents&#34;
WHERE
&#34;mask&#34; LIKE &#39;%mount%&#39;
</code></pre></div><p>Internet activity (websites visited)</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">SELECT
*, _ROWID_ &#34;NAVICAT_ROWID&#34;
FROM
&#34;fsevents&#34;
WHERE
&#34;filename&#34; LIKE
&#39;Users/%/Library/Caches/Metadata/Safari/History/%&#39;
OR &#34;filename&#34; LIKE &#39;Users/%/Library/Application
Support/Google/Chrome/Default/Local Storage/%&#39;
</code></pre></div><p>User folders activity</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">SELECT
*, _ROWID_ &#34;NAVICAT_ROWID&#34;
FROM
&#34;fsevents&#34;
WHERE
&#34;filename&#34; LIKE &#39;Users/%/Documents/%â€™
OR &#34;filename&#34; LIKE &#39;Users/%/Downloads/%â€™
OR &#34;filename&#34; LIKE &#39;Users/%/Desktop/%&#39;
</code></pre></div><p><strong>ğŸ—‘ Trash activity</strong>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">SELECT
*, _ROWID_ &#34;NAVICAT_ROWID&#34;
FROM
&#34;fsevents&#34;
WHERE
&#34;filename&#34; LIKE &#39;Users/%/.Trash/%&#39;
</code></pre></div><h4 id="ios">iOS</h4>
<p>Same as for macOS. On iOS - <code>/private/var/.fseventsd</code>, for System: <code>/.fseventsd</code> and Developer Patch at <code>/DeveloperPatch/.fseventsd</code>.</p>
<p>Internet activity</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">SELECT
*, _ROWID_ &#34;NAVICAT_ROWID&#34;
FROM
&#34;fsevents&#34;
WHERE
&#34;filename&#34; LIKE &#39;%websitedata/local%&#39;
</code></pre></div><p>Email activity</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">SELECT
*, _ROWID_ &#34;NAVICAT_ROWID&#34;
FROM
&#34;fsevents&#34;
WHERE
&#34;filename&#34; LIKE &#39;mobile/Library/Mail/%â€™
</code></pre></div><p>iCloud synced files</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">SELECT
*, _ROWID_ &#34;NAVICAT_ROWID&#34;
FROM
&#34;fsevents&#34;
WHERE
&#34;filename&#34; LIKE &#39;mobile/Library/Mobile
Documents/com~apple~CloudDocs/%&#39;
</code></pre></div><h2 id="configurations">Configurations</h2>
<p><em>ğŸ” What are we looking for? Remote access, detection prevention, response challenges, malware enablement.</em></p>
<p>Can be hard (no consistency). Are they different by accident or from malicous intent. Baseline reference (what the settings should be). Configs have only one place to set thing. Attacker motivation:</p>
<ul>
<li>Get access</li>
<li>Avoid detection</li>
<li>Make the response harder</li>
<li>Make malware to work</li>
</ul>
<h3 id="getting-access">Getting Access</h3>
<ol>
<li>has the remote access been enabled?</li>
<li>file sharing enabled?</li>
<li>config to launch different progs?</li>
</ol>
<h3 id="avoiding-detection">Avoiding detection</h3>
<p>Common anti-forensic techniques.</p>
<p>prevent detection (disable firewalls, anti-virus). Rootkits are in malware section.</p>
<ol>
<li>have any prevention tools been disabled?</li>
<li>installed mal certificates to trick prevention tools?</li>
<li>have many detection tools been disabled?</li>
</ol>
<p>Read more about the above techniques: <a href="https://isc.sans.edu/diary/Wipe+the+drive+Stealthy+Malware+Persistence+Mechanism+-+Part+1/15394">Wipe the drive! Stealthy Malware Persistence - Part 1</a> and <a href="https://isc.sans.edu/forums/diary/Wipe+the+drive+Stealthy+Malware+Persistence+Part+2/15406/">Wipe the drive! Stealthy Malware Persistence - Part 2</a>.</p>
<h3 id="response">Response</h3>
<p>Response harder (disable endpoint visibility, accounts (or reduce privs), reduce or disable logs, backups, volume shadow)</p>
<ol>
<li>Were any accs disabled?</li>
<li>Visibility tools disabled?</li>
<li>Settings to record less data
<ol>
<li>audit settings changed?</li>
<li>logs cleared</li>
<li>Backup disabled?</li>
</ol>
</li>
</ol>
<h3 id="malware-assist">Malware Assist</h3>
<p>Changes needed by malware? Change exe path, lib path, hosts file.</p>
<p>ğŸ‘£ <strong>On a Windows machine.</strong> Registry, Congif files (app specific or OS).</p>
<h2 id="reference">Reference</h2>
<p>[1] Practical Malware Analysis, M. Silkorski, A. Honig</p>
<p>[2] <a href="https://www.sans.org/posters/malware-analysis-and-reverse-engineering-cheat-sheet/">SANS cheatsheet on malware analysis</a></p>
<p>[<a href="https://www.sans.org/posters/tips-for-reverse-engineering-malicious-code/">3</a>] SANS tips on malware analysis</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.1237ff71925bb8625c97a9af8db4c54525258bedfd7c47493daaff723bea755e.js"></script>
  

  
  
  
    
  


</body>

</html>
