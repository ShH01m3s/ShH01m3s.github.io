<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Process Injections - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.9d91cbb32c96c334ae7b38c3d99d30727e0836e1182125cc5f007d215f0b9e59.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-forensics üîç and incident response ü•∑">
      <a href="/docs/dfir">
        <span>Forensics üîç and Incident Response ü•∑</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-forensics üîç and incident response ü•∑">
      <a href="/docs/dfir">
        <span>Forensics üîç and Incident Response ü•∑</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/investigation/processes/"> Back to Process Analysis Section üëàüèº </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#windows">Windows</a>
      <ul>
        <li><a href="#classic">Classic</a>
          <ul>
            <li><a href="#caveats">Caveats</a></li>
          </ul>
        </li>
        <li><a href="#pe-injection">PE Injection</a>
          <ul>
            <li><a href="#caveats-1">Caveats</a></li>
          </ul>
        </li>
        <li><a href="#process-hollowing">Process Hollowing</a>
          <ul>
            <li><a href="#pros-and-cons">Pros And Cons</a></li>
          </ul>
        </li>
        <li><a href="#sir-suspend-inject-resume">SIR (<strong>S</strong>uspend, <strong>I</strong>nject, <strong>R</strong>esume)</a>
          <ul>
            <li><a href="#pros-and-cons-1">Pros And Cons</a></li>
          </ul>
        </li>
        <li><a href="#hook-">Hook ü™ù</a></li>
        <li><a href="#registry-poisoning">Registry poisoning</a>
          <ul>
            <li><a href="#pros-and-cons-2">Pros And Cons</a></li>
          </ul>
        </li>
        <li><a href="#apc">APC</a></li>
        <li><a href="#ewmi-with-setwindowlong">EWMI with <code>SetWindowLong()</code></a>
          <ul>
            <li><a href="#examples">Examples</a></li>
          </ul>
        </li>
        <li><a href="#shims">SHIMS</a>
          <ul>
            <li><a href="#examples-1">Examples</a></li>
            <li><a href="#-tools">üõ† Tools</a></li>
          </ul>
        </li>
        <li><a href="#userland-rootkit">Userland rootkit</a>
          <ul>
            <li><a href="#examples-2">Examples</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
 </div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Process Injections</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
                <i class="fas fa-search"></i>
              
          <a class="category-link" href="/domain/forensics">forensics</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
                <i class="fa fa-graduation-cap"></i>
              
          <a class="platform-link" href="/doctype/article">article</a>
          
      </div> <br /><br/>
      
      
      
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <h2 id="windows">Windows</h2>
<p>Most of the information is taken from <a href="!%5Bulr-4%5D(/Users/veronicazvereva/Documents/website/analyst/content/docs/dfir/investigation/processes/injections/images/ulr-4.png)">here</a>, but more visualization is added. The screenshots from IDA Pro are also copied from that blog post.</p>
<h3 id="classic">Classic</h3>
<p>This one is the one of the simpliest to explain and not that simple to actually use in a real attack (see Caveats). A malicious dll&rsquo;s <strong>path</strong> is copied in the memory space of a running legitimate process to be loaded in runtime.</p>
<p><img src="images/classic-1.png" alt="classic-1"></p>
<p>Below is the anatomy of this function call.</p>
<p><img src="images/classic-2.png" alt="classic-2"></p>
<p>Here is a scheme of the sick process address space layout in RAM when this shit happens:</p>
<p><img src="images/classic-3.png" alt="classic-3"></p>
<p>And this is approximately what you&rsquo;d see in IDA Pro, if you had an appropriate sample utilising this technique:</p>
<p><img src="images/classic-4.png" alt="classic-4"></p>
<h4 id="caveats">Caveats</h4>
<p>There are two main problems:</p>
<ul>
<li>Most of the defense tools start barking when they hear the <code>CreateRemoteThread()</code> call.</li>
<li>The attacker needs to have this <code>mal.dll</code> on disk prior to attack.</li>
</ul>
<h3 id="pe-injection">PE Injection</h3>
<p>A malicious <strong>dll itself</strong> copied in the memory space of a running legitimate process.</p>
<p>This is the chain of function calls needed for this attack.</p>
<p><img src="images/pe-1.png" alt="pe-1"></p>
<p>Below is the anatomy of the <code>CreateRemoteThread</code> function call needed for this attack to work</p>
<p><img src="images/pe-2.png" alt="pe-2"></p>
<p>Below is the memory layout of the sick process.</p>
<p><img src="images/pe-3.png" alt="pe-3"></p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<p><img src="images/pe-4.png" alt="pe-4"></p>
<h4 id="caveats-1">Caveats</h4>
<p><code>–°reateRemoteThread()</code> and <code>LoadLibrary()</code> are not stealthy</p>
<h3 id="process-hollowing">Process Hollowing</h3>
<p>Already loaded good process is fully overwritten with something not that good.</p>
<p>This is the chain of function calls needed for this attack.</p>
<p><img src="images/ph-1.png" alt="ph-1"></p>
<p>Below is the memory layout of the sick process.</p>
<p><img src="images/ph-2.png" alt="ph-2"></p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<p><img src="images/ph-3.png" alt="ph-3"></p>
<p><img src="images/ph-4.png" alt="ph-4"></p>
<h4 id="pros-and-cons">Pros And Cons</h4>
<p>‚ûï No need to have mal.dll on disk</p>
<p>‚ûñ CreateRemoteThread()<code>and</code>LoadLibrary()` are loud</p>
<h3 id="sir-suspend-inject-resume">SIR (<strong>S</strong>uspend, <strong>I</strong>nject, <strong>R</strong>esume)</h3>
<p>EIP register&rsquo;s value of a running thread is substituted. This is the chain of function calls needed for this attack.</p>
<p><img src="images/sir-1.png" alt="sir-1"></p>
<p>Below is the memory layout of the sick process.</p>
<p><img src="images/sir-2.png" alt="sir-2"></p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<p><img src="images/sir-3.png" alt="sir-3"></p>
<p><img src="images/sir-4.png" alt="sir-4"></p>
<h4 id="pros-and-cons-1">Pros And Cons</h4>
<p>‚ûï Not as noisy since there is no process created. All the perversion is done with the already running one.</p>
<p>‚ûñ If the process is suspended due to a system call, the program will crash. For this case Trojans that are a little smarter can check EIP value and postpone the inject if its  value is in the <code>ntdll.dll</code>&rsquo;s address range.</p>
<h3 id="hook-">Hook ü™ù</h3>
<p>Uses <code>SetWindowsHookEx()</code> API function.</p>
<p>Call interception.</p>
<p>This is the chain of function calls needed for this attack.</p>
<p><img src="images/hook-1.png" alt="hook-1"></p>
<p>Below is the memory layout of the sick process.</p>
<p><img src="images/hook-2.png" alt="hook-2"></p>
<p>Below is the anatomy of the <code>SetWindowHookEx()</code> function call needed for this attack to work.</p>
<p><img src="images/hook-3.png" alt="hook-3"></p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<p><img src="images/hook-4.png" alt="hook-4"></p>
<p><img src="images/hook-5.png" alt="hook-5"></p>
<h3 id="registry-poisoning">Registry poisoning</h3>
<p>Using the registry to inject.</p>
<p>These are the keys that can be used for injection.</p>
<ul>
<li>
<p>Upon <code>User32.dll</code> load <code>mal.dll</code> will be loaded:</p>
<ul>
<li><code>HKLM/Software/Microsoft/WindowsNT/CurrentVersion/Windows/Appinit_Dlls</code></li>
<li><code>HKLM/Software/Wow6432Node/Microsoft/WindowsNT/CurrentVersion/Windows/Appinit_Dlls</code></li>
</ul>
</li>
<li>
<p>Whenever <code>CreateProcess()</code>, <code>CreateProcessAsUser()</code>, <code>CreateProcessWithLogonW()</code>,</p>
<p><code>CreateProcessWithTokenW()</code>, <code>WinExec()</code> are called, mal.dll will be called</p>
<ul>
<li><code>HKLM/System/CurrentControlSet/Control/Session Manager/AppCertDlls</code></li>
</ul>
</li>
<li>
<p>IFEO - usually used to attach a debugger. The value of the  &ldquo;Debugger Value&rdquo; is changed.</p>
</li>
<li>
<p><code>HKLM/Software/Wow6432Node/Microsoft/WindowsNT/CurrentVersion/image file execution options</code></p>
</li>
</ul>
<p>Below is the memory layout of the sick process.</p>
<p>Below is the anatomy of the <code>XXXXXXXXXXXXXXXX</code> function call needed for this attack to work</p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<p><img src="images/reg1.png" alt="reg1"></p>
<h4 id="pros-and-cons-2">Pros And Cons</h4>
<p>‚ûï The very process of injection is stealthy.</p>
<p>‚ûñ However,<code>mal.dll</code> needs to be present on disk.</p>
<p>‚ûñ There are &ldquo;smithereens&rdquo; left in the registry that can be a good lead in an investigation.</p>
<h3 id="apc">APC</h3>
<p>This is the chain of function calls needed for this attack.</p>
<p><img src="images/apc-1.png" alt="apc-1"></p>
<p>Below is the memory layout of the sick process.</p>
<p><img src="images/apc-2.png" alt="apc-2"></p>
<p>Below is the anatomy of the <code>XXXXXXXXXXXXXXXX</code> function call needed for this attack to work.</p>
<p><img src="images/apc-3.png" alt="apc-3"></p>
<p>How this attack actually work (visualised):</p>
<p><img src="images/apc-2-2.png" alt="apc-2-2"></p>
<p><img src="images/apc-4.png" alt="apc-4"></p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<p><img src="images/apc-5.png" alt="apc-5"></p>
<h3 id="ewmi-with-setwindowlong">EWMI with <code>SetWindowLong()</code></h3>
<p>Extra Window Memory Injection. Ok, hold my beer üçª, this one is a little tough for 11:14 in the evening. <code>explorer.exe</code> process has some shared memory, that can be used by other processes. Neat, right? What other process have this &ldquo;<em>feature</em>&rdquo;? Let&rsquo;s keep this information roasting for a while. There are two ways of using this <del>bug</del> <em>feature</em>: decently creating a shared region (using <code>NTMapViewOfSection</code> for allocating heap section) or leeching off on another one&rsquo;s. Guess which one is the prefered one for the attackers üòâ?</p>
<p>There is another feature, not <code>explorer.exe</code> specific: GUI applications when creating a window have some additional 40 bytes for each window in the window class structure, where they can put anything 40 bytes long (properties, function pointers). Originally, these bytes were designed to store some window specific info, i.e. colors, menu items I guess. However, one can write a pointer in this space to point to somewhere else: either in this very process (which is quite useless for an attacker) or in some shared region (let&rsquo;s stop the information in the above paragraph roasting).</p>
<p>And finally, there is this <code>Shell_TrayWnd</code>. Remember, the panel on the bottom on Windows? How do these pretty cute icons get into the tray? That&rsquo;s the class responsible for this magic ü™Ñ. As any other window, it also has its own additional 40 bytes for each instance and these bytes can be retrieved and set with <code>GetWindowLong</code> and <code>SetWindowLong</code>.</p>
<p>Now, let&rsquo;s assemble it all together. How does this work from a malicious point of view. To actually make this pointer work, one would have to call <code> SetWindowLong</code> (to set the value pointing to some shared memory with shellcode üêö in it) and <code>SendNotifyMessage</code> (to trigger it).</p>
<p>This is the chain of function calls needed for this attack.</p>
<p>Below is the memory layout of the sick process.</p>
<p>Below is the anatomy of the <code>XXXXXXXXXXXXXXXX</code> function call needed for this attack to work</p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<p><img src="images/ewmi-4.png" alt="ewmi-4"></p>
<h4 id="examples">Examples</h4>
<p>Gapz and PowerLoader</p>
<h3 id="shims">SHIMS</h3>
<p>Favourite and the most useful for malware: <code>DisableNX</code>, <code>DisableSEH</code>, <code>InjectDLL</code>.</p>
<p>This is the chain of function calls needed for this attack.</p>
<p>Below is the memory layout of the sick process.</p>
<p>Below is the anatomy of the <code>XXXXXXXXXXXX</code> function call needed for this attack to work</p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<h4 id="examples-1">Examples</h4>
<p>Adware, ‚ÄúSearch Protect by Conduit‚Äù.</p>
<h4 id="-tools">üõ† Tools</h4>
<p><code>python-sdb</code></p>
<h3 id="userland-rootkit">Userland rootkit</h3>
<p>Rootkits are usually associated with the kernel space, however, there are also userland rootkits out there. There are two main techniques known: IAT and inline.</p>
<p>When IAT hooking technique is used, malware changes the import address table. This way when a good application calls some function from this tampered DLL, the replaced function is executed instead.</p>
<p>With inline hooking malware modifies the function&rsquo;s body itself.</p>
<p>This is the chain of function calls needed for this attack.</p>
<p>Below is the memory layout of the sick process.</p>
<p>Below is the anatomy of the XXXX function call needed for this attack to work</p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<p><img src="images/ulr-4.png" alt="ulr-4"></p>
<h4 id="examples-2">Examples</h4>
<h2 id="references">References</h2>
<p>Ten Process Injection Techniques: A Technical Survey Of Common And Trending Process Injection Techniques: <a href="https://www.endgame.com/blog/technical-blog/ten-process-injection-techniques-technical-survey-common-and-trending-process">https://www.endgame.com/blog/technical-blog/ten-process-injection-techniques-technical-survey-common-and-trending-process</a></p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.1237ff71925bb8625c97a9af8db4c54525258bedfd7c47493daaff723bea755e.js"></script>
  

  
  
  
    
  


</body>

</html>
