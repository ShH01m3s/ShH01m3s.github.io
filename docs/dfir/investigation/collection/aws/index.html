<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⛅️ AWS Evidence Collection - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.1af15d612be2936e296de738ed7062bbcecd3efedde8f895f919d76ce622691e.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-forensics 🔍 and incident response 🥷">
      <a href="/docs/dfir">
        <span>Forensics 🔍 and Incident Response 🥷</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting">
      <a href="/docs/thunting">
        <span>Threat Hunting</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-forensics 🔍 and incident response 🥷">
      <a href="/docs/dfir">
        <span>Forensics 🔍 and Incident Response 🥷</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting">
      <a href="/docs/thunting">
        <span>Threat Hunting</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/investigation/collection/"> Back to 🗳 Evidence Collection And Preservation Section 👈🏼 </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#ec2-instance-metadata">EC2 instance metadata</a></li>
    <li><a href="#amazon-ebs-disk-snapshots">Amazon EBS disk snapshots</a></li>
    <li><a href="#ebs-disks-streamed-to-s3">EBS disks streamed to S3</a></li>
    <li><a href="#memory-dumps">Memory dumps</a></li>
    <li><a href="#memory-hibernation">Memory hibernation</a></li>
    <li><a href="#cloudtrail-logs">CloudTrail logs</a></li>
    <li><a href="#aws-config-rule-findings">AWS Config rule findings</a></li>
    <li><a href="#amazon-route-53">Amazon Route 53</a></li>
    <li><a href="#dns-resolverquery-logs">DNS resolver query logs</a></li>
    <li><a href="#vpc-flow-logs">VPC Flow Logs</a></li>
    <li><a href="#aws-security-hubfindings">AWS Security Hub findings</a></li>
    <li><a href="#elastic-load-balancing-access-logs">Elastic Load Balancing access logs</a></li>
    <li><a href="#aws-waf-logs">AWS WAF logs</a></li>
    <li><a href="#custom-application-logs">Custom application logs</a></li>
    <li><a href="#system-logs">System logs</a></li>
    <li><a href="#security-logs">Security logs</a></li>
    <li><a href="#any-third-party-logs">Any third-party logs</a></li>
    <li><a href="#ec2-snapshots">EC2 snapshots</a></li>
    <li><a href="#-btfm">📘 BTFM</a>
      <ul>
        <li><a href="#s3-buckets-download-bucket-contents">S3 Buckets. Download bucket contents</a></li>
        <li><a href="#connect-to-ec2">Connect to EC2</a>
          <ul>
            <li><a href="#ssm">SSM</a></li>
            <li><a href="#ssh-via-identity">SSH via Identity</a></li>
            <li><a href="#ssh-via-userpassword">SSH via user/password</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
 </div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">⛅️ AWS Evidence Collection</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
                <i class="fas fa-search"></i>
              
          <a class="category-link" href="/domain/forensics">forensics</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
                <i class="fa fa-graduation-cap"></i>
              
          <a class="platform-link" href="/doctype/article">article</a>
          
      </div> <br /><br/>
      
      
      
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p>Are there any Shadow Cloud Accounts? Could be the first place to look when investigating.</p>
<h2 id="ec2-instance-metadata">EC2 instance metadata</h2>
<details>
    <summary>Expand &hellip;</summary>
    <p>Some sensitive information can be stored in IMDS if it&rsquo;s not configured properly. T1522 (MITRE). Not the case with service-managed accounts.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh -i <span class="s2">&#34;PUBLIC_KEY.pem&#34;</span> USERNAME@INSTANCE_PUBLIC_IP_OR_DOMAIN
</span></span><span class="line"><span class="cl">curl –s <span class="s2">&#34;http://169.254.169.254/latest/meta-data/security-groups/&#34;</span>
</span></span></code></pre></div><blockquote>
<p>⛔️ If you get curl: (6) Could not resolve host: xn&ndash;s-5gn,
✍🏻 Refer to this issue <a href="https://stackoverflow.com/questions/43734502/curl-command-could-not-resolve-xn-x-5gn-post-on-ubuntu">https://stackoverflow.com/questions/43734502/curl-command-could-not-resolve-xn-x-5gn-post-on-ubuntu</a>. Try typing all dashes manually.</p>
</blockquote>
<p><strong>Case #1. Capital One</strong>
In 2019, Capital One, there was a SSRF + IMDS. See <a href="https://pumasecurity.io/resources/blog/cloud-security-instance-metadata/">here</a>. CLOUD SECURITY - ATTACKING THE METADATA SERVICE <a href="https://pumasecurity.io/resources/blog/cloud-security-instance-metadata/">https://pumasecurity.io/resources/blog/cloud-security-instance-metadata/</a>. IMDSv2 has several protections in place to ensure SSRF is not possible: TTL=1, require PUT request (most WAF don&rsquo;t support it), deny all requests with X-Forwarded-For, X-aws-ec2-metadata-token-ttl-seconds and X- aws-ec2-metadata-token custom headers are required. One only needs to <a href="https://stackoverflow.com/questions/64595032/how-to-tell-what-version-of-instance-metadata-serviceimds-ec2-instance-is-usin#:~:text=If%20you%20want%20to%20determine,what%20the%20status%20code%20is">make sure they have IMDSv2</a> instead of version 1.</p>

  </details>
<h2 id="amazon-ebs-disk-snapshots">Amazon EBS disk snapshots</h2>
<details>
    <summary>Expand &hellip;</summary>
    <h3 id="prerequisites">Prerequisites</h3>
<ul>
<li>Separate account for forensic acquisition and analysis was created (you&rsquo;d need a root access to your AWS organization).
-    <strong>Source Account</strong> – The IAM user or role in the source account needs to be able to call the <code>ModifySnapshotAttribute</code> function and to perform the <code>DescribeKey</code> and <code>ReEncypt</code> operations on the key associated with the original snapshot.
-    <strong>Target Account</strong> – The IAM user or role in the target account needs to be able perform the <code>DescribeKey</code>, <code>CreateGrant</code>, and <code>Decrypt</code> operations on the key associated with the original snapshot. The user or role must also be able to perform the <code>CreateGrant</code>, <code>Encrypt</code>, <code>Decrypt</code>, <code>DescribeKey</code>, and <code>GenerateDataKeyWithoutPlaintext</code> operations on the key associated with the call to <code>CopySnapshot</code>.</li>
<li>One has root privileges to perform EBS snapshotting.</li>
<li>Recycling is enabled in case of accidental deletion.</li>
</ul>
<h3 id="acquisition-steps">Acquisition Steps</h3>
<p>A very high-level: an investigator needs to create a snapshot of a EBS volume and then share it with the forensic account and make a copy of this EBS volume from the forensic account.</p>
<ol>
<li>
<p>EC2 → Volumes → Check the volume for snapshotting. Click Actions → Create Snapshot from the drop-down menu in the top-right corner.</p>
</li>
<li>
<p>In the description field put the name that follows this convention: <code>incnum-forensic-copy-YYYY-MM-DD-HH-MM</code>.</p>
</li>
<li>
<p>Share KMS keys with the forensic account (if these are not shared already).</p>
</li>
<li>
<p>Go to EC2 → Snapshots → choose the snapshot and click Actions → Go to EC2 → Snapshots → choose the snapshot and click Actions → Modify Permissions from the drop-down menu in the top-right corner.</p>
</li>
<li>
<p>Enter the forensic account’s number.</p>
</li>
<li>
<p>In the forensic account go to Snapshots → Private Snapshots.</p>
</li>
<li>
<p>Locate the snapshot shared, check it and click Actions → Copy snapshot from the drop-down menu in the top-right corner.</p>
<p>Copy snapshot functionality, AWS</p>
</li>
<li>
<p>Select an encryption key for the copy of the snapshot and create the copy.</p>
</li>
</ol>
<h3 id="retainment-steps">Retainment Steps</h3>
<p>In order to save space and money and preserve the evidence until it’s agreed that the evidence is no longer needed, the snapshot can be copied to an archive until it’s needed.</p>
<ol>
<li>
<p>From the forensic account (where the snapshot was copied to) go to EC2 → Snapshots.</p>
</li>
<li>
<p>Choose the snapshot to archive.</p>
</li>
<li>
<p>Check it and click Actions → Archive snapshot from the drop-down menu in the top-right corner.</p>
</li>
</ol>

  </details>
<h2 id="ebs-disks-streamed-to-s3">EBS disks streamed to S3</h2>
<p>How to stream logs/data to forensic account?</p>
<h2 id="memory-dumps">Memory dumps</h2>
<h2 id="memory-hibernation">Memory hibernation</h2>
<p>Memory hibernation captured through hibernation on the root EBS volume</p>
<h2 id="cloudtrail-logs">CloudTrail logs</h2>
<p>Stores most of the information about the things that happened in the Cloud (loggin, creating instances etc). Full logs are only seen in <code>json</code> format.
How to stream logs/data to forensic account?</p>
<h2 id="aws-config-rule-findings">AWS Config rule findings</h2>
<h2 id="amazon-route-53">Amazon Route 53</h2>
<p><a href="https://aws.amazon.com/route53/">https://aws.amazon.com/route53/</a></p>
<h2 id="dns-resolverquery-logs">DNS resolver query logs</h2>
<p><a href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/resolver-getting-started.html">https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/resolver-getting-started.html</a></p>
<h2 id="vpc-flow-logs">VPC Flow Logs</h2>
<p><a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html">https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html</a></p>
<h2 id="aws-security-hubfindings">AWS Security Hub findings</h2>
<p><a href="https://aws.amazon.com/security-hub/">https://aws.amazon.com/security-hub/</a></p>
<h2 id="elastic-load-balancing-access-logs">Elastic Load Balancing access logs</h2>
<p><a href="https://aws.amazon.com/elasticloadbalancing/">https://aws.amazon.com/elasticloadbalancing/</a></p>
<h2 id="aws-waf-logs">AWS WAF logs</h2>
<p><a href="https://aws.amazon.com/waf/">https://aws.amazon.com/waf/</a></p>
<h2 id="custom-application-logs">Custom application logs</h2>
<h2 id="system-logs">System logs</h2>
<h2 id="security-logs">Security logs</h2>
<h2 id="any-third-party-logs">Any third-party logs</h2>
<h2 id="ec2-snapshots">EC2 snapshots</h2>
<h2 id="-btfm">📘 BTFM</h2>
<h3 id="s3-buckets-download-bucket-contents">S3 Buckets. Download bucket contents</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ aws s3api list-buckets
</span></span><span class="line"><span class="cl"><span class="c1"># choose the bucket you want to and ... </span>
</span></span><span class="line"><span class="cl"><span class="c1"># ... download bucket contents</span>
</span></span><span class="line"><span class="cl">$ aws s3 sync s3://juicy-staff /tmp/juicy-staff-on-attackers-pc
</span></span></code></pre></div><h3 id="connect-to-ec2">Connect to EC2</h3>
<h4 id="ssm">SSM</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">aws ssm start-session --target <span class="o">[</span>enter instance id<span class="o">]</span>
</span></span></code></pre></div><h4 id="ssh-via-identity">SSH via Identity</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh -i <span class="s2">&#34;~/.ssh/identity.pem&#34;</span> ec2-user@192.168.1.87
</span></span></code></pre></div><h4 id="ssh-via-userpassword">SSH via user/password</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh ec2-user@192.168.1.87
</span></span><span class="line"><span class="cl">&gt; enter the password
</span></span></code></pre></div><h2 id="references">References</h2>
<p>[<a href="https://aws.amazon.com/blogs/security/forensic-investigation-environment-strategies-in-the-aws-cloud/">0</a>]] Forensic investigation environment strategies in the AWS Cloud</p>
<p>[<a href="https://aws.amazon.com/blogs/aws/new-cross-account-copying-of-encrypted-ebs-snapshots/">1</a>] Cross-account copy of EBS snapshot</p>
<p>[<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-copy-snapshot.html">2</a>] Copy EBS snapshot</p>
<p>[<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-creating-snapshot.html">3</a>] Create EBS snapshot</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
