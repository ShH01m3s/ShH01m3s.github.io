<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⛅️ AWS Evidence Collection - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.f5ee5a6a50d29b6390e5652a9df2ffcaffd904244cc05d6f936d9e4feeb76a3d.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-forensics 🔍 and incident response 🥷">
      <a href="/docs/dfir">
        <span>Forensics 🔍 and Incident Response 🥷</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-forensics 🔍 and incident response 🥷">
      <a href="/docs/dfir">
        <span>Forensics 🔍 and Incident Response 🥷</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/investigation/collection/"> Back to 🗳 Evidence Collection And Preservation Section 👈🏼 </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#cloud-forensic-evironment">Cloud Forensic Evironment</a></li>
    <li><a href="#evidence">Evidence</a>
      <ul>
        <li><a href="#ec2-instance-metadata">EC2 instance metadata</a></li>
        <li><a href="#amazon-ebs-disk-snapshots">Amazon EBS disk snapshots</a></li>
        <li><a href="#ebs-disks-streamed-to-s3">EBS disks streamed to S3</a></li>
        <li><a href="#memory-dumps">Memory dumps</a></li>
        <li><a href="#memory-hibernation">Memory hibernation</a></li>
        <li><a href="#cloudtrail-logs">CloudTrail logs</a></li>
        <li><a href="#aws-config-rule-findings">AWS Config rule findings</a></li>
        <li><a href="#amazon-route-53">Amazon Route 53</a></li>
        <li><a href="#dns-resolverquery-logs">DNS resolver query logs</a></li>
        <li><a href="#vpc-flow-logs">VPC Flow Logs</a></li>
        <li><a href="#aws-security-hubfindings">AWS Security Hub findings</a></li>
        <li><a href="#elastic-load-balancing-access-logs">Elastic Load Balancing access logs</a></li>
        <li><a href="#aws-waf-logs">AWS WAF logs</a></li>
        <li><a href="#custom-application-logs">Custom application logs</a></li>
        <li><a href="#system-logs">System logs</a></li>
        <li><a href="#security-logs">Security logs</a></li>
        <li><a href="#any-third-party-logs">Any third-party logs</a></li>
        <li><a href="#ec2-snapshots">EC2 snapshots</a></li>
      </ul>
    </li>
    <li><a href="#-btfm">📘 BTFM</a>
      <ul>
        <li><a href="#s3-buckets-check-for-public-access">S3 Buckets. Check for Public Access</a></li>
        <li><a href="#s3-buckets-download-bucket-contents">S3 Buckets. Download bucket contents</a></li>
      </ul>
    </li>
    <li><a href="#confusing-terms">Confusing Terms</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
 </div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">⛅️ AWS Evidence Collection</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
                <i class="fas fa-search"></i>
              
          <a class="category-link" href="/domain/forensics">forensics</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
                <i class="fa fa-graduation-cap"></i>
              
          <a class="platform-link" href="/doctype/article">article</a>
          
      </div> <br /><br/>
      
      
      
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <h2 id="cloud-forensic-evironment">Cloud Forensic Evironment</h2>
<p>First of all, data that is collected for analysis within the cloud needs to be handled properly as well. For this purpose a separate account is created. There are several roles there that all have different purpose and rights:</p>
<ul>
<li>
<p><input disabled="" type="checkbox"> <strong>Responder</strong> – acquire evidence</p>
</li>
<li>
<p><input disabled="" type="checkbox"> <strong>Investigator</strong> – analyze evidence</p>
</li>
<li>
<p><input disabled="" type="checkbox"> <strong>Data custodian</strong> – manage (copy, move, delete, and expire) evidence</p>
</li>
<li>
<p><input disabled="" type="checkbox"> <strong>Analyst</strong> – access forensics reports for analytics, trends, and forecasting (threat intelligence)</p>
</li>
</ul>
<p><strong>Below are the main considerations:</strong></p>
<ul>
<li><input disabled="" type="checkbox"> Granting access to either the account, or assuming the role needs to be approved by the owner of the IR plan. Preferably, there should be 2 approvers for this.</li>
<li><input disabled="" type="checkbox"> There should be no network traffic coming from or to this account. and therefore all S3 access must be done through an <a href="https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints-s3.html">S3 VPC endpoint</a>. </li>
<li><input disabled="" type="checkbox"> VPC flow logging should be enabled at the Amazon VPC level so that there are records of all network traffic. </li>
<li><input disabled="" type="checkbox"> <a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html">Security groups</a> should be highly restrictive, and deny all ports that aren’t related to the requirements of the forensic tools.</li>
<li><input disabled="" type="checkbox"> SSH and RDP access should be restricted and governed by auditable mechanisms such as a <a href="https://aws.amazon.com/quickstart/architecture/linux-bastion/">bastion host</a> configured to log all connections and activity, <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html">AWS Systems Manager Session Manager</a>, or similar.</li>
<li><input disabled="" type="checkbox"> AMI chosen and pre-configured with industry-trusted tools. One of them would be</li>
</ul>
<h2 id="evidence">Evidence</h2>
<p>Are there any Shadow Cloud Accounts? Could be the first place to look when investigating.</p>
<h3 id="ec2-instance-metadata">EC2 instance metadata</h3>
<p>Some sensitive information can be stored in IMDS if it&rsquo;s not configured properly. T1522 (MITRE). Not the case with service-managed accounts.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh -i <span class="s2">&#34;PUBLIC_KEY.pem&#34;</span> USERNAME@INSTANCE_PUBLIC_IP_OR_DOMAIN
</span></span><span class="line"><span class="cl">curl –s <span class="s2">&#34;http://169.254.169.254/latest/meta-data/security-groups/&#34;</span>
</span></span></code></pre></div><blockquote>
<p>⛔️ If you get curl: (6) Could not resolve host: xn&ndash;s-5gn,
✍🏻 Refer to this issue <a href="https://stackoverflow.com/questions/43734502/curl-command-could-not-resolve-xn-x-5gn-post-on-ubuntu">https://stackoverflow.com/questions/43734502/curl-command-could-not-resolve-xn-x-5gn-post-on-ubuntu</a>. Try typing all dashes manually.</p>
</blockquote>
<p><strong>Case #1. Capital One</strong>
In 2019, Capital One, there was a SSRF + IMDS. See <a href="https://pumasecurity.io/resources/blog/cloud-security-instance-metadata/">here</a>. CLOUD SECURITY - ATTACKING THE METADATA SERVICE <a href="https://pumasecurity.io/resources/blog/cloud-security-instance-metadata/">https://pumasecurity.io/resources/blog/cloud-security-instance-metadata/</a>. IMDSv2 has several protections in place to ensure SSRF is not possible: TTL=1, require PUT request (most WAF don&rsquo;t support it), deny all requests with X-Forwarded-For, X-aws-ec2-metadata-token-ttl-seconds and X- aws-ec2-metadata-token custom headers are required. One only needs to <a href="https://stackoverflow.com/questions/64595032/how-to-tell-what-version-of-instance-metadata-serviceimds-ec2-instance-is-usin#:~:text=If%20you%20want%20to%20determine,what%20the%20status%20code%20is">make sure they have IMDSv2</a> instead of version 1.</p>
<p>How to determine the version:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -s http://169.254.169.254/
</span></span><span class="line"><span class="cl"><span class="c1"># I guess, if you get 1.0 in response, then it&#39;s not well.</span>
</span></span></code></pre></div><h3 id="amazon-ebs-disk-snapshots">Amazon EBS disk snapshots</h3>
<h3 id="ebs-disks-streamed-to-s3">EBS disks streamed to S3</h3>
<p>How to stream logs/data to forensic account?</p>
<h3 id="memory-dumps">Memory dumps</h3>
<h3 id="memory-hibernation">Memory hibernation</h3>
<p>Memory hibernation captured through hibernation on the root EBS volume</p>
<h3 id="cloudtrail-logs">CloudTrail logs</h3>
<p>Stores most of the information about the things that happened in the Cloud (loggin, creating instances etc). Full logs are only seen in <code>json</code> format.
How to stream logs/data to forensic account?</p>
<h3 id="aws-config-rule-findings">AWS Config rule findings</h3>
<h3 id="amazon-route-53">Amazon Route 53</h3>
<p><a href="https://aws.amazon.com/route53/">https://aws.amazon.com/route53/</a></p>
<h3 id="dns-resolverquery-logs">DNS resolver query logs</h3>
<p><a href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/resolver-getting-started.html">https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/resolver-getting-started.html</a></p>
<h3 id="vpc-flow-logs">VPC Flow Logs</h3>
<p><a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html">https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html</a></p>
<h3 id="aws-security-hubfindings">AWS Security Hub findings</h3>
<p><a href="https://aws.amazon.com/security-hub/">https://aws.amazon.com/security-hub/</a></p>
<h3 id="elastic-load-balancing-access-logs">Elastic Load Balancing access logs</h3>
<p><a href="https://aws.amazon.com/elasticloadbalancing/">https://aws.amazon.com/elasticloadbalancing/</a></p>
<h3 id="aws-waf-logs">AWS WAF logs</h3>
<p><a href="https://aws.amazon.com/waf/">https://aws.amazon.com/waf/</a></p>
<h3 id="custom-application-logs">Custom application logs</h3>
<h3 id="system-logs">System logs</h3>
<h3 id="security-logs">Security logs</h3>
<h3 id="any-third-party-logs">Any third-party logs</h3>
<h3 id="ec2-snapshots">EC2 snapshots</h3>
<h2 id="-btfm">📘 BTFM</h2>
<h3 id="s3-buckets-check-for-public-access">S3 Buckets. Check for Public Access</h3>
<p>First, if you have multiple profiles, set them following the instuctions:</p>
<blockquote>
<p>📝 TODO</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat ~/.aws/config<span class="p">|</span> grep <span class="o">[</span>accnumber<span class="o">]</span> -B3 <span class="p">|</span> grep profile --color<span class="o">=</span>always <span class="c1"># get the account name</span>
</span></span><span class="line"><span class="cl">aws s3api get-bucket-acl --bucket <span class="o">[</span>bucketname<span class="o">]</span> --profile<span class="o">=</span>profilename <span class="c1"># get the policy for this bucket. </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># option 1. Bucket doesn&#39;t exist</span>
</span></span><span class="line"><span class="cl">An error occurred <span class="o">(</span>NoSuchBucket<span class="o">)</span> when calling the GetBucketAcl operation: The specified bucket does not exist
</span></span><span class="line"><span class="cl"><span class="c1"># option 2. Bucket exists.</span>
</span></span><span class="line"><span class="cl">Will show a json with permissions
</span></span></code></pre></div><h3 id="s3-buckets-download-bucket-contents">S3 Buckets. Download bucket contents</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ aws s3api list-buckets
</span></span><span class="line"><span class="cl"><span class="c1"># choose the bucket you want to and ... </span>
</span></span><span class="line"><span class="cl"><span class="c1"># ... download bucket contents</span>
</span></span><span class="line"><span class="cl">$ aws s3 sync s3://juicy-staff /tmp/juicy-staff-on-attackers-pc
</span></span></code></pre></div><h2 id="confusing-terms">Confusing Terms</h2>
<p><strong>IAM</strong> - Identity Access Management. This is a service for creating users, groups, roles, permissions, policies.
Each individual using the AWS service needs to have a separate user in AWS associated with them. So, roughly speaking, user = person.
Each user can be in 1+ groups. Theoretically, a user can be not a part of any group, but when they are, it’s easier to manage access and permissions.
Policies are a list of permissions that can be assigned to a group, user, role. Can be created via JSON (raw) or GUI.
Groups have the same permissions defined by purposes.
Roles are assigned to services within AWS. Something similar to groups?</p>
<h2 id="references">References</h2>
<p>[<a href="https://aws.amazon.com/blogs/security/forensic-investigation-environment-strategies-in-the-aws-cloud/">1</a>]] Forensic investigation environment strategies in the AWS Cloud</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
