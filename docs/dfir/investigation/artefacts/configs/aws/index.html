<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AWS Configuration - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-exploits ⚙️">
      <a href="/docs/exploits">
        <span>Exploits ⚙️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting 🪤">
      <a href="/docs/thunting">
        <span>Threat Hunting 🪤</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-exploits ⚙️">
      <a href="/docs/exploits">
        <span>Exploits ⚙️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting 🪤">
      <a href="/docs/thunting">
        <span>Threat Hunting 🪤</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/investigation/artefacts/configs/"> 👈🏼 Back to </br> ⚙️ Windows Config </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#default-configurations">Default Configurations</a></li>
    <li><a href="#custom-config">Custom Config</a></li>
    <li><a href="#dangerous-policies">Dangerous Policies</a>
      <ul>
        <li><a href="#ssh-access">SSH Access</a></li>
        <li><a href="#network-configuration">Network Configuration</a></li>
      </ul>
    </li>
    <li><a href="#-btfm">📘 BTFM</a>
      <ul>
        <li><a href="#get-credentials">Get credentials</a></li>
        <li><a href="#terraform-init">Terraform Init</a></li>
        <li><a href="#s3-buckets-check-for-public-access">S3 Buckets. Check for Public Access</a></li>
        <li><a href="#imds">IMDS</a>
          <ul>
            <li><a href="#get-imds-version">Get IMDS version</a></li>
            <li><a href="#check-for-ssm-with-imdsv2">Check for SSM with IMDSv2</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#-toolkit">🧰 Toolkit</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">AWS Configuration</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      
      <div class="article-category">
          
            
            
            
            
            
            
            <i class="fab fa-aws"></i>
            
          
          
      </div> <br />
      

      
      <div class="article-category">
        <i class="fas fa-tools"></i>
          
          
          <a class="platform-link" href="/tools/aws-cli">AWS CLI</a> 
          
           , 
          <a class="platform-link" href="/tools/terraform">Terraform</a> 
          
      </div> <br />
      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <h2 id="default-configurations">Default Configurations</h2>
<p>By default, SSH 22 and RDP 3389 are closed, but these are suggested to be opened when creaing them, warning how dangeroud this is. What&rsquo;s <a href="https://docs.aws.amazon.com/vpc/latest/mirroring/what-is-traffic-mirroring.html">traffic mirroring</a>? Using <a href="https://docs.aws.amazon.com/vpc/latest/mirroring/tm-example-open-source.html">this functionality with</a> open-source tools.</p>
<h2 id="custom-config">Custom Config</h2>
<p>If SSM is enabled (System Manager Service), then activity is logged in CloudTrail. At least,  <code>AmazonSSMManagedInstanceCore</code> needs to be attached to the instance profile role. Look at the policies and which users are granted the access. Also, commands run can be also restricted.</p>
<p>If the organization uses Terraform, you could look for any resources that were <strong>NOT</strong> created via Terraform.</p>
<h2 id="dangerous-policies">Dangerous Policies</h2>
<p>Policies, security groups and roles define what level and type of access and to which resources this entity has. That&rsquo;s why overpermissive policies or overpowerful roles might cause the most damage if compromised.</p>
<h3 id="ssh-access">SSH Access</h3>
<p>One of the worst since this permission would give the attacker access to the OS level of the EC2 instance. Of course, they would require a password, that&rsquo;s why they would try bruteforcing it first and this is where a good password policy would really pay off since you would have more time to detect and respond to the alert. What if you still need SSH access to the machine? Make sure to use VERY complex passwords, or much better - public key authentication, or better still use the ssh from the AWS GUI Console and block any SSH from outside AWS.The more security - the less usability and the fewer functionality. But it&rsquo;s better then biting your elbows in the court afterwards. Even if you don&rsquo;t have anything of much value on this particular instance, it doesn&rsquo;t mean the attacker won&rsquo;t be able to move laterally. Here are several techniques from MITRE: <a href="https://attack.mitre.org/techniques/T1534/">https://attack.mitre.org/techniques/T1534/</a>, <a href="https://attack.mitre.org/techniques/T1080/">https://attack.mitre.org/techniques/T1080/</a> and <a href="https://attack.mitre.org/techniques/T1550/">https://attack.mitre.org/techniques/T1550/</a> with examples.</p>
<h3 id="network-configuration">Network Configuration</h3>
<p>Some policies allow an entity change network settings.</p>
<h2 id="-btfm">📘 BTFM</h2>
<h3 id="get-credentials">Get credentials</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Get current creds and region for aws CLI</span>
</span></span><span class="line"><span class="cl">~/.aws/credentials
</span></span><span class="line"><span class="cl">~/.aws/config
</span></span></code></pre></div><h3 id="terraform-init">Terraform Init</h3>
<p>Terraform prerequisites: account on AWS, Google, Azure or another Cloud provider, Terraform isntalled locally on the PC, credentials from the cloud in question (for example, for AWS these are <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code>). For full instructions refer to [<a href="https://learn.hashicorp.com/tutorials/terraform/aws-build?in=terraform/aws-get-started">2</a>].</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">terraform init
</span></span><span class="line"><span class="cl"><span class="c1"># create some tf file or make changes to the existing one</span>
</span></span><span class="line"><span class="cl">terraform apply
</span></span><span class="line"><span class="cl">terraform destroy <span class="c1"># to delete what was deleted</span>
</span></span></code></pre></div><h3 id="s3-buckets-check-for-public-access">S3 Buckets. Check for Public Access</h3>
<p>First, if you have multiple profiles, set them following the instuctions:</p>
<blockquote>
<p>📝 TODO</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat ~/.aws/config<span class="p">|</span> grep <span class="o">[</span>accnumber<span class="o">]</span> -B3 <span class="p">|</span> grep profile --color<span class="o">=</span>always <span class="c1"># get the account name</span>
</span></span><span class="line"><span class="cl">aws s3api get-bucket-acl --bucket <span class="o">[</span>bucketname<span class="o">]</span> --profile<span class="o">=</span>profilename <span class="c1"># get the policy for this bucket. </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># option 1. Bucket doesn&#39;t exist</span>
</span></span><span class="line"><span class="cl">An error occurred <span class="o">(</span>NoSuchBucket<span class="o">)</span> when calling the GetBucketAcl operation: The specified bucket does not exist
</span></span><span class="line"><span class="cl"><span class="c1"># option 2. Bucket exists.</span>
</span></span><span class="line"><span class="cl">Will show a json with permissions
</span></span></code></pre></div><h3 id="imds">IMDS</h3>
<p>Following the best practices, one would use IMDSv2, but if it&rsquo;s not the case, then one can <code>ssh</code> into EC2 and run the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -s <span class="s2">&#34;http://169.254.169.254/latest/meta-data/iam/security-credentials/&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; my-ec2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">curl -s <span class="s2">&#34;http://169.254.169.254/latest/meta-data/iam/security-credentials/my-ec2&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># if you see something juicy here, not that great. If it&#39;s IMDSv1, even worse.</span>
</span></span></code></pre></div><p>The result is something like the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Code&#34;</span> <span class="p">:</span> <span class="s2">&#34;Success&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Last Updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2021-01-16T08:00:00Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Type&#34;</span><span class="p">:</span> <span class="s2">&#34;AWS-HMAC&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;AccessKeyId&#34;</span><span class="p">:</span> <span class="s2">&#34;1234567890&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;SecretAcessKey&#34;</span><span class="p">:</span> <span class="s2">&#34;12345678901234567890&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Token&#34;</span><span class="p">:</span> <span class="s2">&#34;a very long base64 encoded string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Expiration&#34;</span><span class="p">:</span> <span class="s2">&#34;2025-04-16T08:00:00Z&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>How to use IMDSv2 - <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html</a>. IMDSv2 has several protections in place to ensure SSRF is not possible: TTL=1 (IP, network layer, of TCP/IP, network), req,uire PUT request (most WAF don&rsquo;t support it), deny all requests with <code>X-Forwarded-For</code>, <code>X-aws-ec2-metadata-token-ttl-seconds</code> and <code>X- aws-ec2-metadata-token</code> custom headers are required. One only needs to <a href="https://stackoverflow.com/questions/64595032/how-to-tell-what-version-of-instance-metadata-serviceimds-ec2-instance-is-usin#:~:text=If%20you%20want%20to%20determine,what%20the%20status%20code%20is">make sure they have IMDSv2</a> instead of version 1.</p>
<p>If one uses <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/launch_template#metadata-options">Terraform</a>, try using the below settings:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="n">metadata_options</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">http_endpoint</span> <span class="o">=</span> <span class="s">&#34;enabled&#34;</span> <span class="c1">// better set disabled in case it&#39;s not required by EC2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">http_tokens</span> <span class="o">=</span> <span class="s">&#34;required&#34;</span> <span class="c1">// one way to prevent SSRF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">http_put_response_hop_limit</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">// requests will be blocked if requested by any other machine other then the EC2 itself.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></div><h4 id="get-imds-version">Get IMDS version</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -s http://169.254.169.254/
</span></span><span class="line"><span class="cl"><span class="c1"># I guess, if you get 1.0 in response, then it&#39;s not well.</span>
</span></span></code></pre></div><h4 id="check-for-ssm-with-imdsv2">Check for SSM with IMDSv2</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo snap install amazon-ssm-agent --channel<span class="o">=</span>candidate
</span></span></code></pre></div><h2 id="-toolkit">🧰 Toolkit</h2>
<p><a href="https://rhinosecuritylabs.com/aws/pacu-open-source-aws-exploitation-framework/">Pacu</a>, AWS exploitation framework. Might be good to use when you need to find the flaw in your infrastructure.</p>
<p><a href="https://github.com/duo-labs/parliament">Parliament</a>. Find vulnerabilities in IAM policies statically.</p>
<h2 id="references">References</h2>
<p>[<a href="https://flohealth.udemy.com/course/terraform-fast-track/learn/lecture/21023824#overview">1</a>] Udemy Course on Terraform</p>
<p>[<a href="https://learn.hashicorp.com/tutorials/terraform/aws-build?in=terraform/aws-get-started">2</a>] Terraform official website with tutorials</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
