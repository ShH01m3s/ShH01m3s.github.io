<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AWS Authentication - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ü™§">
      <a href="/docs/thunting">
        <span>Threat Hunting ü™§</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ü™§">
      <a href="/docs/thunting">
        <span>Threat Hunting ü™§</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/investigation/artefacts/accounts/"> üëàüèº Back to </br> üìù Account Information Analysis </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#iam">IAM</a></li>
    <li><a href="#iam-policies">IAM Policies</a>
      <ul>
        <li><a href="#access-decision-tree">Access Decision Tree</a></li>
        <li><a href="#instance-profile">Instance profile</a></li>
        <li><a href="#policy-types-by-owner">Policy Types By Owner</a></li>
      </ul>
    </li>
    <li><a href="#login-activity">Login activity</a></li>
    <li><a href="#tokens">Tokens</a>
      <ul>
        <li><a href="#imds">IMDS</a></li>
        <li><a href="#access-tokens">Access Tokens</a></li>
      </ul>
    </li>
    <li><a href="#service-usage-activity">Service usage activity</a></li>
    <li><a href="#useridentity">userIdentity</a>
      <ul>
        <li><a href="#assumedrole"><code>AssumedRole</code></a></li>
        <li><a href="#iamuser"><code>IAMUser</code></a></li>
      </ul>
    </li>
    <li><a href="#-btfm">üìò BTFM</a>
      <ul>
        <li><a href="#login-in-via-aws-cli">Login in via AWS CLI</a></li>
        <li><a href="#retieve-metadata-from-ec2">Retieve Metadata from EC2</a></li>
      </ul>
    </li>
    <li><a href="#root">Root</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">AWS Authentication</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      
      <div class="article-category">
          
            
            
            
            
            
            
            <i class="fab fa-aws"></i>
            
          
          
      </div> <br />
      

      
      

      
    </div>
    
    <b>Created:</b> 09.09.2020
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p><em>This article is about AWS authentication process and how this activity is logged within the system.</em></p>
<h2 id="iam">IAM</h2>
<p>Stands for <strong>I</strong>dentity <strong>A</strong>ccess <strong>M</strong>anagement.
There are several types of IAM identities. They are usually called &ldquo;Principal&rdquo;. This can be either a User or a Role. It can even be a service or an account. Users can assume Roles. Instance Profile is basically a separate IAM Role assumed by this particular instance.</p>
<p><strong>IAM role</strong>. Some entity (principal in AWS language) that can be assumed by others (users, services, instances, accounts). However assumes the role, is provided with temporary credentials.</p>
<blockquote>
<p>‚ùì As far as I know, principals (which I suppose is very close to the term entity) has an ID and probably a AccessKey as well.</p>
</blockquote>
<p>Roles do not exist on their own. No, they are not ally cats üêà‚Äç‚¨õ. Instead, when a principal (service, user, account etc) assumes a role, it is given temporary credentials that expire with time. These credentials, btw, are stored in the IMDS. That&rsquo;s what it is for. <code>AWS_ACCESS_KEY_ID</code> for temp creds starts with a <code>ASIA</code> prefix.</p>
<blockquote>
<p>‚ùì If some entity assumed some role, can these temp creds be used by other entity?</p>
</blockquote>
<p>There are also ACLs (<strong>A</strong>ccess <strong>C</strong>ontrol <strong>L</strong>ists), they have XML format and define which principals in <em>other</em> AWS accounts can access a resouce in question.</p>
<p>Nice diagram <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_evaluation-logic.html">here</a> showing how exactly AWS decides whether to grant access or not:</p>
<p>![[dfir/investigation/artefacts/accounts/aws-auth/images/diagram.png]]</p>
<p>In order to understand what permissions something has, you need to add identity, resource policy + session restrictions.</p>
<h2 id="iam-policies">IAM Policies</h2>
<p>Policies consist of statements: Effect (ALLOW or DENY), Actions (What&rsquo;s about to be done) and Resource (What&rsquo;s it to be done to).</p>
<p>Policy created can be assigned to a user, a group, a resource, other principal.</p>
<p>There are several types of policies.</p>
<p><strong>Organization Service Control Policy (SCP)</strong>. This is one of the major. It specifies the maximum permissions that can be granted to IB or RB policies within the organization. Below is an example of such policy. It basically doesn&rsquo;t allow IAM actions applied to any of the resources in case the request is not coming from eu-west-1 region.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span> 
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Version&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-08-06&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Statement&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Sid&#34;</span><span class="p">:</span> <span class="s2">&#34;SCP Policy&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Effect&#34;</span><span class="p">:</span> <span class="s2">&#34;Deny&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;NotAction&#34;</span><span class="p">:</span> <span class="s2">&#34;iam:*&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Resource&#34;</span><span class="p">:</span> <span class="s2">&#34;*&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Condition&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nt">&#34;StringNotEquals&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nt">&#34;aws:RequestedRegion&#34;</span><span class="p">:</span> <span class="s2">&#34;eu-west-1&#34;</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Resource-based</strong>. Describe principles that are allowed to touch this particular resource.</p>
<blockquote>
<p>‚ùóÔ∏è Not all resources support RB policies.</p>
</blockquote>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Version&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-08-06&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Statement&#34;</span><span class="p">:</span> <span class="p">[</span> 
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			 <span class="nt">&#34;Sid&#34;</span><span class="p">:</span> <span class="s2">&#34;my-ec2 Resource-based Policy&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			 <span class="nt">&#34;Effect&#34;</span><span class="p">:</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			 <span class="nt">&#34;Action&#34;</span><span class="p">:</span> <span class="p">[</span> 
</span></span><span class="line"><span class="cl">				 <span class="s2">&#34;ec2:*&#34;</span> 
</span></span><span class="line"><span class="cl">			 <span class="p">],</span> 
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Principal&#34;</span><span class="p">:</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">				<span class="nt">&#34;AWS&#34;</span><span class="p">:[</span>
</span></span><span class="line"><span class="cl">					<span class="s2">&#34;arn:aws:iam::123456789:role/my-ec2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="s2">&#34;arn:aws:iam::123456789:user/superadmin&#34;</span>
</span></span><span class="line"><span class="cl">				<span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Identity-based</strong>. Specify resources that these identities are allowed to touch. Example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Version&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-08-06&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Statement&#34;</span><span class="p">:</span> <span class="p">[</span> 
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			 <span class="nt">&#34;Sid&#34;</span><span class="p">:</span> <span class="s2">&#34;my-ec2 Identity-based Policy&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			 <span class="nt">&#34;Effect&#34;</span><span class="p">:</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			 <span class="nt">&#34;Action&#34;</span><span class="p">:</span> <span class="p">[</span> 
</span></span><span class="line"><span class="cl">				 <span class="s2">&#34;s3:*&#34;</span> 
</span></span><span class="line"><span class="cl">			 <span class="p">],</span> 
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Resource&#34;</span><span class="p">:</span> <span class="s2">&#34;*&#34;</span> 
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Session policy</strong>. Used when programmatically creating a session. Limits the permissions. First, one needs to create a session. Let&rsquo;s say, Ezio is a product manager but needs to access some accounting information.<code>aws sts assume-role --role-arn &quot;arn:aws:iam::123456789:role/accountant&quot; --role-session-name &quot;accountant-alice-session&quot; --policy file://policy.json</code>.</p>
<p><code>--role-arn arn:aws:iam::123456789:role/accountant</code> - it&rsquo;s the IB policy. Resource policy is evaluated behind the scenes.</p>
<p><code>--policy file://policy.json</code> is our session policy (if any).</p>
<p>The example above basically says the following: <em>&ldquo;I am Ezio and I want to become an accountant for a day to access some resource. May I?&rdquo;</em>. Example of such policy:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>  <span class="nt">&#34;Version&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-06-08&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;Statement&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;Effect&#34;</span><span class="p">:</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;Action&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;s3:ListBucket&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;Resource&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;arn:aws:s3:::accountinginfo&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;Condition&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&#34;StringLike&#34;</span><span class="p">:{</span> <span class="nt">&#34;s3:prefix&#34;</span><span class="p">:[</span><span class="s2">&#34;ezio/*&#34;</span><span class="p">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;Effect&#34;</span><span class="p">:</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;Action&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;s3:GetObject&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;Resource&#34;</span><span class="p">:</span> <span class="s2">&#34;arn:aws:s3:::accountinginfo/ezio/*&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">]}</span>
</span></span></code></pre></div><p><strong>Permissions boundary</strong>. This is very close to the SCP in that it limits the maximum permissions that can be granted to a principal.</p>
<p><strong>Access control lists</strong>. ‚ùóÔ∏è XML. Basically, RB policies but for cross-account stuff.</p>
<h3 id="access-decision-tree">Access Decision Tree</h3>
<p>The official doc&rsquo;s here [<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_evaluation-logic.html">2</a>].</p>
<ol>
<li>Search for &ldquo;Deny&rdquo; within the scope. If found, game over. Nothing is allowed.</li>
<li>Review the SCP (if applicable). Deby if something is there prohibiting the request.</li>
<li>Review the resource policy (if any). If this principal is not allowed - tell him to bugger off.</li>
<li>If there are any permissions boundary, evaluate them first. If something the principal is requesting is prohibited, deny the request alltogether.</li>
<li>If these are temp credentials, evaluate the session policy. If anything is wrong, deny.</li>
<li>Evaluate all of the IB policies associated with the principal.</li>
</ol>
<h3 id="instance-profile">Instance profile</h3>
<p>Instance profile is a container of a signle IAM role. For EC2 instances. It&rsquo;s assigned to one IAM role, which has a number of managed or inline policy permissions. These credentials can be accessed via IMDSv1: <code>curl ‚Äìs &quot;http://169.254.169.254/latest/meta-data/iam/security-credentials/role-name&quot;</code>.</p>
<p>For IMDSv2: <code>TOKEN=$(curl -s -X PUT -H &quot;X-aws-ec2-metadata-token-ttl-seconds: 21600&quot; http://169.254.169.254/latest/api/token)</code> to retrieve the token and <code>curl -H &quot;X-aws-ec2-metadata-token: $TOKEN&quot;http://169.254.169.254/latest/meta-data/iam/security-credentials/role-name&quot;</code> set the value of a <code>X-aws-ec2-metadata-token</code> HTTP header to that retreived value.</p>
<blockquote>
<p>‚ö†Ô∏è The above one didn&rsquo;t work for me. Probably because of the well designed security restrictions.</p>
</blockquote>
<h3 id="policy-types-by-owner">Policy Types By Owner</h3>
<p>AWS Managed Policies - shared between all AWS customers.</p>
<p>Customer Managed Policies - every customer withing AWS realm creates private policies that are managed by them.</p>
<p>Inline policies - owned by a principle and can&rsquo;t be reused by other entities.</p>
<h2 id="login-activity">Login activity</h2>
<p>For admin account go to IAM -&gt; Credential report to see all the users and the following information:</p>
<ol>
<li>user name</li>
<li>arn (acc N + username)</li>
<li>user_creation_time</li>
<li>password_enabled</li>
<li>password_last_used</li>
<li>password_last_changed</li>
<li>password_next_rotation</li>
<li>mfa_active</li>
<li>access_key_1_active</li>
<li>access_key_1_last_rotated</li>
<li>access_key_1_last_used_date</li>
<li>access_key_1_last_used_region</li>
<li>access_key_1_last_used_service</li>
<li>access_key_2_active</li>
<li>access_key_2_last_rotated</li>
<li>access_key_2_last_used_date</li>
<li>access_key_2_last_used_region</li>
<li>access_key_2_last_used_service</li>
<li>cert_1_active</li>
<li>cert_1_last_rotated</li>
<li>cert_2_active</li>
<li>cert_2_last_rotated</li>
</ol>
<h2 id="tokens">Tokens</h2>
<p>On AWS there are several types of tokens.</p>
<h3 id="imds">IMDS</h3>
<p>IMDSv2 tokens live for 6 hours, see <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html">here</a>:</p>
<blockquote>
<p>The¬†<code>PUT</code>¬†request must include a header that specifies the time to live (TTL) for the token, in seconds, up to a maximum of six hours (21,600 seconds).</p>
</blockquote>
<p>IMDSv1 doesn&rsquo;t have token at all.</p>
<h3 id="access-tokens">Access Tokens</h3>
<p>Tokens for users can be configired, see <a href="https://docs.aws.amazon.com/cli/latest/reference/sts/get-session-token.html">here</a>:</p>
<blockquote>
<p>The duration, in seconds, that the credentials should remain valid. Acceptable durations for IAM user sessions range from 900 seconds (15 minutes) to 129,600 seconds (36 hours), with 43,200 seconds (12 hours) as the default.</p>
</blockquote>
<p>For this use <code>get-session-token</code> with <code>--duration-seconds</code> option. This is for temp credentials only. These creds can&rsquo;t get to IAM info (if no MFA is also included) or STS API, aka Security Token Service (other than <code>AssumeRole</code> or <code>GetCallerIdentity</code>).</p>
<p><code>AWS_ACCESS_KEY_ID</code> for temp creds starts with a <code>ASIA</code> prefix.</p>
<h2 id="service-usage-activity">Service usage activity</h2>
<p>Also, you can go to IAM -&gt; username -&gt; Access Advisor tab to see the services that this user has access to and when these were last used.</p>
<h2 id="useridentity">userIdentity</h2>
<p><code>userIdentity</code> can be either <code>AssumedRole</code> or <code>IAMUser</code>.</p>
<blockquote>
<p>An IAM administrator can configure AWS Security Token Service to require that users specify their identity when they use temporary credentials to assume roles.</p>
</blockquote>
<h3 id="assumedrole"><code>AssumedRole</code></h3>
<p>The user can either use their creds directly or use some role (policy instead). In this case, logs will also contain <code>sessionContext</code>.</p>
<h3 id="iamuser"><code>IAMUser</code></h3>
<h2 id="-btfm">üìò BTFM</h2>
<h3 id="login-in-via-aws-cli">Login in via AWS CLI</h3>
<p>Ensure you have <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">AWS CLI</a> installed.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s2">&#34;ASIAJKJHASDKJHSDKJLA&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s2">&#34;akljhdljkhljhewhjjkhsd/s&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">AWS_SESSION_TOKEN</span><span class="o">=</span><span class="s2">&#34;kajsdhkjsaha&#34;</span> <span class="c1"># optional. AWS_SESSION_TOKEN is required with temp creds only.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">aws <span class="nb">help</span>
</span></span><span class="line"><span class="cl"><span class="c1"># You&#39;ll see all available options. For example, you can run aws ec2 to see what you can do to the EC2 instances from within the CLI</span>
</span></span></code></pre></div><h3 id="retieve-metadata-from-ec2">Retieve Metadata from EC2</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># ssh into the machine in question</span>
</span></span><span class="line"><span class="cl">ssh user@machineIPorDNSname
</span></span><span class="line"><span class="cl"><span class="c1"># when promted for the password for user, enter it (in case public key encryption is not being used)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The next two commands are issued from the EC2&#39;s console</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># IMDSv1</span>
</span></span><span class="line"><span class="cl">curl ‚Äìs <span class="s2">&#34;http://169.254.169.254/latest/meta-data/iam/security-credentials/role-name&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># IMDSv2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to retrieve the token</span>
</span></span><span class="line"><span class="cl"><span class="nv">TOKEN</span><span class="o">=</span><span class="k">$(</span>curl -s -X PUT -H <span class="s2">&#34;X-aws-ec2-metadata-token-ttl-seconds: 21600&#34;</span> http://169.254.169.254/latest/api/token<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># set X-aws-ec2-metadata-token header to that value</span>
</span></span><span class="line"><span class="cl"> curl -H <span class="s2">&#34;X-aws-ec2-metadata-token: </span><span class="nv">$TOKEN</span><span class="s2">&#34;</span> http://169.254.169.254/latest/meta-data/iam/security-credentials/role-name<span class="s2">&#34;
</span></span></span></code></pre></div><h2 id="root">Root</h2>
<p>It&rsquo;s not recommended to use <code>root</code> user for any activity on AWS unless it&rsquo;s something that only root can done. <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html">https://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html</a>
<a href="https://docs.aws.amazon.com/general/latest/gr/root-vs-iam.html#aws_tasks-that-require-root">https://docs.aws.amazon.com/general/latest/gr/root-vs-iam.html#aws_tasks-that-require-root</a></p>
<h2 id="references">References</h2>
<p>[<a href="https://www.youtube.com/watch?v=Qg7ZydKo9UU">1</a>] About IAM policies
[<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_evaluation-logic.html">2</a>] Official AWS docs on policy evaluation order.</p>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
