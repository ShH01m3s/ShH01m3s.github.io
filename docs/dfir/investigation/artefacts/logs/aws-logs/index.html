<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AWS Logs - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting 🪤">
      <a href="/docs/thunting">
        <span>Threat Hunting 🪤</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting 🪤">
      <a href="/docs/thunting">
        <span>Threat Hunting 🪤</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/investigation/artefacts/logs/"> 👈🏼 Back to </br> 🪵 Log Analysis </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#cloudtrail">CloudTrail</a>
      <ul>
        <li><a href="#-btfm">📘 BTFM</a></li>
      </ul>
    </li>
    <li><a href="#vpc-flow-logs">VPC Flow Logs</a>
      <ul>
        <li><a href="#-btfm-1">📘 BTFM</a></li>
      </ul>
    </li>
    <li><a href="#resource-timeline">Resource Timeline</a></li>
    <li><a href="#iam-activity">IAM Activity</a>
      <ul>
        <li><a href="#iamhomecredential_report">iam/home#/credential_report</a></li>
        <li><a href="#access-advisor">Access Advisor</a></li>
      </ul>
    </li>
    <li><a href="#vpc-traffic-mirroring">VPC Traffic Mirroring</a></li>
    <li><a href="#vpn">VPN</a></li>
    <li><a href="#logs-archieved-in-s3">Logs Archieved In S3</a></li>
    <li><a href="#cloudwatch">CloudWatch</a></li>
    <li><a href="#sqs">SQS</a>
      <ul>
        <li><a href="#-btfm-2">📘 BTFM</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">AWS Logs</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      
      <div class="article-category">
          
            
            
            
            
            
            
            <i class="fab fa-aws"></i>
            
          
          
      </div> <br />
      

      
      <div class="article-category">
        <i class="fas fa-tools"></i>
          
          
          <a class="platform-link" href="/tools/cloudtrail">Cloudtrail</a> 
          
           , 
          <a class="platform-link" href="/tools/aws-cli">AWS CLI</a> 
          
      </div> <br />
      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p><em>This document is devoted to AWS logs. Several examples are analysed and useful fields are marked.</em></p>
<h2 id="cloudtrail">CloudTrail</h2>
<p>This is an example log from a AWS CTF <a href="https://cyberdefenders.org/blueteam-ctf-challenges/84">challenge</a>. I am going to use this one in order to get an idea of what is being logged and how this can be useful for investigations.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;Records&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;eventVersion&#34;</span><span class="p">:</span> <span class="s2">&#34;1.05&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;userIdentity&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;AWSService&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;invokedBy&#34;</span><span class="p">:</span> <span class="s2">&#34;ecs-tasks.amazonaws.com&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;eventTime&#34;</span><span class="p">:</span> <span class="s2">&#34;2018-11-28T22:31:59Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;eventSource&#34;</span><span class="p">:</span> <span class="s2">&#34;sts.amazonaws.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;eventName&#34;</span><span class="p">:</span> <span class="s2">&#34;AssumeRole&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;awsRegion&#34;</span><span class="p">:</span> <span class="s2">&#34;us-east-1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sourceIPAddress&#34;</span><span class="p">:</span> <span class="s2">&#34;ecs-tasks.amazonaws.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;userAgent&#34;</span><span class="p">:</span> <span class="s2">&#34;ecs-tasks.amazonaws.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;requestParameters&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;roleSessionName&#34;</span><span class="p">:</span> <span class="s2">&#34;d190d14a-2404-45d6-9113-4eda22d7f2c7&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;roleArn&#34;</span><span class="p">:</span> <span class="s2">&#34;arn:aws:iam::653711331788:role/level3&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;responseElements&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;credentials&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;sessionToken&#34;</span><span class="p">:</span> <span class="s2">&#34;FQoGZXIvYXdzEFAaDEbnJXLefTT+kjlmKSKSBNgEUj8tJVL+szjaH5q2npYc2FIPgrLmfkRjK9KqtSW7+lo4WxteBTd77aeAcmIip4GceNBbU86zxGgS1IdNBzEOLnDw6biAzijG0Du/Qazx136qjy+kahHxPlR36C4y/0QrCUZpTFmP3uELsRIKkvhGvuBr6S10pTOZ+GjtUXN3iFV8Ea0KOo/fSP0d4LbZGwI957aJxs2I7N8ji/lKTfwPdq+sxXvSWnaOseinUxZUDS0zdI69CKb6C+qwhR5YTifqyuOvC9OoSlfcBN2FyHpRZf5Bd+Z+mPYTldbAvD/HcdbQo7U4jqlR2WGuXoBfwvypt/Kb6HtPp4g9O0HlTCc7Sb4uiJY81WMbaNFmmYXyj62gi+BN5QaA90YhWn9cU1x9gqt0uEgvSk/RdrwtulTtNyJcuuFvhlD1gaJHGc4eCoWApr+J9nrbPTvSo00sc8IYIVvwOi3NRsmP+ZA9aQOV/qg2L1cYxScQrQ/pKVOnYWJ4XuB0WL8gRYdo1bGI6LWGAtOV+fzVoXU0SfWH7UmPcvttqkWsv1Rr50pspmJneXeY6Ge1szNsvyHqmPFJj7GAXnEKl9xthHK3IaDc6HEprFqYw8SyQqYWGdpeism2S+V4XpIMbQJlC06BxyOg94H0Fiffzs8wwnCUpBU0s69X2tN8sxb4U3FqKl28mwCOuuaweZeGWq5MWxU7Fop2dmjaKN+u/N8F&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;accessKeyId&#34;</span><span class="p">:</span> <span class="s2">&#34;ASIAZQNB3KHGNXWXBSJS&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;expiration&#34;</span><span class="p">:</span> <span class="s2">&#34;Nov 29, 2018 4:31:59 AM&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;requestID&#34;</span><span class="p">:</span> <span class="s2">&#34;6b7d6c60-f35d-11e8-becc-39e7d43d4afe&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;eventID&#34;</span><span class="p">:</span> <span class="s2">&#34;6177ca7e-860e-482c-bde9-50c735af58d6&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;resources&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ARN&#34;</span><span class="p">:</span> <span class="s2">&#34;arn:aws:iam::653711331788:role/level3&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;accountId&#34;</span><span class="p">:</span> <span class="s2">&#34;653711331788&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;AWS::IAM::Role&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;eventType&#34;</span><span class="p">:</span> <span class="s2">&#34;AwsApiCall&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;recipientAccountId&#34;</span><span class="p">:</span> <span class="s2">&#34;653711331788&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sharedEventID&#34;</span><span class="p">:</span> <span class="s2">&#34;1d18bf74-8392-4496-9dc4-a45cb799b8b4&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;eventVersion&#34;</span><span class="p">:</span> <span class="s2">&#34;1.05&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;userIdentity&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;AWSService&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;invokedBy&#34;</span><span class="p">:</span> <span class="s2">&#34;ecs-tasks.amazonaws.com&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;eventTime&#34;</span><span class="p">:</span> <span class="s2">&#34;2018-11-28T22:31:59Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;eventSource&#34;</span><span class="p">:</span> <span class="s2">&#34;sts.amazonaws.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;eventName&#34;</span><span class="p">:</span> <span class="s2">&#34;AssumeRole&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;awsRegion&#34;</span><span class="p">:</span> <span class="s2">&#34;us-east-1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sourceIPAddress&#34;</span><span class="p">:</span> <span class="s2">&#34;ecs-tasks.amazonaws.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;userAgent&#34;</span><span class="p">:</span> <span class="s2">&#34;ecs-tasks.amazonaws.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;requestParameters&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;roleSessionName&#34;</span><span class="p">:</span> <span class="s2">&#34;d190d14a-2404-45d6-9113-4eda22d7f2c7&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;roleArn&#34;</span><span class="p">:</span> <span class="s2">&#34;arn:aws:iam::653711331788:role/ecsTaskExecutionRole&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;responseElements&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;credentials&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;sessionToken&#34;</span><span class="p">:</span> <span class="s2">&#34;FQoGZXIvYXdzEFAaDAhihig4wSQxSSiMjSKSBOW1B0tXzW8SIP7MtRZEikuZamVqb7hEQtmgX5LDeDzpOxpP4G9U8r3cZK74HNErY8W+Scri3Y8NVr/VO7MyzIXnpXiEDo10JfNYnA+urhxB+rYtPF6o8uzm40w/lqdq1/DyOkYYuFRtqWfS4Jy1t83KYAFTuX5IkTGekMidOkIcdnHjsZKQSqKs4U3MQ4doUG4nCyEERDv9yckTPq/R4fKEPTF1BN0jycyiSiR3OTPAWaLGMGxHthAKSA5IXosrPBAq0yD2HhSKZc0kbskCZyGOQCcmVAQK4IdEjyk4Lytc+PEDasvWiGoCQPEqlwwqFJm7EPm838MjCTi4ojN9nVYRP9hFYkXdvnVG6ScwoBfbg135vN1bqYgEKDncW780xUBRYwElM4Q2/6zv7DMj0UegbRJmAwtys4phLrItQqNLWPmBbW/pNgMYoT1IKfzDmuc27AyTHtL8t25hkYOLWZG19EYKm+XeHU9gbs0aDTPssjBFPZp7ssR35IHhgcw5m+etXSoXMxMuHNbVR46ZJ6uieR8roEZ8QfiIijyB8J7i2sH2JOY0HIOonbVYmqdtv++0D+1idTO+6ZbXJIKhEmDmZZDeenF2ZXQGH4PgA4udIdBXnhVLzVFkEKc1MWG3aAhuOhZLvnXkOpkn1XjwfDx3N0UyenOUR4x/gkY9+MEXMZAyO8Va2Y1vNZvnSCvTJtHDKN+u/N8F&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;accessKeyId&#34;</span><span class="p">:</span> <span class="s2">&#34;ASIAZQNB3KHGMG7YRUEW&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;expiration&#34;</span><span class="p">:</span> <span class="s2">&#34;Nov 29, 2018 4:31:59 AM&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;requestID&#34;</span><span class="p">:</span> <span class="s2">&#34;6b80a0b1-f35d-11e8-becc-39e7d43d4afe&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;eventID&#34;</span><span class="p">:</span> <span class="s2">&#34;457af3a9-0b1b-44ca-91e1-8f4a0f873149&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;resources&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ARN&#34;</span><span class="p">:</span> <span class="s2">&#34;arn:aws:iam::653711331788:role/ecsTaskExecutionRole&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;accountId&#34;</span><span class="p">:</span> <span class="s2">&#34;653711331788&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;AWS::IAM::Role&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;eventType&#34;</span><span class="p">:</span> <span class="s2">&#34;AwsApiCall&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;recipientAccountId&#34;</span><span class="p">:</span> <span class="s2">&#34;653711331788&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sharedEventID&#34;</span><span class="p">:</span> <span class="s2">&#34;5397e1a9-82c7-4a00-9b1c-e44cbd688aa1&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>To access logs for this region? you need to login and go to CloudTrail. If SSM is enabled, captures this activity as well. Similarly, session activity audit logs can be captured in S3 or CloudWatch logs.</p>
<blockquote>
<p>⚠️ Not any CloudTrail log entry will have a <code>resources</code> part. For example, <code>LookupEvents</code> doesn&rsquo;t.</p>
</blockquote>
<blockquote>
<p>💡 By the way, using CLI to lookup the events gets logged by CloudTrail.</p>
</blockquote>
<p>CloudTrail events that are relevant from security perspective - <a href="https://www.chrisfarris.com/post/aws-ir/">https://www.chrisfarris.com/post/aws-ir/</a>.</p>
<h3 id="-btfm">📘 BTFM</h3>
<p>Here is my bash to retrieve CT logs for a all keys in the account, filtered by API call <code>Decrypt</code>. I also have a Python version and I am working on the Jupyter book for this.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">loggroupname</span><span class="o">=</span><span class="s2">&#34;aws-controltower/CloudTrailLogs&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> keyname in <span class="k">$(</span>aws kms list-aliases --profile ProfileName <span class="p">|</span> jq -r <span class="s1">&#39;.Aliases[].AliasName&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;keyname is \e[92m</span><span class="nv">$keyname</span><span class="s2">\e[0m&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">key_arn</span><span class="o">=</span><span class="k">$(</span>aws kms describe-key --key-id <span class="nv">$keyname</span> --profile ProfileName <span class="p">|</span> jq -r <span class="s1">&#39;.KeyMetadata.Arn&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Key ARN is </span><span class="nv">$key_arn</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">query_id</span><span class="o">=</span><span class="k">$(</span>aws logs --profile ProfileName start-query --log-group-name <span class="nv">$loggroupname</span> --start-time <span class="m">1655588640</span> --end-time <span class="m">1659109342</span> --query-string <span class="s2">&#34;FIELD eventTime, userIdentity.userName, sourceIPAddress | SORT eventTime DESC | FILTER eventName = &#39;Decrypt&#39; AND resources.0.ARN = &#39;</span><span class="nv">$key_arn</span><span class="s2">&#39;&#34;</span> <span class="p">|</span> jq -r <span class="s1">&#39;.queryId&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    sleep <span class="m">60</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;\e[96m</span><span class="k">$(</span>aws logs --profile ProfileName get-query-results --query-id <span class="nv">$query_id</span><span class="k">)</span><span class="s2">\e[0m&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></div><p>If you receive something like the following snippet for all the keys and you suspect some of them were used at least once during the timespan, try another log group. In my case, the log group that produced such results was disabled (checked in AWS GUI Management Console).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;results&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;statistics&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;recordsMatched&#34;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;recordsScanned&#34;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;bytesScanned&#34;</span><span class="p">:</span> <span class="mf">0.0</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;Complete&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Another useful command to see view these events with <code>fzf</code> timestamps:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">aws logs get-query-results --profile ProfileName --query-id <span class="s2">&#34;</span><span class="nv">$query_id</span><span class="s2">&#34;</span> <span class="p">|</span> jq -c <span class="s1">&#39;.results[]&#39;</span> <span class="p">|</span> fzf --multi --cycle --reverse --preview-window<span class="o">=</span>right:80%:wrap --preview <span class="s1">&#39;echo {} | jq .&#39;</span>
</span></span></code></pre></div><p>The following examples are limited to three events. You&rsquo;ll need to remove <code>--max-results 3</code> after testing it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> aws cloudtrail lookup-events --profile ProfileName --max-results <span class="m">3</span> <span class="p">|</span> jq -c <span class="s1">&#39;.Events[]&#39;</span> <span class="p">|</span> fzf --multi --cycle --reverse --preview-window<span class="o">=</span>right:80%:wrap --preview <span class="s1">&#39;echo {} | jq .&#39;</span> <span class="c1"># --profile ProfileName is optional and is used in case of SSO auth only. </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># limit by UNIX timestamps</span>
</span></span><span class="line"><span class="cl">aws cloudtrail lookup-events --profile ProfileName --start-time <span class="m">1655535200</span> --end-time <span class="m">1655542800</span> <span class="p">|</span> jq -c <span class="s1">&#39;.Events[]&#39;</span> <span class="p">|</span> fzf --multi --cycle --reverse --preview-window<span class="o">=</span>right:80%:wrap --preview <span class="s1">&#39;echo {} | jq .&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># useful command to covert to UNIX timestamps</span>
</span></span><span class="line"><span class="cl">date -ju -f <span class="s2">&#34;%F %T&#34;</span> <span class="s2">&#34;2022-06-18 08:00:00&#34;</span> <span class="s2">&#34;+%s&#34;</span>
</span></span></code></pre></div><h2 id="vpc-flow-logs">VPC Flow Logs</h2>
<p>If these are enabled, you will be able to tell, who connected to what resource and when. Flow Logs are not enabled by default. It&rsquo;s not the same as pcap file! It doesn&rsquo;t provide full packet info. Just statistics, addresses, ports, result (accept/reject).</p>
<p>Logs are sent then either to the CloudWatch or S3 (depending on the configuration). An IAM role needs to be created prior to that. Here are the minimum requirements for the CloudWatch role: CreateLogGroup, CreateLogStream, PutLogEvents, DescribeLogGroups, DescribeLogStreams need to beallowed for all resources. To be able to assume this role, VPC Flow Logs service needs to have its own policy where <code>&quot;service&quot;:&quot;vpc-flow-logs.amazonaws.com&quot;</code> is set to allow <code>AssumeRole</code> action. See <a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs-cwl.html">here</a> for more details.</p>
<p>Log <a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html#flow-log-records">breakthrough</a>. Looks like a simple string with a space as a delimiter. Each field has its place within the string.</p>
<p>Traffic logs between VPCs withing the same org/acc.</p>
<p>If these are enabled, you will be able to tell, who connected to what resource and when. Flow Logs are not enabled by default. AWS states that loggin rejected traffic is sufficient for bad actor detection. The recommended log retention period is 1 year. However, these logs can be archived and stored elsewhere where it&rsquo;s cheaper.</p>
<p>It&rsquo;s not the same as pcap file! It doesn&rsquo;t provide full packet info. Just statistics, addresses, ports, result (accept/reject).</p>
<p>Logs are sent then either to the CloudWatch or S3 (depending on the configuration). Min delay between the capture and its copying to the above mentioned services is 1-6 minutes.</p>
<blockquote>
<p>📝 <a href="https://docs.aws.amazon.com/whitepapers/latest/aws-security-incident-response-guide/logging-and-events.html">https://docs.aws.amazon.com/whitepapers/latest/aws-security-incident-response-guide/logging-and-events.html</a></p>
</blockquote>
<h3 id="-btfm-1">📘 BTFM</h3>
<p>Retrieve the logs:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">aws ec2 describe-flow-logs <span class="c1"># append --profile for SSO or make sure you have the correct creds in ~/.aws/config</span>
</span></span><span class="line"><span class="cl">aws logs filter-log-events --log-group-name &lt;groupname&gt;  <span class="c1"># append --profile for SSO or make sure you have the correct creds in ~/.aws/config</span>
</span></span></code></pre></div><p>Filter the logs - <a href="https://docs.aws.amazon.com/cli/latest/reference/logs/filter-log-events.html">docs</a>.</p>
<h2 id="resource-timeline">Resource Timeline</h2>
<p>In AWS go to Config → Resources → &lt;<code>resource name&gt;</code> → Resource Timeline (in the upper right corner). Shows all the changed made to the resource (created, configuration changed, resource deleted).</p>
<h2 id="iam-activity">IAM Activity</h2>
<p>Two places to look at it.</p>
<ul>
<li>Credentials report</li>
<li></li>
</ul>
<h3 id="iamhomecredential_report">iam/home#/credential_report</h3>
<p>Contains the following fields:</p>
<ol>
<li>user</li>
<li>arn</li>
<li>user_creation_time</li>
<li>password_enabled</li>
<li>password_last_used</li>
<li>password_last_changed</li>
<li>password_next_rotation</li>
<li>mfa_active</li>
<li>access_key_1_active</li>
<li>access_key_1_last_rotated</li>
<li>access_key_1_last_used_date</li>
<li>access_key_1_last_used_region</li>
<li>access_key_1_last_used_service</li>
<li>access_key_2_active</li>
<li>access_key_2_last_rotated</li>
<li>access_key_2_last_used_date</li>
<li>access_key_2_last_used_region</li>
<li>access_key_2_last_used_service</li>
<li>cert_1_active</li>
<li>cert_1_last_rotated</li>
<li>cert_2_active</li>
<li>cert_2_last_rotated</li>
</ol>
<h3 id="access-advisor">Access Advisor</h3>
<p>Go to IAM -&gt; username -&gt; Access Advisor. Not every user might (and should) have access to this one. Access Advisor shows the services that this user can access and when those services were last accessed.</p>
<h2 id="vpc-traffic-mirroring">VPC Traffic Mirroring</h2>
<p>A great idea to use. Deploying an EC2 with some IDS, mirror traffic there for detection. Filter for the most relevant stuff to pass it to SIEM?</p>
<h2 id="vpn">VPN</h2>
<p>If the organization uses a VPN in order to connect, an investigator will need the VPN logs as well (IPsec or OpenVPN).</p>
<h2 id="logs-archieved-in-s3">Logs Archieved In S3</h2>
<p>CloudTrail logs are not available forever. If the company backs up all events as they come and sends them to a S3 bucket. How to query them? To search for a particular string within the logs. For example, by event_id or username.</p>
<p>Bash script below will look through the files recursively and run <code>grep</code> against each. This is very time consuming, so you&rsquo;d better narrow down the search and choose the keyword wisely.</p>
<blockquote>
<p>⚠️ Make sure you’ve logged in the Log Archive first and you have set up the profile for SSO in <code>~/.aws/config</code>.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">keyword</span><span class="o">=</span><span class="s2">&#34;bucket-name&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> file in <span class="k">$(</span>aws s3 ls --profile ProfileName --recursive <span class="s2">&#34;s3://bucket-name/path/to/CloudTrail/logs/&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span> 
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">echo</span> <span class="nv">$file</span> <span class="p">|</span> grep -q <span class="s2">&#34;unique string&#34;</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;========================================&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Looking for keywords in the file \e[36m</span><span class="nv">$file</span><span class="s2">...\e[0m&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">result</span><span class="o">=</span><span class="k">$(</span>aws s3 cp <span class="s2">&#34;s3://bucket-name/</span><span class="nv">$file</span><span class="s2">&#34;</span> --profile ProfileName - <span class="p">|</span> gzip -d - <span class="k">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">echo</span> <span class="nv">$result</span> <span class="p">|</span> grep -q <span class="nv">$keyword</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="nv">$result</span> <span class="p">|</span> jq -C .
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="nv">$result</span> <span class="p">|</span> jq -C . &gt;&gt; result.txt
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;========================================&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></div><p><code>$(aws s3 ls --profile ProfileName --recursive &quot;s3://bucket-name/path/to/CloudTrail/logs/&quot;)</code> will return a table: time - bytes - path (each on a separate line). So, when iterating through the files in S3 buckets, you&rsquo;ll get time after the first iteration, size in bytes after the second one and the last iteration will get you the path itself. For the script to work, we need path only, that&rsquo;s why I added this line if <code>echo $file | grep -q &quot;bucket-name&quot;; then. This command aws s3 cp &quot;s3://bucket-name/$file&quot; --profile Backup - | gzip -d -</code>  will copy the contents of the file to the stdout (<code>-</code>) and pipe to <code>gzip</code> (since log files are usually compressed) and send to stdout again (<code>-</code>). If the file has the <code>$keyword</code> (<code>if echo $result | grep -q $keyword; then</code>) I run<code> jq -C .</code> (coloured <code>jq</code> output) and also save the result in a text file (append).</p>
<h2 id="cloudwatch">CloudWatch</h2>
<p>Similarly, session activity audit logs can be captured in S3 or CloudWatch logs.</p>
<h2 id="sqs">SQS</h2>
<p>This can be used for various things but one of the usages could be a log buffer.</p>
<h3 id="-btfm-2">📘 BTFM</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">aws sqs list-queues  --profile ProfileName
</span></span><span class="line"><span class="cl">aws sqs send-message --queue-url &lt;value&gt; --message-body &lt;value&gt;
</span></span><span class="line"><span class="cl">aws sqs receive-message --queue-url &lt;value&gt;
</span></span></code></pre></div><blockquote>
<p>🧪 I would like to see if messages will disappear from the queue once <code>receive-message</code> was invoked.</p>
</blockquote>
<h2 id="references">References</h2>
<p>[<a href="https://www.chrisfarris.com/post/aws-ir/">1</a>] IR in AWS</p>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
