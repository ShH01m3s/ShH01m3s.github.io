<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Case 4. SANS Mock Case - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.957e71ad2cb873132802e19798d6ca577b82e708fa80d1e90b00bc9e23855023.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-forensics üîç and incident response ü•∑">
      <a href="/docs/dfir">
        <span>Forensics üîç and Incident Response ü•∑</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting">
      <a href="/docs/thunting">
        <span>Threat Hunting</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-forensics üîç and incident response ü•∑">
      <a href="/docs/dfir">
        <span>Forensics üîç and Incident Response ü•∑</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting">
      <a href="/docs/thunting">
        <span>Threat Hunting</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/cases/ir/"> Back to IR Cases üíº Section üëàüèº </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#case-overview">Case Overview</a></li>
    <li><a href="#environment">Environment</a>
      <ul>
        <li><a href="#lab-config">Lab Config</a></li>
      </ul>
    </li>
    <li><a href="#layout">Layout</a></li>
    <li><a href="#lessons-learned">Lessons Learned</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
 </div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Case 4. SANS Mock Case</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
          <a class="category-link" href="/domain/ir">ir</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
          <a class="platform-link" href="/doctype/case-study">case study</a>
          
      </div> <br /><br/>
      
      
      
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <h2 id="case-overview">Case Overview</h2>
<p><em>Arya Stark gets an email presumably from Direwolf with an attachment. It looks suspicious and she forwards it to the Security.</em></p>
<h2 id="environment">Environment</h2>
<p><strong>Winterfell Server Network</strong> (<code>192.168.10.0/24</code>) consisting of DNS (<code>192.168.10.230</code>) Centos7 with <code>bind</code> <code>ns1.winterfell.local</code> and Mail server (<code>192.168.10.140</code>) <code>mail.winterfell.local</code>, Centos7 with Postfix and Dovecot.</p>
<p><strong>Winterfell Desktop Network</strong> (<code>192.168.11.0/24</code>), having IPs: <code>192.168.11.101</code>, <code>192.168.11.102</code>, <code>192.168.11.103</code>, <code>192.168.11.104</code>, <code>192.168.11.105</code>. <code>192.168.11.105</code> is Security&rsquo;s IP. All desktops have Win7 SP1 with MOffice 2010 installed. For the machine to be vulnerable for the below attack steps, Windows Firewall should be disabled and macro turned on for Office Docs (Trust Center &gt; Trust Center Settings &gt; Macro Settings). Also, PsExec requires the DWORD called LocalAccountTokenFilterPolicy in the registry under</p>
<p>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\ System set to a value of 1.</p>
<p><strong>External (attacker&rsquo;s) Network</strong> (<code>192.168.239.0/24</code>), consisting of Attacker casterlyrock <code>192.168.239.130</code> and attacker <code>192.168.239.110</code>.</p>
<p>It&rsquo;s impossible to connect to <strong>Winterfell Desktop Network</strong> (<code>192.168.11.0/24</code>) from external network (<code>192.168.239.0/24</code>). Only <strong>Winterfell Server Network</strong> (<code>192.168.10.0/24</code>) is allowed. However, <strong>Winterfell Desktop Network</strong> (<code>192.168.11.0/24</code>) can talk to the outside world.</p>
<p>Firewall is placed between <strong>External (attacker&rsquo;s) Network</strong> (<code>192.168.239.0/24</code>) and <strong>Winterfell subnets.</strong> It runs Centos7 as well. Uses iptables as a firewall.</p>
<h3 id="lab-config">Lab Config</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">capinfos dedup.pcap <span class="c1"># get the summary and statistics of a pcap file</span>
</span></span><span class="line"><span class="cl">nfpcapd -r dedup.pcap -l /var/log/netflow <span class="c1"># populate Netflow (nfdump/nfpcapd) from pcap</span>
</span></span><span class="line"><span class="cl">snort -c /etc/snort/snort.conf -q -k none -l /var/log/snort -r dedup.pcap <span class="c1"># populate snort from pcap</span>
</span></span><span class="line"><span class="cl">passivedns -r dedup.pcap -d <span class="s1">&#39;|&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># convert from UNIX timestamps</span>
</span></span><span class="line"><span class="cl">cat passivedns.log <span class="p">|</span> awk -F<span class="s1">&#39;|&#39;</span> <span class="s1">&#39;{OFS=&#34;|&#34;;printf(&#34;%s&#34;,strftime(&#34;%Y-%m-%d_%H:%M:%S&#34;,$1));$1=&#34;&#34;;printf $0}&#39;</span> &gt; passivedns-ts.log
</span></span></code></pre></div><p>VMWare Workstation. mergecap to merge separate files.</p>
<h2 id="layout">Layout</h2>
<p><strong>Detection &amp; Analysis</strong></p>
<p>We open the letter and see <code>docm</code> extension which indicates Word2007+ (implying Word file with macro) while it the letter itself it&rsquo;s claimed to be a picture.  We calculate the attachment&rsquo;s hash <code>md5sum Ghost.docm</code> and  the message&rsquo;s hash as well <code>md5sum 'Picture of Ghost (52.2 Kb).msg'</code>. And make two copies of each. Running <code>file Ghost.docm</code> confirms that the file is a Word document. Running <code>exiftool Ghost.docm</code> to see the creator, the type and some other relevant meta data.</p>
<p>Get the macro from the file with <code>OfficeMalScanner</code>, by first running <code>inflate</code> and then <code>info</code>. Usage example was described by me <a href="https://bakerst221b.com/docs/blog/2018/07/undesirable-mail/">here</a>. Calculate the <code>md5sum vbaProject.bin</code> and make a copy as well (two copies, better).</p>
<p>So, we have the following: the file is claimed to be a picture but it&rsquo;s actually a macro-enabled Word document. The sender and the creator of the document do not match. The event now becomes an incident and requires further investigation.</p>
<p>Both the message and the attachment are detected as malicious by VirusTotal (is it okay to use this service for such cases?).</p>
<p><strong>Containment Phase</strong></p>
<p>We need to know, who else got this message. We open the network capture and filter SMTP containing &ldquo;Picture of Ghost&rdquo; and associated with astark: <code>smtp contains &quot;Picture of Ghost&quot; and smtp contains &quot;astark&quot;</code>. We see 5 emails sent. Use follow TCP stream on this packet. Looks like there were no replaying.</p>
<p><em>How to determine that the email was not relayed? Email headers? Which ones?</em></p>
<p>We now have an IP - <code>192.168.239.130</code>. The mail client is identified as sendEmail-1.56 (<code>X-Mailer</code> header). Hostname of the originated PC is <code>casterlyrock.westeros.local</code>. Other three emails have the same characteristics and therefore are most likely related. <code>Message-ID</code> uniquely identifies the emails and using this information we can delete them from postfix to avoid further damage. Four PCs that are presumably compromised. We can see whether anyone communicated with these addresses:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nfdump -R /var/log/netflow -q -O tstart -A srcip,dstip -o <span class="s1">&#39;fmt:%ts %sa %da %byt %fl&#39;</span> <span class="s1">&#39;ip 192.168.239.130&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;BEGIN{printf &#34;%23s %16s %15s %8s %5s\\n&#34;, &#34;Start time&#34;, &#34;Source&#34;, &#34;Dest&#34;, &#34;Bytes&#34;, &#34;Flows&#34;};{print};&#39;</span>
</span></span></code></pre></div><p>We see that at 14:05 there was a request to DNS and then shortly after to the mail server. Then we see lots of requests between <code>192.168.11.104</code> starting from 15:33 and then <code>192.168.11.101</code> starting from 16:17. Looks like they&rsquo;ve opened these attachments&hellip; . Let&rsquo;s examine <code>192.168.11.104</code>&rsquo;s possible compromise.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nfdump -R /var/log/netflow -q -b -O tstart -o <span class="s1">&#39;fmt:%ts %sap %dap %pkt %byt %fl&#39;</span> <span class="s1">&#39;ip 192.168.239.130 and ip 192.168.11.104&#39;</span> <span class="p">|</span> cut -c 12-19,25- <span class="p">|</span> awk <span class="s1">&#39;BEGIN{printf &#34;%8s %21s %21s %8s %8s %5s\\n&#34;, &#34;Start&#34;, &#34;Source&#34;, &#34;Dest&#34;, &#34;Packets&#34;, &#34;Bytes&#34;, &#34;Flows&#34;};{print};&#39;</span>
</span></span></code></pre></div><p>We see three conversations between <code>192.168.239.130</code> and <code>192.168.11.104</code>.</p>
<p>The first conversation can be filtered by:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nfdump -R /var/log/netflow -q -O tstart -A srcip,dstip -o <span class="s1">&#39;fmt:%ts %sa %da %byt %fl&#39;</span> <span class="s1">&#39;ip 192.168.239.130 and ip 192.168.11.104&#39;</span> <span class="p">|</span> cut -c 12-19,25- <span class="p">|</span> awk <span class="s1">&#39;BEGIN{printf &#34;%23s %16s %15s %8s %5s\\n&#34;, &#34;Start time&#34;, &#34;Source&#34;, &#34;Dest&#34;, &#34;Bytes&#34;, &#34;Flows&#34;};{print};&#39;</span>
</span></span></code></pre></div><p>Seems like the client has initiated this connection, <code>GET</code>ing a large <code>MZPE</code> (<code>.exe</code>) file. We save the <code>exe</code> as RAW, calculate the hash (<code>md5sum</code>) and make a copy. Identified as Meterpreter by VT. Since the client initiated the traffic, it is some reverse shell. Given that HTTP traffic was used, it&rsquo;s probably <code>/windows/meterpreter/reverse_http</code> payload. We now have enough information to pass forward to forensics.</p>
<p>Let&rsquo;s examine the second conversation.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nfdump -R /var/log/netflow -q -O tstart -o <span class="s1">&#39;fmt:%ts %sap %dap %pkt %byt %fl&#39;</span> <span class="s1">&#39;ip 192.168.239.130 and ip 192.168.11.104 and port 49161&#39;</span> <span class="p">|</span> cut -c 12-19,25- <span class="p">|</span> awk <span class="s1">&#39;BEGIN{printf &#34;%8s %21s %21s %8s %8s %5s\\n&#34;, &#34;Start&#34;, &#34;Source&#34;, &#34;Dest&#34;, &#34;Packets&#34;, &#34;Bytes&#34;, &#34;Flows&#34;};{print};&#39;</span>
</span></span></code></pre></div><p>We see that after this large file download (first conversation), there are lots of small packets sent every 5 seconds. This is usually an indication of a C&amp;C traffic. The traffic is encrypted (<code>/windows/meterpreter/reverse_http</code> encrypts the traffic).</p>
<p>The third conversation is when the two parties have switched to <code>8080</code> port.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nfdump -R /var/log/netflow -q -O tstart -o <span class="s1">&#39;fmt:%ts %sap %dap %pkt %byt %fl&#39;</span> <span class="s1">&#39;ip 192.168.239.130 and ip 192.168.11.104 and port 49162&#39;</span> <span class="p">|</span> cut -c 12-19,25- <span class="p">|</span> awk <span class="s1">&#39;BEGIN{printf &#34;%8s %21s %21s %8s %8s %5s\\n&#34;, &#34;Start&#34;, &#34;Source&#34;, &#34;Dest&#34;, &#34;Packets&#34;, &#34;Bytes&#34;, &#34;Flows&#34;};{print};&#39;</span>
</span></span></code></pre></div><p>The victim initiated this conversation. After 3-way handshake there is a payload <code>0x2f9e0e00</code>. Then there is a large amount of data transferred from the attacker. Analysis reveal that&rsquo;s another <code>exe</code>. We again extract this file, get the hash and copy the file. To convert to binary: <code>cat ex-02-hex.txt | xxd -r -p &gt; ex-02</code>. Identified as meterpreter by VT. Probably <code>windows/meterpreter/reverse_tcp</code> payload. <code>0x2f9e0e00</code>at the beginning is the indication of meterpreter <code>reverse_tcp</code>. Since the traffic is encrypted, we would need a forensics examination to decrypt it.</p>
<p>Has this system communicated with other fellow systems trying to compromise them?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nfdump -R /var/log/netflow -q -O tstart -A srcip,dstip -o <span class="s1">&#39;fmt:%ts %sa %da %byt %fl&#39;</span> <span class="s1">&#39;ip 192.168.11.104&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;BEGIN{ printf &#34;%23s %16s %15s %8s %5s\\n&#34;, &#34;Start time&#34;, &#34;Source&#34;, &#34;Dest&#34;, &#34;Bytes&#34;, &#34;Flows&#34;};{print};&#39;</span>
</span></span></code></pre></div><p>Examine the traffic with the mail server (<code>192.168.10.140</code>) <code>mail.winterfell.local</code> in Wireshark. We see that this traffic used port <code>995</code>. POP3 protocol uses this port to deliver mail to Outlook clients. The traffic is encrypted. This communication happened less than a minute before the connection over <code>80</code> port above.</p>
<p>It would be a sin not to turn to our DNS logs. Who knows what else we might find out. But there are no logs that would indicate that <code>192.168.11.104</code> performed DNS lookups of any sort. How likely is that? Possible reasons:</p>
<ul>
<li>the host performed no queries</li>
<li>the host had the desired DNS name in its cache</li>
<li>errors not processed by PassiveDNS (since there <em>are</em> some DNS lookups in Wireshark records). SANS states the possible reason for the errors:</li>
</ul>
<p>The processing error could be due to the Wireshark capturing the packets prior to the NIC, so they did not have the necessary padding, and thus were not recognised by PassiveDNS as valid DNS packets.</p>
<p>Since DNS logs are useless in this case, let&rsquo;s see the conversations with the DNS server in Wireshark: <code>ip.addr == 192.168.10.140 and ip.addr == 192.168.11.104</code>. Filter out all irrelevant traffic: <code>ip.addr == 192.168.11.104 and udp.port == 53 !dns contains &quot;update&quot; and !dns contains &quot;msn&quot;</code>.</p>
<p>Timeline:</p>
<p>15:33:06 - <code>192.168.11.104</code> queries <code>mail.winterfell.local</code>.</p>
<p>15:33:56 - <code>192.168.11.104</code> queries <code>ironislands.westeros.local</code>(attacker&rsquo;s server, ip <code>192.168.239.130</code>). This query took place right before the conversation was started with the attacker. This is a IoC that could be used to find other compromised systems.</p>
<p>16:03:56 - scanning of <code>192.168.11.101</code></p>
<p>16:12:02 - scanning of <code>192.168.11.102</code></p>
<p>16:12:33 - scanning of <code>192.168.11.103</code></p>
<p>16:17:38 - <code>192.168.11.104</code> started talking to <code>192.168.11.101</code> over 445 TCP.</p>
<p>16:17 - data sent from <code>192.168.11.104</code> to the attacker.</p>
<p>Then we also observe that <code>192.168.11.104</code> communicated extensively with <code>192.168.11.101</code>, <code>192.168.11.102</code>, and <code>192.168.11.103</code>, which is not usual for this network. It&rsquo;s a huuuge number of flows, scanning?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nfdump -R /var/log/netflow -q -O tstart -b -c <span class="m">8</span> -o <span class="s1">&#39;fmt:%ts %sap %dap %byt %flg&#39;</span> <span class="s1">&#39;ip 192.168.11.104 and ip 192.168.11.101 and | cut -c 12- | awk &#39;</span>BEGIN<span class="o">{</span> <span class="nb">printf</span> <span class="s2">&#34;%12s %22s %18s &#34;</span>Source<span class="s2">&#34;, &#34;</span>Dest<span class="s2">&#34;, &#34;</span>Bytes<span class="s2">&#34;, &#34;</span>flags<span class="s2">&#34;};{print};&#39; flags S and not flags AFRPU&#39; %11s %5s\\n&#34;</span>, <span class="s2">&#34;Start time&#34;</span>,
</span></span></code></pre></div><p>Checking for scanning indicators above. Yes, <code>SYN</code> scan. No other traffic was seen (good sign? ü™ß)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nfdump -R /var/log/netflow -q -O tstart -b -c <span class="m">10</span> -o <span class="s1">&#39;fmt:%ts %sap %dap %byt %flg&#39;</span> <span class="s1">&#39;ip 192.168.11.104 and ip 192.168.11.101 and flags SA&#39;</span> <span class="p">|</span> cut -c 12- <span class="p">|</span> awk <span class="s1">&#39;BEGIN{ printf &#34;%12s %22s %18s %11s %5s\\n&#34;, &#34;Start time&#34;, &#34;Source&#34;, &#34;Dest&#34;, &#34;Bytes&#34;, &#34;flags&#34;};{print};&#39;</span>
</span></span></code></pre></div><p><code>192.168.11.104</code> started talking to <code>192.168.11.101</code> over 445 TCP. This traffic is unusual in that we are not expecting SMB traffic between desktops. We see 5 flows to different ports associated with SMB protocol: 135 (ASF), 139 (ASF), 445 (ARSF), 3389 (ARSF) and 445 again (APRSF). The first 4 look like a scan and the last one - some real activity. Looks like the attacker probed all possible ports for SMB and 445 returned that the port was open. And now sends something over this port. To examine this particular flow closer:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nfdump -R /var/log/netflow -q -O tstart -b -o <span class="s1">&#39;fmt:%ts %te %sap %dap %byt&#39;</span> <span class="s1">&#39;ip 192.168.11.104 and ip 192.168.11.101 and port 53613&#39;</span> <span class="p">|</span> cut -c 12-19,24,35- 42,47- <span class="p">|</span> awk <span class="s1">&#39;BEGIN{ printf &#34;%8s %8s %21s %21s %10s\\n&#34;, &#34;Start&#34;, &#34;End&#34;, &#34;Source&#34;, &#34;Dest&#34;, &#34;Bytes&#34;};{print};&#39;</span>
</span></span></code></pre></div><p>3691 bytes were sent from <code>192.168.11.101:445</code> to <code>192.168.11.104:53613</code>. The attacker acting from the <code>104</code> PC (Sansa) used the account of John Snow (<code>jsnow</code>) for this communication. Hence, this account is compromised. Looks like a file <code>\\svcctl</code> was created and run:</p>
<p><img src="dfir/cases/ir/case4/images/1.png" alt="1"></p>
<p>For whatever reason, <code>Wireshark‚Äôs File &gt; Export Objects &gt;SMB</code> was unable to extract that file (pipe with zero bytes). Let&rsquo;s see the DNS logs for our IoC for this PC to see, how his password could get compromised. We see <code>ironislands.westeros.local</code> lookup originating from <code>192.168.11.101</code> (<code>grep '192.168.11.101' passivedns-ts.log</code>), but no mail lookup. Hence, the compromise flow was different and didn&rsquo;t involve the email we started with.</p>
<p>Since we know that the attacker is at <code>192.168.239.130</code> and John on <code>192.168.11.101</code>, let&rsquo;s filter the pcap accordingly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nfdump -R /var/log/netflow -q -O tstart -b -o <span class="s1">&#39;fmt:%ts %sap %dap %byt %fl&#39;</span> <span class="s1">&#39;ip 192.168.239.130 and ip 192.168.11.101&#39;</span> <span class="p">|</span> cut -c 12- <span class="p">|</span> awk <span class="s1">&#39;BEGIN{ printf &#34;%12s %22s %20s %9s %5s\\n&#34;, &#34;Start time&#34;, &#34;Source&#34;, &#34;Dest&#34;, &#34;Bytes&#34;, &#34;Flows&#34;};{print};&#39;</span>
</span></span></code></pre></div><p>We see two conversations: from <code>4444</code> port and from <code>8082</code>. In Wireshark both <code>4444</code> and <code>8082</code> traffic look like it was probably a download. Once agains it was an <code>exe</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat exe-03.txt <span class="p">|</span> xxd -r -p &gt; ex-03
</span></span><span class="line"><span class="cl">md5sum ex-03
</span></span><span class="line"><span class="cl">518afbf3bb3ccdf41b3523a743a16239 ex-03
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat exe-04-hex.txt <span class="p">|</span> xxd -r -p &gt; ex-04 
</span></span><span class="line"><span class="cl">md5sum ex-04 
</span></span><span class="line"><span class="cl">b8e9c33c0492be88d4ba4631c45956d1 ex-04
</span></span></code></pre></div><p>Make two copies and check against VT, the file identified as a Meterpreter. It&rsquo;s probably a <code>windows/meterpreter/reverse_tcp</code> payload since:</p>
<ul>
<li>victim initiated the network traffic,</li>
<li>traffic is TCP, and</li>
<li>four-byte packet after the three-way TCP handshake is a characteristic of Metasploit‚Äôs Meterpreter <code>reverse_tcp</code> payload.</li>
</ul>
<h2 id="lessons-learned">Lessons Learned</h2>
<h2 id="references">References</h2>
<p>[<a href="https://www.coursera.org/learn/ibm-cybersecurity-breach-case-studies/lecture/FcTgw/phishing-case-study-google-facebook">1</a>] IBM course</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
