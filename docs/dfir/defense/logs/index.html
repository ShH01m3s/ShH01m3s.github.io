<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Logs - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ğŸª¤">
      <a href="/docs/thunting">
        <span>Threat Hunting ğŸª¤</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference ğŸ“š">
      <a href="/docs/reference">
        <span>Tech Reference ğŸ“š</span>
      </a>
    </li>
    
    <li class="menu-item-notes ğŸ“">
      <a href="/docs/notes">
        <span>Notes ğŸ“</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ğŸª¤">
      <a href="/docs/thunting">
        <span>Threat Hunting ğŸª¤</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference ğŸ“š">
      <a href="/docs/reference">
        <span>Tech Reference ğŸ“š</span>
      </a>
    </li>
    
    <li class="menu-item-notes ğŸ“">
      <a href="/docs/notes">
        <span>Notes ğŸ“</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/defense/"> ğŸ‘ˆğŸ¼ Back to </br> Defence Mechanisms </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#event-viewer-">Event Viewer ğŸŒˆ</a></li>
    <li><a href="#varlog-"><code>/var/log</code> ğŸ§</a></li>
    <li><a href="#excersice">Excersice</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Logs</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p><em>This is about using logs as a detection mechanism.</em></p>
<h2 id="event-viewer-">Event Viewer ğŸŒˆ</h2>
<blockquote>
<p>â“ How could an attacker delete entries from the Event Viewer and what level of access would they need?</p>
</blockquote>
<p>To configure what&rsquo;s being logged and what&rsquo;s ignored, set up the appropriate policies here -<code>secpol.msc</code>. Config example:</p>
<ol>
<li>Audit account logon events - success + failure</li>
<li>Audit account management - success + failure</li>
<li>Audit logon events - success + failure</li>
<li>Audit object accesss - failure (too many successes will be generated)</li>
<li>Audit privileged use - success + failure</li>
<li>Audir system events - success + failure</li>
</ol>
<p>This might chew up lots of disk space, so be careful. I might try this configs to look for network events, I could not see before.</p>
<h2 id="varlog-"><code>/var/log</code> ğŸ§</h2>
<p><code>/etc/rsyslog.conf</code> - see the log owners, what specific logs are logging and where the additional configurations are stored.</p>
<p><code>cd rsyslog.d &amp;&amp; less 50-default.conf</code> - to see additional configurations: what specific logs are logging, how they are called and where to find them.</p>
<p><code>sudo less syslog</code> - most of the system logs.</p>
<p><code>auth.log</code> - authorization messages</p>
<p><code>kern.log</code> - kernel messages</p>
<p>To configure what is being logged, how and when, go to <code>/etc/audit</code>. <code>apt-cache search auditd</code> (if it&rsquo;s not installed). <code>nano audit.rules</code> files to open. Config example:</p>
<ol>
<li><code>-w /etc/shadow</code> to keep track of the users added/deleted/modified. <code>w</code> - watch file:
<ol>
<li><code>-p</code> - watch for permission;</li>
<li><code>wa</code> - look for writes;</li>
<li><code>-k &lt;name&gt;</code> - give the name of this log entries.</li>
</ol>
</li>
<li><code>a always,exit</code> - look for actions:
<ol>
<li>generate alerts <code>always</code>;</li>
<li>look for specific syscall <code>-S clock_settime</code>;</li>
<li><code>-k &lt;name</code> - give the name of this log entries, for example, <code>timechange</code>.</li>
</ol>
</li>
</ol>
<p>To start auditing, run the daemon: <code>service auditd start</code>. The results are stored in <code>/etc/audit.log</code>.</p>
<h2 id="excersice">Excersice</h2>
<p>I&rsquo;ve set up my lab as vaguely described <a href="/docs/blog/2021/03/how-i-have-built-my-lab">here</a>. Then, I&rsquo;ve logged into the user <code>sherlock</code> account. Now, I want to see this even in the Event Viewer. Most probably, it&rsquo;s the Security of System logs. I have wrong time settings on the both machines, but I don&rsquo;t think it&rsquo;s a problem for now. I&rsquo;ve noticed some Logon of type 3 in the logs, but the user is not specified. I don&rsquo;t quite remember, which id the network logon type has. I think it&rsquo;s 4&hellip; .</p>
<p>No, logon type 3 is the network logon. Weird. It happens very often.</p>
<p>Since there is no SID shown, I suspect that might be a system acc.</p>
<p>Sorting took some time, and I have noticed that Logon events have these IDs: 4624, 4634, 4625, 4648. Now I am going to filter by these IDs and revert to sorting by date and time. Nothing was found. I&rsquo;ve cleared IDs, leaving just the user name. The filter returned no results as well.</p>
<p>However, I&rsquo;ve also noticed, that even though no username was specified (<code>N/A</code>), the PC name was mentioned: SHERLOCKPC$. Using this to filter the logs, resulted in null results. Tried SHERLOCKPC as well - nothing.</p>
<p>Some packet was blocked.</p>
<p>Clear log. Then try logging in several times with the wrong password. Then log in with the correct one. Observe the logs. Well, seems like <code>Logon</code> and <code>Logoff</code> events are not initiated by the user. So, the login attempts are actually <code>Kerberos Authentication Service</code>. Now it makes more sense. Let&rsquo;s filter by this event (4768 - success and 4771 - failure). After successful authentication, we have Kerberos Service Ticket Operations (4769). And now I have it!</p>
<p>I&rsquo;ve now triggered several authentication failures and one authentication success. And there it is. I have 2 events 4771 (failures) then one event 4768 (success) followed by three events 4769. Why three?</p>
<p>Every minute 4624 and 4634 events are created, meaning new session creating. It seems so that every time I do something in my user account, the events 4624 and 4634 emerge in the logs. Or just every minute.</p>
<p>Let&rsquo;s go to the user PC (sherlock) and see his logs. It says that access was denied (either the query is too long or the daemon is not running). Of course, the first thing to do was to check whether the service is really running, but it was. So, the problem was something else. Query too long? Don&rsquo;t think so, since I have not created any views so far. I tried to clear the logs, but failed. May be it&rsquo;s because the DC is shutdown, or because the user doesn&rsquo;t have the rights to do so. The only way to check that is to turn on the DC.</p>
<p>Can&rsquo;t find the event id that is associated with this activity. Thought 5152 was, but then I saw it appeared on its own.</p>
<p>However System logs had one interesting entry. But failing again has not triggered it.</p>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    Something here
</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
