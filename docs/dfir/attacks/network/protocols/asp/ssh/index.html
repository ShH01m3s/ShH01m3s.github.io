<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SSH Protocol - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ğŸª¤">
      <a href="/docs/thunting">
        <span>Threat Hunting ğŸª¤</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference ğŸ“š">
      <a href="/docs/reference">
        <span>Tech Reference ğŸ“š</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ğŸª¤">
      <a href="/docs/thunting">
        <span>Threat Hunting ğŸª¤</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference ğŸ“š">
      <a href="/docs/reference">
        <span>Tech Reference ğŸ“š</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/attacks/network/protocols/asp/"> ğŸ‘ˆğŸ¼ Back to </br> ğŸ“š Session, Presentation, Application Layer </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#mechanism">Mechanism</a>
      <ul>
        <li><a href="#negotiation">Negotiation</a></li>
        <li><a href="#--session-key-generation">ğŸ¼ ğŸ¤« Session Key Generation</a></li>
        <li><a href="#-decryption-key-generation">ğŸª› Decryption Key Generation</a></li>
        <li><a href="#establishing-the-connection">Establishing The Connection</a></li>
      </ul>
    </li>
    <li><a href="#attacks">Attacks</a></li>
    <li><a href="#improvements">Improvements</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">SSH Protocol</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 16.05.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p><em>This is about &hellip; .</em></p>
<h2 id="mechanism">Mechanism</h2>
<h3 id="negotiation">Negotiation</h3>
<p>The first step is to inform what software and SSH version are used by both the client and the server. Then, they are trying to find the key exchange and message authentication algorithm that suits them both.</p>
<p><img src="https://media.giphy.com/media/PjfhcRfryjV7buhpE7/giphy.gif" alt="img"></p>
<p>SSH header and payload sit atop the TCP header and look something like this:</p>
<p><img src="ssh-packet.png" alt="img"></p>
<blockquote>
<p>â—ï¸ All the data and the requests the were generated by the client ğŸ¥¶ are coloured in blue. Each type of request or reply (the SSH payload, to be precise) sent has its own dedicated emoji (for example, the identification string is a ğŸ“).</p>
</blockquote>
<p>Since the client ğŸ¥¶ needs the service, the client ğŸ¥¶ initiates the connection and presents his preferences for both the SSH version and the software. This is called an identification string ğŸ“.</p>
<p><img src="step-1.png" alt="img"></p>
<p>The server ğŸŒ then demonstrates it&rsquo;s &ldquo;household&rdquo; with a similar reply ğŸ“:</p>
<p><img src="step-2.png" alt="img">
Now, they need to agree on the settings: ciphers and hash algorithms. First, the client ğŸ¥¶ is coming out with the <code>Key Exchange Init</code> ğŸ message.</p>
<p><img src="step-3.png" alt="img"></p>
<p>Then the server ğŸŒ sends a similar <code>Key Exchange Init</code> ğŸ message showing its acceptable cipher suits.</p>
<p><img src="step-4.png" alt="img"></p>
<p>The server ğŸŒ typically uses the first acceptable option presented by the client. But if none is acceptable for the server ğŸŒ, the SSH connection won&rsquo;t be established.</p>
<h3 id="--session-key-generation">ğŸ¼ ğŸ¤« Session Key Generation</h3>
<p>The client ğŸ¥¶ generates two keys: a private ğŸ—ï¸ and a public ğŸ”‘ one. The algorithm used for this key generation was agreed upon in the previous stage. Often it&rsquo;s Elliptic Curve Diffie-Hellman or Diffie-Hellman. To understand how Diffie-Hellman works to exchange secret keys without actually sending them over (something like when scientists from different parts of the world come up with the same ideas).</p>
<p><img src="step-5.png" alt="img">
The client&rsquo;s ğŸ¥¶ public key ğŸ”‘ is then sent over to the server ğŸŒ and that&rsquo;s called an <code>SSH message Key Exchange Initialisation</code> ğŸ‡.</p>
<p><img src="step-6.png" alt="img">
Upon receiving the client&rsquo;s ğŸ¥¶ public key ğŸ”‘, the server ğŸŒ starts generating its own pair of asymmetrical keys.</p>
<p><img src="step-7.png" alt="img">
Here are the states of both the client ğŸ¥¶ and the server ğŸŒ at this stage.</p>
<p><img src="state-1.png" alt="img">
As you can see, the client ğŸ¥¶ has only its own private ğŸ—ï¸ and public ğŸ”‘ keys, while the server ğŸŒ has the following data:</p>
<ol>
<li>the client&rsquo;s ğŸ¥¶ DF public key ğŸ”‘;</li>
<li>the server&rsquo;s ğŸŒ DF public ğŸ”‘ and private ğŸ—ï¸ keys;</li>
<li>the server&rsquo;s ğŸŒ host asymmetrical public ğŸ”‘ and private ğŸ—ï¸ keys (these can be used, for example, with other clients or/and in SSL connections etc.). Let&rsquo;s call them global. CA (certificate authority) will store the certificate with this public ğŸ”‘ key so that the server&rsquo;s ğŸŒ clients can verify its identity. But that&rsquo;s another story.</li>
</ol>
<p>Both parties have all the information needed to generate a shared secret key ğŸ¼ ğŸ¤« and a hash ğŸ§¶. Let&rsquo;s take a little peek at the server&rsquo;s ğŸŒ activity first. The server ğŸŒ takes its private ğŸ—ï¸ and public ğŸ”‘ keys, plus the client&rsquo;s ğŸ¥¶ public key ğŸ”‘ shared previously to derive the value of the shared secret key (session key ğŸ¼ ğŸ¤«).</p>
<p><img src="step-8.png" alt="img"></p>
<p>Then the server will calculate the hash based on the following data (the list is quite long):</p>
<ol>
<li>the client&rsquo;s ğŸ¥¶ identification string ğŸ“ (the payload of the first client&rsquo;s request);</li>
<li>the server&rsquo;s ğŸŒ identification string ğŸ“ (the payload of the first server&rsquo;s reply);</li>
<li>the payload of the second client&rsquo;s ğŸ¥¶ request ğŸ;</li>
<li>the payload of the second server&rsquo;s ğŸŒ reply ğŸ;</li>
<li>the server&rsquo;s ğŸŒ global public ğŸ”‘ ğŸªª key generated long ago;</li>
<li>the client&rsquo;s ğŸ¥¶ public ğŸ”‘ key;</li>
<li>the server&rsquo;s public DF ğŸ”‘ key that was generated at the beginning;</li>
<li>the shared secret key ğŸ¼ ğŸ¤« was generated in the previous stage.</li>
</ol>
<p><img src="step-9.png" alt="img">
Now, the server ğŸŒ will sign this hash with its global private key ğŸ—ï¸ ğŸªª so that the client ğŸ¥¶ who has its global public key ğŸ”‘ ğŸªª can verify that the server sent this. No one is supposed to have the private key ğŸ—ï¸ ğŸªª of the server ğŸŒ and the corresponding public key can only decrypt the message locked by the corresponding public key ğŸ”‘ .</p>
<blockquote>
<p>â—ï¸âš”ï¸ If the private key ğŸ—ï¸ was compromised, game over.</p>
</blockquote>
<p><img src="step-10.png" alt="img"></p>
<p>Now, the server ğŸŒ sends the calculated and signed hash ğŸ§¶, its DF public key ğŸ”‘ and the global public key ğŸ”‘ğŸªª to the client ğŸ¥¶ so that the client ğŸ¥¶ can repeat the same steps.</p>
<p><img src="step-11.png" alt="img">
And so the client does. This message is called <code>SSH Message Exchange Elliptic Curve Diffie-Hellman Reply</code> ğŸ‰.</p>
<p>First, the client ğŸ¥¶ generates the same shared secret key ğŸ¼ğŸ¤«, but using its own private ğŸ—ï¸ and public ğŸ”‘ keys (not the server&rsquo;s) and the server&rsquo;s global public key ğŸ”‘ ğŸªª received in the previous step.</p>
<p><img src="step-12.png" alt="img">
Now, it&rsquo;s time to calculate the hash ğŸ§¶. Note the client ğŸ¥¶ doesn&rsquo;t yet touch the hash ğŸ§¶ sent over by the server ğŸŒ.</p>
<p><img src="step-13.png" alt="img"></p>
<blockquote>
<p>â—ï¸ âš”ï¸ Note that both the client ğŸ¥¶ and the server ğŸŒ have all this data. However, the eavesdropper won&rsquo;t have one little element: ğŸ¼ ğŸ¤«  the shared secret key. That&rsquo;s because the eavesdropper has neither the client&rsquo;s nor the server&rsquo;s private keys ğŸ—ï¸.</p>
</blockquote>
<p>But now, the client ğŸ¥¶ will use the server&rsquo;s ğŸŒ public key ğŸ”‘ ğŸªª to unlock the hash ğŸ§¶ sent over by the server ğŸŒ. After that, the client ğŸ¥¶ will compare this hash ğŸ§¶ to the one the client ğŸ¥¶ has just calculated.</p>
<p><img src="step-15.png" alt="img"></p>
<blockquote>
<p>â—ï¸ By the way, note that the client ğŸ¥¶ doesn&rsquo;t have nor it needs a client certificate ğŸ¥¶ ğŸªª.</p>
</blockquote>
<h3 id="-decryption-key-generation">ğŸª› Decryption Key Generation</h3>
<p>Now, at this point, both the client and the server have the session key (shared secret one), and can proceed to the next stage. At this stage, they both will derive three values from this session key:</p>
<ol>
<li>ğŸª› Decryption key that will be used to encrypt and decrypt the messages.</li>
<li>ğŸ”§ IV (initialisation vector) - a random value generated separately by the client and the server to randomise the ciphertext.</li>
<li>ğŸ”© A key for HMAC (signing the messages exchange to spot tampering).</li>
</ol>
<blockquote>
<p>â—ï¸Note that ğŸ¥¶ğŸª› = ğŸŒğŸª›, ğŸ¥¶ğŸ”© = ğŸŒğŸ”©, but the IVs are random and thus different. IV is not a private value! I have tried to show this by using blue colors for client specific data, yellow - for server&rsquo;s specific data, and purple - for separately generated data that&rsquo;s the same for both parties.</p>
</blockquote>
<p><img src="step-16.png" alt="img"></p>
<h3 id="establishing-the-connection">Establishing The Connection</h3>
<p>Now, the server informs the client ğŸ¥¶ that it has finished and sends a <code>New Keys</code> ğŸ‘ message over.</p>
<p><img src="step-17.png" alt="img">
The client ğŸ¥¶ then responds with a similar message ğŸ‘, also <code>New Keys</code>.</p>
<p><img src="step-18.png" alt="img"></p>
<p>It took so long to establish this connection that the server ğŸŒ and the client ğŸ¥¶ might have forgotten already what this was all about&hellip; . Ah, right, the service request!</p>
<p>The client sends a <code>service request</code> ğŸ¥ message to the server.</p>
<p><img src="step-19.png" alt="img"></p>
<p>All is good, no point to back off at this stage, so the server ğŸŒ presents the lucky winner with a <code>flag.txt</code> ğŸ‡¦ğŸ‡º.</p>
<p><img src="step-20.png" alt="img"></p>
<h2 id="attacks">Attacks</h2>
<h2 id="improvements">Improvements</h2>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    <a href="https://www.youtube.com/watch?v=0Sffl7YO0aY">https://www.youtube.com/watch?v=0Sffl7YO0aY</a>
</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
