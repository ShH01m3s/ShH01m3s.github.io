<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📚 DHCP - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting 🪤">
      <a href="/docs/thunting">
        <span>Threat Hunting 🪤</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting 🪤">
      <a href="/docs/thunting">
        <span>Threat Hunting 🪤</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/attacks/protocols/asp/"> 👈🏼 Back to </br> 📚 Session, Presentation, Application Layer </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#mechanism">Mechanism</a>
      <ul>
        <li><a href="#dhcp-discover-broadcast-c--s">DHCP Discover (Broadcast) C-&gt; S</a></li>
        <li><a href="#dhcp-offer-broadcastunicat-s---c">DHCP Offer (Broadcast/Unicat) S -&gt; C</a></li>
        <li><a href="#dhcp-request-broadcast-c---s">DHCP Request (Broadcast) C -&gt; S</a></li>
        <li><a href="#dhcp-ack-broadcastunicat-s---c">DHCP Ack (Broadcast/Unicat) S -&gt; C</a></li>
      </ul>
    </li>
    <li><a href="#-btfm">📘 BTFM</a></li>
    <li><a href="#dhcp-starvation">DHCP starvation</a>
      <ul>
        <li><a href="#dhcp-snooping">DHCP Snooping</a></li>
      </ul>
    </li>
    <li><a href="#tools">Tools</a></li>
    <li><a href="#reference">Reference</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">📚 DHCP</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 18.11.2020
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p><strong>D</strong>ynamic <strong>H</strong>ost <strong>C</strong>onfiguration <strong>P</strong>rotocol. Listening on 67 port. Sending from 68.</p>
<h2 id="mechanism">Mechanism</h2>
<h3 id="dhcp-discover-broadcast-c--s">DHCP Discover (Broadcast) C-&gt; S</h3>
<p>[new PC] 🧸 <em>&ldquo;I need an IP, I am new here. Only have this stupid useless 169.254.X.X address. Where do I register? Guys! Who knows where the DHCP is?&rdquo;</em></p>
<p><code>DHCPDISCOVER</code> is broadcasted in the network. Every machine, even non-DHCP once, hear this message.</p>
<h3 id="dhcp-offer-broadcastunicat-s---c">DHCP Offer (Broadcast/Unicat) S -&gt; C</h3>
<p>[DHCP server] 🥸 <em>&ldquo;I&rsquo;m DHCP. How can I help?&rdquo;</em></p>
<p>DHCP server sends a DHCPOFFER to the [new PC] offering its help.</p>
<h3 id="dhcp-request-broadcast-c---s">DHCP Request (Broadcast) C -&gt; S</h3>
<p>[new PC] 🧸  <em>&ldquo;I want an IP!&rdquo;</em></p>
<p>PC in question responds with a DHCPREQUEST packet.</p>
<h3 id="dhcp-ack-broadcastunicat-s---c">DHCP Ack (Broadcast/Unicat) S -&gt; C</h3>
<p>[DHCP server] 🥸 <em>&ldquo;Here you are. Fetch your configs also!&rdquo;</em>
DHCP sends the PC IP address with the settings in a DHCPACK packet and put this data into its registry table as well, striking through the IP already in use now.</p>
<p>Mnemonics - DORA (Discover, Offer, Request and Acknowledge)</p>
<h2 id="-btfm">📘 BTFM</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ipconfig <span class="se">\r</span>efresh <span class="c1"># Windows</span>
</span></span></code></pre></div><h2 id="dhcp-starvation">DHCP starvation</h2>
<p>Get a legitimate DHCP down, become a DHCP server for the network, config PCs with the new GW (gateway), DNS, domain, subnet mask, IP etc. Get the legitimate DHCP down and set up a rougue one. All traffic comes through the fake DHCP.
Step 1. Change local MAC address so that DHCP thinks I&rsquo;m someone else.
Step 2. Send a lot of (hunderds, thousands) DHCPREQUESTs thus delpleting the server&rsquo;s pool of available IP addresses. The overwhelmed and terrified legitimate DHCP crashes.
Step 3. Introduce my own rogue DHCP server.</p>
<h3 id="dhcp-snooping">DHCP Snooping</h3>
<p>Prevents DHCP starvation. It&rsquo;s a layer 2 sec switch which blocks unauthorized DHCP servers. Switch have trusted and untrusted ports. Legitimate DHCP is connected to the trusted one when first set up. All other devices, even local machines, become untrusted.</p>
<ol>
<li>Switch will drop all DHCPOFFER, DHCPACK, DHCPNACK from untrusted ports.</li>
<li>Drop requests for release/decline DHCPOFFER if these messages do not originate on the original machine then has send a DHCPREQUEST. This way attacker won&rsquo;t be able to terminate/decline the DHCP offer from the client&rsquo;s behalf.</li>
<li>❓ DHCP relay agent forwards a DHCP packet that includes a relay agent IP != 0.0.0.0 or includes option 82 to an untrusted port.</li>
<li>If source MAC (Ethernet) != client MAC (bootstrap protocol) - drop.</li>
</ol>
<p>If either of the above scenarios happen, it&rsquo;s logged. Apart from that, the switch will log the following:</p>
<ol>
<li>MACs of untrusted ports (UP).</li>
<li>Leased addresses of UP.</li>
<li>Lease time.</li>
<li>Binding time.</li>
<li>VLAN/interface the UP is associated with.</li>
</ol>
<p>On lease time expiration or DHCPRELEASE, cleanup of the corrsponding entry in the DHCP Snooping Binding DB. DHCP assigns addresses, switch filters, logs and forwards. Switch/router = DHCP relay agent.</p>
<h2 id="tools">Tools</h2>
<details>
    <summary>Expand &hellip;</summary>
    <a href="https://www.ccexpert.us/port-security/gobbler.html">https://www.ccexpert.us/port-security/gobbler.html</a>
<a href="http://dhcpstarv.sourceforge.net/">http://dhcpstarv.sourceforge.net/</a>
<a href="https://www.kali.org/tools/yersinia/">https://www.kali.org/tools/yersinia/</a>
</details>
<h2 id="reference">Reference</h2>
<details>
    <summary>Expand&hellip;</summary>
    <p>[<a href="https://2019.phdays.com/en/program/reports/apple-all-about-mitm/">1</a>] Apple, all about MITM. About Mac DHCP bugs from PhDays 2019.
[<a href="https://www.firewall.cx/downloads/article-attachments/198-dhcp-snooping-option-82.html">2</a>]DHCP SNOOPING OPTION 82
[<a href="https://www.firewall.cx/cisco-technical-knowledgebase/cisco-switches/1215-understanding-dhcp-snooping-concepts-and-how-it-works.html">3</a>] COMPLETE GUIDE TO DHCP SNOOPING, HOW IT WORKS, CONCEPTS, DHCP SNOOPING DATABASE, DHCP OPTION 82, MITIGATING DHCP STARVATION ATTACKS, DHCP HIJACKING, MAN-IN-THE-MIDDLE ATTACKS &amp; ROGUE DHCP SERVERS</p>
<p><a href="https://habr.com/en/companies/dsec/articles/333978/">https://habr.com/en/companies/dsec/articles/333978/</a>
<a href="https://habr.com/en/articles/338860/">https://habr.com/en/articles/338860/</a>
<a href="https://habr.com/en/articles/338864/">https://habr.com/en/articles/338864/</a>
<a href="https://habr.com/en/articles/339666/">https://habr.com/en/articles/339666/</a></p>

</details>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
