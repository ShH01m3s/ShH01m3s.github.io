<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Malicious Executables - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/malware/"> 👈🏼 Back to </br> 🦠 Malware Analysis </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#sans-six-part-methodology">SANS Six-Part Methodology</a></li>
    <li><a href="#static">Static</a>
      <ul>
        <li><a href="#strings">Strings</a></li>
        <li><a href="#signed-malware">Signed Malware</a></li>
        <li><a href="#libraries-and-imports">Libraries and Imports</a></li>
        <li><a href="#32-bit-apps">32-bit Apps</a></li>
        <li><a href="#location">Location</a></li>
        <li><a href="#name">Name</a></li>
        <li><a href="#runtime-linking">Runtime Linking</a></li>
        <li><a href="#packed-executable">Packed Executable</a></li>
        <li><a href="#hash">Hash</a></li>
        <li><a href="#byte-level-signatures">Byte-level signatures</a></li>
        <li><a href="#owners">Owners</a></li>
      </ul>
    </li>
    <li><a href="#dynamic">Dynamic</a>
      <ul>
        <li><a href="#parent-process">Parent Process</a></li>
        <li><a href="#process-taken-over">Process taken over</a></li>
        <li><a href="#on-disk-vs-ram">On-disk vs RAM</a></li>
        <li><a href="#behaviour">Behaviour</a></li>
        <li><a href="#singletons">Singletons</a></li>
        <li><a href="#boot-time">Boot time</a></li>
        <li><a href="#pid">PID</a></li>
      </ul>
    </li>
    <li><a href="#troubleshooting">Troubleshooting</a></li>
    <li><a href="#how-to-find-out-">How to find out &hellip;</a></li>
    <li><a href="#malware-as-an-artefact">Malware as an Artefact</a>
      <ul>
        <li><a href="#pdb">PDB</a></li>
        <li><a href="#strings-1">Strings</a></li>
        <li><a href="#meta">Meta</a></li>
        <li><a href="#resources">Resources</a></li>
      </ul>
    </li>
    <li><a href="#evidence">Evidence</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Malicious Executables</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 26.05.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p>For details on reverse engineering - refer to the Reverse 🔧 section of this website. I will only look into the simple static and dynamic analysis (using tools without running the file and running it- to see where it poos 💩).</p>
<h2 id="sans-six-part-methodology">SANS Six-Part Methodology</h2>
<ul>
<li><input disabled="" type="checkbox"> Identify rogue processes</li>
<li><input disabled="" type="checkbox"> Analyse DLLs and handles.</li>
<li><input disabled="" type="checkbox"> Review network artefacts</li>
<li><input disabled="" type="checkbox"> Look for code injection.</li>
<li><input disabled="" type="checkbox"> Check for any signs of a rootkit.</li>
<li><input disabled="" type="checkbox"> Dump suspicious process and drivers.</li>
</ul>
<h2 id="static">Static</h2>
<ul>
<li><code>.rsrc</code> section usually contains such resources as icons, pictures etc. However, some malicious programs (as well as legitimate ones) can store a driver or other code there, which gets extracted and executed by the main program flow.</li>
</ul>
<h3 id="strings">Strings</h3>
<p>Check <strong>strings</strong> in <code>Image</code> and in <code>Memory</code> using the corresponding radio button on the <code>Strings</code> tab of a selected process info in Process Explorer. If they differ - process replacement tool place. Use 🛠 <code>strings</code> or <code>floss</code> (decodes them as well)</p>
<p>Interesting strings:</p>
<ul>
<li><code>pdb</code> files (often contain username and can also give a hint on the malware writer&rsquo;s country of origin)</li>
<li>URLs</li>
<li>Something that looks like a password</li>
<li>emails</li>
<li>Base64 encoded things</li>
<li>library names</li>
</ul>
<h3 id="signed-malware">Signed Malware</h3>
<p>It&rsquo;s a rare case, but it exists. Around 3% of malware is <strong>signed</strong>. It&rsquo;s because some systems require executables to be signed. But this technique is not very good for malware authors since when at least one &ldquo;product&rdquo; is marked as malicious, all code signed with the same certificate will also be identified. 🛠 Use <code>sigcheck</code> to check signatures and hashes against Virus Total.</p>
<p>Check with a <code>spctl</code> if Apple notarises the application (not yet installed).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">spctl -a -vvv -t install /Volumes/BurpSuitePro/Burp<span class="se">\ </span>Suite<span class="se">\ </span>Professional.app 
</span></span><span class="line"><span class="cl">/Volumes/BurpSuitePro/Burp Suite Professional.app: accepted
</span></span><span class="line"><span class="cl"><span class="nv">source</span><span class="o">=</span>Notarized Developer ID
</span></span><span class="line"><span class="cl"><span class="nv">origin</span><span class="o">=</span>Developer ID Application: PortSwigger Ltd <span class="o">(</span>N82YM897DZ<span class="o">)</span>
</span></span></code></pre></div><h3 id="libraries-and-imports">Libraries and Imports</h3>
<ul>
<li>On Windows systems, some functions have the suffix <code>A</code> or <code>W</code>. These indicate that this function accepts ASCII or wide-character strings as an argument.</li>
<li>On Windows systems, some functions have a suffix <code>Ex</code> or even <code>ExEx</code>. These indicate that Windows has released a new version of a function incompatible with older ones since older ones must be supported.</li>
<li>You can use this web resource to understand WinAPI functions that are used by malware - <a href="https://malapi.io/">https://malapi.io/</a>. Remember, these are legit WinAPI functions and they are also used by legit software.</li>
</ul>
<h3 id="32-bit-apps">32-bit Apps</h3>
<p>For backward compatibility with older machines, malware authors prefer compiling 32-bit applications. Since malware authors usually want their software to work on as many machines as possible, they often compile 32-bit code**. That&rsquo;s not a decent indicator but an excellent additional score.</p>
<h3 id="location">Location</h3>
<p>It might be atypical location for <code>svchost.exe</code> in Documents forlder. You&rsquo;ll need to know what&rsquo;s ok and good for the given system. May user SANS poster <em>Find Evil</em>. Common locations for malware: <code>Windows\System32</code> is a very important location since it allows running with elevated privileges? ❓❓❓Also <code>Temp</code> folder and <code>Temp Internet Files</code>. <code>Windows</code>, <code>Windows SxS</code>. Recycle bin also may contain some files or remnants. <code>Program files</code> is the most usual for programs and malware may reside there as well.<code>System Volume Information</code>. That doesn&rsquo;t mean, however, that malware can&rsquo;t be elsewhere. Some core Windows executables don&rsquo;t even have an image file on disk (System, IDLE, for example).</p>
<h3 id="name">Name</h3>
<p>For example, name precisely like or very similar to some core system process? Is the strange name similar to the legit one? <code>svchosts</code>, for example. Present in <code>psscan</code> but absent in <code>pslist</code> (for running processes)? Read more about RAM forensics in the corresponding section. It&rsquo;s usual for malware to mistype the names if standard win core processes or use the same names in weird locations. Name mangling is a common technique.</p>
<p>To spot deviations at that point, you need to understand what&rsquo;s normal for that particular system. There are some common &ldquo;normalities&rdquo; for different OS, of course. You can refer to the SANS poster &ldquo;Find Evil&rdquo;, which is often updated, the SDF Podcast of Michael Leclair about Windows Core Processes, or find the corresponding article about core processes and system supernova in the Technical Reference section of this website.</p>
<h3 id="runtime-linking">Runtime Linking</h3>
<p>Since static linking is rare (it increases the body of a program) and dynamically linked functions can be inspected differently, runtime linking might be a choice for malware authors to hide the functionality. How to determine if the runtime linking is used?<em>❓Windows, Mac, Linux?</em> <strong>Importing</strong> and using <code>GetProcessAddress</code>/<code>LdrGetProcessAddress</code> or/and <code>LoadLibrary</code>/<code>LdrLoadDll</code>.</p>
<h3 id="packed-executable">Packed Executable</h3>
<p>Almoust 100% indicator that the author didn&rsquo;t want his treasure to be reverse engineered. Why could this be? Because it&rsquo;s some software with a portion of client-side code that performs sensitive operations. One example of a legitimate software is a program that generates OTP codes. There are several ways to determine that a file is packed. The first one - using enthropy analysis against the file. Consider, that most program epilogues start with <code>55 8B EC</code> (<code>push ebp mov ebp, esp</code>) and end with <code>c3</code> (<code>ret</code>).  That means that the number of both in one executable should be relatively the same. Compressed files don&rsquo;t compress well. Another example is to pack the file and determine, how efficiently was it packed. If it wasn&rsquo;t possible to pack the file too much, it&rsquo;s probable that the file is already packed. 🛠 Use the first method with <a href="https://www.aldeid.com/wiki/PEiD">PEiD</a> (GUI Windows tool), use the second method with <code>densityscan</code> (commercial cross-platform tool). Below are some common preliminary indicators of packed executables:</p>
<ul>
<li><input disabled="" type="checkbox"> <strong>VA vs PA</strong>. Empty Physical addresses for sections (while VA are not empty). More about virtual and physical addresses in the reverse engineering section.</li>
<li><input disabled="" type="checkbox"> Weired names for <strong>PE sections</strong>. PE sections (for Windows) are usually <code>text</code>, <code>bss</code>, <code>data</code> etc. If you some gibberish that&rsquo;s not usually seen here, most likely the executable is packed.</li>
</ul>
<h3 id="hash">Hash</h3>
<p>Check the file hash against the VirusTotal database. This way you&rsquo;ll eliminate <strong>known good</strong> files, since it&rsquo;s highly unlikely that a legitimate software like Windows files have never been checked so far. Also, this way you can find <strong>known bad</strong>.</p>
<h3 id="byte-level-signatures">Byte-level signatures</h3>
<p>You may have some signatures left from previous malware.</p>
<h3 id="owners">Owners</h3>
<p>Check the account it is run from. The most commonly used are local system accounts, network service accounts, and local service accounts. If any of the core processes are run from a user account, it&rsquo;s a possible sign of compromise.</p>
<h2 id="dynamic">Dynamic</h2>
<h3 id="parent-process">Parent Process</h3>
<p>Some other executable runs each executable. For core processes, there is only one legitimate parent. 👣 <strong>For Windows</strong>: <code>wininit</code> doesn&rsquo;t have a parent, while <code>sms.exe</code> is the child of System. Read more about core processes for each specific OS in a separate section.</p>
<h3 id="process-taken-over">Process taken over</h3>
<p><a href="https://www.linkedin.com/pulse/process-injection-detection-malfind-britton-manahan/">https://www.linkedin.com/pulse/process-injection-detection-malfind-britton-manahan/</a></p>
<h3 id="on-disk-vs-ram">On-disk vs RAM</h3>
<p>On-disk and in-memory contents don&rsquo;t match.</p>
<h3 id="behaviour">Behaviour</h3>
<p>Suspicious files opened, network ports and connections, OS resources (mutexes, hooks etc), a significant amount of CPU or RAM? <code>.rsrc</code> section usually contains such resources as icons, pictures etc. However, some malicious programs (as well as legitimate ones) can store a driver or other code there, which gets extracted and executed by the main program flow. If you suspect that a dynamically linked library was loaded into a process after load time, compare the import list in <a href="/docs/toolkit/general/reverse-toolkit/#process-explorer">Process Explorer</a> to the imports shown in <a href="/docs/toolkit/general/reverse-toolkit/#dependency-walker">Dependency Walker</a> (Windows, for other OS use analogous tools). <code>radare2</code> and <code>IDA</code> can also show imports.</p>
<p>One of the useful resources (Windows API docs, of course) also <a href="https://malapi.io/">https://malapi.io/</a> (from the malware perspective).</p>
<p>If your detection engine says there is an injection technique being used - most likely it&rsquo;s malware. <a href="https://www.linkedin.com/pulse/process-injection-detection-malfind-britton-manahan/">https://www.linkedin.com/pulse/process-injection-detection-malfind-britton-manahan/</a></p>
<p>🔥 An awesome resource to help with malware analysis - <a href="https://unprotect.it/technique/evasion-using-direct-syscalls/">https://unprotect.it/technique/evasion-using-direct-syscalls/</a>.</p>
<h3 id="singletons">Singletons</h3>
<p>One instance running only. 👣 <strong>For Windows</strong>: One instance <code>lsass</code>, <code>services</code>, <code>System</code>, <code>winint</code>, <code>lsm.exe</code> ❓. If any of these have more than 1 process should be the object of further investigation.</p>
<h3 id="boot-time">Boot time</h3>
<p>Core processes boot at a certain time and in specific order after boot. Anomalies here might be a good indicator of compromise. 👣 <strong>For Windows</strong>: <code>sms</code> starts at boot, for example.</p>
<h3 id="pid">PID</h3>
<p>Some core processes might have a predefined PID. 👣 <strong>For Windows</strong>: The system usually has PID 4.</p>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>Funny enough, malware can sometimes only run with massive help. Usually, that happens when there is an OS mismatch, some lib is missing from the machine, or simply a bug in the code itself. Ironically, we need to help it do its job in this case. So, how to troubleshoot malware?</p>
<p><strong>DLL to EXE</strong>. DLLs are dependent processes on Windows and, under normal circumstances, can&rsquo;t run independently. This complicates the analysis, and we want to save time. There are two ways (that I know of) that can make the DLL think it&rsquo;s an EXE:</p>
<ol>
<li>use <code>rundll32</code> (<code>rundll32 [dllname].dll, [function name or ordeal]</code>). For example, a <code>malware.dll</code>  has the function <code>InstallService</code>, which requires an argument service name. We want to launch it, call this function to create a service named &ldquo;MaliciousService&rdquo;: <code>rundll32 malware.dll, MaliciousService</code>. In Dependency Walker, we can peek the function&rsquo;s ordeal and run this command like this (if the ordeal is, say, 5): <code>rundll32 malware.dll, #5</code>.</li>
<li>patch the PE header of the DLL + change its extension. <code>IMAGE_FILE_HEADER</code> -&gt; <code>CHARACTERISTICS</code> &ndash;&gt; <code>IMAGE_FILE_DLL</code> flag <code>0x2000</code> set to <code>0x0000</code>.</li>
</ol>
<p><strong>Services</strong>. On Windows, <code>ServiceMain</code> can sometimes be missing an <code>Install</code> function. To fix this, either:</p>
<ol>
<li>Use <code>sc</code> command or</li>
<li><code>HKLM/SYSTEM/CurrentControlSet\Services</code> - modify the registry key.</li>
</ol>
<h2 id="how-to-find-out-">How to find out &hellip;</h2>
<ul>
<li>&hellip; which processes used a specific dll ❓ In <a href="/docs/toolkit/general/reverse-toolkit/#process-explorer">Process Explorer</a> choose <code>Find Handle or DLL</code>.</li>
<li>&hellip; if a DLL is loaded into a process after load time ❓ Compare the DLL list in <a href="/docs/toolkit/general/reverse-toolkit/#process-explorer">Process Explorer</a> to the imports shown in <a href="/docs/toolkit/general/reverse-toolkit/#dependency-walker">Dependency Walker</a>.</li>
<li>&hellip; if a <code>.doc</code> or <code>.pdf</code> or another document is malicious ❓ Open <a href="/docs/toolkit/general/reverse-toolkit/#process-explorer">Process Explorer</a>, launch the suspicios doc in sandboxed environment and check whether it has spawned any processes. Open this process&rsquo;s <code>Properties</code> window, <code>Image</code> tab to check the location of the malware file.</li>
<li>If there is an open socket, you can open <code>nc -nv &lt;IP&gt; &lt;port&gt;</code> to see what it wants to get.</li>
<li>If the malware is looking for a DNS record and iNetSim doesn&rsquo;t work (because it&rsquo;s something very custom), try adding <code>127.0.0.1  &lt;DNS name&gt;</code> and observing the activity with a tool like ProcMon. Then, do <code>ncat -nvlp &lt;port&gt;</code>. Try <code>ipconfig /flushdns</code> (Windows) if this doesn&rsquo;t help.</li>
<li>If process injection took place, find the victim in Process Hacker (or some analogue) and open Properties -&gt; Memory. Sort by Protection and find all that have RWX permissions (that&rsquo;s usually what a shellcode will require to run). No name in the Use column usually indicates.
Here is a separate section devoted to malware analysis methodology, tips, etc..</li>
</ul>
<h2 id="malware-as-an-artefact">Malware as an Artefact</h2>
<p>The attacker leaves malware, so it&rsquo;s a trace of their activity. Type of malware, location found etc., sometimes can hint at the actor.</p>
<h3 id="pdb">PDB</h3>
<h3 id="strings-1">Strings</h3>
<h3 id="meta">Meta</h3>
<h3 id="resources">Resources</h3>
<ul>
<li><code>.rsrc</code> section usually contains such resources as icons, pictures etc. However, some malicious programs (as well as legitimate ones) can store a driver or other code there, which gets extracted and executed by the main program flow.</li>
</ul>
<h2 id="evidence">Evidence</h2>
<ul>
<li><input disabled="" type="checkbox"> Passwords</li>
<li><input disabled="" type="checkbox"> Names</li>
<li><input disabled="" type="checkbox"> Paths</li>
</ul>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    <h3 id="tools">Tools</h3>
<ul>
<li>ProcMon (Sysinternals) for Windows and Glances for macOS <a href="https://nicolargo.github.io/glances/">https://nicolargo.github.io/glances/</a>, osquery, Instruments, vtop. Also try <code>opensnoop</code>, but with SIP off.</li>
</ul>
<h3 id="repos">Repos</h3>
<ul>
<li>theZoo: <a href="https://github.com/ytisf/theZoo">https://github.com/ytisf/theZoo</a></li>
<li>VXUnderground GitHub repo: <a href="https://github.com/vxunderground/MalwareSourceCode">https://github.com/vxunderground/MalwareSourceCode</a></li>
<li>Zeltser Resources: <a href="https://zeltser.com/malware-sample-sources/">https://zeltser.com/malware-sample-sources/</a></li>
<li></li>
</ul>
<h3 id="info">Info</h3>
<p>Try MISP API - <a href="https://www.misp-project.org/openapi/#tag/Attributes/operation/restSearchAttributes">https://www.misp-project.org/openapi/#tag/Attributes/operation/restSearchAttributes</a>.</p>
<p><a href="https://www.hybrid-analysis.com/sample/9fe55c51af6230c8640e140104645b32ba83ac868bf0f1571733f14761701247">https://www.hybrid-analysis.com/sample/9fe55c51af6230c8640e140104645b32ba83ac868bf0f1571733f14761701247</a>
<a href="https://www.f-secure.com/v-descs/trojan-spy_w32_finspy_a.shtml">https://www.f-secure.com/v-descs/trojan-spy_w32_finspy_a.shtml</a>
<a href="https://malshare.com/">https://malshare.com/</a></p>
<p>Malicious websites: <a href="https://zeltser.com/lookup-malicious-websites/">https://zeltser.com/lookup-malicious-websites/</a></p>
<p><a href="https://mail.google.com/mail/u/0/#inbox">https://mail.google.com/mail/u/0/#inbox</a></p>
<p>My <a href="https://peat-chameleon-e41.notion.site/Malware-DB-25248c9f91bd49b8ba0e869f465f626a">own</a> is maintained in Notion for now. Planning to turn this into a SQL DB + CLI.</p>
<h3 id="network">Network</h3>
<p><a href="https://malware-traffic-analysis.net">https://malware-traffic-analysis.net</a>
<a href="https://packettotal.com/malware-archive.html">https://packettotal.com/malware-archive.html</a></p>

</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
