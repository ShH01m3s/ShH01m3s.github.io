<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤔 How do I check for remote connections? - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/cheatsheets/"> 👈🏼 Back to </br> Artefacts CheatSheet </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#windows">Windows</a>
      <ul>
        <li><a href="#rdp">RDP</a>
          <ul>
            <li><a href="#event-logs">Event Logs</a></li>
            <li><a href="#registry">Registry</a></li>
            <li><a href="#jumplist">JumpList</a></li>
            <li><a href="#prefetch">Prefetch</a></li>
            <li><a href="#bitmapcache">BitmapCache</a></li>
          </ul>
        </li>
        <li><a href="#network-shares">Network Shares</a></li>
        <li><a href="#other-apps">Other Apps</a>
          <ul>
            <li><a href="#vnc">VNC</a></li>
            <li><a href="#teamviewer">TeamViewer</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">🤔 How do I check for remote connections?</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 18.06.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <h2 id="windows">Windows</h2>
<h3 id="rdp">RDP</h3>
<h4 id="event-logs">Event Logs</h4>
<ol>
<li>On <strong>source</strong> machine:
<ol>
<li><code>Security</code>🛡️ (<code>4648</code>)</li>
<li><code>TerminalServices-RDPClient</code> 🌸 (<code>1024</code> and <code>1102</code>)</li>
</ol>
</li>
<li>On the <strong>target</strong> machine:
<ol>
<li><code>Security</code> 🛡️ (<code>4624</code>, logon type <code>10</code>, <code>4778</code> and <code>4779</code>), see <code>Session name</code> to confirm it&rsquo;s an RDP.</li>
<li><code>Remote Desktop Services-RDPCoreTs</code> 🍇 (<code>131</code>, <code>98</code>)</li>
<li><code>TerminalServices-RemoteConnectionManager</code> 🍎 (<code>1149</code>)</li>
<li><code>TerminalServices-LocalSessionManager</code> 🍏(<code>21</code>, <code>22</code>, <code>25</code>, <code>41</code>)</li>
</ol>
</li>
</ol>
<p>Some breakdown of the above-mentioned codes (even if already explained elsewhere). You might filter for <code>4624</code> event id with logon type <code>10</code> to see the RDP connections. However, bear in mind that this event only records the <strong>NEW</strong> connections, not RE-connects. 4624 type 7 is triggered when lock/unlock activity happens. You will see <code>4778</code> for reconnects and <code>4779</code> for disconnects. <code>Client name</code> in <code>4778</code> shows the original machine name of the actor, giving some clues about the attacker.</p>
<blockquote>
<p>❗️Logon IDs for 4624 and 4778 might differ even though they represent the same session. This happens because the earlier created logon ID is often used instead. Search for 4624 events preceded by 4647 to find the logon 4624 event with the same ID.</p>
<p>❗️ Username in 4624 might NOT be the name of the original machine if some VPN or proxy is handling the connection.</p>
<p>❗️ You might also see logon type 3 (4624). It&rsquo;s not commonly used instead of type 10 if NLA is on and authenticating the client before establishing the RDP session.</p>
</blockquote>
<p>Several event log trails can give some insight into RDP connection: 🛡️<code>Security</code>, <code>Remote Desktop Services-RDPCoreTs</code> 🍇, <code>TerminalServices-LocalSessionManager</code> 🍏,  <code>TerminalServices-RemoteConnectionManager</code> 🍎 <code>TerminalServices-RDPClient</code> 🌸:</p>
<table>
<thead>
<tr>
<th>🤦🏽‍♂️ Actor</th>
<th>source ip and username (🍇 <code>131</code>, <code>98</code>🛡️<code>4648</code>, <code>4624</code>, <code>4778</code>, <code>4779</code>, 🍎 <code>1149</code>🍏<code>21</code>, <code>22</code>, <code>25</code>, 41)<!-- raw HTML omitted -->Hostname (🛡️)</th>
</tr>
</thead>
<tbody>
<tr>
<td>🎯 <strong>Target</strong></td>
<td>Destination hostname 🌸 <code>1024</code> and destination IP 🌸 <code>1102</code></td>
</tr>
<tr>
<td>📝 <strong>Event Metadata</strong></td>
<td>Successful Connections 🍇  <code>98</code>, Attempts 🍇 <code>131</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>❗️<code>TerminalServices-RDPClient</code> 🌸 is a rare beast; it records the RDP activity on the SOURCE and is rarely turned on. All other logs record activity on the REMOTE system (thus, they are present on the remote system only).</p>
</blockquote>
<blockquote>
<p>✍🏻 <code>4648</code> - if NLA is enabled and alternate creds are used: username, alternate username, dest hostname, dest IP, process name</p>
<p>✍🏻 <code>1149</code> - Blank username may indicate the use of Sticky keys.</p>
</blockquote>
<h4 id="registry">Registry</h4>
<p>🔑 <code>NTUSER\Software\Microsoft\TerminalServiceClient\Servers</code> shows recent RDP.</p>
<p>🛠️ <code>RegRipper</code>&rsquo;s <code>rdphint</code> plugin can extract this information from the hive automatically.</p>
<h4 id="jumplist">JumpList</h4>
<p>📂 <code>C:\User\username\AppData\Roaming\Microsoft\Windows\Recent\AutomaticDestinations</code> with <code>{MSTSC_APPID}-automaticDestinations-ms</code> show target info and a timestamp.</p>
<h4 id="prefetch">Prefetch</h4>
<p>Look out for 📄 <code>mstsc.exe-[hash].pf</code>.</p>
<h4 id="bitmapcache">BitmapCache</h4>
<p>📂 <code>C:\Users\username\AppData\Local\Microsoft\TerminalServerClient\Cache</code> contains <code>bcache##.bmc</code> and <code>cache#####.bin</code> files worth examining. During RDP connection, Windows collects parts of the image (those that change the least often) to save bandwidth. Sometimes you might see valuable information there, event VPN passwords.</p>
<p>Some file <code>Default.rdf</code> in user profile, what is that?</p>
<h3 id="network-shares">Network Shares</h3>
<p>It&rsquo;s pretty noisy, so be smart. Also, to enable this logging, go to <code>Object Access -&gt; Audit File Share</code>.</p>
<blockquote>
<p>❗️No 👴🏼 XP logs.</p>
</blockquote>
<p><code>5140</code> - network share was accessed.
<code>5142</code> - <code>5144</code> - share created, modified, deleted.
<code>5145</code> - the shared object was accessed.</p>
<p>If you see some <code>4624</code> followed by multiple <code>5140</code> events, it&rsquo;s probably an attempt to mount the share. The attackers will be most interested in the <code>ADMIN$</code> share. However, to use it, one needs to mount <code>IPC$</code> share first. That&rsquo;s good since it allows us to see the account name or SID, information not recorded for the <code>ADMIN$</code> share mount event.</p>
<h3 id="other-apps">Other Apps</h3>
<p>Custom apps for remote desktop connection produce their own artefacts as well. For example, VNC and TeamViewer. Not many of them are allowed in the enterprise, but these two buddies might be.</p>
<h4 id="vnc">VNC</h4>
<p>When VNC is used for remote connection, <code>4624</code> logon type <code>2</code> (Console login) is used instead. Also, VNC keeps its own wealth of logs - worth researching, to be honest (🗒️).</p>
<h4 id="teamviewer">TeamViewer</h4>
<p>This app is pretty 😎 cool because it keeps logs on BOTH source (<code>TeamViewerX-Logfile.log</code>) and the target (<code>Conncections-incoming.txt</code>) systems, which is of great use for the analysts. For these files look in 📂 <code>C:\ProgramFiles\TeamViewer\VersionX</code> folder.</p>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    <ol>
<li>ShimCache and AmCache enterprise-wide hunting - SANS Threat Hunting Summit 2017
<a href="https://www.youtube.com/watch?v=-0bYcD3_bBs">https://www.youtube.com/watch?v=-0bYcD3_bBs</a></li>
</ol>

</details>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
