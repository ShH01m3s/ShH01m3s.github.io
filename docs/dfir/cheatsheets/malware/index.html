<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤔 How Do I Spot Malware? - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/cheatsheets/"> 👈🏼 Back to </br> Artefacts CheatSheet </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#windows">Windows</a>
      <ul>
        <li><a href="#-ram">💭 RAM</a></li>
        <li><a href="#parents-and-children">Parents and Children</a></li>
        <li><a href="#wincore-vs-non-core">WinCore vs Non-Core</a></li>
        <li><a href="#singletons">Singletons</a></li>
        <li><a href="#boot-times">Boot Times</a></li>
        <li><a href="#deviations">Deviations</a></li>
        <li><a href="#permissions">Permissions</a></li>
        <li><a href="#common-malware">Common Malware</a>
          <ul>
            <li><a href="#cobalt-strike">Cobalt Strike</a></li>
          </ul>
        </li>
        <li><a href="#injections">Injections</a>
          <ul>
            <li><a href="#classic">Classic</a></li>
            <li><a href="#pe-injection">PE Injection</a></li>
            <li><a href="#process-hollowing">Process Hollowing</a></li>
            <li><a href="#sir-suspend-inject-resume">SIR (<strong>S</strong>uspend, <strong>I</strong>nject, <strong>R</strong>esume)</a></li>
            <li><a href="#hook-">Hook 🪝</a></li>
            <li><a href="#registry-poisoning">Registry poisoning</a></li>
            <li><a href="#apc">APC</a></li>
            <li><a href="#ewmi-with-setwindowlong">EWMI with <code>SetWindowLong()</code></a></li>
            <li><a href="#shims">SHIMS</a></li>
            <li><a href="#userland-rootkit">Userland rootkit</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">🤔 How Do I Spot Malware?</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 27.06.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p><em>The number or applications installed or present on a device can sometimes be frightening. Not all of them are installed with the user&rsquo;s consent. Some of them might be malicious. How does one spot these little pesky rodents?</em></p>
<p>System faults, errors and crashes can be spotted via System (errors, warnings and critical) and application events.</p>
<h2 id="windows">Windows</h2>
<p>🪵 <strong>Event logs</strong>: ⚙️ System, 📱Application</p>
<table>
<thead>
<tr>
<th>🏺 Artefact</th>
<th>📝 Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>🪵 Event logs</td>
<td>⚙️ errors, warning and critical<!-- raw HTML omitted -->📱1000 (error), 1001 (WER), 1002 (hanging)</td>
</tr>
<tr>
<td>📑 WER</td>
<td>📂 <code>C:\Microsoft\Windows\WER</code> 🛠️ <code>NinjaCopy</code> can collect that.</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="-ram">💭 RAM</h3>
<p>The best place to find malware is in RAM. At some point, it needs to run. Either get the RAM copy or some alternative like a <code>hiberfil.sys</code>. There are several techniques to use to identify malware in the RAM image: signature-based search (like with most AV), contradictions (something is not right there), heuristic/behavioural (the system or a process is behaving weirdly and unexpectedly).</p>
<p>Deviations = investigative leads. <strong>Core Processes</strong> - essential for Win, run on any Win system under examination.</p>
<p><img src="images/standart-proc-win.png" alt="standart-proc-win"></p>
<h3 id="parents-and-children">Parents and Children</h3>
<ul>
<li>check names</li>
<li>parent (for example, <code>svchost.exe</code> is started by <code>services.exe</code>)</li>
<li>expected path</li>
<li>Singleton?</li>
<li>Account (local system, mane, users)</li>
<li>start time (boot time, later)</li>
<li>Security identifier (SID)</li>
</ul>
<p><code>svchost.exe</code> - the most abused process. Check for the above deviations in the result.</p>
<p>One thing to do is compare the output from both <code>psllist</code> and <code>psscan</code> plugins to see if any rootkits are hiding. <code>pslist</code> relies on the doubly-linked <code>EPROCESS</code> list where each node represents a process&rsquo;s meta and points to the next <code>EPROCESS</code>. The problem is that with the DKOM technique (Direct Kernel Object Manipulation), an attacker can unlink the rogue process from the <code>EPROCESS</code> list, thus hiding it from the OS eye.</p>
<p>Here is what the <code>EPROCESS</code> list looks like (roughly):</p>
<p><img src="images/dkom.png" alt="img">
And here is what happens when the process is unlinked:</p>
<p><img src="images/no-dkom.png" alt="img"></p>
<p>As you can see, now the 🌴 process is &ldquo;invisible&rdquo; to the operating system. <code>pstree</code> plugin also relies on the same data structure, so, the only difference is in the presentation: you see a tree (child-parent relationships) instead of a list which is helpful too. <code>psscan</code>, on the other hand, doesn&rsquo;t rely on the <code>EPROCESS</code> list; it scans the whole image for these <code>EPROCESS</code> objects (their signatures), whether they are linked to each other or not, and thus identifies the rogue processes. It can also identify terminated processes (and marks them as such).</p>
<blockquote>
<p>❗️One very important thing to note is that <code>pslist</code> shows the virtual address of the <code>EPROCESS</code> structure (when it was in memory), whereas the <code>psscan</code> shows the physical offset (from the raw image start). 32-bit virtual address consists of the following parts: <code>10b</code> for page index, <code>10b</code> for page table index, <code>12b</code> for byte index. Additionally, <code>pslist</code> shows 🐾 number of threads, 🐾 number of handles, while <code>psscan</code> additionally notes 🐾 page directory base offset (PDB) and 🐾 exit time. <code>pstree</code> has the same info but in a different representation.</p>
</blockquote>
<p>Both plugins also show the following data:</p>
<p>🐾 Process name
🐾 PID
🐾 PPID (parent PID)
🐾 Start time</p>
<blockquote>
<p>🛠 <code>EchoTrail</code> is an excellent online tool for insights into the Windows core processes (expected boot time, children and parents etc).</p>
</blockquote>
<p>You can use the 🛠 <code>pstree</code> plugin to create a diagram in <code>.dot</code> format, which can later be used to create a png</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">📘 vol.py -f imagename --profile prof pstree --output<span class="o">=</span>dot --output-file<span class="o">=</span>pstree.dot
</span></span><span class="line"><span class="cl">📘 dot -Tpng pstree.dot -o pstree.png
</span></span></code></pre></div><p>Check <strong>parent</strong> processes of core processes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">📘 grep -E -i <span class="s2">&#34;(system|wininit|lsass|lsm|services|sms|taskhost|winlogon|iexplore|explorer|svchost|csrss)&#34;</span> pslist.txt &gt; pslist-all-core.txt
</span></span><span class="line"><span class="cl">📘 grep -E -i <span class="s2">&#34;(system|wininit|lsass|lsm|services|sms|taskhost|winlogon|iexplore|explorer|svchost|csrss)&#34;</span> psscan.txt &gt; psscan-all-core.txt
</span></span></code></pre></div><p>We have the result of <code>pslist</code>:</p>
<p><img src="images/pslist-results.png" alt="pslist-results"></p>
<p>We have several suspicious processes here: <code>scvhost.exe</code> (misspelled <code>svchost.exe</code>), some <code>xminer.exe</code> and a process with an intriguing name <code>3.exe</code>. But these are the processes that we could have seen, should we use a Task Manager on a live system. What about terminated or unlinked processes?</p>
<p>To answer that we run <code>psscan</code>:</p>
<p><img src="images/psscan-results.png" alt="psscan-results"></p>
<p>We saw the same <code>3.exe</code> in the list. But also we see <code>q.exe</code> which was run for about a minute and during that time another processes was spawned - <code>xmcminer.exe</code>. <code>q.exe</code> was terminated that&rsquo;s why we don&rsquo;t see it in <code>pslist</code> results. But <code>xmcminer.exe</code> was not terminated but we still don&rsquo;t see it in <code>pslist</code>. That means that the process was unlinked from a doubly-linked list of processes in memory (aka hidden).</p>
<p>Take unique process names, sort and count:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">📘 cut -d <span class="s2">&#34; &#34;</span> -f <span class="m">2</span> <span class="s1">&#39;psscan.txt&#39;</span> <span class="p">|</span> sort <span class="p">|</span> uniq -c <span class="p">|</span> sort &gt; <span class="s1">&#39;psscan_proc_sorted.txt&#39;</span>
</span></span></code></pre></div><p>Also, think about what the attackers are likely to run. Some remote tools, for example? Like, WMI or PowerShell. When PowerShell remoting is used, <code>wsmprovhost.exe</code> process is running in RAM on the target (when <code>ComputreName</code> option is specified). Or if it&rsquo;s an IIS server, there will be a <code>w3wp.exe</code> running in RAM. If the attacker manages to run a web shell, this process will spawn the tools that this web shell invokes, like <code>net.exe</code> or <code>sc.exe</code>.</p>
<p>🤨 If the user launches PowerShell, its parent will be <code>explorer.exe</code>. If admin - <code>svchost.exe</code>. PowerShell as a parent of cmd.exe is not necessarily suspicious but could be. 🤨  <code>wmiprvse.exe</code> is the one running WMI. If you see <code>wmiprvse.exe</code> spawns cmd.exe which does something with the registry or service could be something worth looking into.
🤨 Such processes like <code>mshta</code>, <code>word</code> or <code>excel</code> running PowerShell is also not a good thing.
🤨 <code>ActiveScriptEventConsumer</code> WMI spawns a rare process - <code>scrcons.exe</code>.</p>
<h3 id="wincore-vs-non-core">WinCore vs Non-Core</h3>
<p>Check <strong>names</strong> of non-win processes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">📘 grep -E -i -v <span class="s2">&#34;(system|wininit|lsass|lsm|services|sms|taskhost|winlogon|iexplore|explorer|svchost|csrss)&#34;</span>  pslist.txt &gt; pslist-all-non-wincore.txt
</span></span><span class="line"><span class="cl">📘 grep -E -i -v <span class="s2">&#34;(system|wininit|lsass|lsm|services|sms|taskhost|winlogon|iexplore|explorer|svchost|csrss)&#34;</span>  psscan.txt &gt; psscan-all-non-wincore.txt
</span></span></code></pre></div><h3 id="singletons">Singletons</h3>
<p>Check known <strong>singletons</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">📘 grep -E -i <span class="s2">&#34;(system|wininit|lsass|services|lsm)&#34;</span> pslist.txt &gt; pslist-all-singletons.txt
</span></span><span class="line"><span class="cl">📘 grep -E -i <span class="s2">&#34;(system|wininit|lsass|services|lsm)&#34;</span> psscan.txt &gt; psscan-all-singletons.txt
</span></span></code></pre></div><p><img src="images/pslist-singletons.png" alt="pslist-singletons"></p>
<p>In the example above there are two <code>lsass.exe</code> processes which is nonsense. Obviously, some investigative lead.</p>
<h3 id="boot-times">Boot Times</h3>
<p>Check <strong>boot times</strong>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">📘 grep -E -i &#34;(system|wininit|lsass|services|sms|lsm|csrss)&#34; pslist.txt &gt; pslist-all-boot.txt
</span></span><span class="line"><span class="cl">📘 grep -E -i &#34;(system|wininit|lsass|services|sms|lsm|csrss)&#34; psscan.txt &gt; psscan-all-boot.txt
</span></span></code></pre></div><p><code>System</code> is a pivot point. Other processes that should start at boot, should have roughly the same starting date and time. <code>pslist</code> is pulling the information of a doubly-linked list (like a Task Manager). <code>psscan</code> - unallocated space (processes terminated or unlinked from this double-linked list).</p>
<p>Also, get all processes that did not start at boot time:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">📘 grep -E -i -v 2019-01-20 <span class="s1">&#39;pslist.txt&#39;</span> &gt; pslist_not_boottime.txt
</span></span><span class="line"><span class="cl">📘 grep -E -i -v 2019-01-20 <span class="s1">&#39;psscan.txt&#39;</span> &gt; psscan_not_boottime.txt
</span></span></code></pre></div><h3 id="deviations">Deviations</h3>
<p>Another helpful plugin to use would be the <code>malfind</code>, which tries to identify rogue processes looking for specific attack patterns automatically. And one of the most useful (at least, in my humble opinion) is the <code>processbl</code> which stands for process baseline and means you can compare the processes and DLLs in your image with some baseline image.</p>
<p>The baseline plugin has three parts: <code>processbl</code>, <code>drivebl</code> and <code>servicebl</code>.</p>
<p>⚙️ <code>processbl</code> compares processes and their loaded DLLs (relies on the same structure as <code>pslist</code>)
⚙️ drivebl compares the drivers
⚙️ servicebl compares the services</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">📘 vol.py -f imagefile --profile<span class="o">=</span>prof -B ./baseline.img processbl -U <span class="m">2</span> &gt; error.log <span class="c1">#  -U - shows what&#39;s different and -K - what&#39;s not</span>
</span></span></code></pre></div><p>Since this plugin does NOT compare the executable paths, only the names, it&rsquo;s a good practice to use both <code>-U</code> and <code>-K</code> switches to see what&rsquo;s really out of place.</p>
<h3 id="permissions">Permissions</h3>
<p>Permissions on Windows are specified with the tokens and SIDs. <code>getsid</code> volatility plugin can be used to display the security identifiers for the given process.</p>
<h3 id="common-malware">Common Malware</h3>
<h4 id="cobalt-strike">Cobalt Strike</h4>
<p>CS usually spawns a child process for each activity to make itself more persistent. These are called sacrificial processes. A good approach would be to look for exited child processes under <code>PowerShell</code> or <code>WmiPrvSE</code>.</p>
<h3 id="injections">Injections</h3>
<p>Most of the information is taken from <a href="!%5Bulr-4%5D(images/ulr-4.png)">here</a>, but more visualisation is added. The screenshots from IDA Pro are also copied from that blog post. I will start with a brief overview of the volatility plugins used to analyse injection and you can see the list below for more detailed analysis instructions.</p>
<h4 id="classic">Classic</h4>
<p>This one is the one of the simpliest to explain and not that simple to actually use in a real attack (see Caveats). A malicious dll&rsquo;s <strong>path</strong> is copied in the memory space of a running legitimate process to be loaded in runtime.</p>
<p><img src="images/classic-1.png" alt="classic-1"></p>
<p>Below is the anatomy of this function call.</p>
<p><img src="images/classic-2.png" alt="classic-2"></p>
<p>Here is a scheme of the sick process address space layout in RAM when this shit happens:</p>
<p><img src="images/classic-3.png" alt="classic-3"></p>
<p>And this is approximately what you&rsquo;d see in IDA Pro, if you had an appropriate sample utilising this technique:</p>
<p><img src="images/classic-4.png" alt="classic-4"></p>
<p>There are two main problems:</p>
<ul>
<li>Most of the defense tools start barking when they hear the <code>CreateRemoteThread()</code> call.</li>
<li>The attacker needs to have this <code>mal.dll</code> on disk prior to attack.</li>
</ul>
<h4 id="pe-injection">PE Injection</h4>
<p>A malicious <strong>dll itself</strong> copied in the memory space of a running legitimate process.</p>
<p>This is the chain of function calls needed for this attack.</p>
<p><img src="images/pe-1.png" alt="pe-1"></p>
<p>Below is the anatomy of the <code>CreateRemoteThread</code> function call needed for this attack to work</p>
<p><img src="images/pe-2.png" alt="pe-2"></p>
<p>Below is the memory layout of the sick process.</p>
<p><img src="images/pe-3.png" alt="pe-3"></p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<p><img src="images/pe-4.png" alt="pe-4"></p>
<p><code>СreateRemoteThread()</code> and <code>LoadLibrary()</code> are not stealthy</p>
<h4 id="process-hollowing">Process Hollowing</h4>
<p>Already loaded good process is fully overwritten with something not that good.</p>
<p>This is the chain of function calls needed for this attack.</p>
<p><img src="images/ph-1.png" alt="ph-1"></p>
<p>Below is the memory layout of the sick process.</p>
<p><img src="images/ph-2.png" alt="ph-2"></p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<p><img src="images/ph-3.png" alt="ph-3"></p>
<p><img src="images/ph-4.png" alt="ph-4"></p>
<p>➕ No need to have mal.dll on disk</p>
<p>➖ CreateRemoteThread()<code>and</code>LoadLibrary()` are loud</p>
<h4 id="sir-suspend-inject-resume">SIR (<strong>S</strong>uspend, <strong>I</strong>nject, <strong>R</strong>esume)</h4>
<p>EIP register&rsquo;s value of a running thread is substituted. This is the chain of function calls needed for this attack.</p>
<p><img src="images/sir-1.png" alt="sir-1"></p>
<p>Below is the memory layout of the sick process.</p>
<p><img src="images/sir-2.png" alt="sir-2"></p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<p><img src="images/sir-3.png" alt="sir-3"></p>
<p><img src="images/sir-4.png" alt="sir-4"></p>
<p>➕ Not as noisy since there is no process created. All the perversion is done with the already running one.</p>
<p>➖ If the process is suspended due to a system call, the program will crash. For this case Trojans that are a little smarter can check EIP value and postpone the inject if its  value is in the <code>ntdll.dll</code>&rsquo;s address range.</p>
<h4 id="hook-">Hook 🪝</h4>
<p>Uses <code>SetWindowsHookEx()</code> API function.</p>
<p>Call interception.</p>
<p>This is the chain of function calls needed for this attack.</p>
<p><img src="images/hook-1.png" alt="hook-1"></p>
<p>Below is the memory layout of the sick process.</p>
<p><img src="images/hook-2.png" alt="hook-2"></p>
<p>Below is the anatomy of the <code>SetWindowHookEx()</code> function call needed for this attack to work.</p>
<p><img src="images/hook-3.png" alt="hook-3"></p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<p><img src="images/hook-4.png" alt="hook-4"></p>
<p><img src="images/hook-5.png" alt="hook-5"></p>
<h4 id="registry-poisoning">Registry poisoning</h4>
<p>Using the registry to inject.</p>
<p>These are the keys that can be used for injection.</p>
<ul>
<li>
<p>Upon <code>User32.dll</code> load <code>mal.dll</code> will be loaded:</p>
<ul>
<li><code>HKLM/Software/Microsoft/WindowsNT/CurrentVersion/Windows/Appinit_Dlls</code></li>
<li><code>HKLM/Software/Wow6432Node/Microsoft/WindowsNT/CurrentVersion/Windows/Appinit_Dlls</code></li>
</ul>
</li>
<li>
<p>Whenever <code>CreateProcess()</code>, <code>CreateProcessAsUser()</code>, <code>CreateProcessWithLogonW()</code>,</p>
<p><code>CreateProcessWithTokenW()</code>, <code>WinExec()</code> are called, mal.dll will be called</p>
<ul>
<li><code>HKLM/System/CurrentControlSet/Control/Session Manager/AppCertDlls</code></li>
</ul>
</li>
<li>
<p>IFEO - usually used to attach a debugger. The value of the  &ldquo;Debugger Value&rdquo; is changed.</p>
</li>
<li>
<p><code>HKLM/Software/Wow6432Node/Microsoft/WindowsNT/CurrentVersion/image file execution options</code></p>
</li>
</ul>
<p>Below is the memory layout of the sick process.</p>
<p>Below is the anatomy of the <code>XXXXXXXXXXXXXXXX</code> function call needed for this attack to work</p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<p><img src="images/reg1.png" alt="reg1"></p>
<p>➕ The very process of injection is stealthy.</p>
<p>➖ However,<code>mal.dll</code> needs to be present on disk.</p>
<p>➖ There are &ldquo;smithereens&rdquo; left in the registry that can be a good lead in an investigation.</p>
<h4 id="apc">APC</h4>
<p>This is the chain of function calls needed for this attack.</p>
<p><img src="images/apc-1.png" alt="apc-1"></p>
<p>Below is the memory layout of the sick process.</p>
<p><img src="images/apc-2.png" alt="apc-2"></p>
<p>Below is the anatomy of the <code>XXXXXXXXXXXXXXXX</code> function call needed for this attack to work.</p>
<p><img src="images/apc-3.png" alt="apc-3"></p>
<p>How this attack actually work (visualised):</p>
<p><img src="images/apc-2-2.png" alt="apc-2-2"></p>
<p><img src="images/apc-4.png" alt="apc-4"></p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<p><img src="images/apc-5.png" alt="apc-5"></p>
<h4 id="ewmi-with-setwindowlong">EWMI with <code>SetWindowLong()</code></h4>
<p>Extra Window Memory Injection. Ok, hold my beer 🍻, this one is a little tough for 11:14 in the evening. <code>explorer.exe</code> process has some shared memory, that can be used by other processes. Neat, right? What other process have this &ldquo;<em>feature</em>&rdquo;? Let&rsquo;s keep this information roasting for a while. There are two ways of using this <del>bug</del> <em>feature</em>: decently creating a shared region (using <code>NTMapViewOfSection</code> for allocating heap section) or leeching off on another one&rsquo;s. Guess which one is the prefered one for the attackers 😉?</p>
<p>There is another feature, not <code>explorer.exe</code> specific: GUI applications when creating a window have some additional 40 bytes for each window in the window class structure, where they can put anything 40 bytes long (properties, function pointers). Originally, these bytes were designed to store some window specific info, i.e. colors, menu items I guess. However, one can write a pointer in this space to point to somewhere else: either in this very process (which is quite useless for an attacker) or in some shared region (let&rsquo;s stop the information in the above paragraph roasting).</p>
<p>And finally, there is this <code>Shell_TrayWnd</code>. Remember, the panel on the bottom on Windows? How do these pretty cute icons get into the tray? That&rsquo;s the class responsible for this magic 🪄. As any other window, it also has its own additional 40 bytes for each instance and these bytes can be retrieved and set with <code>GetWindowLong</code> and <code>SetWindowLong</code>.</p>
<p>Now, let&rsquo;s assemble it all together. How does this work from a malicious point of view. To actually make this pointer work, one would have to call <code> SetWindowLong</code> (to set the value pointing to some shared memory with shellcode 🐚 in it) and <code>SendNotifyMessage</code> (to trigger it).</p>
<p>This is the chain of function calls needed for this attack.</p>
<p>Below is the memory layout of the sick process.</p>
<p>Below is the anatomy of the <code>XXXXXXXXXXXXXXXX</code> function call needed for this attack to work</p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<p><img src="images/ewmi-4.png" alt="ewmi-4"></p>
<p>Gapz and PowerLoader</p>
<h4 id="shims">SHIMS</h4>
<p>Favourite and the most useful for malware: <code>DisableNX</code>, <code>DisableSEH</code>, <code>InjectDLL</code>.</p>
<p>This is the chain of function calls needed for this attack.</p>
<p>Below is the memory layout of the sick process.</p>
<p>Below is the anatomy of the <code>XXXXXXXXXXXX</code> function call needed for this attack to work</p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<p>🦠 Adware, 🦠 “Search Protect by Conduit”.</p>
<p>🛠 <code>python-sdb</code></p>
<h4 id="userland-rootkit">Userland rootkit</h4>
<p>Rootkits are usually associated with the kernel space, however, there are also userland rootkits out there. There are two main techniques known: IAT and inline.</p>
<p>When IAT hooking technique is used, malware changes the import address table. This way when a good application calls some function from this tampered DLL, the replaced function is executed instead.</p>
<p>With inline hooking malware modifies the function&rsquo;s body itself.</p>
<p>This is the chain of function calls needed for this attack.</p>
<p>Below is the memory layout of the sick process.</p>
<p>Below is the anatomy of the XXXX function call needed for this attack to work</p>
<p>And this is what you&rsquo;d see in IDA Pro if you had a sample using this technique.</p>
<p><img src="images/ulr-4.png" alt="ulr-4"></p>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    Something here
</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
