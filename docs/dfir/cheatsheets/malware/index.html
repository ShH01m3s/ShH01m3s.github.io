<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤” How Do I Spot Malware? - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/cheatsheets/"> ğŸ‘ˆğŸ¼ Back to </br> Artefacts CheatSheet </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#windows">Windows</a>
      <ul>
        <li><a href="#-ram">ğŸ’­ RAM</a></li>
        <li><a href="#parents-and-children">Parents and Children</a></li>
        <li><a href="#wincore-vs-non-core">WinCore vs Non-Core</a></li>
        <li><a href="#singletons">Singletons</a></li>
        <li><a href="#boot-times">Boot Times</a></li>
        <li><a href="#deviations">Deviations</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">ğŸ¤” How Do I Spot Malware?</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 27.06.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p><em>The number or applications installed or present on a device can sometimes be frightening. Not all of them are installed with the user&rsquo;s consent. Some of them might be malicious. How does one spot these little pesky rodents?</em></p>
<p>System faults, errors and crashes can be spotted via System (errors, warnings and critical) and application events.</p>
<h2 id="windows">Windows</h2>
<p>ğŸªµ <strong>Event logs</strong>: âš™ï¸ System, ğŸ“±Application</p>
<table>
<thead>
<tr>
<th>ğŸº Artefact</th>
<th>ğŸ“ Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸªµ Event logs</td>
<td>âš™ï¸ errors, warning and critical<!-- raw HTML omitted -->ğŸ“±1000 (error), 1001 (WER), 1002 (hanging)</td>
</tr>
<tr>
<td>ğŸ“‘ WER</td>
<td>ğŸ“‚ <code>C:\Microsoft\Windows\WER</code> ğŸ› ï¸ <code>NinjaCopy</code> can collect that.</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="-ram">ğŸ’­ RAM</h3>
<p>The best place to find malware is in RAM. At some point, it needs to run. Either get the RAM copy or some alternative like a <code>hiberfil.sys</code>. There are several techniques to use to identify malware in the RAM image: signature-based search (like with most AV), contradictions (something is not right there), heuristic/behavioural (the system or a process is behaving weirdly and unexpectedly).</p>
<p>Deviations = investigative leads. <strong>Core Processes</strong> - essential for Win, run on any Win system under examination.</p>
<p><img src="images/standart-proc-win.png" alt="standart-proc-win"></p>
<h3 id="parents-and-children">Parents and Children</h3>
<ul>
<li>check names</li>
<li>parent (for example, <code>svchost.exe</code> is started by <code>services.exe</code>)</li>
<li>expected path</li>
<li>Singleton?</li>
<li>Account (local system, mane, users)</li>
<li>start time (boot time, later)</li>
<li>Security identifier (SID)</li>
</ul>
<p><code>svchost.exe</code> - the most abused process. Check for the above deviations in the result.</p>
<p>One thing to do is compare the output from both <code>psllist</code> and <code>psscan</code> plugins to see if any rootkits are hiding. <code>pslist</code> relies on the doubly-linked <code>EPROCESS</code> list where each node represents a process&rsquo;s meta and points to the next <code>EPROCESS</code>. The problem is that with the DKOM technique (Direct Kernel Object Manipulation), an attacker can unlink the rogue process from the <code>EPROCESS</code> list, thus hiding it from the OS eye.</p>
<p>Here is what the <code>EPROCESS</code> list looks like (roughly):</p>
<p><img src="images/dkom.png" alt="img">
And here is what happens when the process is unlinked:</p>
<p><img src="images/no-dkom.png" alt="img"></p>
<p>As you can see, now the ğŸŒ´ process is &ldquo;invisible&rdquo; to the operating system. <code>pstree</code> plugin also relies on the same data structure, so, the only difference is in the presentation: you see a tree (child-parent relationships) instead of a list which is helpful too. <code>psscan</code>, on the other hand, doesn&rsquo;t rely on the <code>EPROCESS</code> list; it scans the whole image for these <code>EPROCESS</code> objects (their signatures), whether they are linked to each other or not, and thus identifies the rogue processes. It can also identify terminated processes (and marks them as such).</p>
<blockquote>
<p>â—ï¸One very important thing to note is that <code>pslist</code> shows the virtual address of the <code>EPROCESS</code> structure (when it was in memory), whereas the <code>psscan</code> shows the physical offset (from the raw image start). 32-bit virtual address consists of the following parts: <code>10b</code> for page index, <code>10b</code> for page table index, <code>12b</code> for byte index. Additionally, <code>pslist</code> shows ğŸ¾ number of threads, ğŸ¾ number of handles, while <code>psscan</code> additionally notes ğŸ¾ page directory base offset (PDB) and ğŸ¾ exit time. <code>pstree</code> has the same info but in a different representation.</p>
</blockquote>
<p>Both plugins also show the following data:</p>
<p>ğŸ¾ Process name
ğŸ¾ PID
ğŸ¾ PPID (parent PID)
ğŸ¾ Start time</p>
<blockquote>
<p>ğŸ›  <code>EchoTrail</code> is an excellent online tool for insights into the Windows core processes (expected boot time, children and parents etc).</p>
</blockquote>
<p>You can use the ğŸ›  <code>pstree</code> plugin to create a diagram in <code>.dot</code> format, which can later be used to create a png</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ğŸ“˜ vol.py -f imagename --profile prof pstree --output<span class="o">=</span>dot --output-file<span class="o">=</span>pstree.dot
</span></span><span class="line"><span class="cl">ğŸ“˜ dot -Tpng pstree.dot -o pstree.png
</span></span></code></pre></div><p>Check <strong>parent</strong> processes of core processes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ğŸ“˜ grep -E -i <span class="s2">&#34;(system|wininit|lsass|lsm|services|sms|taskhost|winlogon|iexplore|explorer|svchost|csrss)&#34;</span> pslist.txt &gt; pslist-all-core.txt
</span></span><span class="line"><span class="cl">ğŸ“˜ grep -E -i <span class="s2">&#34;(system|wininit|lsass|lsm|services|sms|taskhost|winlogon|iexplore|explorer|svchost|csrss)&#34;</span> psscan.txt &gt; psscan-all-core.txt
</span></span></code></pre></div><p>We have the result of <code>pslist</code>:</p>
<p><img src="images/pslist-results.png" alt="pslist-results"></p>
<p>We have several suspicious processes here: <code>scvhost.exe</code> (misspelled <code>svchost.exe</code>), some <code>xminer.exe</code> and a process with an intriguing name <code>3.exe</code>. But these are the processes that we could have seen, should we use a Task Manager on a live system. What about terminated or unlinked processes?</p>
<p>To answer that we run <code>psscan</code>:</p>
<p><img src="images/psscan-results.png" alt="psscan-results"></p>
<p>We saw the same <code>3.exe</code> in the list. But also we see <code>q.exe</code> which was run for about a minute and during that time another processes was spawned - <code>xmcminer.exe</code>. <code>q.exe</code> was terminated that&rsquo;s why we don&rsquo;t see it in <code>pslist</code> results. But <code>xmcminer.exe</code> was not terminated but we still don&rsquo;t see it in <code>pslist</code>. That means that the process was unlinked from a doubly-linked list of processes in memory (aka hidden).</p>
<p>Take unique process names, sort and count:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ğŸ“˜ cut -d <span class="s2">&#34; &#34;</span> -f <span class="m">2</span> <span class="s1">&#39;psscan.txt&#39;</span> <span class="p">|</span> sort <span class="p">|</span> uniq -c <span class="p">|</span> sort &gt; <span class="s1">&#39;psscan_proc_sorted.txt&#39;</span>
</span></span></code></pre></div><p>Also, think about what the attackers are likely to run. Some remote tools, for example? Like, WMI or PowerShell. When PowerShell remoting is used, <code>wsmprovhost.exe</code> process is running in RAM on the target (when <code>ComputreName</code> option is specified). Or if it&rsquo;s an IIS server, there will be a <code>w3wp.exe</code> running in RAM. If the attacker manages to run a web shell, this process will spawn the tools that this web shell invokes, like <code>net.exe</code> or <code>sc.exe</code>.</p>
<p>ğŸ¤¨ If the user launches PowerShell, its parent will be <code>explorer.exe</code>. If admin - <code>svchost.exe</code>. PowerShell as a parent of cmd.exe is not necessarily suspicious but could be. ğŸ¤¨  <code>wmiprvse.exe</code> is the one running WMI. If you see <code>wmiprvse.exe</code> spawns cmd.exe which does something with the registry or service could be something worth looking into.
ğŸ¤¨ Such processes like <code>mshta</code>, <code>word</code> or <code>excel</code> running PowerShell is also not a good thing.
ğŸ¤¨ <code>ActiveScriptEventConsumer</code> WMI spawns a rare process - <code>scrcons.exe</code>.</p>
<h3 id="wincore-vs-non-core">WinCore vs Non-Core</h3>
<p>Check <strong>names</strong> of non-win processes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ğŸ“˜ grep -E -i -v <span class="s2">&#34;(system|wininit|lsass|lsm|services|sms|taskhost|winlogon|iexplore|explorer|svchost|csrss)&#34;</span>  pslist.txt &gt; pslist-all-non-wincore.txt
</span></span><span class="line"><span class="cl">ğŸ“˜ grep -E -i -v <span class="s2">&#34;(system|wininit|lsass|lsm|services|sms|taskhost|winlogon|iexplore|explorer|svchost|csrss)&#34;</span>  psscan.txt &gt; psscan-all-non-wincore.txt
</span></span></code></pre></div><h3 id="singletons">Singletons</h3>
<p>Check known <strong>singletons</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ğŸ“˜ grep -E -i <span class="s2">&#34;(system|wininit|lsass|services|lsm)&#34;</span> pslist.txt &gt; pslist-all-singletons.txt
</span></span><span class="line"><span class="cl">ğŸ“˜ grep -E -i <span class="s2">&#34;(system|wininit|lsass|services|lsm)&#34;</span> psscan.txt &gt; psscan-all-singletons.txt
</span></span></code></pre></div><p><img src="images/pslist-singletons.png" alt="pslist-singletons"></p>
<p>In the example above there are two <code>lsass.exe</code> processes which is nonsense. Obviously, some investigative lead.</p>
<h3 id="boot-times">Boot Times</h3>
<p>Check <strong>boot times</strong>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ğŸ“˜ grep -E -i &#34;(system|wininit|lsass|services|sms|lsm|csrss)&#34; pslist.txt &gt; pslist-all-boot.txt
</span></span><span class="line"><span class="cl">ğŸ“˜ grep -E -i &#34;(system|wininit|lsass|services|sms|lsm|csrss)&#34; psscan.txt &gt; psscan-all-boot.txt
</span></span></code></pre></div><p><code>System</code> is a pivot point. Other processes that should start at boot, should have roughly the same starting date and time. <code>pslist</code> is pulling the information of a doubly-linked list (like a Task Manager). <code>psscan</code> - unallocated space (processes terminated or unlinked from this double-linked list).</p>
<p>Also, get all processes that did not start at boot time:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ğŸ“˜ grep -E -i -v 2019-01-20 <span class="s1">&#39;pslist.txt&#39;</span> &gt; pslist_not_boottime.txt
</span></span><span class="line"><span class="cl">ğŸ“˜ grep -E -i -v 2019-01-20 <span class="s1">&#39;psscan.txt&#39;</span> &gt; psscan_not_boottime.txt
</span></span></code></pre></div><h3 id="deviations">Deviations</h3>
<p>Another helpful plugin to use would be the <code>malfind</code>, which tries to identify rogue processes looking for specific attack patterns automatically. And one of the most useful (at least, in my humble opinion) is the <code>processbl</code> which stands for process baseline and means you can compare the processes and DLLs in your image with some baseline image.</p>
<p>The baseline plugin has three parts: <code>processbl</code>, <code>drivebl</code> and <code>servicebl</code>.</p>
<p>âš™ï¸ <code>processbl</code> compares processes and their loaded DLLs (relies on the same structure as <code>pslist</code>)
âš™ï¸ drivebl compares the drivers
âš™ï¸ servicebl compares the services</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ğŸ“˜ vol.py -f imagefile --profile<span class="o">=</span>prof -B ./baseline.img processbl -U <span class="m">2</span> &gt; error.log <span class="c1">#  -U - shows what&#39;s different and -K - what&#39;s not</span>
</span></span></code></pre></div><p>Since this plugin does NOT compare the executable paths, only the names, it&rsquo;s a good practice to use both <code>-U</code> and <code>-K</code> switches to see what&rsquo;s really out of place.</p>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    Something here
</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
