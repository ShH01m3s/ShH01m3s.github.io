<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤” How Do I Audit Management Tools? - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/cheatsheets/"> ğŸ‘ˆğŸ¼ Back to </br> Artefacts CheatSheet </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#windows">Windows</a>
      <ul>
        <li><a href="#services">Services</a></li>
        <li><a href="#tasks">Tasks</a></li>
        <li><a href="#wmi">WMI</a></li>
        <li><a href="#powershell-remote">PowerShell Remote</a></li>
        <li><a href="#registry">Registry</a></li>
        <li><a href="#winrs">winrs</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">ğŸ¤” How Do I Audit Management Tools?</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 26.06.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p><em>Admins on payroll and those &ldquo;magnanimous volunteers&rdquo; often tread the very same path, albeit guided by different compasses of motivation. Once our cunning adversary ascends to the lofty heights of respect usually reserved for the admin on payroll, the misuse of these management tools becomes bound only by the limits of their mischievous imagination.</em></p>
<h2 id="windows">Windows</h2>
<h3 id="services">Services</h3>
<blockquote>
<p>â—ï¸Doesn&rsquo;t require admin privileges to pull off.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="err">ğŸ“•</span> <span class="nb">sc </span><span class="p">\\</span><span class="n">host</span> <span class="n">create</span> <span class="n">service_name</span> <span class="n">binpath</span><span class="p">=</span><span class="s2">&#34;path/to/service&#34;</span>
</span></span></code></pre></div><table>
<thead>
<tr>
<th>ğŸº Artefact</th>
<th>ğŸš° Source</th>
<th>ğŸ¯ Target</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ—„ï¸ Registry</td>
<td>ShimCache, BAM/DAM and AmCache for <code>sc.exe</code> traces</td>
<td>ğŸ”‘ <code>CurrentControlSet\Services</code><!-- raw HTML omitted -->ShimCache and AmCache</td>
</tr>
<tr>
<td>ğŸ“‘ File system</td>
<td>Prefetch</td>
<td>Image file of the exe<!-- raw HTML omitted -->Prefetch</td>
</tr>
<tr>
<td>ğŸªµ Event logs</td>
<td></td>
<td>ğŸ›¡ï¸ <code>4624</code> type <code>3</code> (sIP, sname), <code>4697</code> (service installed) <!-- raw HTML omitted -->âš™ï¸ <code>7034</code> (service terminated unexpectedly), <code>7035</code> (start/stop request sent), <code>7036</code> (service started/stopped), <code>7040</code> (start type changed), <code>7045</code> (service installed)</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="tasks">Tasks</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="err">ğŸ“•</span> <span class="n">at</span> <span class="p">\\</span><span class="n">host</span> <span class="n">time</span> <span class="s2">&#34;path\to\exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="err">ğŸ“•</span> <span class="n">schtasks</span> <span class="p">/</span><span class="n">CREATE</span> <span class="p">/</span><span class="n">TN</span> <span class="n">taskname</span> <span class="p">/</span><span class="n">TR</span> <span class="n">C:</span><span class="p">\</span><span class="n">path</span><span class="p">\</span><span class="n">to</span><span class="p">\</span><span class="n">evil</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="nb">SC </span><span class="n">once</span> <span class="p">/</span><span class="n">RU</span> <span class="s2">&#34;SYSTEM&#34;</span> <span class="p">/</span><span class="n">ST</span> <span class="n">15</span><span class="err">:</span><span class="n">00</span> <span class="p">/</span><span class="n">S</span> <span class="n">host</span> <span class="p">/</span><span class="n">u</span> <span class="n">uname</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># RU - run as user</span>
</span></span><span class="line"><span class="cl"><span class="c"># TR - what to do</span>
</span></span><span class="line"><span class="cl"><span class="c"># S - remote system to connect to</span>
</span></span></code></pre></div><p>For the below artefacts watch out for <code>at.exe</code> and <code>schtasks.exe</code>.</p>
<p>ğŸ›¡ï¸Security and ğŸ¥€ Task logs</p>
<table>
<thead>
<tr>
<th>ğŸº Artefact</th>
<th>ğŸš° Source</th>
<th>ğŸ¯ Target</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸªµ Event logs</td>
<td>4648 (alternate creds)</td>
<td>ğŸ›¡ï¸ <code>4698</code> (created), <code>4702</code> (updated), <code>4699</code> (deleted), <code>4700</code> (enabled), <code>4701</code> (disabled), <!-- raw HTML omitted -->ğŸ¥€ <code>106</code> (created), <code>140</code> (updated), <code>141</code> (deleted), <code>200</code> (executed), <code>201</code> (completed)</td>
</tr>
<tr>
<td>ğŸ—„ï¸ Registry</td>
<td>ShimCache, BAM/DAM</td>
<td>ğŸ”‘ <code>Microsoft\Windows NT\CurrentVersion\Schedule\TasksCache\Tasks</code><!-- raw HTML omitted -->ShimCache, AmCache</td>
</tr>
<tr>
<td>ğŸ“‘ File System</td>
<td>Prefetch</td>
<td>Prefetch<!-- raw HTML omitted -->ğŸ“‚ <code>C:\Windows\System32\Tasks</code> (newer) and ğŸ“‚ <code>C:\Windows\Tasks</code> containing <code>.job</code> (binary) or <code>.xml</code> files</td>
</tr>
</tbody>
</table>
<h3 id="wmi">WMI</h3>
<blockquote>
<p>âœğŸ» T1047 MITRE ATTACK</p>
</blockquote>
<p>This tool&rsquo;s artefacts usually reside mostly in RAM. Also, it uses WBEM protocol, and thus, it&rsquo;s tricky to eavesdrop on this connection. If no WinRM - network forensics is an option.</p>
<blockquote>
<p>âœğŸ» CIM - common info model, shows object-relationships information.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="err">ğŸ“•</span> <span class="n">wmic</span> <span class="p">/</span><span class="n">node</span><span class="err">:</span><span class="n">host</span> <span class="p">/</span><span class="n">user</span> <span class="n">uname</span> <span class="k">process</span> <span class="n">call</span> <span class="n">create</span> <span class="s2">&#34;path\to\exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="err">ğŸ“•</span> <span class="nb">Invoke-WmiMethod</span> <span class="n">-Computer</span> <span class="n">host</span> <span class="n">-Class</span> <span class="n">Win32_Process</span> <span class="n">-Name</span> <span class="n">create</span> <span class="n">-Argument</span> <span class="s2">&#34;better\be\a\good\argument.exe&#34;</span>
</span></span></code></pre></div><p>Look out for the following executables <code>wmic</code> being invoked (on the source), along with <code>srccons</code>, <code>mofcomp</code>, <code>wmiprvse</code> and some custom names limited to the attacker&rsquo;s quirky whims (on the target).</p>
<p>ğŸ›¡ï¸<code>Security</code>, ğŸ‰ <code>Microsoft-Windows-WMI-Activity%4Operational</code></p>
<table>
<thead>
<tr>
<th>ğŸº Artefact</th>
<th>ğŸš° Source</th>
<th>ğŸ¯ Target</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸªµ Event logs</td>
<td>ğŸ›¡ï¸ <code>4648</code> (alternate creds)</td>
<td>ğŸ›¡ï¸<code>4624</code> type <code>3</code>, <code>4672</code> (admin)</td>
</tr>
<tr>
<td>ğŸ—„ï¸ Registry</td>
<td>ShimCache, BAM/DAM, AmCache</td>
<td>ğŸ‰ <code>5857</code> (start or stop, path to provider DLL), <code>5860</code>/<code>5861</code> (temp/permanent Event Consumer created), ShimCache, AmCache, Prefetch</td>
</tr>
<tr>
<td>ğŸ“‘ File System</td>
<td>Prefetch</td>
<td><code>mof</code> files, unauthorised changes to <code>C:\Windows\System32\wbem\Repository</code></td>
</tr>
</tbody>
</table>
<h3 id="powershell-remote">PowerShell Remote</h3>
<blockquote>
<p>âœï¸ Close to SSH, traffic is also encrypted.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="err">ğŸ“•</span> <span class="nb">Enter-PSSession</span> <span class="n">-ComputerName</span> <span class="n">host</span> <span class="n">-Credential</span> <span class="n">uname</span>
</span></span><span class="line"><span class="cl"><span class="err">ğŸ“•</span> <span class="nb">Invoke-Command</span> <span class="n">-ComputerName</span> <span class="n">host</span> <span class="n">-ScriptBlock</span> <span class="p">{</span> <span class="nb">Start-Process</span> <span class="p">\</span><span class="n">path</span><span class="p">\</span><span class="n">to</span><span class="p">\</span><span class="k">process</span><span class="p">}</span>
</span></span></code></pre></div><p>ğŸªµ Logs: ğŸ›¡ï¸ <code>Security</code>, ğŸŒ <code>Microsoft-Windows-PowerShell</code> and ğŸ¥ <code>Microsoft-Windows-WinRM</code>.</p>
<p>âš™ï¸ Processes: <code>powershell.exe</code></p>
<table>
<thead>
<tr>
<th>ğŸº Artefact</th>
<th>ğŸš° Source</th>
<th>ğŸ¯ Target</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸªµ Event logs</td>
<td>ğŸ›¡ï¸ <code>4648</code><!-- raw HTML omitted -->ğŸ¥ <code>6</code> -WSMan Session init (dhost, dIP, c_user, timestamp), 8, 15, 16, 33 - deinit<!-- raw HTML omitted --> ğŸŒ 40691, 40692, 8193, 8194, 8197</td>
<td></td>
</tr>
<tr>
<td>ğŸ—„ï¸ Registry</td>
<td>ShimCache, BAM/DAM, AmCache</td>
<td></td>
</tr>
<tr>
<td>ğŸ“‘ File System</td>
<td>Prefetch</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="registry">Registry</h3>
<blockquote>
<p>â—ï¸ Requires authentication.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="err">ğŸ“•</span> <span class="n">reg</span> <span class="n">add</span> <span class="p">\</span><span class="n">some</span><span class="p">\</span><span class="n">reg</span><span class="p">\</span><span class="n">key</span> <span class="p">/</span><span class="n">v</span> <span class="n">data</span> <span class="p">/</span><span class="n">t</span> <span class="n">REG_SZ</span> <span class="p">/</span><span class="n">d</span> <span class="s2">&#34;path\to\whatever&#34;</span>
</span></span></code></pre></div><h3 id="winrs">winrs</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="err">ğŸ“•</span> <span class="n">winrs</span> <span class="n">-r</span><span class="err">:</span><span class="n">host</span> <span class="n">-u</span><span class="err">:</span><span class="n">user</span> <span class="n">command_to_run</span>
</span></span></code></pre></div><table>
<thead>
<tr>
<th>ğŸº Artefact</th>
<th>ğŸš° Source</th>
<th>ğŸ¯ Target</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ’­ RAM</td>
<td></td>
<td><code>winrshost.exe</code></td>
</tr>
</tbody>
</table>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    Something here
</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
