<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Manual - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ü™§">
      <a href="/docs/thunting">
        <span>Threat Hunting ü™§</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ü™§">
      <a href="/docs/thunting">
        <span>Threat Hunting ü™§</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/artefacts/malware/"> üëàüèº Back to </br> Hunting Malware </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#find-malware">Find Malware</a>
      <ul>
        <li><a href="#yara">Yara</a></li>
        <li><a href="#evasion-techniques">Evasion Techniques</a></li>
      </ul>
    </li>
    <li><a href="#analysis">Analysis</a>
      <ul>
        <li><a href="#static">Static</a>
          <ul>
            <li><a href="#strings">Strings</a></li>
            <li><a href="#signed-malware">Signed Malware</a></li>
            <li><a href="#libraries-and-imports">Libraries and Imports</a></li>
            <li><a href="#32-bit-apps">32-bit Apps</a></li>
            <li><a href="#location">Location</a></li>
            <li><a href="#name">Name</a></li>
            <li><a href="#runtime-linking">Runtime Linking</a></li>
            <li><a href="#packed-executable">Packed Executable</a></li>
            <li><a href="#hash">Hash</a></li>
            <li><a href="#byte-level-signatures">Byte-level signatures</a></li>
            <li><a href="#owners">Owners</a></li>
            <li><a href="#parent-process">Parent Process</a></li>
            <li><a href="#process-taken-over">Process taken over</a></li>
            <li><a href="#on-disk-vs-ram">On-disk vs RAM</a></li>
            <li><a href="#behaviour">Behaviour</a></li>
            <li><a href="#singletons">Singletons</a></li>
            <li><a href="#boot-time">Boot time</a></li>
            <li><a href="#pid">PID</a></li>
          </ul>
        </li>
        <li><a href="#dynamic">Dynamic</a>
          <ul>
            <li><a href="#troubleshooting">Troubleshooting</a></li>
          </ul>
        </li>
        <li><a href="#how-to-find-out-">How to find out &hellip;</a></li>
      </ul>
    </li>
    <li><a href="#malware-as-an-artefact">Malware as an Artefact</a>
      <ul>
        <li><a href="#pdb">PDB</a></li>
        <li><a href="#strings-1">Strings</a></li>
        <li><a href="#meta">Meta</a></li>
        <li><a href="#resources">Resources</a></li>
      </ul>
    </li>
    <li><a href="#evidence">Evidence</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Manual</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 26.05.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <h2 id="find-malware">Find Malware</h2>
<table>
<thead>
<tr>
<th>How to detect</th>
<th>Active Malware</th>
<th>Dormant Malware</th>
<th>Living-Off the Land</th>
</tr>
</thead>
<tbody>
<tr>
<td>IoC</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
<td>‚úÖ (if you know more details, of course)</td>
</tr>
<tr>
<td>Triage or EDR artefacts and logs</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Timeline Analysis</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Targeted Single Host forensic</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Signature-based (AV, rules, parsers)</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
<td>‚õîÔ∏è</td>
</tr>
<tr>
<td>Process Anomalies (malware processes)</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
<td>‚õîÔ∏è</td>
</tr>
<tr>
<td>Malware Persistence</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
<td>‚õîÔ∏è</td>
</tr>
<tr>
<td>MFT and FS anomalies</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
<td>‚õîÔ∏è</td>
</tr>
<tr>
<td>Anti-forensics residue</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
<td>‚õîÔ∏è</td>
</tr>
<tr>
<td>Memory Analysis</td>
<td>‚úÖ</td>
<td>‚õîÔ∏è (not in memory yet, so, not possible)</td>
<td>‚õîÔ∏è‚ùì(if you know your Normal vs Evil for the system, might be possible)</td>
</tr>
<tr>
<td>Process Anomalies (automated processes)</td>
<td>‚úÖ</td>
<td>‚õîÔ∏è (not in memory yet, so, not possible)</td>
<td>‚õîÔ∏è ‚ùì(if you know your Normal vs Evil for the system, might be possible)</td>
</tr>
</tbody>
</table>
<p>There are two main analysis vectors for malware search: common persistence mechanism for the system, network connections and RAM. Below is the cheat sheet to use to find suspicious files. Each indicator is not 100%, but you can add scores and reverse engineer only those highly suspicious to save time.</p>
<p>Maybe it was removed, or it&rsquo;s stealthy. Or it&rsquo;ll be too hard. Things that are left behind. The same artefacts that with processes in general (User Activity). There must be some signs that the malware was started (like, startup locations), run (logs, dump, registry etc.) and shut down (process termination logs, crash dumps, remnants in RAM etc.).</p>
<ul>
<li><input disabled="" type="checkbox"> <strong>Persistence mechanisms</strong>. There are dozens of ways one can become persistent on a machine. Refer to the persistence mechanisms in the attacks section for more details.</li>
<li><input disabled="" type="checkbox"> <strong>RAM</strong>. This one is the best bet to find a rootkit (but not 100% fail-proof)</li>
<li><input disabled="" type="checkbox"> <strong>Network triage</strong>. Examine connections (opened, closed, attempted), filtering out Internal addresses. Check for remote connections. External IPs reputations. üõ† <code>hostintel</code>.
<ul>
<li><input disabled="" type="checkbox"> Find the executables initiating these connections.</li>
<li><input disabled="" type="checkbox"> Port-services mismatch or unusual ports or services. For example, an unusual port for FTP is 42678.</li>
<li><input disabled="" type="checkbox"> How frequently is the host connecting to another machine? For how long? It could be something legitimate. But if it&rsquo;s recent or/and not regular - it could be an indicator.</li>
<li><input disabled="" type="checkbox"> Unusual application names, paths, typos or poker hand ports (<code>44488</code> <code>12345</code> or like). Or may some gibberish characters‚Äîspecific protocols - <code>1</code> (ICMP) <code>6</code> (TCP) <code>70</code> (UDP). Look for the ports outside of these three.</li>
</ul>
</li>
</ul>
<p>When the process in question seems worth the time to be looked into, check what processes, dynamic libraries, handles, files and network connections were used by the suspicious process. So, you are pivoting around this suspicious process.</p>
<h3 id="yara">Yara</h3>
<p><a href="https://medium.com/bugbountywriteup/intro-to-malware-detection-using-yara-eacab8373cf4">Yara</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew install yara
</span></span><span class="line"><span class="cl">pip install yara-python
</span></span></code></pre></div><p>Repo for <a href="https://github.com/InQuest/awesome-yara">malware</a> and <a href="https://github.com/Xumeiquer/yara-forensics">forensics</a>. YaraGen.</p>
<h3 id="evasion-techniques">Evasion Techniques</h3>
<p>Malware is not always going to shout out loud, revealing its location. It doesn&rsquo;t want to be detected, so it will use different tools from the arsenal to avoid being detected. Below are standard techniques. A more detailed explanation is in the corresponding section.</p>
<ul>
<li><input disabled="" type="checkbox"> Service Hijacking and Replacement.</li>
<li><input disabled="" type="checkbox"> Process Injection. Stealthy. Trivial identification using RAM analysis tools.</li>
<li><input disabled="" type="checkbox"> Filename/Service Hijacking.</li>
<li><input disabled="" type="checkbox"> ADS.</li>
<li><input disabled="" type="checkbox"> WebShells and Beacons.</li>
<li><input disabled="" type="checkbox"> Firmware.</li>
<li><input disabled="" type="checkbox"> DLL Injection.</li>
<li><input disabled="" type="checkbox"> A/V Bypass.</li>
<li><input disabled="" type="checkbox"> Defense Manipulation.</li>
<li><input disabled="" type="checkbox"> Frequent Compilation.</li>
<li><input disabled="" type="checkbox"> Binary Padding.</li>
<li><input disabled="" type="checkbox"> Armouring. It&rsquo;s helpful to avoid A/V but very suspicious and easy to spot‚Äîexamples: packed malware, polymorphic.</li>
<li><input disabled="" type="checkbox"> Dormant Malware üí§.  <em>I&rsquo;ll think about that tomorrow. Tomorrow is another day.</em> (c, Gone With The Wind).</li>
<li><input disabled="" type="checkbox"> They are signing Code with Valid Cert. Thawte and Verisign are responsible for issuing certificates for malware.</li>
<li><input disabled="" type="checkbox"> Anti-Forensics/Timestamping. Timestamping is used to modify the timestamps of a file.</li>
<li><input disabled="" type="checkbox"> Rootkits.</li>
<li><input disabled="" type="checkbox"> &ldquo;Fileless&rdquo; Malware.</li>
</ul>
<h2 id="analysis">Analysis</h2>
<p>For details on reverse engineering - refer to the Reverse üîß section of this website. I will only look into the simple static and dynamic analysis (using tools without running the file and running it- to see where it poos üí©).</p>
<p>In the first step covered in the &ldquo;Find Malware&rdquo; paragraph, we only find suspicious stuff, not always; we can be 100% sure it&rsquo;s malware. Here are some common malware indicators.</p>
<p><strong>SANS Six-Part Methodology</strong>, used to identify malicious processes:</p>
<ul>
<li><input disabled="" type="checkbox"> Identify rogue processes</li>
<li><input disabled="" type="checkbox"> Analyse DLLs and handles.</li>
<li><input disabled="" type="checkbox"> Review network artefacts</li>
<li><input disabled="" type="checkbox"> Look for code injection.</li>
<li><input disabled="" type="checkbox"> Check for any signs of a rootkit.</li>
<li><input disabled="" type="checkbox"> Dump suspicious process and drivers.</li>
</ul>
<h3 id="static">Static</h3>
<ul>
<li><code>.rsrc</code> section usually contains such resources as icons, pictures etc. However, some malicious programs (as well as legitimate ones) can store a driver or other code there, which gets extracted and executed by the main program flow.</li>
</ul>
<h4 id="strings">Strings</h4>
<p>Check <strong>strings</strong> in <code>Image</code> and in <code>Memory</code> using the corresponding radio button on the <code>Strings</code> tab of a selected process info in Process Explorer. If they differ - process replacement tool place. Use üõ† <code>strings</code> or <code>floss</code> (decodes them as well)</p>
<p>Interesting strings:</p>
<ul>
<li><code>pdb</code> files (often contain username and can also give a hint on the malware writer&rsquo;s country of origin)</li>
<li>URLs</li>
<li>Something that looks like a password</li>
<li>emails</li>
<li>Base64 encoded things</li>
<li>library names</li>
</ul>
<h4 id="signed-malware">Signed Malware</h4>
<p>It&rsquo;s a rare case, but it exists. Around 3% of malware is <strong>signed</strong>. It&rsquo;s because some systems require executables to be signed. But this technique is not very good for malware authors since when at least one &ldquo;product&rdquo; is marked as malicious, all code signed with the same certificate will also be identified. üõ† Use <code>sigcheck</code> to check signatures and hashes against Virus Total.</p>
<p>Check with a <code>spctl</code> if Apple notarises the application (not yet installed).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">spctl -a -vvv -t install /Volumes/BurpSuitePro/Burp<span class="se">\ </span>Suite<span class="se">\ </span>Professional.app 
</span></span><span class="line"><span class="cl">/Volumes/BurpSuitePro/Burp Suite Professional.app: accepted
</span></span><span class="line"><span class="cl"><span class="nv">source</span><span class="o">=</span>Notarized Developer ID
</span></span><span class="line"><span class="cl"><span class="nv">origin</span><span class="o">=</span>Developer ID Application: PortSwigger Ltd <span class="o">(</span>N82YM897DZ<span class="o">)</span>
</span></span></code></pre></div><h4 id="libraries-and-imports">Libraries and Imports</h4>
<ul>
<li>On Windows systems, some functions have the suffix <code>A</code> or <code>W</code>. These indicate that this function accepts ASCII or wide-character strings as an argument.</li>
<li>On Windows systems, some functions have a suffix <code>Ex</code> or even <code>ExEx</code>. These indicate that Windows has released a new version of a function incompatible with older ones since older ones must be supported.</li>
<li>You can use this web resource to understand WinAPI functions that are used by malware - <a href="https://malapi.io/">https://malapi.io/</a>. Remember, these are legit WinAPI functions and they are also used by legit software.</li>
</ul>
<h4 id="32-bit-apps">32-bit Apps</h4>
<p>For backward compatibility with older machines, malware authors prefer compiling 32-bit applications. Since malware authors usually want their software to work on as many machines as possible, they often compile 32-bit code**. That&rsquo;s not a decent indicator but an excellent additional score.</p>
<h4 id="location">Location</h4>
<p>It might be atypical location for <code>svchost.exe</code> in Documents forlder. You&rsquo;ll need to know what&rsquo;s ok and good for the given system. May user SANS poster <em>Find Evil</em>. Common locations for malware: <code>Windows\System32</code> is a very important location since it allows running with elevated privileges? ‚ùì‚ùì‚ùìAlso <code>Temp</code> folder and <code>Temp Internet Files</code>. <code>Windows</code>, <code>Windows SxS</code>. Recycle bin also may contain some files or remnants. <code>Program files</code> is the most usual for programs and malware may reside there as well.<code>System Volume Information</code>. That doesn&rsquo;t mean, however, that malware can&rsquo;t be elsewhere. Some core Windows executables don&rsquo;t even have an image file on disk (System, IDLE, for example).</p>
<h4 id="name">Name</h4>
<p>For example, name precisely like or very similar to some core system process? Is the strange name similar to the legit one? <code>svchosts</code>, for example. Present in <code>psscan</code> but absent in <code>pslist</code> (for running processes)? Read more about RAM forensics in the corresponding section. It&rsquo;s usual for malware to mistype the names if standard win core processes or use the same names in weird locations. Name mangling is a common technique.</p>
<p>To spot deviations at that point, you need to understand what&rsquo;s normal for that particular system. There are some common &ldquo;normalities&rdquo; for different OS, of course. You can refer to the SANS poster &ldquo;Find Evil&rdquo;, which is often updated, the SDF Podcast of Michael Leclair about Windows Core Processes, or find the corresponding article about core processes and system supernova in the Technical Reference section of this website.</p>
<h4 id="runtime-linking">Runtime Linking</h4>
<p>Since static linking is rare (it increases the body of a program) and dynamically linked functions can be inspected differently, runtime linking might be a choice for malware authors to hide the functionality. How to determine if the runtime linking is used?<em>‚ùìWindows, Mac, Linux?</em> <strong>Importing</strong> and using <code>GetProcessAddress</code>/<code>LdrGetProcessAddress</code> or/and <code>LoadLibrary</code>/<code>LdrLoadDll</code>.</p>
<h4 id="packed-executable">Packed Executable</h4>
<p>Almoust 100% indicator that the author didn&rsquo;t want his treasure to be reverse engineered. Why could this be? Because it&rsquo;s some software with a portion of client-side code that performs sensitive operations. One example of a legitimate software is a program that generates OTP codes. There are several ways to determine that a file is packed. The first one - using enthropy analysis against the file. Consider, that most program epilogues start with <code>55 8B EC</code> (<code>push ebp mov ebp, esp</code>) and end with <code>c3</code> (<code>ret</code>).  That means that the number of both in one executable should be relatively the same. Compressed files don&rsquo;t compress well. Another example is to pack the file and determine, how efficiently was it packed. If it wasn&rsquo;t possible to pack the file too much, it&rsquo;s probable that the file is already packed. üõ† Use the first method with <a href="https://www.aldeid.com/wiki/PEiD">PEiD</a> (GUI Windows tool), use the second method with <code>densityscan</code> (commercial cross-platform tool). Below are some common preliminary indicators of packed executables:</p>
<ul>
<li><input disabled="" type="checkbox"> <strong>VA vs PA</strong>. Empty Physical addresses for sections (while VA are not empty). More about virtual and physical addresses in the reverse engineering section.</li>
<li><input disabled="" type="checkbox"> Weired names for <strong>PE sections</strong>. PE sections (for Windows) are usually <code>text</code>, <code>bss</code>, <code>data</code> etc. If you some gibberish that&rsquo;s not usually seen here, most likely the executable is packed.</li>
</ul>
<h4 id="hash">Hash</h4>
<p>Check the file hash against the VirusTotal database. This way you&rsquo;ll eliminate <strong>known good</strong> files, since it&rsquo;s highly unlikely that a legitimate software like Windows files have never been checked so far. Also, this way you can find <strong>known bad</strong>.</p>
<h4 id="byte-level-signatures">Byte-level signatures</h4>
<p>You may have some signatures left from previous malware.</p>
<h4 id="owners">Owners</h4>
<p>Check the account it being run from. The most commonly used are: local system account, network service account, local service account. If any of the core processes is run from a user account, it&rsquo;s a possible sign of compromise.</p>
<h4 id="parent-process">Parent Process</h4>
<p>Some other executable runs each executable. For core processes, there is only one legitimate parent. üë£ <strong>For Windows</strong>: <code>wininit</code> doesn&rsquo;t have a parent, while <code>sms.exe</code> is the child of System. Read more about core processes for each specific OS in a separate section.</p>
<h4 id="process-taken-over">Process taken over</h4>
<p><a href="https://www.linkedin.com/pulse/process-injection-detection-malfind-britton-manahan/">https://www.linkedin.com/pulse/process-injection-detection-malfind-britton-manahan/</a></p>
<h4 id="on-disk-vs-ram">On-disk vs RAM</h4>
<p>On-disk and in-memory contents don&rsquo;t match.</p>
<h4 id="behaviour">Behaviour</h4>
<p>Suspicious files opened, network ports and connections, OS resources (mutexes, hooks etc), a significant amount of CPU or RAM? <code>.rsrc</code> section usually contains such resources as icons, pictures etc. However, some malicious programs (as well as legitimate ones) can store a driver or other code there, which gets extracted and executed by the main program flow. If you suspect that a dynamically linked library was loaded into a process after load time, compare the import list in <a href="/docs/toolkit/general/reverse-toolkit/#process-explorer">Process Explorer</a> to the imports shown in <a href="/docs/toolkit/general/reverse-toolkit/#dependency-walker">Dependency Walker</a> (Windows, for other OS use analogous tools). <code>radare2</code> and <code>IDA</code> can also show imports.</p>
<p>One of the useful resources (Windows API docs, of course) also <a href="https://malapi.io/">https://malapi.io/</a> (from the malware perspective).</p>
<p>If your detection engine says there is an injection technique being used - most likely it&rsquo;s malware. <a href="https://www.linkedin.com/pulse/process-injection-detection-malfind-britton-manahan/">https://www.linkedin.com/pulse/process-injection-detection-malfind-britton-manahan/</a></p>
<p>üî• An awesome resource to help with malware analysis - <a href="https://unprotect.it/technique/evasion-using-direct-syscalls/">https://unprotect.it/technique/evasion-using-direct-syscalls/</a>.</p>
<h4 id="singletons">Singletons</h4>
<p>One instance running only. üë£ <strong>For Windows</strong>: One instance <code>lsass</code>, <code>services</code>, <code>System</code>, <code>winint</code>, <code>lsm.exe</code> ‚ùì. If any of these have more than 1 process should be the object of further investigation.</p>
<h4 id="boot-time">Boot time</h4>
<p>Core processes boot at a certain time and in specific order after boot. Anomalies here might be a good indicator of compromise. üë£ <strong>For Windows</strong>: <code>sms</code> starts at boot, for example.</p>
<h4 id="pid">PID</h4>
<p>Some core processes might have a predefined PID. üë£ <strong>For Windows</strong>: The system usually has PID 4.</p>
<h3 id="dynamic">Dynamic</h3>
<p>Funny enough, malware can sometimes only run with massive help. Usually, that happens when there is an OS mismatch, some lib is missing from the machine, or simply a bug in the code itself. Ironically, we need to help it do its job in this case. So, how to troubleshoot malware?</p>
<h4 id="troubleshooting">Troubleshooting</h4>
<p><strong>DLL to EXE</strong>. DLLs are dependent processes on Windows and, under normal circumstances, can&rsquo;t run independently. This complicates the analysis, and we want to save time. There are two ways (that I know of) that can make the DLL think it&rsquo;s an EXE:</p>
<ol>
<li>use <code>rundll32</code> (<code>rundll32 [dllname].dll, [function name or ordeal]</code>). For example, a <code>malware.dll</code>  has the function <code>InstallService</code>, which requires an argument service name. We want to launch it, call this function to create a service named &ldquo;MaliciousService&rdquo;: <code>rundll32 malware.dll, MaliciousService</code>. In Dependency Walker, we can peek the function&rsquo;s ordeal and run this command like this (if the ordeal is, say, 5): <code>rundll32 malware.dll, #5</code>.</li>
<li>patch the PE header of the DLL + change its extension. <code>IMAGE_FILE_HEADER</code> -&gt; <code>CHARACTERISTICS</code> &ndash;&gt; <code>IMAGE_FILE_DLL</code> flag <code>0x2000</code> set to <code>0x0000</code>.</li>
</ol>
<p><strong>Services</strong>. On Windows, <code>ServiceMain</code> can sometimes be missing an <code>Install</code> function. To fix this, either:</p>
<ol>
<li>Use <code>sc</code> command or</li>
<li><code>HKLM/SYSTEM/CurrentControlSet\Services</code> - modify the registry key.</li>
</ol>
<h3 id="how-to-find-out-">How to find out &hellip;</h3>
<ul>
<li>&hellip; which processes used a specific dll ‚ùì In <a href="/docs/toolkit/general/reverse-toolkit/#process-explorer">Process Explorer</a> choose <code>Find Handle or DLL</code>.</li>
<li>&hellip; if a DLL is loaded into a process after load time ‚ùì Compare the DLL list in <a href="/docs/toolkit/general/reverse-toolkit/#process-explorer">Process Explorer</a> to the imports shown in <a href="/docs/toolkit/general/reverse-toolkit/#dependency-walker">Dependency Walker</a>.</li>
<li>&hellip; if a <code>.doc</code> or <code>.pdf</code> or another document is malicious ‚ùì Open <a href="/docs/toolkit/general/reverse-toolkit/#process-explorer">Process Explorer</a>, launch the suspicios doc in sandboxed environment and check whether it has spawned any processes. Open this process&rsquo;s <code>Properties</code> window, <code>Image</code> tab to check the location of the malware file.</li>
<li>If there is an open socket, you can open <code>nc -nv &lt;IP&gt; &lt;port&gt;</code> to see what it wants to get.</li>
<li>If the malware is looking for a DNS record and iNetSim doesn&rsquo;t work (because it&rsquo;s something very custom), try adding <code>127.0.0.1  &lt;DNS name&gt;</code> and observing the activity with a tool like ProcMon. Then, do <code>ncat -nvlp &lt;port&gt;</code>. Try <code>ipconfig /flushdns</code> (Windows) if this doesn&rsquo;t help.</li>
<li>If process injection took place, find the victim in Process Hacker (or some analogue) and open Properties -&gt; Memory. Sort by Protection and find all that have RWX permissions (that&rsquo;s usually what a shellcode will require to run). No name in the Use column usually indicates.
Here is a separate section devoted to malware analysis methodology, tips, etc..</li>
</ul>
<h2 id="malware-as-an-artefact">Malware as an Artefact</h2>
<p>The attacker leaves malware, so it&rsquo;s a trace of their activity. Type of malware, location found etc., sometimes can hint at the actor.</p>
<h3 id="pdb">PDB</h3>
<h3 id="strings-1">Strings</h3>
<h3 id="meta">Meta</h3>
<h3 id="resources">Resources</h3>
<ul>
<li><code>.rsrc</code> section usually contains such resources as icons, pictures etc. However, some malicious programs (as well as legitimate ones) can store a driver or other code there, which gets extracted and executed by the main program flow.</li>
</ul>
<h2 id="evidence">Evidence</h2>
<ul>
<li><input disabled="" type="checkbox"> Passwords</li>
<li><input disabled="" type="checkbox"> Names</li>
<li><input disabled="" type="checkbox"> Paths</li>
</ul>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    <h3 id="tools">Tools</h3>
<ul>
<li>ProcMon (Sysinternals) for Windows and Glances for macOS <a href="https://nicolargo.github.io/glances/">https://nicolargo.github.io/glances/</a>, osquery, Instruments, vtop. Also try <code>opensnoop</code>, but with SIP off.</li>
</ul>
<h3 id="repos">Repos</h3>
<ul>
<li>theZoo:¬†<a href="https://github.com/ytisf/theZoo">https://github.com/ytisf/theZoo</a></li>
<li>VXUnderground GitHub repo:¬†<a href="https://github.com/vxunderground/MalwareSourceCode">https://github.com/vxunderground/MalwareSourceCode</a></li>
<li>Zeltser Resources:¬†<a href="https://zeltser.com/malware-sample-sources/">https://zeltser.com/malware-sample-sources/</a></li>
<li></li>
</ul>
<h3 id="info">Info</h3>
<p>Try MISP API - <a href="https://www.misp-project.org/openapi/#tag/Attributes/operation/restSearchAttributes">https://www.misp-project.org/openapi/#tag/Attributes/operation/restSearchAttributes</a>.</p>
<p><a href="https://www.hybrid-analysis.com/sample/9fe55c51af6230c8640e140104645b32ba83ac868bf0f1571733f14761701247">https://www.hybrid-analysis.com/sample/9fe55c51af6230c8640e140104645b32ba83ac868bf0f1571733f14761701247</a>
<a href="https://www.f-secure.com/v-descs/trojan-spy_w32_finspy_a.shtml">https://www.f-secure.com/v-descs/trojan-spy_w32_finspy_a.shtml</a>
<a href="https://malshare.com/">https://malshare.com/</a></p>
<p>Malicious websites: <a href="https://zeltser.com/lookup-malicious-websites/">https://zeltser.com/lookup-malicious-websites/</a></p>
<p><a href="https://mail.google.com/mail/u/0/#inbox">https://mail.google.com/mail/u/0/#inbox</a></p>
<p>My <a href="https://peat-chameleon-e41.notion.site/Malware-DB-25248c9f91bd49b8ba0e869f465f626a">own</a> is maintained in Notion for now. Planning to turn this into a SQL DB + CLI.</p>
<h3 id="network">Network</h3>
<p><a href="https://malware-traffic-analysis.net">https://malware-traffic-analysis.net</a>
<a href="https://packettotal.com/malware-archive.html">https://packettotal.com/malware-archive.html</a></p>

</details>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
