<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ShellBag - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/artefacts/win/registry/"> 👈🏼 Back to </br> 🏺 Windows Registry </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">ShellBag</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 01.06.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p><em>To open a file, one needs to perform a delightful jaunt to a directory where those files reside. Now picture this: imagine if we could keep a journal of all the full paths of the folders visited; wouldn&rsquo;t that be splendid? It so happens that this nice functionality does exist on Windows machines and ShellBags they are called. Since these folders can be located on a remote machine, a USB drive or any other external media, this artefact can be used to make assumptions about remote connections and devices attached.</em></p>
<p>📑 <code>USRCLASS.DAT</code>,  🔑 <code>\Local Settings\Software\Microsoft\Windows\Shell\BagMRU</code>, subkeys: <code>MRUListEx</code>, <code>NodeSlot</code>, <code>Subkeys</code> and 🔑 Local Settings\Software\Microsoft\Windows\Shell\Bags, subkeys: <code>Shell</code>, will have folder&rsquo;s GUID.</p>
<p><code>volatility.exe -f memory.dmp --profile=Win7SP1x64 shellbags</code></p>
<p><code>Created On</code>: when the folder was created/moved/renamed. The last accessed and created timestamps are sometimes the same. The last modified timestamp is when the preferences were last changed (window resized, view options changed). Mind if it’s UTC or GMT. Also, this data might be updated with a little lag. <code>Last key write time</code> is the ShellBag&rsquo;s timestamp.</p>
<blockquote>
<p>⛔️ Shortcuts MAC times are not updated!</p>
<p>⛔️ Fat16 only records date. No time. So the <code>Last accessed</code> time for a fat16 formatted folder will be <code>00:00:00.000</code>. It&rsquo;s more usual for a USB removable media.</p>
</blockquote>
<p><code>Created On</code>, <code>Modified On</code>, and <code>Last accessed on</code> are all FS timestamps ❗️❗️❗️ However, <code>Registry last write time</code> is its own timestamp, and it seems to be updated even when no preferences were changed.</p>
<p>Track Windows folder settings (how the view is set), track zip files, and folder access, even if the information was deleted. It can also show folders on removable media. This data is initially slightly confusing but can be digested in a few minutes. One important thing to note is that both keys are interconnected. I&rsquo;ve used arrows, squares and circles to mark data corresponding to each for better visualisation below. Sometimes, additional info for the NTFS filesystem will be available (MFT record number) and file system type as well, not always, however.</p>
<blockquote>
<p>⚠️ Proves that the user interacted with these folders if found in ShellBags but not on the system.</p>
<p>❓ How about when being hacked? A hacker might delete the folder.</p>
</blockquote>
<p>Right under <code>BagMRU</code> subkey, there is only one subkey (in this case, in the case of shell bags, a folder): <code>0</code>.  <code>MRUListEx</code> contains a list of folders inside this one identified by sequence numbers. In our example, there are only three subfolders (and, hence, values in the list) in this folder: <code>00 00 00 00</code>, just <code>0</code> in little-endian (green), <code>01 00 00 00</code>, just <code>1</code> in little-endian (orange) and <code>02 00 00 00</code>, just <code>2</code> in little-endian (purple). Above the <code>MRUListEx</code> are three values in our case, each corresponding to the subfolder and containing a folder path and name. In the example below, the <code>0</code> subfolder&rsquo;s value is expanded and marked with a green circle.</p>
<p>Each of these folders in the list will have a corresponding subkey inside our <code>0</code> subkey/folder (marked with arrows on the left).</p>
<p><img src="images/shell-bag.png" alt="shell-bag"></p>
<p>So, we have a parent folder info, what folders it contains, and the paths to them. Now, since ShellBags store folder settings, where are they? Under the second subkey, <code>Bags</code>. But since sequence numbers are also used here, how do we find the folder we need? Are these sequence numbers the same as in the picture above? The answer is <em>no</em>. In the picture above, they were numbering restarts from <code>0</code> for each folder&rsquo;s subfolders so that each folder with at least one subfolder will have at least <code>0</code> value and a <code>0</code> subkey. However, the <code>Bags</code> subkeys number folders sequentially. Each subkey representing a folder in a <code>BagMRU</code> subkey we&rsquo;ve seen above will have a value <code>NodeSlot</code>. This is a number it&rsquo;s identified within <code>Bags</code> subkey. See the below example for folder <code>0</code>.</p>
<p><img src="images/shell-bag2.png" alt="shell-bag2"></p>
<p>🛠 ShellBagsExplorer (E. Zimmerman) is a tools that helps automating this process which is useful for larger amount of data.</p>
<p><img src="images/shell-bag3.png" alt="shell-bag3"></p>
<p>The above is an example of the ShellBagsExplorer for my Windows 10 Parallels VM. Pretty user-friendly representation and lot&rsquo;s of valuable information. Note the folders on the very top: <code>\\Mac\vm</code>, <code>\\Mac\Home</code> and <code>\\Mac\AllFiles</code>. Someone who is using Paralells Windows 10 on Mac might note this at once, that this is a VM running on a Mac. Also, both <code>\\Mac\Home</code> and <code>\\Mac\AllFiles</code> are no longer available for Windows 10, but they were not deleted from the registry as you may see. That&rsquo;s because when folders are deleted, they are not deleted from here, at least not soon.</p>
<p><strong>Key</strong> 🔑 : <code>Local Settings\Software\Microsoft\Windows\Shell\BagMRU </code>. Values: <code>MRUListEx</code>, <code>NodeSlot</code>, <code>Subkeys</code>.</p>
<p><strong>Key</strong> 🔑 : <code>Local Settings\Software\Microsoft\Windows\Shell\Bags</code>. Values: <code>Shell</code>, will have folder&rsquo;s GUID.</p>
<p><code>Created On</code>: when the folder was created/moved/renamed. Last accessed and created are sometimes the same. Last modified is when the preferences were last changed (window resized, view options changed). Mind if it’s utc or gmt. Also, this data might be updated with a little lag. <code>Last key write time</code> is the ShellBag&rsquo;s timestamp.</p>
<blockquote>
<p>⚠️ Shortcuts MAC times are not updated!</p>
<p>⚠️ Fat16 only records date. No time. So the <code>Last accessed</code> time for a fat16 formatted folder will be <code>00:00:00.000</code>. It&rsquo;s more usual for a USB removable media.</p>
</blockquote>
<p><code>Created On</code>, <code>Modified On</code> and <code>Last accessed on</code> are all FS timestamps ❗️❗️❗️ However, <code>Registry last write time</code> is its own timestamp and it seems to be updated even when no preferences were changed.</p>
<p>Track Windows folder settings (how the view is set), track zip files, folder access, even if information was deleted. Can also show folders on removable media. This data is a little bit confusing at first, but can be digested in a couple of minutes. One important thing to note is that both keys are interconnected. I&rsquo;ve used arrows, squares and circles to mark data corresponding to each for better visualization on the picture below. Sometimes, additional info for NTFS filesystem will be available (MFT record number) and file system type as well, not always however.</p>
<blockquote>
<p>⚠️ Proves that the user interacted with these folders if they are found in ShellBags but not on the system.</p>
<p>❓ How about when being hacked? A hacker might delete the folder.</p>
</blockquote>
<p>Right under <code>BagMRU</code> subkey, there is only one subkey (in this case, in case of shell bags, a folder): <code>0</code>.  <code>MRUListEx</code> contains a list of folders inside this one identified by sequence numbers. In our example there are only three subfolders (and, hence, values in the list) in this folder: <code>00 00 00 00</code>, just <code>0</code> in little-endian (green), <code>01 00 00 00</code>, just <code>1</code> in little-endian (orange) and <code>02 00 00 00</code>, just <code>2</code> in little-endian (purple). Above the <code>MRUListEx</code> there are three values in our case, each corresponding to the subfolder and containing a folder path and name. In the example below the <code>0</code> subfolder&rsquo;s value is expanded and marked with a green circle.</p>
<p>Each of these folders in the list will have a corresponding subkey inside our <code>0</code> subkey/folder (marked with arrows on the left).</p>
<p><img src="images/shell-bag.png" alt="shell-bag"></p>
<p>So, we have a parent folder info, what folders it contains and the paths to them. Now, since ShellBags store folder settings, where are they? Under the second subkey, <code>Bags</code>. But since sequence numbers are used here as well, how do we find the folder we need? Are these sequence number the same as on the picture above? The answer is <em>no</em>. On the picture above numbering restarts from <code>0</code> for each folder&rsquo;s subfolders, so that each folder that has at least one subfolder, will have at least <code>0</code> value and a <code>0</code> subkey. However, the <code>Bags</code> subkeys numbers folders sequencially. Each subkey representing a folder in a <code>BagMRU</code> subkey we&rsquo;ve seen above, will have a value <code>NodeSlot</code>. This is a number it&rsquo;s identified by withing <code>Bags</code> subkey. See the below example for the folder <code>0</code>.</p>
<p><img src="images/shell-bag2.png" alt="shell-bag2"></p>
<p>🛠 ShellBagsExplorer (E. Zimmerman) is a tools that helps automating this process which is useful for larger amount of data.</p>
<p><img src="images/shell-bag3.png" alt="shell-bag3"></p>
<p>The above is an example of the ShellBagsExplorer for my Windows 10 Parallels VM. Pretty user-friendly representation and lot&rsquo;s of valuable information. Note the folders on the very top: <code>\\Mac\vm</code>, <code>\\Mac\Home</code> and <code>\\Mac\AllFiles</code>. Someone who is using Paralells Windows 10 on Mac might note this at once, that this is a VM running on a Mac. Also, both <code>\\Mac\Home</code> and <code>\\Mac\AllFiles</code> are no longer available for Windows 10, but they were not deleted from the registry as you may see. Because when folders are deleted, they are kept from here, at least not soon.</p>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    Something here
</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
