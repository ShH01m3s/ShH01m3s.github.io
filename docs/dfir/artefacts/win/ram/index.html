<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏺 RAM - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/artefacts/win/"> 👈🏼 Back to </br> 🪟 Windows Artefacts </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#ram">RAM</a>
      <ul>
        <li><a href="#get-the-profile-info-vol2">Get the Profile Info (vol2)</a></li>
        <li><a href="#convert-to-raw-mem">Convert to raw mem</a></li>
        <li><a href="#triage-of-windows-core-processes">Triage of Windows Core Processes</a></li>
        <li><a href="#analysis-example">Analysis Example</a></li>
        <li><a href="#hyperfilsys">hyperfil.sys</a></li>
        <li><a href="#pagefilesys">pagefile.sys</a></li>
        <li><a href="#vmem">VMEM</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">🏺 RAM</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 01.06.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p><em>Memory is the best evidence, although the hardest to preserve. If you recall Frozen II &ldquo;Water has memory&rdquo; - same story. Even if you delete all the evidence, memory is silently remembering all that. But it&rsquo;s so fragile&hellip;.</em></p>
<p><img src="https://media.giphy.com/media/J6DlqPpKsXeof54aaP/giphy.gif" alt="img"></p>
<p>There are several data types that can hold volatile data i.e. data about some state of RAM in time. Not all of them exist on every system:</p>
<ul>
<li><strong>RAM image.</strong> Can be acquired for all PC, there are certain complications with a Mac. Also, for mobile devices you can collect RAM data for separate processes only. For virtual machines are usually stored in a separate file once the system is suspended.</li>
<li><strong>Hibernation files</strong>. Exist on major OS (Windows, Mac, Linux). For Windows - <a href="/docs/dfir/host/reference/windows/windows-hibernation">hyberfil.sys</a>. It&rsquo;s a RAM capture made by OS itself when the PC is falling asleep 💤.</li>
<li><strong>Page files</strong>.</li>
<li><strong>Swap files</strong>.</li>
<li><strong>Crash dumps</strong>.</li>
</ul>
<p>In general, things we are going to do are specific to the case type. It case of a malware infection we will be looking for rogue processes, rootkits and other such things, while in child exploitation or insider threat  - these are not top priority. In case of child exploitation we would be more interested in some <code>png</code> or <code>jpeg</code> still residing somewhere in memory.</p>
<p>Why collect RAM?</p>
<ul>
<li><strong>User Activity</strong> &ndash;&gt; File usage and knowledge. Prove someone did something or used something. Common artefacts: Prefetch, Shimcache, Web browser, $MFT (master file table).</li>
<li><strong>Encryption</strong> &ndash;&gt;  Key files and passwords. Common tools: hashcat, passware.</li>
<li><strong>Host compromise</strong> &ndash;&gt; Processes, network activity, malware, rootkits, persistence.</li>
</ul>
<p>Hibernation files store the last state of RAM before &ldquo;falling asleep&rdquo; 💤 . These files are of a particular value when live acquisition is impossible.</p>
<p>🛠 Belkasoft RAM Capturer. ~4Mb footprint in RAM, slow. Magnet RAM Capturer - huge footprint, fast. Dumpit - the fastest, the smallest footprint (didn&rsquo;t work on Win10 on a VM Parallels on macOS). All of the aforementioned tools run in kernel mode! FTK Imager - big footprint, <strong>user mode</strong>, doesn&rsquo;t work on VM (in my case). Benchmark the tools yourself from time to time. Redline, Fast Dump (<code>fdpro.exe</code>). Sumuri&rsquo;s Interception (included with Paladin). Exploits some memory bug on some OS for machines that have either Thunderbolt or a Firewire to overwrite the admin&rsquo;s password in memory.</p>
<p><strong>Malfind</strong>. <a href="https://www.linkedin.com/pulse/process-injection-detection-malfind-britton-manahan/">https://www.linkedin.com/pulse/process-injection-detection-malfind-britton-manahan/</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">‘<span class="se">\\</span>.<span class="se">\P</span>hysicalMemory’<span class="p">;</span> a second device, ‘<span class="se">\\</span>.<span class="se">\D</span>ebugMemory’
</span></span><span class="line"><span class="cl">C:<span class="se">\h</span>iberfil.sys
</span></span><span class="line"><span class="cl">C: <span class="se">\p</span>agefile.sys
</span></span><span class="line"><span class="cl">C:<span class="p">|</span> swapfile. sys
</span></span><span class="line"><span class="cl">C: Windows<span class="se">\ </span>memory.dmp
</span></span></code></pre></div><h2 id="ram">RAM</h2>
<h3 id="get-the-profile-info-vol2">Get the Profile Info (vol2)</h3>
<p><img src="images/vol_py_imageinfo_mem_udemy%201.png" alt="vol_py_imageinfo_mem_udemy"></p>
<p>Purple square - Service pack. Green - correct profile with the correct service pack.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vol.py -f hiberfil.sys --profile<span class="o">=</span>Win7SP0x86 imagecopy -O hyber.raw
</span></span></code></pre></div><p>Then validate the file by listing processes that were run:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vol.py -f hiberfil.raw pslist --profile<span class="o">=</span>Win7SP0x86
</span></span></code></pre></div><p>Size up to 75% of memory size.</p>
<p><img src="images/vol_py_pslist_udemy%201.png" alt="vol_py_pslist_udemy"></p>
<p>imagecopy plugin is used to convert some file type into .raw. It decreases the time, needed to analyse the file.</p>
<h3 id="convert-to-raw-mem">Convert to raw mem</h3>
<p><code>hiberfil</code> files are not as common, but just as good. <code>imagecopy</code> plugin converts different formats into <code>raw</code> format to speed up. Also saves up to 75% of memory size, therefore decreases the time for analysis.  First, determine the OS profile (for vol2) and run the plugin. Example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vol.py -f hiberfil.sys --profile<span class="o">=</span>Win7SP0x86 imagecopy -O hyber.raw
</span></span></code></pre></div><p>How to get the correct profile since <code>imageinfo</code> gives you several options and <code>kdbscan</code> gives even more? Below is the output from <code>imageinfo</code>. Purple square shows service pack version and the green one - the correct profile with the correct service pack. Other two suggested profiles have some service packs versions appened to the end.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vol.py -f crash.dmp --profile<span class="o">=</span>Win7SP2x64 imagecopy -O crash2mem.raw
</span></span><span class="line"><span class="cl">vol.py -f hyberfil.sys --profile<span class="o">=</span>Win7SP2x64 imagecopy -O hibir2mem.raw
</span></span></code></pre></div><p>Running <code>vol.py imageinfo -f hiberfil.sys</code>, for example, is slow and inefficient. No profiles were suggested. But when we have a live capture of a system, we can use this dump to determine the profile to perfom actions with the right profile on <code>hyberfil.sys</code>.</p>
<h3 id="triage-of-windows-core-processes">Triage of Windows Core Processes</h3>
<p>Deviations = investigative leads. <strong>Core Processes</strong> - essential for Win, run on any Win system under examination.</p>
<p><img src="images/standart-proc-win.png" alt="standart-proc-win"></p>
<ul>
<li>check names</li>
<li>parent (for example, <code>svchost.exe</code> is started by <code>services.exe</code>)</li>
<li>expected path</li>
<li>Singleton?</li>
<li>Account (local system, mane, users)</li>
<li>start time (boot time, later)</li>
</ul>
<p><code>svchost.exe</code> - the most abused process. Check for above deviations in the result.</p>
<p>Check <strong>parent</strong> processes of core processes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">grep -E -i <span class="s2">&#34;(system|wininit|lsass|lsm|services|sms|taskhost|winlogon|iexplore|explorer|svchost|csrss)&#34;</span> pslist.txt &gt; pslist-all-core.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">grep -E -i <span class="s2">&#34;(system|wininit|lsass|lsm|services|sms|taskhost|winlogon|iexplore|explorer|svchost|csrss)&#34;</span> psscan.txt &gt; psscan-all-core.txt
</span></span></code></pre></div><p>Check <strong>names</strong> of non-win processes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">grep -E -i -v <span class="s2">&#34;(system|wininit|lsass|lsm|services|sms|taskhost|winlogon|iexplore|explorer|svchost|csrss)&#34;</span>  pslist.txt &gt; pslist-all-non-wincore.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">grep -E -i -v <span class="s2">&#34;(system|wininit|lsass|lsm|services|sms|taskhost|winlogon|iexplore|explorer|svchost|csrss)&#34;</span>  psscan.txt &gt; psscan-all-non-wincore.txt
</span></span></code></pre></div><p>Check known <strong>singletons</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">grep -E -i <span class="s2">&#34;(system|wininit|lsass|services|lsm)&#34;</span> pslist.txt &gt; pslist-all-singletons.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">grep -E -i <span class="s2">&#34;(system|wininit|lsass|services|lsm)&#34;</span> psscan.txt &gt; psscan-all-singletons.txt
</span></span></code></pre></div><p><img src="images/pslist-singletons.png" alt="pslist-singletons"></p>
<p>In the example above there are two <code>lsass.exe</code> processes which is nonsense. Obviously, some investigative lead.</p>
<p>Check <strong>bootimes</strong>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">grep -E -i &#34;(system|wininit|lsass|services|sms|lsm|csrss)&#34; pslist.txt &gt; pslist-all-boot.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">grep -E -i &#34;(system|wininit|lsass|services|sms|lsm|csrss)&#34; psscan.txt &gt; psscan-all-boot.txt
</span></span></code></pre></div><p><code>System</code> is a pivot point. Other processes that should start at boot, should have approximately the same starting date and time.</p>
<p><code>pslist</code> is pulling the information of a doubly-linked list (like a Task Manager). <code>psscan</code> - unallocated space (processes terminated or unlinked from this double-linked list).</p>
<h3 id="analysis-example">Analysis Example</h3>
<p>We have the result of <code>pslist</code>:</p>
<p><img src="images/pslist-results.png" alt="pslist-results"></p>
<p>We have several suspicious processes here: <code>scvhost.exe</code> (misspelled <code>svchost.exe</code>), some <code>xminer.exe</code> and a process with an intriguing name <code>3.exe</code>. But these are the processes that we could have seen, should we use a Task Manager on a live system. What about terminated or unlinked processes?</p>
<p>To answer that we run <code>psscan</code>:</p>
<p><img src="images/psscan-results.png" alt="psscan-results"></p>
<p>We seen the same <code>3.exe</code> in the list. But also we see <code>q.exe</code> which was run for about a minute and during that time another processes was spawned - <code>xmcminer.exe</code>. <code>q.exe</code> was terminated that&rsquo;s why we don&rsquo;t see it in <code>pslist</code> results. But <code>xmcminer.exe</code> was not terminated but we still don&rsquo;t see it in <code>pslist</code>. That means that the process was unlinked from double-list of processes in memory (aka hidden).</p>
<p>Take unique process names, sort and count:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cut -d <span class="s2">&#34; &#34;</span> -f <span class="m">2</span> <span class="s1">&#39;psscan.txt&#39;</span> <span class="p">|</span> sort <span class="p">|</span> uniq -c <span class="p">|</span> sort &gt; <span class="s1">&#39;psscan_proc_sorted.txt&#39;</span>
</span></span></code></pre></div><p>Also, get all processes that did not start at boot time:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">grep -E -i -v 2019-01-20 <span class="s1">&#39;pslist.txt&#39;</span> &gt; pslist_not_boottime.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">grep -E -i -v 2019-01-20 <span class="s1">&#39;psscan.txt&#39;</span> &gt; psscan_not_boottime.txt
</span></span></code></pre></div><h3 id="hyperfilsys">hyperfil.sys</h3>
<p>RAM dump at the moment of hypernation. To turn it on: <code>powercfg.exe /hibernate on</code>. Doesn&rsquo;t work on VMs. When the laptop turns back on, these files are filled with 0s (leaving 4K at the beginning only). The only way to get this file - get the HDD.</p>
<blockquote>
<p>💡 So, before performing the live acquisition, think twice: what would be more valuable for you&hellip;?</p>
</blockquote>
<p><strong>Structure</strong>:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>Header</td>
<td>PO_MEMORY_IMAGE structure</td>
</tr>
<tr>
<td>Page list</td>
<td>An array of physical page</td>
</tr>
<tr>
<td>Processor State</td>
<td>CONTEXT + KSPECIAL_REGISTERS</td>
</tr>
<tr>
<td>Memory Range Array n</td>
<td>Header: NextTable page, Number of entries. Entries: Destination page + Checksum.</td>
</tr>
<tr>
<td>Xpress compressed block p</td>
<td>Magic \x81\x81xpress (&gt;Win2K). Compressed data</td>
</tr>
<tr>
<td>Xpress compressed block p+1</td>
<td></td>
</tr>
<tr>
<td>Memory Range Array n+1</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Win8+ - new file format.</p>
<p>Not as common, but just as good. <code>imagecopy</code> plugin converts different formats into raw format to speed up. Hiberfile - compressed. Determine the OS profile and run the plugin.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vol.py -f crash.dmp --profile<span class="o">=</span>Win7SP2x64 imagecopy -O crash2mem.raw
</span></span><span class="line"><span class="cl">vol.py -f hyberfil.sys --profile<span class="o">=</span>Win7SP2x64 imagecopy -O hibir2mem.raw
</span></span></code></pre></div><p>C:\hiberfil.sys</p>
<p>C:\Memory.dmp</p>
<p>What is <a href="https://www.howtogeek.com/howto/15140/what-is-hiberfil.sys-and-how-do-i-delete-it/">hyberfil.sys</a>. Two types of compression.</p>
<p><code>imageinfo</code> - to identify the profile for memory image. Running <code>vol.py imageinfo -f hiberfil.sys</code> is slow and inefficient. No profiles were sugested. But when we have a live capture of a system, we can use this dump to determine the profile to perfom actions with the right profile on <code>hyberfil.sys</code>.</p>
<h3 id="pagefilesys">pagefile.sys</h3>
<p>When Windows system runs out of RAM, it uses HDD space to temporarily store the data from RAM. To acquire it from a live system: use <a href="https://ericzimmerman.github.io/#!index.md">https://ericzimmerman.github.io/#!index.md</a> or FTK Imager. Get separate files using <a href="https://www.cgsecurity.org/wiki/PhotoRec">PhotoRec</a> or using a Hex redactor (for example, <a href="https://www.sweetscape.com/010editor/">101 Editor</a>). This file is deleted on reboot.</p>
<p><strong>Properties</strong>:</p>
<table>
<thead>
<tr>
<th><strong>Hidden</strong></th>
<th>True</th>
<th><strong>Owner SID</strong></th>
<th>S-1-5-32-544</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>System</strong></td>
<td>True</td>
<td><strong>Owner Name</strong></td>
<td>Администраторы</td>
</tr>
<tr>
<td><strong>Read Only</strong></td>
<td>False</td>
<td><strong>Group SID</strong></td>
<td>S-1-5-18</td>
</tr>
<tr>
<td><strong>Archive</strong></td>
<td>True</td>
<td><strong>Group Name</strong></td>
<td>SYSTEM</td>
</tr>
</tbody>
</table>
<p>To copy this file use <code>RawCopy64.exe /FileNamePath:c:\pagefile.sys</code>.</p>
<p>To parse this file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">strings pagefile.sys <span class="p">|</span> egrep <span class="s2">&#34;^https?://&#34;</span> <span class="c1"># show URLs found in memory</span>
</span></span><span class="line"><span class="cl">strings pagefile.sys <span class="p">|</span> grep -i <span class="s2">&#34;^[a-z]:\\\\&#34;</span> <span class="c1"># file paths used are shown</span>
</span></span><span class="line"><span class="cl">strings pagefile.sys <span class="p">|</span> grep -i <span class="s2">&#34;^[a-zA-Z09_]*=.*&#34;</span> <span class="c1"># env vars</span>
</span></span></code></pre></div><p>Apply <a href="https://github.com/matonis/page_brute">yarn rules</a> against <code>pagefile</code>.</p>
<h3 id="vmem">VMEM</h3>
<p><code>python3 vol.py -f 1.vmem windows.vadinfo.VadInfo</code> to view Virtual Address Descriptors (<a href="https://resources.infosecinstitute.com/topic/finding-enumerating-processes-within-memory-part-2/">VAD</a>).</p>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    <p>[<a href="">1</a>] Magnet</p>
<p>[<a href="">2</a>] SDF Memory Forensics</p>
<p>[<a href="https://habr.com/ru/company/group-ib/blog/512728/">1</a>] Тайны файла подкачки pagefile.sys: полезные артефакты для компьютерного криминалиста</p>
<p>[<a href="https://www.blackhat.com/presentations/bh-usa-08/Suiche/BH_US_08_Suiche_Windows_hibernation.pdf">2</a>] About hybernation files</p>
<p>[<a href="https://www.researchgate.net/publication/311849840_Modern_windows_hibernation_file_analysis">3</a>] About new hybernation file format</p>

</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
