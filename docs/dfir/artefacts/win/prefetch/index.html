<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸº Prefetch - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/artefacts/win/"> ğŸ‘ˆğŸ¼ Back to </br> ğŸªŸ Windows Artefacts </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#-anatomy">â˜ ï¸ Anatomy</a></li>
    <li><a href="#-timestamps">â° Timestamps</a></li>
    <li><a href="#-tools">ğŸ›  Tools</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">ğŸº Prefetch</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 01.06.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p><em>Every day, the computer loads some programs and a lot of additional crap that comes with it. Every day the same routine over and over again. Being a diligent and responsible guy, it wondered how to improve this process. So, it decides to save the most recently loaded programs and whatever dlls and stuff these programs need so that everything is ready the next time the program is run. Where is this data stored? In Prefetch.</em></p>
<p>Prefetch is for the efficiency of starting processes and their resources (movies for media players, spreadsheets for Excel, for example). Improves startup time of applications. The PC watches what an app requests and opens during its first 10 seconds of execution and only then creates or updates the corresponding <code>pf</code> file.</p>
<h2 id="-anatomy">â˜ ï¸ Anatomy</h2>
<p>Each prefetch file name follows the pattern: <code>&lt;EXENAME&gt;-&lt;PATHHASHED+CMDARGS&gt;.pf</code>. If collecting prefetch on a live system, run volatile collection tools before that and collect <code>pf</code> files to avoid overwriting the oldest prefetch with prefetch for live response tools (or disable prefetch before collection). Prefetch tracks the execution of programs. A central repository of what was run on the system. File size can be used to search for the same process with a different name on a different machine.</p>
<p><strong>ğŸ“‚ Path</strong>: <code>C:\Windows\Prefetch</code>.</p>
<p>Prefetch contains the following information about the process (I&rsquo;ve marked the most forensically interesting fields with a ğŸ”¥):</p>
<p>ğŸ¾ Filename ğŸ”¥
ğŸ¾ Creation time ğŸ”¥
ğŸ¾ Modified time ğŸ”¥
ğŸ¾ File Size
ğŸ¾ Process EXE
ğŸ¾ Process Path ğŸ”¥
ğŸ¾ Run Counter ğŸ”¥
ğŸ¾ Last Run Time ğŸ”¥ (the same information is reflected in the file system modification timestamp)
ğŸ¾ Missing Process + libraries and resources for each process.</p>
<p>All prefetch have a <strong>signature</strong> at offset 4th byte. MAM - compressed and SCCA - plain text.</p>
<table>
<thead>
<tr>
<th>OS</th>
<th>Signature1 (version)</th>
<th>signature2 (type)</th>
</tr>
</thead>
<tbody>
<tr>
<td>WinXP &amp; 2003</td>
<td>0x00000011 or 17</td>
<td>SCCA</td>
</tr>
<tr>
<td>Vista</td>
<td>0x00000023 or 23</td>
<td>SCCA</td>
</tr>
<tr>
<td>W8</td>
<td>0x0000001a or 26</td>
<td>SCCA</td>
</tr>
<tr>
<td>W10</td>
<td>MAM</td>
<td>0x04</td>
</tr>
<tr>
<td>W10</td>
<td>0x0000001e or 30</td>
<td>SCCA</td>
</tr>
</tbody>
</table>
<p>Prefetch can be disabled in registry <code>SYSTEM</code> hive, key ğŸ”‘: <code>HKLM\SYSTEM\CurrentControlSet\Control\SessionManager\MemoryManagement\PrefetchParameters\Enable Prefetcher</code>:</p>
<table>
<thead>
<tr>
<th>key</th>
<th>meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>0</code></td>
<td>disabled</td>
</tr>
<tr>
<td><code>1</code></td>
<td>enabled for apps only</td>
</tr>
<tr>
<td><code>2</code></td>
<td>enabled for boot only</td>
</tr>
<tr>
<td><code>3</code></td>
<td>boot and app enabled (default)</td>
</tr>
</tbody>
</table>
<p>ğŸ“˜ You can check it with <code>rip.exe</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">rip.exe -r SYSTEM -p prefetch <span class="c1"># to show whether prefetch is enabled</span>
</span></span></code></pre></div><blockquote>
<p>â›”ï¸ When live-response tools ğŸ› ï¸ are run on the system, new <code>pf</code> files are created, and older ones might get deleted.
â›”ï¸ Prefetch is usually turned off on the servers and for the systems with SSD (which don&rsquo;t like write operations).
â›”ï¸  Starting from Windows 10 the prefetch is compressed.
â›”ï¸ Also, there is a latency issue - some apps are not closed upon clicking âŒ, but remain running in the background. Hence, the last time run might be different.
â›”ï¸ The hash in the filename is derived from both the app path and command line arguments. That&rsquo;s why some legit processes have several <code>pf</code> files.</p>
</blockquote>
<p>Prefetch is an invaluable resource during the investigation. Although one should not solely rely on it, it gives a lot if insights.</p>
<p>ğŸº First, sometimes it so happens (especially with the malware running on the system) that two programs have the same name. Since they can&rsquo;t be in the same folder (Windows won&rsquo;t allow it), the path to the executable for both programs will be different. Since the <code>pf</code> filename is derived from the path hash and the exe name, if the same exe was run from different locations - different <code>.pf</code> files will be created. Now, imagine that you see two prefetch files for cmd, that&rsquo;s not something expected and is worth looking into.</p>
<p>ğŸº Another good thing about Prefetch is that even if an application was deleted, the info remains in Prefetch (at least, for some time).</p>
<p>ğŸºPrefetch stores 8 execution times (one of them is the first time run, and the other - is the last time run). But don&rsquo;t forget about the file system timestamps! So, the date and time the <code>pf</code> file itself was created as yet another execution time.</p>
<h2 id="-timestamps">â° Timestamps</h2>
<p><strong>Filesystem Timestamps</strong>. The first time the executable is run, a <code>pf</code> file is created. The last time it was run - a pf&rsquo;s file Modified date and time. However, consider a scenario when a program was run a long time in the past and wasn&rsquo;t run for a while after that. Its <code>pf</code> file was overwritten (prefetch keeps <code>1024</code> entries, which used to be 128 in W7 and below). Sometime after that, the executable is run again, and the <code>pf</code> file is created again. The FS timestamps will show that the file was first executed recently when it&rsquo;s not straightforward.</p>
<h2 id="-tools">ğŸ›  Tools</h2>
<blockquote>
<p>ğŸ’¡ Write a script to determine deleted files</p>
</blockquote>
<p><strong>WinPrefetchView</strong>. To view pretech files (decompressed as well) in GUI.</p>
<p><strong>Fred</strong> - Forensic Registry Editor. To view exported hives.</p>
<p><strong>FTK Imager Lite</strong>. Fairly heavy footprint - 15-16Mb.</p>
<p><strong>CDQR</strong>. This tool focuses on the <code>pf</code> intself rather than on a data it contains. It&rsquo;s useful for making timelines.</p>
<p><strong>RegRipper (GUI and CUI)</strong>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">rip.exe -r SYSTEM -p prefetch <span class="c1"># to show whether prefetch is enabled</span>
</span></span></code></pre></div><p><strong>Prefetch parser.</strong> More info than with WinPrefetchView</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">prefetch.py -c -d -e
</span></span><span class="line"><span class="cl">prefetch.py -c -d &gt; pf.csv
</span></span><span class="line"><span class="cl">prefetch.py -f &lt;file_to_parse&gt; &gt; pf.txt
</span></span></code></pre></div><p>Columns: last executed, MFT sequence number, MFT record number, executable name, run counter,</p>
<p><strong>PECmd</strong>. Eric Zimmerman&rsquo;s tool.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">PECmd</span><span class="p">.</span><span class="n">exe</span> <span class="o">-f</span> <span class="p">&lt;</span><span class="n">pffile</span><span class="p">&gt;.</span><span class="n">pf</span>
</span></span><span class="line"><span class="cl"><span class="n">PECmd</span><span class="p">.</span><span class="n">exe</span> <span class="n">-d</span> <span class="s2">&#34;Prefetch folder&#34;</span> <span class="p">-</span><span class="n">-csv</span> <span class="s2">&#34;outoutdir&#34;</span> <span class="p">-</span><span class="n">-csvf</span> <span class="s2">&#34;outputfile&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">PECmd</span><span class="p">.</span><span class="n">exe</span> <span class="o">-f</span> <span class="s2">&#34;Prefetch_file.pf&#34;</span> <span class="p">-</span><span class="n">-json</span> <span class="s2">&#34;outoutdir&#34;</span> <span class="p">-</span><span class="n">-jsonpretty</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -k  comma-separated keywords</span>
</span></span><span class="line"><span class="cl"><span class="c"># -mp high precision timestamps</span>
</span></span><span class="line"><span class="cl"><span class="c"># --local</span>
</span></span><span class="line"><span class="cl"><span class="c"># vss  process Volume Shadow Copies as well</span>
</span></span></code></pre></div><h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    <a href="https://forensics.wiki/">https://forensics.wiki/</a>
</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
