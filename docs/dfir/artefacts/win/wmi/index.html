<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WMI Event Consumers - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/artefacts/win/"> 👈🏼 Back to </br> 🪟 Windows Artefacts </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#types">Types</a></li>
        <li><a href="#whitelist">Whitelist</a></li>
      </ul>
    </li>
    <li><a href="#-btfm">📘 BTFM</a></li>
    <li><a href="#terms">Terms</a></li>
    <li><a href="#analysis-with-wmi">Analysis with WMI</a></li>
    <li><a href="#analysis-of-cim">Analysis of CIM</a></li>
    <li><a href="#privileges">Privileges</a></li>
    <li><a href="#examples">Examples</a></li>
    <li><a href="#resources">Resources</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">WMI Event Consumers</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      
      <div class="article-category">
          
            
              <i class="fab fa-windows"></i>          
            
            
            
            
            
            
          
          
      </div> <br />
      

      
      

      
    </div>
    
    <b>Created:</b> 28.07.2022
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p><em>In days of yore, there existed a humble batch, whence emerged the WMI, and it didst hold dominion o&rsquo;er the realm of Windows contraptions for a considerable span until it was entwined with the might of PowerShell.</em></p>
<p>An <strong>event filter</strong> is a condition that should be met for something to happen. What&rsquo;s the something? This something is an <strong>Event Consumer</strong> (script or executable). <strong>Binding</strong> is used to tie these two guys up. To set up, up this thing we can use PowerShell or <code>mofcomp.exe</code> (compiles <code>MOF</code> files into <code>OBJECTS.DATA</code>). It is similar to scheduled tasks but much more flexible, robust and capable. Malware has been using WMI for a while, the pioneer being the notorious 🦠 Stuxnet.</p>
<blockquote>
<p>⚠️  WMI consumers run with SYSTEM privileges.</p>
</blockquote>
<p>There are two ways to interact with WMI: <code>wmic</code> utility (running as a process <code>wmprsve.exe</code>) and PowerShell (many cmdlets are wrappers around WMI). When you create a filter-consumer-binder thingy, it&rsquo;s added to a MOF file which is some WMI repo. It is used to register new classes into the WMI repo. <code>Set-WmiInstance</code> or <code>CreateInstance</code> can also be used. To note, Metasploit can do that as well (PowerShell commands under the hood?).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">wmic</span> <span class="p">/?</span>
</span></span><span class="line"><span class="cl"><span class="n">wmic</span> <span class="p">/</span><span class="n">node</span><span class="err">:</span><span class="p">&lt;</span><span class="n">IP</span><span class="p">&gt;</span> <span class="n">startup</span> <span class="n">list</span> <span class="n">full</span>
</span></span><span class="line"><span class="cl"><span class="n">wmic</span> <span class="p">/</span><span class="n">node</span><span class="err">:</span><span class="p">&lt;</span><span class="n">IP</span><span class="p">&gt;</span> <span class="n">nicconfig</span> <span class="n">get</span>
</span></span><span class="line"><span class="cl"><span class="n">wmic</span> <span class="p">/</span><span class="n">node</span><span class="err">:</span><span class="p">&lt;</span><span class="n">IP</span><span class="p">&gt;</span> <span class="k">process</span> <span class="n">get</span>
</span></span></code></pre></div><h3 id="types">Types</h3>
<p>The first two types are beloved attackers because they give the best capabilities. The <code>LogFileEventConsumer</code> and <code>NTEventLogEventConsumer</code> could be used to cover the tracks, while <code>SMTPEventConsumer</code> could be utilised for C2C, but I have not researched that.</p>
<ol>
<li>ActiveScriptEventConsumer 🔥 - execute a <code>vbs</code> or <code>js</code> script.</li>
<li>CommandLineEventConsumer 🔥 - start a process.</li>
<li>LogFileEventConsumer - write to logs.</li>
<li>NTEventLogEventConsumer - log message to event logs.</li>
<li>SMTPEventConsumer - email via SMTP.</li>
<li>Custom - one needs a COM object to use that.</li>
</ol>
<h3 id="whitelist">Whitelist</h3>
<p>There are not too many default WMI consumers, so it&rsquo;s pretty trivial to whitelist those.</p>
<ol>
<li><code>SCM Event Log Consumer</code>. This WMI consumer monitors events related to the Service Control Manager (SCM) on a Windows machine. It captures service start, stop, and failure events, allowing administrators to track and troubleshoot service-related issues.</li>
<li><code>TSLogonFilter</code> - filters and captures events related to Terminal Services logon on a Windows machine. It enables administrators to monitor and log user logon activities, session creation, and other related events in a Terminal Services environment.</li>
<li><code>KernCap.vbs</code> -  acts as a WMI consumer and is used to capture kernel events on a Windows machine. It allows administrators to monitor and log events related to the Windows kernel, such as driver loading, system crashes, and other low-level system activities.</li>
<li><code>BVTFilter</code> -  filters and captures events related to Boot Verification Test (BVT) on a Windows machine. BVT is a testing mechanism Microsoft uses to verify the integrity and functionality of the Windows boot process. The BVTFilter consumer helps monitor and log events associated with this testing process.</li>
<li><code>RAevent.vbs</code> - used for capturing events related to Remote Assistance (RA) sessions on a Windows machine. It allows administrators or remote support personnel to monitor and log events related to RA sessions, including session initiation, user interaction, and session termination.</li>
<li><code>NTEventLogConsumer</code> - captures events from the Windows Event Log. It can monitor and log various events recorded in the Event Log, including application, system, and security events. Its purpose is to provide a general mechanism for capturing events from the Windows Event Log.</li>
<li><code>TSLogonEvents.vbs</code> - designed to capture events related to Terminal Services logon on a Windows machine. It enables administrators to monitor and log user logon activities, session creation, and other related events, specifically in a Terminal Services environment.</li>
<li><code>RmAssistEventFilter</code> filters and captures events related to a Windows machine&rsquo;s Resource Manager Assistance (RmAssist) feature. RmAssist is a Windows Server feature that assists in managing resources for virtual machines. The RmAssistEventFilter consumer allows administrators to monitor and log events related to resource management activities.</li>
<li><code>WSCEAA.exe</code> (Dell) - ???</li>
</ol>
<p>📚 <strong>References</strong>: <a href="https://pentestlab.blog/2020/01/21/persistence-wmi-event-subscription/">pentest lab article</a>, SANS <a href="https://www.sans.org/blog/wmic-for-incident-response/">article</a>, <a href="https://www.sans.org/blog/finding-evil-wmi-event-consumers-with-disk-forensics/?utm_medium=Social&amp;utm_source=Twitter&amp;utm_content=WMI%20Forensics_Blog_VMR&amp;utm_campaign=DFIR%20Blog">https://www.sans.org/blog/finding-evil-wmi-event-consumers-with-disk-forensics/?utm_medium=Social&amp;utm_source=Twitter&amp;utm_content=WMI%20Forensics_Blog_VMR&amp;utm_campaign=DFIR%20Blog</a>, <a href="https://www.sans.org/blog/wmic-for-incident-response/">https://www.sans.org/blog/wmic-for-incident-response/</a>, <a href="https://isc.sans.edu/diary/Tip+of+the+Day+-+Like+a+Kid+in+a+WMIC+Candy+Store/1622">https://isc.sans.edu/diary/Tip+of+the+Day+-+Like+a+Kid+in+a+WMIC+Candy+Store/1622</a></p>
<h2 id="-btfm">📘 BTFM</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># See the consumers</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-WmiObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="n">Subscription</span> <span class="n">-Class</span> <span class="n">___EventFilter</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-WmiObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="n">Subscription</span> <span class="n">-Class</span> <span class="n">___EventConsumer</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-WmiObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="n">Subscription</span> <span class="n">-Class</span> <span class="n">___FilterToConsumerBinding</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Get-WmiObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="k">Default</span> <span class="n">-Class</span> <span class="n">___EventFilter</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-WmiObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="k">Default</span> <span class="n">-Class</span> <span class="n">___EventConsumer</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-WmiObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="k">Default</span> <span class="n">-Class</span> <span class="n">___FilterToConsumerBinding</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create consumers</span>
</span></span><span class="line"><span class="cl"><span class="nb">Set-WmiInstance</span>
</span></span><span class="line"><span class="cl"><span class="n">CreateInstance</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Spot processes NOT running from Windows folder. You see a system process here - red flag 🚩 </span>
</span></span><span class="line"><span class="cl"><span class="n">wmic</span> <span class="k">PROCESS</span> <span class="nb">WHERE </span><span class="s2">&#34;NOT ExecutablePath LIKE &#39;%Windows%&#39;&#34;</span> <span class="n">GET</span> <span class="n">ExecutablePath</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># remote management</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># list autoruns</span>
</span></span><span class="line"><span class="cl"><span class="n">wmic</span> <span class="p">/</span><span class="n">node</span><span class="err">:</span><span class="n">IP</span> <span class="n">startup</span> <span class="n">list</span> <span class="n">all</span> 
</span></span><span class="line"><span class="cl"><span class="n">wmic</span> <span class="p">/</span><span class="n">node</span><span class="err">:</span><span class="n">IP</span> <span class="k">process</span> <span class="n">get</span> <span class="c"># get process list</span>
</span></span><span class="line"><span class="cl"><span class="n">wmic</span> <span class="p">/</span><span class="n">node</span><span class="err">:</span><span class="n">IP</span> <span class="n">nicconfig</span> <span class="n">get</span> <span class="c"># net config on a remote system</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">.\</span><span class="n">Modules</span><span class="p">\</span><span class="k">Process</span><span class="p">\</span><span class="nb">Get-ProcsWMI</span><span class="p">.</span><span class="n">ps1</span> <span class="p">|</span> <span class="nb">Out-GridView</span> <span class="c"># Kansa&#39;s Module to pull info about ProcsWMI from the live system and display in a user-friendly mode.</span>
</span></span></code></pre></div><p>🛠️ <code>autorunsc</code> and 🛠️ <code>Kansa</code> both can get the artefacts associated with this mechanism. Also, 🛠️ <code>PoSh-R2</code> (<a href="https://github.com/WiredPulse/PoSh-R2">here</a>) and <code>Velociraptor</code> are both tools to use for the collection.</p>
<h2 id="terms">Terms</h2>
<p><strong>cmdlet</strong> - put certain enhanced operating system functions into effect when usung powershell, example: <code>Get-Help</code>.</p>
<p><strong>WMI</strong> (Windows Management Instrumentation). Some of the functions are available through powershell cmdlets. Use <code>Get-Command -Noun WMI*</code> to get all WMI cmdlets. On my Windows VM (Parallels, Windows insider) I got this result:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span> <span class="nb">Get-Command</span> <span class="n">-Noun</span> <span class="n">WMI</span><span class="p">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">CommandType</span>     <span class="n">Name</span>                              <span class="n">Version</span>    <span class="n">Source</span>
</span></span><span class="line"><span class="cl"><span class="p">-----------</span>     <span class="p">----</span>                              <span class="p">-------</span>    <span class="p">------</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">Get-WmiObject</span>          <span class="n">3</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">Microsoft</span><span class="p">.</span><span class="n">PowerShell</span><span class="p">.</span><span class="n">Management</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">Invoke-WmiMethod</span>       <span class="n">3</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">Microsoft</span><span class="p">.</span><span class="n">PowerShell</span><span class="p">.</span><span class="n">Management</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">Register-WmiEvent</span>      <span class="n">3</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">Microsoft</span><span class="p">.</span><span class="n">PowerShell</span><span class="p">.</span><span class="n">Management</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">Remove-WmiObject</span>       <span class="n">3</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">Microsoft</span><span class="p">.</span><span class="n">PowerShell</span><span class="p">.</span><span class="n">Management</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">Set-WmiInstance</span>        <span class="n">3</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">Microsoft</span><span class="p">.</span><span class="n">PowerShell</span><span class="p">.</span><span class="n">Management</span>
</span></span></code></pre></div><p>WMI cmdlets were deprecated accourding to the doc, so the recommendation is to start using CIM (Common Information Model). However, CIM is using WIM under the hood anyway. This is what I&rsquo;ve got on the WinVM:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span> <span class="nb">Get-Command</span> <span class="n">-Module</span> <span class="n">CimCmdlets</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">CommandType</span>     <span class="n">Name</span>                                               <span class="n">Version</span>    <span class="n">Source</span>
</span></span><span class="line"><span class="cl"><span class="p">-----------</span>     <span class="p">----</span>                                               <span class="p">-------</span>    <span class="p">------</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">Export-BinaryMiLog</span>                                 <span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">CimCmdlets</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">Get-CimAssociatedInstance</span>                          <span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">CimCmdlets</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">Get-CimClass</span>                                       <span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">CimCmdlets</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">Get-CimInstance</span>                                    <span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">CimCmdlets</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">Get-CimSession</span>                                     <span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">CimCmdlets</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">Import-BinaryMiLog</span>                                 <span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">CimCmdlets</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">Invoke-CimMethod</span>                                   <span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">CimCmdlets</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">New-CimInstance</span>                                    <span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">CimCmdlets</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">New-CimSession</span>                                     <span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">CimCmdlets</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">New-CimSessionOption</span>                               <span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">CimCmdlets</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">Register-CimIndicationEvent</span>                        <span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">CimCmdlets</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">Remove-CimInstance</span>                                 <span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">CimCmdlets</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">Remove-CimSession</span>                                  <span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">CimCmdlets</span>
</span></span><span class="line"><span class="cl"><span class="n">Cmdlet</span>          <span class="nb">Set-CimInstance</span>                                    <span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>    <span class="n">CimCmdlets</span>
</span></span></code></pre></div><h2 id="analysis-with-wmi">Analysis with WMI</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Get autostarts</span>
</span></span><span class="line"><span class="cl"><span class="n">wmic</span> <span class="p">/</span><span class="n">node</span><span class="err">:</span><span class="p">&lt;</span><span class="n">IP</span><span class="p">&gt;</span> <span class="n">startup</span> <span class="n">list</span> <span class="n">full</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># get processes</span>
</span></span><span class="line"><span class="cl"><span class="n">wmic</span> <span class="p">/</span><span class="n">node</span><span class="err">:</span><span class="p">&lt;</span><span class="n">IP</span><span class="p">&gt;</span> <span class="k">process</span> <span class="n">get</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># network config</span>
</span></span><span class="line"><span class="cl"><span class="n">wmic</span> <span class="p">/</span><span class="n">node</span><span class="err">:</span><span class="p">&lt;</span><span class="n">IP</span><span class="p">&gt;</span> <span class="n">nicconfig</span> <span class="n">get</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Prebuilt wmic scripts by Justin Hall on USB</span>
</span></span><span class="line"><span class="cl"><span class="n">wmic_lr</span><span class="p">.</span><span class="n">local</span><span class="p">.</span><span class="n">cmd</span> <span class="p">&amp;</span> <span class="n">wmic_lr</span><span class="p">.</span><span class="n">remote</span><span class="p">.</span><span class="n">cmd</span> 
</span></span></code></pre></div><h2 id="analysis-of-cim">Analysis of CIM</h2>
<p>Looks like the structure is as follows: all the commands start with <code>GetCimInstance</code>. Get the stack version to determine wether to use WSMan protocol or DCOM:</p>
<p><img src="images/stack-version.png" alt="stack-version"></p>
<p>For a remote machine you may use <code>Test-WSMan -ComputerName dc01</code>. Running <code>hostname</code> to get the local PC name and using this value in the previous command resulted in error. <code>$PSVersionTable</code> worked fine for me. On newer versions DCOM is usually blocked by firewall 🔥.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nv">$DCOM</span> <span class="p">=</span> <span class="nb">New-CimSessionOption</span> <span class="n">-Protocol</span> <span class="n">Dcom</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Cred</span> <span class="p">=</span> <span class="nb">Get-Credential</span>
</span></span><span class="line"><span class="cl"><span class="nv">$CimSession</span> <span class="p">=</span> <span class="nb">New-CimSession</span> <span class="n">-ComputerName</span> <span class="n">sql03</span> <span class="n">-SessionOption</span> <span class="nv">$DCOM</span> <span class="n">-Credential</span> <span class="nv">$Cred</span>
</span></span></code></pre></div><h2 id="privileges">Privileges</h2>
<p>Powershell has the exact same privileges as when you are using GUI. For example, when runnning Powershell as local admin, you might get an &ldquo;access denied 🙅‍♀️&rdquo; error trying to connect to a remote machine. In this case you have two options:</p>
<ol>
<li>restart Powershell with <em>domain</em> admin privileges (less secure since you&rsquo;d end up using this privileged window to do other non-privileged stuff);</li>
<li>use per-command privilege escalation using <code>Credentials</code> parameter: <code>$CimSession = New-CimSession -ComputerName dc01 -Credential (Get-Credential)</code>. Then query the remote machine using this session: <code>Get-CimInstance -CimSession $CimSession -ClassName Win32_BIOS</code>.</li>
</ol>
<p><img src="images/cim-session-create.png" alt="cim-session-create"></p>
<h2 id="examples">Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># get the serial</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-CimInstance</span> <span class="n">-ClassName</span> <span class="n">Win32_BIOS</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Property</span> <span class="n">SerialNumber</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># these two options return the same result:</span>
</span></span><span class="line"><span class="cl"><span class="c"># 1</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">Get-CimInstance</span> <span class="n">-ClassName</span> <span class="n">Win32_BIOS</span> <span class="n">-Property</span> <span class="n">SerialNumber</span><span class="p">).</span><span class="n">SerialNumber</span>
</span></span><span class="line"><span class="cl"><span class="c"># 2</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-CimInstance</span> <span class="n">-ClassName</span> <span class="n">Win32_BIOS</span> <span class="n">-Property</span> <span class="n">SerialNumber</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="nb">Select-Object</span> <span class="n">-ExpandProperty</span> <span class="n">SerialNumber</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># query a remote PC</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-CimInstance</span> <span class="n">-ComputerName</span> <span class="n">dc01</span> <span class="n">-ClassName</span> <span class="n">Win32_BIOS</span>
</span></span><span class="line"><span class="cl"><span class="c"># might get an &#34;access denied&#34; error</span>
</span></span></code></pre></div><h2 id="resources">Resources</h2>
<p>[<a href="https://docs.microsoft.com/en-us/powershell/scripting/learn/ps101/07-working-with-wmi?view=powershell-7.1">1</a>] Official Docs</p>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    Something here
</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
