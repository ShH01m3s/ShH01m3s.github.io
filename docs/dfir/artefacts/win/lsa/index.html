<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏺 LSA - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/artefacts/win/"> 👈🏼 Back to </br> 🪟 Windows Artefacts </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#login-process">Login Process</a></li>
    <li><a href="#login-types">Login Types</a></li>
    <li><a href="#-lsa-secrets">🏺 LSA Secrets</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">🏺 LSA</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 21.06.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p>*This article centres around the crowned queen of the Windows kingdom: LSA (<code>lsass.exe</code>), a darling among attackers for the sheer power it wields.</p>
<p>Single Sign-on. LSA is its part. Responsible for authentication and authorisation. Manages <strong>derived</strong> credentials (NTLM, Kerberos tickets, sessions, hashes etc). The image file is located at <code>%WINDIR%\System32</code>.</p>
<p>🛠 <a href="https://github.com/D1rkMtr/DumpThatLSASS">https://github.com/D1rkMtr/DumpThatLSASS</a></p>
<h2 id="login-process">Login Process</h2>
<p>This is what a general picture looked like before Windows Vista came into play:</p>
<p><img src="images/login-vista-minus.png" alt="mypic">
<code>msgina.dll</code> is used to handle the login process. Starting from Windows Vista, the <code>msgine.dll</code> was deprecated.</p>
<p>If you want a more thorough picture to examine:</p>
<p><img src="images/lsa1.png" alt="img"></p>
<h2 id="login-types">Login Types</h2>
<p><code>Win32_LogonSession</code> class is used in Windows API to handle login, depending on the type.</p>
<p><img src="images/win32-logonsession.png" alt="img"></p>
<blockquote>
<p>📝 <code>0</code>.-<code>1</code>. - Not documented, but can occur in the wild. <code>1</code> - system logon?</p>
</blockquote>
<ol start="2">
<li>Console logon (keyboard, server KVM, VNC)</li>
<li>Network logon (SMB, some RDP)</li>
<li>Batch logon. This is used when a scheduled task initiates the logon.</li>
<li>Windows service logon (aka daemons in the UNIX world)</li>
<li>Proxy: This is not widely used, and is typically only used for &ldquo;non-trusted&rdquo; scenarios.</li>
<li>Creds used to lock and unlock the screen, RDP reconnect</li>
<li>Network logon with cleartext creds. This is typically associated with web-based logons.</li>
<li>Creds used != creds for logon. This logon type signifies that the <code>RunAs</code> command was used with the <code>/netonly</code> switch. The user is logging on to a system different from the one that was initially logged on to.</li>
<li>RDP</li>
<li>Cached creds. This logon occurs when a user logs on using cached credentials, typically when the domain controller is unavailable or when a laptop user is off the network.</li>
<li>Cached remote interactive (~ 10). This type of logon occurs when a user logs on with cached credentials to a remote system via RDP.</li>
<li>Cached unlock (~ 7). This logon occurs when a user unlocks a workstation using cached credentials.</li>
</ol>
<blockquote>
<p>📝 The primary benefit of NLA is that it can protect systems from being exposed to malicious users or software right upon connection. It does so by adding an extra layer of authentication at the start of the Remote Desktop Connection (RDC), before the login screen appears.</p>
</blockquote>
<p>As you can see from the picture, <code>uint32 LogonType</code> can be set to either of the 12 values. Types Console login and RunAs when using type 2, Remote Desktop when logging with type 10, PsExec alternate creds when used in combination of 3 and 2 logon types, Remote Scheduled Task using the 4th logon type and Run as a Service using the 5th logon types all store credentials on the target.</p>
<p><code>LsaLogonUser</code> class from <code>secur32.dll</code> is also a struct participating in the login process. As you can see from the picture, <code>pvoid AuthenticationInformation</code> is the field carrying the username and password.
<img src="images/lsalogonuser.png" alt="img"></p>
<h2 id="-lsa-secrets">🏺 LSA Secrets</h2>
<p>🏺 <code>SECURITY\Policy\Secrets</code> - each key has its own registry 🔑 key. To decode them, use <code>SECURITY\Policy</code> 🔑 key. To finally decrypt - <code>SYSTEM</code> hive is needed. The attacker needs 👑 admin or higher privileges to access these keys 🔑.</p>
<p>🛠️ <code>Nishang</code>, <code>Get-LsaSecret.ps1</code> to dump and decrypt secrets.</p>
<p><strong>📕 RTFM</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Enable-DuplicateToken</span> <span class="c"># to get access to SECURITY hive by setting the token it&#39;s using to the same value as LSASS has.</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-LsaSecret</span>
</span></span></code></pre></div><h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    Something here
</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
