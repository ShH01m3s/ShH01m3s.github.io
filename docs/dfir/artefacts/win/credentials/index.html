<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🗝️ Credentials - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/artefacts/win/"> 👈🏼 Back to </br> 🪟 Windows Artefacts </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#sid">SID</a></li>
    <li><a href="#accounts">Accounts</a>
      <ul>
        <li><a href="#local-admin-rid-not-500">Local Admin (RID NOT <code>500</code>)</a></li>
        <li><a href="#local-user-accounts">Local User Accounts</a></li>
        <li><a href="#microsoft-accounts">Microsoft Accounts</a></li>
        <li><a href="#domain-accounts">Domain Accounts</a></li>
        <li><a href="#deleted-accounts">Deleted Accounts</a></li>
        <li><a href="#default-accounts">Default Accounts</a></li>
      </ul>
    </li>
    <li><a href="#-clear-text-creds">🗝️ Clear Text Creds</a></li>
    <li><a href="#-tokens">🗝️ Tokens</a></li>
    <li><a href="#-lm-and-nt-hashes">🗝️ LM and NT Hashes</a>
      <ul>
        <li><a href="#lm--deprecated">LM (⛔️ deprecated)</a></li>
        <li><a href="#ntlm">NTLM</a></li>
        <li><a href="#ntlmv2">NTLMv2</a></li>
      </ul>
    </li>
    <li><a href="#-tickets">🗝️ Tickets</a></li>
    <li><a href="#-lsa-secrets">🏺 LSA Secrets</a></li>
    <li><a href="#-cache">🏺 Cache</a></li>
    <li><a href="#-sam">🏺 SAM</a></li>
    <li><a href="#-local-security-authority-subsystem-lsa">🏺 Local Security Authority Subsystem (LSA)</a>
      <ul>
        <li>
          <ul>
            <li><a href="#login-process">Login Process</a></li>
            <li><a href="#login-types">Login Types</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#-tspkg-and-wdigest">🏺 <code>TsPkg</code> and <code>Wdigest</code></a></li>
    <li><a href="#-livessd">🏺 LiveSSD</a></li>
    <li><a href="#-ntdsdit">🏺 <code>NTDS.DIT</code></a></li>
    <li><a href="#-attacks">⚔️ Attacks</a></li>
    <li><a href="#-detection-and--investigation">🔔 Detection and 🔎 Investigation</a></li>
    <li><a href="#-defense">🛡️ Defense</a>
      <ul>
        <li><a href="#important-security-patches">Important Security Patches</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">🗝️ Credentials</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 09.06.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p><em>To carry out nearly any action on a system, one requires an account, which is typically safeguarded by passwords or other credentials. Hence, it is crucial to understand why attackers exhibit such a strong interest in acquiring them.</em></p>
<h2 id="sid">SID</h2>
<p>Below is the structure of a SID. SID, shortly speaking, is a user id. The actual ID of the user is the RID (relative identifier) part.</p>
<p><img src="images/sid-anatomy.png" alt="img"></p>
<p>In case <code>Who created it?</code> aka issuing authority ends with number <code>21</code>, a trailing SID will represent PC or domain identifier (purple in the picture above). <code>1</code> - revision number, <code>5</code> - issuing authority, <code>21</code> - sub-issuing authority.</p>
<p>Here the most common SIDs you will see in the wild:</p>
<p><img src="images/sids-list.png" alt="img"></p>
<blockquote>
<p>❗️Built-in accounts don&rsquo;t have a Unique domain identifier and RID.</p>
</blockquote>
<p>To get a user&rsquo;s SID:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">wmic</span> <span class="n">useraccount</span> <span class="nb">where </span><span class="n">name</span><span class="p">=</span><span class="s1">&#39;veronicazvereva&#39;</span> <span class="n">get</span> <span class="n">sid</span> <span class="c"># or</span>
</span></span><span class="line"><span class="cl"><span class="n">whoami</span> <span class="p">/</span><span class="n">user</span> <span class="c"># for current user</span>
</span></span></code></pre></div><p>PC/domain ID can be viewed in <code>SAM\SAM\Domains\Accounts</code>, value <code>V</code>, last 12 bytes of the data chunk:</p>
<p><img src="images/sam1.png" alt="sam1"></p>
<p>In order to translate this value, split the hex 12 byte value into three 4 byte chunks. Since these are little-endian, reverse the order of the bytes, convert each to decimal If this is a negative value, something is not right. It&rsquo;s a 32-bit unsigned value! For example, in the below picture we see that the machine id is <code>2d 48 f4 b4 1a b1 b8 73 f1 2a 8a a3</code>. Splitting into 3 chunks gives us: <code>2d 48 f4 b4</code>, <code>1a b1 b8 73</code> and <code>f1 2a 8a a3</code>. Lets now convert each to little-endian: <code>b4 f4 48 2d</code>, <code>73, b8, b1, 1a</code> and <code>a3 8a 2a f1</code>. Now, each set of 4 bytes in decimal: <code>3035908141</code>, <code>1941483802</code>, <code>2743741169</code>. The resulting machine ID part of the SID is then: <code>3035908141-1941483802-2743741169</code>. Let&rsquo;s check in PowerShell:</p>
<p><img src="images/whoami-sam-machineid.png" alt="whoami-sam-machineid"></p>
<p>In the picture above with the registry window, the green square 🟩 shows the RIDs in hex. Given the RID, one can deduce something about the user, since some users have predefined RIDs:</p>
<ul>
<li><code>S-1-5-21-X-X-X-500</code> - default admin</li>
<li><code>S-1-5-21-X-X-X-501</code> - default guest</li>
<li><code>S-1-5-21-X-X-X-1000</code> - the first user created on a Windows 7 and below, <code>S-1-5-21-X-X-X-1001</code> - for newer systems</li>
<li><code>S-1-5-18</code> - System</li>
<li><code>S-1-5-3</code> - batch</li>
<li><code>S-1-5-2</code> - network</li>
<li><code>S-1-5-21-544</code> - local admin group</li>
</ul>
<p>The previous picture shows that the RID is <code>1000</code>, meaning it&rsquo;s the first user account (surprisingly not <code>1001</code> since it&rsquo;s a Windows 10 machine).</p>
<h2 id="accounts">Accounts</h2>
<h3 id="local-admin-rid-not-500">Local Admin (RID NOT <code>500</code>)</h3>
<blockquote>
<p>❗️This is not the same as the built-in admin account on every Windows system with RID <code>500</code>.</p>
</blockquote>
<blockquote>
<p>❗️The use of a local admin account with a single password that grants remote access to all machines within an enterprise is considered a well-known vulnerability.</p>
</blockquote>
<h3 id="local-user-accounts">Local User Accounts</h3>
<p>For each user there will be a separate sub-key under <code>SAM\SAM\Domains\Account\Users</code>. The sub-keys names are actually RID of the user in hex. Each sub-key will have several values. Record <code>V</code> contains static information (username, password length etc), while record <code>F</code> contains constantly updated information like timestamps 🕰:</p>
<ul>
<li>Last login is a little endian 8 byte value at <code>0x08-0x0f</code> offset.</li>
<li>Last password change time at offset <code>0x18-0x1f</code>, 8 bytes long.</li>
<li>Last failed logon time is at offset <code>0x28-0x2f</code>, 8 bytes.</li>
</ul>
<p>RID itself is stored in <code>F</code> record at offset <code>0x30-0x33</code> (little endian). Also, there is <code>PasswordRequired</code> (at <code>0x38</code>). There several possible values for this nibble (half byte): <code>0</code> - account active + pass required, <code>1</code> - account is not active, <code>4</code> - any policies do not apply to this account.</p>
<blockquote>
<p>🧪 I have <code>5</code> on my machine, what does it mean?</p>
</blockquote>
<p>Logon count is at <code>0x42-0x43</code> (two bytes).</p>
<p>The <code>V </code> value is more interesting. It contains usernames and hashes (NTLM). The user account name is at <code>0x1C0</code> offset (Unicode). What about the juicy stuff? I mean the password hashes. SAM file contains a 56-byte NTLM hash of the password, which is encrypted with an AES algo,  the key 🔑 is stored in a system file. You&rsquo;ll need both SAM and the system file to decrypt the password. Password cracking methodology:</p>
<ul>
<li><input disabled="" type="checkbox"> Export SAM and SYSTEM hives from the forensic image/suspect machine.</li>
<li><input disabled="" type="checkbox"> Unencrypt the hash stored in the SAM file (🛠 <code>mimikatz</code>).</li>
<li><input disabled="" type="checkbox"> Create a word list from the current case (may export from Autopsy, EnCase etc).</li>
<li><input disabled="" type="checkbox"> Run a dictionary 📖 or brute-force attack 💪 against this NTLM hash (🛠: <code>hashcat</code> 🐈‍⬛ , <code>John the Ripper</code> 🔪, Cain and Able 🔪 🐏).</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># decrypt the hashes:</span>
</span></span><span class="line"><span class="cl">mimikatz
</span></span><span class="line"><span class="cl">&gt; lsadump::sam /system:<span class="s2">&#34;path_to_SYSTEM&#34;</span> /SAM:<span class="s2">&#34;path_to_SAM&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># crach the hash with hashcat</span>
</span></span></code></pre></div><p><strong>Other values are stored in this sub-key</strong>. <code>ForcePasswordReset</code> speaks for itself, and <code>SupplementalCredentials</code> do not. There also can be a <code>UserPasswordHint</code>, which sometimes contains the actual password.</p>
<h3 id="microsoft-accounts">Microsoft Accounts</h3>
<p>Since Win8. Can be logged in if there is internet access. Profiles and settings are stored in the cloud ☁️. Additional values are stored in SAM: <code>InternetUID</code> and <code>InternetUserName</code>. Both are unique to the user. <code>InternetUID</code> is a 16 byte Unicode string. <code>InternetUserName</code> - usually an email used as a login.</p>
<h3 id="domain-accounts">Domain Accounts</h3>
<p><strong>Key</strong> 🔑 : <code>Software\Microsoft\Windows NT\CurrentVersion\ProfileList</code>.</p>
<p>The key above will have a <code>ProfileImagePath</code>.</p>
<p>⚠️ SAM doesn&rsquo;t have any informaiton about domain accounts! See more info <a href="#software/domain-accounts">in software section, domain accounts</a>.</p>
<h3 id="deleted-accounts">Deleted Accounts</h3>
<p>🛠 Registry Explorer (Eric Zimmerman&rsquo;s tool) shows deleted accounts. If the data was not overwritten, we will be able to get the information.</p>
<p><code>C:\Windows\System32\Config</code></p>
<h3 id="default-accounts">Default Accounts</h3>
<p>Default local user account:</p>
<ul>
<li>Administrator</li>
<li>Guest</li>
<li>HelpAssistant</li>
<li>DefaultAccount</li>
</ul>
<p>Default system accounts (not visible for the user):</p>
<ul>
<li>SYSTEM</li>
<li>NETWORK SERVICE</li>
<li>LOCAL SEVICE</li>
</ul>
<p>There are two main places within the registry that contains that information: SAM hive for local and Microsoft accounts and <code>Software\Microsoft\Windows NT\CurrentVersion\ProfileList</code> for Domain Accounts.</p>
<blockquote>
<p>❗️❗️❗️❗️ More details see here.</p>
</blockquote>
<p>To crack Windows NTLM hashes (for local accounts only), you&rsquo;ll need both SYSTEM and SAM hives. SYSTEM contains an AES key 🔑 for NTLM decryption and SAM contains the encrypted hash. After the hash is decrypted, either brute-force 💪 or dictionary 📖 attack needs.</p>
<p>Xbox on later versions is a built-in game center. It also contains some information about the user (if he uses it for fames): <code>C:\Users\%Username%\AppData\Local\LocalState\ModelManager\Xboxlivegamer.xml</code> (user profile).</p>
<p>Also, collect DPAPI master user and system keys: <a href="https://www.youtube.com/watch?v=vA4qa0uWRHU">https://www.youtube.com/watch?v=vA4qa0uWRHU</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="se">\U</span>sers<span class="se">\%</span>username%<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se">\U</span>sers<span class="se">\%</span>username%<span class="se">\D</span>esktop
</span></span><span class="line"><span class="cl"><span class="se">\U</span>sers<span class="se">\%</span>username%<span class="se">\D</span>ocuments
</span></span><span class="line"><span class="cl"><span class="se">\U</span>sers<span class="se">\%</span>username%<span class="se">\D</span>ownloads
</span></span></code></pre></div><h2 id="-clear-text-creds">🗝️ Clear Text Creds</h2>
<h2 id="-tokens">🗝️ Tokens</h2>
<p>With tokens, one can pretend to be someone else. This is how SSO works. These tokens have some attributes assigned to them. Some attributes, like  <code>SeImpersonate</code>, let one process access the context or tokens of another process.</p>
<p>Each logon and process in the system has a token. This token determines what privileges this fellow has. This token consists of:</p>
<ul>
<li>User SID</li>
<li>Group SID</li>
<li>Integrity level (mandatory label). Vista+/WinServer 2008+. This label determines the process&rsquo;s privileges based on the assigned accesses and groups.</li>
<li>Logon session SID</li>
<li>Token type (primary or impersonation)</li>
<li>Impersonation level</li>
<li>User privileges list</li>
<li>Other</li>
</ul>
<p>Checks:</p>
<ul>
<li><input disabled="" type="checkbox"> <em>What is your mandatory label❓</em>
<ul>
<li><input disabled="" type="checkbox"> Compare this label to the object&rsquo;s label.</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> Take User and Group SIDs of the process and ACL of the object in question.</li>
</ul>
<h2 id="-lm-and-nt-hashes">🗝️ LM and NT Hashes</h2>
<h3 id="lm--deprecated">LM (⛔️ deprecated)</h3>
<p>LM hashes were used a long time ago and were very weak. They used DES and the following algorithm to secure a password.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Step 0. The length is at most 14 characters long</span>
</span></span><span class="line"><span class="cl"><span class="n">password</span> <span class="o">=</span> <span class="n">password</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Step 1. Convert all characters to uppercase</span>
</span></span><span class="line"><span class="cl"><span class="n">password</span> <span class="o">=</span> <span class="n">upper</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">pwd_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_caps</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">hash</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_caps</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Step 2. pad with 0s if the length is less than 14</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">14</span><span class="o">-</span><span class="n">pwd_len</span><span class="p">):</span> <span class="nb">hash</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Step 3. Split the password into two strings, each consisting of seven characters, and encrypt both parts individually.</span>
</span></span><span class="line"><span class="cl"><span class="n">first_part</span> <span class="o">=</span> <span class="n">encrypt_des</span><span class="p">(</span><span class="nb">hash</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span> 
</span></span><span class="line"><span class="cl"><span class="n">second_part</span> <span class="o">=</span> <span class="n">encrypt_des</span><span class="p">(</span><span class="nb">hash</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">all_caps</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Step 4. Return a concatenated string.</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="n">first_part</span> <span class="o">+</span> <span class="n">second_part</span>
</span></span></code></pre></div><p>The root cause of the vulnerability in the LM hash is the practice of padding the password with a known value (<code>0</code>s) and encrypting the two parts separately. This vulnerability becomes evident when the password length is equal to or less than 7 characters. In such cases, the second part of the string will always be the same value: <code>AAD3B435B51404EE</code>. As a result, passwords with a length of 7 characters or less are easier to crack due to this predictable pattern. One would need a rainbow table to do that.</p>
<h3 id="ntlm">NTLM</h3>
<p>DES + MD4 until SP3</p>
<h3 id="ntlmv2">NTLMv2</h3>
<p>MD5 <code>[username][sids][LM][NTLM]</code></p>
<blockquote>
<p>❗️LM hash is not generated if the password length is less than 15.
❗️Passwords are not salted.</p>
</blockquote>
<blockquote>
<p>❗️It is advisable not to utilize CredSSP on machines running an operating system older than Windows 8 when using batch scripts, as CredSSP caches credentials on remote systems. Additionally, CredSSP sends credentials over the network, making it vulnerable to Man-in-the-Middle (MiM) attacks.</p>
</blockquote>
<p>Each process, file or any other object has a set of requirements. For some process to get access, it needs to fulfil these requirements. At the same time, these processes have passports or tickets 🎫 which they can use to get something or somewhere. Requirements are called <strong>security descriptors</strong>; these &ldquo;passports&rdquo; are called <strong>access tokens</strong>. More information about both can be found <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens">here</a> and here.</p>
<p>Access tokens can have the following information (not limited):</p>
<ul>
<li>(SID) for the user&rsquo;s account or/and a group and their privileges</li>
<li>ID for current logon session - logon SID</li>
<li>Owner SID</li>
<li>The source of the access token</li>
<li>Primary or impersonalisation token?</li>
<li><strong>Integrity level</strong></li>
</ul>
<p>Security Descriptors also have a set of fields in it:</p>
<ul>
<li><strong>Integrity level</strong></li>
<li>SID of the owner or group</li>
<li>DACL (list of users allowed and what they can do)</li>
<li>SACL (list of access attempts that will generate alerts ⚠️)</li>
</ul>
<h2 id="-tickets">🗝️ Tickets</h2>
<p>Kerberos tickets are valid for 10 hours and stored in RAM. For more info on Kerberos and its abuse, see the article in attacks -&gt; protocols section.</p>
<p>🛠️ <code>Mimikatz</code>, 🛠️ <code>WCE</code>, 🛠️ <code>kerberoast</code></p>
<p><strong>📕 RTFM</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mimikatz &gt; privilege::debug
</span></span><span class="line"><span class="cl">mimikatz &gt; kerberos::ptt <span class="o">[</span>ticket<span class="o">]</span>
</span></span><span class="line"><span class="cl">mimikatz &gt; <span class="nb">exit</span>
</span></span><span class="line"><span class="cl">klist <span class="c1"># see the cache</span>
</span></span></code></pre></div><h2 id="-lsa-secrets">🏺 LSA Secrets</h2>
<p>🏺 <code>SECURITY\Policy\Secrets</code> - each key has its own registry 🔑 key. To decode them, use <code>SECURITY\Policy</code> 🔑 key. To finally decrypt - <code>SYSTEM</code> hive is needed. The attacker needs 👑 admin or higher privileges to access these keys 🔑.</p>
<p>🛠️ <code>Nishang</code>, <code>Get-LsaSecret.ps1</code> to dump and decrypt secrets.</p>
<p><strong>📕 RTFM</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Enable-DuplicateToken</span> <span class="c"># to get access to SECURITY hive by setting the token it&#39;s using to the same value as LSASS has.</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-LsaSecret</span>
</span></span></code></pre></div><h2 id="-cache">🏺 Cache</h2>
<p>🏺 <code>SECURITY\Cache</code> (requires 👑 to access). These credentials are in <code>mscash2</code> format (persists indefinitely). Use 🛠️ <code>creddump</code> to extract hashes from the hive (offline).</p>
<blockquote>
<p>❗️Can&rsquo;t be used in pass-the-hash attacks because they are salted and encrypted.</p>
</blockquote>
<p>By default, up to 25 hashes can be stored in the cache when someone logs in interactively. But how many hashes would be on a typical workstation? Hardly even 10. Attackers hope something interesting is left there.</p>
<h2 id="-sam">🏺 SAM</h2>
<p><strong>File path</strong> 🛣️: <code>C:\Windows\System32\config\SAM</code>.</p>
<p>⚠️ This file cannot be edited through the RegEdit unless the admin grants you permissions (data marked with red are not accessible unless the admin grants access):</p>
<p><img src="images/sam-hive-permissions.png" alt="sam-hive-permissions"></p>
<p>However, this file can be accessed on a dead-box system. ⚠️ Also, this file only stores local creds, not domain or Microsoft account credentials!</p>
<p>SAM is a database of files, and it stores all the information about all the users: login information, password hashes, and group information.</p>
<p>🛠 Registry Explorer (Eric Zimmerman&rsquo;s tool) can collect all users from the SAM and Profile files and show them assembled. This data can be exported to Excel, for example.</p>
<h2 id="-local-security-authority-subsystem-lsa">🏺 Local Security Authority Subsystem (LSA)</h2>
<p>Single Sign-on. LSA is its part. Responsible for authentication and authorisation. Manages <strong>derived</strong> credentials (NTLM, Kerberos tickets, sessions, hashes etc). The image file is located at <code>%WINDIR%\System32</code>.</p>
<p>🛠 <a href="https://github.com/D1rkMtr/DumpThatLSASS">https://github.com/D1rkMtr/DumpThatLSASS</a></p>
<h4 id="login-process">Login Process</h4>
<p>This is what a general picture looked like before Windows Vista came into play:</p>
<p><img src="images/login-vista-minus.png" alt="mypic">
<code>msgina.dll</code> is used to handle the login process. Starting from Windows Vista, the <code>msgine.dll</code> was deprecated.</p>
<p>If you want a more thorough picture to examine:</p>
<p><img src="images/lsa1.png" alt="img"></p>
<h4 id="login-types">Login Types</h4>
<p><code>Win32_LogonSession</code> class is used in Windows API to handle login, depending on the type.</p>
<p><img src="images/win32-logonsession.png" alt="img"></p>
<blockquote>
<p>📝 <code>0</code>.-<code>1</code>. - Not documented, but can occur in the wild. <code>1</code> - system logon?</p>
</blockquote>
<ol start="2">
<li>Console logon (keyboard, server KVM, VNC)</li>
<li>Network logon (SMB, some RDP)</li>
<li>Batch logon. This is used when a scheduled task initiates the logon.</li>
<li>Windows service logon (aka daemons in the UNIX world)</li>
<li>Proxy: This is not widely used, and is typically only used for &ldquo;non-trusted&rdquo; scenarios.</li>
<li>Creds used to lock and unlock the screen, RDP reconnect</li>
<li>Network logon with cleartext creds. This is typically associated with web-based logons.</li>
<li>Creds used != creds for logon. This logon type signifies that the <code>RunAs</code> command was used with the <code>/netonly</code> switch. The user is logging on to a system different from the one that was initially logged on to.</li>
<li>RDP</li>
<li>Cached creds. This logon occurs when a user logs on using cached credentials, typically when the domain controller is unavailable or when a laptop user is off the network.</li>
<li>Cached remote interactive (~ 10). This type of logon occurs when a user logs on with cached credentials to a remote system via RDP.</li>
<li>Cached unlock (~ 7). This logon occurs when a user unlocks a workstation using cached credentials.</li>
</ol>
<blockquote>
<p>📝 The primary benefit of NLA is that it can protect systems from being exposed to malicious users or software right upon connection. It does so by adding an extra layer of authentication at the start of the Remote Desktop Connection (RDC), before the login screen appears.</p>
</blockquote>
<p>As you can see from the picture, <code>uint32 LogonType</code> can be set to either of the 12 values. Types Console login and RunAs when using type 2, Remote Desktop when logging with type 10, PsExec alternate creds when used in combination of 3 and 2 logon types, Remote Scheduled Task using the 4th logon type and Run as a Service using the 5th logon types all store credentials on the target.</p>
<p><code>LsaLogonUser</code> class from <code>secur32.dll</code> is also a struct participating in the login process. As you can see from the picture, <code>pvoid AuthenticationInformation</code> is the field carrying the username and password.
<img src="images/lsalogonuser.png" alt="img"></p>
<h2 id="-tspkg-and-wdigest">🏺 <code>TsPkg</code> and <code>Wdigest</code></h2>
<blockquote>
<p>❗️ <code>TsPkg</code> and <code>WDigest</code> can be decrypted to retrieve plaintext passwords.</p>
</blockquote>
<p><code>TsPkg</code> (Terminal Services Package): TsPkg is a security package used in Microsoft Windows operating systems. It is part of the authentication process for Remote Desktop Services (formerly known as Terminal Services). TsPkg is responsible for negotiating and exchanging credentials between the client and the server during the remote desktop session initiation.</p>
<p><code>Wdigest</code>: Wdigest is a Windows security package that handles storing and retrieving user credentials (such as usernames and passwords) for Windows authentication. It was primarily used in older versions of Windows, including Windows 7 and earlier. Wdigest stored user passwords in a less secure format than newer authentication protocols. As a result, it became a target for potential security vulnerabilities, leading to its deprecation in later versions of Windows. <code>WDigest.dll</code> was introduced in the Windows XP operating system The Digest Authentication protocol is designed for use with Hypertext Transfer Protocol (HTTP) and Simple Authentication Security Layer (SASL) exchanges, as documented in RFCs <code>2617</code> and <code>2831</code>.”</p>
<p>To prevent WDigest credentials from being stored in memory, a Group Policy setting can be applied to the UseLogonCredential registry entry under the following subkey:</p>
<p><code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SecurityProviders\WDigest</code></p>
<ol>
<li>If the <code>UseLogonCredential</code> value is set to <code>0</code>, <code>WDigest</code> will not store credentials in memory.</li>
<li>If the <code>UseLogonCredential</code> value is set to <code>1</code>, <code>WDigest</code> will store credentials in memory.</li>
</ol>
<h2 id="-livessd">🏺 LiveSSD</h2>
<p>It is derived from the Windows Live cloud accounts.</p>
<h2 id="-ntdsdit">🏺 <code>NTDS.DIT</code></h2>
<p>🏺 <code>\%SystemRoot%\NTDS</code>. If the file is not here, check 🔑 <code>HKLM\SYSTEM\CurrecntControlSet\Services\NTDS\Parameters</code> to see where it&rsquo;s stored. To access this key, use <code>ntdsutil</code> or another tool to get raw access to the disk or get Volume Shadow copy with  🛠️ <code>VSSAdmin</code>.</p>
<p>You need 👑 to load a drive to access the raw disk or use Volume Shadow copy. Active Directory database stored encrypted passwords for all the domain accounts along with the password history. <code>NTDS.DIT</code> is in ESE format.</p>
<p>🛠️ <code>VSSAdmin</code> (to get Volume Shadow copy), 🛠️ <code>NTDSXtract</code>, 🛠️ <code>Metasploit</code>, 🛠️ <code>PowerShell</code>, 🛠️ <code>secretsdump.py</code> (<code>impacket</code>), 🛠️ <code>Bloodhound</code> (looks a lot like a threat modelling tool). 🛠️ <code>Bloodhound</code> uses LDAP and is quite stealthy. 🛠️ <code>GoFetch</code> uses Bloodhound to create a graph and then uses <code>Invoke-Mimikatz</code> and <code>Invoke-Psexec</code> and 🛠️ <code>DeathStar</code>, which uses 🛠️ <code>PowerShell Empire</code> to achieve pretty much the same result.</p>
<h2 id="-attacks">⚔️ Attacks</h2>
<blockquote>
<p>❗️Hashes are only present in RAM if the user is logged in <strong>interactively</strong> and is still logged in.</p>
</blockquote>
<ol>
<li><strong>Get the creds</strong> 🛠️ <code>fgdump</code>, c <code>AceHash</code>, 🛠️ <code>PWDumpX</code>, 🛠️ <code>creddump</code>,🛠️ <code>WCE</code>
<ol>
<li>Get from LSASS 🛠️ <code>Mimikatz</code> or <code>WCE</code> (Windows Credential Editor).</li>
<li>Dump LSASS for the offline attack.</li>
<li>Get from SAM hive in RAM or on disk 🛠️ <code>gsecdump</code> ❓ <code>gsecdump.exe -a &gt; file.txt</code></li>
<li>Get from the cache with 🛠️ <code>creddump</code>. One can get hashes, cached creds and LSA secrets from the hive.
<ol>
<li>📕 <code>pwdump.py SYSTEM SAM true</code> -&gt; local NT hashes.</li>
<li>📕 <code>cachedump.py SYSTEM SECURITY true</code> -&gt; Cached hashes.</li>
</ol>
</li>
<li>Get LSA secrets from</li>
</ol>
</li>
<li><strong>Crack the hash</strong> with the tools like 🛠️ <code>hashcat</code> or 🛠️ <code>John-the-Ripper</code>. LM hashes are very weak (see LM hash section). Both 🛠️ <code>John the ripper</code> and 🛠️ <code>hashcat</code> can crack hashes extracted from the cache, but the password needs to be very, very easy or in the wordlist. Otherwise - inefficient.</li>
<li><strong>Pass-the-hash</strong>. Use the hash in its original form. 🛠️ <code>Metasploit PsExec</code>, 🛠️ <code>WCE</code>, 🛠️ <code>SMBshell</code>. Limited to NTLM challenge-response protocol. Typically, use the SMB protocol to map file shares and perform PsExec-style remote execution or WMI. 📕 <code>sekurlsa::pth /user:someuser /domain:domaincontrollername /ntlm:hashstolen /run:&quot;.\psexec.exe -accepteula \\IP cmd.exe&quot;</code>.</li>
<li><strong>Escalate</strong>.
<ol>
<li><strong>Attribute change.</strong> With admin or <code>SYSTEM</code> privileges, one can add <code>SeImpersonate</code> attribute to a token to steal the tokens of another process and use them to access resources they could not access otherwise 🛠️ <code>Incognito</code>, 🛠️ <code>Metasploit</code>, 🛠️ <code>PowerShell</code>, 🛠️ <code>Mimikatz</code></li>
<li><strong>RID Hijacking</strong>. The system identifies users by their RIDs (the last portion of SID), not by username. What happens if we have manually changed the RID of the guest user? If we set it to <code>500</code>, the system would treat him as the default admin with all the corresponding rights.</li>
</ol>
</li>
<li><strong>Reset Password.</strong> There is also a technique that allows resetting local account passwords by clearing <code>lmpw_len</code> (LM password hash length) and <code>ntpw_len</code> (NTLM password hash length) at <code>0x2c</code> and <code>0x30</code>, respectively [<a href="http://www.ijfcc.org/vol5/455-F005.pdf">8</a>].</li>
</ol>
<p>📕 <strong>RTFM</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Changing TOKENS&#39; attributes</span>
</span></span><span class="line"><span class="cl">mimikatz &gt; privlege::debug <span class="c1"># attacker being authenticated as a local admin adds debug attribute to his token</span>
</span></span><span class="line"><span class="cl">token::whoami
</span></span><span class="line"><span class="cl">token::elevate /domainadmin <span class="c1"># mimikatz tool looks for the domain admin token in memory and retrieves it.</span>
</span></span></code></pre></div><h2 id="-detection-and--investigation">🔔 Detection and 🔎 Investigation</h2>
<p>🏺 <strong>Artefacts</strong></p>
<p>Event logs</p>
<p>🐾 <strong>Detection Patterns</strong></p>
<ol>
<li>New accounts created (Windows <code>4720</code>)</li>
<li>Anomalous logins (workstation to workstation, sensitive networks) - <code>4624</code>, <code>4776</code></li>
<li>After-hours logins</li>
<li>Unusual locations</li>
<li>Ex-employees</li>
<li>Privileged account usage (Windows <code>4672</code>)</li>
<li>Watch out for registry key 🔑<code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SecurityProviders\WDigest\UseLogonCredential</code> set <code>1</code>.</li>
</ol>
<p><strong>By login type</strong></p>
<ol>
<li>Console login, RunAs, PsExec alternate creds - look for logon type <code>2</code>.</li>
<li>Network use, PowerShell remoting (<code>Invoke-Command</code> and <code>Enter-PSSession</code>), PsExec alternate creds, PsExec w/o explicit creds and Remote registry - type <code>3</code>.</li>
<li>Remote Desktop - <code>10</code>.</li>
<li>Remote Scheduled tasks - <code>4</code> (password saved as LSA secret).</li>
<li>Run as Service - <code>5</code> (password saved as LSA secret).</li>
</ol>
<p>📚 <strong>Further reading</strong>: <a href="https://learn.microsoft.com/en-us/security/privileged-access-workstations/privileged-access-access-model">https://learn.microsoft.com/en-us/security/privileged-access-workstations/privileged-access-access-model</a></p>
<h2 id="-defense">🛡️ Defense</h2>
<p>PowerShell remoting is, so far, the most secure option. It enables Remote Credential Guard by default.</p>
<ol>
<li>UAC (MAC + least privilege).</li>
<li>A small number of apps should require admin privileges.</li>
<li>Managed Service accounts (good defence against Kerberos attacks): long complex passwords, frequent password changes. -&gt; Group Managed Service Accounts (flexible and admin-friendly).</li>
<li>Windows 8+
<ol>
<li>Doesn&rsquo;t cache credentials (even when using CredSSP), <code>TsPkg</code>, <code>Wdigest</code>.</li>
<li>New security groups were added. This restricted local admins from the network or remote interactive logons to domain-joint systems.</li>
<li>Some processes are marked as protected, and protected processes can&rsquo;t run unsigned code. LSASS process is one of the most important ones. This protection is off by default + one can sign the cred-dumping malware (like 🛠️ <code>Mimikatz</code>).</li>
<li>Remote Desktop with <code>/restrictedAdmin</code> switch -&gt; creds are not pushed to the remote system.</li>
<li>Domain Protected Users, security group. They can&rsquo;t use NTLM, CredSSP or Digest authentication mechanisms (protection against some of the 🛠️ <code>Mimikatz</code> techniques and pass-the-hash tools). Creds are not cached, nor are they delegated. Kerberos ticket 🎫 lives for 4 hours tops. RC4 encryption is off (too weak).</li>
<li>Group Managed Service accounts (gMSA). With GMSA, one can use the same account for several services and can be used on multiple computers within the same domain. MSA and gMSA automate password management for services (managed by AD), eliminate the need to hardcode the credentials, adhere to the least privilege principle, and isolate service accounts.</li>
</ol>
</li>
<li>Windows 10+
<ol>
<li>Remote Credential Guard. Protects all the accounts, not only admin.</li>
<li>Credential Guard. Uses machine virtualisation to isolate creds.</li>
<li>Device Guard. Can lock a system to prevent the use of untrusted code.</li>
</ol>
</li>
<li>User PowerShell</li>
<li>Don&rsquo;t interact logon to remote machines with an admin account (console, RDP and <code>runas</code>).</li>
<li>Terminate RDP sessions properly. The disconnect is NOT closed. You can set a timeout to terminate disconnected sessions. This can be set via Group Policy.</li>
<li>Assign <code>Account is Sensitive and Cannot be Delegated</code> attribute to prevent token delegation.</li>
<li>Limit the number of cached logon accounts in <code>SOFTWARE\Microsoft\Windows NT\Current Version\WInlogon</code>, <code>cachedlogonscount</code> value. Be careful, though, services need cached creds.</li>
<li>Complex passwords.</li>
<li>Add valuable users to the domain-protected users&rsquo; security group, not cache creds.</li>
</ol>
<p><strong>Built-in</strong>:</p>
<ol>
<li>can&rsquo;t remotely write to <code>C$</code> and <code>Admin$</code> shares</li>
<li>can&rsquo;t use some remote management tools like <code>schtasks</code>, <code>at</code>, <code>wmic</code> (if it&rsquo;s disabled).</li>
</ol>
<p><strong>Custom</strong>:</p>
<ol>
<li>Unique, strong passwords</li>
<li>No network logins for these accounts</li>
<li>2FA?</li>
</ol>
<h3 id="important-security-patches">Important Security Patches</h3>
<ol>
<li>KB2871997 - no clear text in LSASS, two security groups are created.</li>
<li>KB2928120 - The security update modifies the Group Policy Management Editor window of the Group Policy Management Console (GPMC) by removing the ability to configure and distribute passwords using the following Group Policy Preferences extensions.</li>
</ol>
<p>📚 <strong>Further reading</strong>: <a href="https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/the-importance-of-kb2871997-and-kb2928120-for-credential/ba-p/258478">https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/the-importance-of-kb2871997-and-kb2928120-for-credential/ba-p/258478</a></p>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    <p>[<a href="https://www.youtube.com/watch?v=hilLHF37ng8">1</a>] RID Hijaking by Sergey Klevogin, LPT Mater</p>
<p>[<a href="http://www.ijfcc.org/vol5/455-F005.pdf">2</a>] Analysis the Structure of SAM and Cracking Password Base on Windows Operating System, by Jiang Du and Jiwei Li</p>
<p>[<a href="https://www.youtube.com/watch?v=2Aa9_yq4BX4&amp;t=1s">3</a>] Вниз по кроличьей норе как работает аутентификация LSA, или Под капотом системы безопасности Windows,  Артем Синицын</p>
<p>[<a href="https://www.youtube.com/watch?v=aCVdGUjP72Q">3</a>] Diving into Windows Logon Process</p>
<p>[<a href="https://docs.microsoft.com/en-us/windows-server/security/windows-authentication/credentials-processes-in-windows-authentication">4</a>]</p>
<p>[<a href="https://www.coursera.org/learn/cybersecurity-compliance-framework-system-administration/lecture/wHoeT/features-of-active-directory">1</a>] IBM Course on Coursera</p>

</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
