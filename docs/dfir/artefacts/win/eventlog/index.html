<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸº Windows Event Log - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/dfir/artefacts/win/"> ğŸ‘ˆğŸ¼ Back to </br> ğŸªŸ Windows Artefacts </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#anatomy">Anatomy</a>
      <ul>
        <li><a href="#security">Security</a></li>
      </ul>
    </li>
    <li><a href="#-tools">ğŸ› ï¸ Tools</a>
      <ul>
        <li><a href="#event-viewer">Event Viewer</a></li>
        <li><a href="#event-log-explorer">Event Log Explorer</a></li>
        <li><a href="#evtxecmd">Evtxecmd</a></li>
        <li><a href="#chainsaw">Chainsaw</a></li>
        <li><a href="#kansa">Kansa</a></li>
        <li><a href="#psloglist">PSLogList</a></li>
        <li><a href="#f-response">F-Response</a></li>
        <li><a href="#kape">Kape</a></li>
        <li><a href="#velociraptor">Velociraptor</a></li>
        <li><a href="#powershell">Powershell</a></li>
        <li><a href="#sysmon">Sysmon</a></li>
      </ul>
    </li>
    <li><a href="#codes">Codes</a>
      <ul>
        <li><a href="#terminalservicesrdpclient">TerminalServicesRDPClient</a></li>
        <li><a href="#security-1">Security</a>
          <ul>
            <li><a href="#authentication-and-authorisation">Authentication and Authorisation</a></li>
            <li><a href="#4907">4907</a></li>
          </ul>
        </li>
        <li><a href="#network">Network</a>
          <ul>
            <li><a href="#4697">4697</a></li>
            <li><a href="#5140">5140</a></li>
            <li><a href="#5141---5145">5141 - 5145</a></li>
          </ul>
        </li>
        <li><a href="#system">System</a>
          <ul>
            <li><a href="#7045">7045</a></li>
            <li><a href="#104">104</a></li>
            <li><a href="#6416">6416</a></li>
            <li><a href="#20001">20001</a></li>
            <li><a href="#20002">20002</a></li>
          </ul>
        </li>
        <li><a href="#anti-forensics">Anti-Forensics</a>
          <ul>
            <li><a href="#1102">1102</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#exercise">Exercise</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">ğŸº Windows Event Log</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 02.06.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p><em>Event Logs in Windows provide valuable insights for defenders. They can be forwarded to a central machine to monitor organisational-level activities and detect malicious behaviour effectively.</em></p>
<h2 id="anatomy">Anatomy</h2>
<p>There are several major log trails: <code>Application</code> (individual apps activity), <code>Security</code> (logins and logouts etc.), <code>System</code> (OS derived), <code>Custom</code> (lots of them, for example, <code>PowerShell</code> logs) and <code>Forwarded (from remote)</code>. All of them are files with <code>evt</code> (WinXP, Windows 2003) or <code>evtx</code> (Vista +) extensions.</p>
<p>ğŸ“‚ <strong>Path</strong>: <code>%SystemRoot%\System32\config</code> (old Windows)</p>
<p>ğŸ“‚ <strong>Path</strong>: <code>%SystemRoot%\System32\winevt\logs</code> (newer Windows) + remote logs</p>
<p>IIS logs are by default here: ğŸ“‚ <code>C:\%System%\System32\LogFiles\W3SVC1</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\w</span>inevt<span class="se">\l</span>ogs<span class="se">\*</span>.evtx
</span></span><span class="line"><span class="cl"><span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\S</span>RU<span class="se">\s</span>rudb.dat
</span></span><span class="line"><span class="cl"><span class="se">\W</span>indows<span class="se">\i</span>nf<span class="se">\s</span>etupapi.dev.log
</span></span><span class="line"><span class="cl"><span class="se">\U</span>sers<span class="se">\%</span>username%<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\C</span>onnectedDevicesPlatform<span class="se">\*\A</span>ctivitiesCache.db
</span></span></code></pre></div><blockquote>
<p>â›”ï¸ Default location can be changed via the following keys ğŸ”‘ : <code>HKLM\SYSTEM\CurrentControlSet\Services\EventLog\Application</code>, <code>HKLM\SYSTEM\CurrentControlSet\Services\EventLog\System</code> and <code>HKLM\SYSTEM\CurrentControlSet\Services\EventLog\Security</code> (for each corresponding log trail).</p>
</blockquote>
<blockquote>
<p>â›”ï¸ These are binary files implemented as circular loops (call it Queue), meaning that the oldest entry will be overwritten the first. The logs are overwritten or archived depending on the settings, or the system raises an exception when running out of disk space.</p>
</blockquote>
<blockquote>
<p>â›”ï¸ Now it&rsquo;s only updated by LSASS. Third-party apps can&rsquo;t write the logs.</p>
</blockquote>
<p>Each event contains the following information:</p>
<ol>
<li>Log Name (aka a trail)</li>
<li>Source (which application is complaining)</li>
<li>ID - unique identifier for this event <strong>type</strong>. Meaning there will be a lot of events with the same Event ID.</li>
<li>EventRecord ID - unique identifier for this <strong>event</strong>. Meaning for each log entry, this value will be different.</li>
<li>Task Category - what is this event for?</li>
<li>Level - no worries (ğŸï¸), be careful (ğŸ¤”) or hell, my pants are on fire (ğŸ˜¨), you catch the drift.</li>
<li>Keywords - aka a tag, to help categorise an event.</li>
<li>User - user account responsible for this.ğŸ› ï¸</li>
<li>OpCode - Identify the specific operation that the event reports.</li>
<li>Timestamp when the event was logged.</li>
<li>Computer - the name of a machine responsible for this.</li>
<li>XML data - holds all the items from 1 to 10 and some more.</li>
</ol>
<p>ğŸ“š <strong>Further Reading</strong>: <a href="https://learn.microsoft.com/en-US/windows/security/threat-protection/">https://learn.microsoft.com/en-US/windows/security/threat-protection/</a></p>
<blockquote>
<p>â—ï¸If you don&rsquo;t see some event ids that you are supposed to, then try turning on all auditing policies using <code>secpol.msc</code> or going to <code>Start -&gt; Windows Administrative Tools -&gt; Local Security Policy</code>. In the opened window then go to <code>Local Policies</code> and choose <code>Audit Policy</code>. Either turn on each of them or turn on the ones that you think are responsible I was able to start capturing event 5156. I was using Vbox with Windows Server 2019 installed, and the machine was promoted to DC (Active Directory Feature installed).</p>
</blockquote>
<blockquote>
<p>â—ï¸ Most relevant events are recorded on the target system, but some are also present in the source system. We must combine those two to have a bigger picture, especially spotting lateral movement. Some events logged on the SOURCE system are Security <code>4648</code>, Security <code>4776</code> (ğŸ‘´ğŸ¼ <code>680</code>) and <code>Microsoft-Windows-TerminalServiceRDPClient</code> trail.</p>
</blockquote>
<h3 id="security">Security</h3>
<p>It&rsquo;s the most important trail. It records the following event types: account logon (whoever authorised logon), management, directory service (attempted access to AD objects), logon events (on a local system), object access, policy change, privilege user, process tracking, system events (start, shutdown, actions affecting this trail).</p>
<h2 id="-tools">ğŸ› ï¸ Tools</h2>
<h3 id="event-viewer">Event Viewer</h3>
<blockquote>
<p><em>â“How could an attacker delete entries from the Event Viewer and what level of access would they need?</em></p>
</blockquote>
<p>To configure what&rsquo;s being logged and what&rsquo;s ignored, set up the appropriate policies here -<code>secpol.msc</code>. Config example:</p>
<ol>
<li>Audit account logon events - success + failure</li>
<li>Audit account management - success + failure</li>
<li>Audit logon events - success + failure</li>
<li>Audit object access - failure (too many successes will be generated)</li>
<li>Audit privileged use - success + failure</li>
<li>Audit system events - success + failure</li>
</ol>
<p>This might chew up lots of disk space, so be careful. I might try this config to look for network events, I could not see before.</p>
<p>You can create a custom filter to pivot around some event. For example, filter for <code>4624</code> events. One can do it both in the UI menu or provide an XML query (ğŸ“š read more <a href="https://techcommunity.microsoft.com/t5/ask-the-directory-services-team/advanced-xml-filtering-in-the-windows-event-viewer/ba-p/399761">here</a>).</p>
<h3 id="event-log-explorer">Event Log Explorer</h3>
<p>Has a free version for non-commercial use. Allow creating lots of filters and has a GUI.</p>
<h3 id="evtxecmd">Evtxecmd</h3>
<p>Eric Zimmerman&rsquo;s <strong>Evtxecmd</strong> tool. Console tool that can export the result in a csv file. This csv can then be loaded into TimeLine explorer for further analysis.</p>
<h3 id="chainsaw">Chainsaw</h3>
<p>Is a CUI tool that has some predefined rules to search for interesting events. Can digest a lot of event logs at a time and produce a single output. For a usage example refer to the Blog section (Cybercorp1, calendar ğŸ“… Jan 2022).</p>
<h3 id="kansa">Kansa</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">.\</span><span class="n">Modules</span><span class="p">\</span><span class="n">Log</span><span class="p">\</span><span class="nb">Get-LogWinEvent</span><span class="p">.</span><span class="n">ps1</span> <span class="n">security</span> <span class="p">|</span> <span class="nb">Out-GridView</span>
</span></span></code></pre></div><h3 id="psloglist">PSLogList</h3>
<p>SysInternals</p>
<h3 id="f-response">F-Response</h3>
<p>Access to raw data on disk.</p>
<h3 id="kape">Kape</h3>
<h3 id="velociraptor">Velociraptor</h3>
<h3 id="powershell">Powershell</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="err">ğŸ“˜</span> <span class="nb">Get-WinEvent</span> <span class="n">-LogName</span> <span class="n">Security</span>
</span></span><span class="line"><span class="cl"><span class="err">ğŸ“˜</span> <span class="p">(</span><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">Win32_NTEventLogFile</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="n">LogFileName</span> <span class="o">-eq</span> <span class="s1">&#39;System&#39;</span><span class="p">).</span><span class="n">BackupEventLog</span><span class="p">(</span><span class="s2">&#34;output\path&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">ğŸ“˜</span> <span class="nb">Get-WinEvent</span> <span class="n">-ComputerName</span> <span class="n">blah</span> <span class="c"># remote</span>
</span></span><span class="line"><span class="cl"><span class="err">ğŸ“˜</span> <span class="nb">Get-WinEvent</span> <span class="n">-LogName</span> <span class="n">blah</span> <span class="c"># local</span>
</span></span><span class="line"><span class="cl"><span class="err">ğŸ“˜</span> <span class="nb">Get-WinEvent</span> <span class="n">-Path</span> <span class="n">blah</span> <span class="c"># archive</span>
</span></span></code></pre></div><h3 id="sysmon">Sysmon</h3>
<p>ğŸ“‘ <code>Microsoft-Windows-Sysmon/Operational</code> ( has prefiltering)</p>
<p><code>1</code> - <code>mof</code> compiled, <code>20</code> - Consumer added</p>
<p>Sysmon includes the following capabilities:</p>
<ul>
<li>Logs process creation with full command line for both current and parent processes.</li>
<li>Records the hash of process image files using SHA1 (the default), MD5, SHA256 or IMPHASH.</li>
<li>Multiple hashes can be used at the same time.</li>
<li>Includes a process GUID in process create events to allow for correlation of events even when Windows reuses process IDs.</li>
<li>Includes a session GUID in each event to allow correlation of events on same logon session.</li>
<li>Logs loading of drivers or DLLs with their signatures and hashes.</li>
<li>Logs opens for raw read access of disks and volumes.</li>
<li>Optionally logs network connections, including each connectionâ€™s source process, IP addresses, port numbers, hostnames and port names.</li>
<li>Detects changes in file creation time to understand when a file was really created. Modification of file create timestamps is a technique commonly used by malware to cover its tracks.</li>
<li>Automatically reload configuration if changed in the registry.</li>
<li>Rule filtering to include or exclude certain events dynamically.</li>
<li>Generates events from early in the boot process to capture activity made by even sophisticated kernel-mode malware.</li>
</ul>
<p>Log IDs 1-24 + 225.</p>
<p><a href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/">https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/</a></p>
<p><strong>System Logs</strong>.</p>
<p><strong>Security Logs</strong>.</p>
<p><strong>Application Logs</strong>. Not generally useful for IR.</p>
<h2 id="codes">Codes</h2>
<h3 id="terminalservicesrdpclient">TerminalServicesRDPClient</h3>
<blockquote>
<p>â—ï¸ Records activity on the SOURCE system</p>
</blockquote>
<p>Event ID 21: Remote Desktop Services: Session logon succeeded.</p>
<p>Event ID 23: Remote Desktop Services: Session logoff succeeded.</p>
<p>Event ID 24: Remote Desktop Services: Session has been disconnected.</p>
<p>Event ID 25: Remote Desktop Services: Session reconnection succeeded.</p>
<p>Event ID 39: Session X has been disconnected by session Y.</p>
<h3 id="security-1">Security</h3>
<p>Event ID 4624: This event is generated when a logon session is created (i.e., a user successfully logs on).</p>
<p>Event ID 4625: This event is generated when a logon request fails.</p>
<p>Event ID 4648: This event is generated when a logon is attempted using explicit credentials, which often indicates a user is attempting to run a program as a different user.</p>
<p>Event ID 4672: This event is generated when a user logs on with superuser (or admin) rights.</p>
<p>Event ID 4700-4702: These events are related to scheduled tasks and can indicate when a task is triggered or finished.</p>
<p>Event ID 4720: This event is generated when a user account is created.</p>
<p>Event ID 4728: This event is generated when a user is added to a security-enabled global group.</p>
<p>Event ID 4732: This event is generated when a user is added to a security-enabled local group.</p>
<p>Event ID 4738: This event is generated when a user account is updated.</p>
<p>Event ID 4768: A Kerberos authentication ticket (TGT) was requested.</p>
<p>Event ID 4776: The domain controller attempted to validate the credentials for an account.</p>
<p>Event ID 7045: A service was installed in the system.</p>
<h4 id="authentication-and-authorisation">Authentication and Authorisation</h4>
<p>When the logon is failing, the following error codes are the most frequently used (NTLM ğŸ—ï¸ and Kerberos ğŸ•â€ğŸ¦º):</p>
<ol>
<li>ğŸ—ï¸ <code>C0000064</code> (ğŸ•â€ğŸ¦º <code>0x6</code>) - the username provided is invalid (doesn&rsquo;t exist).</li>
<li>ğŸ—ï¸ <code>C000006A</code> (ğŸ•â€ğŸ¦º <code>0x18</code>) - the password provided is invalid.</li>
<li>ğŸ—ï¸ <code>C0000070</code> (ğŸ•â€ğŸ¦º <code>0xC</code>) - unauthorised workstation.</li>
<li>ğŸ—ï¸ <code>C0000234</code> (ğŸ•â€ğŸ¦º <code>0x12</code>) - account is locked.</li>
<li>ğŸ—ï¸ <code>C0000071</code> (ğŸ•â€ğŸ¦º <code>0x17</code>) - the password has expired.</li>
<li>ğŸ•â€ğŸ¦º <code>0x7</code> - server was not found.</li>
<li>ğŸ•â€ğŸ¦º <code>0x25</code> - the time difference between the machines is too big.</li>
</ol>
<h4 id="4907">4907</h4>
<p>Audit policy change.</p>
<blockquote>
<p>This event generates when the SACL of an object (for example, a registry key or file) was changed.</p>
</blockquote>
<p>Windows System Logs</p>
<p>Event ID 1074 (System Shutdown/Restart): This event log indicates when and why the system was shut down or restarted. By monitoring these events, you can determine if there are unexpected shutdowns or restarts, potentially revealing malicious activity such as malware infection or unauthorized user access.
Event ID 6005 (The Event log service was started): This event log marks the time when the Event Log Service was started. This is an important record, as it can signify a system boot-up, providing a starting point for investigating system performance or potential security incidents around that period. It can also be used to detect unauthorized system reboots.
Event ID 6006 (The Event log service was stopped): This event log signifies the moment when the Event Log Service was stopped. It is typically seen when the system is shutting down. Abnormal or unexpected occurrences of this event could point to intentional service disruption for covering illicit activities.
Event ID 6013 (Windows uptime): This event occurs once a day and shows the uptime of the system in seconds. A shorter than expected uptime could mean the system has been rebooted, which could signify a potential intrusion or unauthorized activities on the system.
Event ID 7040 (Service status change): This event indicates a change in service startup type, which could be from manual to automatic or vice versa. If a crucial service&rsquo;s startup type is changed, it could be a sign of system tampering.
Windows Security Logs</p>
<p>Event ID 1102 (The audit log was cleared): I&rsquo;ve already discussed this one, but to reiterate, clearing the audit log is often a sign of an attempt to remove evidence of an intrusion or malicious activity.
Event ID 1116 (Antivirus malware detection): This event is particularly important because it logs when Defender detects a malware. A surge in these events could indicate a targeted attack or widespread malware infection.
Event ID 1118 (Antivirus remediation activity has started): This event signifies that Defender has begun the process of removing or quarantining detected malware. It&rsquo;s important to monitor these events to ensure that remediation activities are successful.
Event ID 1119 (Antivirus remediation activity has succeeded): This event signifies that the remediation process for detected malware has been successful. Regular monitoring of these events will help ensure that identified threats are effectively neutralized.
Event ID 1120 (Antivirus remediation activity has failed): This event is the counterpart to 1119 and indicates that the remediation process has failed. These events should be closely monitored and addressed immediately to ensure threats are effectively neutralized.
Event ID 4624 (Successful Logon): This event records successful logon events. This information is vital for establishing normal user behavior. Abnormal behavior, such as logon attempts at odd hours or from different locations, could signify a potential security threat.
Event ID 4625 (Failed Logon): This event logs failed logon attempts. Multiple failed logon attempts could signify a brute-force attack in progress.
Event ID 4648 (A logon was attempted using explicit credentials): This event is triggered when a user logs on with explicit credentials to run a program. Anomalies in these logon events could indicate lateral movement within a network, which is a common technique used by attackers.
Event ID 4656 (A handle to an object was requested): This event is triggered when a handle to an object (like a file, registry key, or process) is requested. This can be a useful event for detecting attempts to access sensitive resources.
Event ID 4672 (Special Privileges Assigned to a New Logon): This event is logged whenever an account logs on with super user privileges. Tracking these events helps to ensure that super user privileges are not being abused or used maliciously.
Event ID 4698 (A scheduled task was created): This event is triggered when a scheduled task is created. Monitoring this event can help you detect persistence mechanisms, as attackers often use scheduled tasks to maintain access and run malicious code.
Event ID 4700 &amp; Event ID 4702 (A scheduled task was enabled/disabled): This records the enabling or disabling of a scheduled task. Scheduled tasks are often manipulated by attackers for persistence or to run malicious code, thus these logs can provide valuable insight into suspicious activities.
Event ID 4702 (A scheduled task was updated): Similar to 4698, this event is triggered when a scheduled task is updated. Monitoring these updates can help detect changes that may signify malicious intent.
Event ID 4719 (System audit policy was changed): This event records changes to the audit policy on a computer. It could be a sign that someone is trying to cover their tracks by turning off auditing or changing what events get audited.
Event ID 4738 (A user account was changed): This event records any changes made to user accounts, including changes to privileges, group memberships, and account settings. Unexpected account changes can be a sign of account takeover or insider threats.
Event ID 4771 (Kerberos pre-authentication failed): This event is similar to 4625 (failed logon) but specifically for Kerberos authentication. An unusual amount of these logs could indicate an attacker attempting to brute force your Kerberos service.
Event ID 4776 (The domain controller attempted to validate the credentials for an account): This event helps track both successful and failed attempts at credential validation by the domain controller. Multiple failures could suggest a brute-force attack.
Event ID 5001 (Antivirus real-time protection configuration has changed): This event indicates that the real-time protection settings of Defender have been modified. Unauthorized changes could indicate an attempt to disable or undermine the functionality of Defender.
Event ID 5140 (A network share object was accessed): This event is logged whenever a network share is accessed. This can be critical in identifying unauthorized access to network shares.
Event ID 5142 (A network share object was added): This event signifies the creation of a new network share. Unauthorized network shares could be used to exfiltrate data or spread malware across a network.
Event ID 5145 (A network share object was checked to see whether client can be granted desired access): This event indicates that someone attempted to access a network share. Frequent checks of this sort might indicate a user or a malware trying to map out the network shares for future exploits.
Event ID 5157 (The Windows Filtering Platform has blocked a connection): This is logged when the Windows Filtering Platform blocks a connection attempt. This can be helpful for identifying malicious traffic on your network.
Event ID 7045 (A service was installed in the system): A sudden appearance of unknown services might suggest malware installation, as many types of malware install themselves as services.
Event ID 1102 (The audit log was cleared): This event suggests that someone is trying to hide their activity, as clearing the audit log is often associated with attempts to remove traces of a breach.</p>
<h3 id="network">Network</h3>
<p>Check for ğŸ‘£ Windows Security Event Log <code>5156</code> is triggered when a network connection is allowed. 4688 - new process starting. <code>5158</code> -&gt; <code>5031</code> binding started and terminated by fw.</p>
<p>Filter out internal addresses (they are not interesting initially). Check the remote connections. Check executables that launched these connections, also look for port-services mismatch or unusual ports or services. â˜ï¸ malware section as well.</p>
<p><code>5158</code> <code>5154</code> -&gt;</p>
<p><code>5158</code> -&gt; <code>5031</code> binding started and terminated by firewall.</p>
<p>PID, Application field (path to the executable and exe name), Inbound/Outbound, <code>sport</code>/<code>dport</code>, addresses (src and dst), protocol field.</p>
<p>Windows Security Event Log <code>5156</code> is triggered when a network connection is allowed. 4688 - new process starting.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"> <span class="nb">write-EventLog</span> <span class="n">-eventID</span> <span class="n">5156</span> <span class="n">-EntryType</span> <span class="n">FailureAudit</span> <span class="n">-message</span> <span class="s2">&#34;hello&#34;</span> 
</span></span><span class="line"><span class="cl"> <span class="p">&gt;</span><span class="n">Log</span> <span class="n">Application</span>
</span></span><span class="line"><span class="cl"> <span class="p">&gt;</span><span class="n">Source</span> <span class="n">Application</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> <span class="n">auditpol</span> <span class="p">/</span><span class="nb">set </span><span class="p">/</span><span class="n">subcategory</span><span class="err">:â€</span><span class="n">Filtering</span> <span class="n">Platform</span> <span class="n">Connection</span><span class="err">â€</span> <span class="p">/</span><span class="n">success</span><span class="err">:</span><span class="n">disable</span> <span class="p">/</span><span class="n">failure</span><span class="err">:</span><span class="n">enable</span>
</span></span></code></pre></div><p><img src="images/5156-event.png" alt="5156-event"></p>
<p><strong>External IPs reputations</strong>. ğŸ›  <code>hostintel</code>. For running the tool, you&rsquo;ll also need to create a file with a list of IPs. I&rsquo;ve created a file <code>i.txt</code> in the <code>hostintel</code> directory and so my command was:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python hostintel.py config.conf i.txt
</span></span></code></pre></div><p>Filter the record to indentify external IP addresses with which the PC is commincating. Then check external IPs reputations for suspicious using, for example, <code>hostintel</code>.</p>
<p>To use <a href="https://github.com/keithjjones/hostintel">hostintel</a>, install it following the instructions on GitHub. Then install geoip2 using  <code>pip install &quot;geoip2==3.0.0&quot; </code>. I got an error that <code>geoip.database</code> was not installed when I installed it with <code>pip install geoip2</code> or from GitHub. This module is for working with GeoIP databases.</p>
<p>To actually use these databases (one is included with the tool, but it mught get outdated), signup <a href="https://www.maxmind.com/en/geoip2-databases">here</a> and download GeoLite2 City from <a href="https://www.maxmind.com/en/accounts/410417/geoip/downloads">here</a>. This is an archive, unpack it and put the *.mmb file in <code>hostintel/data</code> folder (replace). These dbs are used by other tools as well, so you might want to keep it elsewhere and change its path in config.</p>
<p>Also, about the config. Edit this config - <code>hostintel/sampleconfig.conf</code>. By default, only GeoLite2 City is used, but you can add your free public API keys from different threat intelligence resources like VirusTotal, Censys, OTX, Passive Total or/and Shodan. You should rename it more appropriately, like <code>config.conf</code> or <code>aliens-are-among-us.conf</code> ğŸ‘½. But remember the name of the config, whatever it is, to run the tool.</p>
<p><strong>Frequency Analysis</strong>. How frequently is the host connecting to another machine? For how long? Maybe it is something legitimate. But if it&rsquo;s recent or/and not regular - it could be an indicator.</p>
<p>Unusual. Unusual application names, paths, typos or poker hand ports (<code>44488</code> <code>12345</code> or like). Or may some gibberish names. Unusual protocols - <code>1</code> (ICMP) <code>6</code> (TCP) <code>70</code> (UDP). Look for the ports outside of these three.</p>
<p>Use the Microsoft website for more info on specific events - ğŸ“š <a href="https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4624">https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4624</a>.</p>
<h4 id="4697">4697</h4>
<p>Security.</p>
<p>New service installed.</p>
<h4 id="5140">5140</h4>
<p>Security.</p>
<p>Mount shares.</p>
<h4 id="5141---5145">5141 - 5145</h4>
<p>Security.</p>
<p>SMB shares</p>
<h3 id="system">System</h3>
<h4 id="7045">7045</h4>
<p>Service installed. Logged by default. Services started with user credentials are suspicious.</p>
<h4 id="104">104</h4>
<p><strong>System</strong>. Logs what logs were cleared ğŸ¥¶. Logs their SID.</p>
<h4 id="6416">6416</h4>
<p>USB</p>
<h4 id="20001">20001</h4>
<h4 id="20002">20002</h4>
<h3 id="anti-forensics">Anti-Forensics</h3>
<h4 id="1102">1102</h4>
<p><strong>Security</strong>. Logs what user cleared the logs.</p>
<h2 id="exercise">Exercise</h2>
<p>I&rsquo;ve set up my lab as vaguely described <a href="/docs/blog/2021/03/how-i-have-built-my-lab">here</a>. Then, I&rsquo;ve logged into the user <code>sherlock</code> account. Now, I want to see this even in the Event Viewer. Most probably, it&rsquo;s the Security of System logs. I have wrong time settings on the both machines, but I don&rsquo;t think it&rsquo;s a problem for now. I&rsquo;ve noticed some Logon of type 3 in the logs, but the user is not specified. I don&rsquo;t quite remember, which id the network logon type has. I think it&rsquo;s 4&hellip; .</p>
<p>No, logon type 3 is the network logon. Weird. It happens very often.</p>
<p>Since there is no SID shown, I suspect that might be a system acc.</p>
<p>Sorting took some time, and I have noticed that Logon events have these IDs: 4624, 4634, 4625, 4648. Now I am going to filter by these IDs and revert to sorting by date and time. Nothing was found. I&rsquo;ve cleared IDs, leaving just the user name. The filter returned no results as well.</p>
<p>However, I&rsquo;ve also noticed, that even though no username was specified (<code>N/A</code>), the PC name was mentioned: SHERLOCKPC$. Using this to filter the logs, resulted in null results. Tried SHERLOCKPC as well - nothing.</p>
<p>Some packet was blocked.</p>
<p>Clear log. Then try logging in several times with the wrong password. Then log in with the correct one. Observe the logs. Well, seems like <code>Logon</code> and <code>Logoff</code> events are not initiated by the user. So, the login attempts are actually <code>Kerberos Authentication Service</code>. Now it makes more sense. Let&rsquo;s filter by this event (4768 - success and 4771 - failure). After successful authentication, we have Kerberos Service Ticket Operations (4769). And now I have it!</p>
<p>I&rsquo;ve now triggered several authentication failures and one authentication success. And there it is. I have 2 events 4771 (failures) then one event 4768 (success) followed by three events 4769. Why three?</p>
<p>Every minute 4624 and 4634 events are created, meaning new session creating. It seems so that every time I do something in my user account, the events 4624 and 4634 emerge in the logs. Or just every minute.</p>
<p>Let&rsquo;s go to the user PC (sherlock) and see his logs. It says that access was denied (either the query is too long or the daemon is not running). Of course, the first thing to do was to check whether the service is really running, but it was. So, the problem was something else. Query too long? Don&rsquo;t think so, since I have not created any views so far. I tried to clear the logs, but failed. May be it&rsquo;s because the DC is shutdown, or because the user doesn&rsquo;t have the rights to do so. The only way to check that is to turn on the DC.</p>
<p>Can&rsquo;t find the event id that is associated with this activity. I Thought 5152 was, but then I saw it appeared on its own.</p>
<p>However System logs had one interesting entry. But failing again has not triggered it.</p>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    ğŸ“š <a href="https://cybersecuritynews.com/windows-event-log-analysis/">https://cybersecuritynews.com/windows-event-log-analysis/</a>
</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
