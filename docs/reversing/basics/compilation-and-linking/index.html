<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Compilation and Linking 🔗 - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.9d91cbb32c96c334ae7b38c3d99d30727e0836e1182125cc5f007d215f0b9e59.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-forensics 🔍 and incident response 🥷">
      <a href="/docs/dfir">
        <span>Forensics 🔍 and Incident Response 🥷</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-forensics 🔍 and incident response 🥷">
      <a href="/docs/dfir">
        <span>Forensics 🔍 and Incident Response 🥷</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/reversing/basics/"> Back to Basics 📚 Section 👈🏼 </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#terms">Terms</a></li>
    <li><a href="#linking-types">Linking types</a></li>
    <li><a href="#compilations-and-linking-steps">Compilations and Linking steps</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
 </div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Compilation and Linking 🔗</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
                <i class="fas fa-archive"></i>
              
          <a class="category-link" href="/domain/general">general</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
                <i class="fa fa-graduation-cap"></i>
              
          <a class="platform-link" href="/doctype/article">article</a>
          
      </div> <br /><br/>
      
      
      
      
      <div class="article-category">
          
            
            
            
            
            
              <i class="fab fa-linux"></i>&nbsp;<i class="fab fa-apple"></i>&nbsp;<i class="fab fa-windows"></i>&nbsp;<i class="fas fa-mobile"></i>
            
          <a class="platform-link" href="/platforms/all">all</a>
          
      </div> <br />
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p><em>In this article I am trying to reasearch compilation and linking process.</em></p>
<h2 id="terms">Terms</h2>
<p><code>.cpp</code> - is a human-readable file written in any programming language. In this example it&rsquo;s a file written in C++. An example of this file (meaningless for simplicity sake):</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span> 
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p><code>.obj</code>,  <code>.coff</code> - binary file with its own structure. 1 file of source code (<code>*.cpp</code>) is compiled into 1 <code>.obj</code> or <code>.coff</code> file. Consists of sections, symbol table (name and current location of variable or function that can be referenced by other object files), relocation table (addresses referenced in this file that the linker must adjust when it knows the final memory layout) and debug info. A header that says where in the files the sections below are located  A (concatenated) text segment, which contains all the source code (with some missing addresses)  A (concatenated) data segment (which combines all data and the bss segments)</p>
<p><code>.exe</code> - an executable file with a PE header. Signature - MZ (<code>0x4d 0x5a</code>). Runs as a separate process. An exampe in hex is shown below. More on PE files in a separate article.</p>
<p><img src="images/2.png" alt="Screenshot 2021-02-11 at 20.56.02"></p>
<p><code>.dll</code> - an executable file with a PE header, but some flags are different. Signature is the same - MZ (<code>0x4d 0x5a</code>). Doesn&rsquo;t run as a separate process, loaded by exe. It&rsquo;s <strong>d</strong>ynamically <strong>l</strong>inked <strong>l</strong>ibrary (thus d-l-l).</p>
<p><strong>Compiler</strong> - converts the source human-readable code written by the programmer (<code>*.cpp</code> for example) to a machine level language (pure binary).</p>
<p><strong>Assembler</strong> - not to be confused with assembly. Converts assembly code to a machine level language (pure binary). Assembler is usually a part of a compiler. Some compilers will translate for example C++ code into assembly and then into machine code if a special flag is passed. Otherwise they compile to ones and zeroes directly.</p>
<p><strong>Linker</strong> - assemles several object files into 1 executable. Organizes memory.</p>
<p><strong>Loader</strong> - reads PE file header, .text and .data sections length and allocates the space in memory.</p>
<h2 id="linking-types">Linking types</h2>
<p><strong>Static</strong> - added to the executable at link time (by the linker). This way, the library&rsquo;s .text section is combined with the object file&rsquo;s .text section and the library&rsquo;s .data section is combined with the object file&rsquo;s .data section. Thus they become one executable. This increases the size of the final executable file.</p>
<p><strong>Runtime</strong> - load library and call a function only when they are needed. Usually with <code>LoadLibrary</code> WinAPI function. Common for malware because this way the import table doesn&rsquo;t reveal the full functionality.</p>
<p><strong>Dynamic</strong> - dll for windows and dlib for Mac OS. There are added into memory on laod by the loader (surprise!). The most common way of linking libraries since the size of executables are not increased and libraries can be updated separately.</p>
<h2 id="compilations-and-linking-steps">Compilations and Linking steps</h2>
<p>Assembler only knows one binary file at a time. It doesn&rsquo;t know the final memory layout and addresses from other files (addresses for external functions and variables (for example, <code>printf()</code>)). It puts zeroes instead for each address unknown. Linker will rewrite these zeroes with the correct values once it knows the final memory layout (addersses). Assembler puts labels istead of function calls.</p>
<p><em>❓ But how does the linker know what these labels mean and what addresses they are at?</em></p>
<p>Assembler creates two tables so that the linker/loader can replace the labels with addresses later.</p>
<table>
<thead>
<tr>
<th>symbol table</th>
<th>relocation table</th>
</tr>
</thead>
<tbody>
<tr>
<td>It&rsquo;s actually an export table. List of all items in this file that are referenced by this file itself or by other files (functions, variables, structures).</td>
<td>Basically, it&rsquo;s an import table. List of items from other files or libraries that are needed by this file.</td>
</tr>
<tr>
<td>[name] [offset]</td>
<td># code line to fix???</td>
</tr>
</tbody>
</table>
<p>After assembler or compiler is done with the source code file, linker comes in 💃 . It <strong>links</strong> text to text and data to data from all object files that are to be assembled into one executable. There would be no job for the linker, if there were one object file only and no static libraries. It uses the relocation table to see what lines to fix and symbol table to know how. It calculates absolute addresses to place instead of zeroes put by assembler or compiler.</p>
<p>Linker knows the length of .text and .data. It knows the correct order -&gt; it can calculate addresses. Linker looks at the relocation table. For each line of code to fix it reads the label and then finds in symbol tables of this and other object files. When it finds the label, it reads its offset, calculates the absolute address and fixes the line from the relocation table.</p>
<p>The last stage is when the loader comes in. It copies .text and .data into memory, copies arguments on stack and initialized registers. Starts the program. Performs runtime linking of libraries.</p>
<p><img src="images/1.png" alt="Screenshot 2021-02-10 at 10.58.15"></p>
<h2 id="references">References</h2>
<p><a href="http://courses.ics.hawaii.edu/ReviewICS312/morea/LinkingLoading/ics312_linkingloading.pdf">http://courses.ics.hawaii.edu/ReviewICS312/morea/LinkingLoading/ics312_linkingloading.pdf</a></p>
<p><a href="https://stackoverflow.com/questions/3080213/does-a-compiler-have-an-assembler-too">https://stackoverflow.com/questions/3080213/does-a-compiler-have-an-assembler-too</a></p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.1237ff71925bb8625c97a9af8db4c54525258bedfd7c47493daaff723bea755e.js"></script>
  

  
  
  
    
  


</body>

</html>
