<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Advanced Incident Response &amp; Threat Hunting - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.eeb61b3f25f73088eb3aeb02bc61f28d33975f447fc5649add3b83c10059c331.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-forensics 🔍 and incident response 🥷">
      <a href="/docs/dfir">
        <span>Forensics 🔍 and Incident Response 🥷</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-forensics 🔍 and incident response 🥷">
      <a href="/docs/dfir">
        <span>Forensics 🔍 and Incident Response 🥷</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/notes/gcfa/"> Back to GCFA Section 👈🏼 </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#legend">Legend</a></li>
    <li><a href="#exercises">Exercises</a></li>
    <li><a href="#topics">Topics</a>
      <ul>
        <li><a href="#real-incident-response-tactics">Real Incident Response Tactics</a>
          <ul>
            <li><a href="#preparation">Preparation</a></li>
            <li><a href="#identificationscoping">Identification/Scoping</a></li>
            <li><a href="#containmentintelligence-developmen">Containment/Intelligence Developmen</a></li>
            <li><a href="#eradicationremediation">Eradication/Remediation</a></li>
            <li><a href="#recovery">Recovery</a></li>
            <li><a href="#avoiding-whack-a-mole-incident-response">Avoiding &ldquo;Whack-A-Mole&rdquo; Incident Response</a></li>
          </ul>
        </li>
        <li><a href="#threat-hunting">Threat Hunting</a>
          <ul>
            <li><a href="#hunting-versus-reactive-response">Hunting versus Reactive Response</a></li>
            <li><a href="#intelligence-driven-incident-response">Intelligence-Driven Incident Response</a></li>
            <li><a href="#building-a-continuous-incident-responsethreat-hunting-capability">Building a Continuous Incident Response/Threat Hunting Capability</a></li>
            <li><a href="#forensic-analysis-versus-threat-hunting-across-endpoints">Forensic Analysis versus Threat Hunting Across Endpoints</a></li>
            <li><a href="#threat-hunt-team-roles">Threat Hunt Team Roles</a></li>
            <li><a href="#attck---mitres">ATT&amp;CK - MITRE&rsquo;s</a></li>
          </ul>
        </li>
        <li><a href="#threat-hunting-in-the-enterprise">Threat Hunting in the Enterprise</a>
          <ul>
            <li><a href="#identification-of-compromised-systems">Identification of Compromised Systems</a></li>
            <li><a href="#finding-active-and-dormant-malware">Finding Active and Dormant Malware</a></li>
            <li><a href="#digitally-signed-malware">Digitally Signed Malware</a></li>
            <li><a href="#malware-characteristics">Malware Characteristics</a></li>
            <li><a href="#common-hiding-mechanisms">Common Hiding Mechanisms</a></li>
            <li><a href="#finding-evil-by-understanding-normal">Finding Evil by Understanding Normal</a></li>
          </ul>
        </li>
        <li><a href="#incident-response-and-hunting-across-endpoints">Incident Response and Hunting across Endpoints</a>
          <ul>
            <li><a href="#wmic--powershell">WMIC &amp; PowerShell</a></li>
            <li><a href="#powershell-remoting-scalability">PowerShell Remoting Scalability</a></li>
            <li><a href="#powershell-remoting-credential-safeguards">PowerShell Remoting Credential Safeguards</a></li>
            <li><a href="#kansa-powershell-remoting-ir-framework">Kansa PowerShell Remoting IR Framework</a></li>
          </ul>
        </li>
        <li><a href="#malware-defense-evasion-and-identification">Malware Defense Evasion and Identification</a>
          <ul>
            <li><a href="#service-hijackingreplacement">Service Hijacking/Replacement</a></li>
            <li><a href="#frequent-compilation">Frequent Compilation</a></li>
            <li><a href="#binary-padding">Binary Padding</a></li>
            <li><a href="#packingarmoring">Packing/Armoring</a></li>
            <li><a href="#dormant-malware">Dormant Malware</a></li>
            <li><a href="#signing-code-with-valid-certificates">Signing Code with Valid Certificates</a></li>
            <li><a href="#anti-forensicstimestomping">Anti-Forensics/Timestomping</a></li>
          </ul>
        </li>
        <li><a href="#malware-persistence-identification">Malware Persistence Identification</a>
          <ul>
            <li><a href="#autostart-locations-runkeys">AutoStart Locations, RunKeys</a></li>
            <li><a href="#service-creationreplacement">Service Creation/Replacement</a></li>
            <li><a href="#service-failure-recovery">Service Failure Recovery</a></li>
            <li><a href="#scheduled-tasks">Scheduled Tasks</a></li>
            <li><a href="#dll-hijacking">DLL Hijacking</a></li>
            <li><a href="#wmi-event-consumers">WMI Event Consumers</a></li>
          </ul>
        </li>
        <li><a href="#investigating-wmi-based-attacks">Investigating WMI-Based Attacks</a>
          <ul>
            <li><a href="#wmi-overview">WMI Overview</a></li>
            <li><a href="#wmi-attacks-across-the-kill-chain">WMI Attacks Across the Kill Chain</a></li>
            <li><a href="#auditing-the-wmi-repository">Auditing the WMI Repository</a></li>
            <li><a href="#wmi-file-system-and-registry-residue">WMI File System and Registry Residue</a></li>
            <li><a href="#command-line-analysis-and-wmi-logs">Command-Line Analysis and WMI Logs</a></li>
            <li><a href="#wmi-process-anomalies">WMI Process Anomalies</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#resources">Resources</a></li>
  </ul>
</nav>
 </aside>
 </div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Advanced Incident Response &amp; Threat Hunting</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
                <i class="fas fa-search"></i>
              
          <a class="category-link" href="/domain/forensics">forensics</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
                <i class="fas fa-list-ul"></i>
              
          <a class="platform-link" href="/doctype/plan">plan</a>
          
      </div> <br /><br/>
      
      
      
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <h2 id="legend">Legend</h2>
<p>Below is the skeleton from SAN508 course description. I am using it to make up my study plan. For each step of this plan I estimate my current level of training and I am also collecting resourced for this topic under <em>Resources</em>.</p>
<p>🫑 - <strong>level <code>0</code></strong>. I know nothing and not even where to start. I might have some embarrassingly fundamental knowledge which is not good enough even for the start.</p>
<p>🥒 - <strong>level <code>1</code></strong>. I know something about the subject, but this only gives me an approximate plan and kind of things to look for.</p>
<p>🥗 - <strong>level <code>2</code></strong>. I know something about the subject, I&rsquo;ve even read something about it. But no hands-on eperience.</p>
<p>🌮 - <strong>level <code>3</code></strong>. I know quite a lot about the subject, I&rsquo;ve read something about it and some hands-on eperience.</p>
<p>🥘 - <strong>level <code>4</code></strong>. I know a lot about the subject and quite a decent experience. This one I will only use when I am done preparing and have the first mock exam. Bonus - 🍭 real-life expreience (not just labs).</p>
<p>🗒- Topic specific plan. 👌-done, 🚧 - in progress</p>
<p>🗂 - references and <strong>resources</strong>.</p>
<p>🎯- objectives.</p>
<p>🏺- artifacts</p>
<p>🛠 - tools to learn/use.</p>
<h2 id="exercises">Exercises</h2>
<ul>
<li>Forensic Lab Setup and Orientation Using the SIFT Workstation 🥒 - <strong>level <code>1</code></strong>.</li>
<li>Malware Persistence Detection and Analysis 🗂 [<a href="https://www.amazon.com/Practical-Malware-Analysis-Hands-Dissecting/dp/1593272901">2</a>],  🌮 - <strong>level <code>3</code></strong> + 🍭</li>
<li>Scaling Data Collection and Analysis 🫑 - <strong>level <code>0</code></strong>.</li>
<li>Finding and Analyzing Malicious WMI attacks 🫑 - <strong>level <code>0</code></strong>.</li>
</ul>
<h2 id="topics">Topics</h2>
<h3 id="real-incident-response-tactics">Real Incident Response Tactics</h3>
<h4 id="preparation">Preparation</h4>
<p>Key tools, techniques, and procedures that an incident response team needs to respond properly to intrusions</p>
<h4 id="identificationscoping">Identification/Scoping</h4>
<p>Proper scoping of an incident and detecting all compromised systems in the enterprise. First stages of IR is mostly about cleaning up using frequency analysis, leaving for the worst scenario everything less likely. So, in case there are no clues or traces left with the frequency analysis you are moving to the those, that seem less suspicious or not suspicious at all. So, in IR it&rsquo;s not like you are supposed to investigate every single process on the machine and determine whether it&rsquo;s malicious or not. This is the worst case scenario and it&rsquo;s mostly about forensics, I think.</p>
<h4 id="containmentintelligence-developmen">Containment/Intelligence Developmen</h4>
<p>Restricting access, monitoring, and learning about the adversary in order to develop threat intelligence</p>
<h4 id="eradicationremediation">Eradication/Remediation</h4>
<p>Determining and executing key steps that must be taken to help stop the current incident and the move to real-time remediation</p>
<h4 id="recovery">Recovery</h4>
<p>Recording of the threat intelligence to be used in the event of a similar adversary returning to the enterprise.</p>
<h4 id="avoiding-whack-a-mole-incident-response">Avoiding &ldquo;Whack-A-Mole&rdquo; Incident Response</h4>
<p>Going beyond immediate eradication without proper incident scoping/containment. It&rsquo;s very bad to do so, since without proper scoping/containment you can&rsquo;t know the whole picture and you risk leaving some vulnerability unpatched or some machine unrecovered. Moreover, now the attack knows how you behave and that you know and can act appropriately.</p>
<p>[<a href="https://www.darkreading.com/vulnerabilities-threats/the-end-of-whac-a-mole-from-incident-response-to-strategic-intelligence">1</a>] The End Of Whac-A-Mole: From Incident Response To Strategic Intelligence</p>
<p>[<a href="">1</a>] Incident Response book (Packt) + several others + NIST.</p>
<h3 id="threat-hunting">Threat Hunting</h3>
<h4 id="hunting-versus-reactive-response">Hunting versus Reactive Response</h4>
<p>[<a href="https://www.ibm.com/downloads/cas/Q3W5GYG8">1</a>] SANS+IBM brochure on hunting.</p>
<p>Hunting is usually better since it allows targeted response. Reactive response means that you are looking for everything, even if it&rsquo;s not really relevant for your enterprise. For example, monitoring log4j vulnerability when you don&rsquo;t use this framework at all.</p>
<h4 id="intelligence-driven-incident-response">Intelligence-Driven Incident Response</h4>
<p>[<a href="/files/pdf/DFIR-Threat-Intel-Poster.pdf">1</a>] SANS poster, Threat Intelligence</p>
<p>So, each time a IR process is triggered + third-party informaiton collected, we &ldquo;draw&rdquo; a picture of the most likely threats for this particular organization.</p>
<h4 id="building-a-continuous-incident-responsethreat-hunting-capability">Building a Continuous Incident Response/Threat Hunting Capability</h4>
<h4 id="forensic-analysis-versus-threat-hunting-across-endpoints">Forensic Analysis versus Threat Hunting Across Endpoints</h4>
<p>[<a href="https://lifars.com/2021/05/threat-hunting-vs-digital-forensics-what-are-they-do-you-need-both/">1</a>] use VPN to access</p>
<p>Forensic Analysis is time and resources-costly. That&rsquo;s why you don&rsquo;t use for every investigation for every machine. Threat hunting can be though of as an immune system, B lymphocytes mark &ldquo;bad&rdquo; cells with antibodies and macrophages eat them. So, threat hunting shows the most likely suspects, most likely actors and most likely attack startegies, mark the workstations and forensics is to validate and investigate deeper.</p>
<h4 id="threat-hunt-team-roles">Threat Hunt Team Roles</h4>
<p>[<a href="https://www.youtube.com/watch?v=GrhVz1Sjd_0">1</a>] Find Evil, [<a href="https://www.youtube.com/watch?v=pDY639JsT7I">2</a>] SecOps, [<a href="https://www.youtube.com/watch?v=Ut1t_n6NPQE">3</a>] Where Does Threat Hunting Fit?, [<a href="https://www.sans.org/media/analyst-program/building-maturing-threat-hunting-program-39025.pdf">4</a>] Building your team</p>
<h4 id="attck---mitres">ATT&amp;CK - MITRE&rsquo;s</h4>
<p><a href="https://attack.mitre.org">[1]</a> is the main website on the topic.</p>
<h3 id="threat-hunting-in-the-enterprise">Threat Hunting in the Enterprise</h3>
<h4 id="identification-of-compromised-systems">Identification of Compromised Systems</h4>
<h4 id="finding-active-and-dormant-malware">Finding Active and Dormant Malware</h4>
<p><a href="https://www.tripwire.com/state-of-security/security-data-protection/cyber-security/four-common-scenarios-for-dormant-functionality-in-malware/#:~:text=A%20persistent%20problem%20in%20the,the%20Technical%20University%20of%20Vienna.">[1]</a> TripWire article (short) about dormant malware</p>
<h4 id="digitally-signed-malware">Digitally Signed Malware</h4>
<h4 id="malware-characteristics">Malware Characteristics</h4>
<h4 id="common-hiding-mechanisms">Common Hiding Mechanisms</h4>
<h4 id="finding-evil-by-understanding-normal">Finding Evil by Understanding Normal</h4>
<p>[<a href="">1</a>] My article about Super Novas</p>
<p>[<a href="/files/pdf/evil-and-normal.pdf">2</a>] SANS poster about Normal and Abnormal</p>
<h3 id="incident-response-and-hunting-across-endpoints">Incident Response and Hunting across Endpoints</h3>
<h4 id="wmic--powershell">WMIC &amp; PowerShell</h4>
<p>[<a href="">1</a>] Read here</p>
<p><strong>Offline</strong>. Detect all registered Event Consumers from an OBJECTS.DATA.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">PyWMIPersistenceFinder</span><span class="p">.</span><span class="n">py</span> <span class="p">&lt;</span><span class="n">path</span><span class="p">\</span><span class="n">to</span><span class="p">\</span><span class="n">OBJECTS</span><span class="p">.</span><span class="n">DATA</span><span class="p">&gt;</span>
</span></span></code></pre></div><p><strong>Offline</strong>. Kansa analysis of WMI</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Get-LogparserStack</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-FilePattern</span> <span class="p">*</span><span class="n">WMIEvtFilter</span><span class="p">.</span><span class="n">csv</span> <span class="n">-Delimeter</span> <span class="s2">&#34;,&#34;</span> <span class="n">-Direction</span> <span class="n">asc</span> <span class="n">-OutFile</span> <span class="nb">WMIEvt-stackfiles</span><span class="p">.</span><span class="n">csv</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Open with Timeline Explorer</span>
</span></span></code></pre></div><h4 id="powershell-remoting-scalability">PowerShell Remoting Scalability</h4>
<p>Initiate a remote session:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># session created, command run, session terminated</span>
</span></span><span class="line"><span class="cl"><span class="nb">Invoke-Command</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">pcname</span><span class="p">&gt;</span> <span class="n">-ScriptBlock</span> <span class="p">{</span><span class="nb">Get-Process</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="n">-Property</span> <span class="n">name</span> <span class="o">-eq</span> <span class="n">somethingbad</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># session created, commands run, session terminated when the user says it does</span>
</span></span><span class="line"><span class="cl"><span class="nb">Enter-PSSession</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">pcname</span><span class="p">&gt;</span> <span class="n">-Credential</span> <span class="p">&lt;</span><span class="n">login</span><span class="p">&gt;</span> 
</span></span><span class="line"><span class="cl"><span class="c"># or</span>
</span></span><span class="line"><span class="cl"><span class="c"># create a session</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-PSSession</span> <span class="n">-Credentials</span>
</span></span><span class="line"><span class="cl"><span class="c"># use it with the Invoke-Command as a -Session parameter</span>
</span></span></code></pre></div><p>It used to be <code>Get-WMIInstance</code>, now it&rsquo;s <code>Get-CIMInstance</code> to use with other CIM-based servers.</p>
<blockquote>
<p>⚠️ Kept getting Access Denied on any Get-WMIInstance Win32Process or Get-CIMInstance -ClassName Win32Process</p>
<p>✍️ <a href="https://newbedev.com/get-wmiobject-win32-process-computername-gets-error-access-denied-code-0x80070005">https://newbedev.com/get-wmiobject-win32-process-computername-gets-error-access-denied-code-0x80070005</a></p>
</blockquote>
<p><code>powershell.exe -NoP -NonI -W Hidden -E</code>. You won&rsquo;t usually</p>
<h4 id="powershell-remoting-credential-safeguards">PowerShell Remoting Credential Safeguards</h4>
<h4 id="kansa-powershell-remoting-ir-framework">Kansa PowerShell Remoting IR Framework</h4>
<p>Running Kansa across multiple PCs.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">mkdir</span> <span class="n">Results</span> <span class="p">&amp;&amp;</span> <span class="nb">cd </span><span class="n">Results</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># check kansa.ps1 for the modules that will be run</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.\</span><span class="n">kansa</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-Pushbin</span> <span class="n">-Target</span> <span class="n">localhost</span> <span class="p">[</span><span class="n">-TargetList</span> <span class="p">&lt;</span><span class="n">listoftargets</span><span class="p">&gt;]</span> <span class="n">-Credential</span> <span class="p">&lt;</span><span class="n">login</span><span class="p">&gt;</span> <span class="n">-Authentication</span> <span class="n">Negotiate</span>
</span></span></code></pre></div><h3 id="malware-defense-evasion-and-identification">Malware Defense Evasion and Identification</h3>
<h4 id="service-hijackingreplacement">Service Hijacking/Replacement</h4>
<p>[<a href="/files/pds/Injects_p1.pdf">1</a>] My presentations in injections, part 1</p>
<p>[<a href="/files/pds/Injects_p2.pdf">2</a>] My presentations in injections, part 2</p>
<h4 id="frequent-compilation">Frequent Compilation</h4>
<h4 id="binary-padding">Binary Padding</h4>
<h4 id="packingarmoring">Packing/Armoring</h4>
<p>[<a href="https://www.ma.rhul.ac.uk/static/techrep/2012/MA-2012-10.pdf">1</a>] Incident involving armouring.</p>
<p>My own notes about packing (not ready yet)</p>
<h4 id="dormant-malware">Dormant Malware</h4>
<p><a href="https://www.tripwire.com/state-of-security/security-data-protection/cyber-security/four-common-scenarios-for-dormant-functionality-in-malware/#:~:text=A%20persistent%20problem%20in%20the,the%20Technical%20University%20of%20Vienna.">[1]</a> TripWire article (short)</p>
<h4 id="signing-code-with-valid-certificates">Signing Code with Valid Certificates</h4>
<h4 id="anti-forensicstimestomping">Anti-Forensics/Timestomping</h4>
<h3 id="malware-persistence-identification">Malware Persistence Identification</h3>
<p><a href="https://www.hexacorn.com/blog/2017/01/28/beyond-good-ol-run-key-all-parts/">https://www.hexacorn.com/blog/2017/01/28/beyond-good-ol-run-key-all-parts/</a></p>
<h4 id="autostart-locations-runkeys">AutoStart Locations, RunKeys</h4>
<p>Kansa Framework. Collection of the autorun locations</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Step 1. Run autorunsc (or Kansa script) on every machine, getting csv file for each one</span>
</span></span><span class="line"><span class="cl"><span class="c"># autorun.exe command in Kansa for autoruns search</span>
</span></span><span class="line"><span class="cl"><span class="c"># a * - all possible locations</span>
</span></span><span class="line"><span class="cl"><span class="c"># c - codecs as well</span>
</span></span><span class="line"><span class="cl"><span class="c"># h - generate hashes</span>
</span></span><span class="line"><span class="cl"><span class="c"># s - verify digital signatures</span>
</span></span><span class="line"><span class="cl"><span class="c"># &#39;*&#39; - all user profiles</span>
</span></span><span class="line"><span class="cl"><span class="n">autorunsc</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">accepteula</span> <span class="n">-a</span> <span class="p">*</span> <span class="n">-c</span> <span class="n">-h</span> <span class="n">-s</span> <span class="s1">&#39;*&#39;</span> <span class="n">-nobanner</span> 
</span></span><span class="line"><span class="cl"><span class="c"># Collection with Kansa</span>
</span></span><span class="line"><span class="cl"><span class="n">kansa</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-Pushbin</span> <span class="n">-Target</span> <span class="p">&lt;</span><span class="n">IP</span><span class="p">|</span><span class="n">localhost</span><span class="p">|</span><span class="n">filewithIPs</span><span class="p">&gt;</span> <span class="n">-Credential</span> <span class="n">username</span> <span class="n">-Authentication</span> <span class="n">Negotiate</span> 
</span></span><span class="line"><span class="cl"><span class="c"># don&#39;t pass the password here. Type when asked</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Step 2. open the file generated in TimeLine Explorer for analysis. </span>
</span></span><span class="line"><span class="cl"><span class="c"># Step 3. Choose files from untrusted vendors and (Blank). </span>
</span></span><span class="line"><span class="cl"><span class="c"># Step 4. Look at the images paths (compare with the Find Evil poster)</span>
</span></span><span class="line"><span class="cl"><span class="c"># Step 5. Look at the hashes, eliminate the known good.</span>
</span></span><span class="line"><span class="cl"><span class="c"># Step 6. Stacking (generate on file from all csv)</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-ASEPImagePathLaunchStringMD5UnsignedStack</span><span class="p">.</span><span class="n">ps1</span> <span class="p">&gt;</span> <span class="n">stackedData</span><span class="p">.</span><span class="n">csv</span>
</span></span><span class="line"><span class="cl"><span class="c"># Step 6. Perfom frequency analysis. What stands out?</span>
</span></span><span class="line"><span class="cl"><span class="c"># Step 7. Use Select-String or grep to identify machines for each suspicuios entry</span>
</span></span></code></pre></div><h4 id="service-creationreplacement">Service Creation/Replacement</h4>
<p>Stacking services with Kansa</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Get-LogparserStack</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-FilePattern</span> <span class="p">*</span><span class="n">services</span><span class="p">.</span><span class="n">csv</span> <span class="n">-Delimeter</span> <span class="s2">&#34;,&#34;</span> <span class="n">-Direction</span> <span class="n">asc</span><span class="p">|</span><span class="n">dsc</span> <span class="n">-OutFile</span> <span class="n">allServicesStack</span><span class="p">.</span><span class="n">csv</span>
</span></span><span class="line"><span class="cl"><span class="c"># For each GROUP BY type the column for ordering</span>
</span></span><span class="line"><span class="cl"><span class="c"># For example Name or Path</span>
</span></span><span class="line"><span class="cl"><span class="c"># quit for quit</span>
</span></span></code></pre></div><h4 id="service-failure-recovery">Service Failure Recovery</h4>
<h4 id="scheduled-tasks">Scheduled Tasks</h4>
<h4 id="dll-hijacking">DLL Hijacking</h4>
<p>[<a href="">1</a>] My own presentation and corresponding articles</p>
<h4 id="wmi-event-consumers">WMI Event Consumers</h4>
<p>[<a href="">1</a>] PhDays 2019, Persistance mechanisms on Windows. Review and put down.</p>
<h3 id="investigating-wmi-based-attacks">Investigating WMI-Based Attacks</h3>
<h4 id="wmi-overview">WMI Overview</h4>
<p>Since Win2000. Web-based enterprise management. CIM - common information model. It&rsquo;s both a db of system informaiton AND means to automate its collection. <code>wmic</code> - commandline interface for WMI. It runs with SYSTEM privileges.</p>
<p>Moving laterally: remote desktop or netuse. To code execute from A to B, is one of the core techniques for that.</p>
<p>Can be used in privilege escalation when finding a service that has a unquoted path, for example. Or can be used with <code>rundll32.exe</code> and <code>process call create</code>.</p>
<p>Creating a WMI consumer:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Step 1. Create an event filter that&#39;s going to monitor the systems and events and do something once certain conditions are met.</span>
</span></span><span class="line"><span class="cl"><span class="nv">$FilterArgs</span> <span class="p">=</span> <span class="p">@{</span><span class="n">name</span><span class="p">=</span><span class="s1">&#39;Pentestlab-WMI&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">EventNameSpace</span><span class="p">=</span><span class="s1">&#39;root\CimV2&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">QueryLanguage</span><span class="p">=</span><span class="s2">&#34;WQL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">Query</span><span class="p">=</span><span class="s2">&#34;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &#39;Win32_PerfFormattedData_PerfOS_System&#39; AND TargetInstance.SystemUpTime &gt;= 240 AND TargetInstance.SystemUpTime &lt; 325&#34;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Filter</span><span class="p">=</span><span class="nb">New-CimInstance</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">/</span><span class="n">subscription</span> <span class="n">-ClassName</span> <span class="n">__EventFilter</span> <span class="n">-Property</span> <span class="nv">$FilterArgs</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c"># Step 2. Create an Event Consumer that&#39;s the action that&#39;s going to take place once the conditions specified by the even filter are met.</span>
</span></span><span class="line"><span class="cl"><span class="nv">$ConsumerArgs</span> <span class="p">=</span> <span class="p">@{</span><span class="n">name</span><span class="p">=</span><span class="s1">&#39;Pentestlab-WMI&#39;</span><span class="p">;</span>         <span class="n">CommandLineTemplate</span><span class="p">=</span><span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$Env:SystemRoot</span><span class="p">)</span><span class="s2">\System32\pentestlab.exe&#34;</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Consumer</span><span class="p">=</span><span class="nb">New-CimInstance</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">/</span><span class="n">subscription</span> <span class="n">-ClassName</span> <span class="n">CommandLineEventConsumer</span> <span class="n">-Property</span> <span class="nv">$ConsumerArgs</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c"># Step 3. Bind the Filter to the Consumer.</span>
</span></span><span class="line"><span class="cl"><span class="nv">$FilterToConsumerArgs</span> <span class="p">=</span> <span class="p">@{</span>
</span></span><span class="line"><span class="cl"><span class="k">Filter</span> <span class="p">=</span> <span class="no">[Ref]</span> <span class="nv">$Filter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Consumer</span> <span class="p">=</span> <span class="no">[Ref]</span> <span class="nv">$Consumer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">$FilterToConsumerBinding</span> <span class="p">=</span> <span class="nb">New-CimInstance</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">/</span><span class="n">subscription</span> <span class="n">-ClassName</span> <span class="n">__FilterToConsumerBinding</span> <span class="n">-Property</span> <span class="nv">$FilterToConsumerArgs</span>
</span></span></code></pre></div><p>The above steps can be specified in a MOF file and compiled. So, either use Powershell or <code>mofcomp.exe</code>. <code>Get-WmiObject</code> and <code>Remover-WmiObject</code> to detect and remove suspicious entries.</p>
<p>Just create a process with wmic:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">wmic</span> <span class="k">process</span> <span class="n">call</span> <span class="n">create</span> <span class="s2">&#34;path\to\process&#34;</span>
</span></span></code></pre></div><p><strong>Tools</strong> 🛠: Event Logs, Sysmon and commercial tools like Falcon, CarbonBlack, Tanium.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Get-WmiObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="n">Subscription</span> <span class="n">-Class</span> <span class="n">__EventFilter</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-WmiObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="n">Subscription</span> <span class="n">-Class</span> <span class="n">__EventConsumer</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-WmiObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="n">Subscription</span> <span class="n">-Class</span> <span class="n">__FilterToConsumerBinding</span>
</span></span></code></pre></div><p>Kansa includes the scripts for these commands for autocollection.</p>
<p>There are several types of event consumers:</p>
<ol>
<li>🎯 <code>ActiveScriptEventConsumer</code>. Execute a predefined VB or JScript. This one is frequently used by attackers. <code>scrcons.exe</code> -&gt; cmd.exe -&gt; schticks.exe -&gt; ActiveScript Event Consumer.</li>
<li>🎯 <code>CommandLineEventConsumer</code>. Launch a process. This one is also frequently used by attackers. <code>wmiprvse.exe</code> is the parent process. <code>svchost</code> -&gt; <code>services</code> -&gt; <code>wmiprvse.exe</code> -&gt; CommandLine Event Consumer.</li>
<li><code>LogFileEventConsumer</code>. Write to a <code>txt</code>.</li>
<li><code>NTEventLogEventConsumer</code>. Log a message to Event Log.</li>
<li><code>SMTPEventConsumer</code>. Email a message via SMTP.</li>
<li><code>Custom</code>. Requires custom COM object.</li>
</ol>
<h4 id="wmi-attacks-across-the-kill-chain">WMI Attacks Across the Kill Chain</h4>
<p>APT29. Used for privilege escalation and lateral movement.</p>
<h4 id="auditing-the-wmi-repository">Auditing the WMI Repository</h4>
<p><a href="https://medium.com/threatpunter/detecting-removing-wmi-persistence-60ccbb7dff96">Create and delete entries</a>. <code>Windows\System32\wbem\Repository\OBJECTS.DATA</code> - objects, managed by WMI. <code>INDEX.BTR</code> - Binary Tree Index of the files in <code>OBJECTS</code>. <code>MAPPING[1-3].MAP</code> - correlates data between <code>OBJECTS</code> and <code>INDEX.BTR</code>.</p>
<p><strong>Known good</strong> 😇: SCM Event, BVTFilter, TSlogonEvents.vbs, TSLogonFilter, RAevent.vbs, RmAssistEventFilter, KernCap.vbs, NTEventLogConsumer, WSCEAA.exe (for Dell devices).</p>
<h4 id="wmi-file-system-and-registry-residue">WMI File System and Registry Residue</h4>
<p><strong>MOF files</strong> - compiled versions of event consumers. Can be located anywhere and named lots of diffreent things. But by default: <code>%SystemRoot%\System32\wbem</code>.</p>
<blockquote>
<p>⚠️ Original <code>mof</code> file can be deleted after it&rsquo;s added to the repo.</p>
</blockquote>
<p><code>Set-WmiInstance</code> can be used instead of mof files.</p>
<p><strong>Autorecover</strong>. Pragma autorecover in <code>config.mof</code>. If this option is included, a copy is saved <code>C:\Windows\System32\wbem\AutoRecover</code>. Most of the adversaries use this setting. The time and dates are usually different for this backup than for other backups.</p>
<p><strong>CIMOM</strong>. <code>HKLM\SOFTWARE\Microsoft\Wbem\CIMOM</code>. Use the <code>Autorecover MOFs</code> to see the original MOF files names.</p>
<h4 id="command-line-analysis-and-wmi-logs">Command-Line Analysis and WMI Logs</h4>
<p>If something malicious was found on the system and is likely to be present on other systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">wmic</span> <span class="k">process</span> <span class="nb">where </span><span class="n">name</span><span class="p">=</span><span class="s2">&#34;somethingbad&#34;</span> <span class="n">delete</span>
</span></span><span class="line"><span class="cl"><span class="c"># or with Powershell:</span>
</span></span></code></pre></div><p><code>PyWMIPersistenceFinder.py</code> is used for offline analysis of <code>OBJECTS</code> file. If data is deleted from the DB, the data might be still there. And this script parses the db, even the unallocated entries of this db.</p>
<p>Stacking with Kansa</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Get-LogparserStack</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-FilePattern</span> <span class="p">*</span><span class="n">wmisFilters</span><span class="p">.</span><span class="n">csv</span><span class="p">|</span><span class="n">wmisEvents</span><span class="p">.</span><span class="n">csv</span><span class="p">|</span><span class="n">wmisConsumers</span><span class="p">.</span><span class="n">csv</span> <span class="n">-Delimeter</span> <span class="s2">&#34;,&#34;</span> <span class="n">-Direction</span> <span class="n">asc</span><span class="p">|</span><span class="n">dsc</span> <span class="n">-OutFile</span> <span class="n">wmisStack</span><span class="p">.</span><span class="n">csv</span>
</span></span><span class="line"><span class="cl"><span class="c"># GROUP BY Name or/and query</span>
</span></span><span class="line"><span class="cl"><span class="c"># Use Select-String or grep to identify the machines for suspiction entries</span>
</span></span></code></pre></div><h4 id="wmi-process-anomalies">WMI Process Anomalies</h4>
<ol>
<li><code>svchost</code> -&gt; <code>services</code> -&gt; <code>wmiprvse.exe</code> -&gt; CommandLine Event Consumer. If wmiprvse.exe has another parent or unusuall child (powershell) it&rsquo;s suspicious.</li>
<li><code>scrcons.exe</code> -&gt; cmd.exe -&gt; schticks.exe -&gt; ActiveScript Event Consumer.</li>
<li>Encoded command lines</li>
<li><code>Invoke-WmiMethod</code> and <code>Invoke-CimMethod</code></li>
<li><code>/node:</code></li>
<li><code>wmic process call create</code></li>
</ol>
<p>Create a baseline for what&rsquo;s normal for your systems.</p>
<h2 id="resources">Resources</h2>
<p>[<a href="https://www.crowdstrike.com/cybersecurity-101/advanced-persistent-threat-apt/">1</a>] About some APT groups</p>
<p>[<a href="https://www.amazon.com/Practical-Malware-Analysis-Hands-Dissecting/dp/1593272901">2</a>] Practical Malware Analysis book</p>
<p>[<a href="https://medium.com/@gergely.revay/sans-for-508-setting-a-thief-to-catch-a-thief-dfd4bcb2d163">3</a>] Tips on SANS For508</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
