<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Intrusion analysis üõ†Ô∏è - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.9d91cbb32c96c334ae7b38c3d99d30727e0836e1182125cc5f007d215f0b9e59.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-forensics üîç and incident response ü•∑">
      <a href="/docs/dfir">
        <span>Forensics üîç and Incident Response ü•∑</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-forensics üîç and incident response ü•∑">
      <a href="/docs/dfir">
        <span>Forensics üîç and Incident Response ü•∑</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/notes/gcfa/"> Back to GCFA Section üëàüèº </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#legend">Legend</a></li>
    <li><a href="#exercises">Exercises</a></li>
    <li><a href="#topics">Topics</a>
      <ul>
        <li><a href="#stealing-and-utilization-of-legitimate-credentials">Stealing and Utilization of Legitimate Credentials</a>
          <ul>
            <li><a href="#pass-the-hash">Pass the Hash</a></li>
            <li><a href="#single-sign-on-sso-dumping-using-mimikatz">Single Sign On (SSO) Dumping using Mimikatz</a></li>
            <li><a href="#token-stealing">Token Stealing</a></li>
            <li><a href="#cached-credentials">Cached Credentials</a></li>
            <li><a href="#lsa-secrets">LSA Secrets</a></li>
            <li><a href="#kerberos-attacks">Kerberos Attacks</a></li>
            <li><a href="#ntdsdit-theft">NTDS.DIT theft</a></li>
            <li><a href="#event-log-user-logon-tracking">Event Log (User logon tracking)</a></li>
            <li><a href="#logon-types">Logon Types</a></li>
          </ul>
        </li>
        <li><a href="#advanced-evidence-of-execution-detection">Advanced Evidence of Execution Detection</a>
          <ul>
            <li><a href="#attacker-tactics-techniques-and-procedures-ttps-observed-via-process-execution">Attacker Tactics, Techniques, and Procedures (TTPs) Observed Via Process Execution</a></li>
            <li><a href="#prefetch-analysis">Prefetch Analysis</a></li>
            <li><a href="#application-compatibility-cache-shimcache">Application Compatibility Cache (ShimCache)</a></li>
            <li><a href="#amcache-registry-examination">Amcache Registry Examination</a></li>
            <li><a href="#scaling-shimcache-and-amcache-investigations">Scaling ShimCache and Amcache Investigations</a></li>
          </ul>
        </li>
        <li><a href="#lateral-movement-adversary-tactics-techniques-and-procedures-ttps">Lateral Movement Adversary Tactics, Techniques, and Procedures (TTPs)</a>
          <ul>
            <li><a href="#types-of-credentials">Types Of Credentials</a></li>
            <li><a href="#security-features-protecting-user-accounts">Security features protecting user accounts</a></li>
            <li><a href="#compromising-credentials-techniques">Compromising Credentials Techniques</a></li>
            <li><a href="#remote-desktop-services-misuse">Remote Desktop Services Misuse</a></li>
            <li><a href="#windows-admin-share-abuse">Windows Admin Share Abuse</a></li>
            <li><a href="#psexec-and-cobalt-strike-beacon-psexec-activity">PsExec and Cobalt Strike Beacon PsExec Activity</a></li>
            <li><a href="#windows-remote-management-tool-techniques">Windows Remote Management Tool Techniques</a></li>
            <li><a href="#powershell-remotingwmic-hacking">PowerShell Remoting/WMIC Hacking</a></li>
            <li><a href="#vulnerability-exploitation">Vulnerability Exploitation</a></li>
            <li><a href="#tracking-lateral-movement">Tracking Lateral Movement</a></li>
          </ul>
        </li>
        <li><a href="#log-analysis-for-incident-responders-and-hunters">Log Analysis for Incident Responders and Hunters</a>
          <ul>
            <li><a href="#profiling-account-usage-and-logons">Profiling Account Usage and Logons</a></li>
            <li><a href="#tracking-and-hunting-lateral-movement">Tracking and Hunting Lateral Movement</a></li>
            <li><a href="#identifying-suspicious-services">Identifying Suspicious Services</a></li>
            <li><a href="#detecting-rogue-application-installation">Detecting Rogue Application Installation</a></li>
            <li><a href="#finding-malware-execution-and-process-tracking">Finding Malware Execution and Process Tracking</a></li>
            <li><a href="#capturing-command-lines-and-scripts">Capturing Command Lines and Scripts</a></li>
            <li><a href="#powershell-transcript-and-scriptblock-logging">PowerShell Transcript and ScriptBlock Logging</a></li>
            <li><a href="#discovering-cobalt-strike-beacon-powershell-import-activity">Discovering Cobalt Strike beacon PowerShell Import Activity</a></li>
            <li><a href="#powershell-script-obfuscation">PowerShell Script Obfuscation</a></li>
            <li><a href="#wmi-activity-logging">WMI Activity Logging</a></li>
            <li><a href="#anti-forensics-and-event-log-clearing">Anti-Forensics and Event Log Clearing</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#resources">Resources</a></li>
  </ul>
</nav>
 </aside>
 </div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Intrusion analysis üõ†Ô∏è</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
                <i class="fas fa-search"></i>
              
          <a class="category-link" href="/domain/forensics">forensics</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
                <i class="fas fa-list-ul"></i>
              
          <a class="platform-link" href="/doctype/plan">plan</a>
          
      </div> <br /><br/>
      
      
      
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <h2 id="legend">Legend</h2>
<p>Below is the skeleton from SAN508 course description. I am using it to make up my study plan. For each step of this plan I estimate my current level of training and I am also collecting resourced for this topic under <em>Resources</em>.</p>
<p>ü´ë - <strong>level <code>0</code></strong>. I know nothing and not even where to start. I might have some embarrassingly fundamental knowledge which is not good enough even for the start.</p>
<p>ü•í - <strong>level <code>1</code></strong>. I know something about the subject, but this only gives me an approximate plan and kind of things to look for.</p>
<p>ü•ó - <strong>level <code>2</code></strong>. I know something about the subject, I&rsquo;ve even read something about it. But no hands-on eperience.</p>
<p>üåÆ - <strong>level <code>3</code></strong>. I know quite a lot about the subject, I&rsquo;ve read something about it and some hands-on eperience.</p>
<p>ü•ò - <strong>level <code>4</code></strong>. I know a lot about the subject and quite a decent experience. This one I will only use when I am done preparing and have the first mock exam. Bonus - üç≠ real-life expreience (not just labs).</p>
<p>üóí- Topic specific plan. üëå-done, üöß - in progress</p>
<p>üóÇ - references and <strong>resources</strong>.</p>
<p>üéØ- objectives.</p>
<p>üè∫- artifacts</p>
<p>üõ† - tools to learn/use.</p>
<h2 id="exercises">Exercises</h2>
<ul>
<li>Hunting and Detecting Evidence of Execution at Scale with Shimcache and Amcache</li>
<li>Discovering Credential abuse with Event Log Collection and Analysis</li>
<li>Tracking Lateral Movement with Event Log Analysis</li>
<li>Hunting Malicious use of WMI and PowerShell</li>
</ul>
<h2 id="topics">Topics</h2>
<p>Application execution artifacts, account auditing is a powerful means of identifying malicious actions. An attacker also needs a means to move throughout the network, so we look for artifacts left by the relatively small number of ways there are to accomplish this part of their mission. In this section, we cover common attacker tradecraft and discuss the various data sources and forensic tools you can use to identify malicious activity in the enterprise.</p>
<h3 id="stealing-and-utilization-of-legitimate-credentials">Stealing and Utilization of Legitimate Credentials</h3>
<p>There are limimted amount of techniques for gaining authorization and moving laterally. However, there are thousands of ways to execute code, exfiltrate or collect data. So, in hunting focus on this limited techniques, since at some point the adversary will have to use one of them.</p>
<p>If you are not very important, then it&rsquo;s less likely to face a cool 0-day. Why would anyone use a &ldquo;bargaining chip&rdquo; to hack something small? 0-days are costly.</p>
<blockquote>
<p>‚ö†Ô∏è Don&rsquo;t give every user local admin rights! Windows XP - every user is admin.</p>
</blockquote>
<h4 id="pass-the-hash">Pass the Hash</h4>
<h4 id="single-sign-on-sso-dumping-using-mimikatz">Single Sign On (SSO) Dumping using Mimikatz</h4>
<h4 id="token-stealing">Token Stealing</h4>
<h4 id="cached-credentials">Cached Credentials</h4>
<h4 id="lsa-secrets">LSA Secrets</h4>
<h4 id="kerberos-attacks">Kerberos Attacks</h4>
<h4 id="ntdsdit-theft">NTDS.DIT theft</h4>
<h4 id="event-log-user-logon-tracking">Event Log (User logon tracking)</h4>
<p>Open Log file -&gt; New API. Choose evtx file. View -&gt; Time Correction and check &ldquo;Set UTC time&rdquo;. 4776 to look for failed logins. Find suspicious ones. Then, get to 4624 and see if any of these failed loging resulted in successful login. Note the processes responsible for these events (in the event description). For example, WmiPrvSE.exe is a remote WMI activity.</p>
<p>Remember that not all processes record network info (like Kerberos).</p>
<p>To check RDP connections, first filter by 4624 Type 10 Event, then see 4778 (reconnection) events. Finally, check for acc privileges by looking at 4672 events.</p>
<p>Good practice in the enterprise to minimize admin rights usage. If you see admin accs or accs that have elevated privileges used on workstations, that&rsquo;s a food for thought.</p>
<p>It&rsquo;s better to filter out all built-in accs on Windows. SID can be used to do so. Built-in accounts don&rsquo;t have Unique domain identifier and RID.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">evtxecmd</span> <span class="p">-</span><span class="n">-sync</span>
<span class="n">evtxecmd</span> <span class="o">-f</span> <span class="n">path</span><span class="p">\</span><span class="n">to</span><span class="p">\</span><span class="n">evtx</span> <span class="p">-</span><span class="n">-csv</span> <span class="n">target</span><span class="p">\</span><span class="n">path</span> <span class="n">-csvf</span> <span class="n">target</span><span class="p">\</span><span class="n">file</span><span class="p">\</span><span class="n">name</span>
</code></pre></div><p>Use TimeLine Explorer to analyse the results. Intersting and useful feature is &ldquo;column grouping&rdquo;.</p>
<h4 id="logon-types">Logon Types</h4>
<p>2 - Console</p>
<p>3 - Network</p>
<p>10 - Remote Desktop</p>
<p>9 - RunAs</p>
<h3 id="advanced-evidence-of-execution-detection">Advanced Evidence of Execution Detection</h3>
<h4 id="attacker-tactics-techniques-and-procedures-ttps-observed-via-process-execution">Attacker Tactics, Techniques, and Procedures (TTPs) Observed Via Process Execution</h4>
<h4 id="prefetch-analysis">Prefetch Analysis</h4>
<p>Udemy SDF series about Prefetch, Digital Archaeology, SDF podcast. Review my article about prefetch forensics (based on the previously mentioned sources). Below information is copied from there</p>
<p><strong>WinPrefetchView</strong></p>
<p>To view pretech files (decompressed as well) in GUI.</p>
<p><strong>Fred</strong> - Forensic Registry Editor</p>
<p>To view exported hives.</p>
<p><strong>FTK</strong> Imager Lite</p>
<p>Fairly heavy footprint - 15-16Mb.</p>
<p><strong>CDQR</strong></p>
<p>This tool focuses on the <code>pf</code> intself rather than on a data it contains. It&rsquo;s useful for making timelines.</p>
<p><strong>RegRipper</strong> (GUI and CUI)</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">rip.exe -r SYSTEM -p prefetch <span class="c1"># to show whether prefetch is enabled</span>
</code></pre></div><p><strong>Prefetch</strong> parser</p>
<p>More info than with WinPrefetchView</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">prefetch.py -c -d -e
prefetch.py -c -d &gt; pf.csv
prefetch.py -f &lt;file_to_parse&gt; &gt; pf.txt
</code></pre></div><p>Columns: last executed, MFT sequence number, MFT record number, executable name, run counter.</p>
<p>If collecting prfethc on a live system, run volatile collection tools before that.</p>
<p>Prefetch is for efficiency of starting processes and their resources (movies for media players, spreadsheets for Excel for example). Improves startup time of applications. Filename, Creation time, Modified time, File Size, Process EXE, Process Path, Run Counter, Last Run Time, Missing Process + libraries and resources for each process.</p>
<p>Forensics value - tracks the execution of programs. Central repository of what was run on the system. File size can be used to search for the same process with a different name on a different machine.</p>
<p><code>C:\Windows\Prefetch</code>.</p>
<p>All prefetch have a signature at offset 4th byte. MAM - compressed and SCCA - plain text.</p>
<table>
<thead>
<tr>
<th>OS</th>
<th>Signature1 (version)</th>
<th>signature2 (type)</th>
</tr>
</thead>
<tbody>
<tr>
<td>WinXP &amp; 2003</td>
<td>0x00000011 or 17</td>
<td>SCCA</td>
</tr>
<tr>
<td>Vista</td>
<td>0x00000023 or 23</td>
<td>SCCA</td>
</tr>
<tr>
<td>W8</td>
<td>0x0000001a or 26</td>
<td>SCCA</td>
</tr>
<tr>
<td>W10</td>
<td>MAM</td>
<td>0x04</td>
</tr>
<tr>
<td>W10</td>
<td>0x0000001e or 30</td>
<td>SCCA</td>
</tr>
</tbody>
</table>
<p>Prefetch can be disabled in registry C:\Windows\System32\config\SYSTEM. Export it and open, for example, in Fred. CurrentControlSet -&gt; SessionManager -&gt; Memory Managment -&gt; Prefetch Parameters -&gt; Enable Prefetcher:</p>
<table>
<thead>
<tr>
<th>key</th>
<th>meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>0</code></td>
<td>disabled</td>
</tr>
<tr>
<td><code>1</code></td>
<td>enabled for apps only</td>
</tr>
<tr>
<td><code>2</code></td>
<td>enabled for boot only</td>
</tr>
<tr>
<td><code>3</code></td>
<td>boot and app enabled (default)</td>
</tr>
</tbody>
</table>
<p>You can check it with <code>rip.exe</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">rip.exe -r SYSTEM -p prefetch <span class="c1"># to show whether prefetch is enabled</span>
</code></pre></div><p><strong>Caveats</strong></p>
<p>On servers is usually turned off. And starting with Win10 - compressed. For systems with solid state drives it&rsquo;s also disabled. With Win8 - additional run times recorded. Also, there is latency issue - some apps are not closed upon clicking X, but remain running in background. Hence, the last time run might be different.</p>
<blockquote>
<p>If the app was deleted and then reinstalled? What the firtst run time will be?</p>
<p>What if I rename an executable?</p>
<p>If the exe is substitued?</p>
</blockquote>
<p>If the same exe was run from different locations - different <code>.pf</code> files. If the application was deleted, the info remains in prefetch.</p>
<blockquote>
<p>Write a sctipt to determine deleted files</p>
</blockquote>
<hr>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">pecmd</span> <span class="o">-f</span> <span class="s2">&#34;path/to/pf/file.pf&#34;</span> <span class="c"># for a single file</span>
<span class="n">pecmd</span> <span class="n">-d</span> <span class="s2">&#34;dir/with/pfs&#34;</span> <span class="n">-q</span> <span class="p">-</span><span class="n">-csvf</span> <span class="p">&lt;</span><span class="n">filename</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-csv</span> <span class="p">&lt;</span><span class="n">wheretoputtheresult</span><span class="p">&gt;</span>
<span class="c"># Review in TimeLine Explorer</span>
</code></pre></div><p>Information that can be got from the pf files:</p>
<ul>
<li>Executable name. If it was changed or run from a different location it will have a different name (different suffix at the end, for example CHROME-12345BC and CHROME-43216AD).</li>
<li>Run times</li>
<li>Other run times (not always, if run times &gt; 1)</li>
<li>Referenced files and directories</li>
<li>File size</li>
<li>Hash</li>
<li>Last Run</li>
</ul>
<p>Stacking with Kansa</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># run this Kansa script from the directory with all the csv (results of pecmd) files from all the machines you need to review.</span>
<span class="nb">Get-PrefetchListingStack</span><span class="p">.</span><span class="n">ps1</span> <span class="p">&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">csv</span>

<span class="c"># look for files that were run once first. These are the most suspocious. </span>
<span class="c"># if you have an approximate dates of infection, sort by this data as well.</span>
</code></pre></div><h4 id="application-compatibility-cache-shimcache">Application Compatibility Cache (ShimCache)</h4>
<p>My article about Registry and ShimCache.</p>
<hr>
<p><strong>Key</strong> üîë: <code>CurrentControlSet\Control\Session Manager\AppCompatCache\AppCompatCache</code>.</p>
<p><strong>üõ†</strong>: ShimCacheParser.py (requires Python2), AppCompatCacheParser, shimcache plugin for <code>vol.py</code></p>
<p>Originally was used to identify compatibility issues between 32 and 64 bit progs. Track the <strong>file name, file path, size, last modified time, execution flag*</strong> ‚è∞.</p>
<p>Can be used to see installed apps, deleted apps, wiping apps, notable directories, malware.</p>
<p>Only logs specific file extensions (<code>exe</code>, <code>dll</code>, <code>bat</code>). It might not be a reliable evidnce that the program was executed or even installation, but if the program was installed and deleted - it won&rsquo;t be deleted from here. ShimCache is another name for this artifact. ‚ö†Ô∏è Uses file system timestamps. Last modified ~ when the file was created, changed (the exe itself) or renamed.</p>
<blockquote>
<p>‚ö†Ô∏è Written at shutdown!</p>
<p>‚ö†Ô∏è Doesn‚Äôt track the file execution for Win7+ systems.</p>
</blockquote>
<hr>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">ShimCacheParser</span><span class="p">.</span><span class="n">py</span> <span class="n">-i</span> <span class="s2">&#34;Input file&#34;</span> <span class="n">-o</span> <span class="s2">&#34;Output file&#34;</span>
</code></pre></div><blockquote>
<p>‚ö†Ô∏è Got an error <code> File &quot;ShimCacheParser.py&quot;, line 148,  except OverflowError, err:            ^, SyntaxError: invalid syntax</code>.</p>
<p>‚úçÔ∏è Use python 2.6+. Command <code>python27</code> in my case (alias for pyenv activate python27). It should be installed of course.</p>
</blockquote>
<p><strong>Dropped exe</strong>. Last Modified - when the exe was dropped on the system.</p>
<p><strong>Executed exe</strong>. Last Modified is updated.</p>
<p><strong>Deleted exe</strong>. Last Modified is not updated.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">grep -A10 -i <span class="s2">&#34;last modified&#34;</span> <span class="s2">&#34;path/to/csv/from/shimcacheparser&#34;</span> &gt; results.csv

grep -iv <span class="s2">&#34;windows&#34;</span> <span class="s2">&#34;path/to/csv/from/shimcacheparser&#34;</span> &gt; resultsExcluded.csv <span class="c1"># targeting notable directories</span>

grep -E i <span class="s2">&#34;[\\][a-Z0-9]{1,4}\.(exe|bat|dll|py|txt|vbs)&#34;</span> <span class="s2">&#34;path/to/csv/from/shimcacheparser&#34;</span> &gt; resultNotables.csv
</code></pre></div><blockquote>
<p>üìù Tried running these test myself on a Win11 Parallels VM on macOS. <code>cat resultInstalledAndExecuted.csv | awk -F &quot;,&quot; '/Procmon64/ {print $0}'</code>. In my case these entries remained intact after execution or deletion. I should install something new and see the result then.</p>
</blockquote>
<hr>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">appcompatcacheparser</span> <span class="o">-f</span> <span class="s2">&#34;SYSTEM/hive&#34;</span> <span class="p">-</span><span class="n">-csv</span> <span class="s2">&#34;savetodir&#34;</span> <span class="p">-</span><span class="n">-csvf</span> <span class="s2">&#34;savetofileindir.csv&#34;</span>
</code></pre></div><p>Tips:</p>
<ul>
<li>Different entries with the last modification date being the same - most probably a rename activity. Use $UsnJrnl and $Logfile for proof. Sort by the MT in TimeLine Explorer</li>
<li>In case of UNC path (those starting from an IP of the machines) could be an indicator that the file was browsed and launched with Explorer, or malware ran it using UNC path.</li>
<li>Check for the NTFS last modified timestamp with powershell <code>Get-ChildItem &lt;file&gt; | Select Name, LastWriteTime</code>. If this date and time and the timestamp shown by ShimCache are different (NTFS ts being much older), then there probably was a timestomping at place. It&rsquo;s impossible for a ShimCache entry to have a newer ts than the NTFS ts. Also, this would indicate that the file was not executed after the ShimCache entry was created.</li>
</ul>
<h4 id="amcache-registry-examination">Amcache Registry Examination</h4>
<h4 id="scaling-shimcache-and-amcache-investigations">Scaling ShimCache and Amcache Investigations</h4>
<p>Stacking with Kansa</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Linux</span>
sudo su -
<span class="c1"># AppCompatProcessor.py </span>
<span class="c1"># Step 1. Connect Amcache.hve and SYSTEM hives to the SQL DB.</span>
AppCompatProcessor.py ./db.db load <span class="s2">&#34;path/to/hives.zip&#34;</span>
AppCompatProcessor.py ./db.db search <span class="c1"># /etc/AppCompatProcessor/AppCompatSearch.txt contains signatures to look for and can be changed.</span>
<span class="c1"># Result is stored in Output.txt</span>

<span class="c1"># Stacking examples:</span>
AppCompatProcessor.py ./db.db stack <span class="s2">&#34;Filename&#34;</span> LIKE <span class="s1">&#39;%&lt;partialname&gt;%&#39;</span>
AppCompatProcessor.py ./db.db stack <span class="s2">&#34;Filename&#34;</span> <span class="s2">&#34;length(filename)&lt;3&#34;</span> <span class="c1"># malware is often named with 1 or 2 characters. Let&#39;s make the max 3 just in case</span>

AppCompatProcessor.py ./db.db reconscan <span class="c1"># /etc/AppCompatProcessor.reconFiles.txt - common attackers&#39; recon techniques (interesting commands that could be indicators of recon)</span>

AppCompatProcessor.py ./db.db list <span class="c1">#???</span>

</code></pre></div><p>Could not make the tool run against the hive collected with FTK from my Windows 11 machine.</p>
<h3 id="lateral-movement-adversary-tactics-techniques-and-procedures-ttps">Lateral Movement Adversary Tactics, Techniques, and Procedures (TTPs)</h3>
<p>To do anything on a Windows machine (doesn&rsquo;t this apply to UNIX system as well?) you need a user account. So, at least some account is needed. But the altimate goal is an admin account (domain, if there is a DC).</p>
<p>Detection is possible when you know what&rsquo;s not ok. For example, suspicious logins after hours or unusual account for this machine or for this employee.</p>
<h4 id="types-of-credentials">Types Of Credentials</h4>
<p>Hashes. LM (not used anymore) and NT hashes.</p>
<p>Tokens.</p>
<p>Cached credentials.</p>
<p>LSA secrets.</p>
<p>Tickets. üêï üê© üê∂.</p>
<p>NTDS.DIT.</p>
<h4 id="security-features-protecting-user-accounts">Security features protecting user accounts</h4>
<p><a href="https://www.first.org/resources/papers/conf2017/Windows-Credentials-Attacks-and-Mitigation-Techniques.pdf">Conf2017 presentation</a>.</p>
<p>On Windows XP every used had admin privileges üò¨. So, at least some work needed to be done. Below are some features added in order to solve this problem.</p>
<p><strong>Managed service accounts</strong>. Windows 7+.  Special accounts for some services, that are not used by normal users. These accounts have an automatically-managed, complex password removing the requirement of manually dealing with password rotation and security.</p>
<p><strong>Group managed service accounts</strong>. Windows 8+ From the Microsoft docs: <em>&ldquo;The group Managed Service Account (gMSA) provides the same functionality within the domain but also extends that functionality over multiple servers.&quot;</em>.</p>
<p><strong>Domain Protected Users Security Group</strong>.</p>
<p><strong>KB2871997 patch</strong>. Windows 7+ &amp; Windows Server 2008R2+. Contains a bunch of security improvements (protected groups, lsa update etc). More <a href="https://msrc-blog.microsoft.com/2014/06/05/an-overview-of-kb2871997/">here</a>.</p>
<p><strong>UAC</strong>. Windows Vista +. It means User Account Control. Whenever something admin-like is requested by a process, the user needs to aprove this explicitly (<code>consent.exe</code> process with a GUI window), i.e. elevate privileges. There were some exploits that allowed UAC bypass and may there is somewhere another one lurking in the wild, but officially it&rsquo;s now pretty safe.</p>
<p><strong>Restricted admin</strong>. Windows 8.1+ and Server 2012 R2+.  It&rsquo;s a mode and it prevents storing an RDP user&rsquo;s credentials in memory on the machine to which an RDP connection is made.</p>
<p><strong>Local admin logon restrictions</strong>. Windows 8+</p>
<p><strong>SSP passwords in plaintext mitigation</strong>. Windows 8+</p>
<p><strong>Protected Processes</strong>. Windows 8+</p>
<p><strong>LSA Cache cleanup</strong>. Windows 8+</p>
<p><strong>Credential Guard and Remote Credential Guard</strong>. Windows 10+. This topic is described in more details by Artyom Sinitsin on PhDays 2019 (<a href="https://youtu.be/2Aa9_yq4BX4">here</a>).</p>
<p><strong>Device Guard</strong>. Windows 10+. Prevents execution of untrusted code.</p>
<h4 id="compromising-credentials-techniques">Compromising Credentials Techniques</h4>
<h4 id="remote-desktop-services-misuse">Remote Desktop Services Misuse</h4>
<h4 id="windows-admin-share-abuse">Windows Admin Share Abuse</h4>
<h4 id="psexec-and-cobalt-strike-beacon-psexec-activity">PsExec and Cobalt Strike Beacon PsExec Activity</h4>
<h4 id="windows-remote-management-tool-techniques">Windows Remote Management Tool Techniques</h4>
<h4 id="powershell-remotingwmic-hacking">PowerShell Remoting/WMIC Hacking</h4>
<h4 id="vulnerability-exploitation">Vulnerability Exploitation</h4>
<h4 id="tracking-lateral-movement">Tracking Lateral Movement</h4>
<p><strong>Shares</strong>.  Can be used to track this sort of activity. Mounted shares is one way (5140). ANONYMOUS LOGON is a common thing produced by a built-in accounts on Windows machines (filter it out). If you see a PC name it&rsquo;s not usually suspicious. However, keep an eye on those accounts that mounted shared on remote systems if they are not domain admins!</p>
<p><strong>Services</strong>. Start types. 0 boot, 1 loaded by i/o subsystem, 2 always loaded and run, 3 - manually, 4 - disabled. So, during investiagtion we&rsquo;d be looking primarily for 0, 1 and 2. 7045 - Services started with user credentials are suspicious. To map SIDs and RIDs to the actual user names, use Security event log, eid 4624 (logins, obviously).</p>
<p><strong>Tasks</strong>. TaskScheduler Operational logs, <a href="https://kb.eventtracker.com/evtpass/evtpages/EventId_106_Microsoft-Windows-TaskScheduler_66066.asp">106</a> to get all the registered tasks. Then, use the name of this tasks to filter other events and see what happened (if anything happened). If the task was successful - look for 200 (task executed) and 201 (task completed). Otherwise, look for 332 warning or other errors. Check at <code>C:\Windows\System32\Tasks</code>, open the xml associated with your loot üí∞.</p>
<p><strong>Log Clearing</strong>. Attackers are not interested in investigation, so they are likely to be covering their tracks. One of the way to do so - simply clear the logs. Although it&rsquo;s raising alert on its own, it still deleted valuable source of information.</p>
<p><strong>RunAs</strong>. Logged on both machines if it was remote. <a href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4648">4648</a>.</p>
<h3 id="log-analysis-for-incident-responders-and-hunters">Log Analysis for Incident Responders and Hunters</h3>
<h4 id="profiling-account-usage-and-logons">Profiling Account Usage and Logons</h4>
<h4 id="tracking-and-hunting-lateral-movement">Tracking and Hunting Lateral Movement</h4>
<h4 id="identifying-suspicious-services">Identifying Suspicious Services</h4>
<h4 id="detecting-rogue-application-installation">Detecting Rogue Application Installation</h4>
<h4 id="finding-malware-execution-and-process-tracking">Finding Malware Execution and Process Tracking</h4>
<h4 id="capturing-command-lines-and-scripts">Capturing Command Lines and Scripts</h4>
<h4 id="powershell-transcript-and-scriptblock-logging">PowerShell Transcript and ScriptBlock Logging</h4>
<h4 id="discovering-cobalt-strike-beacon-powershell-import-activity">Discovering Cobalt Strike beacon PowerShell Import Activity</h4>
<h4 id="powershell-script-obfuscation">PowerShell Script Obfuscation</h4>
<h4 id="wmi-activity-logging">WMI Activity Logging</h4>
<h4 id="anti-forensics-and-event-log-clearing">Anti-Forensics and Event Log Clearing</h4>
<h2 id="resources">Resources</h2>
<p>[<a href="https://www.crowdstrike.com/cybersecurity-101/advanced-persistent-threat-apt/">1</a>] About some APT groups</p>
<p>[<a href="https://www.amazon.com/Practical-Malware-Analysis-Hands-Dissecting/dp/1593272901">2</a>] Practical Malware Analysis book</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.1237ff71925bb8625c97a9af8db4c54525258bedfd7c47493daaff723bea755e.js"></script>
  

  
  
  
    
  


</body>

</html>
