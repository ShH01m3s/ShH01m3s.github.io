<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖱 Devices Attached - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-ttp 🔍">
      <a href="/docs/ttp">
        <span>TTP 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-artefacts db 🏺">
      <a href="/docs/tools">
        <span>Artefacts DB 🏺</span>
      </a>
    </li>
    
    <li class="menu-item-attacks db ⚔️">
      <a href="/docs/tools">
        <span>Attacks DB ⚔️</span>
      </a>
    </li>
    
    <li class="menu-item-tools db 🛠️">
      <a href="/docs/tools">
        <span>Tools DB 🛠️</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-ttp 🔍">
      <a href="/docs/ttp">
        <span>TTP 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-artefacts db 🏺">
      <a href="/docs/tools">
        <span>Artefacts DB 🏺</span>
      </a>
    </li>
    
    <li class="menu-item-attacks db ⚔️">
      <a href="/docs/tools">
        <span>Attacks DB ⚔️</span>
      </a>
    </li>
    
    <li class="menu-item-tools db 🛠️">
      <a href="/docs/tools">
        <span>Tools DB 🛠️</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/artefacts/win/registry/"> 👈🏼 Back to </br> 🏺 Windows Registry </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#attached-devices">Attached devices</a></li>
        <li><a href="#usbs">USBs</a>
          <ul>
            <li><a href="#logs">Logs</a></li>
          </ul>
        </li>
        <li><a href="#mounted-devices">Mounted Devices</a></li>
        <li><a href="#managedbyapp">ManagedByApp</a></li>
        <li><a href="#shellbags">ShellBags</a></li>
        <li><a href="#event-logs">Event Logs</a></li>
        <li><a href="#plugnplay">Plug&rsquo;n&rsquo;Play</a></li>
      </ul>
    </li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">🖱 Devices Attached</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      
      <div class="article-category">
          
            
            
            
            
            
              <i class="fab fa-linux"></i>&nbsp;<i class="fab fa-apple"></i>&nbsp;<i class="fab fa-windows"></i>&nbsp;<i class="fas fa-mobile"></i>
            
            
          
          
      </div> <br />
      

      
      

      
    </div>
    
    <b>Created:</b> 12.10.2020
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p>Are we looking for USB storage media activity or all USB devices? Like, cameras 📸? Headphones 🎧? As for the timestamps, you&rsquo;ll usually have <strong>first</strong> (setupapi log) and <strong>last</strong> connected. There are also OS specific timestamps, like first or last install, first connect since reboot etc. <a href="/docs/dfir/host/windows/windows-artifacts#usb-devices">Windows</a> USB artifacts, <a href="/docs/dfir/host/apple/mac-artifacts#usb-devices">macOS</a>. See Event Manager&rsquo;s codes <a href="docs/dfir/host/windows/event-manager#20001">20001</a> and <a href="docs/dfir/host/windows/event-manager#20002">20002</a> for USB events for verification or if the registry was updated. Look at <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\DeviceClasses\</code> and <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Enum\USB\&lt;hardware id&gt;\&lt;instance id&gt;\Device Parameters</code>. <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/usbcon/usb-device-specific-registry-settings">More</a>.</p>
<blockquote>
<p>⚠️ On Windows, USB timestamps in registry will be updated when the registry itself gets update with a Windows update. Use Event Manager logs in these cases.</p>
</blockquote>
<p>Look at <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\DeviceClasses\</code> and <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Enum\USB\&lt;hardware id&gt;\&lt;instance id&gt;\Device Parameters</code>.</p>
<h3 id="attached-devices">Attached devices</h3>
<p><strong>Key</strong> 🔑: <code>Software\Microsoft\Windows Portable Devices\Devices</code>. For USB and other devices connected. The sub-key name contains the device&rsquo;s serial number, name, disk ID (between <code>{}</code>), which is assigned by OS. This disk id can be used to track the device accross the system, for example, other registry values. But keep in mind, that not every USB device has a serial number. Dates and times - when the device was first inserted <em>after the last reboot</em>. <code>FriendlyName</code> - user-created name of the volume.</p>
<p><strong>Key</strong> 🔑: <code>Software\Microsoft\Windows NT\CurrentVersion\EMDMgmt</code>. It was put as an extension of memory (aka ready boost). Checks to see if the USB device can be used to extend memory. Timestamps - when first inserted. Some entries are ending with some decimal number, this is a volume ID in decimal (convert to hex and get your GUID that can be used to correlated data with <code>USBSTR</code> in <code>SYSTEM</code> hive, see below). These should be converted to hex and used to trace the device accross the system.</p>
<p><strong>Key</strong> 🔑: <code>Software\Microsoft\Windows NT\CurrentVersion\Print\Printers</code> for printers connected. This subkey may also contains some SIDs. I don&rsquo;t quite understand yet, when this happens in general, but one case is when OneNote is used to share documets.</p>
<blockquote>
<p>⚠️ Use information about USB devices from <code>SYSTEM</code> hive to get more and validate this information.</p>
</blockquote>
<h3 id="usbs">USBs</h3>
<p><strong>Key</strong> 🔑: <code>System\ControlSet001\Enum\USBSTOR</code> or <code>ControleSet001\Enum\USB</code> (on my Win10 VM)</p>
<p><strong>Key</strong> 🔑: <code>System\MountedDevices</code> - used to map devices to drive letters (not only USBs).</p>
<p>Contains ever connected USBs with their serial numbers (if they have these) and some additional information. <code>0064</code> - first installed, <code>0065</code> last installed, <code>0066</code> last arrival and <code>0067</code> last removal. The full path: <code>Computer\HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Enum\USB\ROOT_HUB20\4&amp;3af74d6&amp;0\Properties\{83da6326-97a6-4088-9453-a1923f573b29}\</code>. ⚠️ Note that <code>ROOT_HUB20\4&amp;3af74d6&amp;0</code> is device specific, but <code>{83da6326-97a6-4088-9453-a1923f573b29}</code> is not.</p>
<blockquote>
<p>⚠️ To view <code>Properties</code> subkey admin 🧑‍💼 privileges are not enough for the live-registry. Install <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">psexec</a> and elevate to system by running the folling command from the <code>psexec</code> folder: <code> .\PsExec.exe -i -s -d powershell.exe</code>. In the PowerShell window that opens run <code>regedit</code>.</p>
</blockquote>
<p><code>Device Parameters\PartMgr</code> - gives a disk ID. <code>PartitionTableCache</code> may contains &hellip; surprise-surprise&hellip; a partition table! Wow&hellip; . For a GPT locate <code>FF FF FF FF 00 00 00 00</code>. 16 bytes right after that are for file system GUID. The next 16 bytes are unique volume GUID used to identify the volume accross systems as well as within one. It might be empty for a USB device. <code>ContainerID</code> - very important, can be used to filter event logs.</p>
<p>As for the <code>MountedDevices</code>&hellip; . If a device doesn&rsquo;t have a serial number, it&rsquo;ll be assigned a machine assigned number aka unique instance ID (not consistent accross multiple systems). If the second character is <code>&amp;</code> - not a a serial number.</p>
<blockquote>
<p>❓ How do I find it? Lot&rsquo;s of gibberish is all I see&hellip;</p>
<p>✍️ Just find the device name, search for the <code>#</code> sign, check after it and up until the next <code>#</code> right before a GUID contained withing <code>{}</code>.</p>
</blockquote>
<p>This is an example of a USB device <strong>with</strong> a serial number that will be reletively unique (not all vendors borther giving each USB drive a separate serial number).</p>
<p><img src="images/usb-2.png" alt="usb-2"></p>
<p>And here is an example of a machine assigned id. Note, that the second symbols is <code>&amp;</code>.</p>
<p><img src="images/usb-1.png" alt="usb-1"></p>
<p>The value that follows the serial number/uniqueid right after the second <code>#</code> and encolsed between <code>{}</code> is the disk id.</p>
<h4 id="logs">Logs</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">USBDevicesLogs: Path: C: <span class="se">\W</span>indows<span class="se">\s</span>etupapi.log
</span></span><span class="line"><span class="cl">USBDevicesLogs: Path: C: <span class="se">\W</span>indows<span class="se">\i</span>nf<span class="se">\s</span>etupapi.dev. log
</span></span></code></pre></div><h3 id="mounted-devices">Mounted Devices</h3>
<p><strong>Key</strong> 🔑: <code>NTUSER\MountPoints2</code>.</p>
<p>If you link volumes from system-wide 🔑 <code>MountPoints</code> and 🔑 <code>USBSTR</code>, we can link a device to a specific user. This 🔑 also shows all systems connected by the current user (useful for RDP investigations).</p>
<blockquote>
<p>🗒️ TODO: How to link, screenshots.</p>
</blockquote>
<h3 id="managedbyapp">ManagedByApp</h3>
<p><strong>Key</strong> 🔑: <code>Software\Microsoft\Windows\CurrentVersion\AppModel\SystemAppData\Microsoft.Windows.Photos_8wekyb3d8bbwe\PersistedStorageItemTable\ManagedByApp</code>.</p>
<p>Tracks images opened with Microsoft application. Shows <em>volume GUID</em> (use other USB-related registry to assemble the picture), file path, data and time ⏰. <code>LastUpdateTime</code> shows when the files was &hellip; . This date and time is very close <code>LastInteracted</code> from ShellBags. Go to <code>MountedDevices</code> in <code>SOFTWARE</code> hive to find the device by the volume GUID and the to <code>SYSTEM</code>&rsquo;s <code>USBSTR</code> -&gt; <code>PartitionTableCache</code>.</p>
<p>This information is very useful for child abuse cases.</p>
<h3 id="shellbags">ShellBags</h3>
<p><strong>Key</strong> 🔑 : <code>Local Settings\Software\Microsoft\Windows\Shell\BagMRU </code>. Values: <code>MRUListEx</code>, <code>NodeSlot</code>, <code>Subkeys</code>.</p>
<p><strong>Key</strong> 🔑 : <code>Local Settings\Software\Microsoft\Windows\Shell\Bags</code>. Values: <code>Shell</code>, will have folder&rsquo;s GUID.</p>
<p>For more info refer to the Shellbags article.</p>
<h3 id="event-logs">Event Logs</h3>
<p>Security 6416: A new external device was recognized by the system</p>
<p>Event ID 219 is logged when a device is plugged into a Windows-based system</p>
<h3 id="plugnplay">Plug&rsquo;n&rsquo;Play</h3>
<p><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/install/setupapi-logging--windows-vista-and-later-">https://docs.microsoft.com/en-us/windows-hardware/drivers/install/setupapi-logging--windows-vista-and-later-</a></p>
<p>By default, the SetupAPI text logs are located in the<code> %SystemRoot%\Inf</code> directory.</p>
<p>To enable event categories for the SetupAPI logs, create (or modify) the following <a href="https://docs.microsoft.com/en-us/windows/desktop/SysInfo/registry-value-types">REG_DWORD</a> registry value:
<code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Setup\LogMask</code>. More <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/install/enabling-event-categories-for-a-text-log">here</a>.</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
