<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AmCache - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-ttp 🔍">
      <a href="/docs/ttp">
        <span>TTP 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-artefacts db 🏺">
      <a href="/docs/tools">
        <span>Artefacts DB 🏺</span>
      </a>
    </li>
    
    <li class="menu-item-attacks db ⚔️">
      <a href="/docs/tools">
        <span>Attacks DB ⚔️</span>
      </a>
    </li>
    
    <li class="menu-item-tools db 🛠️">
      <a href="/docs/tools">
        <span>Tools DB 🛠️</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-ttp 🔍">
      <a href="/docs/ttp">
        <span>TTP 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-artefacts db 🏺">
      <a href="/docs/tools">
        <span>Artefacts DB 🏺</span>
      </a>
    </li>
    
    <li class="menu-item-attacks db ⚔️">
      <a href="/docs/tools">
        <span>Attacks DB ⚔️</span>
      </a>
    </li>
    
    <li class="menu-item-tools db 🛠️">
      <a href="/docs/tools">
        <span>Tools DB 🛠️</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/artefacts/win/registry/"> 👈🏼 Back to </br> 🏺 Windows Registry </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#-anatomy">☠️ Anatomy</a>
      <ul>
        <li><a href="#devicecensus"><code>DeviceCensus</code></a></li>
        <li><a href="#file"><code>File</code></a></li>
        <li><a href="#inventoryapplication"><code>InventoryApplication</code></a></li>
        <li><a href="#inventoryapplicationfile"><code>InventoryApplicationFile</code></a></li>
        <li><a href="#inventorydevicecontainer"><code>InventoryDeviceContainer</code></a></li>
        <li><a href="#inventorydevicepnp"><code>InventoryDevicePnp</code></a></li>
        <li><a href="#programs"><code>Programs</code></a></li>
      </ul>
    </li>
    <li><a href="#-timestamps">⏰ Timestamps</a></li>
    <li><a href="#-tools">🛠 Tools</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">AmCache</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 01.06.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p><em>And yet another place to check for program execution. It&rsquo;s like a forensic treasure of program execution. You can see installed applications, drivers and unassociated progs. For each entry, you can see loads of metadata. You can even see the SHA1 hashes! How great is that? However, be careful; installed doesn&rsquo;t mean executed!</em></p>
<blockquote>
<p>✍🏻 It&rsquo;s not reliable evidence of execution. Use it as evidence of PRESENCE and for metadata collection, and use other artefacts (such as Prefetch) to prove execution.</p>
</blockquote>
<h2 id="-anatomy">☠️ Anatomy</h2>
<p>It used to be called <code>RecentFileCache.bcf</code>. And then it was changed several times. You could see the first execution time on Win8.</p>
<blockquote>
<p>❗️ The GUID indicates the volume GUID, not the user GUID!</p>
</blockquote>
<blockquote>
<p>⛔️ The format and info in this particular artefact are not driven by the OS but rather the DLL&rsquo;s version!</p>
</blockquote>
<p><strong>Path</strong> 📂 : <code>C:\Windows\AppCompat\Programs\Amcache.hve</code>.</p>
<p>Win8+. This artefact stores information about program execution, including those executed from a USB drive, loaded drivers, programs executed, etc. It contains the following information:</p>
<p>🐾 install date and time
🐾 name
🐾 version
🐾 path to exe/dll
🐾 source info
🐾 path to uninstall
🐾 publisher name
🐾 volume GUIDs
🐾 container ID of the device from which the program was run.
🐾 SHA1 hash of a driver or exe</p>
<p>Several types of processes are tracked here:</p>
<ol>
<li>Executed GUI</li>
<li>Executables and dlls copies during app execution</li>
<li>Executables in the folder scanned by Microsoft Compatibility Appraiser (scheduled task). Programs Files and Desktop.</li>
</ol>
<p>Here is what <code>Amcache</code> looks like in Registry Explorer (open <code>Amcache.hve</code> from the upper menu File -&gt; Open).</p>
<p><img src="images/amcache_regexp1.png" alt="img"></p>
<p>Let&rsquo;s understand each forensically valuable part one by one.</p>
<h3 id="devicecensus"><code>DeviceCensus</code></h3>
<p>This &ldquo;directory&rdquo; contains some information about the physical machine itself. For example, for my Parallels VM, there was also a <code>VM</code> subkey that contained some value <code>VMId</code>.</p>
<p><img src="images/amcache_regexp2.png" alt="img"></p>
<p><img src="images/amcache_regexp3.png" alt="img"></p>
<p>I can see that this <code>hve</code> file belongs to a VM.</p>
<p><img src="images/amcache_regexp4.png" alt="img"></p>
<p>I can even see that it&rsquo;s a <code>Apple Silicon</code> by looking at the Processor key 🔑.</p>
<p><img src="images/amcache_regexp5.png" alt="img"></p>
<h3 id="file"><code>File</code></h3>
<p>Full path to the executable.</p>
<blockquote>
<p>⚠️ Not present on my Windows 10 and Windows 11 (Parallels VM).</p>
</blockquote>
<h3 id="inventoryapplication"><code>InventoryApplication</code></h3>
<p>Consists of folders/subkeys named by the program id. Each folder will contain the following important information: <code>OSVersionAtInstallTime</code>, <code>InstallDateMsi</code>, <code>InstallDate</code>, <code>InstallDateArpLastModified</code>, <code>InstallDateFromLinkFile</code>, <code>Name</code>, <code>Publisher</code>, <code>RegistryKeyPath</code> (may show user SID), <code>Source</code>, <code>UninstallString</code>, <code>ProgramID</code> (consistent across systems).</p>
<blockquote>
<p>👀 On my Parallels Windows 10 machine, I noticed that Windows and Mac executables are listed here, even though I have explicitly set preferences for not sharing Mac folders or disks with the VM.
⛔️ No such key on my Windows 11 machine (VM, Parallels).</p>
</blockquote>
<h3 id="inventoryapplicationfile"><code>InventoryApplicationFile</code></h3>
<p>App name + file hash (algo unknown). Contains a field, an SHA-1 hash (<code>FileID</code>), padded with 4 leading zeros, a full path to the executable (<code>LowerCaseLongPath</code>), file size (<code>Size</code>), and compilation time from PE header (<code>LinkDate</code>). Use a list of known goods or VirusTotal.</p>
<p><img src="images/amcache_regexp6.png" alt="img"></p>
<h3 id="inventorydevicecontainer"><code>InventoryDeviceContainer</code></h3>
<p>Contains <code>ModelName</code> and <code>FriendlyName</code>. When devices get connected, they might install some software to be able to work correctly.</p>
<h3 id="inventorydevicepnp"><code>InventoryDevicePnp</code></h3>
<p>Contains <code>ContainerID</code>, <code>DriverID</code>, <code>Description</code>, <code>Manufacturer</code> and <code>Model</code>.</p>
<h3 id="programs"><code>Programs</code></h3>
<p>Where this program is located within the FS and the source (for example, <code>AddRemoveProgram</code>). And also the information path to the uninstaller in the registry.</p>
<blockquote>
<p>⛔️ Don&rsquo;t have it on my VM (Windows 11, Parallels)</p>
</blockquote>
<h2 id="-timestamps">⏰ Timestamps</h2>
<p>The key&rsquo;s last write time of the key itself indicates the first time the application was executed.</p>
<h2 id="-tools">🛠 Tools</h2>
<p>AmCacheParser.exe + Timeline Explorer.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">AmcacheParser</span><span class="p">.</span><span class="n">exe</span> <span class="o">-f</span> <span class="p">&lt;</span><span class="n">path_to_AmCache</span><span class="p">.</span><span class="n">hve</span><span class="p">&gt;</span> <span class="n">-i</span> <span class="n">on</span> <span class="p">-</span><span class="n">-csv</span> <span class="p">&lt;</span><span class="n">export_to_folder_no_quotes</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-csvf</span> <span class="p">&lt;</span><span class="n">desired_filename</span><span class="p">&gt;</span> 
</span></span></code></pre></div><p>What are unassociated files? Those that are not associated with a known source. Good starting point when looking for bad files.</p>
<blockquote>
<p>⚠️ In my case on a macOS with Parallels and Windows 10 installed, this evidence also contained mac executables.</p>
</blockquote>
<p><img src="images/amcachehve1.png" alt="img"></p>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    ssi.gouv.fr/uploads/2019/01/anssi-coriin_2019-analysis_amcache.pdf - different types of AmCache
</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
