<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏺 Active Directory - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-ttp 🔍">
      <a href="/docs/ttp">
        <span>TTP 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-artefacts db 🏺">
      <a href="/docs/tools">
        <span>Artefacts DB 🏺</span>
      </a>
    </li>
    
    <li class="menu-item-attacks db ⚔️">
      <a href="/docs/tools">
        <span>Attacks DB ⚔️</span>
      </a>
    </li>
    
    <li class="menu-item-tools db 🛠️">
      <a href="/docs/tools">
        <span>Tools DB 🛠️</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-ttp 🔍">
      <a href="/docs/ttp">
        <span>TTP 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-artefacts db 🏺">
      <a href="/docs/tools">
        <span>Artefacts DB 🏺</span>
      </a>
    </li>
    
    <li class="menu-item-attacks db ⚔️">
      <a href="/docs/tools">
        <span>Attacks DB ⚔️</span>
      </a>
    </li>
    
    <li class="menu-item-tools db 🛠️">
      <a href="/docs/tools">
        <span>Tools DB 🛠️</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/artefacts/win/"> 👈🏼 Back to </br> 🪟 Windows Artefacts </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#-ntdsdit">🏺 <code>NTDS.DIT</code></a>
      <ul>
        <li><a href="#attacks--investigation">Attacks &amp; Investigation</a></li>
        <li><a href="#default-accounts">Default accounts</a></li>
        <li><a href="#protecting-domain-accounts">Protecting Domain Accounts</a></li>
      </ul>
    </li>
    <li><a href="#group-policy">Group Policy</a></li>
    <li><a href="#attacks">Attacks</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">🏺 Active Directory</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      
      <div class="article-category">
          
            
              <i class="fab fa-windows"></i>          
            
            
            
            
            
            
          
          
      </div> <br />
      

      
      <div class="article-category">
        <i class="fas fa-tools"></i>
          
          
          <a class="platform-link" href="/tools/active-directory">Active Directory</a> 
          
      </div> <br />
      
      

      
    </div>
    
    <b>Created:</b> 28.07.2022
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p>Moving accounts and auth policies to the server side. Azure Active Directory is when instead of having a physical server, you have a server in the cloud ⛅️. Defines a set of rules to restrict users&rsquo; access to resources. PCs that are part of AD usually don&rsquo;t have full access to the systems.</p>
<p>AD DS store contains db files and processes that manage directory information for users, services and applications. Consists of <code>Ntds.dit</code> file, at <code>%SystemRoot%\	NTDS</code> folder on all DC. Is only accessible thtough the DC&rsquo;s processes and protocols.</p>
<p><strong>Class objects</strong>. What objects can be created in the dir (User, Computer).</p>
<p><strong>Attribute objects</strong>. Info attached to an object (Display name).</p>
<p><strong>Forests</strong>. Share common schema, config partition, global catalog, trusts between domains in the forest, Enterprise Admins and Schema Admins groups.</p>
<p><strong>OU</strong>. Organisational Units. Containers with users, groups, computers or other OUs.  Represent the org hierarchy and logically, manage objects in consistent way, delegate permissions and apply policies.</p>
<p><strong>Trust</strong>. Directional (peer to peer) and Transitive (the friend of my friend is my friend).</p>
<h2 id="-ntdsdit">🏺 <code>NTDS.DIT</code></h2>
<p>🏺 <code>\%SystemRoot%\NTDS</code>. If the file is not here, check 🔑 <code>HKLM\SYSTEM\CurrecntControlSet\Services\NTDS\Parameters</code> to see where it&rsquo;s stored. To access this key, use <code>ntdsutil</code> or another tool to get raw access to the disk or get Volume Shadow copy with  🛠️ <code>VSSAdmin</code>.</p>
<p>You need 👑 to load a drive to access the raw disk or use Volume Shadow copy. Active Directory database stored encrypted passwords for all the domain accounts along with the password history. <code>NTDS.DIT</code> is in ESE format.</p>
<p>🛠️ <code>VSSAdmin</code> (to get Volume Shadow copy), 🛠️ <code>NTDSXtract</code>, 🛠️ <code>Metasploit</code>, 🛠️ <code>PowerShell</code>, 🛠️ <code>secretsdump.py</code> (<code>impacket</code>), 🛠️ <code>Bloodhound</code> (looks a lot like a threat modelling tool). 🛠️ <code>Bloodhound</code> uses LDAP and is quite stealthy. 🛠️ <code>GoFetch</code> uses Bloodhound to create a graph and then uses <code>Invoke-Mimikatz</code> and <code>Invoke-Psexec</code> and 🛠️ <code>DeathStar</code>, which uses 🛠️ <code>PowerShell Empire</code> to achieve pretty much the same result.</p>
<h3 id="attacks--investigation">Attacks &amp; Investigation</h3>
<p><strong>LLMNR Poisoning</strong>. NBT-NS (former name). Used when DNS screws up. Uses NTLMv2 hash and username. ⚔️ Disable LLMNR (Turn off multicast name resolution) and NBT-NS. If these are needed: require network access control, strong user passwords (14+ chars).</p>
<p><strong>SMB Relay</strong>. Resend the stolen hashes to the machines that can use them instead of cracking them. Pass the hash? SMB must be disabled for the attack to work, relayed creds are admin for the machine. <code>nmap --script=smb2-security-mode.nse -p445 &lt;IP range&gt;</code> to check for SMB with signing <strong>off</strong>. Use the tool <code>ntlmrelayx.py tf targets.txt -smb2support -i</code> (<code>i</code> for Interactive shell) along with the responder (HTTP and SMB off). Use <code>nc &lt;IP&gt; &lt;port&gt;</code> to connect to the open connection. ⚔️ Enable SMB signing, disable NTLM auth over network, local admin restriction ()</p>
<h3 id="default-accounts">Default accounts</h3>
<p><strong>Administrator account</strong>.</p>
<p><strong>Guest account</strong>.</p>
<p><strong>HelpAssistant Account</strong>.</p>
<p><strong>KRBTGT account</strong>. More like a system account.</p>
<h3 id="protecting-domain-accounts">Protecting Domain Accounts</h3>
<p>First of all, separate admin accs from user accs. For admin accs follow the least priv principle.</p>
<p><strong>Privileged account</strong>:</p>
<p><strong>Minimum</strong>. Several levels of admins with separate accounts: domain, enterprise admins and other types of admins. They have various levels of access. This one 👮‍♂️ has most access, this one 👨‍🏫 a little more and this one 👨‍🎨 has not so much access as he would like to.</p>
<p><strong>Better</strong>. Separate accounts with different right for different admins roles (admin that only set up the PCs, admins that manage AD etc). Some of them have reduced rights. Usually, segregated by OU (org unit, i.e. department). For example, there is a marketing unit and they have their own admins, that support their daily activity.</p>
<p><strong>Ideal</strong>. Different accs for different <strong>trust levels</strong>. So, for example, one administrator 👨‍🏫 will have several accounts: main admin account for managing resources, another admin account for adding users. Also, standard account for his daily routine and say personal, for something that&rsquo;s not related to work.</p>
<p><strong>Standard user account</strong> 🤪:</p>
<p>E-mail 📬, browsing the Internet 🌎, using business applications.</p>
<p>It&rsquo;s also a good practice to <strong>create dedicated workstations</strong> that don&rsquo;t have network and email access:</p>
<p><strong>Minimum</strong>.  Build dedicated worstations 🖥 that don&rsquo;t have internet access.</p>
<p><strong>Better</strong>. Don&rsquo;t grant local admin rights for the machine to the admins that are using these machines.</p>
<p><strong>Ideal</strong>. No network 🌎🚫 access, only access to domains and servers that this admin manages.</p>
<p>Restrict admin logon to servers and workstations.</p>
<p><strong>Minimum</strong>.  Identify all machines that admins cannot login to. Then restrict access appropriately.</p>
<p><strong>Better</strong>. Don&rsquo;t let domain admins login to non-domain controller servers and worstations.</p>
<p><strong>Ideal</strong>. Restrict server admins logging into workstations in addition to domain admins.</p>
<p>➕Disable the account delegation for admins. Account delegation lets servers and PCs impersonate certain accounts and perform actions with these rights. For admin accs that should be disabled.</p>
<h2 id="group-policy">Group Policy</h2>
<p>Allows system administrators to define and enforce settings and configurations for user accounts and computers in a Windows domain</p>
<h2 id="attacks">Attacks</h2>
<p>Active Directory. Did you know that 95% of the Fortune 1000 companies run Active Directory in their environments? Due to this, Active Directory penetration testing is one of the most important topics you should learn and one of the least taught. The Active Directory portion of the course focuses on several topics. You will build out your own Active Directory lab and learn how to exploit it. Attacks include, but are not limited to: LLMNR poisoning, SMB relays, IPv6 DNS takeovers, pass-the-hash/pass-the-password, token impersonation, kerberoasting, GPP attacks, golden ticket attacks, and much more. You&rsquo;ll also learn important tools like mimikatz, Bloodhound, and PowerView. This is not a section to miss!</p>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    Something here
</details>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
