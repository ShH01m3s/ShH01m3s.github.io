<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>UNIX Shell - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-ttp üîç">
      <a href="/docs/ttp">
        <span>TTP üîç</span>
      </a>
    </li>
    
    <li class="menu-item-artefacts db üè∫">
      <a href="/docs/artefacts">
        <span>Artefacts DB üè∫</span>
      </a>
    </li>
    
    <li class="menu-item-attacks db ‚öîÔ∏è">
      <a href="/docs/attacks">
        <span>Attacks DB ‚öîÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tools db üõ†Ô∏è">
      <a href="/docs/tools">
        <span>Tools DB üõ†Ô∏è</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-ttp üîç">
      <a href="/docs/ttp">
        <span>TTP üîç</span>
      </a>
    </li>
    
    <li class="menu-item-artefacts db üè∫">
      <a href="/docs/artefacts">
        <span>Artefacts DB üè∫</span>
      </a>
    </li>
    
    <li class="menu-item-attacks db ‚öîÔ∏è">
      <a href="/docs/attacks">
        <span>Attacks DB ‚öîÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tools db üõ†Ô∏è">
      <a href="/docs/tools">
        <span>Tools DB üõ†Ô∏è</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/artefacts/unix/"> üëàüèº Back to </br> üçè üêß UNIX Artefacts </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#macos">macOS</a>
      <ul>
        <li><a href="#bash-history">Bash History</a></li>
        <li><a href="#zsh">zsh</a></li>
      </ul>
    </li>
    <li><a href="#linux">Linux</a>
      <ul>
        <li><a href="#shell">Shell</a></li>
        <li><a href="#bash">Bash</a>
          <ul>
            <li><a href="#lateral-movement">Lateral movement</a></li>
            <li><a href="#malicious-modifications">Malicious modifications</a></li>
            <li><a href="#recon">Recon</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">UNIX Shell</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 02.06.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <h2 id="macos">macOS</h2>
<p>By default, all console data is not being logged. Only staff that was typed with <code>sudo</code> is. Below is the screenshot of the Console app (streaming on) when <code>sudo ls</code> command is typed in the Terminal.</p>
<p><img src="images/sudo-console.png" alt="sudo-console">
And here is what&rsquo;s being logged when one types <code>sudo su</code> and then <code>ls</code>.</p>
<p><img src="images/sudo-console-2.png" alt="sudo-console-2">
What about using <code>ls</code> or <code>cat</code> without elevating privileges? Nothing is logged at all (trying <code>helloworld</code>, cat <code>metadata.db</code> or <code>visudo</code>). So, how one keeps logging their Terminal history? It would be also great to add PID of the process, effective and real usernames. Here is how I&rsquo;ve managed to do it on my local machine (to further integrate the logs with Elastic).</p>
<p>There were several problems that I&rsquo;ve encountered given it&rsquo;s a macOS.
First of all, macOS default interpreter is zsh, which doesn&rsquo;t have <code>PROMT_COMMAND</code> variable. This variable in bash allows executing some script after each command. I&rsquo;ve found a <a href="https://superuser.com/questions/735660/whats-the-zsh-equivalent-of-bashs-prompt-command">soulution</a> in the internet to overcome this pecularity: add <code>bash precmd() { eval &quot;$PROMPT_COMMAND&quot; }</code> at the beginning of the <code>~/.zshrc</code> file, then add export <code>PROMPT_COMMAND=&quot;&quot;</code> right after it. This would simulate the desired behaviour. Don&rsquo;t forget to <code>source ~/.zshrc</code> or relaunching the Terminal for the changes to be applied.</p>
<p>Now, we can log most of the commands typed here. However, in this case commands that were typed after <code>sudo su</code> won&rsquo;t be logged. That happens because when using sudo su, most of environment variables are not loaded for safety reasons. However, if you type <code>sudo su -</code> or <code>sudo -l</code> instead, you&rsquo;ll get the data logged. Shoking!</p>
<p>No matter what interpreter is in use, when you type sudo su, it&rsquo;s not loading your env variables by default. To overcome this, add <code>sudo visudo</code>. <code>Defaults env_keep += &quot;PROMPT_COMMAND&quot;</code>.</p>
<p>Commands can be retrieved by <code>history</code> command on UNIX machines. Depending on the user, the history will return different values. We need both the main user&rsquo;s and the root&rsquo;s history.</p>
<blockquote>
<p>‚ùìDoes it retireve info from zsh_history/bash_history or from elsewhere?</p>
</blockquote>
<p><code>zsh_history</code>/<code>bash_history</code> contain UNIX timestamp as well. <code>history</code> returns only command id and the command itself. Both list the same commands (check the first two and the last two lines).</p>
<blockquote>
<p>üîé Since each command has its own line, I&rsquo;ve decided to compare these two files. <code>cat ~/.zsh_history | wc -l</code> shows <code>5503</code> in my case and <code>history | wc -l</code> - <code>5325</code>. It&rsquo;s pretty bad difference. That means they are not correlated too well. Why is that?
I&rsquo;ve redirected the output to a csv file and imported into Excel (for both <code>history</code> and <code>zsh_history</code>). The first thing that caught the eye was the amount of blank lines for the latter. The second - some commands were split into several lines for <code>zsh_history</code>. While the blank lines could be eliminated with <code>cat ~/.zsh_history| sed '/^$/d' | wc -l</code>, the second problem is trickier. But do I need to cope with it? What do I need from this file? Timestamp. So, it&rsquo;s easier to run and log <code>date</code> before or after each command instead. I will only be referring to the <code>history</code> output then.</p>
</blockquote>
<p>Now, to the log file itself.  Since I will be integrating it to Elastic (Custom Logging), I&rsquo;d better make it a JSON (ndjson) format. Below is the beginning of my <code>~/.zshrc</code> file (other contents is irrelevant for this matter).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;timestamp&#34;</span><span class="p">:</span> <span class="err">$(date)</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;real_username&#34;</span><span class="p">:</span> <span class="s2">&#34;$(id -p | head -n1 | cut -f2)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;effective_username&#34;</span><span class="p">:</span> <span class="s2">&#34;$(whoami)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;pid&#34;</span><span class="p">:</span> <span class="err">$$</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;commandid&#34;</span><span class="p">:</span> <span class="s2">&#34;$(history | tail -n 1 | cut -d&#34;</span> <span class="s2">&#34; -f2),
</span></span></span><span class="line"><span class="cl"><span class="s2">  &#34;</span><span class="err">command</span><span class="s2">&#34;: &#39;$(history | tail -n 1 | xargs | cut -d&#34;</span> <span class="err">&#34;</span> <span class="err">-f</span><span class="mi">2</span><span class="err">-)&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Now, to the effective vs real user. You can read more <a href="https://stackoverflow.com/questions/32455684/difference-between-real-user-id-effective-user-id-and-saved-user-id#:~:text=So%2C%20the%20real%20user%20id,%2C%20there%20are%20some%20exceptions">here</a>. In short, when ordinary user issues commands, both are the same, but whenever the privileges are elevated (for example, with <code>sudo su</code>) or a command is issued from behalf of another user (like <code>sudo -l username</code>) these two are going to be different. This allows us to log the responsible user. Effective user is the one, who the system thinks it is. Someone, whose rights and privileges (if any) the currently logged user is using. Real user is pretty self-explanatory, the logged in user, the one who&rsquo;s been doing staff.
The next problem to solve, is to</p>
<p>There are different shell interpreters. In order to find the appropriate history file, you&rsquo;ll need to know which one is used on the machine. Run env command and look at the following variables:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">SHELL</span><span class="o">=</span>/bin/zsh
</span></span><span class="line"><span class="cl"><span class="nv">ZSH</span><span class="o">=</span>/Users/username/.oh-my-zsh
</span></span><span class="line"><span class="cl"><span class="nv">PYENV_SHELL</span><span class="o">=</span>zsh
</span></span></code></pre></div><h3 id="bash-history">Bash History</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/Users/%username%/.bash_sessions
</span></span><span class="line"><span class="cl">/Users/%username%/.bash_history
</span></span></code></pre></div><h3 id="zsh">zsh</h3>
<h2 id="linux">Linux</h2>
<table>
<thead>
<tr>
<th>Shell</th>
<th>Characteristics</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sh</code></td>
<td>first linux shell. Nowadays, rarely used and usually points to bash.</td>
</tr>
<tr>
<td><code>bash</code></td>
<td>Born Again Shell. Most common. Also used on MacOS. Based on <code>sh</code>.</td>
</tr>
<tr>
<td><code>csh</code></td>
<td>C shell. Not used much.</td>
</tr>
<tr>
<td><code>tcsh</code></td>
<td>Based on <code>csh</code>. Used sometimes but not set as default for main Linux distributions.</td>
</tr>
<tr>
<td><code>ksh</code></td>
<td>Korn shell. Combines best features of <code>bash</code> and <code>csh</code> and extends them. Not many people use it.</td>
</tr>
<tr>
<td><code>zsh</code></td>
<td>Also used on MacOS. Adds more features. Built on <code>ksh</code>.</td>
</tr>
</tbody>
</table>
<p>history typically displays the last 500 commands. <code>history -c</code> - clear the history.</p>
<h3 id="shell">Shell</h3>
<h3 id="bash">Bash</h3>
<p><code>/home/%username%/.bash_history</code></p>
<p>On most Linux machines bash is the default shell interpereter. Each user has a separate bash history. However, if the user has escalated to root, everything goes to the root&rsquo;s history file (<code>~/.bash_history</code>). ‚ùóÔ∏è Not only root&rsquo;s history is interesting!</p>
<blockquote>
<p>üìù Set history time env variable to record timestamps for the <code>q</code> file.</p>
</blockquote>
<p>It&rsquo;s not always easy to determine if this activity is a legitimate admin activity or if it&rsquo;s something adversary (given that they have managed to escalate).</p>
<blockquote>
<p>‚ö†Ô∏è Bash hostory can be tampered with or turned of.</p>
</blockquote>
<blockquote>
<p>By default, the bash_history is stored in memory when you&rsquo;re running commands on a system. This means that nothing is actually written to disk until you run the &ldquo;exit&rdquo; command and exit the shell. [<a href="https://www.linkedin.com/pulse/incident-response-case-study-linux-cryptominer-debacle-ronald-craft/?trackingId=iWqzrUB1zPSuO50joDGSHQ%3D%3D">1</a>]</p>
</blockquote>
<p><code>kill -9 $$</code> to kill the bash shell. This way whatever was in memory for bash_history won&rsquo;t be written to disk.</p>
<p>If you simply delete <code>bash_history</code> one can recover it using photorec or other carving utility, for example (unless the sectors for this files were overwritten).</p>
<h4 id="lateral-movement">Lateral movement</h4>
<p><code>ssh</code>, <code>netcat</code> and <code>telnet</code> are frequently used for lateral movement. ssh and telnet will give a target IP as well. Agregate and make a frequency analysis. Note all the IPs that the system has connected to.</p>
<blockquote>
<p>üí° I would also check with the baseline (which machines this machine usually connects to).</p>
</blockquote>
<h4 id="malicious-modifications">Malicious modifications</h4>
<p><code>vim</code>, <code>nano</code>. Which files were changed? something in <code>/etc/</code>. Look for archiving activity: <code>tar</code>, <code>7zip</code> etc. What&rsquo;s archived and why?</p>
<h4 id="recon">Recon</h4>
<p><code>whoami</code>, <code>cat</code>, <code>ifconfig</code> etc. Amount of these commands. Short span. First is usually to run whoami, then might be something else.</p>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    Something here
</details>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
