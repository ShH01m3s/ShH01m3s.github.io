<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Web Application basics - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting 🪤">
      <a href="/docs/thunting">
        <span>Threat Hunting 🪤</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting 🪤">
      <a href="/docs/thunting">
        <span>Threat Hunting 🪤</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/reference/network/"> 👈🏼 Back to </br> 📚 Network </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#sop-vs-cors">SOP vs CORS</a>
      <ul>
        <li><a href="#sop">SOP</a></li>
        <li><a href="#relax-sop">Relax, SOP&hellip;</a></li>
        <li><a href="#cors">CORS</a></li>
      </ul>
    </li>
    <li><a href="#hsts">HSTS</a></li>
    <li><a href="#certificate-transparency-ct">Certificate Transparency (CT)</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Web Application basics</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p><em>This is about &hellip; .</em></p>
<h2 id="sop-vs-cors">SOP vs CORS</h2>
<p><img src="images/anakin-vs-obivan.jpg" alt="img"></p>
<h3 id="sop">SOP</h3>
<p>Basically, SOP says &ldquo;You can&rsquo;t manipulate resources belonging to other websites, you must remain here at all times. Play with your toys only&rdquo;. It is some sort of a sandbox.</p>
<p>Let&rsquo;s have a look at an example. Let&rsquo;s take two websites: <code>bakerst221b.com</code> and <code>richmond65a.com</code>. The javascript on <code>bakerst221b.com</code> wants to have access to something on <code>richmond65a.com</code>. What does it have access to and what does it not have access to?</p>
<ol>
<li><strong>Cookies</strong> 🍪 -&gt; NO!!! Cookies are like temp keys. While temporary, these are still keys which can be used to open doors. Once the door is open, all sorts of nasty stuff can happen and we don&rsquo;t want that. That&rsquo;s the whole point why SOP was created in the first place. ❗️For the usability purposes, cookies can be accessed by other subdomains although it might pose some risks. In order to partially mitigate it, use <code>HttpOnly</code> flag when creating a cookie.</li>
<li><strong>Videos</strong> 🎥.</li>
<li><strong>Pictures</strong> 🌇.</li>
<li><strong>Another script</strong> 📝.</li>
</ol>
<p><img src="images/sop1.png" alt="img"></p>
<p>Ok. The website <a href="https://bakerst221b.com">https://bakerst221b.com</a> can have videos, pictires and sctipts from the richmond website loaded on its page.</p>
<p><img src="images/sop2.png" alt="img"></p>
<p>But what&rsquo;s interesting, it still can&rsquo;t ACCESS them.</p>
<p><img src="images/sop3.png" alt="img"></p>
<h3 id="relax-sop">Relax, SOP&hellip;</h3>
<ol>
<li>Cookies can be accessed by subdomains (unless <code>HttpOnly</code> is set)</li>
<li><code>document.domain</code> is set to the same domain to show the browser it&rsquo;s ok, but only if both are parts of the same FQDN.</li>
<li>CORS.</li>
</ol>
<h3 id="cors">CORS</h3>
<p>What fun would it be if the rules didn&rsquo;t have some exceptions? CORS is basically as way to circumvent overly strict SOP and allow something to be accessed cross-origin.</p>
<p>When seeing some cross-origin request, user&rsquo;s browser first sends a preflight request to check if it&rsquo;s allowed to do so. And here is the biggest trick. There are simple and &ldquo;complex&rdquo; requests. When something happens WITHOUT javascript (html only), the requests generated are ALWAYS simple. That means that without javascript code one CAN&rsquo;T make a non-simple request. What do I call non-simple? Let&rsquo;s start with what&rsquo;s simple first.</p>
<ol>
<li><strong>Methods</strong>: <code>GET</code>, <code>HEAD</code> and <code>POST</code></li>
<li><strong>Headers</strong>: no custom headers (including those starting with <code>X-</code>)</li>
<li><strong>Content type</strong>: <code>application/x-www-form-urlencoded</code>, <code>multipart/form-data</code>, or <code>text/plain</code>.</li>
</ol>
<p>Note that ALL of the requierements above need to be satisfied. Non-simple are basically everything <strong>else</strong>. The reason why simple requests do not require a preflights is because they relatively safe. Since you can&rsquo;t set headers, change content-type or use other methods from plain html, and the request is constructed automatically by the browser, it&rsquo;s relatively safe. You might ask if cookies are sent this way.</p>
<p>The most important header is <code>Access-Control-Allow-Origin</code>, it says which origins can make the cross-origin requests. Another header to be mindful is <code>Access-Control-Allow-Credentials</code>, when set to <code>true</code>.</p>
<p>Here is an example of the request:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">OPTIONS /api/resource HTTP/1.1
</span></span><span class="line"><span class="cl">Host: example-server.com
</span></span><span class="line"><span class="cl">Origin: https://example-client.com
</span></span><span class="line"><span class="cl">Access-Control-Request-Method: PUT
</span></span><span class="line"><span class="cl">Access-Control-Request-Headers: X-Auth-Token
</span></span></code></pre></div><p>In the response, the server will tell the broser what&rsquo;s allowed and what&rsquo;s not:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">HTTP/1.1 <span class="m">200</span> OK
</span></span><span class="line"><span class="cl">Access-Control-Allow-Origin: https://example-client.com
</span></span><span class="line"><span class="cl">Access-Control-Allow-Methods: PUT, POST, GET, OPTIONS
</span></span><span class="line"><span class="cl">Access-Control-Allow-Headers: X-Auth-Token
</span></span><span class="line"><span class="cl">Access-Control-Max-Age: <span class="m">86400</span>
</span></span></code></pre></div><p>Say, I have a website <code>bakerst22b_evil.com</code>. On my website there is a link to richmond64.com. When the user clicks the link, it doesn&rsquo;t initiate CORS. However, this is a cross origin request. If <code>richmond64.com</code> has a CSRF there, it might be exploited. CORS won&rsquo;t protect from that.</p>
<p>Another scenario. On my website <code>bakerst22b_evil.com</code> there is a javascript code that want&rsquo;s to access a <code>richmond64.com</code> cookie 🍪. It won&rsquo;t be able to because the user&rsquo;s browser won&rsquo;t allow it. The only way that <code>bakerst22b_evil.com</code> could access it, is if <code>richmond64.com</code> set its CORS header to the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Access-Control-Allow-Origin: * <span class="c1"># or</span>
</span></span><span class="line"><span class="cl">Access-Control-Allow-Origin: bakerst22b_evil.com <span class="c1"># or</span>
</span></span><span class="line"><span class="cl">Access-Control-Allow-Credentials: <span class="nb">true</span>
</span></span></code></pre></div><p>Suppose we have a page on <a href="https://bakerst221b_evil.com">https://bakerst221b_evil.com</a>, and there is a link like <a href="https://richmond.com/admin/add?name=evil&amp;password=master">https://richmond.com/admin/add?name=evil&amp;password=master</a> (richmond.com is vulnerable to CSRF). What happens is that the browser will open this page with the credentials belonging to Richmond, and if there is a valid session, the action above will be executed.</p>
<p>How does a CSRF token protect against CSRF? Remember that a request is considered simple only when all conditions are met (GET/POST/HEAD and no custom headers and content type is a form or text). But what is a CSRF token? It&rsquo;s a random value passed in a custom header (something like X-CSRF-token). Now, if the server requires this custom header to be present, one cannot use just HTML to craft a request. Clicking on a link like <a href="https://richmond.com/admin/add?name=evil&amp;password=master">https://richmond.com/admin/add?name=evil&amp;password=master</a> will not result in a request with a custom header since it&rsquo;s CUSTOM, and the browser only sends what is NOT custom, but rather what&rsquo;s usual. Now, the attacking script on <a href="https://bakerst221b_evil.com">https://bakerst221b_evil.com</a> would have to embed JavaScript to add a custom header, something like the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;https://richmond64.com/api/data&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Add a custom header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;X-Custom-Header&#39;</span><span class="p">,</span> <span class="s1">&#39;my-custom-value&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">responseData</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">responseData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
</span></span></code></pre></div><p>But that poses two problems:</p>
<ol>
<li>How does it &ldquo;guess&rdquo; the value of the token? The attacker can hope that there is some vulnerability in the token generation or validation.</li>
<li>Once the custom header is sent, the request ceases to be a simple one and preflight is sent first. And if there are no misconfigurations associated with the CORS policy, or no CORS policy is set up at all, the request will NOT be sent.</li>
</ol>
<blockquote>
<p>❗️ Of course, there are other mechanisms that need to be leveraged to protect from CSRF, since CORS is not a CSRF mitigation!</p>
</blockquote>
<h2 id="hsts">HSTS</h2>
<p><code>Strict-Transport-Security</code> header is sent forcing the browser only use HTTPS and preventing any requests coming via HTTP.</p>
<h2 id="certificate-transparency-ct">Certificate Transparency (CT)</h2>
<p>CA issues certificates and maintains a log with all the certificates issued. This log is available online and helps:</p>
<ol>
<li>Detect misissued certificates, which may be a result of CA compromise or misconfiguration.</li>
<li>Identify rogue CAs that are issuing certificates without proper authorization.</li>
<li>Increase the overall trust in the SSL/TLS ecosystem by providing transparency and accountability.</li>
</ol>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    <h3 id="portswigger-sop-article">Portswigger SOP article</h3>
<p><a href="https://portswigger.net/web-security/cors/same-origin-policy">https://portswigger.net/web-security/cors/same-origin-policy</a></p>
<h3 id="portswigger-cors-article">Portswigger CORS article</h3>
<p><a href="https://portswigger.net/web-security/cors">https://portswigger.net/web-security/cors</a></p>

</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
