<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ“š TCP - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ğŸª¤">
      <a href="/docs/thunting">
        <span>Threat Hunting ğŸª¤</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference ğŸ“š">
      <a href="/docs/reference">
        <span>Tech Reference ğŸ“š</span>
      </a>
    </li>
    
    <li class="menu-item-notes ğŸ“">
      <a href="/docs/notes">
        <span>Notes ğŸ“</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ğŸª¤">
      <a href="/docs/thunting">
        <span>Threat Hunting ğŸª¤</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference ğŸ“š">
      <a href="/docs/reference">
        <span>Tech Reference ğŸ“š</span>
      </a>
    </li>
    
    <li class="menu-item-notes ğŸ“">
      <a href="/docs/notes">
        <span>Notes ğŸ“</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/reference/network/protocols/transport/"> ğŸ‘ˆğŸ¼ Back to </br> ğŸ“š Transport Layer Protocols </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#segment-structure">Segment structure</a>
      <ul>
        <li><a href="#intro">Intro</a></li>
        <li><a href="#source-port">Source Port</a></li>
        <li><a href="#destination-port">Destination Port</a></li>
        <li><a href="#sequence-number">Sequence number</a></li>
        <li><a href="#acknowledgement-number">Acknowledgement number</a></li>
        <li><a href="#data-offset-aka-header-length">Data Offset aka Header Length</a></li>
        <li><a href="#reserved--flags">Reserved + Flags</a></li>
        <li><a href="#window-size">Window Size</a></li>
        <li><a href="#checksum">Checksum</a></li>
        <li><a href="#urgent-pointer">Urgent Pointer</a></li>
      </ul>
    </li>
    <li><a href="#tcp-handshake">TCP handshake</a></li>
    <li><a href="#exchanging--data">Exchanging  data</a></li>
    <li><a href="#four-way-handshake">Four-way Handshake</a></li>
    <li><a href="#attacks">Attacks</a>
      <ul>
        <li><a href="#tcp-session-hijacking">TCP session hijacking</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">ğŸ“š TCP</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
                <i class="fas fa-archive"></i>
              
          <a class="category-link" href="/domain/general">general</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
                <i class="fas fa-microscope"></i>
              
          <a class="platform-link" href="/doctype/research">research</a>
          
      </div> <br /><br/>
      
      
      
      

      
      <div class="article-category">
        <i class="fas fa-tools"></i>
          
          <a class="platform-link" href="/tools/wireshark">wireshark</a>
          
      </div> <br />
      
      

      
      <div class="article-tag">
          <i class="fas fa-tag"></i>
          
          
          <a class="tag-link" href="/tags/network" rel="tag">network</a>
          
           ,  
          <a class="tag-link" href="/tags/protocol" rel="tag">protocol</a>
          
           ,  
          <a class="tag-link" href="/tags/transport" rel="tag">transport</a>
          
      </div> 
      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p><em>This article collects the basics of TCP protocol. Its friend UDP (transport layer protocol as well) is faster but less reliable.</em></p>
<h2 id="segment-structure">Segment structure</h2>
<p><img src="images/1.png" alt="img"></p>
<h3 id="intro">Intro</h3>
<p>The desired prerequisite for this article is <a href="/docs/articles/fundamentals/network/osi/overview">this</a>. It&rsquo;s also recommended to read about <strong>data structures</strong>.  A very good book that I&rsquo;ve accidenatlly stumbled upon is Brian Carrier&rsquo;s <em>File System Forensic Analysis</em> [<a href="#references">3</a>]. I also strongly believe, that the best way to learn is to activate different parts of the brain. Simple reading is not enough, that&rsquo;s why I&rsquo;m trying to mix in pictures and emoji. Also, metaphors help and analogies which I also try to provide. But it would really help, if you installed some packet capture program (<a href="https://www.wireshark.org/download.html">Wireshark</a> is an example), opened some network interface and observed the stuff I&rsquo;m talking about yourself.</p>
<p>Off we go âœˆï¸.</p>
<p>This part is probably the easiest one to explain. One PC ğŸ’» can communicate with many other PCs simultaneously. To be precise, different applications on a same PC can communicate with their servers or other PCs at the same time. For example, a user is running <em>Facebook</em> app ğŸŒ… and some application for work, for example, <em>Excel</em>, at the same time (ğŸ˜¬ oops). <em>Facebook</em> is reading feed from the server, while <em>Excel</em> is synching with the Cloud ğŸŒ©.</p>
<p><em>How does the NIC (network card of the PC) distinguish between the packets?</em></p>
<p>The answer is simple serial numbers aka <strong>port number</strong>. PC assigns <em>Excel</em> port #1 and <em>Facebook</em> to port #2.</p>
<p>A few minutes have passed&hellip; â²ï¸</p>
<p>Both applications receive a response ğŸ“¨ .</p>
<p><em>But how to tell, which one goes to which application?</em></p>
<p>The first message has <em>port #1</em> written on the envelope âœ‰, and the second - <em>port #2</em>. So, when an application sends a request, it is asssigned a port. Roughly speaking, a port number identifies an application that is using the network ğŸ•¸ï¸.</p>
<p>Some applications have their <em>&ldquo;favourite&rdquo;</em> ports, which are usually assigned to them (like, ssh is usually at <code>22</code>, and ftp <code>21</code>, and web <code>80</code> or <code>8080</code>). Even some malware ğŸ•·ï¸ applications have prerferences. But whatever the preferences are, a user can usually change them.</p>
<p>We are arriving ğŸš‹ and I hope you&rsquo;ve read about <strong>data structures</strong>, but in case you have not or in case this knowledge has not yet settled&hellip; In a word, computers only see an almost endless sequence of <code>1</code>s and <code>0</code>s. A data structure difines how a PC interprets this or that sequence of <code>1</code>s or <code>0</code>s. If you tell a computer ğŸ’» PC that <code>01000001</code> is an integer, it will show you <code>0x41</code> in hex editor.  If you tell a computer that <code>01000001</code> is an ASCII letter, it will output <code>A</code>. If you, for example, tell a computer that these are <a href="#flags">TCP flags</a>, it will interpret them as <code>ECN-Echo</code> and <code>FIN</code> flags ğŸ set and etc (I hope you get the point). So, TCP header is just another data structure that tells a PC how it should interpret and use these particular sequence of bits (<code>1</code>s or <code>0</code>s).</p>
<p>Now, about TCP header. TCP is just one of the headers that you message âœ‰ sent over the network ğŸ•¸ï¸ has to provide in order to be delievered. You can read about this in my article <a href="/docs/articles/fundamentals/network/osi/overview">here</a>. Its main purpose (as pointed out above) is to specify the port (i.e. application or process) that this message should be delievered to. All other things it provides are secondary. For example, it can so, to say, ensure data integrity. I&rsquo;ve marked TCP header on the screenshot below with purple curly brackets. The upper curly bracket shows the TCP header after being enterpreted by Wireshark and the below one (highlighted in blue as well) - raw bytes (before being interpreted by Wireshark): <code>ea a3 01 bb 69 10 a9 e2 a0 71 33 51 50 10 0f ed 1e b9 00 00</code>. Yes, that&rsquo;s it, 20 bytes is the length of a TCP header (if an optional field <em>Options</em> is not filled out). And these 20 bytes tell so much!</p>
<p><img src="images/11.jpg" alt="img"></p>
<h3 id="source-port">Source Port</h3>
<p>The first two bytes are <code>eaa3</code>. These bytes are to be interpreted as a decimal value (<code>60067</code>) and stand for the source port. You can use a converter online (for example, <a href="https://www.rapidtables.com/convert/number/hex-to-decimal.html">here</a>).  Now check the <em>Source port:</em> field value (bytes as they were interpreted by Wireshark) on the screenshot below - <code>60067</code> as well! Amazing ğŸ¤©!</p>
<p><img src="images/2.jpg" alt="img"></p>
<p>Note, that on the lower part of the window there are some weird-looking letters <code>t</code>, <code>q3QP</code> etc. They don&rsquo;t make sense, do they? Well, they should not, at least. If they do, having a good rest is strongly suggested ğŸ¥. Wireshark attempts to interpret these bytes as ASCII characters aka text (remember abut data structures above? This is a good example when the wrong one is used). Since this is a TCP header and <strong>not</strong> text, the result is total garbage. <em>You might ask why Wireshark is doing that?</em> Well, the reason is probably because on other layers this functionality is handy and it was tedious to turn it off for this field. Besides, who knows, may there is some covert channel here&hellip; . But I&rsquo;m getting off the topic.</p>
<h3 id="destination-port">Destination Port</h3>
<p>Now, let&rsquo;s take the next 2 bytes: <code>01bb</code>. Let&rsquo;s use the same hex-to-decimal converter <a href="https://www.rapidtables.com/convert/number/hex-to-decimal.html">here</a> to figure out the decimal value - <code>443</code>. Check against the Wireshark&rsquo;s interpretation below (value highlighted in yellow):</p>
<p><img src="images/3.jpg" alt="img"></p>
<p>Bingo ğŸ‰ ! Remeber me writing about favourite port numbers? Well, <code>443</code> is an indisputable darling of <code>SSL/TLS</code> (secure version of HTTP used to browse websites). You can read more about it <a href="/docs/articles/fundamentals/network/osi/application/protocols/ssl-tls">here</a>.</p>
<h3 id="sequence-number">Sequence number</h3>
<p>The next four bytes are a bit harder to explain, but I will try ğŸ˜Š. As the paragraph&rsquo;s title states, we are going to talk about <em>sequence numbers</em>.  Since TCP was developed in order to ensure that no data is lost in transit, there must be a way to track parcels ğŸ“¦. What can be easier than put a number on each package ğŸ“¦?</p>
<p>For example, Marge needs to send 10 packages to Homer. She numbers all packages from 1 to 10.</p>
<p><img src="images/marge.png" alt="img"></p>
<p>Now, let&rsquo;s assume the following option. Marge sends them in turn: <code>1</code> ğŸ“¦-&gt; <code>2</code> ğŸ“¦-&gt; <code>3</code> ğŸ“¦-&gt; <code>4</code>ğŸ“¦ -&gt; <code>5</code>  ğŸ“¦-&gt; <code>6</code> ğŸ“¦-&gt; <code>7</code> ğŸ“¦-&gt; <code>8</code> ğŸ“¦-&gt; <code>9</code> ğŸ“¦-<code>10</code>ğŸ“¦. <em>What happens if Homer receives them like this: <code>1</code> ğŸ“¦-&gt; <code>2</code> ğŸ“¦-&gt; <code>3</code> ğŸ“¦-&gt; <code>4</code>ğŸ“¦ -&gt; <code>6</code> ğŸ“¦-&gt; <code>7</code> ğŸ“¦-&gt; <code>8</code> ğŸ“¦-&gt; <code>9</code> ğŸ“¦-<code>10</code>ğŸ“¦</em> Well, Homer detects (hopefully ğŸ™ ) that the fifth packages ğŸ“¦ is missing and asks to resend it.</p>
<p><img src="images/homer.png" alt="img"></p>
<p>Everything is fine, until for some reason, packets come in the wrong order. Homer will have to wait until Marge stops talking and then check that there are no &ldquo;gaps&rdquo;. That&rsquo;s time-costy, it would be much better to be able to detect missing packages before the connection is closed. But that not the only problem.</p>
<p>Imagine, Homer receives these packages in the right order: <code>1</code> ğŸ“¦-&gt; <code>2</code> ğŸ“¦-&gt; <code>3</code> ğŸ“¦-&gt; <code>4</code>ğŸ“¦ -&gt; <code>5</code>  ğŸ“¦-&gt; <code>6</code> ğŸ“¦-&gt; <code>7</code> ğŸ“¦-&gt; <code>8</code> ğŸ“¦-&gt; <code>9</code> ğŸ“¦ . He didn&rsquo;t know that there were supposed to be 10 packages in total. He might notice the mistake if he then opens them all and finds something in the wrong state.</p>
<p>The best solution to track packages ğŸ“¦ and to detect errors ğŸ›‘ right away is for Marge to send a package along with the number of the next package. For example,  <code>1</code> ğŸ“¦ (the next is <code>2</code>)-&gt; <code>2</code> ğŸ“¦ (the next is <code>3</code>)-&gt; <code>3</code> ğŸ“¦ (the next is <code>4</code>)-&gt; <code>4</code>ğŸ“¦ (the next is <code>5</code>) -&gt; <code>5</code>  ğŸ“¦ (the next is <code>6</code>)-&gt; <code>6</code> ğŸ“¦ (the next is <code>7</code>)-&gt; <code>7</code> ğŸ“¦(the next is <code>8</code>)-&gt; <code>8</code> ğŸ“¦ (the next is <code>9</code>)-&gt; <code>9</code> ğŸ“¦ (the next is <code>10</code>)-<code>10</code>ğŸ“¦ (it&rsquo;s the last).</p>
<p>The problem with this scheme is that these numbers are predictable and someone malicious might interfere and substitue a legitimate package ğŸ“¦ with his/her package ğŸ•·ï¸ğŸ“¦. Consider this scenario:</p>
<p><img src="images/14.png" alt="img"></p>
<ol>
<li>A pervert puppy ğŸ•  (don&rsquo;t judge the puppy) wants to get a picture of naked dogs from the server (arrow #1) and after establishing the connection, the server sends the first picture to the puppy with a sequence number 1.</li>
<li>A genius hacker has been listening and now knows that the next sequence number is <code>2</code>.</li>
<li>To prevent the server from sending the second picture, he keeps it busy with requests and meanwhile sends a picture with number <code>2</code> on it to the pervert puppy ğŸ• . And on this picture, oh horror! Let&rsquo;s not tell. Now puppy will wait until his 18-21 year to look at the naked ladies.</li>
</ol>
<p><img src="images/15.png" alt="img"></p>
<p>When the servere is finally free and ready, it, of course, might send the pictire <code>2</code> (the one originally requested by the puppy), but since the puppy has already received picture #2, he&rsquo;ll ignore it.</p>
<p>That&rsquo;s why these sequence numbers are supposed to be unpredictable or at least very hard to predict. On Windows machines they were just incremented by one after the first sequence number was generated for the connection. That&rsquo;s why the attacker only had to intercept one request to calculate the next sequence number.</p>
<p>See the screenshot below for an example from the wild ğŸ… :</p>
<p><img src="images/4.jpg" alt="img"></p>
<p>So, to summarize, sequence numbers are like tracking number used by postal services. It tells what is the next package&rsquo;s number is supposed to be. That helps both parties to synchronize with each other.</p>
<h3 id="acknowledgement-number">Acknowledgement number</h3>
<p>An acknowledgment number simply shows, what is the sequence number of the next segment that is expected by the receiver. It&rsquo;s like saying: <em>I have received your segment #1 and I know that since the numbers increment by one, the next is supposed to be #2. I&rsquo;m incredibly smart&hellip;. ğŸ¤“.</em></p>
<p><img src="images/5.jpg" alt="img"></p>
<h3 id="data-offset-aka-header-length">Data Offset aka Header Length</h3>
<p>If no Options at the end of the header are specified, its length is always <strong>20 bytes</strong>. The value specified in this case (5) needs to be multiplied by 32 and divided by 8 to have bytes. The formula is: <code>x * 32 / 8</code>.</p>
<h3 id="reserved--flags">Reserved + Flags</h3>
<p>There were 9 flags there. Each flag can be either <code>1</code> or <code>0</code> thus occupying precisely 1 bit. For 9 flags we need exactly 9 bits. Probably, just in case, this field is extented to 12, that&rsquo;s why the first 3 bits are marked as reserved. May be, it looked weired to allocate 9 (uneven number) of bits to this. Who knows, as they say, who knows.</p>
<p><img src="images/6.jpg" alt="img"></p>
<p>Below is the list of possible flags and what they are for (if I understood it correctly myself ğŸ˜).</p>
<p><code>SYN</code></p>
<p>Wireshark filter to see all segments that have this flag set: <code>tcp.flags.syn==1</code>. To see packets that both have <code>SYN</code> and <code>ACK</code> (TCP handshake, last step): <code>tcp.flags.syn==1 &amp;&amp; tcp.flags.ack==1 &amp;&amp; tcp.len==0</code>.</p>
<p><code>ACK</code></p>
<p>Wireshark filter to see all segments that have this flag set: <code>tcp.flags.ack==1</code>.</p>
<p><code>PUSH</code></p>
<p>Wireshark filter to see all segments that have this flag set: <code>tcp.flags.push==1</code>.</p>
<p><img src="images/push-f.png" alt="img"></p>
<p><code>URG</code></p>
<p>Wireshark filter to see all segments that have this flag set: <code>tcp.flags.urg==1</code>. This flag is not too frequent to encounter. I only managed to capture it when I crafted it myself with python <code>scapy</code> module from terminal:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ip</span> <span class="o">=</span> <span class="n">IP</span><span class="p">(</span><span class="n">ttl</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="s1">&#39;192.168.1.1&#39;</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="s1">&#39;192.168.1.2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tcp</span> <span class="o">=</span> <span class="n">TCP</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="s1">&#39;U&#39;</span><span class="p">,</span><span class="n">dport</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sport</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">send</span><span class="p">(</span><span class="n">ip</span><span class="o">/</span><span class="n">tcp</span><span class="p">)</span>
</span></span></code></pre></div><p>Or using a script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">scapy.all</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">send</span><span class="p">(</span><span class="n">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="s2">&#34;192.168.1.1&#34;</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="s2">&#34;192.168.1.1&#34;</span><span class="p">)</span><span class="o">/</span><span class="n">TCP</span><span class="p">(</span><span class="n">dport</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sport</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">ack</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="s1">&#39;U&#39;</span><span class="p">))</span>
</span></span></code></pre></div><p>In the artile [<a href="#references">17</a>] the author states that he mamanged to observe these segments when using telnet. Also, it&rsquo;s stated that this mechanism is deprecated in RFC 6093 (but I have not confirmed this statement).</p>
<p><img src="images/ur-f.png" alt="img"></p>
<p><code>RST</code></p>
<p>Wireshark filter to see all segments that have this flag set: <code>tcp.flags.rst==1</code>.</p>
<p><code>FIN</code></p>
<p>Wireshark filter to see all segments that have this flag set: <code>tcp.flags.fin==1</code>.</p>
<h3 id="window-size">Window Size</h3>
<p>Let&rsquo;s imagine that Marge wants to send a <code>24Kb</code> picture ğŸ–¼ to Homer. She sends this whole picture over the wire. It takes some time to be fully delievered and in the end Homer calculates the checksum. But the cheksum he has calculated and the one, put in the TCP header by Marge, are different! O-la-la! Marge resends this picture, but it still gets corrupted ğŸ˜.</p>
<p>The above process is time and bandwidth consuming and that just won&rsquo;t do! How many time does Marge have to resend a <code>24Kb</code> picture before it gets safely to the other end?! And what if it were a video over <code>1Gb</code> large?</p>
<p>Marge is smart and dicides to divide this picture into 3 parts ğŸ•, each <code>8Kb</code>  in size. Homer <code>ACK</code>s to the first 2 but doesn&rsquo;t <code>ACK</code> to the last one. Marge now knows that the problem is the last <code>8Kb</code> and resends them. Homer doesn&rsquo;t <code>ACK</code> (what the heck is he doing?). Marge then divides these <code>8Kb</code> into 16 smaller pieces ğŸ•, each piece is now <code>512</code> bytes. Homer <code>ACK</code>s to all of them except the 12th. Marge knows, that the 12th <code>512bytes</code> of the picture&rsquo;s last fragment is the problem and resends only this part. Homer <code>ACK</code>s and everyone is happy ğŸŠ.</p>
<p>So, Marge has cut down the size of the segment to resend from <code>24Kb</code> to <code>512</code> bytes, which is much better since we don&rsquo;t occupy so much bandwidth for this single operation and it was easier to locate the problem segment. The smaller the piece ğŸ• is, the smaller the segment to resend is and the quicker the corrupted data can be restored.</p>
<p>But we cannot cut it down to 1 byte for each segment, that would also not help in speeding up the process, since our headers occupy <code>40bytes</code> at least and that would mean <code>1/41</code> only is for data&hellip; . That&rsquo;s why IETF (<strong>I</strong>nternet <strong>E</strong>ngineering <strong>T</strong>ask <strong>F</strong>orce) has wisely calculated the recommended size for such a unit.</p>
<p><strong>M</strong>aximum <strong>S</strong>egment <strong>S</strong>ize is the maximum&hellip;. well&hellip; segment size ğŸ˜Š. That&rsquo;s exactly what we were just talking about. A unit of information for TCP protocol is a <em>segment</em>, as you might recall. That includes the TCP header + the actual data. According to RFC [<a href="#references">6</a>], if the client doesn&rsquo;t tell how much it can digest at a time, the default value is <code>536</code> bytes (minimum packet size <code>576</code> minux <code>20</code> bytes for IP header and minus <code>20</code> bytes for TCP header). So, <code>536</code> bytes of actual <strong>data</strong> (for example, a picture, or a webpage).</p>
<p>But we have to take two things into account.</p>
<p><strong>Firstly</strong>, we have to acknowledge every portion ğŸ•. What if there were 19 segments sent? The client would have to send 19 <code>ACK</code>s in return. So much waste of bandwidth&hellip; .</p>
<p><strong>Secondly</strong>, when a segment is received, it&rsquo;s not processed right away, it&rsquo;s waiting its turn in the TCP outgoing buffer ğŸ“¨ (of the sender) and then in the TCP incoming buffer ğŸ“¨ (of the receiver). This buffer also cannot be stuffed infinitely with data.</p>
<p><img src="images/homer-eating.png" alt="img"></p>
<p>That&rsquo;s where windows size comes into play. Look at the screenshot below:</p>
<p><img src="images/9.jpg" alt="img"></p>
<p>I&rsquo;ve marked window size with blue - <code>65535</code> bytes it&rsquo;s the maximum value. Why? This field is only two bytes long and that&rsquo;s why the biggest possible number is <code>0xFFFF</code>  which is <code>65535</code> in decimal. Homer specifies the window size, Marge sends this amount of data and only after data within this window size was received, Homer will <code>ACK</code>.</p>
<p>If there were no window size value, this is how it would look like:</p>
<ol>
<li>Homer ğŸŒ¯ &lt;- seg #1 Marge ğŸ‘©â€ğŸ³</li>
<li>Homer ğŸŒ¯-&gt; <code>ACK num</code> 2 Marge ğŸ‘©â€ğŸ³*(&ldquo;Marge, I&rsquo;ve received segment #1 give me the 2nd&rdquo;)*</li>
<li>Homer ğŸŒ¯&lt;- seg #2 server Marge ğŸ‘©â€ğŸ³</li>
<li>Homer ğŸŒ¯-&gt; <code>ACK num</code> 3 Marge ğŸ‘©â€ğŸ³*(&ldquo;Marge, I&rsquo;ve received segment #2 give me the 3rd&rdquo;)*</li>
</ol>
<p>And this is how it looks like <strong>with</strong> Window size (if Window size holds up to two segments):</p>
<ol>
<li>Homer ğŸŒ¯ &lt;- seg #1 Marge ğŸ‘©â€ğŸ³</li>
<li>Homer ğŸŒ¯&lt;- seg #2 server Marge ğŸ‘©â€ğŸ³</li>
<li>Homer ğŸŒ¯-&gt; <code>ACK num</code> 3 Marge ğŸ‘©â€ğŸ³ <em>(&ldquo;Marge, I&rsquo;ve received segments #1 and #2, give me the 3rd&rdquo;)</em></li>
</ol>
<p>But the technologies don&rsquo;t stay still, we have larger files and we have quicker PCs, so <code>64Kb</code> was not enough over time. That&rsquo;s why TCP Options field was introduced with its <code>Maximum segment size</code>. If the client wishes, they can specify this option with every <code>SYN</code> segment sent (a segment, where <code>SYN</code> flag is set). On the screenshot above I&rsquo;ve marked the <code>TCP Option - Maximum segment size: 1460 bytes</code>. That means, that Homer can digest <code>1460</code> bytes at a time (instead of the default <code>536</code>).</p>
<h3 id="checksum">Checksum</h3>
<p><img src="images/8.jpg" alt="img"></p>
<h3 id="urgent-pointer">Urgent Pointer</h3>
<p><img src="images/10.jpg" alt="img"></p>
<p>This one is tricky&hellip; . Seems that none really understands what it&rsquo;s for and how to use. That&rsquo;s probably the reason, why it so hard to capture.</p>
<blockquote>
<p>The urgent pointer points to the <strong>sequence number</strong> of the octet following the urgent data.</p>
</blockquote>
<p>Another peculiar statement in RFC:</p>
<blockquote>
<p>The TCP urgent mechanism is NOT a mechanism for sending &ldquo;out-of-band&rdquo; data: the so-called &ldquo;urgent data&rdquo; should be delivered &ldquo;in-line&rdquo; to the TCP user.</p>
</blockquote>
<h2 id="tcp-handshake">TCP handshake</h2>
<p>Let&rsquo;s return to the pervert puppy. Before he was scared off by this hideous picture, he used to visit this <em>El Barto</em> website quite often. Let&rsquo;s dissect one of these sessions. At this moment no data is being sent. It&rsquo;s just the connection establishment.</p>
<p>The pervert puppy comes up with an initial sequence number (ISN). For the simplicity sake I&rsquo;ll choose a very small one, when in reality they are a little longer (as was shown in this article <a href="#sequence-number">before</a>).</p>
<p>Say, the puppy ğŸ• came up with the number <code>10</code>. He sends this number and sets the <code>SYN</code> flag.</p>
<p>The server receives this sequence number and now knows, that the next segment it will receive will have the number <code>11</code>. Also, the server comes up with his own ISN. For example, <code>100</code>. The server sends his sequence number <code>100</code>, along with the client&rsquo;s next expected sequence number specified as an acknowledgment number and sets both <code>SYN</code> and <code>ACK</code> flags.</p>
<p>The pervert puppy receives the response. It first increments <strong><em>El Barto</em> server&rsquo;s</strong> sequence number by one. This is going to be his <em>acknowledgment number</em> which indicates that the next segment from the server should have the sequence number <code>101</code>. Then, the puppy increments its <strong>own</strong> sequence number by one (<code>11</code>). This is his new <em>sequence number</em>. He also sets the <code>ACK</code> flag and sends this all to the <em>El Barto</em> server.</p>
<p><em>El Barto</em> server is expecting sequence number <code>11</code> from the pervert puppy and it gets this very number, so everything is in order, the connection has been established and the pictures can be finally transferred. The server enters a listening state and waits for the request: <em>Which picture do you want?</em>, - it asks.</p>
<p>To be brief, if <code>x</code> is the ISN (initial sequence number) of the client, and <code>y</code> is the ISN of the server, then the process looks like this:</p>
<ol>
<li>client -&gt; server: <code>SYN</code>, <code>SEQ</code> = x;</li>
<li>client &lt;- server: <code>SYN</code>+<code>ACK</code>, <code>SEQ</code> = y, <code>ACKN</code> = x+1</li>
<li>client -&gt; server: <code>ACK</code>, <code>SEQ</code> = x+1, <code>ACKN</code> = y+1</li>
</ol>
<h2 id="exchanging--data">Exchanging  data</h2>
<p>So, the pervert puppy ğŸ• is changing neither sequence nor acknowledgment numbers. It only &ldquo;copies&rdquo; the previous header and adds some data to it. The data part is an HTTP GET request. So, the last step from the list above is repeated with data attached:</p>
<ol start="4">
<li>client -&gt; server: <code>ACK</code>, <code>SEQ</code> = x+1, <code>ACKN</code> = y+1, data ğŸ“ƒ</li>
</ol>
<p>Observe the below two pictures: the first one shows the <code>ACK</code> segment from the client (note the sequence <code>2271707856</code>  and acknowledgment <code>2307963123</code> numbers).</p>
<p><img src="images/last-ack.png" alt="img"></p>
<p>The second picture shows the first segment with data (the sequence <code>2271707856</code> and acknowledgement <code>2307963123</code> numbers are the same and the <code>ACK</code> flag is still set):</p>
<p><img src="images/first-http.png" alt="img"></p>
<p>In the picture above I&rsquo;ve also marked HTTP protocol part (putrple). It&rsquo;s not expanded because for this discussion its contents is irrelevant. I&rsquo;ve marked it to show, that though the TCP headers are almost the same, there appears a new layer - application layer, i.e. the data it all was meant for. So, the client requests something using HTTP protocol.</p>
<p>Diagram from RFC 793 [<a href="#references">2</a>]:</p>
<p><img src="images/rfc-tcp-connection-diagram.png" alt="img"></p>
<p>Here is WinAPI that handles TCP connections:</p>
<h2 id="four-way-handshake">Four-way Handshake</h2>
<p>That&rsquo;s how the connection is terminated.</p>
<p><img src="images/fin.png" alt="fin"></p>
<h2 id="attacks">Attacks</h2>
<h3 id="tcp-session-hijacking">TCP session hijacking</h3>
<h2 id="references">References</h2>
<p>[<a href="https://nmap.org/misc/split-handshake.pdf">1</a>] TCP split-handshake attack, pdf document</p>
<p>[<a href="https://tools.ietf.org/html/rfc793">2</a>] RFC 793 about TCP protocol and TCP handshake</p>
<p>[<a href="https://www.amazon.com/System-Forensic-Analysis-Brian-Carrier/dp/0321268172">3</a>] File System Forensic Analysis 1st Edition by <a href="https://www.amazon.com/Brian-Carrier/e/B001KDJ2KK/ref=dp_byline_cont_book_1">Brian Carrier</a> (Author)</p>
<p>[<a href="http://www.tcpipguide.com/free/t_TCPConnectionEstablishmentProcessTheThreeWayHandsh-4.htm">4</a>]</p>
<p>[<a href="https://www.techrepublic.com/article/tcp-hijacking/">5</a>] TCP hijacking attack</p>
<p>[<a href="https://tools.ietf.org/html/rfc1122">6</a>] RFC 1122 about MTU</p>
<p>[<a href="https://medium.com/@NickKaramoff/tcp-packets-from-scratch-in-python-3a63f0cd59fe">7</a>] Build a packet with python</p>
<p>[<a href="https://scapy.readthedocs.io/en/latest/usage.html">8</a>] Scapy tutorial</p>
<p>[<a href="https://tools.ietf.org/html/rfc6093#page-3">9</a>] RFC 6093 Updates pn 793, 1011, 1122</p>
<p>[<a href="https://www.quora.com/What-is-the-significance-of-the-urgent-pointer-in-TCP-Are-there-any-real-examples-of-its-usage">10</a>] What is UP for?</p>
<p>[<a href="https://viblo.asia/p/network-socket-implementation-client-iosserver-macos-zb7vDVrkMjKd">11</a>] MacOS Socket API, [<a href="http://web.mit.edu/macdev/Development/MITSupportLib/SocketsLib/Documentation/sockets.html">12</a>] BSD Socket  [<a href="https://inst.eecs.berkeley.edu//~ee122/fa09/notes/03-SocketProgrammingx6.pdf">13</a>] Socket Programming [<a href="https://handsonnetworkprogramming.com/articles/differences-windows-winsock-linux-unix-bsd-sockets-compatibility/">14</a>] Socket Programming Differences MacOS vs Win [<a href="https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/connect.2.html">15</a>] <code>connect</code> man page [<a href="https://stackoverflow.com/questions/21001028/sockets-behavior-differently-between-bsd-mac-os-x-and-openbsd-and-linux-ubunt">16</a>] Socket differences Mac vs Ubuntu</p>
<p>[<a href="https://packetlife.net/blog/2011/mar/2/tcp-flags-psh-and-urg/">17</a>] [<a href="https://www.geeksforgeeks.org/tcp-flags/">18</a>] <code>URG</code> vs <code>PSH</code> flags</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
