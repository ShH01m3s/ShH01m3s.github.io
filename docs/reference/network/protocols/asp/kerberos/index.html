<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ“š Kerberos - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ğŸª¤">
      <a href="/docs/thunting">
        <span>Threat Hunting ğŸª¤</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference ğŸ“š">
      <a href="/docs/reference">
        <span>Tech Reference ğŸ“š</span>
      </a>
    </li>
    
    <li class="menu-item-notes ğŸ“">
      <a href="/docs/notes">
        <span>Notes ğŸ“</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ğŸª¤">
      <a href="/docs/thunting">
        <span>Threat Hunting ğŸª¤</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference ğŸ“š">
      <a href="/docs/reference">
        <span>Tech Reference ğŸ“š</span>
      </a>
    </li>
    
    <li class="menu-item-notes ğŸ“">
      <a href="/docs/notes">
        <span>Notes ğŸ“</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/reference/network/protocols/asp/"> ğŸ‘ˆğŸ¼ Back to </br> ğŸ“š Session, Presentation, Application Layer </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#structure">Structure</a></li>
    <li><a href="#the-flow">The Flow</a></li>
    <li><a href="#keys">Keys</a></li>
    <li><a href="#messages">Messages</a></li>
    <li><a href="#the-play">The Play</a>
      <ul>
        <li><a href="#step-1-user-initiates-authentication">Step 1. User initiates authentication</a></li>
        <li><a href="#step-2-as-generates-a-ticket-granting-ticket">Step 2. AS generates a Ticket Granting Ticket</a></li>
        <li><a href="#step-3-user-requests-the-ticket">Step 3. User requests the ticket</a></li>
        <li><a href="#step-4-user-gets-the-ticket">Step 4. User gets the ticket</a></li>
        <li><a href="#the-end">The End</a></li>
      </ul>
    </li>
    <li><a href="#golden-ticket">Golden Ticket</a></li>
    <li><a href="#silver-ticket">Silver Ticket</a></li>
    <li><a href="#diamond-ticket">Diamond Ticket</a></li>
    <li><a href="#saphire-ticket">Saphire Ticket</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">ğŸ“š Kerberos</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      
      <div class="article-category">
          
            
              <i class="fab fa-windows"></i>          
            
            
            
            
            
            
          
          
      </div> <br />
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <h2 id="structure">Structure</h2>
<h2 id="the-flow">The Flow</h2>
<p>- Wanna talk</p>
<p>- Ok. Let&rsquo;s talk. Here is my public key. Here are the protocols that I support.</p>
<p>- Thanks <em>Checks for known hosts locally</em>. Here&rsquo;s my password.</p>
<h2 id="keys">Keys</h2>
<p>There are several keys that are used in this play. Three keys exist at the very begining. A user has his green key, TGS has its yellow one and the HTTP server has a black one. Each key is private to the party and is not know by other parties. Two more keys are generated during the authentication process: a purple and a crimson one. Keys also need to be printer out: one copy for green, black and yellow keys and two copies for purple and crimson ones. Here is the ininital &ldquo;state&rdquo;.</p>
<p><img src="images/intro.png" alt="intro"></p>
<h2 id="messages">Messages</h2>
<p>Below are all the messages that need to be printed. These messages are going to be exchanged and &ldquo;decrypted&rdquo; during the play. Each message has a symbol of envelope âœ‰ï¸ at the right corner. Its color corresponds to the party&rsquo;s color: user&rsquo;s green, AS&rsquo;s blue, TGS&rsquo; yellow, HTTP server&rsquo;s black. The same goes for the locks that can be drawn right upon the envelope sign. These locks mean that the message is encrypted. It&rsquo;s never encrypted with the key that belongs to the author of the message, so the colors of locks and enveloped never match! For example, if the lock is yellow and the envelop is blue, it means that the message was generated by AS (since it&rsquo;s blue) and encrypted with a TGS key (since the lock is yellow). To unlock the message one needs a yellow key.</p>
<p>All the keys that a particular party has is listed by its avatar.</p>
<p><img src="images/messages/1.png" alt="intro">
<img src="images/messages/2.png" alt="intro"></p>
<p><img src="images/messages/2.png" alt="intro"></p>
<p><img src="images/messages/3.png" alt="intro"></p>
<p><img src="images/messages/4.png" alt="img"></p>
<p><img src="images/messages/5.png" alt="img"></p>
<p><img src="images/messages/6.png" alt="img"></p>
<p><img src="images/messages/7.png" alt="img"></p>
<p><img src="images/messages/8.png" alt="img"></p>
<p><img src="images/messages/9.png" alt="img"></p>
<h2 id="the-play">The Play</h2>
<p>When I was working in DrWeb I have designed an interactive presentation that helped to understand how Kerberos worked. My four collegues all were wearing T-shirts of different colours: green, black, blue and yellow. Luckily, these were the colours I used in my presentation as well (just a coincidence).</p>
<p>Each colleague was to play a ceratin role in this play: a user (green ğŸŒ±), an authentication service (blue ğŸ’¦), a TGS (yellow ğŸŒ) and an HTTP server (black ğŸ¥·). Instead of an HTTP there could be any other server, Afterall, all of these operations were designed to ensure secure authentication to some server. Could as well be an FTP or something less boring.</p>
<p>Each person representing a party was given an envelope colored with his color (blue, green, black or yellow), which contained appropriately colored messages and keys (yes, I&rsquo;ve actually printed on the paper and cut these messages and keys).</p>
<h3 id="step-1-user-initiates-authentication">Step 1. User initiates authentication</h3>
<p>A user ğŸ¤£ wants to connect to an HTTP server, but he cannot do so just like that. He needs to go through several levels of hell to achieve that goal and we are about to see them under the microscope.</p>
<p><img src="images/1.png" alt="step1"></p>
<p>So, as is we can clearly see from the picture above, this message (the first in this chain) is called Authentication request. It contains several data fields: <code>userid</code>, <code>tgsid</code> (id number of a Ticket Granting Ticket), user&rsquo;s <code>IP</code> address and the <code>lifetime</code> this request is valid for. This message is destined for the AS ğŸ’‚â€â™€ï¸ (Authentication server).</p>
<blockquote>
<p>-  <em>I wanna see the pictures of cute snakes ğŸ</em>.</p>
<p><em>The collegue playing the user ğŸ¤£ (green) hands an authentication request message to the person who&rsquo;s playing the AS ğŸ’‚â€â™€ï¸.</em></p>
</blockquote>
<h3 id="step-2-as-generates-a-ticket-granting-ticket">Step 2. AS generates a Ticket Granting Ticket</h3>
<p>AS ğŸ’‚â€â™€ï¸now generates the crimson key ğŸ”‘ for the user ğŸ¤£ and TGS ğŸ‘¨ğŸ¼â€ğŸ’¼ communication.</p>
<p><img src="images/2.png" alt="img"></p>
<p>AS ğŸ’‚â€â™€ï¸ then generates two messages: Response and Ticket Granting Ticket. Both messages contain this newly created crimson key. The contents of these messages is almoust the same (see below). The only difference is that Ticket Granting Ticket contains user id as well.</p>
<p>The Response is encrypted with the user&rsquo;s green lock and only the user&rsquo;s green key can unlock it.</p>
<p>Ticket Granting Ticket is locked (encrypted) with the TGS ğŸ‘¨ğŸ¼â€ğŸ’¼ yellow key and thus only TGS ğŸ‘¨ğŸ¼â€ğŸ’¼ can unlock it with its yellow key ğŸ”‘.</p>
<p>So, even though the user ğŸ¤£ receives this Ticket Granting Ticket, he cannot read it. He only can view the contents of the Response that he has a key for. The crimson key is found in both messages, so that the user ğŸ¤£ wouldn&rsquo;t be able to tamper the TGS session key. Since the second message is encrypted and the user ğŸ¤£ presumably doesn&rsquo;t have a key (he shouldn&rsquo;t), he can tamper only the key that&rsquo;s in his own message. But in this case the key in Ticket Granting Ticket  won&rsquo;t be able to open (dectrypt) the Authenticator message.</p>
<p><img src="images/3.png" alt="img"></p>
<blockquote>
<p>- ğŸ’‚â€â™€ï¸<em>Here is your ticket to get the ticket, pal!</em></p>
<p>The person playing AS hands the person playing the user two messages: Response locked with a green lock and a TGT locked with a yellow lock. Both messages have crimson keys attached. User keeps all of that for now.</p>
</blockquote>
<h3 id="step-3-user-requests-the-ticket">Step 3. User requests the ticket</h3>
<p>So, the user ğŸ¤£ has nothing else to other that open the Response. Now, ther user ğŸ¤£ can grab the crimson key and add it to his collection.</p>
<p><img src="images/4.png" alt="img"></p>
<p>Now the user ğŸ¤£ has the crimson key and can lock messages with crimson locks and unlock them as well.</p>
<p>But wait, to whom is this Ticket Granting Ticket destined? Do you remember, it&rsquo;s still in the user&rsquo;s archive! It&rsquo;s for TGS ğŸ‘¨ğŸ¼â€ğŸ’¼, of course. TGS ğŸ‘¨ğŸ¼â€ğŸ’¼ is the only party that has a yellow key ğŸ”‘. So, the user just forwards it to the TGS.</p>
<p>Remember, that the ultimate goal is to get the ticket for HTTP server. But at this stage the user only has the Ticket Granting Ticket, basically a ticket to get another ticket! It&rsquo;s needed by the TGS to issue a ticket that the user really wanted to get from the very start.</p>
<p><img src="images/5.png" alt="img"></p>
<p>So, the user ğŸ¤£ generates two messages: Request (unencrypted) and Authenticator (locked with crimson lock). These two messages are then forwarded to TGS ğŸ‘¨ğŸ¼â€ğŸ’¼ along with the TGT that was received from AS ğŸ’‚â€â™€ï¸ and remains encrypted.</p>
<blockquote>
<p>- <em>I have the Ticket to get the ticket. Give me <strong>the</strong> ticket!</em>, - the user says, handing the TGS player three messages along with the TGT and the second copy of the crimson key. See the picture above.</p>
</blockquote>
<h3 id="step-4-user-gets-the-ticket">Step 4. User gets the ticket</h3>
<p>Now, TGS ğŸ‘¨ğŸ¼â€ğŸ’¼finally uses his yellow key to unlock the TGT and grabs the crimson key as well.</p>
<p><img src="images/6.png" alt="img"></p>
<p>TGS ğŸ‘¨ğŸ¼â€ğŸ’¼ has now the key to unlock the Authenticator message from the user locked with a crimson lock.</p>
<p><img src="images/7.png" alt="img"></p>
<p>TGS ğŸ‘¨ğŸ¼â€ğŸ’¼takes some time to compare the data in these messages, validate IP address and cache. It also checks whether the TGS session key (crimson key) is not expired, by the way!</p>
<p><img src="images/8.png" alt="img"></p>
<p>If everything is in order, TGS ğŸ‘¨ğŸ¼â€ğŸ’¼ generated yet another key, the purple one (HTTP session key is its boring name).</p>
<p><img src="images/9.png" alt="img"></p>
<p>The following responses resemble the ones that were sent by AS during the second step. Except that they encrypted with other keys and contain other keys as well.</p>
<p><img src="images/10.png" alt="img"></p>
<p>Both HTTP Server ticket and Response contain a purple key. However, remember that the use only has the crimson key. Who has the black one then? HTTP server ğŸ˜µâ€ğŸ’«! So, user can only unlock the Response and get the purple key, adding it to the collection.</p>
<p><img src="images/11.png" alt="img"></p>
<p>The second message remains locked and just gets forwared to the HTTP server ğŸ˜µâ€ğŸ’« since it&rsquo;s the only one who can open it.</p>
<p><img src="images/12.png" alt="img"></p>
<p><img src="images/13.png" alt="img"></p>
<p>HTTP server ğŸ˜µâ€ğŸ’« uses its black key to open the black lock and read the HTTP Server Ticket. It grabs the purple key from the message and uses it to unlock the Authenticator message.</p>
<p><img src="images/14.png" alt="img"></p>
<p>The following check are exactly the same as the TGS performed earlier: compaing userid, timestamp, session expiration date. Checking cache and user IP.</p>
<p><img src="images/15.png" alt="img"></p>
<p>ğŸ¤º By the way, this black key can be stolen by the attacker to craft</p>
<p>If everything is ok, the user finally gets his ticket!!!</p>
<p><img src="images/16.png" alt="img"></p>
<h3 id="the-end">The End</h3>
<p>That&rsquo;s the final set up with the keys. The user ğŸ¤£ has a green, purple and crimson keys. AS ğŸ’‚â€â™€ï¸ has crimson only. TGS ğŸ‘¨ğŸ¼â€ğŸ’¼ - yellow, crimson and purple. HTTP server ğŸ˜µâ€ğŸ’« - black and purple only.</p>
<p><img src="images/17.png" alt="img"></p>
<h2 id="golden-ticket">Golden Ticket</h2>
<h2 id="silver-ticket">Silver Ticket</h2>
<h2 id="diamond-ticket">Diamond Ticket</h2>
<h2 id="saphire-ticket">Saphire Ticket</h2>
<p><a href="https://pgj11.com/posts/Diamond-And-Sapphire-Tickets/">https://pgj11.com/posts/Diamond-And-Sapphire-Tickets/</a></p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
