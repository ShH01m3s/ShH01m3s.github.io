<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ“š TCP/IP Stack Overview - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.957e71ad2cb873132802e19798d6ca577b82e708fa80d1e90b00bc9e23855023.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-forensics ğŸ” and incident response ğŸ¥·">
      <a href="/docs/dfir">
        <span>Forensics ğŸ” and Incident Response ğŸ¥·</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting">
      <a href="/docs/thunting">
        <span>Threat Hunting</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference ğŸ“š">
      <a href="/docs/reference">
        <span>Tech Reference ğŸ“š</span>
      </a>
    </li>
    
    <li class="menu-item-notes ğŸ“">
      <a href="/docs/notes">
        <span>Notes ğŸ“</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-forensics ğŸ” and incident response ğŸ¥·">
      <a href="/docs/dfir">
        <span>Forensics ğŸ” and Incident Response ğŸ¥·</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting">
      <a href="/docs/thunting">
        <span>Threat Hunting</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference ğŸ“š">
      <a href="/docs/reference">
        <span>Tech Reference ğŸ“š</span>
      </a>
    </li>
    
    <li class="menu-item-notes ğŸ“">
      <a href="/docs/notes">
        <span>Notes ğŸ“</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/reference/network/protocols/"> Back to ğŸ“š Network Protocols Section ğŸ‘ˆğŸ¼ </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#prerequisites">Prerequisites</a></li>
    <li><a href="#analogy">Analogy</a></li>
    <li><a href="#getting-technical">Getting Technical</a></li>
    <li><a href="#network-architecture">Network Architecture</a></li>
    <li><a href="#step-1-get-the-ip-address">Step 1. Get the IP address</a></li>
    <li><a href="#step-2-get-the-mac-address">Step 2. Get the MAC address</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
 </div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">ğŸ“š TCP/IP Stack Overview</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
                <i class="fas fa-archive"></i>
              
          <a class="category-link" href="/domain/general">general</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
                <i class="fa fa-graduation-cap"></i>
              
          <a class="platform-link" href="/doctype/article">article</a>
          
      </div> <br /><br/>
      
      
      
      

      
      

      
      <div class="article-tag">
          <i class="fas fa-tag"></i>
          
          
          <a class="tag-link" href="/tags/network" rel="tag">network</a>
          
           ,  
          <a class="tag-link" href="/tags/protocol" rel="tag">protocol</a>
          
           ,  
          <a class="tag-link" href="/tags/osi" rel="tag">osi</a>
          
      </div> 
      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p><em>This article is an overview of TCP/IP protocol stack. I will cover in detail what happens when a request to, say, <code>bakerst221b.com</code> is sent in the browser.</em></p>
<p>There is this famous OSI model&hellip; If you have ever scratched the surface of network security, you must have heard of it. It&rsquo;s an empermal model (like spherical eggs ğŸ¥š in the vacuum - a joke from Big Bang Theory). It&rsquo;s not a real thing, it&rsquo;s more like a blueprint ğŸ—ºï¸ for making real things. This model basically describes, what an empermal packet sent over network should approximately look like. It&rsquo;s called a packet ğŸ“¦ because it looks very much like one: your message wrapped in an envelope, wrapped in some paper, put into a box and sent via post office and finally delivered to the door. Comparing this process with mail services is not uncommon, but I will use it in my example. However, to make the process clearer, I&rsquo;ve sacrificied some realism. Though it&rsquo;s unreal, in my humble opinion it better describes the process.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>To get something somewhere we need some identifications, each level of identification narrowing the search. In case of our human world, if a shop needs to deliver, say, a book ğŸ“– to a person, he gets his address (street number). But there are many people living on this street ğŸ˜ . For further narrowing the search the shop needs a house number. But again, there are still many people living in the same building ğŸ¡, how to get the parcel to the right one? Apparently, we need a flat number and the person&rsquo;s name ğŸ’â€â™€ï¸. The same happens when you sending a packet over the computer network. Everytime a PC (laptop or a mobile device) needs to talk to other computers (laptops, mobiles, PCs, servers) it sends a packet using a network ğŸ•¸ï¸ of other computers ğŸ–¥ï¸ğŸ–¥ï¸ğŸ–¥ï¸ğŸ–¥ï¸ .</p>
<p>To make the further illustration clearer, here are the mail service vs computer network equivalents:</p>
<ul>
<li>Person&rsquo;s full name is MAC address (because it&rsquo;s almoust unique to each device). It&rsquo;s engraved on the devices network card when this card is manufactured. In terms of devices, swtiches live on data link layer and operate MAC addresses. In terms of people, network system administrators set this devices up and manage.</li>
<li>Person&rsquo;s street name is equivalent to IP address. There are local IP addresses and public ones. Local IP addresses are assigned by routers to all the devices in the local network. Local IPs usually start with <code>192.168.</code>. Public IPs are assigned to the router that&rsquo;s representing its local network. This public IP is the same for all devices  behind the router. Public IP is assigned by IPS (Internet Provider Service). The job of assigning IPs is done by a DHCP (Dynamic Host Configuration Protocol) service. It&rsquo;s usually turned on on the router to assign local addresses and on your IPS to assign public addresses to different routers. In addition to that DHCP service also provides some configuration data (such as Default Gateway, Domain Name, DNS Servers and more). In terms of devices, routers and DHCP servers live on network layer and operate IP addresses. In terms of people, network system administrators set this devices up and manage.</li>
<li>Person&rsquo;s house number is vaguely equivalent to TCP/UDP port number (IP + port is usually called a socket). Each service on a machine is usually assigned a port, but it doesn&rsquo;t mean it can&rsquo;t use another one. Also, a lot of malware use specific ports and that&rsquo;s how they are sometimes recognized. Most of the time you can get the service by looking at the port (<code>22</code> SSH, <code>80</code>, <code>443</code>, <code>8080</code> web servers (https and http), <code>21</code> ftp and etc). In terms of devices, PCs live on this layer (transport) and operate port numbers. In terms of people, system administrators set this devices up and manage.</li>
<li>Message itself is a mere application data (session, presentation and application layers). In terms of devices, PCs live on these layers and operate applications. In terms of people, system administrators set this devices up and manage, but the application data flow, logic is managed by software developers. Session layer is more backend software engineering realm, but presentation and application data is usually developed by front-enders.</li>
</ul>
<h2 id="analogy">Analogy</h2>
<p>There is this far far away world. It this world there are lots of cities, but we are going to talk about very peculiar one - Revencole. It is so peculiar because of the way they are messaging. They have something that looks very much like a Russian <a href="https://en.wikipedia.org/wiki/Matryoshka_doll">matryoshka doll</a> for exchanging messages. Here&rsquo;s a matryoshka:</p>
<p><img src="images/nesting-dolls_1fa86.png" alt="nesting-dolls_1fa86"></p>
<p>As you may already know, it&rsquo;s a hollow doll, which has another doll inside, also hollow and which also &hellip; well, you get the idea. That&rsquo;s why they are called - nested dolls. Now imagine that in this city people actually talk using this dolls.</p>
<p>Mark is an accountant at a big company in Revencole. He is a serious person and he needs to fill out different forms and tables and send them to different agencies and goverment bodies (like a IRS to pay taxes or something like that). Each agency or government body has it&rsquo;s own set of standarts for their documents. For example, Revencole&rsquo;s IRS requires all documents about taxes to start with <em>&ldquo;This is for IRS with love ğŸ’Œ &ldquo;</em> (they are weird) and the total amount of taxes paid in the end of the document.</p>
<p><img src="images/irs-report.png" alt="irs-report"></p>
<p>Also, Mark&rsquo;s ordering pencils in one company in the city, and this shop requires all orders to be filled in the form of a table with a <em>&ldquo;I need a pencil&rdquo;</em> at the top and a table of goods following it in a form of a table.</p>
<p><img src="images/pen-shop.png" alt="pen-shop"></p>
<p>When IRS receives something that doesn&rsquo;t start with <em>&ldquo;This is for IRS with love ğŸ’Œ &ldquo;</em>, they don&rsquo;t continue reading and just throw it away ğŸ—‘ï¸ informing Mark&rsquo;s or any other company that the document was invalid. If it&rsquo;s valid, they simply take the last digit in the form and take is a total. So, if Mark confuses Tax Code and Total fields, he&rsquo;ll be in trouble.</p>
<p>So, one gloomy evening Mark is preparing a tax report for IRS. He takes a paper with a blank form and writes  <em>&ldquo;This is for IRS with love ğŸ’Œ &ldquo;</em> at the top.</p>
<p><img src="images/irs-report-blank.png" alt="irs-report-blank"></p>
<p>Then Mark fills out all the blanks in the form according to his calculations. He then folds it twice and puts the report in an envelope âœ‰. On this envelope he writes the name of an employee at IRS who usually handles his company - Thomas.</p>
<p>The he puts this into a small box ğŸ“¦  and writes the house number on it (<code>23</code>). Then he puts it in a bigger box ğŸ“¦ and puts a house number on it (<code>Good St.</code>).</p>
<p>Finally he puts the bigger box ğŸ“¦ into a bag ğŸ‘ and orders a postman on a bike ğŸš´â€â™‚ï¸ to take it to IRS.</p>
<p>A ğŸš´â€â™‚ï¸ postman on a bike takes the parcel and gets to the post office. He gives the bag ğŸ‘ to the postoffice clerk ğŸ‘¨â€ğŸ’¼ James. James opens the bag and gets the bigger box ğŸ“¦. He reads the Street number and gives the Box to another clerk Jessie ğŸ‘©â€ğŸ’¼. Jessie opens it up and reads the house number written on the smaller box. Each of them then gives the postman on a bike this information and he departures.</p>
<p>He gets to the street <code>Good St.</code> specified by James and find a house number <code>23</code>. He knocks at the door and meets the landlady ğŸ‘µ of this house. He gives her the smaller box. She opens it up and reads the name on the envelope âœ‰.  If she knows the complany or the person in question, she accepts it and delivers it to the recipient. IRS worker get&rsquo;s the envolope, unwraps it and reads the report. He checks it for presence of <em>&ldquo;This is for IRS with love ğŸ’Œ&rdquo;</em> and if it&rsquo;s there, takes the last number in the report and write it down into his IRS tax book.</p>
<p>A very peculiar algorithm but it works&hellip; That&rsquo;s approximately how this model works. The ğŸš´â€â™‚ï¸ postman on a bike is a physical layer (cables and radio waves) whose job is to provide the means of delivery. The postoffice clerk ğŸ‘¨â€ğŸ’¼ James and Jessie are to read the street name and house number and tell it to the  ğŸš´â€â™‚ï¸ postman on a bike (he can&rsquo;t read). The landlady ğŸ‘µ is the data link layer, whose job is to identify the correct person inside the building ğŸ  and drop the parcel ğŸ“¦ if no such person or company resides in the house that she owns.</p>
<p>Let&rsquo;s now assume, that Mark has specified the correct street name and the employee&rsquo;s name correctly, but made an error in house number <code>26</code> instead of <code>23</code>. So, the ğŸš´â€â™‚ï¸ postman on a bike would ride to the same street but knocked at the wrong door. <code>26</code>&rsquo;s landlord ğŸ‘´ might have Thomas in the building, so he doesn&rsquo;t recognize the mistake. He would take the emvelope to to Thomas in <code>26</code> building. Let&rsquo;s assume this another Thomas is from the pencil company. He opens up the envelope and reads the message. But he doesn&rsquo;t see &ldquo;I need a pencil&rdquo; on the top, so he thinks to himself &ldquo;what the hell&rdquo; and throws it away into a ğŸ—‘ï¸ bin.</p>
<h2 id="getting-technical">Getting Technical</h2>
<p>So, now get more technical. Phisical layer and wires and stuff are two broad a topic to be discussed here. I am plannig to write an article about the ğŸš´â€â™‚ï¸ postman on a bike as well but later (keep checking this section for Physical Layer article).</p>
<p>When you type <code>bakerst221b.com</code> in the address bar of your browser, your PC is doing a tremedous work behind the curtains. Let&rsquo;s see, what this little workaholic elf is doing there. First, it ğŸ’» needs to pack your message into a set of nested envelopes (matryoshkas or boxed or bags). What&rsquo;s the message then? Since we are talking about websites, the most common wrapper would be the HTTP wrapper. What&rsquo;s an HTTP? Remember the specific forms like IRS requiring the <em>&ldquo;This is for IRS with love ğŸ’Œ&rdquo;</em> at the top and the total number in the bottom? And remember the pencil company insisting on having a <em>&ldquo;I need a pencil&rdquo;</em> at the top with a table following it? So, basically this is what a protocol is. It is merely a standart, some form or <strong>set of rules</strong> which all the requests should adhere to. IRS uses one protocol while the pencil company another. Whenever Mark is sending something to IRS, he uses IRS&rsquo;s set of rules for composing a message, and whenever he orders pencils, he follows the pencil company&rsquo;s instructions. Otherwise they simply won&rsquo;t read. HTTP is the set of rules that web servers make the clients to follow if this client wants to get a webpage in return. Here is how it looks like when requesting <code>bakerst221b.com</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">GET</span> <span class="o">/</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Host</span><span class="p">:</span> <span class="n">bakerst221b</span><span class="o">.</span><span class="n">com</span>
</span></span><span class="line"><span class="cl"><span class="n">Connection</span><span class="p">:</span> <span class="n">close</span>
</span></span><span class="line"><span class="cl"><span class="n">Upgrade</span><span class="o">-</span><span class="n">Insecure</span><span class="o">-</span><span class="n">Requests</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="p">:</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10_15_7</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">86.0.4240.198</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">,</span><span class="n">application</span><span class="o">/</span><span class="n">xhtml</span><span class="o">+</span><span class="n">xml</span><span class="p">,</span><span class="n">application</span><span class="o">/</span><span class="n">xml</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">image</span><span class="o">/</span><span class="n">avif</span><span class="p">,</span><span class="n">image</span><span class="o">/</span><span class="n">webp</span><span class="p">,</span><span class="n">image</span><span class="o">/</span><span class="n">apng</span><span class="p">,</span><span class="o">*/*</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">application</span><span class="o">/</span><span class="n">signed</span><span class="o">-</span><span class="n">exchange</span><span class="p">;</span><span class="n">v</span><span class="o">=</span><span class="n">b3</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span>
</span></span><span class="line"><span class="cl"><span class="n">Sec</span><span class="o">-</span><span class="n">Fetch</span><span class="o">-</span><span class="n">Site</span><span class="p">:</span> <span class="n">none</span>
</span></span><span class="line"><span class="cl"><span class="n">Sec</span><span class="o">-</span><span class="n">Fetch</span><span class="o">-</span><span class="n">Mode</span><span class="p">:</span> <span class="n">navigate</span>
</span></span><span class="line"><span class="cl"><span class="n">Sec</span><span class="o">-</span><span class="n">Fetch</span><span class="o">-</span><span class="n">User</span><span class="p">:</span> <span class="err">?</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Sec</span><span class="o">-</span><span class="n">Fetch</span><span class="o">-</span><span class="n">Dest</span><span class="p">:</span> <span class="n">document</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept</span><span class="o">-</span><span class="n">Language</span><span class="p">:</span> <span class="n">en</span><span class="o">-</span><span class="n">US</span><span class="p">,</span><span class="n">en</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">ru</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">es</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.7</span>
</span></span></code></pre></div><p>Well, basically that the message that we are going to wrap in an envelope âœ‰, smaller box ğŸ“¦, a bigger one ğŸ“¦ and a bag ğŸ‘. Let&rsquo;s use another example, closer to the ground.</p>
<h2 id="network-architecture">Network Architecture</h2>
<p>There is a nice family of Jack and Mary. They like pears ğŸ so let&rsquo;s mark their realm with one. They both like this website and use it pretty often (grapes realm ğŸ‡). But since these realms are quite far from each other, they can only communicate over some intermediary networks (network A ruled by <code>Router A</code> and network B ruled by <code>Router B</code>).</p>
<p>Let&rsquo;s just asume that our PC with IP <code>192.168.1.70</code> (local address) and the website with IP <code>185.199.110.153</code> (public address) are on two different VLAN&rsquo;s that are connected via three routers. What will happen if Mary goes to <code>bakerst221b.com</code>?</p>
<p>Let&rsquo;s examine our current network architecture first:</p>
<p><img src="images/network-architecture.png" alt="network-architecture"></p>
<p>Green arrows and green names with IP addresses (ğŸ realm) is Mary&rsquo;s and Jack&rsquo;s home network. Only Jack&rsquo;s and Mary&rsquo;s Router knows their internal IP addresses. Whenever any device wants to talk to the outside world, it uses on singe IP - the routers one (orange <code>184.10.199.12</code>). He is like a ambassador for them, representing them in the public network.</p>
<p>Orange ğŸŠ realm contains two Routers A and B. They are representing someone else. Who exactly - it is irrelevant for this example. For Jack and Mary they are simply  intermediary nodes (almost like a road to the  ğŸš´â€â™‚ï¸ postman on a bike).</p>
<p>The grapes ğŸ‡ realm is where web server with <code>bakerst221b.com</code> resides with its own ambassador Router who talks from its behalf. Notice that I&rsquo;ve not put any local addresses (local addresses known only to the router and devices connected to it usually begin with <code>192.168.</code>) for <code>bakerst221b.com</code> and it&rsquo;s Router. It&rsquo;s because from Mary&rsquo;s or Jack&rsquo;s point of view there is not wat to know it. They only see and care about the public IPs.</p>
<p>When Mary connects to <code>bakerst221b.com</code>  using her laptop, her request goes to the <code>Jack's and Mary's Router</code>, then to the <code>Router A</code>, then <code>Router B</code> and get to <code>Bakerst221b.com's Router</code>. The latter will then forward the request to <code>bakerst221b.com</code>. So the route is ğŸ -&gt; ğŸŠ -&gt; ğŸ‡. The response will go the same route but reversed (ğŸ‡ -&gt; ğŸŠ -&gt; ğŸ).</p>
<p>Let&rsquo;s see this work in more details using an example. One sunny day Mary decides to visit <code>bakerst221b.com</code> and check it for updates. She opens her laptop and opens a web browser. Then she types in the address bar <code>https://bakerst221b.com</code> and hits <code>Enter</code>. Her laptop is not panicking. It knows what to do. It needs to pack the following parcel:</p>
<p><img src="images/http-request.png" alt="http-request"></p>
<p><code>XXX</code> in red stand for some data that the PC ğŸ–¥ï¸ doesn&rsquo;t know at the moment:</p>
<ul>
<li><code>bakerst221b.com</code>&rsquo;s IP address</li>
<li><code>bakerst221b.com</code>&rsquo;s port number</li>
<li><code>bakerst221b.com</code>&rsquo;s MAC address</li>
</ul>
<p>It sends several separate request to fill in the fields in question.</p>
<h2 id="step-1-get-the-ip-address">Step 1. Get the IP address</h2>
<p>Using DNS protocol her PC asks the following:</p>
<blockquote>
<p>ğŸ’» â€‹ &ldquo;I have a human readable garbage (<code>bakerst221b.com</code>), I need a hardcore machine equivalent (IP address). Does anyone know who the heck <code>bakerst221b.com</code> is?&rdquo;.</p>
</blockquote>
<p>&ndash; Whom is it asking?</p>
<p>&ndash; A DNS server.</p>
<p>&ndash; Where is it?</p>
<p>&ndash; Her internet provider has it.</p>
<p>&ndash; Does Internet Provider&rsquo;s DNS server has all the domain names?</p>
<p>&ndash; Of course not. It would blow up. It asks its fellow DNS buddies until the right one is found.</p>
<blockquote>
<p>Unnecessary info I&rsquo;ve found out while writing this article. It turns out,  Mary&rsquo;s laptop first tries doing this over IPv6 (red square) and fails. Two requests: for A and AAAA records (see <a href="#">DNS article</a>) to get both IPv4 and IPv6 addresses for <code>bakerst221b.com</code>. For both requests itgot a <code>Refused</code> response - I don&rsquo;t understand the whole internals of this, but guess IPv6 connection is not supported for my hosting server ğŸ’¡ .</p>
</blockquote>
<p>Then it tries to ask over IPv4 for the same both records (A and AAAA) and gets the addresses it needed (purple square):</p>
<p><img src="images/dns-query.png" alt="dns-query"></p>
<p>Since there are no IPv6 addresses assigned, ğŸ–¥ï¸ PC only needs the response for A record.  Ok, not that ğŸ–¥ï¸ gets its IPs, it can finally sign his first envelope, the IP header (see the outer envelope âœ‰  <code>To</code> field filled in):</p>
<p><img src="images/http-request2.png" alt="http-request2"></p>
<p>But there are also transport and datalink layers&hellip;. His parcel now looks like this :</p>
<h2 id="step-2-get-the-mac-address">Step 2. Get the MAC address</h2>
<p>Data Link layer, is tricky one. The ğŸ–¥ï¸ itself doesn&rsquo;t do that dirty job. It just puts its router&rsquo;s MAC address, knowing that the router will know what to do. How does it know the Router&rsquo;s MAC? well, it asks. It knows that the router sits at <code>192.168.1.1</code>. So, it sends an ARP request (just like the ones we will see below in a minute), asking for <code>192.168.1.1</code>&rsquo;s MAC. But this won&rsquo;t be as complex as the example below. Since these devices are on the same network, there only going to be one ARP request and a single response from the J&amp;M Router.</p>
<p>Let see, what that little chap (J&amp;M Router) is doing. How does it get the MAC address of <code>bakerst221b.com</code>? To determine MAC address (to help Mary&rsquo;s laptop ğŸ’» sign the second envelope with MAC addresses) the router sends an ARP request to the network of his buddies (other representatives, Router A).</p>
<ol>
<li>J&amp;M Router puts <code>ff:ff:ff:ff:ff:ff</code> MAC address in the Enthernet header&rsquo;s <code>To</code> field (which means broadcast and therefor all Jack&rsquo;s and Mary&rsquo;s router&rsquo;s buddies are going to get this message) and its own in MAC <code>From</code> field (orange square). In the ARP request it puts the newly discovered IP of <code>bakerst221b.com</code> as <code>Target IP</code> and its own MAC and IP as a <code>Sender MAC</code> and <code>Sender IP</code> (see the scheme below, purple square):</li>
</ol>
<p><img src="images/arp-request.png" alt="arp-request"></p>
<ol start="2">
<li>
<p>Router A get&rsquo;s the ARP request from Jack and Mary&rsquo;s Router. It reads the request, reads the <code>Target IP</code>, checks its records and realized that it doesn&rsquo;t know the guy. That&rsquo;s why it asks his fellow Router B. In the Ethernet II header it puts its own MAC address in <code>From</code> and <code>ff:ff:ff:ff:ff:ff</code> in <code>To</code> fields (orange square). It leaves the ARP request itself untouched (purple square). So, <code>Target MAC</code> remains untouched. â“</p>
</li>
<li>
<p>Router B get&rsquo;s the ARP request from Router A. It reads the ARP request, reads the  <code>Target IP</code>, checks its records and realized that it doesn&rsquo;t know the guy. That&rsquo;s why it asks his fellow <code>Bakerst221b</code>&rsquo;s Router. In the Ethernet II header it puts its own MAC address in <code>From</code> and <code>ff:ff:ff:ff:ff:ff</code> in <code>To</code> fields (orange square). It leaves the ARP request itself untouched (purple square). So, <code>Target MAC</code> remains untouched again. â“ğŸ’¡ <em>May be the Sender&rsquo;s MAC is changing - don&rsquo;t know yet.</em></p>
</li>
<li>
<p><code>Bakerst221b</code>&rsquo;s Router receives the request. It reads the ARP request, reads the  <code>Target IP</code>, checks its records and realized that it&rsquo;s itself. So, in its response it switches <code>Source</code> and <code>Target</code> fields&rsquo; values and puts its own MAC in <code>Source MAC</code> field. It then sends the packet to Router B. So now it would look something like this:</p>
<p><img src="images/arp-response-1.png" alt="arp-response-1"></p>
</li>
<li>
<p>Router B just relays the answer, substituting <code>From</code> to its MAC address and <code>To</code> to the Router&rsquo;s A MAC in Ethernet II (Data link layer).</p>
<p><img src="images/arp-response-2.png" alt="arp-response-2"></p>
</li>
<li>
<p>Router A receives the package and relays it to Jack&rsquo;s and Mary&rsquo;s router, substituting <code>From</code> to its MAC address and <code>To</code> to the J&amp;M Router&rsquo;s MAC in Ethernet II (Data link layer).</p>
</li>
</ol>
<p><img src="images/arp-response-3.png" alt="arp-response-3"></p>
<p>Here are ARP request and response intercepted in real traffic:</p>
<p><img src="images/arp-request-iris.png" alt="arp-request-iris"></p>
<p><img src="images/arp-response-iris.png" alt="arp-response-iris"></p>
<p>Now, J&amp;M saves the data for some time for future requests. The main idea is that the device is asking <em>&ldquo;Who has 185.199.110.153? Tell 184.10.199.12&rdquo;</em> recursively thorogh a network of interconnected network devices. As soon as it gets the answer, it fills the data link layer header with the correct MAC address.  Please note, that ARP is only packed into data link (Ethernet) envelope ğŸ“© , not subsequent wrappings into IP and TCP envelopes since we are not actually sending any data and don&rsquo;t need IP and TCP envelopes for that. Our postoffice clerk 1 and postoffice clerk 2 are both having a rest ğŸŒ´ .</p>
<p>So, Mary&rsquo;s laptop already knows the destination IP that he acquired with the help of DNS request: <code>185.199.110.153</code>. It also knows its own MAC and IP (obviously).  Let&rsquo;s keep in mind mind that Mary&rsquo;s laptop doesn&rsquo;t talk to the outer world on its own. So, it puts its representative&rsquo;s MAC in Ethernet II header (<code>To</code> field) instead of <code>bakerst221b.com</code>&rsquo;s MAC. For example, I&rsquo;ve requested a <code>sherlock.com</code> page and captured the request. However, IP and port are of <code>sherlock.com</code>, of course. It also inserts its local IP as the <code>Source IP</code> in IP header (see the <code>Source Address</code> in the screenshot below, it&rsquo;s local since starts with <code>192.168.</code>) but you need a public one to talk to others.</p>
<p><img src="images/ip-header.png" alt="ip-header"></p>
<p>That&rsquo;s why when the router receives the package, it performs two importnant modifications.</p>
<ul>
<li>changes the <code>From</code> and <code>To</code> MAC addresses in Ethernet II header. <code>From</code> its own MAC and <code>To</code> Router&rsquo;s A MAC.</li>
<li>Substitues <code>Source IP</code> in IP header with its own <strong>public</strong> IP. This is IP can be seen when you type <code>what's my ip</code> in google.com or go to your router&rsquo;s settings and look at the main page. It&rsquo;s the IP others see on the network.</li>
</ul>
<p>The J&amp;M Router also takes a note, that the machine with local address <code>192.168.1.70</code> send this request. It&rsquo;s needed, of course, to be able to deliever the reply to Mary&rsquo;s laptop ğŸ’» later.</p>
<p>So, now the request is going to look as follows:</p>
<p><img src="images/mary-final-req.png" alt="mary-final-req"></p>
<p>Now the port, how does it get the port to connect to? For more details see the article about TCP/UDP <a href="#">here</a>.</p>
<h2 id="references">References</h2>
<p><a href="http://www.firewall.cx/">firewall.cx</a></p>
<p>Wireshark and Iris packet sniffers</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/Performance/How_browsers_work">https://developer.mozilla.org/en-US/docs/Web/Performance/How_browsers_work</a></p>
<p><a href="https://edx.readthedocs.io/projects/edx-developer-guide/en/latest/preventing_xss/preventing_xss.html">https://edx.readthedocs.io/projects/edx-developer-guide/en/latest/preventing_xss/preventing_xss.html</a></p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
