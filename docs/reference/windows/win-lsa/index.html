<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Windows LSA - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.9d91cbb32c96c334ae7b38c3d99d30727e0836e1182125cc5f007d215f0b9e59.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-forensics ğŸ” and incident response ğŸ¥·">
      <a href="/docs/dfir">
        <span>Forensics ğŸ” and Incident Response ğŸ¥·</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference ğŸ“š">
      <a href="/docs/reference">
        <span>Tech Reference ğŸ“š</span>
      </a>
    </li>
    
    <li class="menu-item-notes ğŸ“">
      <a href="/docs/notes">
        <span>Notes ğŸ“</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-forensics ğŸ” and incident response ğŸ¥·">
      <a href="/docs/dfir">
        <span>Forensics ğŸ” and Incident Response ğŸ¥·</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference ğŸ“š">
      <a href="/docs/reference">
        <span>Tech Reference ğŸ“š</span>
      </a>
    </li>
    
    <li class="menu-item-notes ğŸ“">
      <a href="/docs/notes">
        <span>Notes ğŸ“</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/reference/windows/"> Back to ğŸ“š Windows Analysis Reference Section ğŸ‘ˆğŸ¼ </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#sid">SID</a>
      <ul>
        <li><a href="#rid-hijacking">RID hijacking</a></li>
      </ul>
    </li>
    <li><a href="#local-security-authority-subsystem">Local Security Authority Subsystem</a></li>
    <li><a href="#login-process">Login Process</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
 </div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Windows LSA</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      
      
      <div class="article-category">
          
            
              <i class="fab fa-windows"></i>          
            
            
            
            
            
          <a class="platform-link" href="/platforms/windows">windows</a>
          
      </div> <br />
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p>Each process in the system has an access token. This token determies what privileges this fellow has. This token consists of:</p>
<ul>
<li>User SID</li>
<li>Group SID</li>
<li>Integrity level (mandatory label). Vista+/WinServer 2008+. This label determines what privileges the process has based on the assigned accesses and groups.</li>
<li>Logon session SID</li>
<li>Token type (primary or impresonation)</li>
<li>Impersonation level</li>
<li>User privileges list</li>
<li>Other</li>
</ul>
<p>Checks:</p>
<ul>
<li><input disabled="" type="checkbox"> <em>What is your mandatory labelâ“</em>
<ul>
<li><input disabled="" type="checkbox"> Compare this label to the object&rsquo;s label.</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> Take User and Group SIDs of the process and ACL of the object in question</li>
</ul>
<h2 id="sid">SID</h2>
<p>Below is the structure of a SID. SID, shortly speaking, is a user id. The actual ID of the user, is the RID (relative identifier) part.</p>
<p><img src="images/1.png" alt="1"></p>
<p>In case <code>Who created it?</code> aka issuing authority ends with number <code>21</code>, there will be a trailing SID which represendts PC or domain identifier (purple in the picture above). <code>1</code> - revision number, <code>5</code> - issuing autority, <code>21</code> - sub-issuing authority.</p>
<p>To get a user&rsquo;s SID:</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">wmic</span> <span class="n">useraccount</span> <span class="nb">where </span><span class="n">name</span><span class="p">=</span><span class="s1">&#39;veronicazvereva&#39;</span> <span class="n">get</span> <span class="n">sid</span>
<span class="c"># or</span>
<span class="n">whoami</span> <span class="p">/</span><span class="n">user</span> <span class="c"># for current user</span>
</code></pre></div><p>PC/domain ID can be viewed in <code>SAM\SAM\Domains\Accounts</code>, value <code>V</code>, last 12 bytes of the data chunk:</p>
<p><img src="images/sam1.png" alt="sam1"></p>
<p>In order to translate this value, split the hex 12 byte value into three 4 byte chunks. Since these are little-endian, reverse the order of the bytes, convert each to decimal If this is a negative value, something is not right. It&rsquo;s a 32-bit unsigned value! For example, in the below picture we see that the machine id is <code>2d 48 f4 b4 1a b1 b8 73 f1 2a 8a a3</code>. Splitting into 3 chunks gives us: <code>2d 48 f4 b4</code>, <code>1a b1 b8 73</code> and <code>f1 2a 8a a3</code>. Lets now convert each to little-endian: <code>b4 f4 48 2d</code>, <code>73, b8, b1, 1a</code> and <code>a3 8a 2a f1</code>. Now, each set of 4 bytes in decimal: <code>3035908141</code>, <code>1941483802</code>, <code>2743741169</code>. The resulting machine ID part of the SID is then: <code>3035908141-1941483802-2743741169</code>. Let&rsquo;s check in PowerShell:</p>
<p><img src="images/whoami-sam-machineid.png" alt="whoami-sam-machineid"></p>
<p>In the picture above with the registry window the green square ğŸŸ© shows the RIDs in hex. Given the RID one can deduce something about the user, since there are some users that have predefined RIDs:</p>
<ul>
<li><code>S-1-5-21-X-X-X-500</code> - default admin</li>
<li><code>S-1-5-21-X-X-X-501</code> - default guest</li>
<li><code>S-1-5-21-X-X-X-1000</code> - the first user created on a Windows 7 and below, <code>S-1-5-21-X-X-X-1001</code> - for newer systems</li>
<li><code>S-1-5-18</code> - System</li>
<li><code>S-1-5-3</code> - batch</li>
<li><code>S-1-5-2</code> - network</li>
<li><code>S-1-5-21-544</code> - local admin group</li>
</ul>
<p>On the previous picture we can see that the RID is <code>1000</code>, meaning it&rsquo;s the first user account (surprisingly not <code>1001</code> since it&rsquo;s a Windows 10 machine).</p>
<h3 id="rid-hijacking">RID hijacking</h3>
<p>System udentifies users by their RIDs (the last portion of SID), not by username. What happens if we have changed manually the RID of the guest user? Well, if we set it to <code>500</code>, the system would treat him as default admin with all the corresponding rights.</p>
<h2 id="local-security-authority-subsystem">Local Security Authority Subsystem</h2>
<p>Single Sign-on. LSA is its part. Responsible for authentication, authorisation. Manages <strong>derived</strong> credentials (NTLM, kerberos tickets, sessions, hashes etc).</p>
<p>Image file is located at <code>%WINDIR%\System32</code>.</p>
<h2 id="login-process">Login Process</h2>
<p>This is how a general picture looks like:</p>
<p><img src="images/mypic.jpg" alt="mypic"></p>
<p>Sorry for the dragon ğŸ‰.</p>
<h2 id="references">References</h2>
<p>[<a href="https://www.youtube.com/watch?v=hilLHF37ng8">1</a>] RID Hijaking by Sergey Klevogin, LPT Mater</p>
<p>[<a href="http://www.ijfcc.org/vol5/455-F005.pdf">2</a>] Analysis the Structure of SAM and Cracking Password Base on Windows Operating System, by Jiang Du and Jiwei Li</p>
<p>[<a href="https://www.youtube.com/watch?v=2Aa9_yq4BX4&amp;t=1s">3</a>] Ğ’Ğ½Ğ¸Ğ· Ğ¿Ğ¾ ĞºÑ€Ğ¾Ğ»Ğ¸Ñ‡ÑŒĞµĞ¹ Ğ½Ğ¾Ñ€Ğµ ĞºĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ LSA, Ğ¸Ğ»Ğ¸ ĞŸĞ¾Ğ´ ĞºĞ°Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ Windows,  ĞÑ€Ñ‚ĞµĞ¼ Ğ¡Ğ¸Ğ½Ğ¸Ñ†Ñ‹Ğ½</p>
<p>[<a href="https://www.youtube.com/watch?v=aCVdGUjP72Q">3</a>] Diving into Windows Logon Process</p>
<p>[<a href="https://docs.microsoft.com/en-us/windows-server/security/windows-authentication/credentials-processes-in-windows-authentication">4</a>]</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.1237ff71925bb8625c97a9af8db4c54525258bedfd7c47493daaff723bea755e.js"></script>
  

  
  
  
    
  


</body>

</html>
