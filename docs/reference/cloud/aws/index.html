<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📚 AWS Overview - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting 🪤">
      <a href="/docs/thunting">
        <span>Threat Hunting 🪤</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting 🪤">
      <a href="/docs/thunting">
        <span>Threat Hunting 🪤</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/reference/cloud/"> 👈🏼 Back to </br> 📚 Cloud </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#confusing-terms">Confusing Terms</a></li>
    <li><a href="#ids">IDs</a>
      <ul>
        <li><a href="#arn">ARN</a></li>
      </ul>
    </li>
    <li><a href="#terraform">Terraform</a></li>
    <li><a href="#vpc">VPC</a>
      <ul>
        <li><a href="#nacl">NACL</a></li>
        <li><a href="#security-group">Security Group</a></li>
        <li><a href="#nat">NAT</a></li>
        <li><a href="#vpc-flow-logs">VPC Flow Logs</a></li>
        <li><a href="#vpc-traffic-mirroring">VPC Traffic Mirroring</a></li>
        <li><a href="#aws-vpc-endpoints">AWS VPC Endpoints</a>
          <ul>
            <li><a href="#gateway">Gateway</a></li>
            <li><a href="#interface">Interface</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#elastic-ip">Elastic IP</a></li>
    <li><a href="#connection">Connection</a>
      <ul>
        <li><a href="#ssh--rdp">SSH / RDP</a></li>
        <li><a href="#vpn">VPN</a>
          <ul>
            <li><a href="#site-to-site-vpn">Site-to-Site VPN</a></li>
            <li><a href="#client-vpn">Client VPN</a></li>
            <li><a href="#vpn-cloudhub">VPN CloudHub</a></li>
            <li><a href="#custom">Custom</a></li>
          </ul>
        </li>
        <li><a href="#private-connections">Private Connections</a></li>
        <li><a href="#ssm">SSM</a></li>
      </ul>
    </li>
    <li><a href="#kms">KMS</a>
      <ul>
        <li><a href="#policies">Policies</a></li>
        <li><a href="#cloudhsm">CloudHSM</a></li>
        <li><a href="#-btfm">📘 BTFM</a></li>
      </ul>
    </li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">📚 AWS Overview</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p><em>Here I am collecting some information that is needed in order to understand what to look for in the cloud and where.</em></p>
<h2 id="confusing-terms">Confusing Terms</h2>
<p><strong>IAM</strong> - Identity Access Management. This is a service for creating users, groups, roles, permissions, policies.
Each individual using the AWS service needs to have a separate user in AWS associated with them. So, roughly speaking, user = person.
Each user can be in 1+ groups. Theoretically, a user can be not a part of any group, but when they are, it’s easier to manage access and permissions.
Policies are a list of permissions that can be assigned to a group, user, role. Can be created via JSON (raw) or GUI.
Groups have the same permissions defined by purposes.
Roles are assigned to services within AWS. Something similar to groups?</p>
<h2 id="ids">IDs</h2>
<h3 id="arn">ARN</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">arn:partition:service:region:account-id:resource-id
</span></span><span class="line"><span class="cl">arn:partition:service:region:account-id:resource-type/resource-id
</span></span><span class="line"><span class="cl">arn:partition:service:region:account-id:resource-type:resource-id
</span></span></code></pre></div><p><strong>Partition</strong>. There are just three of them: general (most likely to encounter), China 🇨🇳 and US Gov.</p>
<p><strong>Service</strong>. Can be <code>guardduty</code> for alert from GuardDuty, or <code>iam</code> or <code>sts</code> or any other service.</p>
<p><code>Region</code>, <code>Account-ID</code> and <code>Resource-ID</code>. Pretty self-explanatory.</p>
<h2 id="terraform">Terraform</h2>
<p>Most of the things can be and usually prefered to be configured via Terraform. It&rsquo;s usually refered to as &ldquo;Infrastructure as code&rdquo;, which basically means that you can &ldquo;code&rdquo; the way your infrastructure is built and with what permissions. For example, you can either create an EC2 instance via GUI in AWS Console, or use aws CLI for that or you can do this via Terraform. The latter option allows better managements, transparancy and, of course, automation.</p>
<p>Following the advice of the instructor from Udemy (see reference below), I&rsquo;ve used Visual Studio (which I usually use for scripting) with a HashiCorp Terraform plugin installed. To install terraform itself follow the instructions here - <a href="https://learn.hashicorp.com/tutorials/terraform/install-cli">https://learn.hashicorp.com/tutorials/terraform/install-cli</a>. Good tutorials are available for free on the Terraform&rsquo;s website as well: <a href="https://learn.hashicorp.com/tutorials/terraform/aws-build?in=terraform/aws-get-started">https://learn.hashicorp.com/tutorials/terraform/aws-build?in=terraform/aws-get-started</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">category</span> <span class="s2">&#34;subcategory&#34;</span> <span class="s2">&#34;some_randomname&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="err">mandatory_stuff</span> <span class="err">=</span> <span class="nt">&#34;your value 1&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="err">another_optional_stuff</span> <span class="err">=</span> <span class="s2">&#34;your value 2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">resource</span> <span class="s2">&#34;google_storage_bucket&#34;</span> <span class="s2">&#34;assets&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> 	<span class="err">name</span> <span class="err">=</span> <span class="nt">&#34;sec510-assets-${var.UniqueString}&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">provider</span> <span class="s2">&#34;aws&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="err">region</span> <span class="err">=</span> <span class="nt">&#34;eu-west-2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">resource</span> <span class="s2">&#34;aws_instance&#34;</span> <span class="s2">&#34;ec2&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="err">ami</span> <span class="err">=</span> <span class="nt">&#34;ami-12390843958&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="err">instance_type</span> <span class="err">=</span> <span class="s2">&#34;t2.micro&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The suggested workflow would be to store <code>tf</code> files (terraform proprietary format) on git (for version control).</p>
<h2 id="vpc">VPC</h2>
<p>The main concern is that something provate can be poked from the outside. There are several controls in place to avoid this and following the best practicies of Defense-in-Depth policy we are better to leverage all of them properly. But the bigger the organization becomes, the harder it gets to configure everything correctly. Default VPC is very lax. Therefore, it should not be used for anything more serious than I personal blog or lab exercises and stuff like that.</p>
<p>For something to be publicly availble, a Internet Gateway is required.</p>
<h3 id="nacl">NACL</h3>
<p>Network Access Control list. Whever there is a match, further list trversal is ceised. Traffic restrictions are determined by both the NACL (which is overly permissive for the default VPC) and a security group (see the next subsection).</p>
<blockquote>
<p>⚠️ Important note! NACL are stateless, which means that if the request was allowed to pass through, the response might not be if it was not configured. Rules are evaluated in order until a match is found (allow or deny) and the remaining rules in the list are skipped.</p>
</blockquote>
<h3 id="security-group">Security Group</h3>
<p>For default EC2 security group (presuming no changes were made when deploying it) all ingress traffic will be blocked. When EC2 is greated via CLI, it&rsquo;s less &ldquo;open-minded&rdquo; and allows less crap 💩 to flow through. Default security group (ingress all from the same sec group, egress allow traffic on all ports) != default EC2 security group.</p>
<blockquote>
<p>⚠️ Important note!
By default, security groups, do not allow any ingress and allow all egress traffic. Anything that was not specified, is <strong>denied by default</strong>.
Security groups are stateful. So, if the request has passed through, the response will as well. Moreover, all rules are evaluted before decision is made. If there are some conflicting rules, then, the most permissive will get the medal 🥇.</p>
</blockquote>
<blockquote>
<p>❓ How rules are evaluated after NACL and SG specific are evaluated?</p>
</blockquote>
<h3 id="nat">NAT</h3>
<p>A NAT gateway is a Network Address Translation (NAT) service. You can use a NAT gateway so that instances in a private subnet can connect to services outside your VPC but external services cannot initiate a connection with those instances. Can be public (for the internet) or private (between VPCs).
<a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/nat_gateway">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/nat_gateway</a>
<a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html">https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html</a>
NAT is not required for completely private network and private endpoints. All this access is managed by policies and role-based access controls.</p>
<h3 id="vpc-flow-logs">VPC Flow Logs</h3>
<p>If these are enabled, you will be able to tell, who connected to what resource and when. Flow Logs are not enabled by default. It&rsquo;s not the same as pcap file! It doesn&rsquo;t provide full packet info. Just statistics, addresses, ports, result (accept/reject).</p>
<p>Logs are sent then either to the CloudWatch or S3 (depending on the configuration). An IAM role needs to be created prior to that. Here are the minimum requirements for the CloudWatch role: CreateLogGroup, CreateLogStream, PutLogEvents, DescribeLogGroups, DescribeLogStreams need to beallowed for all resources. To be able to assume this role, VPC Flow Logs service needs to have its own policy where <code>&quot;service&quot;:&quot;vpc-flow-logs.amazonaws.com&quot;</code> is set to allow <code>AssumeRole</code> action. See <a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs-cwl.html">here</a> for more details.</p>
<p>Log <a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html#flow-log-records">breakthrough</a>. Looks like a simple string with a space as a delimiter. Each field has its place within the string.</p>
<h3 id="vpc-traffic-mirroring">VPC Traffic Mirroring</h3>
<p>A great idea to use. Deploying an EC2 with some IDS, mirror traffic there for detection. Filter for the most relevant stuff to pass it to SIEM?</p>
<h3 id="aws-vpc-endpoints">AWS VPC Endpoints</h3>
<p>By default, even private VPCs will talk over the Intenet, raising unneccessary interest of the attackers. VPC Endpoints are used in order to establish a connection for separate VPCs without exposing themselves to the public.</p>
<p><a href="https://www.linkedin.com/pulse/aws-interface-endpoint-vs-gateway-alex-chang/">https://www.linkedin.com/pulse/aws-interface-endpoint-vs-gateway-alex-chang/</a>
<a href="https://aws.amazon.com/blogs/architecture/choosing-your-vpc-endpoint-strategy-for-amazon-s3/">https://aws.amazon.com/blogs/architecture/choosing-your-vpc-endpoint-strategy-for-amazon-s3/</a></p>
<h4 id="gateway">Gateway</h4>
<p>Free to use. Dynamo and S3 use this type of endpoint. Reside within the VPC globally.</p>
<h4 id="interface">Interface</h4>
<p>Using static IP. Reside inside the subnet (which is inside the VPC). Costs something. Below example is for a S3 service.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">resource</span> <span class="s2">&#34;aws_vpc_endpoint&#34;</span>   <span class="s2">&#34;owlmailbucket&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">vpc_id</span> <span class="err">=</span> <span class="err">aws_vpc.hogwarts.id</span> <span class="err">#</span> <span class="err">this</span> <span class="err">is</span> <span class="err">some</span> <span class="err">AWS</span> <span class="err">VPC</span> <span class="err">called</span> <span class="err">app.</span> <span class="err">Should</span> <span class="err">have</span> <span class="err">been</span> <span class="err">created</span> <span class="err">prior</span> <span class="err">to</span> <span class="err">this</span> <span class="err">doc</span>
</span></span><span class="line"><span class="cl">    <span class="err">service_name</span> <span class="err">=</span> <span class="nt">&#34;com.amazonaws.${local.region}.owlmail&#34;</span> <span class="err">#</span> <span class="err">from</span> <span class="err">Terraform</span><span class="p">,</span> <span class="err">looks</span> <span class="err">like</span> <span class="err">it&#39;s</span> <span class="err">a</span> <span class="err">common</span> <span class="err">practice</span>
</span></span><span class="line"><span class="cl">    <span class="err">vpc_endpoint_type</span> <span class="err">=</span> <span class="nt">&#34;Interface&#34;</span> <span class="err">#</span> <span class="err">self-explanatory</span>
</span></span><span class="line"><span class="cl">    <span class="err">subnet_ids</span> <span class="err">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                 <span class="err">aws_subnet.harrypotter.id</span><span class="p">,</span> <span class="err">#</span> <span class="err">(Optional)</span> <span class="err">The</span> <span class="err">ID</span> <span class="err">of</span> <span class="err">one</span> <span class="err">or</span> <span class="err">more</span> <span class="err">subnets</span> <span class="err">in</span> <span class="err">which</span> <span class="err">to</span> <span class="err">create</span> <span class="err">a</span> <span class="err">network</span> <span class="err">interface</span> <span class="err">for</span> <span class="err">the</span> <span class="err">endpoint.</span>
</span></span><span class="line"><span class="cl">                 <span class="err">aws_subnet.siriusblack.id</span> <span class="err">#</span> <span class="err">So</span><span class="p">,</span> <span class="err">that</span> <span class="err">means</span><span class="p">,</span> <span class="err">hey</span><span class="p">,</span> <span class="err">I&#39;ve</span> <span class="err">created</span> <span class="err">an</span> <span class="err">interface</span> <span class="err">which</span> <span class="err">subnet</span> <span class="err">harrypotter</span> <span class="err">and</span> <span class="err">siriusblack</span> <span class="err">can</span> <span class="err">use</span>
</span></span><span class="line"><span class="cl">                 <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="err">security_group_ids</span> <span class="err">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="err">aws_security_group.owlmail.id</span> <span class="err">#</span> <span class="err">For</span> <span class="err">Interface</span> <span class="err">only</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="err">private_dns_enabled</span> <span class="err">=</span> <span class="kc">true</span> <span class="err">#</span> <span class="err">Whether</span> <span class="err">or</span> <span class="err">not</span> <span class="err">to</span> <span class="err">associate</span> <span class="err">a</span> <span class="err">private</span> <span class="err">hosted</span> <span class="err">zone</span> <span class="err">with</span> <span class="err">the</span> <span class="err">specified</span> <span class="err">VPC.</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">##</span> <span class="err">INTEFRACEE</span> <span class="err">ENDPOINT,</span> <span class="err">require</span> <span class="err">private</span> <span class="err">access,</span> <span class="err">restrict</span> <span class="err">access</span> <span class="err">to</span> <span class="mi">1</span> <span class="err">VPC</span>
</span></span><span class="line"><span class="cl"><span class="err">##</span> <span class="err">Interface</span> <span class="err">policy</span>
</span></span><span class="line"><span class="cl"><span class="err">data</span> <span class="s2">&#34;aws_iam_policy_document&#34;</span> <span class="s2">&#34;owlmailpolicy&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">statement</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">actions</span> <span class="err">=</span> <span class="err">[</span><span class="nt">&#34;owlmail:GetEncryptedMessage&#34;</span><span class="err">]</span>
</span></span><span class="line"><span class="cl">    <span class="err">resources</span> <span class="err">=</span> <span class="err">*</span>
</span></span><span class="line"><span class="cl">    <span class="err">effect</span> <span class="err">=</span> <span class="s2">&#34;Allow&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="err">condition</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="err">test</span> <span class="err">=</span> <span class="nt">&#34;StringEquals&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="err">variable</span> <span class="err">=</span> <span class="s2">&#34;aws:SourceVpc&#34;</span> <span class="err">#</span> <span class="err">only</span> <span class="err">allow</span> <span class="err">messages</span> <span class="err">from</span> <span class="err">a</span> <span class="err">specified</span> <span class="err">VPC</span>
</span></span><span class="line"><span class="cl">      <span class="err">values</span> <span class="err">=</span> <span class="p">[</span><span class="err">aws_vpc.hogwarts.id</span><span class="p">]</span> <span class="err">#</span> <span class="err">this</span> <span class="err">is</span> <span class="err">the</span> <span class="err">VPC</span> <span class="err">mentioned</span> <span class="err">above</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">##</span> <span class="err">SECURITY</span> <span class="err">GROUP</span>
</span></span><span class="line"><span class="cl"><span class="err">resource</span> <span class="s2">&#34;aws_security_group&#34;</span> <span class="s2">&#34;owlmailsg&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="err">name</span> <span class="err">=</span> <span class="nt">&#34;owlmail&#34;</span>
</span></span><span class="line"><span class="cl"><span class="err">description</span> <span class="err">=</span> <span class="s2">&#34;Sec group to for Owl Main VPC endpoint&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="err">vpc_id</span> <span class="err">=</span> <span class="err">aws_vpc.hogwarts.id</span> <span class="err">#</span> <span class="err">specify</span> <span class="err">the</span> <span class="err">id</span> <span class="err">of</span> <span class="err">a</span> <span class="err">Hogwarts</span> <span class="err">VPC</span> <span class="err">which</span> <span class="err">was</span> <span class="err">created</span> <span class="err">earlier</span>
</span></span><span class="line"><span class="cl"><span class="err">ingress</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">description</span> <span class="err">=</span> <span class="nt">&#34;HTTPS from the subnet containing the EC2 instance&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="err">from_port</span> <span class="err">=</span> <span class="mi">443</span>
</span></span><span class="line"><span class="cl">    <span class="err">to_port</span> <span class="err">=</span> <span class="mi">443</span>
</span></span><span class="line"><span class="cl">    <span class="err">protocol</span> <span class="err">=</span> <span class="s2">&#34;tcp&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="err">cidr_blocks</span> <span class="err">=</span> <span class="p">[</span><span class="err">aws_subnet.wholeuk.cidr_block</span><span class="p">]</span> <span class="err">#</span> <span class="err">only</span> <span class="err">allow</span> <span class="err">inbound</span> <span class="err">traffic</span> <span class="err">over</span> <span class="err">TCP</span><span class="p">:</span><span class="mi">443</span> <span class="err">from</span> <span class="err">the</span> <span class="err">IP</span> <span class="err">range</span> <span class="err">that</span> <span class="err">the</span> <span class="err">application</span> <span class="err">we</span> <span class="err">want</span> <span class="err">to</span> <span class="err">allow</span> <span class="err">is</span> <span class="err">residing</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>However, one can create a custom endpoint. For this to work, they need to set up a NLB to accept and pass the traffic to this service and the endpoint config above would also have to specify this NLB to use. IAM permissions can be used to restrict creation of these endpoints.</p>
<p>In order to understand this thing more, I&rsquo;ve come up with an analogy. Imagine, there is a bank you&rsquo;d like to use (not HSBC, probably 😣). You can&rsquo;t just use it like this. It&rsquo;s like the AWS private service. You need to have something in order to use it. So, you sign an agreement, install an application and now - voila! Application that you install (or a website that you would use for your transactions) are these endpoints. One little fault in this analogy is that this communication is performed over the public Internet whereas AWS endpoint allow totally isolated traffic.</p>
<h2 id="elastic-ip">Elastic IP</h2>
<p>Weird enough, but it means static IP.</p>
<h2 id="connection">Connection</h2>
<h3 id="ssh--rdp">SSH / RDP</h3>
<p>AWS (as well as other cloud providers), allow SSH Access over the web. This way one doesn&rsquo;t need to open the ports to the outside world. Browser-based SSH connections can be controlled from inside. This allows to apply strict access control through IAM and also this activity is logged.</p>
<h3 id="vpn">VPN</h3>
<p>If the organization uses a VPN in order to connect, an investigator will need the VPN logs as well (IPsec or OpenVPN).</p>
<h4 id="site-to-site-vpn">Site-to-Site VPN</h4>
<p>On-premise -&gt; AWS over IPSec and virtual private GW. Tunnel is established. More <a href="https://docs.aws.amazon.com/vpn/latest/s2svpn/VPC_VPN.html">here</a>.</p>
<h4 id="client-vpn">Client VPN</h4>
<p>OpenVPN over TLS. Worstations and mobile phones connect to a cloud-hosted VPC. One needs to create a cert for a client and for the server and upload it to ACM. Create VPN endpoint and link to a VPC. Download OpenVPN config file.</p>
<h4 id="vpn-cloudhub">VPN CloudHub</h4>
<p>Multiple remote networks connect to a single private GW.</p>
<h4 id="custom">Custom</h4>
<p>Host their own VPN on EC2 instances. For example, Pritnl.</p>
<h3 id="private-connections">Private Connections</h3>
<p>Dedicated fibers that connect client data centers and AWS infrastructure. Traffic never goes to the Internet.</p>
<h3 id="ssm">SSM</h3>
<p>AWS Systems Manager. The session manager allows IAM to connect tro EC2 instances. No need to have a bastion host, or open 22 port for SSH or desktop gw. Instead a principal (entity) can call <code>ssm:StartSession</code> action. Captured by CloudTrail logs.</p>
<h2 id="kms">KMS</h2>
<p>Multi-tenany Hardware Security Applicance (HSM). Keys never leave the HSM-domain, like with the Keychain, encryption and decryption happen without providing the key to the client.</p>
<p>RDS and EBS require disk-level encryption at rest.</p>
<p><img src="images/hsm-master-keys.png" alt="img">
Keys can be deleted (in 7 days after the request) or deactivated. Deletion is detructive. Data won&rsquo;t be restorable once the key is deleted.</p>
<p>CMK (Customer Master Key) - meta of the key, the key itself is inside the KMS infra.
DK (Data Key) - keys for data enctyption.
Encryption context - custom tags in logs which restrict key usage.</p>
<p>Remember the book, <em>Eine Woche voller Samstage</em>, where this director that was depicted as a total freak (who hid a key in a sock -&gt; boot -&gt; wardrobe -&gt; drawer -&gt; key from the drawer etc)? If you have never read this book, better do so now, it&rsquo;s a true masterpiece. So, when you look at encryption mechanisms implemented in our modern digital world, this stops being so funny because it&rsquo;s what it looks like now.</p>
<p>In this case, data is encrypted by DK (or DEK) which are stored in HSM where they are protected by CMK, which is duplicated and protected by the domain key elsewhere. Besides, you won&rsquo;t see this DK as well, it&rsquo;s in HSM. Theoretically, you can use a CMK to encrypt application data that is &lt;= 4KB via <code>aws kms encrypt</code> but it&rsquo;s just nuts. Don&rsquo;t do that, it&rsquo;s weird. Like eating soup with a teaspoon.</p>
<p><em>Envelope encryption</em> is what they call all this encryption mess.</p>
<p>By default it&rsquo;s symmetric encryption.</p>
<h3 id="policies">Policies</h3>
<p>You can restrict key usage with either principal-based policies or resource-based policies on a key-by-key basis. The second option is recommended.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">resource</span> <span class="s2">&#34;aws_kms_key&#34;</span> <span class="s2">&#34;owlmailbucket&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="err">description</span> <span class="err">=</span> <span class="nt">&#34;Used for Hogwarts secret mail storage&#34;</span> 
</span></span><span class="line"><span class="cl">	<span class="err">customer_master_key_spec</span> <span class="err">=</span> <span class="s2">&#34;SYMMETRIC_DEFAULT&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="err">policy</span> <span class="err">=</span> <span class="err">data.aws_iam_policy_document.owlmailpolicy.json</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">resource</span> <span class="s2">&#34;owlmailbucket&#34;</span> <span class="s2">&#34;s3&#34;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">	<span class="err">name</span> <span class="err">=</span> <span class="nt">&#34;${var.UniqueString}/database&#34;</span> 
</span></span><span class="line"><span class="cl">	<span class="err">kms_key_id</span> <span class="err">=</span> <span class="err">aws_kms_key.owlmailbucket.key_id</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Using a principal-based policy is not a good idea. Resource-based is better. I guess, since it&rsquo;s easier to manage.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;Effect&#34;</span><span class="p">:</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;Action&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;kms:&lt;required actions listed&gt;&#34;</span><span class="p">],</span> 
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;Resource&#34;</span><span class="p">:</span> <span class="s2">&#34;*&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;Principal&#34;</span><span class="p">:</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;AWS&#34;</span><span class="p">:</span> <span class="s2">&#34;arn:aws:iam::01234567890:user/siriusadmin&#34;</span> 
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">},</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Effect&#34;</span><span class="p">:</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Action&#34;</span><span class="p">:</span> <span class="s2">&#34;kms:Decrypt&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Resource&#34;</span><span class="p">:</span> <span class="s2">&#34;*&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Principal&#34;</span><span class="p">:</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;AWS&#34;</span><span class="p">:</span> <span class="s2">&#34;arn:aws:iam::012345678901:role/useroftheowlmail&#34;</span> 
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Condition&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="nt">&#34;StringEquals&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;kms:CallerAccount&#34;</span><span class="p">:</span> <span class="s2">&#34;012345678901&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="nt">&#34;kms:ViaService&#34;</span><span class="p">:</span> <span class="s2">&#34;owlmailbucket.&lt;Region&gt;.amazonaws.com&#34;</span>
</span></span><span class="line"><span class="cl">	    <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">]</span>    
</span></span></code></pre></div><ol>
<li>
<p>Gives the cloudsecurity IAM user permission to administrate the key. This is necessary for our Terraform deployment and teardown script to function properly. The list of actions the actual policy lists is: kms:Update*, kms:ScheduleKeyDeletion, kms:Revoke*, kms:Put*, kms:List*, kms:Get*, kms:GenerateDataKey, kms:Encrypt, kms:Enable*, kms:Disable*, kms:Describe*, kms:Delete*, kms:Decrypt, kms:Create*, and kms:CancelKeyDeletion</p>
</li>
<li>
<p>Grants the IAM role used by our EC2 instance profile the ability to decrypt data with this key, but only if the request is made via the Secrets Manager service in our AWS account.</p>
</li>
</ol>
<h3 id="cloudhsm">CloudHSM</h3>
<p>Basically, it&rsquo;s provate HSM. Otherwise, CMKs of different companies are stored in one HSM place.</p>
<h3 id="-btfm">📘 BTFM</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">aws kms list-keys --profile ProfileName <span class="c1"># if it&#39;s sso</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># lists KeyId and KeyArn for each key</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="k">$(</span>aws kms list-aliases --profile ProfileName<span class="k">)</span> <span class="p">|</span> jq 
</span></span><span class="line"><span class="cl"><span class="c1"># lists AliasName, AliasArn and TargetKeyId</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># get the resource-based policy associated with this key</span>
</span></span><span class="line"><span class="cl">aws kms list-key-policies --profile ProfileName --key-id <span class="k">$(</span>aws kms describe-key --key-id alias/test-trail --profile ProfileName <span class="p">|</span> jq -r <span class="s1">&#39;.KeyMetadata.KeyId&#39;</span><span class="k">)</span>
</span></span></code></pre></div><p>My bash script to check for resource-based policies associated with a key (mind that it&rsquo;s adjusted to SSO login instead of <code>aws configure</code> credentials):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="k">for</span> keyname in <span class="k">$(</span>aws kms list-aliases --profile ProfileName <span class="p">|</span> jq -r <span class="s1">&#39;.Aliases[].AliasName&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nv">key_id</span><span class="o">=</span><span class="k">$(</span>aws kms describe-key --key-id <span class="nv">$keyname</span> --profile ProfileName <span class="p">|</span> jq -r <span class="s1">&#39;.KeyMetadata.KeyId&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;For key \e[92m</span><span class="nv">$keyname</span><span class="s2">\e[0m with id=</span><span class="nv">$key_id</span><span class="s2"> the policies in use are:&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;\e[96m</span><span class="k">$(</span>aws kms list-key-policies --key-id <span class="nv">$key_id</span> --profile ProfileName<span class="k">)</span><span class="s2">\e[0m&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;=======================&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></div><p>If you see nothing but the following</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;PolicyNames&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>It means that there either are no policies associated or there is some identity-based policy assigned. Let&rsquo;s check with idetity policies.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="k">for</span> rolename in <span class="k">$(</span>aws iam list-roles --profile ProfileName <span class="p">|</span> jq -r <span class="s1">&#39;.Roles[].RoleName&#39;</span> <span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span> 
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;For role \e[92m</span><span class="nv">$rolename</span><span class="s2">\e[0m the policy is: &#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;\e[96m</span><span class="k">$(</span>aws iam list-attached-role-policies --role-name <span class="nv">$rolename</span> --profile ProfileName<span class="k">)</span><span class="s2">\e[0m&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></div><p>Then, for the policy in question (get the <code>PolicyArn</code> from the output above):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">aws iam get-policy-version --profile ProfileName --policy-arn PolicyArn --version-id v1
</span></span></code></pre></div><p>And even better, which policies have kms permissions:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="k">for</span> rolename in <span class="k">$(</span>aws iam list-roles --profile ProfileName <span class="p">|</span> jq -r <span class="s1">&#39;.Roles[].RoleName&#39;</span> <span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span> 
</span></span><span class="line"><span class="cl">    <span class="k">for</span> policy_arn in <span class="k">$(</span>aws iam list-attached-role-policies --role-name <span class="nv">$rolename</span> --profile ProfileName <span class="p">|</span> jq -r <span class="s1">&#39;.AttachedPolicies[].PolicyArn&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="nv">policy</span><span class="o">=</span><span class="k">$(</span>aws iam get-policy-version --profile ProfileName --policy-arn <span class="nv">$policy_arn</span> --version-id v1<span class="k">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$policy</span><span class="s2">&#34;</span> <span class="p">|</span> grep -q <span class="s2">&#34;kms&#34;</span><span class="p">;</span> <span class="k">then</span> 
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;\e[92m</span><span class="nv">$rolename</span><span class="s2">\e[0m has KMS permissions:&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;\e[96m</span><span class="k">$(</span>aws iam get-policy-version --profile ProfileName --policy-arn <span class="nv">$policy_arn</span> --version-id v1 <span class="p">|</span> jq<span class="k">)</span><span class="s2">\e[0m&#34;</span> 
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></div><p>Retrieve CloudWatch event for each key:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">loggroupname</span><span class="o">=</span><span class="s2">&#34;log_group_name&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> keyname in <span class="k">$(</span>aws kms list-aliases --profile ProfileName <span class="p">|</span> jq -r <span class="s1">&#39;.Aliases[].AliasName&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;keyname is </span><span class="nv">$keyname</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">key_arn</span><span class="o">=</span><span class="k">$(</span>aws kms describe-key --key-id <span class="nv">$keyname</span> --profile ProfileName <span class="p">|</span> jq -r <span class="s1">&#39;.KeyMetadata.Arn&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Key ARN is </span><span class="nv">$key_arn</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">query_id</span><span class="o">=</span><span class="k">$(</span>aws logs --profile ProfileName start-query --log-group-name <span class="nv">$loggroupname</span> --start-time <span class="m">1655588640</span> --end-time <span class="m">1659109342</span> --query-string <span class="s2">&#34;FIELD eventTime, userIdentity.userName, sourceIPAddress | SORT eventTime DESC | FILTER eventName = &#39;Decrypt&#39; AND resources.0.ARN = &#39;</span><span class="nv">$key_arn</span><span class="s2">&#39;&#34;</span> <span class="p">|</span> jq -r <span class="s1">&#39;.queryId&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    sleep <span class="m">30</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="k">$(</span>aws logs --profile ProfileName get-query-results --query-id <span class="nv">$query_id</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></div>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
