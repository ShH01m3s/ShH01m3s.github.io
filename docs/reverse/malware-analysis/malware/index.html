<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶† Malware Analysis - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ü™§">
      <a href="/docs/thunting">
        <span>Threat Hunting ü™§</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ü™§">
      <a href="/docs/thunting">
        <span>Threat Hunting ü™§</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/reverse/malware-analysis/"> üëàüèº Back to </br> Malware Analysis ü¶†  </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#malware-databases">Malware Databases</a>
      <ul>
        <li><a href="#repos">Repos</a></li>
        <li><a href="#info">Info</a></li>
        <li><a href="#network">Network</a></li>
      </ul>
    </li>
    <li><a href="#general-guidelines">General Guidelines</a>
      <ul>
        <li><a href="#malware-evasion-techniques">Malware Evasion Techniques</a></li>
        <li><a href="#throubleshooting-malware">Throubleshooting malware</a></li>
      </ul>
    </li>
    <li><a href="#macos">macOS</a>
      <ul>
        <li><a href="#quarantine-files">Quarantine files</a></li>
      </ul>
    </li>
    <li><a href="#windows">Windows</a>
      <ul>
        <li><a href="#av-logs">AV Logs</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">ü¶† Malware Analysis</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      
      <div class="article-category">
          
            
            
            
            
            
              <i class="fab fa-linux"></i>&nbsp;<i class="fab fa-apple"></i>&nbsp;<i class="fab fa-windows"></i>&nbsp;<i class="fas fa-mobile"></i>
            
            
          
          
      </div> <br />
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <h2 id="malware-databases">Malware Databases</h2>
<h3 id="repos">Repos</h3>
<ul>
<li>theZoo:¬†<a href="https://github.com/ytisf/theZoo">https://github.com/ytisf/theZoo</a></li>
<li>VXUnderground GitHub repo:¬†<a href="https://github.com/vxunderground/MalwareSourceCode">https://github.com/vxunderground/MalwareSourceCode</a></li>
<li>Zeltser Resources:¬†<a href="https://zeltser.com/malware-sample-sources/">https://zeltser.com/malware-sample-sources/</a></li>
<li></li>
</ul>
<h3 id="info">Info</h3>
<p><a href="https://www.hybrid-analysis.com/sample/9fe55c51af6230c8640e140104645b32ba83ac868bf0f1571733f14761701247">https://www.hybrid-analysis.com/sample/9fe55c51af6230c8640e140104645b32ba83ac868bf0f1571733f14761701247</a>
<a href="https://www.f-secure.com/v-descs/trojan-spy_w32_finspy_a.shtml">https://www.f-secure.com/v-descs/trojan-spy_w32_finspy_a.shtml</a>
<a href="https://malshare.com/">https://malshare.com/</a></p>
<p>Malicious websites: <a href="https://zeltser.com/lookup-malicious-websites/">https://zeltser.com/lookup-malicious-websites/</a></p>
<p><a href="https://mail.google.com/mail/u/0/#inbox">https://mail.google.com/mail/u/0/#inbox</a></p>
<p>My <a href="https://peat-chameleon-e41.notion.site/Malware-DB-25248c9f91bd49b8ba0e869f465f626a">own</a> is maintained in Notion for now. Planning to turn this into a SQL DB + CLI.</p>
<h3 id="network">Network</h3>
<p><a href="https://malware-traffic-analysis.net">https://malware-traffic-analysis.net</a>
<a href="https://packettotal.com/malware-archive.html">https://packettotal.com/malware-archive.html</a></p>
<h2 id="general-guidelines">General Guidelines</h2>
<p><strong>Signed executable</strong>. It&rsquo;s a rare case, but it exists. Around 3% of malware is <strong>signed</strong>. It&rsquo;s due to the fact that some systems require executables to be signed. But this technique is not very good for malware authors since when at least one &ldquo;product&rdquo; is marked as malicious, all code that was signed with the same certificate will be identified as well. üõ† Use <code>sigcheck</code> to check signatures and hashes against Virus Total.</p>
<p>Check with a <code>spctl</code> if the given application (not yet installed) is notarized by Apple.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">spctl -a -vvv -t install /Volumes/BurpSuitePro/Burp<span class="se">\ </span>Suite<span class="se">\ </span>Professional.app 
</span></span><span class="line"><span class="cl">/Volumes/BurpSuitePro/Burp Suite Professional.app: accepted
</span></span><span class="line"><span class="cl"><span class="nv">source</span><span class="o">=</span>Notarized Developer ID
</span></span><span class="line"><span class="cl"><span class="nv">origin</span><span class="o">=</span>Developer ID Application: PortSwigger Ltd <span class="o">(</span>N82YM897DZ<span class="o">)</span>
</span></span></code></pre></div><p><strong>Strings</strong>. Check <strong>strings</strong> in <code>Image</code> and in <code>Memory</code> using the corresponding radio button on the <code>Strings</code> tab of a selected process info in Process Explorer. If they differ - process replacement tool place. Use üõ† <code>strings</code> or <code>floss</code> (decodes them as well)</p>
<p>Interesting strings:</p>
<ul>
<li><code>pdb</code> files (often contain username and can also give a hint on the malware writer&rsquo;s country of origin)</li>
<li>URLs</li>
<li>Something that looks like a password</li>
<li>emails</li>
<li>Base64 encoded things</li>
<li>library names</li>
</ul>
<p><strong>32 bit application.</strong> For backward compatibility for older machines, malware authors prefer compiling 32bit applications. Since malware authors usually want their software to work on as many machines as possible, they often compile <strong>32bit code</strong>. That&rsquo;s not a decent indicator by itself, but it&rsquo;s a good additional score.</p>
<p><strong>Location</strong>. It might be atypical location for <code>svchost.exe</code> in Documents forlder. You&rsquo;ll need to know what&rsquo;s ok and good for the given system. May user SANS poster <em>Find Evil</em>. Common locations for malware: <code>Windows\System32</code> is a very important location since it allows running with elevated privileges? ‚ùì‚ùì‚ùìAlso <code>Temp</code> folder and <code>Temp Internet Files</code>. <code>Windows</code>, <code>Windows SxS</code>. Recycle bin also may contain some files or remnants. <code>Program files</code> is the most usual for programs and malware may reside there as well.<code>System Volume Information</code>. That doesn&rsquo;t mean, however, that malware can&rsquo;t be elsewhere. Some core Windows executables don&rsquo;t even have an image file on disk (System, IDLE, for example).</p>
<p><strong>Suspicious time</strong>. Created at suspicious time? Launch time suspicious?</p>
<p><strong>Suspicious name</strong>. For example, name exactly like or very similar to some core system process? Strange name similar to leg one? <code>svchosts</code>, for example. Present in <code>psscan</code> but absent in <code>pslist</code> (for running processes)? Read more about RAM forensics in the corresponding section. It&rsquo;s usual for malware to mistype the names if common wincore processes or use the same names in weird locations. Name mangling is a common technique.</p>
<p><strong>Signs of reconnaissance stage</strong>.</p>
<p><strong>Runtime linking</strong>. Since static linking is rare (it increases the body of a program) and dynamicly linked functions can be inspected in different ways, runtime linking might be a choice for malware authors to hide the functionality. How to determine if the runtime linking is used?<em>‚ùìWindows, Mac, Linux?</em> <strong>Importing</strong> and using <code>GetProcessAddress</code>/<code>LdrGetProcessAddress</code> or/and <code>LoadLibrary</code>/<code>LdrLoadDll</code>.</p>
<p><strong>Packed executables</strong>. Almoust 100% indicator that the author didn&rsquo;t want his treasure to be reverse engineered. Why could this be? Because it&rsquo;s some software with a portion of client-side code that performs sensitive operations. One example of a legitimate software is a program that generates OTP codes. There are several ways to determine that a file is packed. The first one - using enthropy analysis against the file. Consider, that most program epilogues start with <code>55 8B EC</code> (<code>push ebp mov ebp, esp</code>) and end with <code>c3</code> (<code>ret</code>).  That means that the number of both in one executable should be relatively the same. Compressed files don&rsquo;t compress well. Another example is to pack the file and determine, how efficiently was it packed. If it wasn&rsquo;t possible to pack the file too much, it&rsquo;s probable that the file is already packed. üõ† Use the first method with <a href="https://www.aldeid.com/wiki/PEiD">PEiD</a> (GUI Windows tool), use the second method with <code>densityscan</code> (commercial cross-platform tool). Below are some common preliminary indicators of packed executables:</p>
<ul>
<li><input disabled="" type="checkbox"> <strong>VA vs PA</strong>. Empty Physical addresses for sections (while VA are not empty). More about virtual and physical addresses in the reverse engineering section.</li>
<li><input disabled="" type="checkbox"> Weired names for <strong>PE sections</strong>. PE sections (for Windows) are usually <code>text</code>, <code>bss</code>, <code>data</code> etc. If you some gibberish that&rsquo;s not usually seen here, most likely the executable is packed.</li>
</ul>
<p><strong>Hash</strong>. The first and dummiest way, but highly suggested is to check the file hash against VirusTotal database. This way you&rsquo;ll eliminate <strong>known good</strong> files, since it&rsquo;s highly unlikely that a legitimate software like Windows files have never been checked so far. Also, this way you can find <strong>known bad</strong>.</p>
<p><strong>Byte-level signatures.</strong> May be you have some signatures left from previous malware.</p>
<p><strong>Name</strong>. In order to spot deviations at that point you need to have a firm understanding of what&rsquo;s normal for that particular system. There are some common &ldquo;normalities&rdquo; for different OSes, of course, as well. You can refer to SANS poster &ldquo;Find Evil&rdquo; which is often updated, SDF Podcast of Michael Leclair about Windows Core Processes, or find the corresponding article about core processes and system supernova in the Technical Reference section of this website.</p>
<p><strong>Unexpected owners</strong>. Check the account it being run from. The most commonly used are: local system account, network service account, local service account. If any of the core processes is run from a user account, it&rsquo;s a possible sign of compromise. üë£ <strong>For Windows</strong>:</p>
<p><strong>Unexpected parent</strong>. Each executable is run by some other executable. For core processes there is only one legitimate parent. üë£ <strong>For Windows</strong>: <code>wininit</code> doesn&rsquo;t have a parent, while <code>sms.exe</code> is the child of System. Read more about core processes for each specific OS in a separate section.</p>
<p><strong>Hidden by WinAPI</strong>.</p>
<p><strong>Process taken over</strong>. <a href="https://www.linkedin.com/pulse/process-injection-detection-malfind-britton-manahan/">https://www.linkedin.com/pulse/process-injection-detection-malfind-britton-manahan/</a></p>
<p><strong>On-disk and in-memory contents don&rsquo;t match</strong>.</p>
<p><strong>Unusual behaviour and resources</strong>. Suspicious files opened, netwrk ports and connections, OS resources (mutexes, hooks etc), significant amount of CPU or RAM? <code>.rsrc</code> section usually contains such resources as icons, pictires etc. However, some malicious programs (as well as legitimate ones) can store a driver or other code there which gets extracted and executed by the main progam flow. If you suspect that a dinamically linked library was loaded into a process after load time, compare the import list in <a href="/docs/toolkit/general/reverse-toolkit/#process-explorer">Process Explorer</a> to the imports shown in <a href="/docs/toolkit/general/reverse-toolkit/#dependency-walker">Dependency Walker</a> (Windows, for other OS use analogous tools). <code>radare2</code> and <code>IDA</code> can also show imports.</p>
<p>One of the usefull resources (Windows API docs, of course) and also <a href="https://malapi.io/">https://malapi.io/</a> (from the malware perspective).</p>
<table>
<thead>
<tr>
<th>Function imported</th>
<th>Usual usage in malware</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>Network triage</strong>. Check network activity for malicious stuuff.</p>
<p><strong>Singleton</strong>. One instance running only. üë£ <strong>For Windows</strong>: One instance <code>lsass</code>, <code>services</code>, <code>System</code>, <code>winint</code>, <code>lsm.exe</code> ‚ùì. If any of these having more than 1 process should be the object of further investigation.</p>
<p><strong>Boot time</strong>.  Core processes boot at certain time after boot. Anomalies here might be a good indicator of compromise. üë£ <strong>For Windows</strong>: <code>sms</code> starts at boot, for example.</p>
<p><strong>PID</strong>. Some core processes might have a predefined PID. üë£ <strong>For Windows</strong>: System usually has PID 4.</p>
<p><strong>Injections</strong>. <a href="https://www.linkedin.com/pulse/process-injection-detection-malfind-britton-manahan/">https://www.linkedin.com/pulse/process-injection-detection-malfind-britton-manahan/</a></p>
<h3 id="malware-evasion-techniques">Malware Evasion Techniques</h3>
<p>Malware is not going to just always sit there and sing üé∂. Below are common techniques. More detailed explanation is in the anti-forensics section.</p>
<ul>
<li><input disabled="" type="checkbox"> Service Hijacking and Replacement.</li>
<li><input disabled="" type="checkbox"> Process Injection. Stealthy. Trivial identification using RAM analysis tools.</li>
<li><input disabled="" type="checkbox"> Filename/Service Hijacking.</li>
<li><input disabled="" type="checkbox"> ADS.</li>
<li><input disabled="" type="checkbox"> WebShells and Beacons.</li>
<li><input disabled="" type="checkbox"> Firmware.</li>
<li><input disabled="" type="checkbox"> DLL Injeciton.</li>
<li><input disabled="" type="checkbox"> A/V Bypass.</li>
<li><input disabled="" type="checkbox"> Defense Manipulation.</li>
<li><input disabled="" type="checkbox"> Frequent Compilation.</li>
<li><input disabled="" type="checkbox"> Binary Padding.</li>
<li><input disabled="" type="checkbox"> Armoring. It&rsquo;s useful to avoid A/V, but it&rsquo;s very suspicious and easy to spot. Examples: packed malware, polymorphic.</li>
<li><input disabled="" type="checkbox"> Dormant Malware üí§.  <em>I&rsquo;ll think about that tomorrow. Tomorrow is another day.</em> (c, Gone With The Wind).</li>
<li><input disabled="" type="checkbox"> Signing Code with Valid Cert. Thawte and Verisign are responsible for issuing ceritifacates for malware.</li>
<li><input disabled="" type="checkbox"> Anti-Forensics/Timestomping. Timestomping is used to modify the timestamps of a file.</li>
<li><input disabled="" type="checkbox"> Rootkits.</li>
<li><input disabled="" type="checkbox"> &ldquo;Fileless&rdquo; Malware.</li>
</ul>
<h3 id="throubleshooting-malware">Throubleshooting malware</h3>
<ul>
<li>If it&rsquo;s a dll, it can be still ran independently.  Though there are no guaratees, there are two ways to acomplish that (either can work for you):
<ul>
<li>use <code>rundll32</code> (<code>rundll32 [dllname].dll, [function name or ordeal]</code>). Example, a <code>malware.dll</code> that has a function <code>InstallService</code> which requires an argument service name. We want to launch it, call this function to create a service with name &ldquo;MaliciousService&rdquo;: <code>rundll32 malware.dll, MaliciousService</code>. In Dependency Walker we can peek the function&rsquo;s ordeal and run this command like this (if the ordeal is, say, 5): <code>rundll32 malware.dll, #5</code>.</li>
<li>patch PE header of the dll + changing its extension. <code>IMAGE_FILE_HEADER</code> -&gt; <code>CHARACTERISTICS</code> &ndash;&gt; <code>IMAGE_FILE_DLL</code> flag <code>0x2000</code> set to <code>0x0000</code>.</li>
</ul>
</li>
<li><code>ServiceMain</code> without any <code>Install</code> function.
<ul>
<li>Use <code>sc</code> command</li>
<li><code>HKLM/SYSTEM/CurrentControlSet\Services</code> - modify the registry</li>
</ul>
</li>
</ul>
<h2 id="macos">macOS</h2>
<p>The list of malware samples + info + analysis - <a href="https://objective-see.org/malware.html">https://objective-see.org/malware.html</a>.
Mami, Dacls, FinSpy, IPStorm, and GravityRAT.</p>
<h3 id="quarantine-files">Quarantine files</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/Users/%username%/Library/Preferences/com.apple.LaunchServices.QuarantineEventsV2
</span></span></code></pre></div><p>The warning ‚ö†Ô∏è that appears once you want to launch a file that was downloaded from the internet. Quarantine-aware applications: Safari, Messages, iChat, Mail. Known malware is also detected.Windows</p>
<h2 id="windows">Windows</h2>
<h3 id="av-logs">AV Logs</h3>
<p><code>C:\ProgramData\Microsoft\Windows Defender</code></p>
<p>McAfee: <code>C:\ProgramData\McAfee\Endpoint Security\Logs</code></p>
<h2 id="references">References</h2>
<p>Wardle, Patrick. The Art of Mac Malware (p. xxii). No Starch Press. Kindle Edition.
<a href="https://www.magnetforensics.com/resources/investigate-malware-ransomware-with-speed-and-efficiency/">https://www.magnetforensics.com/resources/investigate-malware-ransomware-with-speed-and-efficiency/</a></p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
