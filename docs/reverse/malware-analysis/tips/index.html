<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analysis Tips - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.fdbd9d5cb0cf0052278919e6215fcb4d1e74fc19130407295de2bbe2ee68d0d0.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ü™§">
      <a href="/docs/thunting">
        <span>Threat Hunting ü™§</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ü™§">
      <a href="/docs/thunting">
        <span>Threat Hunting ü™§</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/reverse/malware-analysis/"> üëàüèº Back to </br> Malware Analysis ü¶†  </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#malware-indicators">Malware Indicators</a>
      <ul>
        <li><a href="#runtime-linking">Runtime linking</a></li>
        <li><a href="#imports">Imports</a></li>
        <li><a href="#strings">Strings</a></li>
        <li><a href="#32bit-code">32bit Code</a></li>
        <li><a href="#signed-code">Signed Code</a></li>
        <li><a href="#packed-executables">Packed Executables</a></li>
        <li><a href="#pe-sections">PE Sections</a></li>
        <li><a href="#virtual-vs-physical-addresses">Virtual vs Physical Addresses</a></li>
      </ul>
    </li>
    <li><a href="#librariries-and-methods">Librariries and Methods</a></li>
    <li><a href="#throubleshooting-malware">Throubleshooting malware</a></li>
    <li><a href="#interesting-places-to-check">Interesting places to check</a></li>
    <li><a href="#naming-conventions">Naming conventions</a></li>
    <li><a href="#how-to-find-out-">How to find out &hellip;</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
 </div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Analysis Tips</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
              <i class="fas fa-microchip"></i>
              
          <a class="category-link" href="/domain/reverse">reverse</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
                <i class="fa fa-graduation-cap"></i>
              
          <a class="platform-link" href="/doctype/article">article</a>
          
      </div> <br /><br/>
      
      
      
      
      <div class="article-category">
          
            
              <i class="fab fa-windows"></i>          
            
            
            
            
            
          <a class="platform-link" href="/platforms/windows">windows</a>
          
      </div> <br />
      

      
      <div class="article-category">
        <i class="fas fa-tools"></i>
          
          <a class="platform-link" href="/tools/strings.exe">strings.exe</a>
          
          <a class="platform-link" href="/tools/rundll32.exe">rundll32.exe</a>
          
      </div> <br />
      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p><em>In this article I&rsquo;m collecting all the main tips for malware analysis. Some indicators of compromise, some common clues and etc.</em></p>
<h2 id="malware-indicators">Malware Indicators</h2>
<p>These characteristics MIGHT be of a malware, but not neccessarilly. These are just some clues and advices.</p>
<h3 id="runtime-linking">Runtime linking</h3>
<p>Since static linking is rare (it increases the body of a program) and dynamicly linked functions can be inspected in different ways, runtime linking might be a choice for malware authors to hide the functionality. How to determine if the runtime linking is used?</p>
<blockquote>
<p>‚ùìWindows, Mac, Linux?</p>
</blockquote>
<h3 id="imports">Imports</h3>
<p><strong>Importing</strong> and using <code>GetProcessAddress</code>/<code>LdrGetProcessAddress</code> or/and <code>LoadLibrary</code>/<code>LdrLoadDll</code>.</p>
<blockquote>
<p>‚ùì For Mac and Linux?</p>
</blockquote>
<h3 id="strings">Strings</h3>
<p>Check <strong>strings</strong> in <code>Image</code> and in <code>Memory</code> using the corresponding radio button on the <code>Strings</code> tab of a selected process info in Process Explorer. If they differ - process replacement tool place.</p>
<h3 id="32bit-code">32bit Code</h3>
<p>Since malware authors usually want their software to work on as many machines as possible, they often compile <strong>32bit code</strong>. That&rsquo;s not a decent indicator by itself, but it&rsquo;s a good additional score.</p>
<h3 id="signed-code">Signed Code</h3>
<p>Around 3% of malware is <strong>signed</strong>. It&rsquo;s due to the fact that some systems require executables to be signed. But this technique is not very good for malware authors since when at least one &ldquo;product&rdquo; is marked as malicious, all code that was signed with the same certificate will be identified as well. üõ† Use <code>sigcheck</code> to check signatures and hashes against Virus Total.</p>
<h3 id="packed-executables">Packed Executables</h3>
<p><strong>Packed executables</strong> are almoust 100% indicator that the author didn&rsquo;t want his treasure to be reverse engineered. Why could this be? Because it&rsquo;s some software with a portion of client-side code that performs sensitive operations. One example of a legitimate software is a program that generates OTP codes. There are several ways to determine that a file is packed. The first one - using enthropy analysis against the file. Consider, that most program epilogues start with <code>55 8B EC</code> (<code>push ebp mov ebp, esp</code>) and end with <code>c3</code> (<code>ret</code>).  That means that the number of both in one executable should be relatively the same. Compressed files don&rsquo;t compress well. Another example is to pack the file and determine, how efficiently was it packed. If it wasn&rsquo;t possible to pack the file too much, it&rsquo;s probable that the file is already packed. üõ† Use the first method with <a href="https://www.aldeid.com/wiki/PEiD">PEiD</a> (GUI Windows tool), use the second method with <code>pescan</code> (commercial cross-platform tool).</p>
<h3 id="pe-sections">PE Sections</h3>
<p>Weired names for <strong>PE sections</strong>. PE sections (for Windows) are usually <code>text</code>, <code>bss</code>, <code>data</code> etc. If you some gibberish that&rsquo;s not usually seen here, most likely the executable is packed.</p>
<h3 id="virtual-vs-physical-addresses">Virtual vs Physical Addresses</h3>
<p><strong>VA vs PA</strong>. Empty Physical addresses for sections (while VA are not empty).</p>
<h2 id="librariries-and-methods">Librariries and Methods</h2>
<table>
<thead>
<tr>
<th>Library</th>
<th>common use</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>kernell32.dll</code>, <code>advapi.dll</code>, <code>ntdll.dll</code></td>
<td>These three libraries are used for communicating with the kernel and basic functions, like openinng files, creating proccessing, manipulating hardware etc. <code>advapi.dll</code> is for advanced functionality like registry and service manager. <code>ntdll.dll</code> is pretty much the same as <code>kernell32.dll</code> (since the latter used the former in its imports) but more low-level and advanced. It&rsquo;s rarely imported directly, usually, <code>kernell32.dll</code> imports it. Its direct import might be an indicator of hiding functionality.</td>
</tr>
<tr>
<td><code>user32.dll</code>, <code>gdi32.dll</code></td>
<td>These are for GUI. <code>user32.dll</code> is for buttons and stuff, while <code>gdi32.dll</code> is for general graphics settings.</td>
</tr>
<tr>
<td><code>WSock32.dll</code>, <code>ws2_32.dll</code>, <code>wininet.dll</code></td>
<td><code>WSock32.dll</code> and <code>ws2_32.dll</code> are for general networing functionality like opening sockets, while <code>wininet.dll</code> is more high-level (FTP, HTTP, NTP protocols etc).</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Function imported</th>
<th>Usual usage in malware</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="throubleshooting-malware">Throubleshooting malware</h2>
<ul>
<li>If it&rsquo;s a dll, it can be still ran independently.  Though there are no guaratees, there are two ways to acomplish that (either can work for you):
<ul>
<li>use <code>rundll32</code> (<code>rundll32 [dllname].dll, [function name or ordeal]</code>). Example, a <code>malware.dll</code> that has a function <code>InstallService</code> which requires an argument service name. We want to launch it, call this function to create a service with name &ldquo;MaliciousService&rdquo;: <code>rundll32 malware.dll, MaliciousService</code>. In Dependency Walker we can peek the function&rsquo;s ordeal and run this command like this (if the ordeal is, say, 5): <code>rundll32 malware.dll, #5</code>.</li>
<li>patch PE header of the dll + changing its extension. <code>IMAGE_FILE_HEADER</code> -&gt; <code>CHARACTERISTICS</code> &ndash;&gt; <code>IMAGE_FILE_DLL</code> flag <code>0x2000</code> set to <code>0x0000</code>.</li>
</ul>
</li>
<li><code>ServiceMain</code> without any <code>Install</code> function.
<ul>
<li>Use <code>sc</code> command</li>
<li><code>HKLM/SYSTEM/CurrentControlSet\Services</code> - modify the registry</li>
</ul>
</li>
</ul>
<h2 id="interesting-places-to-check">Interesting places to check</h2>
<ul>
<li><code>.rsrc</code> section usually contains such resources as icons, pictires etc. However, some malicious programs (as well as legitimate ones) can store a driver or other code there which gets extracted and executed by the main progam flow.</li>
</ul>
<h2 id="naming-conventions">Naming conventions</h2>
<ul>
<li>On Windows systems some functions have a suffix <code>A</code> or <code>W</code>. These indicate that this function accepting ASCII or wide character string as an argument respectively.</li>
<li>On Windows systems some functions have a suffix <code>Ex</code> or even <code>ExEx</code>. These indicate that Windows has released a new version of a function which is not compatible with older ones, since older ones must be supported.</li>
</ul>
<h2 id="how-to-find-out-">How to find out &hellip;</h2>
<ul>
<li>&hellip; which processes used a certain dll ‚ùì In <a href="/docs/toolkit/general/reverse-toolkit/#process-explorer">Process Explorer</a> choose <code>Find Handle or DLL</code>.</li>
<li>&hellip; if a DLL is loaded into a process after load time ‚ùì Compare the DLL list in <a href="/docs/toolkit/general/reverse-toolkit/#process-explorer">Process Explorer</a> to the imports shown in <a href="/docs/toolkit/general/reverse-toolkit/#dependency-walker">Dependency Walker</a>.</li>
<li>&hellip; if a <code>.doc</code> or <code>.pdf</code> or another document is malicious ‚ùì Open <a href="/docs/toolkit/general/reverse-toolkit/#process-explorer">Process Explorer</a>, launch the suspicios doc in sandboxed environment and check whether it has spawned any processes. Open this process&rsquo;s <code>Properties</code> window, <code>Image</code> tab to check the location of the malware file.</li>
</ul>
<h2 id="references">References</h2>
<p>[<a href="">1</a>] Practical Malware Analysis, M. Silkorski, A. Honig</p>
<p>[<a href="https://www.sans.org/posters/malware-analysis-and-reverse-engineering-cheat-sheet/">2</a>] SANS cheatsheet on malware analysis</p>
<p>[<a href="https://www.sans.org/posters/tips-for-reverse-engineering-malicious-code/">3</a>] SANS tips on malware analysis</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
