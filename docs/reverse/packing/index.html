<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Packed Executables And Unpacking - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting 🪤">
      <a href="/docs/thunting">
        <span>Threat Hunting 🪤</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home 🏡">
      <a href="/">
        <span>Home 🏡</span>
      </a>
    </li>
    
    <li class="menu-item-blog ✍️">
      <a href="/docs/blog">
        <span>Blog ✍️</span>
      </a>
    </li>
    
    <li class="menu-item-dfir 🔍">
      <a href="/docs/dfir">
        <span>DFIR 🔍</span>
      </a>
    </li>
    
    <li class="menu-item-crypto 🗝️">
      <a href="/docs/cryptography">
        <span>Crypto 🗝️</span>
      </a>
    </li>
    
    <li class="menu-item-reverse 🔧">
      <a href="/docs/reverse">
        <span>Reverse 🔧</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit 🧰">
      <a href="/docs/toolkit">
        <span>Toolkit 🧰</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting 🪤">
      <a href="/docs/thunting">
        <span>Threat Hunting 🪤</span>
      </a>
    </li>
    
    <li class="menu-item-about me 🧝🏽‍♀️">
      <a href="/docs/about">
        <span>About me 🧝🏽‍♀️</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference 📚">
      <a href="/docs/reference">
        <span>Tech Reference 📚</span>
      </a>
    </li>
    
    <li class="menu-item-notes 📝">
      <a href="/docs/notes">
        <span>Notes 📝</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/reverse/"> 👈🏼 Back to </br> ⚙️ Reverse Engineering </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#unpacking-techniques">Unpacking techniques</a>
      <ul>
        <li><a href="#ollydbgs-built-in-option">OllyDbg&rsquo;s built in option</a></li>
        <li><a href="#hr-esp-4"><code>hr esp-4</code></a></li>
        <li><a href="#jmp-edi"><code>JMP EDI</code></a></li>
        <li><a href="#popad">POPAD</a></li>
        <li><a href="#getprocaddress"><code>GetProcAddress</code></a></li>
      </ul>
    </li>
    <li><a href="#unsorted">Unsorted</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Packed Executables And Unpacking</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
              <i class="fas fa-microchip"></i>
              
          <a class="category-link" href="/domain/reverse">reverse</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
                <i class="fa fa-graduation-cap"></i>
              
          <a class="platform-link" href="/doctype/article">article</a>
          
      </div> <br /><br/>
      
      
      
      
      <div class="article-category">
          
            
              <i class="fab fa-windows"></i>          
            
            
            
            
            
          <a class="platform-link" href="/platforms/windows">windows</a>
          
      </div> <br />
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p>There are several indicators that the executable is packed. Here they are (this list will be growing as I encounter new indicators):</p>
<ul>
<li>Few imports and among these imports are functions like <code>GetProcessAddress</code> or <code>LoadLibrary</code></li>
<li>Weired names for PE sections</li>
<li>Empty Physical addresses for sections (while VA are not empty). More about</li>
</ul>
<h2 id="unpacking-techniques">Unpacking techniques</h2>
<p>A piece of software cannot just run packed (what a challenging world that would be! 😳 ). The thing is that whatever the packing algorythm is, however complex 🧶 it might be, the real code needs to be <em>unpacked into memory</em> first. So, even with the most sophisticated protection techniques, it all really comes down to waiting for the executable to get unpacked into memory, from where it can be gently and dearly dumped like a 🐝 hive from a tree 🌳 full of hungry and pretty agressive wild bees with a big and heavy bat 🏃‍♀️. We might want to do some minor other stuff afterwards but let&rsquo;s keep it for now.</p>
<p>What do I mean by &ldquo;<em>waiting</em>&rdquo;? Start a debugger, attach to this packed 📦 piece of treasure 💎, inspect the code and try to find a point in execution, when it&rsquo;s done unpacking and hands control over to the original code. The original code&rsquo;s entry point is called OEP (original entry point - 😳) and that&rsquo;s the point when we make a memory dump.</p>
<p>The problem is - how to actually <em>find</em> this OEP? Well, there are lot&rsquo;s of ways to do so. They vary from packer to packer, or from the analyst to analyst. Here is the list of techniques that I&rsquo;ve compiled.</p>
<h3 id="ollydbgs-built-in-option">OllyDbg&rsquo;s built in option</h3>
<p>There is a functionality that OllyDbg debugger has, which can be reached out with <code>Plugins -&gt; OllyDump -&gt; Find OEP</code> that can get you something unpacked. Didn&rsquo;t work for me, but might be a low hanging fruit 🍌 for you. Give it a try before getting dragged into the swamp of hardcore reversing.</p>
<p>Below is what I got when trying to run it against a slightly complicated packed malware that was a part of my job interview once:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0048DF34 CALL unpackme.0048DF39
</span></span><span class="line"><span class="cl">0048DF39 POP EAX
</span></span><span class="line"><span class="cl">0048DF3A PUSH EBP
</span></span><span class="line"><span class="cl">0048DF3B MOV EDI, EAX...
</span></span><span class="line"><span class="cl">0048DF47 ...JMP SHORT unpackme.0048DF4E
</span></span></code></pre></div><p>It was my first executable to unpack (well, I didn&rsquo;t touch anything harder than the labs from <em>Practical Malware Analysis</em>), so I couldn&rsquo;t say whether it was it. Now my guts tell me that it&rsquo;s not. Dumping the code from memory and trying to run it proved this, but I would like to explain it later. Just to be sure I <em>understand</em> why this is not OEP and how to tell just by looking at this code. Let&rsquo;s move to the next one.</p>
<h3 id="hr-esp-4"><code>hr esp-4</code></h3>
<p>This is another technique - setting a hardware breakpoint on the point when the stack is being squeezed. I got these instructions:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">00490B50 POP ESI 
</span></span><span class="line"><span class="cl">00490B51 POP EBP
</span></span><span class="line"><span class="cl">00490B52 JMP EDI
</span></span></code></pre></div><p>When I clicked <code>Follow Dump</code> for <code>EAX</code> registry I saw a <code>MZ ... PE</code>-header and the registry&rsquo;s value at the moment is <code>00400000</code>. All I needed to do then was dumping the code and fixing the import table with ImportRec. PEView showed that the file was unpacked. Reopen the file with OllyDbg and the program stops at <code>0x0043A586</code>.</p>
<h3 id="jmp-edi"><code>JMP EDI</code></h3>
<p>Before the unpacking code handes the control over to the original code, it needs to allocate some memory, but setting a BP on <code>VirtualAlloc</code> didn&rsquo;t work. However, setting it on <code>ZwAllocateVirtualMemory</code>&hellip; Several times did the code stumble on this function. Upon return to the user-code, I saw clearly that memory was allocated for libraries.</p>
<p>При возврате в user-code было видно, что память выделяется под библиотеки. Сделала первый раз dump на том участке, где выделяется память под comctl_1 (адрес 7CA27320). При этом, ImportRec увидел всего 4 dlls, но OEP найти не вышло таким способом (ставила Hardware Breakpoint on write byte в EAX follow dump, а также после возврата в user-code пыталась с помощью F8 отследить, происходят ли какие-то изменения в dump - никаких результатов).</p>
<h3 id="popad">POPAD</h3>
<p>Quite close to <code>esp-4</code> technique.</p>
<p>Также пробовала найти OEP более стандартным способом, найдя POPAD и поставив bp на эту инструкцию. Однако после этой инструкции не было unconditional JMP. Кроме того, после запуска возникала ошибка и код останавливался до bp: ”Access violation when reading&quot;</p>
<h3 id="getprocaddress"><code>GetProcAddress</code></h3>
<p>Deemed no results.</p>
<h2 id="unsorted">Unsorted</h2>
<p>Код распаковывается в какой-либо регион памяти и уже в распакованном виде выполняется оттуда. Но для этого нужно выделить память и изменить атрибуты доступа к ней, чтобы иметь возможность выполнять код. Функция VirtualProtect как раз изменяет атрибуты доступа к региону памяти, поэтому она меня так заинтересовала.
BOOL WINAPI VirtualProtect(
<em>In</em>  LPVOID lpAddress,
<em>In</em>  SIZE_T dwSize,
<em>In</em>  DWORD  flNewProtect,
<em>Out</em> PDWORD lpflOldProtect
);
Нас интересует третий параметр этой функции — flNewProtect.Видим, что передается значение 0x40, а документация MSDN показывает нам, что это права на чтение, запись и выполнение.</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
