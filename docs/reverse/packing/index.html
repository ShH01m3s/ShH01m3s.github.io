<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Packed Executables And Unpacking - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ü™§">
      <a href="/docs/thunting">
        <span>Threat Hunting ü™§</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-reverse üîß">
      <a href="/docs/reverse">
        <span>Reverse üîß</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ü™§">
      <a href="/docs/thunting">
        <span>Threat Hunting ü™§</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference üìö">
      <a href="/docs/reference">
        <span>Tech Reference üìö</span>
      </a>
    </li>
    
    <li class="menu-item-notes üìù">
      <a href="/docs/notes">
        <span>Notes üìù</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/reverse/"> üëàüèº Back to </br> ‚öôÔ∏è Reverse Engineering </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#unpacking-techniques">Unpacking techniques</a>
      <ul>
        <li><a href="#ollydbgs-built-in-option">OllyDbg&rsquo;s built in option</a></li>
        <li><a href="#hr-esp-4"><code>hr esp-4</code></a></li>
        <li><a href="#jmp-edi"><code>JMP EDI</code></a></li>
        <li><a href="#popad">POPAD</a></li>
        <li><a href="#getprocaddress"><code>GetProcAddress</code></a></li>
      </ul>
    </li>
    <li><a href="#unsorted">Unsorted</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Packed Executables And Unpacking</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
              <i class="fas fa-microchip"></i>
              
          <a class="category-link" href="/domain/reverse">reverse</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
                <i class="fa fa-graduation-cap"></i>
              
          <a class="platform-link" href="/doctype/article">article</a>
          
      </div> <br /><br/>
      
      
      
      
      <div class="article-category">
          
            
              <i class="fab fa-windows"></i>          
            
            
            
            
            
          <a class="platform-link" href="/platforms/windows">windows</a>
          
      </div> <br />
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p>There are several indicators that the executable is packed. Here they are (this list will be growing as I encounter new indicators):</p>
<ul>
<li>Few imports and among these imports are functions like <code>GetProcessAddress</code> or <code>LoadLibrary</code></li>
<li>Weired names for PE sections</li>
<li>Empty Physical addresses for sections (while VA are not empty). More about</li>
</ul>
<h2 id="unpacking-techniques">Unpacking techniques</h2>
<p>A piece of software cannot just run packed (what a challenging world that would be! üò≥ ). The thing is that whatever the packing algorythm is, however complex üß∂ it might be, the real code needs to be <em>unpacked into memory</em> first. So, even with the most sophisticated protection techniques, it all really comes down to waiting for the executable to get unpacked into memory, from where it can be gently and dearly dumped like a üêù hive from a tree üå≥ full of hungry and pretty agressive wild bees with a big and heavy bat üèÉ‚Äç‚ôÄÔ∏è. We might want to do some minor other stuff afterwards but let&rsquo;s keep it for now.</p>
<p>What do I mean by &ldquo;<em>waiting</em>&rdquo;? Start a debugger, attach to this packed üì¶ piece of treasure üíé, inspect the code and try to find a point in execution, when it&rsquo;s done unpacking and hands control over to the original code. The original code&rsquo;s entry point is called OEP (original entry point - üò≥) and that&rsquo;s the point when we make a memory dump.</p>
<p>The problem is - how to actually <em>find</em> this OEP? Well, there are lot&rsquo;s of ways to do so. They vary from packer to packer, or from the analyst to analyst. Here is the list of techniques that I&rsquo;ve compiled.</p>
<h3 id="ollydbgs-built-in-option">OllyDbg&rsquo;s built in option</h3>
<p>There is a functionality that OllyDbg debugger has, which can be reached out with <code>Plugins -&gt; OllyDump -&gt; Find OEP</code> that can get you something unpacked. Didn&rsquo;t work for me, but might be a low hanging fruit üçå for you. Give it a try before getting dragged into the swamp of hardcore reversing.</p>
<p>Below is what I got when trying to run it against a slightly complicated packed malware that was a part of my job interview once:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0048DF34 CALL unpackme.0048DF39
</span></span><span class="line"><span class="cl">0048DF39 POP EAX
</span></span><span class="line"><span class="cl">0048DF3A PUSH EBP
</span></span><span class="line"><span class="cl">0048DF3B MOV EDI, EAX...
</span></span><span class="line"><span class="cl">0048DF47 ...JMP SHORT unpackme.0048DF4E
</span></span></code></pre></div><p>It was my first executable to unpack (well, I didn&rsquo;t touch anything harder than the labs from <em>Practical Malware Analysis</em>), so I couldn&rsquo;t say whether it was it. Now my guts tell me that it&rsquo;s not. Dumping the code from memory and trying to run it proved this, but I would like to explain it later. Just to be sure I <em>understand</em> why this is not OEP and how to tell just by looking at this code. Let&rsquo;s move to the next one.</p>
<h3 id="hr-esp-4"><code>hr esp-4</code></h3>
<p>This is another technique - setting a hardware breakpoint on the point when the stack is being squeezed. I got these instructions:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">00490B50 POP ESI 
</span></span><span class="line"><span class="cl">00490B51 POP EBP
</span></span><span class="line"><span class="cl">00490B52 JMP EDI
</span></span></code></pre></div><p>When I clicked <code>Follow Dump</code> for <code>EAX</code> registry I saw a <code>MZ ... PE</code>-header and the registry&rsquo;s value at the moment is <code>00400000</code>. All I needed to do then was dumping the code and fixing the import table with ImportRec. PEView showed that the file was unpacked. Reopen the file with OllyDbg and the program stops at <code>0x0043A586</code>.</p>
<h3 id="jmp-edi"><code>JMP EDI</code></h3>
<p>Before the unpacking code handes the control over to the original code, it needs to allocate some memory, but setting a BP on <code>VirtualAlloc</code> didn&rsquo;t work. However, setting it on <code>ZwAllocateVirtualMemory</code>&hellip; Several times did the code stumble on this function. Upon return to the user-code, I saw clearly that memory was allocated for libraries.</p>
<p>–ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ user-code –±—ã–ª–æ –≤–∏–¥–Ω–æ, —á—Ç–æ –ø–∞–º—è—Ç—å –≤—ã–¥–µ–ª—è–µ—Ç—Å—è –ø–æ–¥ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏. –°–¥–µ–ª–∞–ª–∞ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ dump –Ω–∞ —Ç–æ–º —É—á–∞—Å—Ç–∫–µ, –≥–¥–µ –≤—ã–¥–µ–ª—è–µ—Ç—Å—è –ø–∞–º—è—Ç—å –ø–æ–¥ comctl_1 (–∞–¥—Ä–µ—Å 7CA27320). –ü—Ä–∏ —ç—Ç–æ–º, ImportRec —É–≤–∏–¥–µ–ª –≤—Å–µ–≥–æ 4 dlls, –Ω–æ OEP –Ω–∞–π—Ç–∏ –Ω–µ –≤—ã—à–ª–æ —Ç–∞–∫–∏–º —Å–ø–æ—Å–æ–±–æ–º (—Å—Ç–∞–≤–∏–ª–∞ Hardware Breakpoint on write byte –≤ EAX follow dump, –∞ —Ç–∞–∫–∂–µ –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ user-code –ø—ã—Ç–∞–ª–∞—Å—å —Å –ø–æ–º–æ—â—å—é F8 –æ—Ç—Å–ª–µ–¥–∏—Ç—å, –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –ª–∏ –∫–∞–∫–∏–µ-—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ dump - –Ω–∏–∫–∞–∫–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤).</p>
<h3 id="popad">POPAD</h3>
<p>Quite close to <code>esp-4</code> technique.</p>
<p>–¢–∞–∫–∂–µ –ø—Ä–æ–±–æ–≤–∞–ª–∞ –Ω–∞–π—Ç–∏ OEP –±–æ–ª–µ–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º, –Ω–∞–π–¥—è POPAD –∏ –ø–æ—Å—Ç–∞–≤–∏–≤ bp –Ω–∞ —ç—Ç—É –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é. –û–¥–Ω–∞–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–µ –±—ã–ª–æ unconditional JMP. –ö—Ä–æ–º–µ —Ç–æ–≥–æ, –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞ –∏ –∫–æ–¥ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª—Å—è –¥–æ bp: ‚ÄùAccess violation when reading&quot;</p>
<h3 id="getprocaddress"><code>GetProcAddress</code></h3>
<p>Deemed no results.</p>
<h2 id="unsorted">Unsorted</h2>
<p>–ö–æ–¥ —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç—Å—è –≤ –∫–∞–∫–æ–π-–ª–∏–±–æ —Ä–µ–≥–∏–æ–Ω –ø–∞–º—è—Ç–∏ –∏ —É–∂–µ –≤ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ç—Ç—É–¥–∞. –ù–æ –¥–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å –ø–∞–º—è—Ç—å –∏ –∏–∑–º–µ–Ω–∏—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–µ–π, —á—Ç–æ–±—ã –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–¥. –§—É–Ω–∫—Ü–∏—è VirtualProtect –∫–∞–∫ —Ä–∞–∑ –∏–∑–º–µ–Ω—è–µ—Ç –∞—Ç—Ä–∏–±—É—Ç—ã –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–≥–∏–æ–Ω—É –ø–∞–º—è—Ç–∏, –ø–æ—ç—Ç–æ–º—É –æ–Ω–∞ –º–µ–Ω—è —Ç–∞–∫ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∞.
BOOL WINAPI VirtualProtect(
<em>In</em>  LPVOID lpAddress,
<em>In</em>  SIZE_T dwSize,
<em>In</em>  DWORD  flNewProtect,
<em>Out</em> PDWORD lpflOldProtect
);
–ù–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç —Ç—Ä–µ—Ç–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ ‚Äî flNewProtect.–í–∏–¥–∏–º, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ 0x40, –∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è MSDN –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–º, —á—Ç–æ —ç—Ç–æ –ø—Ä–∞–≤–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ, –∑–∞–ø–∏—Å—å –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
