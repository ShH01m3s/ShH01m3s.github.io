<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Buffer Overflow - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ğŸª¤">
      <a href="/docs/thunting">
        <span>Threat Hunting ğŸª¤</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference ğŸ“š">
      <a href="/docs/reference">
        <span>Tech Reference ğŸ“š</span>
      </a>
    </li>
    
    <li class="menu-item-notes ğŸ“">
      <a href="/docs/notes">
        <span>Notes ğŸ“</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-dfir ğŸ”">
      <a href="/docs/dfir">
        <span>DFIR ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-reverse ğŸ”§">
      <a href="/docs/reverse">
        <span>Reverse ğŸ”§</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit ğŸ§°">
      <a href="/docs/toolkit">
        <span>Toolkit ğŸ§°</span>
      </a>
    </li>
    
    <li class="menu-item-threat hunting ğŸª¤">
      <a href="/docs/thunting">
        <span>Threat Hunting ğŸª¤</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tech reference ğŸ“š">
      <a href="/docs/reference">
        <span>Tech Reference ğŸ“š</span>
      </a>
    </li>
    
    <li class="menu-item-notes ğŸ“">
      <a href="/docs/notes">
        <span>Notes ğŸ“</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/reverse/exploits/"> ğŸ‘ˆğŸ¼ Back to </br> Exploits </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Buffer Overflow</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      <div class="article-category">domain: 
          
              
              <i class="fas fa-microchip"></i>
              
          <a class="category-link" href="/domain/reverse">reverse</a>
          
      </div> <br />
      
      <div class="article-category">doctype:
          
            
              
                <i class="fa fa-graduation-cap"></i>
              
          <a class="platform-link" href="/doctype/article">article</a>
          
      </div> <br /><br/>
      
      
      
      
      <div class="article-category">
          
            
            
            
            
            
              <i class="fab fa-linux"></i>&nbsp;<i class="fab fa-apple"></i>&nbsp;<i class="fab fa-windows"></i>&nbsp;<i class="fas fa-mobile"></i>
            
          <a class="platform-link" href="/platforms/all">all</a>
          
      </div> <br />
      

      
      

      
    </div>
  </header>


  <div class="content" itemprop="articleBody">
    <p><em>The idea of a buffer overflow attack is quite simple, though the implementation might be difficult to digest at first. In this article I am exploring this notion and trying to visualise it.</em></p>
<p>Imagine your have a job you don&rsquo;t really like (I think most of us have had such an experience at least once in a life ğŸ˜¢). And also imagine that you are being highly underpaid. You job is simple and ridiculous: place rabbits ğŸ‡ into one set of boxes and foxes ğŸ¦Š - into another. You happen to have 6 boxes ğŸ“¦ğŸ“¦ğŸ“¦ğŸ“¦ğŸ“¦ğŸ“¦ for foxes ğŸ¦Š and 4 ğŸ“¦ğŸ“¦ğŸ“¦ğŸ“¦ for rabbits ğŸ‡. However, you were given 4 rabbits ğŸ‡ğŸ‡ğŸ‡ğŸ‡ and 7 foxes ğŸ¦ŠğŸ¦ŠğŸ¦ŠğŸ¦ŠğŸ¦ŠğŸ¦ŠğŸ¦Š. So, one fox ğŸ¦Š doesn&rsquo;t have its own fox box ğŸ“¦. However, there are also rabbit ğŸ‡ boxes ğŸ“¦ right nearby. So, even though you were specifically told not to place foxes into rabbit boxes and vice versa, since you don&rsquo;t really give a shit, you put a fox into a rabbit fox. What happens? One can only guess&hellip; ğŸ¤”. Long story short: the fox eats the rabbit and now you have 7 foxes and only 3 rabbits ğŸ‡. Alas! If only you&rsquo;ve followed the manual ğŸ“–&hellip; . Most likely one would get fired after such a mistake, but we can&rsquo;t fire the compiler, so that&rsquo;s what would happen if the developer was not using a memory safe language or wasn&rsquo;t careful enough. Now, to the technicalities.</p>
<p>Below is a short example of such a vulbeiability in code (C language). Let&rsquo;s read it line by line and understand the mechanics.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//init two arrays (buffers), 4 bytes for rabbits and 6 bytes for foxes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">rabbit_boxes</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">foxes_boxes</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">//put 4 rabbits into rabbit boxes and 6 foxes into foxes boxes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">strcpy</span><span class="p">(</span><span class="n">rabbit_boxes</span><span class="p">,</span> <span class="s">&#34;rrrr&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">strcpy</span><span class="p">(</span><span class="n">foxes_boxes</span><span class="p">,</span> <span class="s">&#34;ffffff&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">//print the contents of these two arrays in memory before buffer overflow occurs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[BEFORE] Foxes boxes are at %p and contain %s&#34;</span><span class="p">,</span> <span class="n">foxes_boxes</span><span class="p">,</span> <span class="n">foxes_boxes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[BEFORE] Rabbit boxes are at %p and contain %s&#34;</span><span class="p">,</span> <span class="n">rabbit_boxes</span><span class="p">,</span> <span class="n">rabbit_boxes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">//if the length of the argv[1] exceeds the size of the foxes boxes array, you&#39;ll have your overflow. Some amount of rabbits in rabbit boxes will be &#34;overflown&#34;, i.e. eaten
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[STRCPY] Putting %d foxes (bytes) into foxes boxes&#34;</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">//print the contents of these two arrays in memory after and if buffer overflow occurs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[AFTER] Foxes boxes are at %p and contain %s&#34;</span><span class="p">,</span> <span class="n">foxes_boxes</span><span class="p">,</span> <span class="n">foxes_boxes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[AFTER] Rabbit boxes are at %p and contain %s&#34;</span><span class="p">,</span> <span class="n">rabbit_boxes</span><span class="p">,</span> <span class="n">rabbit_boxes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The above example is just a technical representation of the story at the beginning of this article.</p>
<p>Stack is a data structure and an area in memory that stores local variables, arguments, return addresses, return values, frame stack pointers. It&rsquo;s also used to temporarily save data. When a function calls another function, the caller&rsquo;s data (registry data, EIP and EBP) is temporarily stored in stack until the callee returns.</p>
<p>Let&rsquo;s assume we have a cruel <code>kill_rabbit</code> ğŸ‡ function:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">function</span> <span class="nf">kill_rabbit</span><span class="p">(</span><span class="kt">int</span> <span class="n">number</span><span class="p">,</span> <span class="kt">char</span><span class="p">[]</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rabbits_number</span> <span class="o">=</span> <span class="n">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span><span class="p">[]</span> <span class="n">rabbits_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#34;Roger</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">kill_rabbit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;The rabbit couldn&#39;t be killed. It&#39;s Roger, man! Show some respect.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>At the moment of the function call, the stack is arranged in a following way:</p>
<table>
<thead>
<tr>
<th>return (<code>1</code> or <code>0</code>)</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>char[] rabbits_name</code> (local variable)</td>
</tr>
<tr>
<td><code>int rabbits_number</code> (local variable)</td>
</tr>
<tr>
<td>EBP of main (<strong>S</strong>aved <strong>F</strong>unction <strong>P</strong>ointer)</td>
</tr>
<tr>
<td>return address (saved value of <code>EIP</code>)</td>
</tr>
<tr>
<td>char[] name (argument)</td>
</tr>
<tr>
<td>int number (argument)</td>
</tr>
<tr>
<td><code>main</code>&rsquo;s frame</td>
</tr>
</tbody>
</table>
<p>But what if the coyote ğŸº still wants to kill Roger? How to help him?</p>
<p><strong>Steps</strong>:</p>
<ul>
<li>
<p><input disabled="" type="checkbox"> Identify a buffer to overflow</p>
</li>
<li>
<p><input disabled="" type="checkbox"> Find a value you want to overflow</p>
</li>
<li>
<p><input disabled="" type="checkbox"> Â Calculate the distance in bytes between the buffer and the value:</p>
<ul>
<li><input disabled="" type="checkbox"> <code>msf-pattern create -l 1400</code> (to generate an excessively long string of random characters). Say, for example, we have generated a string and some portion of it conatined <code>[...]lksdjfk[...]</code>.</li>
<li><input disabled="" type="checkbox"> Look at the value of the registry or other buffer that is the target of BO. Translate the hex to ASCII and search this sequence in the above generated string. Let&rsquo;s say that we see <code>EIP</code> registry set to <code>0x73646a66</code> which in ASCII is <code>sdjf</code>.</li>
<li><input disabled="" type="checkbox"> Find the exact offset of the substirng above withing the string: <code>msf-pattern_offset -q 73646a66</code>.</li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> ```bash
x/s buffer # represent the value at buffer as a string
x/x value # represent the value as a hex integer 4 bytes long</p>
<p>print &amp;value - &amp;buffer (or &amp;buffer - &amp;value) # for arithmetic operation</p>
<p>x/16xw buffer # print 16 words starting from the beginning of the buffer</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"></code></pre></div></li>
<li>
<p><input disabled="" type="checkbox"> </p>
</li>
<li>
<p><input disabled="" type="checkbox"> </p>
</li>
</ul>
<h2 id="references">References</h2>
<p>[<a href="">1</a>] Hacking: the Art of Exploitation</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js"></script>
  

  
  
  
    
  


</body>

</html>
