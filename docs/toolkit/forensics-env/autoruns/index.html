<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Kansa and Autoruns - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-dfir üîç">
      <a href="/docs/dfir">
        <span>DFIR üîç</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-toolkit üß∞">
      <a href="/docs/toolkit">
        <span>Toolkit üß∞</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/toolkit/forensics-env/"> üëàüèº Back to </br> Forensic Environment Setup </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#-btfm">üìò BTFM</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Kansa and Autoruns</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 03.06.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p>Run a tool to collect all the artefacts for this OS (for example, <code>autorunc.exe</code> for Windows) on the machines in question. I use CSV format as output whenever possible because it can be imported in a SIEM, TimeLine Explorer (Windows) or Numbers/Excel/Google Sheets. I prefer the last option because its pivoting functionality is much easier to deploy.</p>
<ol>
<li>Open each file (if there are not too many)</li>
<li>Filter for untrusted or missing vendors. Such vendors as Google and Firefox might be used to trick the user. It would look like `(Not verified) Firefox.</li>
<li>Show those enabled ones (if applicable)</li>
<li>Look at the image path, and use the FindEvil SANS poster or your baseline system profile as a reference for known good to find what‚Äôs bad</li>
<li>Look at the hashes and check against known-good.</li>
<li>Check with a supernova, google Publishes and Description</li>
<li>Frequency analysis. What stands out? (see the following sections). Find possible suspicious or malicious things.</li>
<li>Check the triage files from other machines for the same IoCs (Select-String, grep etc).</li>
<li>Stacking (frequency-based outlier analysis)</li>
<li>Frequency analysis. What stands out?</li>
</ol>
<p>üóí If the file doesn‚Äôt have an image path (<code>File not found</code>), it‚Äôs likely it was moved/deleted and thus is not an active threat. What‚Äôs suspicious?</p>
<ul>
<li>Non-system executables like OneDrive are in the System32 directory (Windows) or not in Applications (macOS) or /opt (Linux).</li>
<li>Files with meaningless names and usually one letter or 1 number like <code>1.bat</code> or <code>2.exe</code> or <code>a.exe</code>.</li>
<li>Be especially careful with drivers/daemons since they have the most power.</li>
<li>WMI entries are also worth checking (Windows only)</li>
<li>Executables and scripts in a temp directory</li>
</ul>
<p>üõ†Ô∏è <code>Kansa</code> PowerShell script <code>Get-ASEPImagePathLaunchStringMD5UnsignedStack.ps1</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="cm">&lt;#
</span></span></span><span class="line"><span class="cl"><span class="cm"></span><span class="sd">.SYNOPSIS</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">Get-ASEPImagePathLaunchStringStack.ps1
</span></span></span><span class="line"><span class="cl"><span class="cm">Requires logparser.exe in path
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">Pulls frequency of autoruns based on ImagePath, LaunchString and MD5 tuple
</span></span></span><span class="line"><span class="cl"><span class="cm">where the publisher is not verified (unsigned code) and the ImagePath is
</span></span></span><span class="line"><span class="cl"><span class="cm">not &#39;File not found&#39;
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">This script expects files matching the *autorunsc.txt pattern to be in the
</span></span></span><span class="line"><span class="cl"><span class="cm">current working directory.
</span></span></span><span class="line"><span class="cl"><span class="cm"></span><span class="sd">.NOTES</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">DATADIR Autorunsc
</span></span></span><span class="line"><span class="cl"><span class="cm">#&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nb">Get-Command</span> <span class="n">LogParser</span><span class="p">.</span><span class="n">exe</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$lpquery</span> <span class="p">=</span> <span class="sh">@&#34;
</span></span></span><span class="line"><span class="cl"><span class="sh">    SELECT
</span></span></span><span class="line"><span class="cl"><span class="sh">        COUNT([Image Path], [Launch String], MD5) as ct,
</span></span></span><span class="line"><span class="cl"><span class="sh">        [Image Path],
</span></span></span><span class="line"><span class="cl"><span class="sh">        [Launch String],
</span></span></span><span class="line"><span class="cl"><span class="sh">        MD5,
</span></span></span><span class="line"><span class="cl"><span class="sh">        Signer
</span></span></span><span class="line"><span class="cl"><span class="sh">    FROM
</span></span></span><span class="line"><span class="cl"><span class="sh">        *autorunsc.csv
</span></span></span><span class="line"><span class="cl"><span class="sh">    WHERE
</span></span></span><span class="line"><span class="cl"><span class="sh">        Signer not like &#39;(Verified)%&#39; and
</span></span></span><span class="line"><span class="cl"><span class="sh">        ([Image Path] not like &#39;File not found%&#39;)
</span></span></span><span class="line"><span class="cl"><span class="sh">    GROUP BY
</span></span></span><span class="line"><span class="cl"><span class="sh">        [Image Path],
</span></span></span><span class="line"><span class="cl"><span class="sh">        [Launch String],
</span></span></span><span class="line"><span class="cl"><span class="sh">        MD5,
</span></span></span><span class="line"><span class="cl"><span class="sh">        Signer
</span></span></span><span class="line"><span class="cl"><span class="sh">    ORDER BY
</span></span></span><span class="line"><span class="cl"><span class="sh">        ct ASC
</span></span></span><span class="line"><span class="cl"><span class="sh">&#34;@</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">&amp;</span> <span class="n">logparser</span> <span class="n">-stats</span><span class="err">:</span><span class="n">off</span> <span class="n">-i</span><span class="err">:</span><span class="n">csv</span> <span class="n">-dtlines</span><span class="err">:</span><span class="n">0</span> <span class="n">-o</span><span class="err">:</span><span class="n">csv</span> <span class="s2">&#34;$lpquery&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ScriptName</span> <span class="p">=</span> <span class="no">[System.IO.Path]</span><span class="p">::</span><span class="n">GetFileName</span><span class="p">(</span><span class="nv">$MyInvocation</span><span class="p">.</span><span class="n">ScriptName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;${ScriptName} requires logparser.exe in the path.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>üõ†Ô∏è <code>Logparser</code> needs to be installed for it to run. Run this script in the directory with the *-Autorunsc.csv files. It will merge all the info into one file. Perform frequency analysis against this consolidated data and note anything run on one system only (sort or filter by the cnt column). Once the processes of interest have been identified, run the Powershell script to see which machine this process was run on:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Select-String <span class="s2">&#34;processname&#34;</span> *-Autorunsc.csv
</span></span></code></pre></div><p>There is also a <code>Get-LogparserStack.ps1</code> script which is more general and allows you to parse and merge different logs so long as they have the same structure.</p>
<p><code>.\Get-LogparserStack.ps1 -FilePattern *SvcAll.csv -Delimiter &quot;,&quot; -Direction asc -OutFile SvcAll-workstation-stack.csv</code></p>
<p>You will be asked to Enter the field to pass to <code>COUNT()</code>. This needs to be some column that identifies the processes uniquely, not the row! For example, it‚Äôs the process name. Then you will be prompted to Enter the fields you want to GROUP BY, one per line. Enter &ldquo;quit&rdquo; when finished. You can group by any column and also combine several of them. For example, group by Name, DisplayName and Path (for some process logs) or by IP and user id for some application logs.</p>
<p>When you specify columns to group by using the ‚ÄúGROUP BY‚Äù option in the script, Log Parser will group all log entries that have the same value for the specified columns into a single group. The script then calculates the number of hits and bytes transferred for each group. ChatGPT
You‚Äôll see the columns specified as GROUP BY options in the output. So, for example, in the case of some accesslogs.txt files, we can group by method, URL and HTTP status code returned. That means the script will group all entries where the method, URL and status code are the same, then calculate the number of entries there and then list the aggregated results. It‚Äôs something like pivot tables in Excel or Numbers.</p>
<p>See more here - <a href="https://trustedsignal.blogspot.com/2015/03/kansa-get-logparserstackps1.html">https://trustedsignal.blogspot.com/2015/03/kansa-get-logparserstackps1.html</a>.</p>
<p>When the entries of interest are found, use <code>Select-String &lt;full-or-partial-entry-name&gt;</code> in the folder with all the csv <code>files</code> to find machines with the suspicious artefact.</p>
<h4 id="-btfm">üìò BTFM</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">autorunsc -v <span class="o">[</span>options<span class="o">]</span> &gt; result.csv
</span></span></code></pre></div><h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    Something here
</details>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
