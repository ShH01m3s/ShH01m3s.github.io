<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤” How do I check for remote connections? - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.564b5f4faf3af87992cb8ab298314448914c22dbdb3f2f9c584546b21b8d407c.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-ttp ğŸ”">
      <a href="/docs/ttp">
        <span>TTP ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-artefacts db ğŸº">
      <a href="/docs/tools">
        <span>Artefacts DB ğŸº</span>
      </a>
    </li>
    
    <li class="menu-item-attacks db âš”ï¸">
      <a href="/docs/tools">
        <span>Attacks DB âš”ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tools db ğŸ› ï¸">
      <a href="/docs/tools">
        <span>Tools DB ğŸ› ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home ğŸ¡">
      <a href="/">
        <span>Home ğŸ¡</span>
      </a>
    </li>
    
    <li class="menu-item-blog âœï¸">
      <a href="/docs/blog">
        <span>Blog âœï¸</span>
      </a>
    </li>
    
    <li class="menu-item-ttp ğŸ”">
      <a href="/docs/ttp">
        <span>TTP ğŸ”</span>
      </a>
    </li>
    
    <li class="menu-item-artefacts db ğŸº">
      <a href="/docs/tools">
        <span>Artefacts DB ğŸº</span>
      </a>
    </li>
    
    <li class="menu-item-attacks db âš”ï¸">
      <a href="/docs/tools">
        <span>Attacks DB âš”ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-tools db ğŸ› ï¸">
      <a href="/docs/tools">
        <span>Tools DB ğŸ› ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-crypto ğŸ—ï¸">
      <a href="/docs/cryptography">
        <span>Crypto ğŸ—ï¸</span>
      </a>
    </li>
    
    <li class="menu-item-about me ğŸ§ğŸ½â€â™€ï¸">
      <a href="/docs/about">
        <span>About me ğŸ§ğŸ½â€â™€ï¸</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/ttp/cheatsheets/"> ğŸ‘ˆğŸ¼ Back to </br> Artefacts CheatSheet </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#windows">Windows</a>
      <ul>
        <li><a href="#rdp">RDP</a>
          <ul>
            <li><a href="#event-logs">Event Logs</a></li>
            <li><a href="#registry">Registry</a></li>
            <li><a href="#jumplist">JumpList</a></li>
            <li><a href="#prefetch-shimcache-amcache-bamdam">Prefetch, ShimCache, AmCache, BAM/DAM</a></li>
            <li><a href="#bitmapcache">BitmapCache</a></li>
          </ul>
        </li>
        <li><a href="#network-shares">Network Shares</a></li>
        <li><a href="#psexec">PsExec</a>
          <ul>
            <li><a href="#event-logs-1">Event Logs</a></li>
            <li><a href="#registry-1">Registry</a></li>
            <li><a href="#prefetch">Prefetch</a></li>
          </ul>
        </li>
        <li><a href="#other-apps">Other Apps</a>
          <ul>
            <li><a href="#vnc">VNC</a></li>
            <li><a href="#teamviewer">TeamViewer</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">ğŸ¤” How do I check for remote connections?</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 18.06.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p><em>How to check if the system was accessed remotely? What sort of remote connections is the attacker likely to be using?</em></p>
<p>When we give a system the old remote-access razzle-dazzle system, a wealth of juicy artefacts stand ready for exploration: logs stored locally and telling the story of the past deeds, file system events tucked away by the system with the care of a fussy librarian and the config guardian (for Windows, it&rsquo;s mostly the registry) pulling the strings behind the scenes.</p>
<p><img src="images/footprints.png" alt="img">
Depending on the attack stage (reconnaissance or discovery and lateral movements), we might have access to the DESTINATION machine. On that contraption, we&rsquo;ll find ourselves amidst the same breed of artefacts.  Depending on the activity, we might find a veritable feast or a mere smattering of evidence on the source or destination machines. And as a cherry on top, our workstations can siphon the logs into one neatly organised jar ğŸ«™ (the SIEM).</p>
<p>Sneaky attackers go through reconnaissance and initial access stages twice (poor things): when bombarding the infrastructure from the outside world and while poking the systems in an already infiltrated kingdom.</p>
<h2 id="windows">Windows</h2>
<h3 id="rdp">RDP</h3>
<h4 id="event-logs">Event Logs</h4>
<ol>
<li>On <strong>source</strong> machine:
<ol>
<li><code>Security</code>ğŸ›¡ï¸ (<code>4648</code>)</li>
<li><code>TerminalServices-RDPClient</code> ğŸŒ¸ (<code>1024</code> and <code>1102</code>)</li>
</ol>
</li>
<li>On the <strong>target</strong> machine:
<ol>
<li><code>Security</code> ğŸ›¡ï¸ (<code>4624</code>, logon type <code>10</code>, <code>4778</code> and <code>4779</code>), see <code>Session name</code> to confirm it&rsquo;s an RDP.</li>
<li><code>Remote Desktop Services-RDPCoreTs</code> ğŸ‡ (<code>131</code>, <code>98</code>)</li>
<li><code>TerminalServices-RemoteConnectionManager</code> ğŸ (<code>1149</code>)</li>
<li><code>TerminalServices-LocalSessionManager</code> ğŸ(<code>21</code>, <code>22</code>, <code>25</code>, <code>41</code>)</li>
</ol>
</li>
</ol>
<p>Some breakdown of the above-mentioned codes (even if already explained elsewhere). You might filter for <code>4624</code> event id with logon type <code>10</code> to see the RDP connections. However, bear in mind that this event only records the <strong>NEW</strong> connections, not RE-connects. 4624 type 7 is triggered when lock/unlock activity happens. You will see <code>4778</code> for reconnects and <code>4779</code> for disconnects. <code>Client name</code> in <code>4778</code> shows the original machine name of the actor, giving some clues about the attacker.</p>
<blockquote>
<p>â—ï¸Logon IDs for <code>4624</code> and <code>4778</code> might differ even though they represent the same session. This happens because the earlier created logon ID is often used instead. Search for <code>4624</code> events preceded by <code>4647</code> to find the logon <code>4624</code> event with the same ID.</p>
<p>â—ï¸ Username in <code>4624</code> might NOT be the name of the original machine if some VPN or proxy is handling the connection.</p>
<p>â—ï¸ You might also see logon type 3 (4624). It&rsquo;s not commonly used instead of type 10 if NLA is on and authenticating the client before establishing the RDP session.</p>
</blockquote>
<p>Several event log trails can give some insight into RDP connection: ğŸ›¡ï¸<code>Security</code>, <code>Remote Desktop Services-RDPCoreTs</code> ğŸ‡, <code>TerminalServices-LocalSessionManager</code> ğŸ,  <code>TerminalServices-RemoteConnectionManager</code> ğŸ <code>TerminalServices-RDPClient</code> ğŸŒ¸:</p>
<table>
<thead>
<tr>
<th>ğŸ¤¦ğŸ½â€â™‚ï¸ Actor</th>
<th>source ip and username (ğŸ‡ <code>131</code>, <code>98</code>ğŸ›¡ï¸<code>4648</code>, <code>4624</code>, <code>4778</code>, <code>4779</code>, ğŸ <code>1149</code>ğŸ<code>21</code>, <code>22</code>, <code>25</code>, 41)<!-- raw HTML omitted -->Hostname (ğŸ›¡ï¸)</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ¯ <strong>Target</strong></td>
<td>Destination hostname ğŸŒ¸ <code>1024</code> and destination IP ğŸŒ¸ <code>1102</code></td>
</tr>
<tr>
<td>ğŸ“ <strong>Event Metadata</strong></td>
<td>Successful Connections ğŸ‡  <code>98</code>, Attempts ğŸ‡ <code>131</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>â—ï¸<code>TerminalServices-RDPClient</code> ğŸŒ¸ is a rare beast; it records the RDP activity on the SOURCE and is rarely turned on. All other logs record activity on the REMOTE system (thus, they are present on the remote system only).</p>
</blockquote>
<blockquote>
<p>âœğŸ» <code>4648</code> - if NLA is enabled and alternate creds are used: username, alternate username, dest hostname, dest IP, process name</p>
<p>âœğŸ» <code>1149</code> - Blank username may indicate the use of Sticky keys.</p>
</blockquote>
<h4 id="registry">Registry</h4>
<p>ğŸ”‘ <code>NTUSER\Software\Microsoft\TerminalServiceClient\Servers</code> shows recent RDP.</p>
<p>ğŸ› ï¸ <code>RegRipper</code>&rsquo;s <code>rdphint</code> plugin can extract this information from the hive automatically.</p>
<h4 id="jumplist">JumpList</h4>
<p>ğŸ“‚ <code>C:\User\username\AppData\Roaming\Microsoft\Windows\Recent\AutomaticDestinations</code> with <code>{MSTSC_APPID}-automaticDestinations-ms</code> show target info and a timestamp.</p>
<h4 id="prefetch-shimcache-amcache-bamdam">Prefetch, ShimCache, AmCache, BAM/DAM</h4>
<p>ğŸ“‚ <code>C:\Windows\Prefetch</code> (<code>[name]-[hash].pf</code></p>
<p>ğŸ“„ <code>C:\Windows\AppCompat\Programs\Amcache.hve</code> (first time executed) and the following registry keys ğŸ”‘ at <code>C:\Windows\System32\config\SYSTEM</code> hive:</p>
<ol>
<li>ğŸ”‘ <code>ControlSet001\Services\BAM</code> and ğŸ”‘ <code>ControlSet001\Services\DAM</code>  (last time executed)</li>
<li>ğŸ”‘ <code>CurrentControlSet\Control\Session Manager\AppCompatCache\AppCompatCache</code> (Vista+) and <code>CurrentControlSet\Control\Session Manager\AppCompatibility\AppCompatCache</code> (XP-)</li>
</ol>
<p>Find entries for the following executables:</p>
<ol>
<li>ğŸ“„ <code>mstsc.exe</code></li>
<li>ğŸ“„ <code>rdpclip.exe</code></li>
<li>ğŸ“„ <code>tstheme.exe</code></li>
</ol>
<h4 id="bitmapcache">BitmapCache</h4>
<p>ğŸ“‚ <code>C:\Users\username\AppData\Local\Microsoft\TerminalServerClient\Cache</code> contains <code>bcache##.bmc</code> and <code>cache#####.bin</code> files worth examining. During an RDP connection, Windows collects parts of the image (those that change the least often) to save bandwidth. Sometimes you might see valuable information there, even VPN passwords.</p>
<p>Some file <code>Default.rdf</code> in the user profile; what is that?</p>
<h3 id="network-shares">Network Shares</h3>
<p>ğŸ‘‘ - admin (domain or RID500) rights are required to access those shares.</p>
<p>ğŸ“• <strong>RTFM</strong>: <code>net use g: \\host\c$ /user:domain\uname [password]</code> will be likely used by the attacker to mount the share. The command tells roughly the following: <em>&ldquo;Mount <code>\\host\c$</code> share from the remote machine (which is the projection of <code>C</code> folder on that machine) as a G drive on the current machine. To succeed with this tiresome task, use username and passwords I EXPLICITLY provide&rdquo;</em>.</p>
<blockquote>
<p>â“Since the credentials are provided explicitly, we will likely see Security EID <code>4648</code>.</p>
</blockquote>
<p>ğŸªµ <strong>Even log trails</strong>:ğŸ›¡ï¸ <code>Security</code> and ğŸ <code>Microsoft-Windows-SmbClient%Security</code>.</p>
<p>It&rsquo;s pretty noisy, so be smart. Also, to enable this logging, go to <code>Object Access -&gt; Audit File Share</code>.</p>
<blockquote>
<p>â—ï¸No ğŸ‘´ğŸ¼ XP logs.</p>
</blockquote>
<p><code>5140</code> - network share was accessed.
<code>5142</code> - <code>5144</code> - share created, modified, deleted.
<code>5145</code> - the shared object was accessed.</p>
<p>If you see some <code>4624</code> followed by multiple <code>5140</code> events, it&rsquo;s probably an attempt to mount the share. The attackers will be most interested in the <code>ADMIN$</code> share. However, to use it, one needs to mount <code>IPC$</code> share first. That&rsquo;s good since it lets us see the account name, SID, and information not recorded for the <code>ADMIN$</code> share mount event.</p>
<table>
<thead>
<tr>
<th>Source</th>
<th>Destination</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ›¡ï¸<code>4648</code> (alternate credentials): d_IP, d_host, p_name, c_user</td>
<td>ğŸ›¡ï¸<code>4624</code> type <code>3</code> (network logon), <code>5140</code> (share access), <code>4672</code> (elevated privileges, uname), <code>4776</code> (Kerberos auth validation, s_host and name), <code>4768</code>, <code>4769</code>, <code>5145</code> - share audit log.</td>
</tr>
<tr>
<td>ğŸ<code>31001</code> (failed logon to dest): d_host, uname, err_code</td>
<td>ğŸ•¸ï¸ Network Forensics (if SMB connection was not encrypted)</td>
</tr>
<tr>
<td>ğŸ—„ï¸ Registry: <code>MountPoints2</code></td>
<td></td>
</tr>
<tr>
<td>ğŸ’¼ ShellBags: <code>USRClASS.DAT</code> (remote folders accessed)</td>
<td></td>
</tr>
<tr>
<td>âš™ï¸ ShimCache, BAM/DAM, AmCache (look for <code>net.exe</code> and <code>net1.exe</code>)</td>
<td></td>
</tr>
<tr>
<td>ğŸ“‘ Prefetch and User Profile Artefacts (shortcuts and jumplists)</td>
<td></td>
</tr>
</tbody>
</table>
<p>ğŸ“‘ <strong>File Created and Modified</strong>:</p>
<ol>
<li>Suspicious files copied to the share.</li>
<li>Modification timestamp &lt; creation timestamp -&gt; If you copy a file to a different location, the new copy of the file may have a new creation time (when the copy was made) but still retain the original file&rsquo;s earlier modification time.</li>
<li>Created time is the time of the file copy.</li>
</ol>
<h3 id="psexec">PsExec</h3>
<p>This application doesn&rsquo;t exist on the system by default. It requires one to engage in a veritable dance of dexterity to get this precious executable on the system of interest. But this Herculean labour doesn&rsquo;t go in vain: it also brings a mighty toolkit to further spread the damage.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="err">ğŸ“•</span> <span class="n">psexec</span><span class="p">.</span><span class="n">exe</span> <span class="p">\\</span><span class="n">host</span> <span class="n">-accepteula</span> <span class="n">-d</span> <span class="n">-c</span> <span class="n">C:</span><span class="p">\</span><span class="n">some</span><span class="p">\</span><span class="n">path</span><span class="p">\</span><span class="n">iamnotnefarious</span><span class="p">.</span><span class="n">exe</span>
</span></span></code></pre></div><p>ğŸ›¡ï¸Security logs, âš™ï¸ System Logs</p>
<table>
<thead>
<tr>
<th>Artefact</th>
<th>ğŸš° Source (psexec.exe)</th>
<th>ğŸ¯ Target (psexesvc.exe), â—ï¸One can rename the executable with <code>-r</code> switch.</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸªµ Event logs</td>
<td>ğŸ›¡ï¸ <code>4648</code></td>
<td>ğŸ›¡ï¸<code>4624</code> type <code>3</code> (if no <code>-u</code> switch), <code>4624</code> type <code>2</code> (<code>-u</code> switch), <code>4672</code>, <code>5140</code>, âš™ï¸ <code>7045</code> (service installed).</td>
</tr>
<tr>
<td>ğŸ—„ï¸ Registry</td>
<td>ShimCache, BAM/DAM, AmCache</td>
<td>ğŸ”‘ <code>SYSTEM\CurrentControlSet\Services\PSEXESVC</code> (can get deleted on session closed)<!-- raw HTML omitted --> ğŸ”‘ <code>NTUSER.DAT</code> (when user profile is created, no <code>-e</code> switch)<!-- raw HTML omitted -->ShimCache and AmCache.</td>
</tr>
<tr>
<td>ğŸ“‘ File system</td>
<td>Prefetch</td>
<td>Prefetch, user profile</td>
</tr>
<tr>
<td>ğŸ’­ RAM</td>
<td></td>
<td>With <code>4624</code> type <code>2</code> the token remains in the RAM<!-- raw HTML omitted -->Process handles <code>\\IP\name - shost - PID -stdin/stdout/stderr </code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>â—ï¸Keep in mind that this executable consists of two parts: <code>psexec.exe</code> running on the source (<code>c</code> pehaps means <code>client</code>) while <code>psexesvc.exe</code> runs on the target system.</p>
<p>â—ï¸Also, <code>psexesvc.exe</code> creates a service each time it&rsquo;s executing and deletes that service afterwards.</p>
</blockquote>
<h4 id="event-logs-1">Event Logs</h4>
<p>EID <code>4648</code> is of the most use here since it tracks the use of alternate credentials. It means that most of the time, the attacker needs to provide the credentials explicitly. Once this is done, this EID 4648 fires up and tells a tale of who (the current user), what (process id) and to whom (alternate credentials, destination IP and destination hostname) without even those thirty pieces of silver.</p>
<h4 id="registry-1">Registry</h4>
<p>The three piglet of the registry that give away the program execution are ShimCache, the two bafoons BAM/DAM (last time executed) and AmCache (first time executed).</p>
<h4 id="prefetch">Prefetch</h4>
<p>Of course, we would be lost without this little vigilant scoundrel. Ratting out almost any executable careless enough to be working under its unblinking gaze.</p>
<h3 id="other-apps">Other Apps</h3>
<p>Custom apps for remote desktop connection produce their own artefacts as well. For example, VNC and TeamViewer. Not many of them are allowed in the enterprise, but these two buddies might be.</p>
<h4 id="vnc">VNC</h4>
<p>When VNC is used for remote connection, <code>4624</code> logon type <code>2</code> (Console login) is used instead. Also, VNC keeps its own wealth of logs - worth researching, to be honest (ğŸ—’ï¸).</p>
<h4 id="teamviewer">TeamViewer</h4>
<p>This app is pretty ğŸ˜ cool because it keeps logs on BOTH source (<code>TeamViewerX-Logfile.log</code>) and the target (<code>Conncections-incoming.txt</code>) systems, which is of great use for the analysts. For these files look in ğŸ“‚ <code>C:\ProgramFiles\TeamViewer\VersionX</code> folder.</p>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    <ol>
<li>ShimCache and AmCache enterprise-wide hunting - SANS Threat Hunting Summit 2017
<a href="https://www.youtube.com/watch?v=-0bYcD3_bBs">https://www.youtube.com/watch?v=-0bYcD3_bBs</a></li>
</ol>

</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

  
  
  
    
  


</body>

</html>
